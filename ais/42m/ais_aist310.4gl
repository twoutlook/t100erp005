#該程式未解開Section, 採用最新樣板產出!
{<section id="aist310.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0081(2016-12-21 17:22:58), PR版次:0081(2017-02-24 11:14:26)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 001398
#+ Filename...: aist310
#+ Description: 客戶貨款對帳作業
#+ Creator....: 02114(2014-01-26 14:36:52)
#+ Modifier...: 08171 -SD/PR- 04152
 
{</section>}
 
{<section id="aist310.global" >}
#應用 t01 樣板自動產生(Version:79)
#add-point:填寫註解說明 name="global.memo" 
#150507-00007#1  150507 By Jessy     人員串查
#150603-00046#1  150603 By Reanna    修正單身組織開窗
#150609-00004#1  150609 By apo       單頭發票資料頁籤,購貨方訊息-購貨方名稱欄位,要顯示全名
#150609-00006#1  150609 By apo       輸入單頭發票資料頁籤-發票簿號,帶回來isaf010的值,應依台灣/大陸稅區分別帶回字軌/發票代碼
#150512-00024#1  150609 By Hans      零稅率資料維護
#150331-00006#5  150618 By Reanna    增加發票歷程欄位：營運據點、單據日期
#150904-00006#2  150908 By Reanna    增加商用發票號碼(isaf066)
#150911          150911 By apo       非使用字軌才需抓取發票代號,且加上依發票日期所在的年期找發票簿號
#150915          150915 By albireo   修改isatdocdt   isatsite邏輯
#150915-00009#3  150916 By albireo   1.已確認可利用發票補登功能登打申報頁簽資料;2.國別TW時,將字軌加入發票號碼欄位(批次功能追回)
#                                    3.申報頁籤預設值:若為非經海關時,參考文件名稱預設帶'REF',參考文件號碼預設帶商用發票號碼;
#                                    4.折讓發票確認取消確認回寫原單發票已折金額(批次功能追回);5.發票歷程檔項次隱藏;
#                                    6.發票歷程檔的金額改呈現本幣金額(本幣異動時原幣不改變)
#150918-00001#7  150923 By albireo   發票原幣金額顯示出來, 在本幣前面;
#                                    發票補登,可維護本幣若異動本幣相關金額要重計本幣其他欄位,不回推原幣;原幣若異動原幣相關金額要重計,要重推本幣
#151005-00007#2  151008 By Hans      發票開立的時候 LET isat025 = isat014
#151007-00002#3  151008 By Hans      銷退單寫到發票歷程檔時,依發票號碼彙總
#151021          151021 By Hans      MAX(seq)修改
#151020-00003#2  151027 By Jessy     TOPMENU 增加作廢發票歷程檔及換開發票功能
#151028          151028 By albireo   1.倉退發票單頭為負 發票單身為正, 所以要判斷為倉退時 負轉正後再比較
#                                    2.倉退發票確認時匯回寫來源發票已折金額,要先判斷該單狀態碼是否為確認
#151013-00019#10 151111 By Reanna    發票號碼的check要加上年月
#151117          151117 By Reanna    方便性輸入需求：單身若是輸入19其他加項，則【收款條件】default客戶的常用收款條件
##151123-00013#7 151127 By albireo   單身登打增加出貨簽收單邏輯  (檢核及開窗)
#151125-00001#3  151127 By Charles4m 增加詢問是否作廢。
#151029-00001#3  151130 By Reanna    1.申報訊息頁籤:商用發票號碼不用檢核是否存在axmt620
#                                    2.登打折讓單之原始發票號碼時，需控管不可超折
#151209-00019#1  151218 By albireo   1.單據確認審核時，增加檢核,IF 有指定發票號碼者(isaf011), 則 isat_t 必需存在有相同發票號碼者，才可確認；否則提示訊息"無發票明細及資料,請檢核。
#                                    2.回寫發票簿的已開票號時，以發票歷程檔的資料為主。
#151130-00015#2  151223 BY taozf     判断 是否可以更改單據日期 設定開放單據日期修改
#151223-00001#3  151228 BY lujh      單身若為出單或或銷退單時,異動單身即時回寫單據之xmdl047
#                                    單據狀態作废 取消作废,核和取消審 同時要調整
#151229-00001#2  151230 By Reanna    在維護時發票歷程檔，發票狀態控卡：出貨發票isaf056=1時，isat014只能打11:發票開立
#                                                                   折讓發票isaf056=2時，isat014只能打21:折讓開立
#160104-00015#1  160104 By Reanna    匯整至發票明細時，若aisi080設定為字軌，則不用寫發票代碼(isah001、isat003、isaf010)的值進去
#160105-00015#2  160108 By albireo   (正項)輸入發票時,檢核是否有輸入重覆的發票,重覆發票者,不可輸入;並且開放[發票日期]必要輸入
#160111-00020#2  160113 By albireo   1.單頭發票檢查重複性(存在其他張對帳單isat否) 2.單身發票明細檢查重複性(存在其他張對帳單isat否) 
#                                    3.從發票歷程回寫發票明細時,若發票明細已有發票號碼的單身不回寫 
#                                    4.匯率預設參考AR aoos020
#151231-00010#3  160113 By albireo   增加交易對象控制組邏輯
#160118-00007#2  160127 By Hans      IF isat002 = 'Y'(電子發票) THEN select isak003 into isat026 ,isat008 給予系統時間
#151209-00023#1  160215 By lujh      发出商品且参与成本计算的功能
#160215-00013#1  160219 By Hans      當折讓單顯示 原始發票日期欄位，增加原始發票日期取用原則，產生isat時取稅別即含稅否。
#                                    確認時檢核是否有發票明細，如果沒有，彈出彙整式發票明細。
#150518-00046#4  160308 By 03538     增加單身類型12:維修單,相關維護處理邏輯
#160304-00023#1  160309 By Reanna    執行作廢，開放維護：異動理由碼(isaf037)、異動備註(isaf038)、專案作廢核准文號(isaf042)
#                                             一併給值：異動日期(isaf039)為執行日期、異動時間(isaf040)為執行時間、異動人員(isaf041)為執行人員
#160315          160315 By 03538     選擇發票資料的營運據點,必須與單頭帳務中心法人相同
#160316-00017#2  160316 By lujh      1.訂金發票開窗只能選訂單多帳期的訂金及簽約金
#                                    2.單身打完訂單號及期別 call 元件依訂金百分比拆出各料件之數量寫到來源明細
#160317-00024#1  160321 By lujh      單身來源組織可選到, 但會卡關顯示錯誤訊息
#160308-00006#2  160323 By Reanna    作廢時增加詢問發票號碼是否回收
#160322-00027#3  160323 By lujh      1.單身數量 = 出貨單數量時, 不再重計 --> 取出貨單上的未稅, 稅額, 含稅..xrcd 直接複製
#                                    2.稅別取出貨單
#160321-00016#35 160328 By Jessy     修正azzi920重複定義之錯誤訊息
#160318-00005#22 160330 by 07675     將重複內容的錯誤訊息置換為公用錯誤訊息
#150703-00017#1  160406 By 01727     增加導出金稅TXT文件功能
#160318-00025#30 160408 by 07959     將重複內容的錯誤訊息置換為公用錯誤訊息
#160413-00019#1  160414 By Reanna    調整发票明细页签金额与立账来源明细金额9300不等時要卡住
#160414-00018#2  160415 By albireo   查詢效能調校
#160413-00020#1  160425 By Reanna    單據已過帳應可轉應收，控卡調整
#160413-00018#1  160425 By Hans      作廢時還原已開發票數量xmdl047之數量
#160506          160506 By albireo   確認前登打多筆發票被卡住,修改檢核邏輯
#160510-00020#1  160509 By Reanna    修正：作廢時回寫已開發票數量重複回寫
#160426-00013#2  160601 By Reanna    增加訂金發票流程
#160620-00010#3  160621 By 06821     scc = 9715增加2.雜項發票,若選 2.雜項發票時,不要隱藏單身來源頁籤
#160623-00019#1  160628 By Reanna    1.出貨對帳時,自動產生段與直接維護時,發票數量計算應過濾以出貨對帳資料為主
#                                    2.手工輸入時,於輸入確定後,檢查出貨對應的待抵若無維護則提示錯誤訊息
#160623-00023#1  160628 By Reanna    自動產生單身出貨資料時，無法依照出貨性質區分，仍會將簽收出貨單產生進來
#160530-00005#1  160629 By 06821     1.topmenu 掛發票列印,若主程式上的電子發票=Y,則本作業改call aisr520/若發票性質為折讓單且電子發票=N時則 call aisp350/
#                                    若發票性質為交易單且電子發票=N時則 call aisp330  2.對帳金額訊息頁籤的"應收單號" 應要有串連功能
#160614-00025#1  160630 By 06821     1.當單身來源類型: 1-1.當單頭對帳來源為 1. 時:13.門店銷售單時 來源單號則開啟則為 artt600/artt610/artt620
#                                    1-2.當單頭對帳來源為 4. 時:22.門店銷退單時,來源單號則開啟則為 artt700 
#                                    1-3.已過帳未存在其他 aist310資料並排除 aist310 已作廢單據, 1-4.13,22 類型時,後續數量與金額皆不可修改 
#                                    2.新增/刪除/作廢後更新 rtia014,rtia015 發票編號 3.建議增加以下防呆控卡: 當對帳來源為 1,2,3 時發票性質不可為 2 ;當對帳來源為 4 時,發票性質不可為 1
#160706-00024#1  160706 By Reanna    該出貨單沒有訂金待抵，單據確認時不應該卡住
#160705-00042#6  160712 By sakura    查詢程式段q_ooba002_1開窗，呼叫開窗前的g_qryparam.arg若是要傳入程式代號，要改傳入g_prog
#160708-00012#1  160718 By Reanna    修改单头的账务中心，法人，账务人员，业务人员，账款客户等栏位时，未及时更新说明字段
#160721無單      160721 By albireo    修正取發票簿key多增加發票類型
#160801-00053#1  160802 By Reanna    AFTER FIELD 檢核bug修正
#160803-00044#1  160804 By Reanna    調整抓取aisi080發票編碼方式改用isai002判斷
#160707-00023#2  160805 By albireo   調整發票匯總,若aisi090對應發票類型未建立,提示並且視為發票列印時才取號
#160808-00030#1  160808 By albireo   修改發票明細單價時,改用s_tax_count元件預設後續資訊
#160809-00012#1  160809 By Yiting    發票類型預設值雖是以發票客戶為主, 但帳款客戶給予發票客戶時也應同步給予發票類型的預設值
#160807-00010#1  160809 By Reanna    彙整至發票明細時，若單頭發票號碼為MULTI，則不用重產isat_t
#160704-00017#1  160818 By 08171     topmenu call aisp330 / aisp350 時傳入當前的單據資訊並帶出在單身
#                                    1.對帳單號 2.發票類型 3.發票日期 當前若無資料,則不可執行 topmenu 發票列印
#160812-00017#4  160818 By 06814     在satatchange( )的FUNCTION中，有RETURN指令但沒有加上transaction_end( ) 
#                                    造成transaction沒有結束就直接RETURN
#160517-00001#1  160819 By 01727     判斷訂單是否為100%訂金.如果是100%訂金則將訂單單身數量/金額照搬至對帳單/應收單
#160614-00025#2  160819 By Reanna    調整回寫門店銷售單發票號碼的位置
#160712-00013#1  160819 By Reanna    檢查發票類型是否符合aisi090該據點設定可使用的
#160816-00023#1  160822 By 06821     過帳寫入 inaj023 時,改用發票日期(isaf014)傳入
#160823-00016#1  160824 By Reanna    金額統計時，訂金沒開發票，不可以加進來(發票開在出貨單)
#160824-00066#1  160826 By 00768     单头发票类型有变更，需同步更新单身的发票类型
#160825-00040#1  160829 By Reanna    單身無資料時，允許修改單頭的栏位：对账来源、发票性质、账款客户
#160822-00008#8  160907 By 08171     新舊值調整
#160907-00046#1  160908 By 08729     調整來源單號不同串查程式不同,將SELECT COUNT(*)改掉
#160907-00041#1  160909 By 06821     1.补登发票号码后输入发票日期 保存后变为空 第二次录入后才能保存 2.過帳時,call s_inventory_upd_inag 傳遞參數異動日期 g_today 請改用發票日期
#                                    3.執行發票補登維護發票歷程(isat_t)後,如為發票簿最大號時並未更新至發票簿下次列印號碼(isae012)-限定已確認時更新 3-1.換開發票時亦需同步更新(限定已確認時更新)  3-2.如已確認,則先跳到發票簿決定發票編號再帶到isat中
#                                    4.法人欄位的輸入與開窗須具備 azzi800 權限為主 5.整單查詢時需要將 azzi800 權限作為過濾條件 6.單身的來源組織範圍, 新增時, 受帳務中心權限限制
#160920-00019#5  160926 By 08732     交易對象開窗調整為q_pmaa001_13
#160909-00081#1  160926 By Reanna    1.檢查未確認發票時沒有加上營運據點2.單身手動輸入預收待抵單時,若訂金預收尚未收款則需控卡不可輸入
#160802-00007#1  160926 By 01727     一次性交易對象識別碼(pmaa004=2)功能應用
#160920-00013#1  161004 By 08171     訂金發票開放未稅稅別應用
#160920-00013#1  161005 By 08171     1.新增對帳來源 5.雜項待抵SCC 9715
#                                    2.發票類型則為 aisi030 進銷項為4:銷項折讓證明單資料
#                                    3.應收帳款串查為 axrt341
#                                    axrp132 當對帳來源為 5.雜項待抵時產生到 axrt341,xrca001 為 29,其他維持原對應關係
#161006-00005#29 161018 By 08732     組織類型與職能開窗調整
#161018-00050#1  161018 By 00768     处理因币种未获取到，导致提示：传入参数为空或参数值的參數值不正确
#161020-00002#1  161020 By Reanna    處理付款條件開窗bug
#161005-00018#3  161020 By albireo   27自動產生 與單身手打單號項次  帶出訂金待抵時需依原帳款單單頭稅別稅率含稅否展金額到稅額未稅金額
#161018-00053#1  161026 By 06821     1.當稅別不為 null 時,當游標移到發票客戶後不可再異動稅別欄位資料 .輸出日期或結匯日期(isaf065)取消必要欄位限制,預帶發票日期 3.單身來源組織預設為 g_site
#161017-00005#1  161026 By 08171     業務組織開窗根據aooi125法人底下的部門
#161024-00065#2  161028 By Reanna    依照aoos020的參數S-FIN-2023(流通門店銷售立帳方式)，選1.發票立帳，除抓資料來源=1:ERP外，
#                                    可多抓取4:日結的門店銷售單對帳，選2:店日結立帳只可抓資料來源=1:ERP
#161028-00011#1  161031 By Reanna    換開發票時，若換開的新號碼=該發票簿下次列印號碼時，號碼回寫有問題
#161101-00039#1  161101 By 06821     發票補登時，如未維護發票歷程檔，則單頭發票號碼不做寫入
#161103-00004#1  161103 By 06821     原IF g_isaf_m.isaf011 <> 'MULTI' 增加判斷isaf011=null時，自動帶出發票號碼
#161102-00041#1  161103 By Reanna    調整發票日期給值
#161025-00016#1  161104 By Reanna    立帳來源明細的收款條件後面增加顯示銷售通路(xmdk030)欄位
#160826-00017#1  161107 By 08732     對帳單主畫面表尾增加原/本幣未稅、稅額、含稅合計金額
#160922-00055#2  161108 By 06821     1.維護完交易對象後當發票類型為空時,自動帶入axmm202的慣用發票類型為預設值 2.整單操作產生應收帳款時,請將對帳來源作為 axrp132 對帳來源預設值 3.匯率異動後,若發票客戶未異動不可再改變匯率 4.原#161018-00053#1 單身來源組織預設 g_site 改為預設 isafsite
#161020-00021#1  161108 By 06821     1.當單身已存在發票歷程(isat_t)時,單頭限制不可異動發票類型、營運據點與發票簿欄位 
#160826-00017#2  161108 By 06821     對帳單主畫面表尾增加原/本幣未稅,稅額,含稅合計金額(原#160826-00017#1部分已由原開發者自行mark)
#161104-00024#10 161109 By 08171     程式中DEFINE RECORD LIKE時不可以用*的寫法，要一個一個欄位定義
#161101-00042#1  161110 By 08171     取消 申報訊息 頁簽依照 isai002 顯示改為一律顯示 
#                                    並依據國家別為 TW 時,才顯示申報格式(isaf019),適用零稅率規定(isaf059),通關方式(isaf060),非經海關證明文件名稱(isaf061),非經海關證明文件號碼(isaf062),經由海關出口報單類別(isaf063),出口報單號碼(isaf064)等欄位
#161108-00017#6  161110 By 08171     程式中INSERT時不可以用*的寫法，要一個一個欄位定義
#160920-00032#1  161116 By albireo   1.發票簿輸入邏輯 折讓時應依aisi080  是否紅字藍字共用發票簿 決定欄位是否開放 2.ais-00311檢核取消
#160930-00020#1  161118 By 08732     列印串接aisr310
#161123-00012#1  161123 By Reanna    調整取得訂金發票的待抵單條件
#161127-00002#1  161129 By Reanna    檢核折讓發票是否超折應限定台灣稅區檢核即可
#161124-00070#1  161202 By 06821     原發票補登針對無發票歷程資料的控卡(若無發票歷程資訊，則把單頭發票資訊清空)改寫到aist310_isaf011_update 統一處理
#161201-00028#1  161202 By 08732     發票補登的情況下，刪除時(如為最後一號),應將發票簿的下次列印號碼減一
#161125-00028#1  161206 By 00222     預帶發票類型要檢查合理性
#161206-00035#1  161206 By 08732     修復161201-00028#1的邏輯錯誤問題
#161207-00038#1  161207 By 06821     1.若帳款客戶為"一次性交易對象"時，購貨方名稱、統一編號、購貨方地址，依apmi004的資料預設帶出    2.一併處理在切換上下筆時，發票類型、稅別等帶出的說明有問題(從第一筆到第二筆時，說明還是第一筆的資料)
#161209-00037#1  161209 By Reanna    本幣取位時，傳入的幣別應傳入本幣
#161212-00008#1  161212 By albireo   彙總到發票明細修正與aisp320原則相同;有aisi050且設定發票編號時過發票簿 發票編號為空的修正
#161212-00075#1  161213 By albireo   依SA整測內容修正下列各點:發票限額於含稅稅別時邏輯調整;彙總至發票明細transaction被破壞;若有發票歷程時,執行彙總到發票明細提示並不予執行功能;
#                                    修正第一次執行彙總到發票明細不會產生isat問題
#161208-00026#19 161214 By 08732     SUB_程式中DEFINE / INSERT INTO 有星號整批調整(針對SELECT *的部份)
#161214-00053#1  161219 By Reanna    1.修正#160907-00041#1預帶少帶了發票代碼
#                                    2.立帳來源明細填寫原始發票編號+原始發票號碼時，才回寫原始發票號碼的已折金額
#                                    3.修改檢核發票代碼+發票編號是否存在於發票簿(isae_t)
#                                    4.若無來源發票，【发票历程档】页签的原发票日期給空
#                                    5.依據 aisi080紅字發票呈現方式(isai004)決定當1:以正值呈現時，單頭與單身頁簽皆呈現正數
#                                      當2:以負值呈現時，針對單頭與發票歷程頁簽呈現負數，其他頁簽維持呈現正數
#                                    6.原幣乘匯率後本幣未做取位，調整此隻金額取位
#                                    7.台灣地區開立折讓單時，限制不可使用換開與作廢
#                                    8.調整bug：整批產生訂金時，若訂金有兩筆以上只能產生第一筆，第二筆之後無法產生
#                                    9.整批產生的訂金單號開窗增加排除已立aist310的訂金
#                                    10.增加發票簿手動輸入時檢核控卡
#161221-00021#1  161221 By 08171     將單身來源單號在qbe時改為不提供開窗查詢(在規格做設定，然後重產程式)
#161129-00042#1  161222 By 08729     增加營利事業統一編號檢查，修正取isai值(增加取isai008)
#161222-00029#1  161228 By Reanna    帳款客戶未過濾據點
#161228-00004#1  161228 By 02114     走发出商品时,aist310过账产生inaj表时,inaj036给值有误
#161216-00009#1  161228 By Reanna    aist310單號查詢開窗增加azzi800條件
#161206-00042#2  161229 By albireo   對帳單一次性交易對象處理需依發票對帳來源攔位決定,雜項則當作第一站新增,其他類型則當作有來源單處理
#161214-00042#1  161229 By albireo   彙整至發票明細產isat段  針對銷退並不共用發票簿調整
#161223-00053#1  170105 By Reanna    銷退發票換開發票時,原發票日期欄位應取發票號對應正項發票開立時發票日期
#170105-00017#1  170110 By Reanna    1.在來源明細，銷退上改稅額>>不會改交易稅明細的稅額
#                                    2.在交易稅明細裏，修改稅額>>會重複出現更新訊息
#170112-00008#2  170111 By Reanna    aist310該句sql增加判斷發票號碼為空或者等於空白的條件
#170111-00031#1  170113 By Reanna    新增時，其他信息的業務部門開窗ooegstus='Y'的条件重复
#170116-00020#1  170116 By Reanna    1.補登發票，輸入發票號碼，會一直檢核報錯"#發票號碼不存在於發票簿的起始號碼及截止號碼之間!"
#                                    2.單頭發票號碼輸入"MULTI"，則不用檢核
#                                    3.未確認時，不產生發票歷程，也不開放發票歷程維護
#                                    4.單據確認時，檢核紅字發票金額需為負，要排除aisi080紅字發票呈現方式呈現方式設定為1:以正值呈現
#                                    5.輸入出貨單號與項次時預帶原本的客料說明
#170117-00067#1  170118 By Reanna    調整回寫出貨數量的位置(改AFTER ROW)
#160622-00019#1  170120 By Reanna    當對帳來源為3:訂金發票 時，單身來源類型僅能使用 10.訂單
#170120-00040#1  170123 By Reanna    更新發票簿資料檔(isae_t)時，需一併更新：資料修改者(isaemodid)、最近修改日(isaemoddt)
#161104-00046#3  170125 By 08729     單別預設值;資料依照單別user dept權限過濾單號
#170103-00009#1  170206 By 08729     發票類型=4.收據，發票簿欄位隱藏，輸入發票號碼，只要檢核是不是有重複即可
#170208-00018#1  170210 By Reanna    单身挑选出货单后点确定，写到xrcd表时，xrcdld 帐别没有赋值。删除单身的出货单信息后，xrcd也没有跟着一起删除。
#170215-00025#1  170215 By Reanna    單身拉加減項時，交易稅及發票明細稅額有問題(未稅金額0/稅額1/含稅金額1，匯總至發票明細isah_t的正負值=1應該是-1才對)
#170214-00045#1  170215 By Reanna    發票性質：2.扣抵折讓單 時，發票歷程頁簽輸入發票號碼後，原發票日期並不會帶入
#170215-00040#1  170216 By Reanna    對帳來源改成4:待抵銷退 or 5:雜項待抵時，發票簿應該要影藏(isaf051)，修正#170103-00009#1 bug
#170217-00019#1  170217 By Reanna    因為匯率小，導致原幣與本幣的取位變0，導致產生至發票明細正負值給予不正確，最下面金額統計有誤，無法審核確認
#170216-00030#1  170222 By Reanna    取消確認時，檢核isat_t存在否，增加條件為發票最後狀態是='11'者，不可取消確認
#170220-00041#1  170223 By 06821     整單操作執行發票列印aisp330時，增加傳入發票簿條件
#170220-00070#1  170224 By Reanna    訂單產生的xrcd_t的xrcd001應帶aist310
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目 name="global.import"

#end add-point 
 
SCHEMA ds 
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔 name="global.inc"

#end add-point
 
#單頭 type 宣告
PRIVATE type type_g_isaf_m        RECORD
       isafsite LIKE isaf_t.isafsite, 
   isafsite_desc LIKE type_t.chr80, 
   isafdocno LIKE isaf_t.isafdocno, 
   isafdocno_desc LIKE type_t.chr80, 
   isaf001 LIKE isaf_t.isaf001, 
   isafcomp LIKE isaf_t.isafcomp, 
   isafcomp_desc LIKE type_t.chr80, 
   isafdocdt LIKE isaf_t.isafdocdt, 
   isaf056 LIKE isaf_t.isaf056, 
   isaf005 LIKE isaf_t.isaf005, 
   isaf005_desc LIKE type_t.chr80, 
   isaf057 LIKE isaf_t.isaf057, 
   isaf057_desc LIKE type_t.chr80, 
   isaf003 LIKE isaf_t.isaf003, 
   isaf003_desc LIKE type_t.chr80, 
   isaf067 LIKE isaf_t.isaf067, 
   isafstus LIKE isaf_t.isafstus, 
   isaf008 LIKE isaf_t.isaf008, 
   isaf008_desc LIKE type_t.chr80, 
   isaf016 LIKE isaf_t.isaf016, 
   isaf014 LIKE isaf_t.isaf014, 
   isaf053 LIKE type_t.chr10, 
   isaf016_desc LIKE type_t.chr80, 
   isaf052 LIKE isaf_t.isaf052, 
   isaf052_desc LIKE type_t.chr80, 
   isaf018 LIKE isaf_t.isaf018, 
   isaf051 LIKE isaf_t.isaf051, 
   isaf009 LIKE type_t.chr1, 
   isaf017 LIKE isaf_t.isaf017, 
   isaf010 LIKE isaf_t.isaf010, 
   isaf012 LIKE isaf_t.isaf012, 
   isaf100 LIKE isaf_t.isaf100, 
   isaf011 LIKE isaf_t.isaf011, 
   isaf101 LIKE isaf_t.isaf101, 
   isaf054 LIKE isaf_t.isaf054, 
   isaf002 LIKE isaf_t.isaf002, 
   isaf002_desc LIKE type_t.chr80, 
   isaf021 LIKE isaf_t.isaf021, 
   isaf022 LIKE isaf_t.isaf022, 
   isaf023 LIKE isaf_t.isaf023, 
   isaf024 LIKE isaf_t.isaf024, 
   isaf025 LIKE isaf_t.isaf025, 
   isaf026 LIKE isaf_t.isaf026, 
   isaf045 LIKE isaf_t.isaf045, 
   isaf027 LIKE isaf_t.isaf027, 
   isaf028 LIKE isaf_t.isaf028, 
   isaf029 LIKE isaf_t.isaf029, 
   isaf030 LIKE isaf_t.isaf030, 
   isaf031 LIKE isaf_t.isaf031, 
   isaf032 LIKE isaf_t.isaf032, 
   isaf046 LIKE isaf_t.isaf046, 
   isaf103 LIKE isaf_t.isaf103, 
   isaf104 LIKE isaf_t.isaf104, 
   isaf105 LIKE isaf_t.isaf105, 
   isaf106 LIKE isaf_t.isaf106, 
   isaf107 LIKE isaf_t.isaf107, 
   isaf108 LIKE isaf_t.isaf108, 
   isaf113 LIKE isaf_t.isaf113, 
   isaf114 LIKE isaf_t.isaf114, 
   isaf115 LIKE isaf_t.isaf115, 
   isaf116 LIKE isaf_t.isaf116, 
   isaf117 LIKE isaf_t.isaf117, 
   isaf118 LIKE isaf_t.isaf118, 
   isaf119 LIKE isaf_t.isaf119, 
   isaf120 LIKE isaf_t.isaf120, 
   isaf121 LIKE isaf_t.isaf121, 
   isaf033 LIKE isaf_t.isaf033, 
   isaf034 LIKE isaf_t.isaf034, 
   isaf035 LIKE isaf_t.isaf035, 
   isaf048 LIKE isaf_t.isaf048, 
   isaf049 LIKE isaf_t.isaf049, 
   isaf201 LIKE isaf_t.isaf201, 
   isaf201_desc LIKE type_t.chr80, 
   isaf202 LIKE isaf_t.isaf202, 
   isaf202_desc LIKE type_t.chr80, 
   isaf203 LIKE isaf_t.isaf203, 
   isaf204 LIKE isaf_t.isaf204, 
   isaf207 LIKE isaf_t.isaf207, 
   isaf207_desc LIKE type_t.chr80, 
   isaf205 LIKE isaf_t.isaf205, 
   isaf206 LIKE isaf_t.isaf206, 
   isaf037 LIKE isaf_t.isaf037, 
   isaf037_desc LIKE type_t.chr80, 
   isaf038 LIKE isaf_t.isaf038, 
   isaf039 LIKE isaf_t.isaf039, 
   isaf040 LIKE isaf_t.isaf040, 
   isaf041 LIKE isaf_t.isaf041, 
   isaf041_desc LIKE type_t.chr80, 
   isaf042 LIKE isaf_t.isaf042, 
   isaf055 LIKE isaf_t.isaf055, 
   isaf055_desc LIKE type_t.chr80, 
   isaf007 LIKE isaf_t.isaf007, 
   isaf006 LIKE isaf_t.isaf006, 
   isaf006_desc LIKE type_t.chr80, 
   isaf050 LIKE isaf_t.isaf050, 
   isaf004 LIKE isaf_t.isaf004, 
   isaf004_desc LIKE type_t.chr80, 
   isaf044 LIKE isaf_t.isaf044, 
   isaf066 LIKE isaf_t.isaf066, 
   isaf019 LIKE isaf_t.isaf019, 
   isaf019_desc LIKE type_t.chr80, 
   isaf059 LIKE isaf_t.isaf059, 
   isaf060 LIKE isaf_t.isaf060, 
   isaf061 LIKE isaf_t.isaf061, 
   isaf063 LIKE isaf_t.isaf063, 
   isaf062 LIKE isaf_t.isaf062, 
   isaf064 LIKE isaf_t.isaf064, 
   isaf065 LIKE isaf_t.isaf065, 
   isaf208 LIKE isaf_t.isaf208, 
   isaf209 LIKE isaf_t.isaf209, 
   isaf210 LIKE isaf_t.isaf210, 
   isaf210_desc LIKE type_t.chr80, 
   isafownid LIKE isaf_t.isafownid, 
   isafownid_desc LIKE type_t.chr80, 
   isafowndp LIKE isaf_t.isafowndp, 
   isafowndp_desc LIKE type_t.chr80, 
   isafcrtid LIKE isaf_t.isafcrtid, 
   isafcrtid_desc LIKE type_t.chr80, 
   isafcrtdp LIKE isaf_t.isafcrtdp, 
   isafcrtdp_desc LIKE type_t.chr80, 
   isafcrtdt LIKE isaf_t.isafcrtdt, 
   isafmodid LIKE isaf_t.isafmodid, 
   isafmodid_desc LIKE type_t.chr80, 
   isafmoddt LIKE isaf_t.isafmoddt, 
   isafcnfid LIKE isaf_t.isafcnfid, 
   isafcnfid_desc LIKE type_t.chr80, 
   isafcnfdt LIKE isaf_t.isafcnfdt, 
   l_isaf103_s LIKE type_t.num20_6, 
   l_isaf104_s LIKE type_t.num20_6, 
   l_isaf105_s LIKE type_t.num20_6, 
   l_isaf113_s LIKE type_t.num20_6, 
   l_isaf114_s LIKE type_t.num20_6, 
   l_isaf115_s LIKE type_t.num20_6
       END RECORD
 
#單身 type 宣告
PRIVATE TYPE type_g_isag_d        RECORD
       isagseq LIKE isag_t.isagseq, 
   isagorga LIKE isag_t.isagorga, 
   isagorga_desc LIKE type_t.chr500, 
   isag001 LIKE isag_t.isag001, 
   isag002 LIKE isag_t.isag002, 
   isag003 LIKE isag_t.isag003, 
   isag018 LIKE isag_t.isag018, 
   isag009 LIKE isag_t.isag009, 
   isag010 LIKE isag_t.isag010, 
   imaal004 LIKE type_t.chr500, 
   isag016 LIKE isag_t.isag016, 
   isag017 LIKE isag_t.isag017, 
   isag015 LIKE isag_t.isag015, 
   inag009 LIKE type_t.num20_6, 
   xmdl047 LIKE type_t.num20_6, 
   inag007 LIKE type_t.chr10, 
   inag007_desc LIKE type_t.chr100, 
   isag006 LIKE isag_t.isag006, 
   isag008 LIKE isag_t.isag008, 
   isag012 LIKE isag_t.isag012, 
   l_xmdk030 LIKE type_t.chr500, 
   isag004 LIKE isag_t.isag004, 
   isag005 LIKE isag_t.isag005, 
   isag005_desc LIKE type_t.chr100, 
   isag101 LIKE isag_t.isag101, 
   isag103 LIKE isag_t.isag103, 
   isag104 LIKE isag_t.isag104, 
   isag105 LIKE isag_t.isag105, 
   isag113 LIKE isag_t.isag113, 
   isag114 LIKE isag_t.isag114, 
   isag115 LIKE isag_t.isag115, 
   isag116 LIKE isag_t.isag116, 
   isag117 LIKE isag_t.isag117, 
   isag013 LIKE isag_t.isag013, 
   isag014 LIKE isag_t.isag014, 
   isag011 LIKE isag_t.isag011
       END RECORD
PRIVATE TYPE type_g_isag2_d RECORD
       isahseq LIKE isah_t.isahseq, 
   isahorga LIKE isah_t.isahorga, 
   isahorga_desc LIKE type_t.chr500, 
   isah003 LIKE isah_t.isah003, 
   isah004 LIKE isah_t.isah004, 
   isah013 LIKE isah_t.isah013, 
   isah005 LIKE isah_t.isah005, 
   isah005_desc LIKE type_t.chr100, 
   isah010 LIKE isah_t.isah010, 
   isah006 LIKE isah_t.isah006, 
   isah101 LIKE isah_t.isah101, 
   isah103 LIKE isah_t.isah103, 
   isah007 LIKE isah_t.isah007, 
   isah104 LIKE isah_t.isah104, 
   isah105 LIKE isah_t.isah105, 
   isah113 LIKE isah_t.isah113, 
   isah114 LIKE isah_t.isah114, 
   isah115 LIKE isah_t.isah115, 
   isah001 LIKE isah_t.isah001, 
   isah002 LIKE isah_t.isah002, 
   isah008 LIKE isah_t.isah008, 
   isah009 LIKE isah_t.isah009, 
   isah011 LIKE isah_t.isah011, 
   isah106 LIKE isah_t.isah106, 
   isah012 LIKE isah_t.isah012, 
   isah116 LIKE isah_t.isah116
       END RECORD
PRIVATE TYPE type_g_isag3_d RECORD
       xrcdld LIKE xrcd_t.xrcdld, 
   xrcdseq2 LIKE xrcd_t.xrcdseq2, 
   xrcdseq LIKE xrcd_t.xrcdseq, 
   xrcb005 LIKE type_t.chr500, 
   xrcd007 LIKE xrcd_t.xrcd007, 
   xrcd002 LIKE xrcd_t.xrcd002, 
   xrcd002_desc LIKE type_t.chr500, 
   xrcd003 LIKE xrcd_t.xrcd003, 
   xrcd006 LIKE xrcd_t.xrcd006, 
   xrcd005 LIKE xrcd_t.xrcd005, 
   xrcd104 LIKE xrcd_t.xrcd104, 
   xrcd103 LIKE xrcd_t.xrcd103, 
   xrcd105 LIKE xrcd_t.xrcd105, 
   xrcd114 LIKE xrcd_t.xrcd114
       END RECORD
PRIVATE TYPE type_g_isag4_d RECORD
       isatseq LIKE isat_t.isatseq, 
   isat003 LIKE isat_t.isat003, 
   isat004 LIKE isat_t.isat004, 
   isat027 LIKE isat_t.isat027, 
   isat006 LIKE isat_t.isat006, 
   isat002 LIKE isat_t.isat002, 
   isat103 LIKE isat_t.isat103, 
   isat104 LIKE isat_t.isat104, 
   isat105 LIKE isat_t.isat105, 
   isat113 LIKE isat_t.isat113, 
   isat114 LIKE isat_t.isat114, 
   isat115 LIKE isat_t.isat115, 
   isat007 LIKE isat_t.isat007, 
   isat014 LIKE isat_t.isat014, 
   isat106 LIKE isat_t.isat106, 
   isat107 LIKE isat_t.isat107, 
   isat017 LIKE isat_t.isat017, 
   isatsite LIKE isat_t.isatsite, 
   isatdocdt LIKE isat_t.isatdocdt
       END RECORD
 
 
PRIVATE TYPE type_browser RECORD
         b_statepic     LIKE type_t.chr50,
            b_isafcomp LIKE isaf_t.isafcomp,
      b_isafdocno LIKE isaf_t.isafdocno
       END RECORD
       
#add-point:自定義模組變數(Module Variable) (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="global.variable"
DEFINE g_ooef002             LIKE ooef_t.ooef002
DEFINE g_ooef004             LIKE ooef_t.ooef004
DEFINE g_ooef019             LIKE ooef_t.ooef019
DEFINE g_glaa001             LIKE glaa_t.glaa001
DEFINE g_glaald              LIKE glaa_t.glaald
DEFINE g_ooef017             LIKE ooef_t.ooef017
 TYPE type_g_isae_m RECORD
             type           LIKE type_t.chr1, 
             quota          LIKE type_t.num20_6,
             merge          LIKE type_t.chr1,
             isaesite       LIKE isae_t.isaesite, 
             isaesite_desc  LIKE type_t.chr80,
             isae001        LIKE isae_t.isae001, 
             isae014        LIKE isae_t.isae014, 
             isae008        LIKE isae_t.isae008, 
             isae012        LIKE isae_t.isae012
             END RECORD
DEFINE g_isae_m             type_g_isae_m
DEFINE g_isai002            LIKE isai_t.isai002
DEFINE g_isai003            LIKE isai_t.isai003    #161214-00053#1
DEFINE g_isai004            LIKE isai_t.isai004
DEFINE g_isai006            LIKE isai_t.isai006
DEFINE g_isai008            LIKE isai_t.isai008
DEFINE g_isac003            LIKE isac_t.isac003
DEFINE g_isaf003            LIKE isaf_t.isaf003
DEFINE g_isaf055            LIKE isaf_t.isaf055
DEFINE g_para_data          LIKE type_t.chr80
DEFINE g_oodb004            LIKE oodb_t.oodb004

#151231-00010#3-----s
DEFINE g_ctl_where          STRING    #交易對象控制組WHERE CON
#151231-00010#3-----e
DEFINE g_wc_cs_comp         STRING    #azzi800的權限可看的資料範圍  #160907-00041#1 add
DEFINE g_wc_isagorga        STRING                                #160907-00041#1 add
DEFINE g_sfin2023           LIKE type_t.chr10                     #161024-00065#2
DEFINE g_user_dept_wc       STRING                                #161104-00046#3
DEFINE g_user_dept_wc_q     STRING                                #161104-00046#3
DEFINE g_user_slip_wc       STRING                                #161104-00046#3
#end add-point
       
#模組變數(Module Variables)
DEFINE g_isaf_m          type_g_isaf_m
DEFINE g_isaf_m_t        type_g_isaf_m
DEFINE g_isaf_m_o        type_g_isaf_m
DEFINE g_isaf_m_mask_o   type_g_isaf_m #轉換遮罩前資料
DEFINE g_isaf_m_mask_n   type_g_isaf_m #轉換遮罩後資料
 
   DEFINE g_isafdocno_t LIKE isaf_t.isafdocno
DEFINE g_isafcomp_t LIKE isaf_t.isafcomp
 
 
DEFINE g_isag_d          DYNAMIC ARRAY OF type_g_isag_d
DEFINE g_isag_d_t        type_g_isag_d
DEFINE g_isag_d_o        type_g_isag_d
DEFINE g_isag_d_mask_o   DYNAMIC ARRAY OF type_g_isag_d #轉換遮罩前資料
DEFINE g_isag_d_mask_n   DYNAMIC ARRAY OF type_g_isag_d #轉換遮罩後資料
DEFINE g_isag2_d          DYNAMIC ARRAY OF type_g_isag2_d
DEFINE g_isag2_d_t        type_g_isag2_d
DEFINE g_isag2_d_o        type_g_isag2_d
DEFINE g_isag2_d_mask_o   DYNAMIC ARRAY OF type_g_isag2_d #轉換遮罩前資料
DEFINE g_isag2_d_mask_n   DYNAMIC ARRAY OF type_g_isag2_d #轉換遮罩後資料
DEFINE g_isag3_d          DYNAMIC ARRAY OF type_g_isag3_d
DEFINE g_isag3_d_t        type_g_isag3_d
DEFINE g_isag3_d_o        type_g_isag3_d
DEFINE g_isag3_d_mask_o   DYNAMIC ARRAY OF type_g_isag3_d #轉換遮罩前資料
DEFINE g_isag3_d_mask_n   DYNAMIC ARRAY OF type_g_isag3_d #轉換遮罩後資料
DEFINE g_isag4_d          DYNAMIC ARRAY OF type_g_isag4_d
DEFINE g_isag4_d_t        type_g_isag4_d
DEFINE g_isag4_d_o        type_g_isag4_d
DEFINE g_isag4_d_mask_o   DYNAMIC ARRAY OF type_g_isag4_d #轉換遮罩前資料
DEFINE g_isag4_d_mask_n   DYNAMIC ARRAY OF type_g_isag4_d #轉換遮罩後資料
 
 
DEFINE g_browser         DYNAMIC ARRAY OF type_browser
DEFINE g_browser_f       DYNAMIC ARRAY OF type_browser
 
 
DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc2_table1          STRING
DEFINE g_wc2_table2   STRING
 
DEFINE g_wc2_table3   STRING
 
DEFINE g_wc2_table4   STRING
 
 
 
DEFINE g_wc2_extend          STRING
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING
 
DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10     
DEFINE g_jump                LIKE type_t.num10        
DEFINE g_no_ask              LIKE type_t.num5        
DEFINE g_rec_b               LIKE type_t.num10           
DEFINE l_ac                  LIKE type_t.num10    
DEFINE g_curr_diag           ui.Dialog                         #Current Dialog
                                                               
DEFINE g_pagestart           LIKE type_t.num10                 
DEFINE gwin_curr             ui.Window                         #Current Window
DEFINE gfrm_curr             ui.Form                           #Current Form
DEFINE g_page_action         STRING                            #page action
DEFINE g_header_hidden       LIKE type_t.num5                  #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5                  #隱藏工作Panel
DEFINE g_page                STRING                            #第幾頁
DEFINE g_state               STRING       
DEFINE g_header_cnt          LIKE type_t.num10
DEFINE g_detail_cnt          LIKE type_t.num10                  #單身總筆數
DEFINE g_detail_idx          LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx_tmp      LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx2         LIKE type_t.num10                  #單身2目前所在筆數
DEFINE g_detail_idx_list     DYNAMIC ARRAY OF LIKE type_t.num10 #單身2目前所在筆數
DEFINE g_browser_cnt         LIKE type_t.num10                  #Browser總筆數
DEFINE g_browser_idx         LIKE type_t.num10                  #Browser目前所在筆數
DEFINE g_temp_idx            LIKE type_t.num10                  #Browser目前所在筆數(暫存用)
DEFINE g_order               STRING                             #查詢排序欄位
                                                        
DEFINE g_current_row         LIKE type_t.num10                  #Browser所在筆數
DEFINE g_current_sw          BOOLEAN                            #Browser所在筆數用開關
DEFINE g_current_page        LIKE type_t.num10                  #目前所在頁數
DEFINE g_insert              LIKE type_t.chr5                   #是否導到其他page
 
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_bfill               LIKE type_t.chr5              #是否刷新單身
DEFINE g_error_show          LIKE type_t.num5              #是否顯示筆數提示訊息
DEFINE g_master_insert       BOOLEAN                       #確認單頭資料是否寫入
 
DEFINE g_wc_frozen           STRING                        #凍結欄位使用
DEFINE g_chk                 BOOLEAN                       #助記碼判斷用
DEFINE g_aw                  STRING                        #確定當下點擊的單身
DEFINE g_default             BOOLEAN                       #是否有外部參數查詢
DEFINE g_log1                STRING                        #log用
DEFINE g_log2                STRING                        #log用
DEFINE g_loc                 LIKE type_t.chr5              #判斷游標所在位置
DEFINE g_add_browse          STRING                        #新增填充用WC
DEFINE g_update              BOOLEAN                       #確定單頭/身是否異動過
DEFINE g_idx_group           om.SaxAttributes              #頁籤群組
DEFINE g_master_commit       LIKE type_t.chr1              #確認單頭是否修改過
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
 
#add-point:傳入參數說明(global.argv) name="global.argv"

#end add-point
 
{</section>}
 
{<section id="aist310.main" >}
#應用 a26 樣板自動產生(Version:7)
#+ 作業開始(主程式類型)
MAIN
   #add-point:main段define(客製用) name="main.define_customerization"
   
   #end add-point   
   #add-point:main段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="main.define"
   
   #end add-point   
   
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("ais","")
 
   #add-point:作業初始化 name="main.init"
   #151231-00010#3-----s
   #CALL s_control_get_customer_sql('2',g_site,g_user,g_dept,'') RETURNING g_sub_success,g_ctl_where #161222-00029#1 mark
   #151231-00010#3-----e
   #161222-00029#1 add ------
   SELECT ooef017 INTO g_isaf_m.isafcomp
     FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = g_site
      AND ooefstus = 'Y'
   CALL s_control_get_customer_sql_pmab('4',g_site,g_user,g_dept,'',g_isaf_m.isafcomp) RETURNING g_sub_success,g_ctl_where
   #161222-00029#1 add end---
   CALL aist310_isag002_ref_pre()   #160414-00018#2
   #161104-00046#3-----s
   #建立與單頭array相同的temptable
   CALL s_aooi200def_create('','g_isaf_m','','','','','','')RETURNING g_sub_success
   
   #單別控制組
   LET g_user_dept_wc = ''
   CALL s_fin_get_user_dept_control('isafcomp','','isafent','isafdocno') RETURNING g_user_dept_wc
   #開窗使用
   LET g_user_dept_wc_q = g_user_dept_wc
   
   CALL s_control_get_docno_sql(g_user,g_dept) RETURNING g_sub_success,g_user_slip_wc  
   #161104-00046#3-----e
   #end add-point
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define name="main.define_sql"
   
   #end add-point
   LET g_forupd_sql = " SELECT isafsite,'',isafdocno,'',isaf001,isafcomp,'',isafdocdt,isaf056,isaf005, 
       '',isaf057,'',isaf003,'',isaf067,isafstus,isaf008,'',isaf016,isaf014,'','',isaf052,'',isaf018, 
       isaf051,'',isaf017,isaf010,isaf012,isaf100,isaf011,isaf101,isaf054,isaf002,'',isaf021,isaf022, 
       isaf023,isaf024,isaf025,isaf026,isaf045,isaf027,isaf028,isaf029,isaf030,isaf031,isaf032,isaf046, 
       isaf103,isaf104,isaf105,isaf106,isaf107,isaf108,isaf113,isaf114,isaf115,isaf116,isaf117,isaf118, 
       isaf119,isaf120,isaf121,isaf033,isaf034,isaf035,isaf048,isaf049,isaf201,'',isaf202,'',isaf203, 
       isaf204,isaf207,'',isaf205,isaf206,isaf037,'',isaf038,isaf039,isaf040,isaf041,'',isaf042,isaf055, 
       '',isaf007,isaf006,'',isaf050,isaf004,'',isaf044,isaf066,isaf019,'',isaf059,isaf060,isaf061,isaf063, 
       isaf062,isaf064,isaf065,isaf208,isaf209,isaf210,'',isafownid,'',isafowndp,'',isafcrtid,'',isafcrtdp, 
       '',isafcrtdt,isafmodid,'',isafmoddt,isafcnfid,'',isafcnfdt,'','','','','',''", 
                      " FROM isaf_t",
                      " WHERE isafent= ? AND isafcomp=? AND isafdocno=? FOR UPDATE"
   #add-point:SQL_define name="main.after_define_sql"
   
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aist310_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT DISTINCT t0.isafsite,t0.isafdocno,t0.isaf001,t0.isafcomp,t0.isafdocdt,t0.isaf056, 
       t0.isaf005,t0.isaf057,t0.isaf003,t0.isaf067,t0.isafstus,t0.isaf008,t0.isaf016,t0.isaf014,t0.isaf053, 
       t0.isaf052,t0.isaf018,t0.isaf051,t0.isaf009,t0.isaf017,t0.isaf010,t0.isaf012,t0.isaf100,t0.isaf011, 
       t0.isaf101,t0.isaf054,t0.isaf002,t0.isaf021,t0.isaf022,t0.isaf023,t0.isaf024,t0.isaf025,t0.isaf026, 
       t0.isaf045,t0.isaf027,t0.isaf028,t0.isaf029,t0.isaf030,t0.isaf031,t0.isaf032,t0.isaf046,t0.isaf103, 
       t0.isaf104,t0.isaf105,t0.isaf106,t0.isaf107,t0.isaf108,t0.isaf113,t0.isaf114,t0.isaf115,t0.isaf116, 
       t0.isaf117,t0.isaf118,t0.isaf119,t0.isaf120,t0.isaf121,t0.isaf033,t0.isaf034,t0.isaf035,t0.isaf048, 
       t0.isaf049,t0.isaf201,t0.isaf202,t0.isaf203,t0.isaf204,t0.isaf207,t0.isaf205,t0.isaf206,t0.isaf037, 
       t0.isaf038,t0.isaf039,t0.isaf040,t0.isaf041,t0.isaf042,t0.isaf055,t0.isaf007,t0.isaf006,t0.isaf050, 
       t0.isaf004,t0.isaf044,t0.isaf066,t0.isaf019,t0.isaf059,t0.isaf060,t0.isaf061,t0.isaf063,t0.isaf062, 
       t0.isaf064,t0.isaf065,t0.isaf208,t0.isaf209,t0.isaf210,t0.isafownid,t0.isafowndp,t0.isafcrtid, 
       t0.isafcrtdp,t0.isafcrtdt,t0.isafmodid,t0.isafmoddt,t0.isafcnfid,t0.isafcnfdt,t1.ooefl003 ,t2.ooefl003 , 
       t3.ooag011 ,t4.ooag011 ,t5.pmaal004 ,t6.ooefl003 ,t7.pmaal004 ,t8.oocql004 ,t9.oocql004 ,t10.oocql004 , 
       t11.oocql004 ,t12.ooag011 ,t13.pmaal004 ,t14.ooefl003 ,t15.ooefl003 ,t16.ooefl003 ,t17.ooag011 , 
       t18.ooefl003 ,t19.ooag011 ,t20.ooefl003 ,t21.ooag011 ,t22.ooag011",
               " FROM isaf_t t0",
                              " LEFT JOIN ooefl_t t1 ON t1.ooeflent="||g_enterprise||" AND t1.ooefl001=t0.isafsite AND t1.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.isafcomp AND t2.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t3 ON t3.ooagent="||g_enterprise||" AND t3.ooag001=t0.isaf005  ",
               " LEFT JOIN ooag_t t4 ON t4.ooagent="||g_enterprise||" AND t4.ooag001=t0.isaf057  ",
               " LEFT JOIN pmaal_t t5 ON t5.pmaalent="||g_enterprise||" AND t5.pmaal001=t0.isaf003 AND t5.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t6 ON t6.ooeflent="||g_enterprise||" AND t6.ooefl001=t0.isaf052 AND t6.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t7 ON t7.pmaalent="||g_enterprise||" AND t7.pmaal001=t0.isaf002 AND t7.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t8 ON t8.oocqlent="||g_enterprise||" AND t8.oocql001='3801' AND t8.oocql002=t0.isaf201 AND t8.oocql003='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t9 ON t9.oocqlent="||g_enterprise||" AND t9.oocql001='3802' AND t9.oocql002=t0.isaf202 AND t9.oocql003='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t10 ON t10.oocqlent="||g_enterprise||" AND t10.oocql001='3803' AND t10.oocql002=t0.isaf207 AND t10.oocql003='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t11 ON t11.oocqlent="||g_enterprise||" AND t11.oocql001='3804' AND t11.oocql002=t0.isaf037 AND t11.oocql003='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t12 ON t12.ooagent="||g_enterprise||" AND t12.ooag001=t0.isaf041  ",
               " LEFT JOIN pmaal_t t13 ON t13.pmaalent="||g_enterprise||" AND t13.pmaal001=t0.isaf055 AND t13.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t14 ON t14.ooeflent="||g_enterprise||" AND t14.ooefl001=t0.isaf006 AND t14.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t15 ON t15.ooeflent="||g_enterprise||" AND t15.ooefl001=t0.isaf004 AND t15.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t16 ON t16.ooeflent="||g_enterprise||" AND t16.ooefl001=t0.isaf210 AND t16.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t17 ON t17.ooagent="||g_enterprise||" AND t17.ooag001=t0.isafownid  ",
               " LEFT JOIN ooefl_t t18 ON t18.ooeflent="||g_enterprise||" AND t18.ooefl001=t0.isafowndp AND t18.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t19 ON t19.ooagent="||g_enterprise||" AND t19.ooag001=t0.isafcrtid  ",
               " LEFT JOIN ooefl_t t20 ON t20.ooeflent="||g_enterprise||" AND t20.ooefl001=t0.isafcrtdp AND t20.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t21 ON t21.ooagent="||g_enterprise||" AND t21.ooag001=t0.isafmodid  ",
               " LEFT JOIN ooag_t t22 ON t22.ooagent="||g_enterprise||" AND t22.ooag001=t0.isafcnfid  ",
 
               " WHERE t0.isafent = " ||g_enterprise|| " AND t0.isafcomp = ? AND t0.isafdocno = ?"
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
   #add-point:SQL_define name="main.after_refresh_sql"
   
   #end add-point
   PREPARE aist310_master_referesh FROM g_sql
 
    
 
   
   IF g_bgjob = "Y" THEN
      #add-point:Service Call name="main.servicecall"
      
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_aist310 WITH FORM cl_ap_formpath("ais",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL aist310_init()   
 
      #進入選單 Menu (="N")
      CALL aist310_ui_dialog() 
      
      #add-point:畫面關閉前 name="main.before_close"
      
      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_aist310
      
   END IF 
   
   CLOSE aist310_cl
   
   
 
   #add-point:作業離開前 name="main.exit"
   
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
 
 
 
{</section>}
 
{<section id="aist310.init" >}
#+ 瀏覽頁簽資料初始化
PRIVATE FUNCTION aist310_init()
   #add-point:init段define(客製用) name="init.define_customerization"
   
   #end add-point    
   #add-point:init段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="init.define"
   DEFINE l_sql      STRING
   DEFINE l_str      STRING
   DEFINE l_gzcb002  LIKE gzcb_t.gzcb002 
   DEFINE l_success  LIKE type_t.num5     #160316-00017#2 add lujh
   #end add-point   
   
   #add-point:Function前置處理  name="init.pre_function"
   
   #end add-point
   
   LET g_bfill       = "Y"
   LET g_detail_idx  = 1 #第一層單身指標
   LET g_detail_idx2 = 1 #第二層單身指標
   
   #各個page指標
   LET g_detail_idx_list[1] = 1 
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
   LET g_detail_idx_list[4] = 1
 
   LET g_error_show  = 1
   LET l_ac = 1 #單身指標
      CALL cl_set_combo_scc_part('isafstus','13','N,Y,S,A,D,R,W,X')
 
      CALL cl_set_combo_scc('isaf001','9715') 
   CALL cl_set_combo_scc('isaf059','9746') 
   CALL cl_set_combo_scc('isaf060','9736') 
   CALL cl_set_combo_scc('isag001','24') 
 
   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件
   
   #page群組
   LET g_idx_group = om.SaxAttributes.create()
   CALL g_idx_group.addAttribute("'1',","1")
   CALL g_idx_group.addAttribute("'2',","1")
   CALL g_idx_group.addAttribute("'3',","1")
   CALL g_idx_group.addAttribute("'4',","1")
 
 
   #add-point:畫面資料初始化 name="init.init"
   CALL cl_set_combo_scc('isaf059','9746') #150512-00024#1
   CALL cl_set_combo_scc('isaf060','9736') #150512-00024#1
   CALL cl_set_combo_scc('isaf001','9715')
   CALL cl_set_combo_scc('isaf056','9741')
   CALL cl_set_combo_scc('isaf053','9734')
   CALL cl_set_combo_scc('isaf050','8324')
   CALL cl_set_combo_scc('isag001','8341')   
   CALL cl_set_combo_scc('isat014','9716')
   CALL cl_set_combo_scc('isat014','9716')
   CALL s_fin_create_account_center_tmp()
   CALL s_dep_pay_cre_tmp() RETURNING l_success   #160316-00017#2 add lujh

   #160907-00041#1 --s add
   #查詢時azzi800法人權限
   CALL s_fin_azzi800_sons_query(g_today)
   CALL s_fin_account_center_comp_str() RETURNING g_wc_cs_comp   
   CALL s_fin_account_center_sons_str() RETURNING g_wc_isagorga  #組織查詢時開窗
   CALL s_fin_get_wc_str(g_wc_cs_comp) RETURNING g_wc_cs_comp
   CALL s_fin_get_wc_str(g_wc_isagorga) RETURNING g_wc_isagorga  
   #160907-00041#1 --e add
   #end add-point
   
   #初始化搜尋條件
   CALL aist310_default_search()
    
END FUNCTION
 
{</section>}
 
{<section id="aist310.ui_dialog" >}
#+ 功能選單
PRIVATE FUNCTION aist310_ui_dialog()
   #add-point:ui_dialog段define(客製用) name="ui_dialog.define_customerization"
   
   #end add-point
   DEFINE li_idx     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE lb_first   BOOLEAN
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE la_param   RECORD
          prog       STRING,
          actionid   STRING,
          background LIKE type_t.chr1,
          param      DYNAMIC ARRAY OF STRING
          END RECORD
   DEFINE ls_js      STRING
   DEFINE la_output  DYNAMIC ARRAY OF STRING   #報表元件鬆耦合使用
   DEFINE  l_cmd_token           base.StringTokenizer   #報表作業cmdrun使用 
   DEFINE  l_cmd_next            STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_cnt             LIKE type_t.num5       #報表作業cmdrun使用
   DEFINE  l_cmd_prog_arg        STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_arg             STRING                 #報表作業cmdrun使用
   #add-point:ui_dialog段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_dialog.define"
   DEFINE l_n      LIKE type_t.num5
   DEFINE l_success    LIKE type_t.num5
   DEFINE l_cmd    STRING

   #151020-00003#2---s
   DEFINE l_yer     LIKE isaa_t.isaa012       
   DEFINE l_mon     LIKE isaa_t.isaa013    
   DEFINE l_isaa012 LIKE isaa_t.isaa012
   DEFINE l_isaa013 LIKE isaa_t.isaa013
   DEFINE l_day1    LIKE type_t.dat
   DEFINE l_day2    LIKE type_t.dat
   #151020-00003#2---e
   #DEFINE l_isag118 LIKE isag_t.isag118
   DEFINE l_ooba002 LIKE type_t.chr10     #151209-00023#1 add lujhs
   DEFINE l_isao006 LIKE isao_t.isao006   #150703-00017#1 Add
   DEFINE l_flag    LIKE type_t.num5      #150703-00017#1 Add
   
   DEFINE l_sfin2022         LIKE type_t.chr10 #160907-00046#1 add
   
   #160907-00041#1 --s add
   DEFINE l_isae007              LIKE isae_t.isae007
   DEFINE l_isae012              LIKE isae_t.isae012
   DEFINE l_len                  LIKE type_t.num5
   DEFINE l_isae012_n            LIKE isae_t.isae012    #下次列印號碼
   DEFINE l_isae012_max          LIKE isae_t.isae012    #該次換開發票號碼最大號
   DEFINE l_isae012_max_des      LIKE isae_t.isae012    #該次作廢發票號碼最大號
   DEFINE l_add                  LIKE type_t.num10      #該次發票開票數
   DEFINE l_str                  STRING
   DEFINE l_sql                  STRING
   DEFINE l_isae012_str          STRING
   #160907-00041#1 --e add
   #161212-00075#1-----s
   DEFINE l_count                LIKE type_t.num10
   #161212-00075#1-----e
   DEFINE l_date                 DATETIME YEAR TO SECOND  #170120-00040#1
   #end add-point
   
   #add-point:Function前置處理  name="ui_dialog.pre_function"
   
   #end add-point
   
   CALL cl_set_act_visible("accept,cancel", FALSE)
 
   
   #action default動作
   #應用 a42 樣板自動產生(Version:3)
   #進入程式時預設執行的動作
   CASE g_actdefault
      WHEN "insert"
         LET g_action_choice="insert"
         LET g_actdefault = ""
         IF cl_auth_chk_act("insert") THEN
            CALL aist310_insert()
            #add-point:ON ACTION insert name="menu.default.insert"
            
            #END add-point
         END IF
 
      #add-point:action default自訂 name="ui_dialog.action_default"
      
      #end add-point
      OTHERWISE
   END CASE
 
 
 
   
   LET lb_first = TRUE
   
   #add-point:ui_dialog段before dialog  name="ui_dialog.before_dialog"
 
   #end add-point
   
   WHILE TRUE 
   
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_browser.clear()       
         INITIALIZE g_isaf_m.* TO NULL
         CALL g_isag_d.clear()
         CALL g_isag2_d.clear()
         CALL g_isag3_d.clear()
         CALL g_isag4_d.clear()
 
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL aist310_init()
      END IF
   
            
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
    
         DISPLAY ARRAY g_isag_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1  
    
            BEFORE ROW
               #顯示單身筆數
               CALL aist310_idx_chk()
               #確定當下選擇的筆數
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[1] = l_ac
               CALL g_idx_group.addAttribute("'1',",l_ac)
               
               #add-point:page1, before row動作 name="ui_dialog.page1.before_row"
               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_current_page = 1
               #顯示單身筆數
               CALL aist310_idx_chk()
               #add-point:page1自定義行為 name="ui_dialog.page1.before_display"
               
               #end add-point
               
            #自訂ACTION(detail_show,page_1)
            
               
            #add-point:page1自定義行為 name="ui_dialog.page1.action"
            
            #end add-point
               
         END DISPLAY
        
         #第一階單身段落
         DISPLAY ARRAY g_isag2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL aist310_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[2] = l_ac
               CALL g_idx_group.addAttribute("'2',",l_ac)
               
               #add-point:page2, before row動作 name="ui_dialog.body2.before_row"
               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'2',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_current_page = 2
               #顯示單身筆數
               CALL aist310_idx_chk()
               #add-point:page2自定義行為 name="ui_dialog.body2.before_display"
               
               #end add-point
      
            #自訂ACTION(detail_show,page_2)
            
         
            #add-point:page2自定義行為 name="ui_dialog.body2.action"
            
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_isag3_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL aist310_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[3] = l_ac
               CALL g_idx_group.addAttribute("'3',",l_ac)
               
               #add-point:page3, before row動作 name="ui_dialog.body3.before_row"
               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_current_page = 3
               #顯示單身筆數
               CALL aist310_idx_chk()
               #add-point:page3自定義行為 name="ui_dialog.body3.before_display"
               
               #end add-point
      
            #自訂ACTION(detail_show,page_3)
            
         
            #add-point:page3自定義行為 name="ui_dialog.body3.action"
            
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_isag4_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL aist310_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[4] = l_ac
               CALL g_idx_group.addAttribute("'4',",l_ac)
               
               #add-point:page4, before row動作 name="ui_dialog.body4.before_row"
               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'4',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               LET g_current_page = 4
               #顯示單身筆數
               CALL aist310_idx_chk()
               #add-point:page4自定義行為 name="ui_dialog.body4.before_display"
               
               #end add-point
      
            #自訂ACTION(detail_show,page_4)
            
         
            #add-point:page4自定義行為 name="ui_dialog.body4.action"
            
            #end add-point
         
         END DISPLAY
 
         
 
         
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
 
         #end add-point
         
      
         BEFORE DIALOG
            #先填充browser資料
            CALL aist310_browser_fill("")
            CALL cl_notice()
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            
            #確保g_current_idx位於正常區間內
            #小於,等於0則指到第1筆
            IF g_current_idx <= 0 THEN
               LET g_current_idx = 1
            END IF
            #超過最大筆數則指到最後1筆
            IF g_current_idx > g_browser.getLength() THEN
               LEt g_current_idx = g_browser.getLength()
            END IF 
            
            LET g_current_sw = TRUE
            LET g_current_row = g_current_idx #目前指標
            
            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL aist310_fetch('') # reload data
            END IF
            #LET g_detail_idx = 1
            CALL aist310_ui_detailshow() #Setting the current row 
            
            #筆數顯示
            LET g_current_page = 1
            CALL aist310_idx_chk()
            CALL cl_ap_performance_cal()
            #add-point:ui_dialog段before_dialog2 name="ui_dialog.before_dialog2"
            
            #end add-point
 
         #add-point:ui_dialog段more_action name="ui_dialog.more_action"
         
         #end add-point
 
         #狀態碼切換
         ON ACTION statechange
            LET g_action_choice = "statechange"
            CALL aist310_statechange()
            #根據資料狀態切換action狀態
            CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
            CALL aist310_set_act_visible()   
            CALL aist310_set_act_no_visible()
            IF NOT (g_isaf_m.isafcomp IS NULL
              OR g_isaf_m.isafdocno IS NULL
 
              ) THEN
               #組合條件
               LET g_add_browse = " isafent = " ||g_enterprise|| " AND",
                                  " isafcomp = '", g_isaf_m.isafcomp, "' "
                                  ," AND isafdocno = '", g_isaf_m.isafdocno, "' "
 
               #填到對應位置
               CALL aist310_browser_fill("")
            END IF
         #應用 a32 樣板自動產生(Version:3)
         #簽核狀況
         ON ACTION bpm_status
            #查詢簽核狀況, 統一建立HyperLink
            CALL cl_bpm_status()
            #add-point:ON ACTION bpm_status name="menu.bpm_status"
            
            #END add-point
 
 
 
          
         #查詢方案選擇 
         ON ACTION queryplansel
            CALL cl_dlg_qryplan_select() RETURNING ls_wc
            #不是空條件才寫入g_wc跟重新找資料
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
               INITIALIZE g_wc2_table4 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "isaf_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "isag_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "isah_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "xrcd_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "isat_t" 
                        LET g_wc2_table4 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
                  OR NOT cl_null(g_wc2_table4)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  #組合g_wc2
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
                  IF g_wc2_table4 <> " 1=1" AND NOT cl_null(g_wc2_table4) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
 
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
               END IF
               CALL aist310_browser_fill("F")   #browser_fill()會將notice區塊清空
            END IF
         
         #查詢方案選擇
         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
               INITIALIZE g_wc2_table4 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "isaf_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "isag_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "isah_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "xrcd_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "isat_t" 
                        LET g_wc2_table4 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1)
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
                  OR NOT cl_null(g_wc2_table4)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
                  IF g_wc2_table4 <> " 1=1" AND NOT cl_null(g_wc2_table4) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
                  #取得條件後需要重查、跳到結果第一筆資料的功能程式段
                  CALL aist310_browser_fill("F")
                  IF g_browser_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "" 
                     LET g_errparam.code = "-100" 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     CLEAR FORM
                  ELSE
                     CALL aist310_fetch("F")
                  END IF
               END IF
            END IF
            #重新搜尋會將notice區塊清空,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
          
         
         
         ON ACTION first
            LET g_action_choice = "fetch"
            CALL aist310_fetch('F')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist310_idx_chk()
            
         ON ACTION previous
            LET g_action_choice = "fetch"
            CALL aist310_fetch('P')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist310_idx_chk()
            
         ON ACTION jump
            LET g_action_choice = "fetch"
            CALL aist310_fetch('/')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist310_idx_chk()
            
         ON ACTION next
            LET g_action_choice = "fetch"
            CALL aist310_fetch('N')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist310_idx_chk()
            
         ON ACTION last
            LET g_action_choice = "fetch"
            CALL aist310_fetch('L')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist310_idx_chk()
          
         #excel匯出功能          
         ON ACTION exporttoexcel
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN
               #browser
               CALL g_export_node.clear()
               IF g_main_hidden = 1 THEN
                  LET g_export_node[1] = base.typeInfo.create(g_browser)
                  LET g_export_id[1]   = "s_browse"
                  CALL cl_export_to_excel()
               #非browser
               ELSE
                  LET g_export_node[1] = base.typeInfo.create(g_isag_d)
                  LET g_export_id[1]   = "s_detail1"
                  LET g_export_node[2] = base.typeInfo.create(g_isag2_d)
                  LET g_export_id[2]   = "s_detail2"
                  LET g_export_node[3] = base.typeInfo.create(g_isag3_d)
                  LET g_export_id[3]   = "s_detail3"
                  LET g_export_node[4] = base.typeInfo.create(g_isag4_d)
                  LET g_export_id[4]   = "s_detail4"
 
                  #add-point:ON ACTION exporttoexcel name="menu.exporttoexcel"
                  
                  #END add-point
                  CALL cl_export_to_excel_getpage()
                  CALL cl_export_to_excel()
               END IF
            END IF
        
         ON ACTION close
            LET INT_FLAG = FALSE
            LET g_action_choice = "exit"
            EXIT DIALOG
          
         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT DIALOG
    
         #主頁摺疊
         ON ACTION mainhidden       
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
               CALL cl_notice()
            END IF
            
       
         #單頭摺疊，可利用hot key "Alt-s"開啟/關閉單頭
         ON ACTION controls     
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("vb_master",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("vb_master",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden     
            END IF
    
         
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL aist310_modify()
               #add-point:ON ACTION modify name="menu.modify"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = g_curr_diag.getCurrentItem()
               CALL aist310_modify()
               #add-point:ON ACTION modify_detail name="menu.modify_detail"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION posted
            LET g_action_choice="posted"
            IF cl_auth_chk_act("posted") THEN
               
               #add-point:ON ACTION posted name="menu.posted"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION unposted
            LET g_action_choice="unposted"
            IF cl_auth_chk_act("unposted") THEN
               
               #add-point:ON ACTION unposted name="menu.unposted"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL aist310_delete()
               #add-point:ON ACTION delete name="menu.delete"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL aist310_insert()
               #add-point:ON ACTION insert name="menu.insert"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION aist310_invpnt
            LET g_action_choice="aist310_invpnt"
            IF cl_auth_chk_act("aist310_invpnt") THEN
               
               #add-point:ON ACTION aist310_invpnt name="menu.aist310_invpnt"
               #160530-00005#1 --s mark
               ##151020-00003#2---s
               ##原aist310_02的程式段，搬移至此 (aist310_02原已不被使用，因此由其他子程式命名用，發票列印呼叫改到此段)
               #IF g_isaf_m.isafstus <> 'Y' AND g_isaf_m.isafstus <> 'S' THEN 
               #   INITIALIZE g_errparam TO NULL
               #   LET g_errparam.code = 'ais-00034'
               #   LET g_errparam.extend = ''
               #   LET g_errparam.popup = TRUE
               #   CALL cl_err()
               #
               #   EXIT DIALOG
               #END IF
               #
               #LET la_param.prog = "aisq310"
               #LET la_param.param[1] = g_isaf_m.isaf006
               #LET la_param.param[2] = g_isaf_m.isaf004
               #LET la_param.param[3] = g_isaf_m.isaf008
               #LET ls_js = util.JSON.stringify(la_param)
               #CALL cl_cmdrun(ls_js)
               #
               #CALL aist310_show()
               ##151020-00003#2---e
               #160530-00005#1 --e mark
               
               #160530-00005#1 --s add
               IF g_isaf_m.isafstus <> 'Y' AND g_isaf_m.isafstus <> 'S' THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00034'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  EXIT DIALOG
               END IF
               #160704-00017#1 ---(S)                 
               CASE              
                  WHEN g_isaf_m.isaf009 = 'Y' #電子發票否=Y
                     LET la_param.prog = "aisr520"
                     LET la_param.param[1] = g_isaf_m.isafdocno #對帳單號
                     LET la_param.param[2] = g_isaf_m.isaf011   #發票號碼
                  WHEN g_isaf_m.isaf056 = '2' AND g_isaf_m.isaf009 = 'N' #發票性質=2 電子發票否=N
                     LET la_param.prog = "aisp350"
                     LET la_param.param[1] = g_isaf_m.isafcomp  #法人
                     LET la_param.param[2] = g_isaf_m.isafdocno #對帳單號
                     LET la_param.param[3] = g_isaf_m.isaf008 #發票類型
                     LET la_param.param[4] = g_isaf_m.isaf014 #發票日期
                  OTHERWISE
                     LET la_param.prog = "aisp330"               
                     LET la_param.param[1] = g_isaf_m.isafdocno #對帳單號
                     LET la_param.param[2] = g_isaf_m.isaf008 #發票類型
                     LET la_param.param[3] = g_isaf_m.isaf014 #發票日期
                     LET la_param.param[4] = g_isaf_m.isaf051 #發票簿號   #170220-00041#1  add
                     LET la_param.param[5] = g_isaf_m.isaf011 #發票號碼   #170220-00041#1  add
                     LET la_param.param[6] = g_isaf_m.isafsite #組織      #170220-00041#1  add
                     LET la_param.param[7] = g_isaf_m.isafcomp #法人      #170220-00041#1  add
               END CASE                                   
               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun(ls_js)
               #160704-00017#1 ---(E)
               #160704-00017#1 Mark ---(S)---
               #LET la_param.prog = "aisp330"
               #CASE 
               #   WHEN g_isaf_m.isaf009 = 'Y'
               #      LET la_param.prog = "aisr520"
               #   WHEN g_isaf_m.isaf056 = '2' AND g_isaf_m.isaf009 = 'N'
               #      LET la_param.prog = "aisp350"
               #END CASE
               #IF g_isaf_m.isaf009 = 'Y' THEN
               #   LET la_param.param[1] = g_isaf_m.isafdocno
               #   LET la_param.param[2] = g_isaf_m.isaf011
               #ELSE
               #   LET la_param.param[1] = g_isaf_m.isafcomp
               #END IF                
               #LET ls_js = util.JSON.stringify(la_param)
               #CALL cl_cmdrun(ls_js)
               #160704-00017#1 ---(E)---
               CALL aist310_show()
               #160530-00005#1 --e add
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN
               
               #add-point:ON ACTION output name="menu.output"
               #160930-00020#1 mark-----s
               ##150703-00017#1 Add  ---(S)---
               #SELECT isao006 INTO l_isao006 FROM isao_t WHERE isaoent = g_enterprise
               #  AND isaosite = g_isaf_m.isafcomp
               #  AND isaostus = 'Y'
               #IF l_isao006 = 'Y' THEN
               #   CALL cl_ask_confirm('ais-00314') RETURNING l_flag
               #END IF
               #CASE
               #   WHEN l_isao006 = 'Y' AND l_flag
               #      CALL la_param.param.CLEAR()
               #      LET la_param.prog = 'aisp701'
               #      LET la_param.param[1] = g_isaf_m.isafdocno
               #      LET la_param.param[2] = g_isaf_m.isafsite
               #      LET la_param.param[3] = g_isaf_m.isafcomp
               #      LET la_param.param[4] = g_isaf_m.isafdocdt
               #      LET la_param.param[5] = g_isaf_m.isaf003
               #      LET la_param.param[6] = g_isaf_m.isaf008
               #      LET la_param.param[7] = g_isaf_m.isaf057
               #      LET la_param.param[8] = g_isaf_m.isaf005
               #      LET ls_js = util.JSON.stringify( la_param )
               #      CALL cl_cmdrun(ls_js)
               #   OTHERWISE
               #      #電子發票列印補印 
               #      IF g_isaf_m.isaf009 = 'Y' THEN
               #         CALL la_param.param.CLEAR()
               #         LET la_param.prog = 'aisr520'
               #         LET la_param.param[1] = g_isaf_m.isafdocno
               #         IF g_isaf_m.isaf011 = 'MULTI' THEN
               #            LET la_param.param[2] = ''
               #         ELSE
               #            LET la_param.param[2] = g_isaf_m.isaf011
               #         END IF
               #         LET ls_js = util.JSON.stringify( la_param )
               #         CALL cl_cmdrun(ls_js)
               #      END IF
               #END CASE
               ##150703-00017#1 Add  ---(E)---
               ##電子發票列印補印 
               #IF g_isaf_m.isaf009 = 'Y' THEN
               #   CALL la_param.param.CLEAR()
               #   LET la_param.prog = 'aisr520'
               #   LET la_param.param[1] = g_isaf_m.isafdocno
               #   IF g_isaf_m.isaf011 = 'MULTI' THEN
               #      LET la_param.param[2] = ''
               #   ELSE
               #      LET la_param.param[2] = g_isaf_m.isaf011
               #   END IF
               #   LET ls_js = util.JSON.stringify( la_param )
               #   CALL cl_cmdrun(ls_js)
               #END IF
               #160930-00020#1 mark-----e
               #160930-00020#1---add---s
               LET g_rep_wc = "     isafent = '",g_enterprise,"' ",
                              " AND isafcomp = '",g_isaf_m.isafcomp,"' ",
                              " AND isafdocno = '",g_isaf_m.isafdocno,"' ",
                              " AND isafent = isagent AND isafcomp = isagcomp AND isafdocno = isagdocno "    
               #160930-00020#1---add---e

               #END add-point
               &include "erp/ais/aist310_rep.4gl"
               #add-point:ON ACTION output.after name="menu.after_output"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION quickprint
            LET g_action_choice="quickprint"
            IF cl_auth_chk_act("quickprint") THEN
               
               #add-point:ON ACTION quickprint name="menu.quickprint"
               #160930-00020#1 mark-----s
               ##150703-00017#1 Add  ---(S)---
               #SELECT isao006 INTO l_isao006 FROM isao_t WHERE isaoent = g_enterprise
               #  AND isaosite = g_isaf_m.isafcomp
               #  AND isaostus = 'Y'
               #IF l_isao006 = 'Y' THEN
               #   CALL cl_ask_confirm('ais-00314') RETURNING l_flag
               #END IF
               #CASE
               #   WHEN l_isao006 = 'Y' AND l_flag
               #      CALL la_param.param.CLEAR()
               #      LET la_param.prog = 'aisp701'
               #      LET la_param.param[1] = g_isaf_m.isafdocno
               #      LET la_param.param[2] = g_isaf_m.isafsite
               #      LET la_param.param[3] = g_isaf_m.isafcomp
               #      LET la_param.param[4] = g_isaf_m.isafdocdt
               #      LET la_param.param[5] = g_isaf_m.isaf003
               #      LET la_param.param[6] = g_isaf_m.isaf008
               #      LET la_param.param[7] = g_isaf_m.isaf057
               #      LET la_param.param[8] = g_isaf_m.isaf005
               #      LET ls_js = util.JSON.stringify( la_param )
               #      CALL cl_cmdrun(ls_js)
               #   OTHERWISE
               #      #電子發票列印補印 
               #      IF g_isaf_m.isaf009 = 'Y' THEN
               #         CALL la_param.param.CLEAR()
               #         LET la_param.prog = 'aisr520'
               #         LET la_param.param[1] = g_isaf_m.isafdocno
               #         IF g_isaf_m.isaf011 = 'MULTI' THEN
               #            LET la_param.param[2] = ''
               #         ELSE
               #            LET la_param.param[2] = g_isaf_m.isaf011
               #         END IF
               #         LET ls_js = util.JSON.stringify( la_param )
               #         CALL cl_cmdrun(ls_js)
               #      END IF
               #END CASE
               ##150703-00017#1 Add  ---(E)---
               ##電子發票列印補印 
               #IF g_isaf_m.isaf009 = 'Y' THEN
               #   CALL la_param.param.CLEAR()
               #   LET la_param.prog = 'aisr520'
               #   LET la_param.param[1] = g_isaf_m.isafdocno
               #   IF g_isaf_m.isaf011 = 'MULTI' THEN
               #      LET la_param.param[2] = ''
               #   ELSE
               #      LET la_param.param[2] = g_isaf_m.isaf011
               #   END IF
               #   LET ls_js = util.JSON.stringify( la_param )
               #   CALL cl_cmdrun(ls_js)
               #END IF
               #160930-00020#1 mark-----e
               #160930-00020#1---add---s
               LET g_rep_wc = "     isafent = '",g_enterprise,"' ",
                              " AND isafcomp = '",g_isaf_m.isafcomp,"' ",
                              " AND isafdocno = '",g_isaf_m.isafdocno,"' ",
                              " AND isafent = isagent AND isafcomp = isagcomp AND isafdocno = isagdocno "    
               #160930-00020#1---add---e

               #END add-point
               &include "erp/ais/aist310_rep.4gl"
               #add-point:ON ACTION quickprint.after name="menu.after_quickprint"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION invoice_update
            LET g_action_choice="invoice_update"
            IF cl_auth_chk_act("invoice_update") THEN
               
               #add-point:ON ACTION invoice_update name="menu.invoice_update"
               #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
               SELECT COUNT(1) INTO l_n #160907-00046#1
                 FROM isat_t
                WHERE isatent = g_enterprise
                  AND isatcomp = g_isaf_m.isafcomp
                  AND isatdocno = g_isaf_m.isafdocno
                  
               IF l_n > 0 THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00179'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                     
                  EXIT DIALOG
               END IF
               
               IF l_n = 0 AND (g_isaf_m.isafstus = 'Y' OR g_isaf_m.isafstus = 'S') THEN                
                  LET g_forupd_sql = "SELECT isahseq,isahorga,isah003,isah004,isah013,isah005,isah010,isah006,isah101, 
                                             isah103,isah007,isah104,isah105,isah113,isah114,isah115,isah001,isah002,isah008,isah009,isah011, 
                                             isah106,isah012 FROM isah_t WHERE isahent=? AND isahcomp=? AND isahdocno=? AND isahseq=? FOR  
                                             UPDATE"
                  
                  LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
                  LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
                  DECLARE aist310_bcl6 CURSOR FROM g_forupd_sql
                  CALL aist310_invoice_update()
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL aist310_query()
               #add-point:ON ACTION query name="menu.query"
               
               #END add-point
               #應用 a59 樣板自動產生(Version:3)  
               CALL g_curr_diag.setCurrentRow("s_detail1",1)
               CALL g_curr_diag.setCurrentRow("s_detail2",1)
               CALL g_curr_diag.setCurrentRow("s_detail3",1)
               CALL g_curr_diag.setCurrentRow("s_detail4",1)
 
 
 
 
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION invoice
            LET g_action_choice="invoice"
            IF cl_auth_chk_act("invoice") THEN
               
               #add-point:ON ACTION invoice name="menu.invoice"
               IF cl_null(g_isaf_m.isafdocno) AND cl_null(g_isaf_m.isafcomp) THEN 
                  EXIT DIALOG
               END IF
               
               #151029-00001#3 add ------
               #單據已作廢不可補登發票
               IF g_isaf_m.isafstus = 'X' THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00254'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  EXIT DIALOG
               END IF
               #151029-00001#3 add end--
                
               LET g_forupd_sql = "SELECT isatseq,isat003,isat004,isat103,isat104,isat105,isat007,isat014,isat106, 
                                   isat107,isat017 FROM isat_t WHERE isatent=? AND isatcomp=? AND isatdocno=? AND isatseq=? AND  
                                   isat003=? AND isat004=? FOR UPDATE"
               
               LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
               LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
               DECLARE aist310_bcl5 CURSOR FROM g_forupd_sql
               
               CALL aist310_invoice()
               CALL aist310_set_act_visible()      #160907-00041#1 add 
               CALL aist310_set_act_no_visible()   #160907-00041#1 add
               #161101-00039#1 --s add                               
               IF NOT (g_isaf_m.isafcomp IS NULL OR g_isaf_m.isafdocno IS NULL) THEN
                  #組合條件
                  LET g_add_browse = " isafent = " ||g_enterprise|| " AND",
                                     " isafcomp = '", g_isaf_m.isafcomp, "' "
                                     ," AND isafdocno = '", g_isaf_m.isafdocno, "' "
               
                  #填到對應位置
                  #LET g_wc = " isafent = ",g_enterprise," AND isafcomp = '",g_isaf_m.isafcomp,"' AND isafdocno = '",g_isaf_m.isafdocno,"' "
                  CALL aist310_browser_fill("")
                  LET g_no_ask = TRUE
                  LET g_jump = g_current_idx
                  CALL aist310_fetch('/')
                  CALL aist310_idx_chk()
               END IF               
               #161101-00039#1 --e add  
               CLOSE aist310_cl
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_aist310_02
            LET g_action_choice="open_aist310_02"
            IF cl_auth_chk_act("open_aist310_02") THEN
               
               #add-point:ON ACTION open_aist310_02 name="menu.open_aist310_02"
               #151020-00003#2---s
               #若申報年月大於本單據日期年月，則不可執行
               SELECT isaa012,isaa013 INTO l_isaa012,l_isaa013 FROM isaa_t WHERE isaaent = g_enterprise AND isaa001 = g_isaf_m.isafsite
               LET l_yer = YEAR(g_isaf_m.isafdocdt)
               LET l_mon = MONTH(g_isaf_m.isafdocdt)
               IF NOT cl_null(l_isaa012) THEN
                  IF l_isaa012 > l_yer THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00227'
                     LET g_errparam.popup = TRUE
                     LET g_errparam.replace[1] = g_isaf_m.isafsite
                     LET g_errparam.replace[2] = l_isaa012,l_isaa013
                     CALL cl_err()
                     EXIT DIALOG
                  ELSE 
                     IF NOT cl_null(l_isaa013) THEN
                        LET l_day1= MDY(l_mon,1,l_yer)
                        LET l_day2= MDY(l_isaa013,1,l_isaa012)                        
                        IF l_day2 > l_day1 THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'ais-00227'
                           LET g_errparam.popup = TRUE
                           LET g_errparam.replace[1] = g_isaf_m.isafsite
                           LET g_errparam.replace[2] = l_isaa012,l_isaa013
                           CALL cl_err()
                           EXIT DIALOG
                        END IF
                     END IF
                  END IF
               END IF
               CALL aist310_02(g_isaf_m.isafdocno,g_isaf_m.isafcomp)
               CALL aist310_set_act_visible()   
               CALL aist310_set_act_no_visible()
               CALL aist310_b_fill()
               CALL aist310_show()
               #151020-00003#2---e
               
               #160907-00041#1 --s add
               #已確認單據執行換開及作廢發票,回寫發票簿下次列印號碼
               IF g_isaf_m.isafstus = 'Y' THEN 
                  IF NOT cl_null(g_isaf_m.isaf052) AND NOT cl_null(g_isaf_m.isaf051) AND
                     NOT cl_null(g_isaf_m.isaf014) AND NOT cl_null(g_isaf_m.isaf008) THEN
                     LET l_isae007 = ''
                     LET l_isae012 = ''
                     SELECT isae007,isae012    #發票字軌,下次列印號碼
                       INTO l_isae007,l_isae012
                       FROM isae_t
                      WHERE isaeent  = g_enterprise
                        AND isaesite = g_isaf_m.isaf052
                        AND isae001  = g_isaf_m.isaf051
                        AND isae002 <= g_isaf_m.isaf014
                        AND isae003 >= g_isaf_m.isaf014
                        AND isae004  = g_isaf_m.isaf008
                        
                     ###換開發票---------------------------------------------------------------
                     #取isat發票歷程檔中本次開立最大的發票
                     LET l_isae012_max = ''
                     SELECT MAX(isat004) INTO l_isae012_max
                       FROM isat_t
                      WHERE isatent = g_enterprise
                        AND isatcomp = g_isaf_m.isafcomp
                        AND isatdocno = g_isaf_m.isafdocno
                        AND isat025 IN ('11','21')   #開立狀態
                     IF NOT cl_null(l_isae012_max) THEN
                        IF g_isai002 = '1' THEN
                           IF NOT cl_null(l_isae007)THEN
                              LET l_str = cl_replace_str(l_isae012,l_isae007,'')
                              LET l_isae012 = l_str.trim()
                              LET l_str = cl_replace_str(l_isae012_max,l_isae007,'')
                              LET l_isae012_max = l_str.trim()                           
                           END IF
                        END IF
                     END IF
                     #如輸入之最大發票號碼相同或大於發票簿下次列印發票號碼,則須更新發票簿下次列印號碼
                     IF l_isae012 = l_isae012_max OR l_isae012 < l_isae012_max THEN
                        LET l_add = l_isae012_max - (l_isae012-1) #增加的張數
                        IF s_transaction_chk("N",0) THEN
                           CALL s_transaction_begin()
                        END IF
                        #计算下次列印号码
                        LET l_isae012_n = ''
                        LET l_isae012_str = l_isae012
                        LET l_len = l_isae012_str.getLength()
                        LET l_sql = "SELECT lpad('",l_isae012,"'+",l_add,",",l_len,",'0') FROM dual"
                        PREPARE isae012_pre4 FROM l_sql
                        EXECUTE isae012_pre4 INTO l_isae012_n
                        LET l_date = cl_get_current()                #170120-00040#1
                        UPDATE isae_t SET isae012 = l_isae012_n,     #發票簿下次列印號碼
                                          isae013 = isae013 + l_add, #已開張數 
                                          isae014 = g_isaf_m.isaf014 #已開發票日期 = 目前列印發票日期
                                         ,isaemodid = g_user         #170120-00040#1
                                         ,isaemoddt = l_date         #170120-00040#1
                         WHERE isaeent  = g_enterprise
                           AND isaesite = g_isaf_m.isaf052
                           AND isae001  = g_isaf_m.isaf051
                           AND isae002 <= g_isaf_m.isaf014
                           AND isae003 >= g_isaf_m.isaf014
                           AND isae004  = g_isaf_m.isaf008
                        IF SQLCA.SQLcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "update_isae012_erro"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL s_transaction_end('N','0')
                           EXIT DIALOG 
                        ELSE
                           CALL s_transaction_end('Y','0')
                        END IF
                     END IF 
                     
                     #161028-00011#1 mark ------
                     #SA們討論作廢發票不用更新發票簿號碼，因為作廢就作廢了
                     ####作廢發票---------------------------------------------------------------
                     ##如執行作廢發票,取該作廢最大號比對下次列印號碼更新至發票簿
                     #LET l_isae012_max_des = ''
                     #SELECT MAX(isat004) INTO l_isae012_max_des
                     #  FROM isat_t
                     # WHERE isatent = g_enterprise
                     #   AND isatcomp = g_isaf_m.isafcomp
                     #   AND isatdocno = g_isaf_m.isafdocno
                     #   AND isat025 IN ('12','22')   #作廢狀態
                     #IF NOT cl_null(l_isae012_max_des) THEN
                     #   IF g_isai002 = '1' THEN
                     #      IF NOT cl_null(l_isae007)THEN
                     #         LET l_str = cl_replace_str(l_isae012,l_isae007,'')
                     #         LET l_isae012 = l_str.trim()
                     #         LET l_str = cl_replace_str(l_isae012_max_des,l_isae007,'')
                     #         LET l_isae012_max_des = l_str.trim()
                     #      END IF
                     #   END IF
                     #END IF
                     #
                     ##如輸入之最大發票號碼同發票簿下次列印發票號碼,則須更新發票簿下次列印號碼
                     #IF l_isae012 = (l_isae012_max_des + 1) THEN
                     #   LET l_add = l_isae012 -l_isae012_max_des #扣除的張數
                     #   IF s_transaction_chk("N",0) THEN
                     #      CALL s_transaction_begin()
                     #   END IF
                     #   #计算下次列印号码
                     #   LET l_isae012_n = ''
                     #   LET l_isae012_str = l_isae012
                     #   LET l_len = l_isae012_str.getLength()
                     #   LET l_sql = "SELECT lpad('",l_isae012,"'-",l_add,",",l_len,",'0') FROM dual"
                     #   PREPARE isae012_pre5 FROM l_sql
                     #   EXECUTE isae012_pre5 INTO l_isae012_n
                     #   UPDATE isae_t SET isae012 = l_isae012_n,        #發票簿下次列印號碼
                     #                     isae013 = isae013 - l_add,    #已開張數 
                     #                     isae014 = g_isaf_m.isaf014    #已開發票日期 = 目前列印發票日期
                     #    WHERE isaeent  = g_enterprise
                     #      AND isaesite = g_isaf_m.isaf052
                     #      AND isae001  = g_isaf_m.isaf051
                     #      AND isae002 <= g_isaf_m.isaf014
                     #      AND isae003 >= g_isaf_m.isaf014
                     #      AND isae004  = g_isaf_m.isaf008
                     #   IF SQLCA.SQLcode THEN
                     #      INITIALIZE g_errparam TO NULL
                     #      LET g_errparam.code = SQLCA.sqlcode
                     #      LET g_errparam.extend = "update_isae012_des_erro"
                     #      LET g_errparam.popup = TRUE
                     #      CALL cl_err()
                     #      CALL s_transaction_end('N','0')
                     #      EXIT DIALOG
                     #   ELSE
                     #      CALL s_transaction_end('Y','0')
                     #   END IF
                     #END IF
                     #161028-00011#1 mark end---
                  END IF
               END IF
               CALL aist310_set_act_visible()   
               CALL aist310_set_act_no_visible()
               #160907-00041#1 --e add
               
               #151020-00003#2---mark-s
               #IF g_isaf_m.isafstus <> 'Y' AND g_isaf_m.isafstus <> 'S' THEN 
               #   INITIALIZE g_errparam TO NULL
               #   LET g_errparam.code = 'ais-00034'
               #   LET g_errparam.extend = ''
               #   LET g_errparam.popup = TRUE
               #   CALL cl_err()
               #   EXIT DIALOG
               #END IF
               #LET la_param.prog = "aisq310"
               #LET la_param.param[1] = g_isaf_m.isaf006
               #LET la_param.param[2] = g_isaf_m.isaf004
               #LET la_param.param[3] = g_isaf_m.isaf008
               #LET ls_js = util.JSON.stringify(la_param)
               #CALL cl_cmdrun(ls_js)
               #CALL aist310_show()
               #151020-00003#2---mark-e
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION compile
            LET g_action_choice="compile"
            IF cl_auth_chk_act("compile") THEN
               
               #add-point:ON ACTION compile name="menu.compile"
               IF cl_null(g_isaf_m.isafdocno) AND cl_null(g_isaf_m.isafcomp) THEN 
                  EXIT DIALOG
               END IF
                 
               #CALL aist310_s01()     #161212-00075#1 mark
               #161212-00075#1-----s
               LET l_count = NULL
               SELECT COUNT(1) INTO l_count FROM isat_t
                WHERE isatent = g_enterprise
                  AND isatcomp = g_isaf_m.isafcomp
                  AND isatdocno = g_isaf_m.isafdocno
               IF cl_null(l_count)THEN LET l_count = 0 END IF
               IF l_count = 0 THEN
                  CALL aist310_s01()
               ELSE
                  INITIALIZE g_errparam.* TO NULL
                  LET g_errparam.code = 'ais-00349'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
               END IF
               #161212-00075#1-----e
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_aist310_invpnt
            LET g_action_choice="open_aist310_invpnt"
            IF cl_auth_chk_act("open_aist310_invpnt") THEN
               
               #add-point:ON ACTION open_aist310_invpnt name="menu.open_aist310_invpnt"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_aist310_01
            LET g_action_choice="open_aist310_01"
            IF cl_auth_chk_act("open_aist310_01") THEN
               
               #add-point:ON ACTION open_aist310_01 name="menu.open_aist310_01"
              #IF g_isaf_m.isafstus != 'Y' THEN   #160413-00020#1 mark
               IF g_isaf_m.isafstus = 'N' THEN    #160413-00020#1
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00034'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  EXIT DIALOG
               END IF
               
               #150603-00046#1 mark ------
               #LET la_param.prog = "aisp310"
               #LET la_param.param[1] = g_isaf_m.isaf001
               #LET la_param.param[2] = g_isaf_m.isaf005
               #LET la_param.param[3] = g_isaf_m.isaf006
               #LET la_param.param[4] = g_isaf_m.isafdocno
               #LET la_param.param[5] = g_isaf_m.isaf014
               #LET la_param.param[6] = g_isaf_m.isaf003
               #LET la_param.param[7] = g_isaf_m.isaf018
               #LET la_param.param[8] = g_isaf_m.isaf010
               #LET la_param.param[9] = g_isaf_m.isaf011
               #150603-00046#1 mark end---
               #150603-00046#1 add ------
               IF NOT cl_null(g_isaf_m.isaf035) OR NOT cl_null(g_isaf_m.isaf048) OR NOT cl_null(g_isaf_m.isaf049) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00215'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  EXIT DIALOG
               END IF
               #151209-00023#1--add--str--lujh
               LET l_ooba002 = ''
               LET l_ooba002 = cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-1003')
               IF l_ooba002 = '3' AND g_isaf_m.isafstus <> 'S' THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00299'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  EXIT DIALOG
               END IF
               #151209-00023#1--add--str--lujh
               
               LET la_param.prog = "axrp132"
               LET la_param.param[1] = g_isaf_m.isafsite
               LET la_param.param[2] = g_isaf_m.isafdocno
               LET la_param.param[3] = g_isaf_m.isaf001    #160922-00055#2 add
               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun(ls_js)
               #150603-00046#1 add end---
               CALL aist310_show()
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_isaf005
            LET g_action_choice="prog_isaf005"
            IF cl_auth_chk_act("prog_isaf005") THEN
               
               #add-point:ON ACTION prog_isaf005 name="menu.prog_isaf005"
               #應用 a45 樣板自動產生(Version:2)
               CALL cl_user_contact("aooi130", "ooag_t", "ooag002", "ooag001",g_isaf_m.isaf005)
 


               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_isaf057
            LET g_action_choice="prog_isaf057"
            IF cl_auth_chk_act("prog_isaf057") THEN
               
               #add-point:ON ACTION prog_isaf057 name="menu.prog_isaf057"
               #應用 a45 樣板自動產生(Version:2)
               CALL cl_user_contact("aooi130", "ooag_t", "ooag002", "ooag001",g_isaf_m.isaf057)
 


               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_isaf035
            LET g_action_choice="prog_isaf035"
            IF cl_auth_chk_act("prog_isaf035") THEN
               
               #add-point:ON ACTION prog_isaf035 name="menu.prog_isaf035"
               #應用 a41 樣板自動產生(Version:3)
               #160530-00005#1 --s add
               #使用JSON格式組合參數與作業編號(串查)
               IF cl_null(g_glaald) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code   = 'sub-00280'
                  LET g_errparam.extend = g_glaald
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CONTINUE DIALOG
               END IF
               IF cl_null(g_isaf_m.isaf035) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code   = 'sub-00280'
                  LET g_errparam.extend = s_fin_get_colname(g_prog,'isaf035')
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CONTINUE DIALOG
               END IF   
               
               INITIALIZE la_param.* TO NULL
               #160907-00046#1--add(e)
               LET l_sfin2022 = cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-2022')
               CASE              
                  WHEN g_isaf_m.isaf001 = '1'
                     LET la_param.prog = "axrt300"
                     LET la_param.param[1] = g_glaald
                     LET la_param.param[2] = g_isaf_m.isaf035
                  WHEN g_isaf_m.isaf001 = '2'
                     LET la_param.prog = "axrt330"
                     LET la_param.param[1] = g_glaald
                     LET la_param.param[2] = g_isaf_m.isaf035 
                  WHEN g_isaf_m.isaf001 = '3'
                     IF l_sfin2022 = '01' THEN
                        LET la_param.prog = "axrt300"
                     LET la_param.param[1] = g_glaald
                     LET la_param.param[2] = g_isaf_m.isaf035
                     ELSE
                        LET la_param.prog = "axrt310" 
                     LET la_param.param[1] = g_glaald
                     LET la_param.param[2] = g_isaf_m.isaf035
                     END IF
                  WHEN g_isaf_m.isaf001 = '4'   
                     LET la_param.prog = "axrt340" 
                     LET la_param.param[1] = g_glaald
                     LET la_param.param[2] = g_isaf_m.isaf035
                  #160920-00013#1--s
                  WHEN g_isaf_m.isaf001 = '5'   
                     LET la_param.prog = "axrt341" 
                     LET la_param.param[1] = g_glaald
                     LET la_param.param[2] = g_isaf_m.isaf035
                  #160920-00013#1--e
               END CASE
               #160907-00046#1--add(e)
               #160907-00046#1--mark(s)
               #LET la_param.prog  = 'axrt300'
               #LET la_param.param[1] = g_glaald
               #LET la_param.param[2] = g_isaf_m.isaf035              
               ##160907-00046#1--mark(e)
               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun_wait(ls_js)
               #160530-00005#1 --e add
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_isaf041
            LET g_action_choice="prog_isaf041"
            IF cl_auth_chk_act("prog_isaf041") THEN
               
               #add-point:ON ACTION prog_isaf041 name="menu.prog_isaf041"
               #應用 a45 樣板自動產生(Version:2)
               CALL cl_user_contact("aooi130", "ooag_t", "ooag002", "ooag001",g_isaf_m.isaf041)
 


               #END add-point
               
            END IF
 
 
 
 
         
         #應用 a46 樣板自動產生(Version:3)
         #新增相關文件
         ON ACTION related_document
            CALL aist310_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document name="ui_dialog.dialog.related_document"
               
               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL aist310_set_pk_array()
            #add-point:ON ACTION agendum name="ui_dialog.dialog.agendum"
            
            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL aist310_set_pk_array()
            #add-point:ON ACTION followup name="ui_dialog.dialog.followup"
            
            #END add-point
            CALL cl_user_overview_follow(g_isaf_m.isafdocdt)
 
 
 
         
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
    
         #交談指令共用ACTION
         &include "common_action.4gl" 
            CONTINUE DIALOG
      END DIALOG
 
      #(ver:79) ---add start---
      #add-point:ui_dialog段 after dialog name="ui_dialog.exit_dialog"
      
      #end add-point
      #(ver:79) --- add end ---
    
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         #add-point:ui_dialog段離開dialog前 name="ui_dialog.b_exit"
         
         #end add-point
         EXIT WHILE
      END IF
    
   END WHILE    
      
   CALL cl_set_act_visible("accept,cancel", TRUE)
    
END FUNCTION
 
{</section>}
 
{<section id="aist310.browser_fill" >}
#+ 瀏覽頁簽資料填充
PRIVATE FUNCTION aist310_browser_fill(ps_page_action)
   #add-point:browser_fill段define(客製用) name="browser_fill.define_customerization"
   
   #end add-point  
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   #add-point:browser_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="browser_fill.define"
 
   #end add-point    
   
   #add-point:Function前置處理 name="browser_fill.before_browser_fill"
   
   #end add-point
   
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   LET l_wc  = g_wc.trim() 
   LET l_wc2 = g_wc2.trim()
 
   #add-point:browser_fill,foreach前 name="browser_fill.before_foreach"
   
   #end add-point
   
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件                      
      LET l_sub_sql = " SELECT DISTINCT isafcomp,isafdocno ",
                      " FROM isaf_t ",
                      " ",
                      " LEFT JOIN isag_t ON isagent = isafent AND isafcomp = isagcomp AND isafdocno = isagdocno ", "  ",
                      #add-point:browser_fill段sql(isag_t1) name="browser_fill.cnt.join.}"
                      
                      #end add-point
                      " LEFT JOIN isah_t ON isahent = isafent AND isafcomp = isahcomp AND isafdocno = isahdocno", "  ",
                      #add-point:browser_fill段sql(isah_t1) name="browser_fill.cnt.join.isah_t1"
                      
                      #end add-point
 
                      " LEFT JOIN xrcd_t ON xrcdent = isafent AND isafcomp = xrcdcomp AND isafdocno = xrcddocno", "  ",
                      #add-point:browser_fill段sql(xrcd_t1) name="browser_fill.cnt.join.xrcd_t1"
                      
                      #end add-point
 
                      " LEFT JOIN isat_t ON isatent = isafent AND isafcomp = isatcomp AND isafdocno = isatdocno", "  ",
                      #add-point:browser_fill段sql(isat_t1) name="browser_fill.cnt.join.isat_t1"
                      
                      #end add-point
 
 
 
                      " ", 
                      " ", 
                      " ",                      
 
                      " ",                      
 
                      " ",                      
 
 
 
                      " WHERE isafent = " ||g_enterprise|| " AND isagent = " ||g_enterprise|| " AND ",l_wc, " AND ", l_wc2, cl_sql_add_filter("isaf_t")
   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT DISTINCT isafcomp,isafdocno ",
                      " FROM isaf_t ", 
                      "  ",
                      "  ",
                      " WHERE isafent = " ||g_enterprise|| " AND ",l_wc CLIPPED, cl_sql_add_filter("isaf_t")
   END IF
   
   #add-point:browser_fill,cnt wc name="browser_fill.cnt_sqlwc"
   
   #end add-point
   
   LET g_sql = " SELECT COUNT(1) FROM (",l_sub_sql,")"
   
   #add-point:browser_fill,count前 name="browser_fill.before_count"
   
   #end add-point
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE header_cnt_pre FROM g_sql
      EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
      FREE header_cnt_pre
   END IF
    
   IF g_browser_cnt > g_max_browse THEN
      IF g_error_show = 1 THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_browser_cnt
         LET g_errparam.code = 9035 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
      END IF
      LET g_browser_cnt = g_max_browse
   END IF
   
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
 
   #根據行為確定資料填充位置及WC
   IF cl_null(g_add_browse) THEN
      #清除畫面
      CLEAR FORM                
      INITIALIZE g_isaf_m.* TO NULL
      CALL g_isag_d.clear()        
      CALL g_isag2_d.clear() 
      CALL g_isag3_d.clear() 
      CALL g_isag4_d.clear() 
 
      #add-point:browser_fill g_add_browse段額外處理 name="browser_fill.add_browse.other"
      
      #end add-point   
      CALL g_browser.clear()
      LET g_cnt = 1
   ELSE
      LET l_wc  = g_add_browse
      LET l_wc2 = " 1=1" 
      LET g_cnt = g_current_idx
   END IF
 
   #依照t0.isafcomp,t0.isafdocno Browser欄位定義(取代原本bs_sql功能)
   #考量到單身可能下條件, 所以此處需join單身所有table
   #DISTINCT是為了避免在join時出現重複的資料(如果不加DISTINCT則須在程式中過濾)
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.isafstus,t0.isafcomp,t0.isafdocno ",
                  " FROM isaf_t t0",
                  "  ",
                  "  LEFT JOIN isag_t ON isagent = isafent AND isafcomp = isagcomp AND isafdocno = isagdocno ", "  ", 
                  #add-point:browser_fill段sql(isag_t1) name="browser_fill.join.isag_t1"
                  
                  #end add-point
                  "  LEFT JOIN isah_t ON isahent = isafent AND isafcomp = isahcomp AND isafdocno = isahdocno", "  ", 
                  #add-point:browser_fill段sql(isah_t1) name="browser_fill.join.isah_t1"
                  
                  #end add-point
 
                  "  LEFT JOIN xrcd_t ON xrcdent = isafent AND isafcomp = xrcdcomp AND isafdocno = xrcddocno", "  ", 
                  #add-point:browser_fill段sql(xrcd_t1) name="browser_fill.join.xrcd_t1"
                  
                  #end add-point
 
                  "  LEFT JOIN isat_t ON isatent = isafent AND isafcomp = isatcomp AND isafdocno = isatdocno", "  ", 
                  #add-point:browser_fill段sql(isat_t1) name="browser_fill.join.isat_t1"
                  
                  #end add-point
 
 
 
                  " ", 
                  " ",                      
 
                  " ",                      
 
                  " ",                      
 
 
 
                  
                  " WHERE t0.isafent = " ||g_enterprise|| " AND ",l_wc," AND ",l_wc2, cl_sql_add_filter("isaf_t")
   ELSE
      #單身無輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.isafstus,t0.isafcomp,t0.isafdocno ",
                  " FROM isaf_t t0",
                  "  ",
                  
                  " WHERE t0.isafent = " ||g_enterprise|| " AND ",l_wc, cl_sql_add_filter("isaf_t")
   END IF
   #add-point:browser_fill,sql wc name="browser_fill.fill_sqlwc"
   
   #end add-point
   LET g_sql = g_sql, " ORDER BY isafcomp,isafdocno ",g_order
 
   #add-point:browser_fill,before_prepare name="browser_fill.before_prepare"
   
   #end add-point
        
   #LET g_sql = cl_sql_add_tabid(g_sql,"isaf_t") #WC重組
   LET g_sql = cl_sql_add_mask(g_sql) #遮蔽特定資料
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE browse_pre FROM g_sql
      DECLARE browse_cur CURSOR FOR browse_pre
      
      #add-point:browser_fill段open cursor name="browser_fill.open"
      
      #end add-point
      
      FOREACH browse_cur INTO g_browser[g_cnt].b_statepic,g_browser[g_cnt].b_isafcomp,g_browser[g_cnt].b_isafdocno 
 
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "Foreach:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
      
         #add-point:browser_fill段reference name="browser_fill.reference"
         
         #end add-point
      
      
               #應用 a24 樣板自動產生(Version:3)
      #browser顯示圖片
      CASE g_browser[g_cnt].b_statepic
         WHEN "N"
            LET g_browser[g_cnt].b_statepic = "stus/16/unconfirmed.png"
         WHEN "Y"
            LET g_browser[g_cnt].b_statepic = "stus/16/confirmed.png"
         WHEN "S"
            LET g_browser[g_cnt].b_statepic = "stus/16/posted.png"
         WHEN "A"
            LET g_browser[g_cnt].b_statepic = "stus/16/approved.png"
         WHEN "D"
            LET g_browser[g_cnt].b_statepic = "stus/16/withdraw.png"
         WHEN "R"
            LET g_browser[g_cnt].b_statepic = "stus/16/rejection.png"
         WHEN "W"
            LET g_browser[g_cnt].b_statepic = "stus/16/signing.png"
         WHEN "X"
            LET g_browser[g_cnt].b_statepic = "stus/16/invalid.png"
         
      END CASE
 
 
 
         LET g_cnt = g_cnt + 1
         IF g_cnt > g_max_browse THEN
            EXIT FOREACH
         END IF
         
      END FOREACH
      FREE browse_pre
   END IF
   
   #清空g_add_browse, 並指定指標位置
   IF NOT cl_null(g_add_browse) THEN
      LET g_add_browse = ""
      CALL g_curr_diag.setCurrentRow("s_browse",g_current_idx)
   END IF
   
   IF cl_null(g_browser[g_cnt].b_isafcomp) THEN
      CALL g_browser.deleteElement(g_cnt)
   END IF
   
   LET g_header_cnt  = g_browser.getLength()
   LET g_browser_cnt = g_browser.getLength()
   
   #筆數顯示
   IF g_browser_cnt > 0 THEN
      DISPLAY g_browser_idx TO FORMONLY.b_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.b_count #總筆數
      DISPLAY g_browser_idx TO FORMONLY.h_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.h_count #總筆數
      DISPLAY g_detail_idx  TO FORMONLY.idx     #單身當下筆數
      DISPLAY g_detail_cnt  TO FORMONLY.cnt     #單身總筆數
   ELSE
      DISPLAY '' TO FORMONLY.b_index #當下筆數
      DISPLAY '' TO FORMONLY.b_count #總筆數
      DISPLAY '' TO FORMONLY.h_index #當下筆數
      DISPLAY '' TO FORMONLY.h_count #總筆數
      DISPLAY '' TO FORMONLY.idx     #單身當下筆數
      DISPLAY '' TO FORMONLY.cnt     #單身總筆數
   END IF
 
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0
 
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
                  
   
   #add-point:browser_fill段結束前 name="browser_fill.after"
   
   #end add-point   
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.ui_headershow" >}
#+ 單頭資料重新顯示
PRIVATE FUNCTION aist310_ui_headershow()
   #add-point:ui_headershow段define(客製用) name="ui_headershow.define_customerization"
   
   #end add-point  
   #add-point:ui_headershow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_headershow.define"
   
   #end add-point      
   
   #add-point:Function前置處理  name="ui_headershow.pre_function"
   
   #end add-point
   
   LET g_isaf_m.isafcomp = g_browser[g_current_idx].b_isafcomp   
   LET g_isaf_m.isafdocno = g_browser[g_current_idx].b_isafdocno   
 
   EXECUTE aist310_master_referesh USING g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isaf_m.isafsite, 
       g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt,g_isaf_m.isaf056,g_isaf_m.isaf005, 
       g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf016, 
       g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009, 
       g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101, 
       g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024, 
       g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029, 
       g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104, 
       g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114, 
       g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120, 
       g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049, 
       g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf205, 
       g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039,g_isaf_m.isaf040,g_isaf_m.isaf041, 
       g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf050,g_isaf_m.isaf004, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059,g_isaf_m.isaf060,g_isaf_m.isaf061, 
       g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208,g_isaf_m.isaf209, 
       g_isaf_m.isaf210,g_isaf_m.isafownid,g_isaf_m.isafowndp,g_isaf_m.isafcrtid,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmoddt,g_isaf_m.isafcnfid,g_isaf_m.isafcnfdt, 
       g_isaf_m.isafsite_desc,g_isaf_m.isafcomp_desc,g_isaf_m.isaf005_desc,g_isaf_m.isaf057_desc,g_isaf_m.isaf003_desc, 
       g_isaf_m.isaf052_desc,g_isaf_m.isaf002_desc,g_isaf_m.isaf201_desc,g_isaf_m.isaf202_desc,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf037_desc,g_isaf_m.isaf041_desc,g_isaf_m.isaf055_desc,g_isaf_m.isaf006_desc,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf210_desc,g_isaf_m.isafownid_desc,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid_desc, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafmodid_desc,g_isaf_m.isafcnfid_desc
   
   CALL aist310_isaf_t_mask()
   CALL aist310_show()
      
END FUNCTION
 
{</section>}
 
{<section id="aist310.ui_detailshow" >}
#+ 單身資料重新顯示
PRIVATE FUNCTION aist310_ui_detailshow()
   #add-point:ui_detailshow段define(客製用) name="ui_detailshow.define_customerization"
   
   #end add-point    
   #add-point:ui_detailshow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_detailshow.define"
   
   #end add-point    
 
   #add-point:Function前置處理 name="ui_detailshow.before"
   
   #end add-point    
   
   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)      
      CALL g_curr_diag.setCurrentRow("s_detail2",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail3",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail4",g_detail_idx)
 
   END IF
   
   #add-point:ui_detailshow段after name="ui_detailshow.after"
   
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.ui_browser_refresh" >}
#+ 瀏覽頁簽資料重新顯示
PRIVATE FUNCTION aist310_ui_browser_refresh()
   #add-point:ui_browser_refresh段define(客製用) name="ui_browser_refresh.define_customerization"
   
   #end add-point    
   DEFINE l_i  LIKE type_t.num10
   #add-point:ui_browser_refresh段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_browser_refresh.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="ui_browser_refresh.pre_function"
   
   #end add-point
   
   LET g_browser_cnt = g_browser.getLength()
   LET g_header_cnt  = g_browser.getLength()
   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_isafcomp = g_isaf_m.isafcomp 
         AND g_browser[l_i].b_isafdocno = g_isaf_m.isafdocno 
 
         THEN
         CALL g_browser.deleteElement(l_i)
         EXIT FOR
      END IF
   END FOR
   LET g_browser_cnt = g_browser_cnt - 1
   LET g_header_cnt = g_header_cnt - 1
    
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
      CLEAR FORM
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
   
   #add-point:ui_browser_refresh段after name="ui_browser_refresh.after"
   
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.construct" >}
#+ QBE資料查詢
PRIVATE FUNCTION aist310_construct()
   #add-point:cs段define(客製用) name="cs.define_customerization"
   
   #end add-point    
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING 
   DEFINE ls_wc       STRING 
   DEFINE la_wc       DYNAMIC ARRAY OF RECORD
          tableid     STRING,
          wc          STRING
          END RECORD
   DEFINE li_idx      LIKE type_t.num10
   #add-point:cs段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="cs.define"
   DEFINE l_comp      LIKE ooef_t.ooef001
   DEFINE l_isag001_c LIKE isag_t.isag001   #150518-00046#4
   #end add-point    
   
   #add-point:Function前置處理  name="cs.pre_function"
   
   #end add-point
    
   #清除畫面
   CLEAR FORM                
   INITIALIZE g_isaf_m.* TO NULL
   CALL g_isag_d.clear()        
   CALL g_isag2_d.clear() 
   CALL g_isag3_d.clear() 
   CALL g_isag4_d.clear() 
 
   
   LET g_action_choice = ""
    
   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   
   INITIALIZE g_wc2_table1 TO NULL
   INITIALIZE g_wc2_table2 TO NULL
 
   INITIALIZE g_wc2_table3 TO NULL
 
   INITIALIZE g_wc2_table4 TO NULL
 
 
    
   LET g_qryparam.state = 'c'
   
   #add-point:cs段開始前 name="cs.before_construct"
   CALL cl_set_comp_visible('bpage_1',TRUE)
   CALL cl_set_combo_scc('isag001','8341')
   #CALL cl_set_comp_visible('isaf010,isag013.isah001,isah008,isat003',TRUE)  #161020-00002#1 #161214-00053#1 mark
   CALL cl_set_comp_visible('isaf010,isag013,isag014,isah001,isah008,isat003',TRUE) #161214-00053#1 add
   CALL cl_set_comp_visible('isaf051',TRUE) #170103-00009#1
   #end add-point 
   
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
      #單頭
      CONSTRUCT BY NAME g_wc ON isafsite,isafdocno,isafdocno_desc,isaf001,isafcomp,isafdocdt,isaf056, 
          isaf005,isaf057,isaf003,isaf067,isafstus,isaf008,isaf008_desc,isaf016,isaf014,isaf053,isaf016_desc, 
          isaf052,isaf018,isaf051,isaf009,isaf017,isaf010,isaf012,isaf100,isaf011,isaf101,isaf054,isaf002, 
          isaf021,isaf022,isaf023,isaf024,isaf025,isaf026,isaf045,isaf027,isaf028,isaf029,isaf030,isaf031, 
          isaf032,isaf046,isaf103,isaf104,isaf105,isaf106,isaf107,isaf108,isaf113,isaf114,isaf115,isaf116, 
          isaf117,isaf118,isaf119,isaf120,isaf121,isaf033,isaf034,isaf035,isaf048,isaf049,isaf201,isaf202, 
          isaf203,isaf204,isaf207,isaf205,isaf206,isaf037,isaf038,isaf039,isaf040,isaf041,isaf042,isaf055, 
          isaf007,isaf006,isaf050,isaf004,isaf044,isaf066,isaf019,isaf019_desc,isaf059,isaf060,isaf061, 
          isaf063,isaf062,isaf064,isaf065,isaf208,isaf209,isaf210,isafownid,isafowndp,isafcrtid,isafcrtdp, 
          isafcrtdt,isafmodid,isafmoddt,isafcnfid,isafcnfdt
 
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.head.before_construct"
 
            #end add-point 
            
         #公用欄位開窗相關處理
         #應用 a11 樣板自動產生(Version:3)
         #共用欄位查詢處理  
         ##----<<isafcrtdt>>----
         AFTER FIELD isafcrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
 
         #----<<isafmoddt>>----
         AFTER FIELD isafmoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<isafcnfdt>>----
         AFTER FIELD isafcnfdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<isafpstdt>>----
 
 
 
            
         #一般欄位開窗相關處理    
                  #Ctrlp:construct.c.isafsite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafsite
            #add-point:ON ACTION controlp INFIELD isafsite name="construct.c.isafsite"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #CALL q_ooef001()     #161006-00005#29   mark
            CALL q_ooef001_46()   #161006-00005#29   add 
            DISPLAY g_qryparam.return1 TO isafsite  #顯示到畫面上
            NEXT FIELD isafsite                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafsite
            #add-point:BEFORE FIELD isafsite name="construct.b.isafsite"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafsite
            
            #add-point:AFTER FIELD isafsite name="construct.a.isafsite"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isafdocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafdocno
            #add-point:ON ACTION controlp INFIELD isafdocno name="construct.c.isafdocno"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #161216-00009#1 add ------
            LET g_qryparam.where = " isafcomp IN ",g_wc_cs_comp
            IF NOT cl_null(g_ctl_where) AND NOT g_ctl_where = ' 1=1'  THEN
               LET g_qryparam.where = g_qryparam.where," AND EXISTS (SELECT 1 FROM pmaa_t ",
                                                       "              WHERE pmaaent = ",g_enterprise,
                                                       "                AND ",g_ctl_where,
                                                       "                AND pmaaent = isafent ",
                                                       "                AND pmaa001 = isaf003 )"
            END IF
            #161216-00009#1 add end---
            #161104-00046#3-----s
            #單別權限控管
            IF NOT cl_null(g_user_dept_wc_q) AND NOT g_user_dept_wc_q = ' 1=1'  THEN
               LET g_qryparam.where = g_qryparam.where," AND ",g_user_dept_wc_q CLIPPED 
            END IF
            #161104-00046#3-----e
            CALL q_isafdocno()
            DISPLAY g_qryparam.return1 TO isafdocno
            NEXT FIELD isafdocno
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafdocno
            #add-point:BEFORE FIELD isafdocno name="construct.b.isafdocno"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafdocno
            
            #add-point:AFTER FIELD isafdocno name="construct.a.isafdocno"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafdocno_desc
            #add-point:BEFORE FIELD isafdocno_desc name="construct.b.isafdocno_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafdocno_desc
            
            #add-point:AFTER FIELD isafdocno_desc name="construct.a.isafdocno_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isafdocno_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafdocno_desc
            #add-point:ON ACTION controlp INFIELD isafdocno_desc name="construct.c.isafdocno_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf001
            #add-point:BEFORE FIELD isaf001 name="construct.b.isaf001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf001
            
            #add-point:AFTER FIELD isaf001 name="construct.a.isaf001"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf001
            #add-point:ON ACTION controlp INFIELD isaf001 name="construct.c.isaf001"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isafcomp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafcomp
            #add-point:ON ACTION controlp INFIELD isafcomp name="construct.c.isafcomp"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " ooef003 = 'Y'"   #161006-00005#29   add
            #160907-00041#1 --s add
            IF NOT cl_null(g_wc_cs_comp)THEN
               LET g_qryparam.where = g_qryparam.where ,   #161006-00005#29   add
                                     " AND ooef001 IN ",g_wc_cs_comp          
            END IF
            #160907-00041#1 --e add
            #CALL q_ooef001_2()   #161006-00005#29   mark
            CALL q_ooef001()      #161006-00005#29   add            
            DISPLAY g_qryparam.return1 TO isafcomp  #顯示到畫面上
            NEXT FIELD isafcomp                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafcomp
            #add-point:BEFORE FIELD isafcomp name="construct.b.isafcomp"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafcomp
            
            #add-point:AFTER FIELD isafcomp name="construct.a.isafcomp"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafdocdt
            #add-point:BEFORE FIELD isafdocdt name="construct.b.isafdocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafdocdt
            
            #add-point:AFTER FIELD isafdocdt name="construct.a.isafdocdt"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isafdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafdocdt
            #add-point:ON ACTION controlp INFIELD isafdocdt name="construct.c.isafdocdt"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf056
            #add-point:BEFORE FIELD isaf056 name="construct.b.isaf056"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf056
            
            #add-point:AFTER FIELD isaf056 name="construct.a.isaf056"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf056
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf056
            #add-point:ON ACTION controlp INFIELD isaf056 name="construct.c.isaf056"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf005
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf005
            #add-point:ON ACTION controlp INFIELD isaf005 name="construct.c.isaf005"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf005  #顯示到畫面上

            NEXT FIELD isaf005                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf005
            #add-point:BEFORE FIELD isaf005 name="construct.b.isaf005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf005
            
            #add-point:AFTER FIELD isaf005 name="construct.a.isaf005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf057
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf057
            #add-point:ON ACTION controlp INFIELD isaf057 name="construct.c.isaf057"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf057  #顯示到畫面上
            NEXT FIELD isaf057                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf057
            #add-point:BEFORE FIELD isaf057 name="construct.b.isaf057"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf057
            
            #add-point:AFTER FIELD isaf057 name="construct.a.isaf057"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf003
            #add-point:ON ACTION controlp INFIELD isaf003 name="construct.c.isaf003"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #151231-00010#3-----s
            #LET g_qryparam.where = g_ctl_where #161222-00029#1 mark
            #151231-00010#3-----e
            #161222-00029#1 add ------
            IF NOT cl_null(g_ctl_where) AND NOT g_ctl_where = ' 1=1'  THEN
               LET g_qryparam.where = g_ctl_where
            END IF
            #161222-00029#1 add end---
            #CALL q_pmaa001()     #160920-00019#5--mark
            CALL q_pmaa001_13()   #160920-00019#5--add
            DISPLAY g_qryparam.return1 TO isaf003
            NEXT FIELD isaf003
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf003
            #add-point:BEFORE FIELD isaf003 name="construct.b.isaf003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf003
            
            #add-point:AFTER FIELD isaf003 name="construct.a.isaf003"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf067
            #add-point:BEFORE FIELD isaf067 name="construct.b.isaf067"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf067
            
            #add-point:AFTER FIELD isaf067 name="construct.a.isaf067"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf067
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf067
            #add-point:ON ACTION controlp INFIELD isaf067 name="construct.c.isaf067"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafstus
            #add-point:BEFORE FIELD isafstus name="construct.b.isafstus"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafstus
            
            #add-point:AFTER FIELD isafstus name="construct.a.isafstus"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isafstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafstus
            #add-point:ON ACTION controlp INFIELD isafstus name="construct.c.isafstus"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf008
            #add-point:ON ACTION controlp INFIELD isaf008 name="construct.c.isaf008"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE                      
            CALL q_isac002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf008  #顯示到畫面上

            NEXT FIELD isaf008                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf008
            #add-point:BEFORE FIELD isaf008 name="construct.b.isaf008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf008
            
            #add-point:AFTER FIELD isaf008 name="construct.a.isaf008"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf008_desc
            #add-point:BEFORE FIELD isaf008_desc name="construct.b.isaf008_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf008_desc
            
            #add-point:AFTER FIELD isaf008_desc name="construct.a.isaf008_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf008_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf008_desc
            #add-point:ON ACTION controlp INFIELD isaf008_desc name="construct.c.isaf008_desc"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf016
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf016
            #add-point:ON ACTION controlp INFIELD isaf016 name="construct.c.isaf016"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_oodb002_5()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf016  #顯示到畫面上

            NEXT FIELD isaf016                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf016
            #add-point:BEFORE FIELD isaf016 name="construct.b.isaf016"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf016
            
            #add-point:AFTER FIELD isaf016 name="construct.a.isaf016"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf014
            #add-point:BEFORE FIELD isaf014 name="construct.b.isaf014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf014
            
            #add-point:AFTER FIELD isaf014 name="construct.a.isaf014"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf014
            #add-point:ON ACTION controlp INFIELD isaf014 name="construct.c.isaf014"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf053
            #add-point:BEFORE FIELD isaf053 name="construct.b.isaf053"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf053
            
            #add-point:AFTER FIELD isaf053 name="construct.a.isaf053"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf053
            #add-point:ON ACTION controlp INFIELD isaf053 name="construct.c.isaf053"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf016_desc
            #add-point:BEFORE FIELD isaf016_desc name="construct.b.isaf016_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf016_desc
            
            #add-point:AFTER FIELD isaf016_desc name="construct.a.isaf016_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf016_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf016_desc
            #add-point:ON ACTION controlp INFIELD isaf016_desc name="construct.c.isaf016_desc"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf052
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf052
            #add-point:ON ACTION controlp INFIELD isaf052 name="construct.c.isaf052"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #161006-00005#29   add---s
            LET g_qryparam.where = " ooef201 = 'Y'"   
            IF NOT cl_null(g_wc_isagorga)THEN
               LET g_qryparam.where = g_qryparam.where , 
                                     " AND ooef001 IN ",g_wc_isagorga          
            END IF
            #161006-00005#29  add---e
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf052  #顯示到畫面上
            NEXT FIELD isaf052                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf052
            #add-point:BEFORE FIELD isaf052 name="construct.b.isaf052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf052
            
            #add-point:AFTER FIELD isaf052 name="construct.a.isaf052"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf018
            #add-point:BEFORE FIELD isaf018 name="construct.b.isaf018"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf018
            
            #add-point:AFTER FIELD isaf018 name="construct.a.isaf018"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf018
            #add-point:ON ACTION controlp INFIELD isaf018 name="construct.c.isaf018"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf051
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf051
            #add-point:ON ACTION controlp INFIELD isaf051 name="construct.c.isaf051"
            #發票簿號
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_isaesite_3()
            DISPLAY g_qryparam.return1 TO isaf051
            NEXT FIELD isaf051
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf051
            #add-point:BEFORE FIELD isaf051 name="construct.b.isaf051"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf051
            
            #add-point:AFTER FIELD isaf051 name="construct.a.isaf051"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf009
            #add-point:BEFORE FIELD isaf009 name="construct.b.isaf009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf009
            
            #add-point:AFTER FIELD isaf009 name="construct.a.isaf009"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf009
            #add-point:ON ACTION controlp INFIELD isaf009 name="construct.c.isaf009"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf017
            #add-point:BEFORE FIELD isaf017 name="construct.b.isaf017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf017
            
            #add-point:AFTER FIELD isaf017 name="construct.a.isaf017"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf017
            #add-point:ON ACTION controlp INFIELD isaf017 name="construct.c.isaf017"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf010
            #add-point:BEFORE FIELD isaf010 name="construct.b.isaf010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf010
            
            #add-point:AFTER FIELD isaf010 name="construct.a.isaf010"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf010
            #add-point:ON ACTION controlp INFIELD isaf010 name="construct.c.isaf010"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf012
            #add-point:BEFORE FIELD isaf012 name="construct.b.isaf012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf012
            
            #add-point:AFTER FIELD isaf012 name="construct.a.isaf012"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf012
            #add-point:ON ACTION controlp INFIELD isaf012 name="construct.c.isaf012"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf100
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf100
            #add-point:ON ACTION controlp INFIELD isaf100 name="construct.c.isaf100"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_aooi001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf100  #顯示到畫面上

            NEXT FIELD isaf100                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf100
            #add-point:BEFORE FIELD isaf100 name="construct.b.isaf100"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf100
            
            #add-point:AFTER FIELD isaf100 name="construct.a.isaf100"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf011
            #add-point:BEFORE FIELD isaf011 name="construct.b.isaf011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf011
            
            #add-point:AFTER FIELD isaf011 name="construct.a.isaf011"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf011
            #add-point:ON ACTION controlp INFIELD isaf011 name="construct.c.isaf011"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf101
            #add-point:BEFORE FIELD isaf101 name="construct.b.isaf101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf101
            
            #add-point:AFTER FIELD isaf101 name="construct.a.isaf101"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf101
            #add-point:ON ACTION controlp INFIELD isaf101 name="construct.c.isaf101"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf054
            #add-point:BEFORE FIELD isaf054 name="construct.b.isaf054"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf054
            
            #add-point:AFTER FIELD isaf054 name="construct.a.isaf054"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf054
            #add-point:ON ACTION controlp INFIELD isaf054 name="construct.c.isaf054"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf002
            #add-point:ON ACTION controlp INFIELD isaf002 name="construct.c.isaf002"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            #151231-00010#3-----s
            LET g_qryparam.where = g_ctl_where 
            #151231-00010#3-----e
            #CALL q_pmaa001()     #160920-00019#5--mark   
            CALL q_pmaa001_13()   #160920-00019#5--add
            DISPLAY g_qryparam.return1 TO isaf002  #顯示到畫面上
            NEXT FIELD isaf002                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf002
            #add-point:BEFORE FIELD isaf002 name="construct.b.isaf002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf002
            
            #add-point:AFTER FIELD isaf002 name="construct.a.isaf002"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf021
            #add-point:BEFORE FIELD isaf021 name="construct.b.isaf021"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf021
            
            #add-point:AFTER FIELD isaf021 name="construct.a.isaf021"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf021
            #add-point:ON ACTION controlp INFIELD isaf021 name="construct.c.isaf021"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf022
            #add-point:BEFORE FIELD isaf022 name="construct.b.isaf022"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf022
            
            #add-point:AFTER FIELD isaf022 name="construct.a.isaf022"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf022
            #add-point:ON ACTION controlp INFIELD isaf022 name="construct.c.isaf022"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf023
            #add-point:BEFORE FIELD isaf023 name="construct.b.isaf023"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf023
            
            #add-point:AFTER FIELD isaf023 name="construct.a.isaf023"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf023
            #add-point:ON ACTION controlp INFIELD isaf023 name="construct.c.isaf023"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf024
            #add-point:BEFORE FIELD isaf024 name="construct.b.isaf024"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf024
            
            #add-point:AFTER FIELD isaf024 name="construct.a.isaf024"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf024
            #add-point:ON ACTION controlp INFIELD isaf024 name="construct.c.isaf024"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf025
            #add-point:BEFORE FIELD isaf025 name="construct.b.isaf025"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf025
            
            #add-point:AFTER FIELD isaf025 name="construct.a.isaf025"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf025
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf025
            #add-point:ON ACTION controlp INFIELD isaf025 name="construct.c.isaf025"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf026
            #add-point:BEFORE FIELD isaf026 name="construct.b.isaf026"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf026
            
            #add-point:AFTER FIELD isaf026 name="construct.a.isaf026"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf026
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf026
            #add-point:ON ACTION controlp INFIELD isaf026 name="construct.c.isaf026"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf045
            #add-point:BEFORE FIELD isaf045 name="construct.b.isaf045"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf045
            
            #add-point:AFTER FIELD isaf045 name="construct.a.isaf045"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf045
            #add-point:ON ACTION controlp INFIELD isaf045 name="construct.c.isaf045"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf027
            #add-point:BEFORE FIELD isaf027 name="construct.b.isaf027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf027
            
            #add-point:AFTER FIELD isaf027 name="construct.a.isaf027"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf027
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf027
            #add-point:ON ACTION controlp INFIELD isaf027 name="construct.c.isaf027"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf028
            #add-point:BEFORE FIELD isaf028 name="construct.b.isaf028"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf028
            
            #add-point:AFTER FIELD isaf028 name="construct.a.isaf028"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf028
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf028
            #add-point:ON ACTION controlp INFIELD isaf028 name="construct.c.isaf028"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf029
            #add-point:BEFORE FIELD isaf029 name="construct.b.isaf029"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf029
            
            #add-point:AFTER FIELD isaf029 name="construct.a.isaf029"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf029
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf029
            #add-point:ON ACTION controlp INFIELD isaf029 name="construct.c.isaf029"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf030
            #add-point:BEFORE FIELD isaf030 name="construct.b.isaf030"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf030
            
            #add-point:AFTER FIELD isaf030 name="construct.a.isaf030"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf030
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf030
            #add-point:ON ACTION controlp INFIELD isaf030 name="construct.c.isaf030"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf031
            #add-point:BEFORE FIELD isaf031 name="construct.b.isaf031"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf031
            
            #add-point:AFTER FIELD isaf031 name="construct.a.isaf031"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf031
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf031
            #add-point:ON ACTION controlp INFIELD isaf031 name="construct.c.isaf031"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf032
            #add-point:BEFORE FIELD isaf032 name="construct.b.isaf032"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf032
            
            #add-point:AFTER FIELD isaf032 name="construct.a.isaf032"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf032
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf032
            #add-point:ON ACTION controlp INFIELD isaf032 name="construct.c.isaf032"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf046
            #add-point:BEFORE FIELD isaf046 name="construct.b.isaf046"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf046
            
            #add-point:AFTER FIELD isaf046 name="construct.a.isaf046"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf046
            #add-point:ON ACTION controlp INFIELD isaf046 name="construct.c.isaf046"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf103
            #add-point:BEFORE FIELD isaf103 name="construct.b.isaf103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf103
            
            #add-point:AFTER FIELD isaf103 name="construct.a.isaf103"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf103
            #add-point:ON ACTION controlp INFIELD isaf103 name="construct.c.isaf103"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf104
            #add-point:BEFORE FIELD isaf104 name="construct.b.isaf104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf104
            
            #add-point:AFTER FIELD isaf104 name="construct.a.isaf104"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf104
            #add-point:ON ACTION controlp INFIELD isaf104 name="construct.c.isaf104"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf105
            #add-point:BEFORE FIELD isaf105 name="construct.b.isaf105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf105
            
            #add-point:AFTER FIELD isaf105 name="construct.a.isaf105"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf105
            #add-point:ON ACTION controlp INFIELD isaf105 name="construct.c.isaf105"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf106
            #add-point:BEFORE FIELD isaf106 name="construct.b.isaf106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf106
            
            #add-point:AFTER FIELD isaf106 name="construct.a.isaf106"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf106
            #add-point:ON ACTION controlp INFIELD isaf106 name="construct.c.isaf106"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf107
            #add-point:BEFORE FIELD isaf107 name="construct.b.isaf107"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf107
            
            #add-point:AFTER FIELD isaf107 name="construct.a.isaf107"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf107
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf107
            #add-point:ON ACTION controlp INFIELD isaf107 name="construct.c.isaf107"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf108
            #add-point:BEFORE FIELD isaf108 name="construct.b.isaf108"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf108
            
            #add-point:AFTER FIELD isaf108 name="construct.a.isaf108"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf108
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf108
            #add-point:ON ACTION controlp INFIELD isaf108 name="construct.c.isaf108"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf113
            #add-point:BEFORE FIELD isaf113 name="construct.b.isaf113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf113
            
            #add-point:AFTER FIELD isaf113 name="construct.a.isaf113"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf113
            #add-point:ON ACTION controlp INFIELD isaf113 name="construct.c.isaf113"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf114
            #add-point:BEFORE FIELD isaf114 name="construct.b.isaf114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf114
            
            #add-point:AFTER FIELD isaf114 name="construct.a.isaf114"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf114
            #add-point:ON ACTION controlp INFIELD isaf114 name="construct.c.isaf114"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf115
            #add-point:BEFORE FIELD isaf115 name="construct.b.isaf115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf115
            
            #add-point:AFTER FIELD isaf115 name="construct.a.isaf115"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf115
            #add-point:ON ACTION controlp INFIELD isaf115 name="construct.c.isaf115"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf116
            #add-point:BEFORE FIELD isaf116 name="construct.b.isaf116"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf116
            
            #add-point:AFTER FIELD isaf116 name="construct.a.isaf116"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf116
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf116
            #add-point:ON ACTION controlp INFIELD isaf116 name="construct.c.isaf116"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf117
            #add-point:BEFORE FIELD isaf117 name="construct.b.isaf117"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf117
            
            #add-point:AFTER FIELD isaf117 name="construct.a.isaf117"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf117
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf117
            #add-point:ON ACTION controlp INFIELD isaf117 name="construct.c.isaf117"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf118
            #add-point:BEFORE FIELD isaf118 name="construct.b.isaf118"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf118
            
            #add-point:AFTER FIELD isaf118 name="construct.a.isaf118"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf118
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf118
            #add-point:ON ACTION controlp INFIELD isaf118 name="construct.c.isaf118"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf119
            #add-point:BEFORE FIELD isaf119 name="construct.b.isaf119"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf119
            
            #add-point:AFTER FIELD isaf119 name="construct.a.isaf119"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf119
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf119
            #add-point:ON ACTION controlp INFIELD isaf119 name="construct.c.isaf119"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf120
            #add-point:BEFORE FIELD isaf120 name="construct.b.isaf120"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf120
            
            #add-point:AFTER FIELD isaf120 name="construct.a.isaf120"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf120
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf120
            #add-point:ON ACTION controlp INFIELD isaf120 name="construct.c.isaf120"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf121
            #add-point:BEFORE FIELD isaf121 name="construct.b.isaf121"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf121
            
            #add-point:AFTER FIELD isaf121 name="construct.a.isaf121"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf121
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf121
            #add-point:ON ACTION controlp INFIELD isaf121 name="construct.c.isaf121"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf033
            #add-point:BEFORE FIELD isaf033 name="construct.b.isaf033"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf033
            
            #add-point:AFTER FIELD isaf033 name="construct.a.isaf033"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf033
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf033
            #add-point:ON ACTION controlp INFIELD isaf033 name="construct.c.isaf033"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf034
            #add-point:BEFORE FIELD isaf034 name="construct.b.isaf034"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf034
            
            #add-point:AFTER FIELD isaf034 name="construct.a.isaf034"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf034
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf034
            #add-point:ON ACTION controlp INFIELD isaf034 name="construct.c.isaf034"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf035
            #add-point:BEFORE FIELD isaf035 name="construct.b.isaf035"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf035
            
            #add-point:AFTER FIELD isaf035 name="construct.a.isaf035"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf035
            #add-point:ON ACTION controlp INFIELD isaf035 name="construct.c.isaf035"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf048
            #add-point:BEFORE FIELD isaf048 name="construct.b.isaf048"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf048
            
            #add-point:AFTER FIELD isaf048 name="construct.a.isaf048"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf048
            #add-point:ON ACTION controlp INFIELD isaf048 name="construct.c.isaf048"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf049
            #add-point:BEFORE FIELD isaf049 name="construct.b.isaf049"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf049
            
            #add-point:AFTER FIELD isaf049 name="construct.a.isaf049"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf049
            #add-point:ON ACTION controlp INFIELD isaf049 name="construct.c.isaf049"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf201
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf201
            #add-point:ON ACTION controlp INFIELD isaf201 name="construct.c.isaf201"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = '3801'
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf201  #顯示到畫面上

            NEXT FIELD isaf201                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf201
            #add-point:BEFORE FIELD isaf201 name="construct.b.isaf201"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf201
            
            #add-point:AFTER FIELD isaf201 name="construct.a.isaf201"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf202
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf202
            #add-point:ON ACTION controlp INFIELD isaf202 name="construct.c.isaf202"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = '3802'
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf202  #顯示到畫面上

            NEXT FIELD isaf202                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf202
            #add-point:BEFORE FIELD isaf202 name="construct.b.isaf202"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf202
            
            #add-point:AFTER FIELD isaf202 name="construct.a.isaf202"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf203
            #add-point:BEFORE FIELD isaf203 name="construct.b.isaf203"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf203
            
            #add-point:AFTER FIELD isaf203 name="construct.a.isaf203"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf203
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf203
            #add-point:ON ACTION controlp INFIELD isaf203 name="construct.c.isaf203"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf204
            #add-point:BEFORE FIELD isaf204 name="construct.b.isaf204"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf204
            
            #add-point:AFTER FIELD isaf204 name="construct.a.isaf204"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf204
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf204
            #add-point:ON ACTION controlp INFIELD isaf204 name="construct.c.isaf204"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf207
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf207
            #add-point:ON ACTION controlp INFIELD isaf207 name="construct.c.isaf207"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = '3803'
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf207  #顯示到畫面上

            NEXT FIELD isaf207                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf207
            #add-point:BEFORE FIELD isaf207 name="construct.b.isaf207"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf207
            
            #add-point:AFTER FIELD isaf207 name="construct.a.isaf207"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf205
            #add-point:BEFORE FIELD isaf205 name="construct.b.isaf205"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf205
            
            #add-point:AFTER FIELD isaf205 name="construct.a.isaf205"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf205
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf205
            #add-point:ON ACTION controlp INFIELD isaf205 name="construct.c.isaf205"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf206
            #add-point:BEFORE FIELD isaf206 name="construct.b.isaf206"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf206
            
            #add-point:AFTER FIELD isaf206 name="construct.a.isaf206"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf206
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf206
            #add-point:ON ACTION controlp INFIELD isaf206 name="construct.c.isaf206"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf037
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf037
            #add-point:ON ACTION controlp INFIELD isaf037 name="construct.c.isaf037"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = '3804'
            CALL q_oocq002()
            DISPLAY g_qryparam.return1 TO isaf037
            NEXT FIELD isaf037
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf037
            #add-point:BEFORE FIELD isaf037 name="construct.b.isaf037"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf037
            
            #add-point:AFTER FIELD isaf037 name="construct.a.isaf037"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf038
            #add-point:BEFORE FIELD isaf038 name="construct.b.isaf038"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf038
            
            #add-point:AFTER FIELD isaf038 name="construct.a.isaf038"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf038
            #add-point:ON ACTION controlp INFIELD isaf038 name="construct.c.isaf038"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf039
            #add-point:BEFORE FIELD isaf039 name="construct.b.isaf039"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf039
            
            #add-point:AFTER FIELD isaf039 name="construct.a.isaf039"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf039
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf039
            #add-point:ON ACTION controlp INFIELD isaf039 name="construct.c.isaf039"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf040
            #add-point:BEFORE FIELD isaf040 name="construct.b.isaf040"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf040
            
            #add-point:AFTER FIELD isaf040 name="construct.a.isaf040"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf040
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf040
            #add-point:ON ACTION controlp INFIELD isaf040 name="construct.c.isaf040"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf041
            #add-point:BEFORE FIELD isaf041 name="construct.b.isaf041"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf041
            
            #add-point:AFTER FIELD isaf041 name="construct.a.isaf041"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf041
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf041
            #add-point:ON ACTION controlp INFIELD isaf041 name="construct.c.isaf041"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf041  #顯示到畫面上

            NEXT FIELD isaf041                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf042
            #add-point:BEFORE FIELD isaf042 name="construct.b.isaf042"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf042
            
            #add-point:AFTER FIELD isaf042 name="construct.a.isaf042"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf042
            #add-point:ON ACTION controlp INFIELD isaf042 name="construct.c.isaf042"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf055
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf055
            #add-point:ON ACTION controlp INFIELD isaf055 name="construct.c.isaf055"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #151231-00010#3-----s
            LET g_qryparam.where =  g_ctl_where
            #151231-00010#3-----e
            #CALL q_pmaa001()     #160920-00019#5--mark   
            CALL q_pmaa001_13()   #160920-00019#5--add
            DISPLAY g_qryparam.return1 TO isaf055  #顯示到畫面上
            NEXT FIELD isaf055                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf055
            #add-point:BEFORE FIELD isaf055 name="construct.b.isaf055"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf055
            
            #add-point:AFTER FIELD isaf055 name="construct.a.isaf055"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf007
            #add-point:BEFORE FIELD isaf007 name="construct.b.isaf007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf007
            
            #add-point:AFTER FIELD isaf007 name="construct.a.isaf007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf007
            #add-point:ON ACTION controlp INFIELD isaf007 name="construct.c.isaf007"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf006
            #add-point:ON ACTION controlp INFIELD isaf006 name="construct.c.isaf006"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			   #161006-00005#29   add---s
			   LET g_qryparam.where = " EXISTS (SELECT 1 FROM isao_t WHERE isaoent = ooefent",
                                      " AND isaosite = ooef001 ",
                                               ") ",
                                      " AND ooef201= 'Y'" ,
                                      " AND ooef001 IN ",g_wc_isagorga
            #161006-00005#29   add---e
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isaf006  #顯示到畫面上

            NEXT FIELD isaf006                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf006
            #add-point:BEFORE FIELD isaf006 name="construct.b.isaf006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf006
            
            #add-point:AFTER FIELD isaf006 name="construct.a.isaf006"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf050
            #add-point:BEFORE FIELD isaf050 name="construct.b.isaf050"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf050
            
            #add-point:AFTER FIELD isaf050 name="construct.a.isaf050"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf050
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf050
            #add-point:ON ACTION controlp INFIELD isaf050 name="construct.c.isaf050"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isaf004
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf004
            #add-point:ON ACTION controlp INFIELD isaf004 name="construct.c.isaf004"
            #業務部門
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #CALL q_ooef001()     #161006-00005#29 mark
            CALL q_ooeg001_4()    #161006-00005#29 add
            DISPLAY g_qryparam.return1 TO isaf004
            NEXT FIELD isaf004
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf004
            #add-point:BEFORE FIELD isaf004 name="construct.b.isaf004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf004
            
            #add-point:AFTER FIELD isaf004 name="construct.a.isaf004"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf044
            #add-point:BEFORE FIELD isaf044 name="construct.b.isaf044"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf044
            
            #add-point:AFTER FIELD isaf044 name="construct.a.isaf044"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf044
            #add-point:ON ACTION controlp INFIELD isaf044 name="construct.c.isaf044"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf066
            #add-point:BEFORE FIELD isaf066 name="construct.b.isaf066"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf066
            
            #add-point:AFTER FIELD isaf066 name="construct.a.isaf066"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf066
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf066
            #add-point:ON ACTION controlp INFIELD isaf066 name="construct.c.isaf066"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf019
            #add-point:BEFORE FIELD isaf019 name="construct.b.isaf019"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf019
            
            #add-point:AFTER FIELD isaf019 name="construct.a.isaf019"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf019
            #add-point:ON ACTION controlp INFIELD isaf019 name="construct.c.isaf019"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf019_desc
            #add-point:BEFORE FIELD isaf019_desc name="construct.b.isaf019_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf019_desc
            
            #add-point:AFTER FIELD isaf019_desc name="construct.a.isaf019_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf019_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf019_desc
            #add-point:ON ACTION controlp INFIELD isaf019_desc name="construct.c.isaf019_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf059
            #add-point:BEFORE FIELD isaf059 name="construct.b.isaf059"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf059
            
            #add-point:AFTER FIELD isaf059 name="construct.a.isaf059"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf059
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf059
            #add-point:ON ACTION controlp INFIELD isaf059 name="construct.c.isaf059"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf060
            #add-point:BEFORE FIELD isaf060 name="construct.b.isaf060"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf060
            
            #add-point:AFTER FIELD isaf060 name="construct.a.isaf060"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf060
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf060
            #add-point:ON ACTION controlp INFIELD isaf060 name="construct.c.isaf060"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf061
            #add-point:BEFORE FIELD isaf061 name="construct.b.isaf061"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf061
            
            #add-point:AFTER FIELD isaf061 name="construct.a.isaf061"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf061
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf061
            #add-point:ON ACTION controlp INFIELD isaf061 name="construct.c.isaf061"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf063
            #add-point:BEFORE FIELD isaf063 name="construct.b.isaf063"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf063
            
            #add-point:AFTER FIELD isaf063 name="construct.a.isaf063"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf063
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf063
            #add-point:ON ACTION controlp INFIELD isaf063 name="construct.c.isaf063"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf062
            #add-point:BEFORE FIELD isaf062 name="construct.b.isaf062"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf062
            
            #add-point:AFTER FIELD isaf062 name="construct.a.isaf062"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf062
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf062
            #add-point:ON ACTION controlp INFIELD isaf062 name="construct.c.isaf062"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf064
            #add-point:BEFORE FIELD isaf064 name="construct.b.isaf064"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf064
            
            #add-point:AFTER FIELD isaf064 name="construct.a.isaf064"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf064
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf064
            #add-point:ON ACTION controlp INFIELD isaf064 name="construct.c.isaf064"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf065
            #add-point:BEFORE FIELD isaf065 name="construct.b.isaf065"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf065
            
            #add-point:AFTER FIELD isaf065 name="construct.a.isaf065"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf065
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf065
            #add-point:ON ACTION controlp INFIELD isaf065 name="construct.c.isaf065"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf208
            #add-point:BEFORE FIELD isaf208 name="construct.b.isaf208"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf208
            
            #add-point:AFTER FIELD isaf208 name="construct.a.isaf208"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf208
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf208
            #add-point:ON ACTION controlp INFIELD isaf208 name="construct.c.isaf208"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf209
            #add-point:BEFORE FIELD isaf209 name="construct.b.isaf209"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf209
            
            #add-point:AFTER FIELD isaf209 name="construct.a.isaf209"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf209
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf209
            #add-point:ON ACTION controlp INFIELD isaf209 name="construct.c.isaf209"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf210
            #add-point:BEFORE FIELD isaf210 name="construct.b.isaf210"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf210
            
            #add-point:AFTER FIELD isaf210 name="construct.a.isaf210"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isaf210
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf210
            #add-point:ON ACTION controlp INFIELD isaf210 name="construct.c.isaf210"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isafownid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafownid
            #add-point:ON ACTION controlp INFIELD isafownid name="construct.c.isafownid"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isafownid  #顯示到畫面上

            NEXT FIELD isafownid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafownid
            #add-point:BEFORE FIELD isafownid name="construct.b.isafownid"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafownid
            
            #add-point:AFTER FIELD isafownid name="construct.a.isafownid"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isafowndp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafowndp
            #add-point:ON ACTION controlp INFIELD isafowndp name="construct.c.isafowndp"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isafowndp  #顯示到畫面上

            NEXT FIELD isafowndp                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafowndp
            #add-point:BEFORE FIELD isafowndp name="construct.b.isafowndp"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafowndp
            
            #add-point:AFTER FIELD isafowndp name="construct.a.isafowndp"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isafcrtid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafcrtid
            #add-point:ON ACTION controlp INFIELD isafcrtid name="construct.c.isafcrtid"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isafcrtid  #顯示到畫面上

            NEXT FIELD isafcrtid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafcrtid
            #add-point:BEFORE FIELD isafcrtid name="construct.b.isafcrtid"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafcrtid
            
            #add-point:AFTER FIELD isafcrtid name="construct.a.isafcrtid"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isafcrtdp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafcrtdp
            #add-point:ON ACTION controlp INFIELD isafcrtdp name="construct.c.isafcrtdp"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isafcrtdp  #顯示到畫面上

            NEXT FIELD isafcrtdp                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafcrtdp
            #add-point:BEFORE FIELD isafcrtdp name="construct.b.isafcrtdp"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafcrtdp
            
            #add-point:AFTER FIELD isafcrtdp name="construct.a.isafcrtdp"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafcrtdt
            #add-point:BEFORE FIELD isafcrtdt name="construct.b.isafcrtdt"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isafmodid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafmodid
            #add-point:ON ACTION controlp INFIELD isafmodid name="construct.c.isafmodid"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isafmodid  #顯示到畫面上

            NEXT FIELD isafmodid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafmodid
            #add-point:BEFORE FIELD isafmodid name="construct.b.isafmodid"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafmodid
            
            #add-point:AFTER FIELD isafmodid name="construct.a.isafmodid"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafmoddt
            #add-point:BEFORE FIELD isafmoddt name="construct.b.isafmoddt"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isafcnfid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafcnfid
            #add-point:ON ACTION controlp INFIELD isafcnfid name="construct.c.isafcnfid"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isafcnfid  #顯示到畫面上

            NEXT FIELD isafcnfid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafcnfid
            #add-point:BEFORE FIELD isafcnfid name="construct.b.isafcnfid"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafcnfid
            
            #add-point:AFTER FIELD isafcnfid name="construct.a.isafcnfid"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafcnfdt
            #add-point:BEFORE FIELD isafcnfdt name="construct.b.isafcnfdt"
            
            #END add-point
 
 
 
         
      END CONSTRUCT
 
      #單身根據table分拆construct
      CONSTRUCT g_wc2_table1 ON isagseq,isagorga,isag001,isag003,isag018,isag009,isag010,imaal004,isag016, 
          isag017,isag015,inag009,xmdl047,inag007,inag007_desc,isag006,isag008,isag012,isag004,isag005, 
          isag005_desc,isag101,isag103,isag104,isag105,isag113,isag114,isag115,isag116,isag117,isag013, 
          isag014,isag011
           FROM s_detail1[1].isagseq,s_detail1[1].isagorga,s_detail1[1].isag001,s_detail1[1].isag003, 
               s_detail1[1].isag018,s_detail1[1].isag009,s_detail1[1].isag010,s_detail1[1].imaal004, 
               s_detail1[1].isag016,s_detail1[1].isag017,s_detail1[1].isag015,s_detail1[1].inag009,s_detail1[1].xmdl047, 
               s_detail1[1].inag007,s_detail1[1].inag007_desc,s_detail1[1].isag006,s_detail1[1].isag008, 
               s_detail1[1].isag012,s_detail1[1].isag004,s_detail1[1].isag005,s_detail1[1].isag005_desc, 
               s_detail1[1].isag101,s_detail1[1].isag103,s_detail1[1].isag104,s_detail1[1].isag105,s_detail1[1].isag113, 
               s_detail1[1].isag114,s_detail1[1].isag115,s_detail1[1].isag116,s_detail1[1].isag117,s_detail1[1].isag013, 
               s_detail1[1].isag014,s_detail1[1].isag011
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body.before_construct"
            
            #end add-point 
            
       #單身公用欄位開窗相關處理
       
         
       #單身一般欄位開窗相關處理
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isagseq
            #add-point:BEFORE FIELD isagseq name="construct.b.page1.isagseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isagseq
            
            #add-point:AFTER FIELD isagseq name="construct.a.page1.isagseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isagseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isagseq
            #add-point:ON ACTION controlp INFIELD isagseq name="construct.c.page1.isagseq"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.isagorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isagorga
            #add-point:ON ACTION controlp INFIELD isagorga name="construct.c.page1.isagorga"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			   LET g_qryparam.where = " ooef201 = 'Y'"   #161006-00005#29   add
			   #160907-00041#1 --s add
            IF NOT cl_null(g_wc_isagorga) THEN         
               LET g_qryparam.where = g_qryparam.where CLIPPED,   #161006-00005#29  add
                                     " AND ooef001 IN ",g_wc_isagorga
            END IF  
            #160907-00041#1 --e add
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isagorga  #顯示到畫面上

            NEXT FIELD isagorga                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isagorga
            #add-point:BEFORE FIELD isagorga name="construct.b.page1.isagorga"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isagorga
            
            #add-point:AFTER FIELD isagorga name="construct.a.page1.isagorga"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag001
            #add-point:BEFORE FIELD isag001 name="construct.b.page1.isag001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag001
            
            #add-point:AFTER FIELD isag001 name="construct.a.page1.isag001"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag001
            #add-point:ON ACTION controlp INFIELD isag001 name="construct.c.page1.isag001"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag003
            #add-point:BEFORE FIELD isag003 name="construct.b.page1.isag003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag003
            
            #add-point:AFTER FIELD isag003 name="construct.a.page1.isag003"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag003
            #add-point:ON ACTION controlp INFIELD isag003 name="construct.c.page1.isag003"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_xrcadocno_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isag003  #顯示到畫面上

            NEXT FIELD isag003                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag018
            #add-point:BEFORE FIELD isag018 name="construct.b.page1.isag018"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag018
            
            #add-point:AFTER FIELD isag018 name="construct.a.page1.isag018"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag018
            #add-point:ON ACTION controlp INFIELD isag018 name="construct.c.page1.isag018"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.isag009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag009
            #add-point:ON ACTION controlp INFIELD isag009 name="construct.c.page1.isag009"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_imaf001_7()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isag009  #顯示到畫面上
            NEXT FIELD isag009                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag009
            #add-point:BEFORE FIELD isag009 name="construct.b.page1.isag009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag009
            
            #add-point:AFTER FIELD isag009 name="construct.a.page1.isag009"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag010
            #add-point:BEFORE FIELD isag010 name="construct.b.page1.isag010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag010
            
            #add-point:AFTER FIELD isag010 name="construct.a.page1.isag010"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag010
            #add-point:ON ACTION controlp INFIELD isag010 name="construct.c.page1.isag010"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD imaal004
            #add-point:BEFORE FIELD imaal004 name="construct.b.page1.imaal004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD imaal004
            
            #add-point:AFTER FIELD imaal004 name="construct.a.page1.imaal004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.imaal004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD imaal004
            #add-point:ON ACTION controlp INFIELD imaal004 name="construct.c.page1.imaal004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag016
            #add-point:BEFORE FIELD isag016 name="construct.b.page1.isag016"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag016
            
            #add-point:AFTER FIELD isag016 name="construct.a.page1.isag016"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag016
            #add-point:ON ACTION controlp INFIELD isag016 name="construct.c.page1.isag016"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag017
            #add-point:BEFORE FIELD isag017 name="construct.b.page1.isag017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag017
            
            #add-point:AFTER FIELD isag017 name="construct.a.page1.isag017"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag017
            #add-point:ON ACTION controlp INFIELD isag017 name="construct.c.page1.isag017"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag015
            #add-point:BEFORE FIELD isag015 name="construct.b.page1.isag015"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag015
            
            #add-point:AFTER FIELD isag015 name="construct.a.page1.isag015"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag015
            #add-point:ON ACTION controlp INFIELD isag015 name="construct.c.page1.isag015"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD inag009
            #add-point:BEFORE FIELD inag009 name="construct.b.page1.inag009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD inag009
            
            #add-point:AFTER FIELD inag009 name="construct.a.page1.inag009"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.inag009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD inag009
            #add-point:ON ACTION controlp INFIELD inag009 name="construct.c.page1.inag009"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xmdl047
            #add-point:BEFORE FIELD xmdl047 name="construct.b.page1.xmdl047"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xmdl047
            
            #add-point:AFTER FIELD xmdl047 name="construct.a.page1.xmdl047"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.xmdl047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xmdl047
            #add-point:ON ACTION controlp INFIELD xmdl047 name="construct.c.page1.xmdl047"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD inag007
            #add-point:BEFORE FIELD inag007 name="construct.b.page1.inag007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD inag007
            
            #add-point:AFTER FIELD inag007 name="construct.a.page1.inag007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.inag007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD inag007
            #add-point:ON ACTION controlp INFIELD inag007 name="construct.c.page1.inag007"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD inag007_desc
            #add-point:BEFORE FIELD inag007_desc name="construct.b.page1.inag007_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD inag007_desc
            
            #add-point:AFTER FIELD inag007_desc name="construct.a.page1.inag007_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.inag007_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD inag007_desc
            #add-point:ON ACTION controlp INFIELD inag007_desc name="construct.c.page1.inag007_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag006
            #add-point:BEFORE FIELD isag006 name="construct.b.page1.isag006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag006
            
            #add-point:AFTER FIELD isag006 name="construct.a.page1.isag006"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag006
            #add-point:ON ACTION controlp INFIELD isag006 name="construct.c.page1.isag006"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag008
            #add-point:BEFORE FIELD isag008 name="construct.b.page1.isag008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag008
            
            #add-point:AFTER FIELD isag008 name="construct.a.page1.isag008"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag008
            #add-point:ON ACTION controlp INFIELD isag008 name="construct.c.page1.isag008"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.isag012
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag012
            #add-point:ON ACTION controlp INFIELD isag012 name="construct.c.page1.isag012"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooib001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isag012  #顯示到畫面上
            NEXT FIELD isag012                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag012
            #add-point:BEFORE FIELD isag012 name="construct.b.page1.isag012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag012
            
            #add-point:AFTER FIELD isag012 name="construct.a.page1.isag012"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag004
            #add-point:BEFORE FIELD isag004 name="construct.b.page1.isag004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag004
            
            #add-point:AFTER FIELD isag004 name="construct.a.page1.isag004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag004
            #add-point:ON ACTION controlp INFIELD isag004 name="construct.c.page1.isag004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag005
            #add-point:BEFORE FIELD isag005 name="construct.b.page1.isag005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag005
            
            #add-point:AFTER FIELD isag005 name="construct.a.page1.isag005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag005
            #add-point:ON ACTION controlp INFIELD isag005 name="construct.c.page1.isag005"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.isag005_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag005_desc
            #add-point:ON ACTION controlp INFIELD isag005_desc name="construct.c.page1.isag005_desc"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isag005_desc  #顯示到畫面上

            NEXT FIELD isag005_desc                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag005_desc
            #add-point:BEFORE FIELD isag005_desc name="construct.b.page1.isag005_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag005_desc
            
            #add-point:AFTER FIELD isag005_desc name="construct.a.page1.isag005_desc"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag101
            #add-point:BEFORE FIELD isag101 name="construct.b.page1.isag101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag101
            
            #add-point:AFTER FIELD isag101 name="construct.a.page1.isag101"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag101
            #add-point:ON ACTION controlp INFIELD isag101 name="construct.c.page1.isag101"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag103
            #add-point:BEFORE FIELD isag103 name="construct.b.page1.isag103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag103
            
            #add-point:AFTER FIELD isag103 name="construct.a.page1.isag103"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag103
            #add-point:ON ACTION controlp INFIELD isag103 name="construct.c.page1.isag103"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag104
            #add-point:BEFORE FIELD isag104 name="construct.b.page1.isag104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag104
            
            #add-point:AFTER FIELD isag104 name="construct.a.page1.isag104"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag104
            #add-point:ON ACTION controlp INFIELD isag104 name="construct.c.page1.isag104"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag105
            #add-point:BEFORE FIELD isag105 name="construct.b.page1.isag105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag105
            
            #add-point:AFTER FIELD isag105 name="construct.a.page1.isag105"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag105
            #add-point:ON ACTION controlp INFIELD isag105 name="construct.c.page1.isag105"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag113
            #add-point:BEFORE FIELD isag113 name="construct.b.page1.isag113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag113
            
            #add-point:AFTER FIELD isag113 name="construct.a.page1.isag113"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag113
            #add-point:ON ACTION controlp INFIELD isag113 name="construct.c.page1.isag113"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag114
            #add-point:BEFORE FIELD isag114 name="construct.b.page1.isag114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag114
            
            #add-point:AFTER FIELD isag114 name="construct.a.page1.isag114"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag114
            #add-point:ON ACTION controlp INFIELD isag114 name="construct.c.page1.isag114"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag115
            #add-point:BEFORE FIELD isag115 name="construct.b.page1.isag115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag115
            
            #add-point:AFTER FIELD isag115 name="construct.a.page1.isag115"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag115
            #add-point:ON ACTION controlp INFIELD isag115 name="construct.c.page1.isag115"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag116
            #add-point:BEFORE FIELD isag116 name="construct.b.page1.isag116"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag116
            
            #add-point:AFTER FIELD isag116 name="construct.a.page1.isag116"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag116
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag116
            #add-point:ON ACTION controlp INFIELD isag116 name="construct.c.page1.isag116"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag117
            #add-point:BEFORE FIELD isag117 name="construct.b.page1.isag117"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag117
            
            #add-point:AFTER FIELD isag117 name="construct.a.page1.isag117"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag117
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag117
            #add-point:ON ACTION controlp INFIELD isag117 name="construct.c.page1.isag117"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag013
            #add-point:BEFORE FIELD isag013 name="construct.b.page1.isag013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag013
            
            #add-point:AFTER FIELD isag013 name="construct.a.page1.isag013"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag013
            #add-point:ON ACTION controlp INFIELD isag013 name="construct.c.page1.isag013"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag014
            #add-point:BEFORE FIELD isag014 name="construct.b.page1.isag014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag014
            
            #add-point:AFTER FIELD isag014 name="construct.a.page1.isag014"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag014
            #add-point:ON ACTION controlp INFIELD isag014 name="construct.c.page1.isag014"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag011
            #add-point:BEFORE FIELD isag011 name="construct.b.page1.isag011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag011
            
            #add-point:AFTER FIELD isag011 name="construct.a.page1.isag011"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isag011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag011
            #add-point:ON ACTION controlp INFIELD isag011 name="construct.c.page1.isag011"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
      
      CONSTRUCT g_wc2_table2 ON isahseq,isahorga,isah003,isah004,isah013,isah005,isah005_desc,isah010, 
          isah006,isah101,isah103,isah007,isah104,isah105,isah113,isah114,isah115,isah001,isah002,isah008, 
          isah009,isah011,isah106,isah012,isah116
           FROM s_detail2[1].isahseq,s_detail2[1].isahorga,s_detail2[1].isah003,s_detail2[1].isah004, 
               s_detail2[1].isah013,s_detail2[1].isah005,s_detail2[1].isah005_desc,s_detail2[1].isah010, 
               s_detail2[1].isah006,s_detail2[1].isah101,s_detail2[1].isah103,s_detail2[1].isah007,s_detail2[1].isah104, 
               s_detail2[1].isah105,s_detail2[1].isah113,s_detail2[1].isah114,s_detail2[1].isah115,s_detail2[1].isah001, 
               s_detail2[1].isah002,s_detail2[1].isah008,s_detail2[1].isah009,s_detail2[1].isah011,s_detail2[1].isah106, 
               s_detail2[1].isah012,s_detail2[1].isah116
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body2.before_construct"
            #160826-00017#1   add---s
            #LET l_ac = 1
            #LET g_isag2_d[l_ac].isahseq = ''
            #DISPLAY ARRAY g_isag2_d TO s_detail2.*
            #   BEFORE DISPLAY
            #   EXIT DISPLAY
            #END DISPLAY
            #160826-00017#1   add---e
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 2)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isahseq
            #add-point:BEFORE FIELD isahseq name="construct.b.page2.isahseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isahseq
            
            #add-point:AFTER FIELD isahseq name="construct.a.page2.isahseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isahseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isahseq
            #add-point:ON ACTION controlp INFIELD isahseq name="construct.c.page2.isahseq"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page2.isahorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isahorga
            #add-point:ON ACTION controlp INFIELD isahorga name="construct.c.page2.isahorga"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			   #161006-00005#29   add---s
            LET g_qryparam.where = " ooef201 = 'Y'"   
            IF NOT cl_null(g_wc_isagorga)THEN
               LET g_qryparam.where = g_qryparam.where , 
                                     " AND ooef001 IN ",g_wc_isagorga          
            END IF
            #161006-00005#29  add---e
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isahorga  #顯示到畫面上

            NEXT FIELD isahorga                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isahorga
            #add-point:BEFORE FIELD isahorga name="construct.b.page2.isahorga"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isahorga
            
            #add-point:AFTER FIELD isahorga name="construct.a.page2.isahorga"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah003
            #add-point:ON ACTION controlp INFIELD isah003 name="construct.c.page2.isah003"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_imaf001_7()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isah003  #顯示到畫面上

            NEXT FIELD isah003                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah003
            #add-point:BEFORE FIELD isah003 name="construct.b.page2.isah003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah003
            
            #add-point:AFTER FIELD isah003 name="construct.a.page2.isah003"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah004
            #add-point:BEFORE FIELD isah004 name="construct.b.page2.isah004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah004
            
            #add-point:AFTER FIELD isah004 name="construct.a.page2.isah004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah004
            #add-point:ON ACTION controlp INFIELD isah004 name="construct.c.page2.isah004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah013
            #add-point:BEFORE FIELD isah013 name="construct.b.page2.isah013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah013
            
            #add-point:AFTER FIELD isah013 name="construct.a.page2.isah013"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah013
            #add-point:ON ACTION controlp INFIELD isah013 name="construct.c.page2.isah013"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah005
            #add-point:BEFORE FIELD isah005 name="construct.b.page2.isah005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah005
            
            #add-point:AFTER FIELD isah005 name="construct.a.page2.isah005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah005
            #add-point:ON ACTION controlp INFIELD isah005 name="construct.c.page2.isah005"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page2.isah005_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah005_desc
            #add-point:ON ACTION controlp INFIELD isah005_desc name="construct.c.page2.isah005_desc"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isah005_desc  #顯示到畫面上

            NEXT FIELD isah005_desc                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah005_desc
            #add-point:BEFORE FIELD isah005_desc name="construct.b.page2.isah005_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah005_desc
            
            #add-point:AFTER FIELD isah005_desc name="construct.a.page2.isah005_desc"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah010
            #add-point:BEFORE FIELD isah010 name="construct.b.page2.isah010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah010
            
            #add-point:AFTER FIELD isah010 name="construct.a.page2.isah010"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah010
            #add-point:ON ACTION controlp INFIELD isah010 name="construct.c.page2.isah010"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah006
            #add-point:BEFORE FIELD isah006 name="construct.b.page2.isah006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah006
            
            #add-point:AFTER FIELD isah006 name="construct.a.page2.isah006"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah006
            #add-point:ON ACTION controlp INFIELD isah006 name="construct.c.page2.isah006"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah101
            #add-point:BEFORE FIELD isah101 name="construct.b.page2.isah101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah101
            
            #add-point:AFTER FIELD isah101 name="construct.a.page2.isah101"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah101
            #add-point:ON ACTION controlp INFIELD isah101 name="construct.c.page2.isah101"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah103
            #add-point:BEFORE FIELD isah103 name="construct.b.page2.isah103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah103
            
            #add-point:AFTER FIELD isah103 name="construct.a.page2.isah103"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah103
            #add-point:ON ACTION controlp INFIELD isah103 name="construct.c.page2.isah103"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah007
            #add-point:BEFORE FIELD isah007 name="construct.b.page2.isah007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah007
            
            #add-point:AFTER FIELD isah007 name="construct.a.page2.isah007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah007
            #add-point:ON ACTION controlp INFIELD isah007 name="construct.c.page2.isah007"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah104
            #add-point:BEFORE FIELD isah104 name="construct.b.page2.isah104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah104
            
            #add-point:AFTER FIELD isah104 name="construct.a.page2.isah104"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah104
            #add-point:ON ACTION controlp INFIELD isah104 name="construct.c.page2.isah104"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah105
            #add-point:BEFORE FIELD isah105 name="construct.b.page2.isah105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah105
            
            #add-point:AFTER FIELD isah105 name="construct.a.page2.isah105"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah105
            #add-point:ON ACTION controlp INFIELD isah105 name="construct.c.page2.isah105"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah113
            #add-point:BEFORE FIELD isah113 name="construct.b.page2.isah113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah113
            
            #add-point:AFTER FIELD isah113 name="construct.a.page2.isah113"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah113
            #add-point:ON ACTION controlp INFIELD isah113 name="construct.c.page2.isah113"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah114
            #add-point:BEFORE FIELD isah114 name="construct.b.page2.isah114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah114
            
            #add-point:AFTER FIELD isah114 name="construct.a.page2.isah114"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah114
            #add-point:ON ACTION controlp INFIELD isah114 name="construct.c.page2.isah114"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah115
            #add-point:BEFORE FIELD isah115 name="construct.b.page2.isah115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah115
            
            #add-point:AFTER FIELD isah115 name="construct.a.page2.isah115"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah115
            #add-point:ON ACTION controlp INFIELD isah115 name="construct.c.page2.isah115"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah001
            #add-point:BEFORE FIELD isah001 name="construct.b.page2.isah001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah001
            
            #add-point:AFTER FIELD isah001 name="construct.a.page2.isah001"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah001
            #add-point:ON ACTION controlp INFIELD isah001 name="construct.c.page2.isah001"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah002
            #add-point:BEFORE FIELD isah002 name="construct.b.page2.isah002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah002
            
            #add-point:AFTER FIELD isah002 name="construct.a.page2.isah002"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah002
            #add-point:ON ACTION controlp INFIELD isah002 name="construct.c.page2.isah002"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah008
            #add-point:BEFORE FIELD isah008 name="construct.b.page2.isah008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah008
            
            #add-point:AFTER FIELD isah008 name="construct.a.page2.isah008"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah008
            #add-point:ON ACTION controlp INFIELD isah008 name="construct.c.page2.isah008"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah009
            #add-point:BEFORE FIELD isah009 name="construct.b.page2.isah009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah009
            
            #add-point:AFTER FIELD isah009 name="construct.a.page2.isah009"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah009
            #add-point:ON ACTION controlp INFIELD isah009 name="construct.c.page2.isah009"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah011
            #add-point:BEFORE FIELD isah011 name="construct.b.page2.isah011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah011
            
            #add-point:AFTER FIELD isah011 name="construct.a.page2.isah011"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah011
            #add-point:ON ACTION controlp INFIELD isah011 name="construct.c.page2.isah011"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah106
            #add-point:BEFORE FIELD isah106 name="construct.b.page2.isah106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah106
            
            #add-point:AFTER FIELD isah106 name="construct.a.page2.isah106"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah106
            #add-point:ON ACTION controlp INFIELD isah106 name="construct.c.page2.isah106"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah012
            #add-point:BEFORE FIELD isah012 name="construct.b.page2.isah012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah012
            
            #add-point:AFTER FIELD isah012 name="construct.a.page2.isah012"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah012
            #add-point:ON ACTION controlp INFIELD isah012 name="construct.c.page2.isah012"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah116
            #add-point:BEFORE FIELD isah116 name="construct.b.page2.isah116"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah116
            
            #add-point:AFTER FIELD isah116 name="construct.a.page2.isah116"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah116
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah116
            #add-point:ON ACTION controlp INFIELD isah116 name="construct.c.page2.isah116"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table3 ON xrcdld,xrcdseq,xrcb005,xrcd007,xrcd002,xrcd002_desc,xrcd003,xrcd006, 
          xrcd005,xrcd104,xrcd103,xrcd105,xrcd114
           FROM s_detail3[1].xrcdld,s_detail3[1].xrcdseq,s_detail3[1].xrcb005,s_detail3[1].xrcd007,s_detail3[1].xrcd002, 
               s_detail3[1].xrcd002_desc,s_detail3[1].xrcd003,s_detail3[1].xrcd006,s_detail3[1].xrcd005, 
               s_detail3[1].xrcd104,s_detail3[1].xrcd103,s_detail3[1].xrcd105,s_detail3[1].xrcd114
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body3.before_construct"
            #160826-00017#1   add---s
            #LET l_ac = 1
            #LET g_isag3_d[l_ac].xrcdseq = ''
            #DISPLAY ARRAY g_isag3_d TO s_detail3.*
            #   BEFORE DISPLAY
            #      EXIT DISPLAY
            #END DISPLAY
            #160826-00017#1   add---e
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 3)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcdld
            #add-point:BEFORE FIELD xrcdld name="construct.b.page3.xrcdld"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcdld
            
            #add-point:AFTER FIELD xrcdld name="construct.a.page3.xrcdld"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcdld
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcdld
            #add-point:ON ACTION controlp INFIELD xrcdld name="construct.c.page3.xrcdld"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcdseq
            #add-point:BEFORE FIELD xrcdseq name="construct.b.page3.xrcdseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcdseq
            
            #add-point:AFTER FIELD xrcdseq name="construct.a.page3.xrcdseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcdseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcdseq
            #add-point:ON ACTION controlp INFIELD xrcdseq name="construct.c.page3.xrcdseq"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcb005
            #add-point:BEFORE FIELD xrcb005 name="construct.b.page3.xrcb005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcb005
            
            #add-point:AFTER FIELD xrcb005 name="construct.a.page3.xrcb005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcb005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcb005
            #add-point:ON ACTION controlp INFIELD xrcb005 name="construct.c.page3.xrcb005"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd007
            #add-point:BEFORE FIELD xrcd007 name="construct.b.page3.xrcd007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd007
            
            #add-point:AFTER FIELD xrcd007 name="construct.a.page3.xrcd007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcd007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd007
            #add-point:ON ACTION controlp INFIELD xrcd007 name="construct.c.page3.xrcd007"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page3.xrcd002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd002
            #add-point:ON ACTION controlp INFIELD xrcd002 name="construct.c.page3.xrcd002"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_xrcd002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xrcd002  #顯示到畫面上
            NEXT FIELD xrcd002                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd002
            #add-point:BEFORE FIELD xrcd002 name="construct.b.page3.xrcd002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd002
            
            #add-point:AFTER FIELD xrcd002 name="construct.a.page3.xrcd002"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd002_desc
            #add-point:BEFORE FIELD xrcd002_desc name="construct.b.page3.xrcd002_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd002_desc
            
            #add-point:AFTER FIELD xrcd002_desc name="construct.a.page3.xrcd002_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcd002_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd002_desc
            #add-point:ON ACTION controlp INFIELD xrcd002_desc name="construct.c.page3.xrcd002_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd003
            #add-point:BEFORE FIELD xrcd003 name="construct.b.page3.xrcd003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd003
            
            #add-point:AFTER FIELD xrcd003 name="construct.a.page3.xrcd003"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcd003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd003
            #add-point:ON ACTION controlp INFIELD xrcd003 name="construct.c.page3.xrcd003"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd006
            #add-point:BEFORE FIELD xrcd006 name="construct.b.page3.xrcd006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd006
            
            #add-point:AFTER FIELD xrcd006 name="construct.a.page3.xrcd006"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcd006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd006
            #add-point:ON ACTION controlp INFIELD xrcd006 name="construct.c.page3.xrcd006"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd005
            #add-point:BEFORE FIELD xrcd005 name="construct.b.page3.xrcd005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd005
            
            #add-point:AFTER FIELD xrcd005 name="construct.a.page3.xrcd005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcd005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd005
            #add-point:ON ACTION controlp INFIELD xrcd005 name="construct.c.page3.xrcd005"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd104
            #add-point:BEFORE FIELD xrcd104 name="construct.b.page3.xrcd104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd104
            
            #add-point:AFTER FIELD xrcd104 name="construct.a.page3.xrcd104"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcd104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd104
            #add-point:ON ACTION controlp INFIELD xrcd104 name="construct.c.page3.xrcd104"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd103
            #add-point:BEFORE FIELD xrcd103 name="construct.b.page3.xrcd103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd103
            
            #add-point:AFTER FIELD xrcd103 name="construct.a.page3.xrcd103"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcd103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd103
            #add-point:ON ACTION controlp INFIELD xrcd103 name="construct.c.page3.xrcd103"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd105
            #add-point:BEFORE FIELD xrcd105 name="construct.b.page3.xrcd105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd105
            
            #add-point:AFTER FIELD xrcd105 name="construct.a.page3.xrcd105"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcd105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd105
            #add-point:ON ACTION controlp INFIELD xrcd105 name="construct.c.page3.xrcd105"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd114
            #add-point:BEFORE FIELD xrcd114 name="construct.b.page3.xrcd114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd114
            
            #add-point:AFTER FIELD xrcd114 name="construct.a.page3.xrcd114"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.xrcd114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd114
            #add-point:ON ACTION controlp INFIELD xrcd114 name="construct.c.page3.xrcd114"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table4 ON isatseq,isat003,isat004,isat027,isat006,isat002,isat103,isat104,isat105, 
          isat113,isat114,isat115,isat007,isat014,isat106,isat107,isat017
           FROM s_detail4[1].isatseq,s_detail4[1].isat003,s_detail4[1].isat004,s_detail4[1].isat027, 
               s_detail4[1].isat006,s_detail4[1].isat002,s_detail4[1].isat103,s_detail4[1].isat104,s_detail4[1].isat105, 
               s_detail4[1].isat113,s_detail4[1].isat114,s_detail4[1].isat115,s_detail4[1].isat007,s_detail4[1].isat014, 
               s_detail4[1].isat106,s_detail4[1].isat107,s_detail4[1].isat017
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body4.before_construct"
            
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 4)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isatseq
            #add-point:BEFORE FIELD isatseq name="construct.b.page4.isatseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isatseq
            
            #add-point:AFTER FIELD isatseq name="construct.a.page4.isatseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isatseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isatseq
            #add-point:ON ACTION controlp INFIELD isatseq name="construct.c.page4.isatseq"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat003
            #add-point:BEFORE FIELD isat003 name="construct.b.page4.isat003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat003
            
            #add-point:AFTER FIELD isat003 name="construct.a.page4.isat003"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat003
            #add-point:ON ACTION controlp INFIELD isat003 name="construct.c.page4.isat003"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat004
            #add-point:BEFORE FIELD isat004 name="construct.b.page4.isat004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat004
            
            #add-point:AFTER FIELD isat004 name="construct.a.page4.isat004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat004
            #add-point:ON ACTION controlp INFIELD isat004 name="construct.c.page4.isat004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat027
            #add-point:BEFORE FIELD isat027 name="construct.b.page4.isat027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat027
            
            #add-point:AFTER FIELD isat027 name="construct.a.page4.isat027"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat027
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat027
            #add-point:ON ACTION controlp INFIELD isat027 name="construct.c.page4.isat027"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat006
            #add-point:BEFORE FIELD isat006 name="construct.b.page4.isat006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat006
            
            #add-point:AFTER FIELD isat006 name="construct.a.page4.isat006"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat006
            #add-point:ON ACTION controlp INFIELD isat006 name="construct.c.page4.isat006"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat002
            #add-point:BEFORE FIELD isat002 name="construct.b.page4.isat002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat002
            
            #add-point:AFTER FIELD isat002 name="construct.a.page4.isat002"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat002
            #add-point:ON ACTION controlp INFIELD isat002 name="construct.c.page4.isat002"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat103
            #add-point:BEFORE FIELD isat103 name="construct.b.page4.isat103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat103
            
            #add-point:AFTER FIELD isat103 name="construct.a.page4.isat103"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat103
            #add-point:ON ACTION controlp INFIELD isat103 name="construct.c.page4.isat103"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat104
            #add-point:BEFORE FIELD isat104 name="construct.b.page4.isat104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat104
            
            #add-point:AFTER FIELD isat104 name="construct.a.page4.isat104"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat104
            #add-point:ON ACTION controlp INFIELD isat104 name="construct.c.page4.isat104"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat105
            #add-point:BEFORE FIELD isat105 name="construct.b.page4.isat105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat105
            
            #add-point:AFTER FIELD isat105 name="construct.a.page4.isat105"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat105
            #add-point:ON ACTION controlp INFIELD isat105 name="construct.c.page4.isat105"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat113
            #add-point:BEFORE FIELD isat113 name="construct.b.page4.isat113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat113
            
            #add-point:AFTER FIELD isat113 name="construct.a.page4.isat113"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat113
            #add-point:ON ACTION controlp INFIELD isat113 name="construct.c.page4.isat113"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat114
            #add-point:BEFORE FIELD isat114 name="construct.b.page4.isat114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat114
            
            #add-point:AFTER FIELD isat114 name="construct.a.page4.isat114"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat114
            #add-point:ON ACTION controlp INFIELD isat114 name="construct.c.page4.isat114"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat115
            #add-point:BEFORE FIELD isat115 name="construct.b.page4.isat115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat115
            
            #add-point:AFTER FIELD isat115 name="construct.a.page4.isat115"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat115
            #add-point:ON ACTION controlp INFIELD isat115 name="construct.c.page4.isat115"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat007
            #add-point:BEFORE FIELD isat007 name="construct.b.page4.isat007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat007
            
            #add-point:AFTER FIELD isat007 name="construct.a.page4.isat007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat007
            #add-point:ON ACTION controlp INFIELD isat007 name="construct.c.page4.isat007"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat014
            #add-point:BEFORE FIELD isat014 name="construct.b.page4.isat014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat014
            
            #add-point:AFTER FIELD isat014 name="construct.a.page4.isat014"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat014
            #add-point:ON ACTION controlp INFIELD isat014 name="construct.c.page4.isat014"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat106
            #add-point:BEFORE FIELD isat106 name="construct.b.page4.isat106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat106
            
            #add-point:AFTER FIELD isat106 name="construct.a.page4.isat106"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat106
            #add-point:ON ACTION controlp INFIELD isat106 name="construct.c.page4.isat106"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat107
            #add-point:BEFORE FIELD isat107 name="construct.b.page4.isat107"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat107
            
            #add-point:AFTER FIELD isat107 name="construct.a.page4.isat107"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat107
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat107
            #add-point:ON ACTION controlp INFIELD isat107 name="construct.c.page4.isat107"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat017
            #add-point:BEFORE FIELD isat017 name="construct.b.page4.isat017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat017
            
            #add-point:AFTER FIELD isat017 name="construct.a.page4.isat017"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.isat017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat017
            #add-point:ON ACTION controlp INFIELD isat017 name="construct.c.page4.isat017"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
 
 
      
 
      
      #add-point:cs段add_cs(本段內只能出現新的CONSTRUCT指令) name="cs.add_cs"
 
      #end add-point
 
      BEFORE DIALOG
         CALL cl_qbe_init()
         #add-point:cs段b_dialog name="cs.b_dialog"
         #160826-00017#1   add---s
         #LET g_aw = g_curr_diag.getCurrentItem()
         #LET l_ac = 1
         #IF g_aw = 's_detail2' THEN
         #   LET g_isag2_d[l_ac].isahseq = ''
         #   DISPLAY ARRAY g_isag2_d TO s_detail2.*
         #      BEFORE DISPLAY
         #      EXIT DISPLAY
         #   END DISPLAY
         #END IF
         # 
         #IF g_aw = 's_detail3' THEN
         #   LET g_isag3_d[l_ac].xrcdseq = ''
         #   DISPLAY ARRAY g_isag3_d TO s_detail3.*
         #      BEFORE DISPLAY
         #      EXIT DISPLAY
         #   END DISPLAY
         #END IF
         #160826-00017#1   add---e
         #end add-point  
 
      #查詢方案列表
      ON ACTION qbe_select
         LET ls_wc = ""
         CALL cl_qbe_list("c") RETURNING ls_wc
         IF NOT cl_null(ls_wc) THEN
            CALL util.JSON.parse(ls_wc, la_wc)
            INITIALIZE g_wc, g_wc2, g_wc2_table1, g_wc2_extend TO NULL
            INITIALIZE g_wc2_table2 TO NULL
 
            INITIALIZE g_wc2_table3 TO NULL
 
            INITIALIZE g_wc2_table4 TO NULL
 
 
            FOR li_idx = 1 TO la_wc.getLength()
               CASE
                  WHEN la_wc[li_idx].tableid = "isaf_t" 
                     LET g_wc = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "isag_t" 
                     LET g_wc2_table1 = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "isah_t" 
                     LET g_wc2_table2 = la_wc[li_idx].wc
 
                  WHEN la_wc[li_idx].tableid = "xrcd_t" 
                     LET g_wc2_table3 = la_wc[li_idx].wc
 
                  WHEN la_wc[li_idx].tableid = "isat_t" 
                     LET g_wc2_table4 = la_wc[li_idx].wc
 
 
               END CASE
            END FOR
         END IF
    
      #條件儲存為方案
      ON ACTION qbe_save
         CALL cl_qbe_save()
 
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG
   
   #組合g_wc2
   LET g_wc2 = g_wc2_table1
   IF g_wc2_table2 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
   END IF
 
   IF g_wc2_table3 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
   END IF
 
   IF g_wc2_table4 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
   END IF
 
 
 
 
   
   #add-point:cs段結束前 name="cs.after_construct"
   #151231-00010#3-----s
   LET g_wc = g_wc CLIPPED," AND isaf003 IN (SELECT pmaa001 FROM pmaa_t ",
                                            " WHERE pmaaent = ",g_enterprise," AND ",g_ctl_where,")"
   #151231-00010#3-----e
   
   #160907-00041#1 --s add
   IF cl_null(g_wc)THEN
      LET g_wc = " isafcomp IN ",g_wc_cs_comp  
   ELSE
      LET g_wc = g_wc," AND isafcomp IN ",g_wc_cs_comp   
   END IF
   #160907-00041#1 --e add
   #161104-00046#3-----s
   IF cl_null(g_user_dept_wc)THEN
      LET g_user_dept_wc = ' 1=1'
   END IF
   IF g_user_dept_wc <>  " 1=1" THEN
      LET g_wc = g_wc ," AND ", g_user_dept_wc CLIPPED
   END IF   
   #161104-00046#3-----e
   #end add-point    
 
   IF INT_FLAG THEN
      RETURN
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.query" >}
#+ 資料查詢QBE功能準備
PRIVATE FUNCTION aist310_query()
   #add-point:query段define(客製用) name="query.define_customerization"
   
   #end add-point   
   DEFINE ls_wc STRING
   #add-point:query段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="query.define"
   
   #end add-point   
   
   #add-point:Function前置處理  name="query.pre_function"
   
   #end add-point
   
   #切換畫面
   
   LET ls_wc = g_wc
   
   LET INT_FLAG = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""
   
   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()       
   CALL g_isag_d.clear()
   CALL g_isag2_d.clear()
   CALL g_isag3_d.clear()
   CALL g_isag4_d.clear()
 
   
   #add-point:query段other name="query.other"
 
   #end add-point   
   
   DISPLAY '' TO FORMONLY.idx
   DISPLAY '' TO FORMONLY.cnt
   DISPLAY '' TO FORMONLY.b_index
   DISPLAY '' TO FORMONLY.b_count
   DISPLAY '' TO FORMONLY.h_index
   DISPLAY '' TO FORMONLY.h_count
   
   CALL aist310_construct()
 
   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      #LET g_wc = ls_wc
      LET g_wc = " 1=2"
      CALL aist310_browser_fill("")
      CALL aist310_fetch("")
      RETURN
   END IF
   
   #儲存WC資訊
   CALL cl_dlg_save_user_latestqry("("||g_wc||") AND ("||g_wc2||")")
   
   #搜尋後資料初始化 
   LET g_detail_cnt  = 0
   LET g_current_idx = 1
   LET g_current_row = 0
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   LET g_detail_idx_list[1] = 1
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
   LET g_detail_idx_list[4] = 1
 
   LET g_error_show  = 1
   LET g_wc_filter   = ""
   LET l_ac = 1
   CALL FGL_SET_ARR_CURR(1)
   CALL aist310_browser_fill("F")
         
   IF g_browser_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "-100" 
      LET g_errparam.popup = TRUE 
      CALL cl_err()
   ELSE
      CALL aist310_fetch("F") 
      #顯示單身筆數
      CALL aist310_idx_chk()
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.fetch" >}
#+ 指定PK後抓取單頭其他資料
PRIVATE FUNCTION aist310_fetch(p_flag)
   #add-point:fetch段define(客製用) name="fetch.define_customerization"
   
   #end add-point    
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #add-point:fetch段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fetch.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="fetch.pre_function"
   
   #end add-point
   
   IF g_browser_cnt = 0 THEN
      RETURN
   END IF
 
   #清空第二階單身
 
   
   CALL cl_ap_performance_next_start()
   CASE p_flag
      WHEN 'F' 
         LET g_current_idx = 1
      WHEN 'L'  
         LET g_current_idx = g_browser.getLength()              
      WHEN 'P'
         IF g_current_idx > 1 THEN               
            LET g_current_idx = g_current_idx - 1
         END IF 
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF        
      WHEN '/'
         IF (NOT g_no_ask) THEN    
            CALL cl_set_act_visible("accept,cancel", TRUE)    
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0
 
            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl" 
            END PROMPT
 
            CALL cl_set_act_visible("accept,cancel", FALSE)    
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE  
            END IF           
         END IF
         
         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
             LET g_current_idx = g_jump
         END IF
         LET g_no_ask = FALSE  
   END CASE 
 
   
   LET g_current_row = g_current_idx
   LET g_detail_cnt = g_header_cnt                  
   
   #單身總筆數顯示
   IF g_detail_cnt > 0 THEN
      #若單身有資料時, idx至少為1
      IF g_detail_idx <= 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx  
   ELSE
      LET g_detail_idx = 0
      DISPLAY '' TO FORMONLY.idx    
   END IF
   
   #瀏覽頁筆數顯示
   LET g_pagestart = g_current_idx
   DISPLAY g_pagestart TO FORMONLY.b_index   #當下筆數
   DISPLAY g_pagestart TO FORMONLY.h_index   #當下筆數
   
   CALL cl_navigator_setting( g_pagestart, g_browser_cnt )
 
   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF
   
   #避免超出browser資料筆數上限
   IF g_current_idx > g_browser.getLength() THEN
      LET g_browser_idx = g_browser.getLength()
      LET g_current_idx = g_browser.getLength()
   END IF
   
   LET g_isaf_m.isafcomp = g_browser[g_current_idx].b_isafcomp
   LET g_isaf_m.isafdocno = g_browser[g_current_idx].b_isafdocno
 
   
   #重讀DB,因TEMP有不被更新特性
   EXECUTE aist310_master_referesh USING g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isaf_m.isafsite, 
       g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt,g_isaf_m.isaf056,g_isaf_m.isaf005, 
       g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf016, 
       g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009, 
       g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101, 
       g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024, 
       g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029, 
       g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104, 
       g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114, 
       g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120, 
       g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049, 
       g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf205, 
       g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039,g_isaf_m.isaf040,g_isaf_m.isaf041, 
       g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf050,g_isaf_m.isaf004, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059,g_isaf_m.isaf060,g_isaf_m.isaf061, 
       g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208,g_isaf_m.isaf209, 
       g_isaf_m.isaf210,g_isaf_m.isafownid,g_isaf_m.isafowndp,g_isaf_m.isafcrtid,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmoddt,g_isaf_m.isafcnfid,g_isaf_m.isafcnfdt, 
       g_isaf_m.isafsite_desc,g_isaf_m.isafcomp_desc,g_isaf_m.isaf005_desc,g_isaf_m.isaf057_desc,g_isaf_m.isaf003_desc, 
       g_isaf_m.isaf052_desc,g_isaf_m.isaf002_desc,g_isaf_m.isaf201_desc,g_isaf_m.isaf202_desc,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf037_desc,g_isaf_m.isaf041_desc,g_isaf_m.isaf055_desc,g_isaf_m.isaf006_desc,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf210_desc,g_isaf_m.isafownid_desc,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid_desc, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafmodid_desc,g_isaf_m.isafcnfid_desc
   
   #遮罩相關處理
   LET g_isaf_m_mask_o.* =  g_isaf_m.*
   CALL aist310_isaf_t_mask()
   LET g_isaf_m_mask_n.* =  g_isaf_m.*
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL aist310_set_act_visible()   
   CALL aist310_set_act_no_visible()
   
   #add-point:fetch段action控制 name="fetch.action_control"
   
   #end add-point  
   
   
   
   #add-point:fetch結束前 name="fetch.after"
   
   #end add-point
   
   #保存單頭舊值
   LET g_isaf_m_t.* = g_isaf_m.*
   LET g_isaf_m_o.* = g_isaf_m.*
   
   LET g_data_owner = g_isaf_m.isafownid      
   LET g_data_dept  = g_isaf_m.isafowndp
   
   #重新顯示   
   CALL aist310_show()
 
   #應用 a56 樣板自動產生(Version:3)
   #檢查此單據是否需顯示BPM簽核狀況按鈕 
   IF cl_bpm_chk() THEN
      CALL cl_set_act_visible("bpm_status",TRUE)
   ELSE
      CALL cl_set_act_visible("bpm_status",FALSE)
   END IF
 
 
 
 
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.insert" >}
#+ 資料新增
PRIVATE FUNCTION aist310_insert()
   #add-point:insert段define(客製用) name="insert.define_customerization"
   
   #end add-point    
   #add-point:insert段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert.define"
 
   #end add-point    
   
   #add-point:Function前置處理  name="insert.pre_function"
   
   #end add-point
   
   #清畫面欄位內容
   CLEAR FORM                    
   CALL g_isag_d.clear()   
   CALL g_isag2_d.clear()  
   CALL g_isag3_d.clear()  
   CALL g_isag4_d.clear()  
 
 
   INITIALIZE g_isaf_m.* TO NULL             #DEFAULT 設定
   
   LET g_isafcomp_t = NULL
   LET g_isafdocno_t = NULL
 
   
   LET g_master_insert = FALSE
   
   #add-point:insert段before name="insert.before"
   
   #end add-point    
   
   CALL s_transaction_begin()
   WHILE TRUE
      #公用欄位給值(單頭)
      #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_isaf_m.isafownid = g_user
      LET g_isaf_m.isafowndp = g_dept
      LET g_isaf_m.isafcrtid = g_user
      LET g_isaf_m.isafcrtdp = g_dept 
      LET g_isaf_m.isafcrtdt = cl_get_current()
      LET g_isaf_m.isafmodid = g_user
      LET g_isaf_m.isafmoddt = cl_get_current()
      LET g_isaf_m.isafstus = 'N'
 
 
 
 
      #append欄位給值
      
     
      #一般欄位給值
            LET g_isaf_m.isaf001 = "1"
      LET g_isaf_m.isaf056 = "1"
      LET g_isaf_m.isaf009 = "N"
      LET g_isaf_m.isaf205 = "N"
      LET g_isaf_m.l_isaf103_s = "0"
      LET g_isaf_m.l_isaf104_s = "0"
      LET g_isaf_m.l_isaf105_s = "0"
      LET g_isaf_m.l_isaf113_s = "0"
      LET g_isaf_m.l_isaf114_s = "0"
      LET g_isaf_m.l_isaf115_s = "0"
 
  
      #add-point:單頭預設值 name="insert.default"
      LET g_isaf_m_t.* = g_isaf_m.*
      #取得預設的帳務中心,因新增階段的時候,並不會知道site,所以以登入人員做為依據
      CALL s_fin_get_account_center('',g_user,'3',g_today) RETURNING g_sub_success,g_isaf_m.isafsite,g_errno 
      CALL cl_set_combo_scc_part('isaf056','9741','1') #交易發票  #160614-00025#1 add
      
      SELECT ooef017 INTO g_isaf_m.isafcomp 
        FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = g_isaf_m.isafsite
  
      CALL cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-2013') RETURNING g_para_data
      #161024-00065#2 add ------
      #取得aoos020的參數S-FIN-2023(流通門店銷售立帳方式)
      CALL cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-2023') RETURNING g_sfin2023
      #161024-00065#2 add end---
      
      SELECT ooef016 INTO g_isaf_m.isaf100 FROM ooef_t
       WHERE ooefent = g_enterprise AND ooef001 = g_isaf_m.isafcomp
      CALL cl_set_comp_visible('bpage_1',TRUE)
      LET g_isaf_m_t.* = g_isaf_m.*
      LET g_isaf_m.isafstus = "N"
      CALL gfrm_curr.setElementImage("statechange", "stus/32/open.png")
      LET g_isaf_m.isafdocdt = g_today
      LET g_isaf_m.isaf014 = g_today
      LET g_isaf_m.isaf005 = g_user
      LET g_isaf_m.isaf106 = 0
      LET g_isaf_m.isaf107 = 0
      LET g_isaf_m.isaf108 = 0
      LET g_isaf_m.isaf116 = 0
      LET g_isaf_m.isaf117 = 0
      LET g_isaf_m.isaf118 = 0
      LET g_isaf_m.isaf039 = g_today
      LET g_isaf_m.isaf040 = cl_get_time()
      LET g_isaf_m.isaf041 = g_user 
      LET g_isaf_m.isaf044 = 0
      LET g_isaf_m.isaf050 = '0'
      LET g_isaf_m.isaf052 = g_isaf_m.isafcomp
      LET g_isaf_m.isaf006 = g_site
      CALL aist310_ref_show()
      CALL aist310_isafcomp_get()
      CALL aist310_isaf100_get()
      CALL cl_set_comp_visible("isag013,isag014,isah008,isah009",FALSE)
      CALL aist310_visible()
      #end add-point 
      
      #保存單頭舊值(用於資料輸入錯誤還原預設值時使用)
      LET g_isaf_m_t.* = g_isaf_m.*
      LET g_isaf_m_o.* = g_isaf_m.*
      
      #顯示狀態(stus)圖片
            #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_isaf_m.isafstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         
      END CASE
 
 
 
    
      CALL aist310_input("a")
      
      #add-point:單頭輸入後 name="insert.after_insert"
      
      #end add-point
      
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code = 9001 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
      END IF
      
      IF NOT g_master_insert THEN
         DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
         DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
         INITIALIZE g_isaf_m.* TO NULL
         INITIALIZE g_isag_d TO NULL
         INITIALIZE g_isag2_d TO NULL
         INITIALIZE g_isag3_d TO NULL
         INITIALIZE g_isag4_d TO NULL
 
         #add-point:取消新增後 name="insert.cancel"
         
         #end add-point 
         CALL aist310_show()
         RETURN
      END IF
      
      LET INT_FLAG = 0
      #CALL g_isag_d.clear()
      #CALL g_isag2_d.clear()
      #CALL g_isag3_d.clear()
      #CALL g_isag4_d.clear()
 
 
      LET g_rec_b = 0
      CALL s_transaction_end('Y','0')
      EXIT WHILE
        
   END WHILE
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL aist310_set_act_visible()   
   CALL aist310_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_isafcomp_t = g_isaf_m.isafcomp
   LET g_isafdocno_t = g_isaf_m.isafdocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " isafent = " ||g_enterprise|| " AND",
                      " isafcomp = '", g_isaf_m.isafcomp, "' "
                      ," AND isafdocno = '", g_isaf_m.isafdocno, "' "
 
                      
   #add-point:組合新增資料的條件後 name="insert.after.add_browse"
   
   #end add-point
      
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL aist310_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   CLOSE aist310_cl
   
   CALL aist310_idx_chk()
   
   #撈取異動後的資料(主要是帶出reference)
   EXECUTE aist310_master_referesh USING g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isaf_m.isafsite, 
       g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt,g_isaf_m.isaf056,g_isaf_m.isaf005, 
       g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf016, 
       g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009, 
       g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101, 
       g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024, 
       g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029, 
       g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104, 
       g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114, 
       g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120, 
       g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049, 
       g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf205, 
       g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039,g_isaf_m.isaf040,g_isaf_m.isaf041, 
       g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf050,g_isaf_m.isaf004, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059,g_isaf_m.isaf060,g_isaf_m.isaf061, 
       g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208,g_isaf_m.isaf209, 
       g_isaf_m.isaf210,g_isaf_m.isafownid,g_isaf_m.isafowndp,g_isaf_m.isafcrtid,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmoddt,g_isaf_m.isafcnfid,g_isaf_m.isafcnfdt, 
       g_isaf_m.isafsite_desc,g_isaf_m.isafcomp_desc,g_isaf_m.isaf005_desc,g_isaf_m.isaf057_desc,g_isaf_m.isaf003_desc, 
       g_isaf_m.isaf052_desc,g_isaf_m.isaf002_desc,g_isaf_m.isaf201_desc,g_isaf_m.isaf202_desc,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf037_desc,g_isaf_m.isaf041_desc,g_isaf_m.isaf055_desc,g_isaf_m.isaf006_desc,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf210_desc,g_isaf_m.isafownid_desc,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid_desc, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafmodid_desc,g_isaf_m.isafcnfid_desc
   
   
   #遮罩相關處理
   LET g_isaf_m_mask_o.* =  g_isaf_m.*
   CALL aist310_isaf_t_mask()
   LET g_isaf_m_mask_n.* =  g_isaf_m.*
   
   #將資料顯示到畫面上
   DISPLAY BY NAME g_isaf_m.isafsite,g_isaf_m.isafsite_desc,g_isaf_m.isafdocno,g_isaf_m.isafdocno_desc, 
       g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafcomp_desc,g_isaf_m.isafdocdt,g_isaf_m.isaf056, 
       g_isaf_m.isaf005,g_isaf_m.isaf005_desc,g_isaf_m.isaf057,g_isaf_m.isaf057_desc,g_isaf_m.isaf003, 
       g_isaf_m.isaf003_desc,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf008_desc, 
       g_isaf_m.isaf016,g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf016_desc,g_isaf_m.isaf052,g_isaf_m.isaf052_desc, 
       g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009,g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012, 
       g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101,g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf002_desc, 
       g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024,g_isaf_m.isaf025,g_isaf_m.isaf026, 
       g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031, 
       g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104,g_isaf_m.isaf105,g_isaf_m.isaf106, 
       g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114,g_isaf_m.isaf115,g_isaf_m.isaf116, 
       g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120,g_isaf_m.isaf121,g_isaf_m.isaf033, 
       g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049,g_isaf_m.isaf201,g_isaf_m.isaf201_desc, 
       g_isaf_m.isaf202,g_isaf_m.isaf202_desc,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf205,g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf037_desc,g_isaf_m.isaf038,g_isaf_m.isaf039, 
       g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf041_desc,g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf055_desc, 
       g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf006_desc,g_isaf_m.isaf050,g_isaf_m.isaf004,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf019_desc,g_isaf_m.isaf059,g_isaf_m.isaf060, 
       g_isaf_m.isaf061,g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208, 
       g_isaf_m.isaf209,g_isaf_m.isaf210,g_isaf_m.isaf210_desc,g_isaf_m.isafownid,g_isaf_m.isafownid_desc, 
       g_isaf_m.isafowndp,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid,g_isaf_m.isafcrtid_desc,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmodid_desc,g_isaf_m.isafmoddt, 
       g_isaf_m.isafcnfid,g_isaf_m.isafcnfid_desc,g_isaf_m.isafcnfdt,g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s, 
       g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
   
   #add-point:新增結束後 name="insert.after"
   
   #end add-point 
   
   LET g_data_owner = g_isaf_m.isafownid      
   LET g_data_dept  = g_isaf_m.isafowndp
   
   #功能已完成,通報訊息中心
   CALL aist310_msgcentre_notify('insert')
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.modify" >}
#+ 資料修改
PRIVATE FUNCTION aist310_modify()
   #add-point:modify段define(客製用) name="modify.define_customerization"
   
   #end add-point    
   DEFINE l_new_key    DYNAMIC ARRAY OF STRING
   DEFINE l_old_key    DYNAMIC ARRAY OF STRING
   DEFINE l_field_key  DYNAMIC ARRAY OF STRING
   DEFINE l_wc2_table1          STRING
   DEFINE l_wc2_table2   STRING
 
   DEFINE l_wc2_table3   STRING
 
   DEFINE l_wc2_table4   STRING
 
 
 
   #add-point:modify段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="modify.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="modify.pre_function"
   
   #end add-point
   
   #保存單頭舊值
   LET g_isaf_m_t.* = g_isaf_m.*
   LET g_isaf_m_o.* = g_isaf_m.*
   
   IF g_isaf_m.isafcomp IS NULL
   OR g_isaf_m.isafdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   ERROR ""
  
   LET g_isafcomp_t = g_isaf_m.isafcomp
   LET g_isafdocno_t = g_isaf_m.isafdocno
 
   CALL s_transaction_begin()
   
   OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
   IF SQLCA.SQLCODE THEN   #(ver:78)
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN aist310_cl:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
      LET g_errparam.popup = TRUE 
      CLOSE aist310_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE aist310_master_referesh USING g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isaf_m.isafsite, 
       g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt,g_isaf_m.isaf056,g_isaf_m.isaf005, 
       g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf016, 
       g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009, 
       g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101, 
       g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024, 
       g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029, 
       g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104, 
       g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114, 
       g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120, 
       g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049, 
       g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf205, 
       g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039,g_isaf_m.isaf040,g_isaf_m.isaf041, 
       g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf050,g_isaf_m.isaf004, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059,g_isaf_m.isaf060,g_isaf_m.isaf061, 
       g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208,g_isaf_m.isaf209, 
       g_isaf_m.isaf210,g_isaf_m.isafownid,g_isaf_m.isafowndp,g_isaf_m.isafcrtid,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmoddt,g_isaf_m.isafcnfid,g_isaf_m.isafcnfdt, 
       g_isaf_m.isafsite_desc,g_isaf_m.isafcomp_desc,g_isaf_m.isaf005_desc,g_isaf_m.isaf057_desc,g_isaf_m.isaf003_desc, 
       g_isaf_m.isaf052_desc,g_isaf_m.isaf002_desc,g_isaf_m.isaf201_desc,g_isaf_m.isaf202_desc,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf037_desc,g_isaf_m.isaf041_desc,g_isaf_m.isaf055_desc,g_isaf_m.isaf006_desc,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf210_desc,g_isaf_m.isafownid_desc,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid_desc, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafmodid_desc,g_isaf_m.isafcnfid_desc
   
   #檢查是否允許此動作
   IF NOT aist310_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_isaf_m_mask_o.* =  g_isaf_m.*
   CALL aist310_isaf_t_mask()
   LET g_isaf_m_mask_n.* =  g_isaf_m.*
   
   
   
   #add-point:modify段show之前 name="modify.before_show"
   
   #end add-point  
   
   #LET l_wc2_table1 = g_wc2_table1
   #LET g_wc2_table1 = " 1=1"
   #LET l_wc2_table2 = g_wc2_table2
   #LET l_wc2_table2 = " 1=1"
 
   #LET l_wc2_table3 = g_wc2_table3
   #LET l_wc2_table3 = " 1=1"
 
   #LET l_wc2_table4 = g_wc2_table4
   #LET l_wc2_table4 = " 1=1"
 
 
 
   
   CALL aist310_show()
   #add-point:modify段show之後 name="modify.after_show"
   #20150309--add--str--
   IF g_isaf_m.isafstus <> 'N' THEN 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00313'
      LET g_errparam.extend = g_isaf_m.isafdocno
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN
   END IF
   #20150309--add--end--
   #end add-point
   
   #LET g_wc2_table1 = l_wc2_table1
   #LET  g_wc2_table2 = l_wc2_table2 
 
   #LET  g_wc2_table3 = l_wc2_table3 
 
   #LET  g_wc2_table4 = l_wc2_table4 
 
 
 
    
   WHILE TRUE
      LET g_isafcomp_t = g_isaf_m.isafcomp
      LET g_isafdocno_t = g_isaf_m.isafdocno
 
      
      #寫入修改者/修改日期資訊(單頭)
      LET g_isaf_m.isafmodid = g_user 
LET g_isaf_m.isafmoddt = cl_get_current()
LET g_isaf_m.isafmodid_desc = cl_get_username(g_isaf_m.isafmodid)
      
      #add-point:modify段修改前 name="modify.before_input"
      
      #end add-point
      
      #欄位更改
      LET g_loc = 'n'
      LET g_update = FALSE
      LET g_master_commit = "N"
      CALL aist310_input("u")
      LET g_loc = 'n'
 
      #add-point:modify段修改後 name="modify.after_input"
      
      #end add-point
      
      IF g_update OR NOT INT_FLAG THEN
         #若有modid跟moddt則進行update
         UPDATE isaf_t SET (isafmodid,isafmoddt) = (g_isaf_m.isafmodid,g_isaf_m.isafmoddt)
          WHERE isafent = g_enterprise AND isafcomp = g_isafcomp_t
            AND isafdocno = g_isafdocno_t
 
      END IF
    
      IF INT_FLAG THEN
         CALL s_transaction_end('N','0')
         LET INT_FLAG = 0
         #若單頭無commit則還原
         IF g_master_commit = "N" THEN
            LET g_isaf_m.* = g_isaf_m_t.*
            CALL aist310_show()
         END IF
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code = 9001 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN
      END IF 
                  
      #若單頭key欄位有變更
      IF g_isaf_m.isafcomp != g_isaf_m_t.isafcomp
      OR g_isaf_m.isafdocno != g_isaf_m_t.isafdocno
 
      THEN
         CALL s_transaction_begin()
         
         #add-point:單身fk修改前 name="modify.body.b_fk_update"
         
         #end add-point
         
         #更新單身key值
         UPDATE isag_t SET isagcomp = g_isaf_m.isafcomp
                                       ,isagdocno = g_isaf_m.isafdocno
 
          WHERE isagent = g_enterprise AND isagcomp = g_isaf_m_t.isafcomp
            AND isagdocno = g_isaf_m_t.isafdocno
 
            
         #add-point:單身fk修改中 name="modify.body.m_fk_update"
         
         #end add-point
 
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "isag_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isag_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         
         #add-point:單身fk修改後 name="modify.body.a_fk_update"
         
         #end add-point
         
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update2"
         
         #end add-point
         
         UPDATE isah_t
            SET isahcomp = g_isaf_m.isafcomp
               ,isahdocno = g_isaf_m.isafdocno
 
          WHERE isahent = g_enterprise AND
                isahcomp = g_isafcomp_t
            AND isahdocno = g_isafdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update2"
         
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "isah_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update2"
         
         #end add-point
 
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update3"
         
         #end add-point
         
         UPDATE xrcd_t
            SET xrcdcomp = g_isaf_m.isafcomp
               ,xrcddocno = g_isaf_m.isafdocno
 
          WHERE xrcdent = g_enterprise AND
                xrcdcomp = g_isafcomp_t
            AND xrcddocno = g_isafdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update3"
         
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "xrcd_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update3"
         
         #end add-point
 
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update4"
         
         #end add-point
         
         UPDATE isat_t
            SET isatcomp = g_isaf_m.isafcomp
               ,isatdocno = g_isaf_m.isafdocno
 
          WHERE isatent = g_enterprise AND
                isatcomp = g_isafcomp_t
            AND isatdocno = g_isafdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update4"
         
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "isat_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update4"
         
         #end add-point
 
 
         
 
         
         #UPDATE 多語言table key值
         
         
         
         
 
         CALL s_transaction_end('Y','0')
      END IF
    
      EXIT WHILE
   END WHILE
 
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL aist310_set_act_visible()   
   CALL aist310_set_act_no_visible()
 
   #組合新增資料的條件
   LET g_add_browse = " isafent = " ||g_enterprise|| " AND",
                      " isafcomp = '", g_isaf_m.isafcomp, "' "
                      ," AND isafdocno = '", g_isaf_m.isafdocno, "' "
 
   #填到對應位置
   CALL aist310_browser_fill("")
 
   CLOSE aist310_cl
   
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL aist310_msgcentre_notify('modify')
 
END FUNCTION 
 
{</section>}
 
{<section id="aist310.input" >}
#+ 資料輸入
PRIVATE FUNCTION aist310_input(p_cmd)
   #add-point:input段define(客製用) name="input.define_customerization"
   
   #end add-point  
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_n                   LIKE type_t.num10                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num10                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num10
   DEFINE  l_i                   LIKE type_t.num10
   DEFINE  l_ac_t                LIKE type_t.num10
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num10
   DEFINE  li_reproduce_target   LIKE type_t.num10
   DEFINE  ls_keys               DYNAMIC ARRAY OF VARCHAR(500)
   #add-point:input段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="input.define"
   DEFINE  l_ooef004             LIKE ooef_t.ooef004
   DEFINE  l_success             LIKE type_t.num5
   DEFINE  l_isac006             LIKE isac_t.isac006
   DEFINE  l_isag004             LIKE isag_t.isag004
   DEFINE  l_xrcb030             LIKE xrcb_t.xrcb030
   DEFINE  l_isae002             LIKE isae_t.isae002
   DEFINE  l_isae003             LIKE isae_t.isae003
   DEFINE  l_isae008             LIKE isae_t.isae008
   DEFINE  l_isae012             LIKE isae_t.isae012
   DEFINE  r_xrcd123             LIKE xrcd_t.xrcd113
   DEFINE  r_xrcd124             LIKE xrcd_t.xrcd114
   DEFINE  r_xrcd125             LIKE xrcd_t.xrcd115
   DEFINE  r_xrcd133             LIKE xrcd_t.xrcd113
   DEFINE  r_xrcd134             LIKE xrcd_t.xrcd114
   DEFINE  r_xrcd135             LIKE xrcd_t.xrcd115
   DEFINE  l_origin_str          STRING   #組織範圍
   DEFINE  l_isag115_sum         LIKE isag_t.isag115
   DEFINE  l_glaa024             LIKE glaa_t.glaa024
   DEFINE  l_isaf011             LIKE isaf_t.isaf011
   DEFINE  l_isae007             LIKE isae_t.isae007
   DEFINE  l_isae016             LIKE isae_t.isae016   #150911    
   DEFINE  l_isae017             LIKE isae_t.isae017   #150911   
   #160111-00020#2-----s
  #DEFINE  l_isai008             LIKE isai_t.isai008   #160803-00044#1 mark
  #DEFINE  l_ooef019             LIKE ooef_t.ooef019   #160803-00044#1 mark
   DEFINE  l_isatcnt             LIKE type_t.num10
   #160111-00020#2-----e
   #150518-00046#4--s
   DEFINE l_rmba008          LIKE rmba_t.rmba008
   DEFINE l_rmdb016          LIKE rmdb_t.rmdb016
   DEFINE l_rmdb017          LIKE rmdb_t.rmdb017
   DEFINE r_xrcd103          LIKE xrcd_t.xrcd113
   DEFINE r_xrcd104          LIKE xrcd_t.xrcd114
   DEFINE r_xrcd105          LIKE xrcd_t.xrcd115
   DEFINE l_isag105          LIKE isag_t.isag105   
   #150518-00046#4--e 
   #160316-00017#2--add--str--lujh   
   DEFINE l_isag011          LIKE isag_t.isag011
   DEFINE l_flag             LIKE type_t.chr1
   DEFINE l_isag_flag        LIKE type_t.chr1
   DEFINE l_oodb005          LIKE oodb_t.oodb005
   #160316-00017#2--add--end--lujh
   DEFINE l_sfin2022         LIKE type_t.chr10    #160426-00013#2
   #160614-00025#1 --s add
   DEFINE l_sql           STRING
   DEFINE l_isag001       LIKE isag_t.isag001
   DEFINE l_isag002       LIKE isag_t.isag002
   #160614-00025#2 mark ------
   #DEFINE l_rtia014       LIKE rtia_t.rtia014
   #DEFINE l_rtia015       LIKE rtia_t.rtia015
   #160614-00025#2 mark end---
   DEFINE l_isat004       LIKE isat_t.isat004
   DEFINE l_date          DATETIME YEAR TO SECOND
   #160614-00025#1 --e ad
   DEFINE l_cnt_comp      LIKE type_t.num10        #160907-00041#1 add
   DEFINE l_pmaa004     LIKE pmaa_t.pmaa004   #160802-00007#1 Add
   DEFINE l_isac_cnt      LIKE type_t.num10   #161125-00028#1
   DEFINE l_ooef011       LIKE ooef_t.ooef011 #161129-00042#1-add
   DEFINE l_flag1         LIKE type_t.num5    #161104-00046#3 單別預設值用
   DEFINE l_slip          LIKE ooba_t.ooba002 #161104-00046#3
   #end add-point  
   
   #add-point:Function前置處理  name="input.pre_function"
   
   #end add-point
   
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF   
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_isaf_m.isafsite,g_isaf_m.isafsite_desc,g_isaf_m.isafdocno,g_isaf_m.isafdocno_desc, 
       g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafcomp_desc,g_isaf_m.isafdocdt,g_isaf_m.isaf056, 
       g_isaf_m.isaf005,g_isaf_m.isaf005_desc,g_isaf_m.isaf057,g_isaf_m.isaf057_desc,g_isaf_m.isaf003, 
       g_isaf_m.isaf003_desc,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf008_desc, 
       g_isaf_m.isaf016,g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf016_desc,g_isaf_m.isaf052,g_isaf_m.isaf052_desc, 
       g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009,g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012, 
       g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101,g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf002_desc, 
       g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024,g_isaf_m.isaf025,g_isaf_m.isaf026, 
       g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031, 
       g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104,g_isaf_m.isaf105,g_isaf_m.isaf106, 
       g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114,g_isaf_m.isaf115,g_isaf_m.isaf116, 
       g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120,g_isaf_m.isaf121,g_isaf_m.isaf033, 
       g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049,g_isaf_m.isaf201,g_isaf_m.isaf201_desc, 
       g_isaf_m.isaf202,g_isaf_m.isaf202_desc,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf205,g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf037_desc,g_isaf_m.isaf038,g_isaf_m.isaf039, 
       g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf041_desc,g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf055_desc, 
       g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf006_desc,g_isaf_m.isaf050,g_isaf_m.isaf004,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf019_desc,g_isaf_m.isaf059,g_isaf_m.isaf060, 
       g_isaf_m.isaf061,g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208, 
       g_isaf_m.isaf209,g_isaf_m.isaf210,g_isaf_m.isaf210_desc,g_isaf_m.isafownid,g_isaf_m.isafownid_desc, 
       g_isaf_m.isafowndp,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid,g_isaf_m.isafcrtid_desc,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmodid_desc,g_isaf_m.isafmoddt, 
       g_isaf_m.isafcnfid,g_isaf_m.isafcnfid_desc,g_isaf_m.isafcnfdt,g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s, 
       g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
   
   #切換畫面
 
   CALL cl_set_head_visible("","YES")  
 
   LET l_insert = FALSE
   LET g_action_choice = ""
 
   #add-point:input段define_sql name="input.define_sql"
   
   #end add-point 
   LET g_forupd_sql = "SELECT isagseq,isagorga,isag001,isag002,isag003,isag018,isag009,isag010,isag016, 
       isag017,isag015,isag006,isag008,isag012,isag004,isag005,isag101,isag103,isag104,isag105,isag113, 
       isag114,isag115,isag116,isag117,isag013,isag014,isag011 FROM isag_t WHERE isagent=? AND isagcomp=?  
       AND isagdocno=? AND isagseq=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql"
   
   #end add-point 
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aist310_bcl CURSOR FROM g_forupd_sql
   
   #add-point:input段define_sql name="input.define_sql2"
   
   #end add-point    
   LET g_forupd_sql = "SELECT isahseq,isahorga,isah003,isah004,isah013,isah005,isah010,isah006,isah101, 
       isah103,isah007,isah104,isah105,isah113,isah114,isah115,isah001,isah002,isah008,isah009,isah011, 
       isah106,isah012,isah116 FROM isah_t WHERE isahent=? AND isahcomp=? AND isahdocno=? AND isahseq=?  
       FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql2"
   
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aist310_bcl2 CURSOR FROM g_forupd_sql
 
   #add-point:input段define_sql name="input.define_sql3"
   
   #end add-point    
   LET g_forupd_sql = "SELECT xrcdld,xrcdseq2,xrcdseq,xrcd007,xrcd002,xrcd003,xrcd006,xrcd005,xrcd104, 
       xrcd103,xrcd105,xrcd114 FROM xrcd_t WHERE xrcdent=? AND xrcdcomp=? AND xrcddocno=? AND xrcdld=?  
       AND xrcdseq=? AND xrcdseq2=? AND xrcd007=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql3"
   
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aist310_bcl3 CURSOR FROM g_forupd_sql
 
   #add-point:input段define_sql name="input.define_sql4"
   
   #end add-point    
   LET g_forupd_sql = "SELECT isatseq,isat003,isat004,isat027,isat006,isat002,isat103,isat104,isat105, 
       isat113,isat114,isat115,isat007,isat014,isat106,isat107,isat017,isatsite,isatdocdt FROM isat_t  
       WHERE isatent=? AND isatcomp=? AND isatdocno=? AND isatseq=? AND isat003=? AND isat004=? FOR  
       UPDATE"
   #add-point:input段define_sql name="input.after_define_sql4"
   
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aist310_bcl4 CURSOR FROM g_forupd_sql
 
 
   
 
 
   #add-point:input段define_sql name="input.other_sql"
   
   #end add-point 
 
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'
   
   #控制key欄位可否輸入
   CALL aist310_set_entry(p_cmd)
   #add-point:set_entry後 name="input.after_set_entry"
   LET g_errshow = 1 
   #end add-point
   CALL aist310_set_no_entry(p_cmd)
 
   DISPLAY BY NAME g_isaf_m.isafsite,g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt, 
       g_isaf_m.isaf056,g_isaf_m.isaf005,g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus, 
       g_isaf_m.isaf008,g_isaf_m.isaf016,g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018, 
       g_isaf_m.isaf051,g_isaf_m.isaf009,g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100, 
       g_isaf_m.isaf011,g_isaf_m.isaf101,g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022, 
       g_isaf_m.isaf023,g_isaf_m.isaf024,g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027, 
       g_isaf_m.isaf028,g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046, 
       g_isaf_m.isaf103,g_isaf_m.isaf104,g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108, 
       g_isaf_m.isaf113,g_isaf_m.isaf114,g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118, 
       g_isaf_m.isaf119,g_isaf_m.isaf120,g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035, 
       g_isaf_m.isaf048,g_isaf_m.isaf049,g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204, 
       g_isaf_m.isaf207,g_isaf_m.isaf205,g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039, 
       g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006, 
       g_isaf_m.isaf050,g_isaf_m.isaf004,g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059, 
       g_isaf_m.isaf060,g_isaf_m.isaf061,g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065, 
       g_isaf_m.isaf208,g_isaf_m.isaf209,g_isaf_m.isaf210
   
   LET lb_reproduce = FALSE
   LET l_ac_t = 1
   
   #關閉被遮罩相關欄位輸入, 無法確定USER是否會需要輸入此欄位
   #因此先行關閉, 若有需要可於下方add-point中自行開啟
   CALL cl_mask_set_no_entry()
   
   #add-point:資料輸入前 name="input.before_input"
   #CALL cl_showmsg_init()
   #CALL cl_err_collect_init()
   #160316-00017#2--add--str--lujh
   LET l_isag_flag = 'N'
   WHILE TRUE   
      LET l_flag = 'N'      
   #160316-00017#2--add--end--lujh
   #end add-point
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
{</section>}
 
{<section id="aist310.input.head" >}
      #單頭段
      INPUT BY NAME g_isaf_m.isafsite,g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt, 
          g_isaf_m.isaf056,g_isaf_m.isaf005,g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus, 
          g_isaf_m.isaf008,g_isaf_m.isaf016,g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018, 
          g_isaf_m.isaf051,g_isaf_m.isaf009,g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100, 
          g_isaf_m.isaf011,g_isaf_m.isaf101,g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022, 
          g_isaf_m.isaf023,g_isaf_m.isaf024,g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027, 
          g_isaf_m.isaf028,g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046, 
          g_isaf_m.isaf103,g_isaf_m.isaf104,g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108, 
          g_isaf_m.isaf113,g_isaf_m.isaf114,g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118, 
          g_isaf_m.isaf119,g_isaf_m.isaf120,g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035, 
          g_isaf_m.isaf048,g_isaf_m.isaf049,g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204, 
          g_isaf_m.isaf207,g_isaf_m.isaf205,g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039, 
          g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006, 
          g_isaf_m.isaf050,g_isaf_m.isaf004,g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059, 
          g_isaf_m.isaf060,g_isaf_m.isaf061,g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065, 
          g_isaf_m.isaf208,g_isaf_m.isaf209,g_isaf_m.isaf210 
         ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂ACTION(master_input)
         
     
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist310_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE aist310_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            IF l_cmd_t = 'r' THEN
               
            END IF
            #因應離開單頭後已寫入資料庫, 若重新回到單頭則視為修改
            #因此需於此處開啟/關閉欄位
            CALL aist310_set_entry(p_cmd)
            #add-point:資料輸入前 name="input.m.before_input"
            #160316-00017#2--add--str--lujh
            CALL aist310_set_no_entry(p_cmd)
            IF l_isag_flag = 'Y' THEN 
               LET l_isag_flag = 'N'
               NEXT FIELD isagorga
            END IF
            #160316-00017#2--add--end--lujh
            #end add-point
            CALL aist310_set_no_entry(p_cmd)
    
                  #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafsite
            
            #add-point:AFTER FIELD isafsite name="input.a.isafsite"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isafsite) THEN
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isaf_m.isafsite != g_isaf_m_t.isafsite OR g_isaf_m_t.isafsite IS NULL )) THEN #160822-00008#8 Mark
               IF g_isaf_m.isafsite != g_isaf_m_o.isafsite OR cl_null(g_isaf_m_o.isafsite) THEN #160822-00008#8
                  CALL s_fin_account_center_sons_query('3',g_isaf_m.isafsite,g_today,'1')
                  CALL s_fin_account_center_chk(g_isaf_m.isafsite,'','3',g_isaf_m.isafdocdt)
                  RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     #LET g_isaf_m.isafsite = g_isaf_m_t.isafsite #160822-00008#8 Mark
                     #LET g_isaf_m.isafcomp = g_isaf_m_t.isafcomp #160822-00008#8 Mark
                     LET g_isaf_m.isafsite = g_isaf_m_o.isafsite  #160822-00008#8
                     LET g_isaf_m.isafcomp = g_isaf_m_o.isafcomp  #160822-00008#8
                     CALL aist310_ref_show()
                     NEXT FIELD CURRENT
                  END IF

                  #IF g_isaf_m.isafsite != g_isaf_m_t.isafsite OR cl_null(g_isaf_m_t.isafsite) THEN #160822-00008#8 Mark
                  IF g_isaf_m.isafsite != g_isaf_m_o.isafsite OR cl_null(g_isaf_m_o.isafsite) THEN #160822-00008#8
                     LET g_isaf_m.isafcomp = '' #160822-00008#8
                     LET g_glaald          = '' #160822-00008#8
                     CALL s_fin_orga_get_comp_ld(g_isaf_m.isafsite) RETURNING l_success,g_errno,g_isaf_m.isafcomp,g_glaald
                     LET g_isaf_m.isaf029 = '' #160822-00008#8 
                     LET g_isaf_m.isaf030 = '' #160822-00008#8
                     LET g_isaf_m.isaf031 = '' #160822-00008#8
                     LET g_isaf_m.isaf032 = '' #160822-00008#8
                     LET g_isaf_m.isaf046 = '' #160822-00008#8                   
                     CALL aist310_isafcomp_get()
                     CALL aist310_ref_show()
                     IF NOT g_sub_success THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        #LET g_isaf_m.isafsite = g_isaf_m_t.isafsite #160822-00008#8 Mark
                        #LET g_isaf_m.isafcomp = g_isaf_m_t.isafcomp #160822-00008#8 Mark
                        LET g_isaf_m.isafsite = g_isaf_m_o.isafsite  #160822-00008#8
                        LET g_isaf_m.isafcomp = g_isaf_m_o.isafcomp  #160822-00008#8
                        LET g_isaf_m.isaf029 = '' #160822-00008#8 
                        LET g_isaf_m.isaf030 = '' #160822-00008#8
                        LET g_isaf_m.isaf031 = '' #160822-00008#8
                        LET g_isaf_m.isaf032 = '' #160822-00008#8
                        LET g_isaf_m.isaf046 = '' #160822-00008#8
                        CALL aist310_isafcomp_get()
                        CALL aist310_ref_show()
                        NEXT FIELD CURRENT
                     END IF
                  END IF    

                  IF NOT cl_null(g_isaf_m.isafcomp)THEN
                     CALL s_fin_account_center_with_ld_chk(g_isaf_m.isafsite,g_glaald,g_user,'3','Y','',g_today) 
                        RETURNING g_sub_success,g_errno
                     IF NOT g_sub_success THEN
                        INITIALIZE g_errparam TO NULL
                        #LET g_errparam.code = 'aap-00127'
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        #LET g_isaf_m.isafsite = g_isaf_m_t.isafsite #160822-00008#8 mark
                        LET g_isaf_m.isafsite = g_isaf_m_o.isafsite  #160822-00008#8
                        CALL aist310_ref_show()
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            CALL s_fin_account_center_sons_query('3',g_isaf_m.isafsite,g_today,'1')
            #LET g_isaf_m_t.isafsite = g_isaf_m.isafsite #160822-00008#8 mark
            #LET g_isaf_m_t.isafcomp = g_isaf_m.isafcomp #160822-00008#8 mark
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafsite
            #add-point:BEFORE FIELD isafsite name="input.b.isafsite"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isafsite
            #add-point:ON CHANGE isafsite name="input.g.isafsite"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafdocno
            
            #add-point:AFTER FIELD isafdocno name="input.a.isafdocno"
            #此段落由子樣板a05產生
            IF  NOT cl_null(g_isaf_m.isafcomp) AND NOT cl_null(g_isaf_m.isafdocno) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t  OR g_isaf_m.isafdocno != g_isafdocno_t )) THEN 
                  #IF NOT ap_chk_notDup(g_isaf_m.isafdocno,"SELECT COUNT(*) FROM isaf_t WHERE "||"isafent = '" ||g_enterprise|| "' AND "||"isafcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isafdocno = '"||g_isaf_m.isafdocno ||"'",'std-00004',0) THEN  #160907-00046#1 mark
                  IF NOT ap_chk_notDup(g_isaf_m.isafdocno,"SELECT COUNT(1) FROM isaf_t WHERE "||"isafent = '" ||g_enterprise|| "' AND "||"isafcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isafdocno = '"||g_isaf_m.isafdocno ||"'",'std-00004',0) THEN #160907-00046#1
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            
            LET l_glaa024 = ''
            SELECT glaa024 INTO l_glaa024 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_glaald
            IF NOT cl_null(g_isaf_m.isafdocno) THEN 
               IF g_isaf_m.isafdocno != g_isaf_m_o.isafdocno OR cl_null(g_isaf_m_o.isafdocno) THEN #160822-00008#8
                  CALL s_aooi200_fin_chk_slip(g_glaald,l_glaa024,g_isaf_m.isafdocno,'aist310') RETURNING l_success
                  IF l_success = FALSE THEN 
                     #LET g_isaf_m.isafdocno = g_isaf_m_t.isafdocno #160822-00008#8
                     LET g_isaf_m.isafdocno = g_isaf_m_o.isafdocno  #160822-00008#8
                     CALL aist310_ref_show()
                     NEXT FIELD isafdocno
                  END IF
                  #161104-00046#3-----s
                  CALL s_control_chk_doc('1',g_isaf_m.isafdocno,'4',g_user,g_dept,'','') RETURNING g_sub_success,l_flag1
                  IF g_sub_success AND l_flag1 THEN             
                  ELSE
                     LET g_isaf_m.isafdocno = g_isaf_m_o.isafdocno 
                     NEXT FIELD CURRENT                  
                  END IF
                  CALL s_aooi200_fin_get_slip(g_isaf_m.isafdocno) RETURNING g_sub_success,l_slip
                  #刪除單別預設temptable
                  DELETE FROM s_aooi200def1
                  #以目前畫面資訊新增temp資料   #請勿調整.*
                  INSERT INTO s_aooi200def1 VALUES(g_isaf_m.*)
                  #依單別預設取用資訊
                  CALL s_aooi200def_get('','',g_isaf_m.isafcomp,'2',l_slip,'','',g_glaald)
                  #依單別預設值TEMP內容 給予到畫面上   #請勿調整.*
                  SELECT * INTO g_isaf_m.* FROM s_aooi200def1
                  #161104-00046#3-----e  
               END IF #160822-00008#8
            END IF
            #160708-00012#1-s
            CALL s_aooi200_fin_get_slip_desc(g_isaf_m.isafdocno) RETURNING g_isaf_m.isafdocno_desc
            DISPLAY BY NAME g_isaf_m.isafdocno_desc
            #160708-00012#1-e
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafdocno
            #add-point:BEFORE FIELD isafdocno name="input.b.isafdocno"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isafdocno
            #add-point:ON CHANGE isafdocno name="input.g.isafdocno"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf001
            #add-point:BEFORE FIELD isaf001 name="input.b.isaf001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf001
            
            #add-point:AFTER FIELD isaf001 name="input.a.isaf001"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf001
            #add-point:ON CHANGE isaf001 name="input.g.isaf001"
            IF g_isaf_m.isaf001 = '2' THEN 
               #CALL cl_set_comp_visible('bpage_1',FALSE) #160620-00010#3 mark 
               CALL cl_set_comp_visible('bpage_1',TRUE)   #160620-00010#3 add
               LET g_isaf_m.isaf055 = g_isaf_m.isaf003
               CALL cl_set_comp_entry("isaf055",FALSE)  
            ELSE
               CALL cl_set_comp_visible('bpage_1',TRUE)
               LET g_isaf_m.isaf055 = ''
               CALL cl_set_comp_entry("isaf055",TRUE)
            END IF     
            CALL cl_set_comp_required("isag013,isag014",FALSE)  #161214-00053#1
            #IF g_isaf_m.isaf001 = '4' THEN  #160920-00013#1 mark
            IF g_isaf_m.isaf001 = '4' OR g_isaf_m.isaf001 = '5' THEN #160920-00013#1 add
               CALL cl_set_combo_scc_part('isaf056','9741','2') #扣抵折讓單   #160614-00025#1 add 當對帳來源為 4 時,發票性質不可為 1
               LET g_isaf_m.isaf056 = '2'
               #161214-00053#1 add ------
               IF g_isai003 = 'Y' THEN
                  IF g_isai002 = '1' THEN
                     CALL cl_set_comp_required("isag014",TRUE)
                  ELSE
                     CALL cl_set_comp_required("isag013,isag014",TRUE)
                  END IF
               END IF
               #161214-00053#1 add end---
            ELSE
               CALL cl_set_combo_scc_part('isaf056','9741','1') #交易發票     #160614-00025#1 add 當對帳來源為 1,2,3 時發票性質不可為 2
               LET g_isaf_m.isaf056 = '1'
            END IF
            
            CALL aist310_isag001_sel()   #160316-00017#2 add lujh
            #160920-00032#1-----s
            CALL aist310_visible()
            #160920-00032#1-----e
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafcomp
            
            #add-point:AFTER FIELD isafcomp name="input.a.isafcomp"
            #此段落由子樣板a05產生
            IF  NOT cl_null(g_isaf_m.isafcomp) AND NOT cl_null(g_isaf_m.isafdocno) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t  OR g_isaf_m.isafdocno != g_isafdocno_t )) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isaf_t WHERE "||"isafent = '" ||g_enterprise|| "' AND "||"isafcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isafdocno = '"||g_isaf_m.isafdocno ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isaf_t WHERE "||"isafent = '" ||g_enterprise|| "' AND "||"isafcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isafdocno = '"||g_isaf_m.isafdocno ||"'",'std-00004',0) THEN #160907-00046#1
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

            CALL aist310_ref_show()
            LET g_isaf_m.isaf029 = '' #160822-00008#8 
            LET g_isaf_m.isaf030 = '' #160822-00008#8
            LET g_isaf_m.isaf031 = '' #160822-00008#8
            LET g_isaf_m.isaf032 = '' #160822-00008#8
            LET g_isaf_m.isaf046 = '' #160822-00008#8 
            CALL aist310_isafcomp_get()
            IF NOT cl_null(g_isaf_m.isafcomp) THEN
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isaf_m.isafcomp != g_isaf_m_t.isafcomp OR g_isaf_m_t.isafcomp IS NULL )) THEN #160822-00008#8 Mark
               IF g_isaf_m.isafcomp != g_isaf_m_o.isafcomp OR cl_null(g_isaf_m_o.isafcomp) THEN #160822-00008#8
                  CALL s_fin_comp_chk(g_isaf_m.isafcomp) RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     #160321-00016#35 --s add
                     LET g_errparam.replace[1] = 'aooi100'
                     LET g_errparam.replace[2] = cl_get_progname('aooi100',g_lang,"2")
                     LET g_errparam.exeprog = 'aooi100'
                     #160321-00016#35 --e add
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     #LET g_isaf_m.isafcomp = g_isaf_m_t.isafcomp #160822-00008#8 Mark
                     LET g_isaf_m.isafcomp = g_isaf_m_o.isafcomp  #160822-00008#8
                     CALL aist310_ref_show()
                     NEXT FIELD CURRENT
                  END IF
                  LET g_isaf_m.isaf052 = '' #160822-00008#8
                  LET g_isaf_m.isaf052 = g_isaf_m.isafcomp
                  CALL aist310_ref_show()

                  IF NOT cl_null(g_isaf_m.isafsite)THEN
                     CALL s_fin_account_center_with_ld_chk(g_isaf_m.isafsite,g_glaald,g_user,'3','Y','',g_today) 
                        RETURNING g_sub_success,g_errno
                     IF NOT g_sub_success THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'aap-00127'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        #LET g_isaf_m.isafcomp = g_isaf_m_t.isafcomp #160822-00008#8 Mark
                        LET g_isaf_m.isafcomp = g_isaf_m_o.isafcomp  #160822-00008#8
                        CALL aist310_ref_show()
                        NEXT FIELD CURRENT
                     END IF   
                  END IF
                  #160907-00041#1 --s add
                  #檢核法人是否有azzi800權限
                  LET l_cnt_comp = 0                     
                  #LET l_sql = "SELECT COUNT(*) FROM ooef_t WHERE ooefent = ",g_enterprise," ", #170215-00025#1 mark
                  LET l_sql = "SELECT COUNT(1) FROM ooef_t WHERE ooefent = ",g_enterprise,      #170215-00025#1
                              "   AND ooef001 = '",g_isaf_m.isafcomp,"' ",
                              "   AND ooef001 IN ",g_wc_cs_comp CLIPPED
                  PREPARE sel_cnt_comp FROM l_sql
                  EXECUTE sel_cnt_comp INTO l_cnt_comp
                     
                  IF cl_null(l_cnt_comp)THEN LET l_cnt_comp = 0 END IF
                  IF l_cnt_comp = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00228'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()        
                     LET g_isaf_m.isafcomp = g_isaf_m_o.isafcomp 
                     CALL aist310_ref_show()
                     NEXT FIELD CURRENT
                  END IF
                  #160907-00041#1 --e add
                  
                  LET g_isaf_m.isaf029 = '' #160822-00008#8 
                  LET g_isaf_m.isaf030 = '' #160822-00008#8
                  LET g_isaf_m.isaf031 = '' #160822-00008#8
                  LET g_isaf_m.isaf032 = '' #160822-00008#8
                  LET g_isaf_m.isaf046 = '' #160822-00008#8 
                  CALL aist310_isafcomp_get()
                  
                  LET g_para_data = '' #160822-00008#8 
                  CALL cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-2013') RETURNING g_para_data
                  #161024-00065#2 add ------
                  #取得aoos020的參數S-FIN-2023(流通門店銷售立帳方式)
                  CALL cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-2023') RETURNING g_sfin2023
                  #161024-00065#2 add end---
               END IF
            END IF
            #LET g_isaf_m_t.isafcomp = g_isaf_m.isafcomp #160822-00008#8 mark
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafcomp
            #add-point:BEFORE FIELD isafcomp name="input.b.isafcomp"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isafcomp
            #add-point:ON CHANGE isafcomp name="input.g.isafcomp"
            SELECT ooef016 INTO g_isaf_m.isaf100 FROM ooef_t 
             WHERE ooefent = g_enterprise
               AND ooef001 = g_isaf_m.isafcomp
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafdocdt
            #add-point:BEFORE FIELD isafdocdt name="input.b.isafdocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafdocdt
            
            #add-point:AFTER FIELD isafdocdt name="input.a.isafdocdt"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isafdocdt
            #add-point:ON CHANGE isafdocdt name="input.g.isafdocdt"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf056
            #add-point:BEFORE FIELD isaf056 name="input.b.isaf056"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf056
            
            #add-point:AFTER FIELD isaf056 name="input.a.isaf056"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf056
            #add-point:ON CHANGE isaf056 name="input.g.isaf056"
            CALL aist310_isag001_sel()
            CALL aist310_visible()
            CALL cl_set_comp_visible('isat027',TRUE)
            IF g_isaf_m.isaf056 = '1' THEN CALL cl_set_comp_visible('isat027',FALSE) END IF #160215-00013#1
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf005
            
            #add-point:AFTER FIELD isaf005 name="input.a.isaf005"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf005) THEN  
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL      
               LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isaf_m.isaf005
               LET g_chkparam.err_str[1] = "aim-00070:sub-01302|aooi130|",cl_get_progname("aooi130",g_lang,"2"),"|:EXEPROGaooi130"#要執行的建議程式待補 #160318-00025#30  add
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooag001") THEN
                  #檢查成功時後續處理
               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf005 = g_isaf_m_t.isaf005
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF
            
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf005
            #add-point:BEFORE FIELD isaf005 name="input.b.isaf005"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf005
            #add-point:ON CHANGE isaf005 name="input.g.isaf005"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf057
            
            #add-point:AFTER FIELD isaf057 name="input.a.isaf057"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf057) THEN 
               IF g_isaf_m.isaf057 != g_isaf_m_o.isaf057 OR cl_null(g_isaf_m_o.isaf057) THEN #160822-00008#8
#此段落由子樣板a19產生
                  #校驗代值
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_isaf_m.isaf057
                  LET g_chkparam.err_str[1] = "aim-00070:sub-01302|aooi130|",cl_get_progname("aooi130",g_lang,"2"),"|:EXEPROGaooi130"#要執行的建議程式待補 #160318-00025#30  add
                     
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_ooag001") THEN
                     #檢查成功時後續處理
                     #LET  = g_chkparam.return1
                     #DISPLAY BY NAME
                     LET g_isaf_m.isaf004 = ''   #160822-00008#8               
                     SELECT ooag003 INTO g_isaf_m.isaf004
                       FROM ooag_t
                      WHERE ooagent = g_enterprise
                        AND ooag001 = g_isaf_m.isaf057
                     CALL aist310_ref_show() 
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_isaf_m.isaf057 = g_isaf_m_t.isaf057 #160822-00008#8 Mark
                     LET g_isaf_m.isaf057 = g_isaf_m_o.isaf057  #160822-00008#8
                     CALL aist310_ref_show()
                     NEXT FIELD CURRENT
                  END IF
               END IF #160822-00008#8

            END IF 
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf057
            #add-point:BEFORE FIELD isaf057 name="input.b.isaf057"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf057
            #add-point:ON CHANGE isaf057 name="input.g.isaf057"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf003
            
            #add-point:AFTER FIELD isaf003 name="input.a.isaf003"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf003) THEN
               IF g_isaf_m.isaf003 != g_isaf_m_o.isaf003 OR cl_null(g_isaf_m_o.isaf003) THEN #160822-00008#8 
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                  LET g_chkparam.arg1 = g_isaf_m.isaf003
                  LET g_chkparam.err_str[1] = "apm-00044:sub-01302|apmm100|",cl_get_progname("apmm100",g_lang,"2"),"|:EXEPROGapmm100"#要執行的建議程式待補 #160318-00025#30  add
                  IF cl_chk_exist("v_pmaa001_2") THEN
                     LET g_isaf_m.isaf002 = '' #160822-00008#8 
                     LET g_isaf_m.isaf055 = '' #160822-00008#8 
                     LET g_isaf_m.isaf002 = g_isaf_m.isaf003
                     LET g_isaf_m.isaf055 = g_isaf_m.isaf003
                     IF cl_null(g_isaf_m.isaf008) THEN  #160922-00055#2 add 發票類型為空時才做預帶
                     #160809-00012#1---s
                     LET g_isaf_m.isaf008 = '' #160822-00008#8 
                     SELECT pmab106 INTO g_isaf_m.isaf008
                       FROM pmab_t
                      WHERE pmabent = g_enterprise
                        AND pmabsite = g_isaf_m.isafcomp
                        AND pmab001 = g_isaf_m.isaf002
                     #160809-00012#1---e
                     
                     #161125-00028#1---s
                     IF NOT cl_null(g_isaf_m.isaf008) THEN
                         LET l_isac_cnt = 0
                         #SELECT COUNT(*) INTO l_isac_cnt #170215-00025#1 mark
                         SELECT COUNT(1) INTO l_isac_cnt  #170215-00025#1
                           FROM isac_t
                           WHERE isacent = g_enterprise
                           AND isac001 = g_ooef019
                           AND isac002 = g_isaf_m.isaf008
                         IF l_isac_cnt = 0 THEN
                             LET g_isaf_m.isaf008 = null
                         ELSE
                             LET g_isac003 = ''
                             SELECT isac003 INTO g_isac003
                               FROM isac_t
                              WHERE isacent = g_enterprise
                                AND isac001 = g_ooef019
                                AND isac002 = g_isaf_m.isaf008
                             IF g_isac003 <> '2' AND g_isaf_m.isaf056 = '1' THEN
                                 LET g_isaf_m.isaf008 = null
                             END IF
                             IF g_isai006 = 'N' THEN
                                 IF g_isac003 <> '4' AND g_isaf_m.isaf056 = '2' THEN
                                     LET g_isaf_m.isaf008 = null
                                 END IF
                             END IF
                             #檢查發票類型是否符合aisi090該據點設定可使用的
                             IF NOT cl_null(g_isaf_m.isaf052) THEN
                                 LET l_cnt = 0
                                 SELECT COUNT(1) INTO l_cnt
                                   FROM isaq_t
                                  WHERE isaqent = g_enterprise
                                    AND isaqsite = g_isaf_m.isaf052
                                    AND isaq001 = g_isaf_m.isaf008
                             ELSE
                                 LET l_cnt = 0
                                 SELECT COUNT(1) INTO l_cnt
                                   FROM isaq_t
                                  WHERE isaqent = g_enterprise
                                    AND isaqsite = g_isaf_m.isafcomp
                                    AND isaq001 = g_isaf_m.isaf008
                            END IF
                            IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                            IF l_cnt = 0 THEN
                                LET g_isaf_m.isaf008 = null
                            END IF
                         END IF
                     END IF
                     #161125-00028#1---e
                     
                     END IF #160922-00055#2 add
                    CALL aist310_ref_show()
                     CALL aist310_isaf002_get()
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_isaf_m.isaf003 = g_isaf_m_t.isaf003 #160822-00008#8 Mark
                     LET g_isaf_m.isaf003 = g_isaf_m_o.isaf003  #160822-00008#8
                     CALL aist310_ref_show()
                     NEXT FIELD CURRENT
                  END IF
                  
                  #151231-00010#3-----s
                  CALL s_control_check_customer(g_isaf_m.isaf003,'2',g_isaf_m.isafsite,g_user,g_dept,'')
                     RETURNING g_sub_success
                  IF NOT g_sub_success THEN
                     #檢查失敗時後續處理
                     #LET g_isaf_m.isaf003 = g_isaf_m_t.isaf003 #160822-00008#8 Mark
                     LET g_isaf_m.isaf003 = g_isaf_m_o.isaf003  #160822-00008#8
                     CALL aist310_ref_show()
                     NEXT FIELD CURRENT
                  END IF
                  #151231-00010#3-----e
                  #160802-00007#1 Add ---(S)---
                  SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_isaf_m.isaf003
                  CASE
                     WHEN l_pmaa004 = '2'   #一次性交易對象
                        #161206-00042#2 mark-----s
                        #INITIALIZE g_qryparam.* TO NULL
                        #LET g_qryparam.state = 'i'
		    	            #LET g_qryparam.reqry = FALSE
		    	            #LET g_qryparam.default1 = g_isaf_m.isaf067
		    	            #LET g_qryparam.arg1 = g_isaf_m.isaf003
		                  #CALL q_pmak002() 
		    	            #LET g_isaf_m.isaf067 = g_qryparam.return1
		    	            #161206-00042#2 mark-----e
		    	            #SELECT pmak003 INTO g_isaf_m.isaf003_desc FROM pmak_t                    #161207-00038#1 mark
		    	            #161207-00038#1 --s add
		    	            #161206-00042#2-----s
		    	            IF g_isaf_m.isaf001 MATCHES '[25]' THEN
		    	               CALL apmi004_01('1',g_isaf_m.isaf067,g_isaf_m.isaf003,g_isaf_m.isafdocno) RETURNING g_isaf_m.isaf067
		    	            ELSE
                           INITIALIZE g_qryparam.* TO NULL
                           LET g_qryparam.state = 'i'
		    	               LET g_qryparam.reqry = FALSE
		    	               LET g_qryparam.default1 = g_isaf_m.isaf067
		    	               LET g_qryparam.arg1 = g_isaf_m.isaf003
		                     CALL q_pmak002() 
		    	               LET g_isaf_m.isaf067 = g_qryparam.return1
		    	            END IF
		    	            #161206-00042#2-----e
		    	            LET g_isaf_m.isaf003_desc = ''
		    	            LET g_isaf_m.isaf022 = ''
		    	            LET g_isaf_m.isaf023 = ''
		    	            SELECT pmak003,pmak004,pmak005 INTO g_isaf_m.isaf003_desc,g_isaf_m.isaf022,g_isaf_m.isaf023 
		    	              FROM pmak_t
		    	           #161207-00038#1 --e add
		    	             WHERE pmakent = g_enterprise
		    	               AND pmak001 = g_isaf_m.isaf067
		    	            LET g_isaf_m.isaf021 = g_isaf_m.isaf003_desc  #161207-00038#1 add
                     WHEN l_pmaa004 = '4'   #員工
                        INITIALIZE g_qryparam.* TO NULL
                        LET g_qryparam.state = 'i'
		    	            LET g_qryparam.reqry = FALSE
		    	            LET g_qryparam.default1 = g_isaf_m.isaf067
		                  CALL q_ooag001() 
		    	            LET g_isaf_m.isaf067 = g_qryparam.return1
		    	            CALL s_axrt300_xrca_ref('xrca003',g_isaf_m.isaf067,'','') RETURNING l_success,g_isaf_m.isaf003_desc
		    	         OTHERWISE
		    	            LET g_isaf_m.isaf067 = g_isaf_m.isaf003
                  END CASE
                  IF NOT cl_null(g_isaf_m.isaf067) THEN
                     CALL s_axrt300_xrca_ref('xrca057',g_isaf_m.isaf067,'','') RETURNING l_success,g_isaf_m.isaf003_desc
                  END IF
                  #160802-00007#1 Add ---(E)---
               END IF #160822-00008#8
            END IF
            #161206-00042#2-----s
            IF NOT cl_null(g_isaf_m.isaf067) THEN
               CALL s_axrt300_xrca_ref('xrca057',g_isaf_m.isaf067,'','') RETURNING l_success,g_isaf_m.isaf003_desc
            END IF
            DISPLAY BY NAME g_isaf_m.isaf003_desc
            #161206-00042#2-----e
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf003
            #add-point:BEFORE FIELD isaf003 name="input.b.isaf003"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf003
            #add-point:ON CHANGE isaf003 name="input.g.isaf003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf067
            #add-point:BEFORE FIELD isaf067 name="input.b.isaf067"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf067
            
            #add-point:AFTER FIELD isaf067 name="input.a.isaf067"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf067
            #add-point:ON CHANGE isaf067 name="input.g.isaf067"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isafstus
            #add-point:BEFORE FIELD isafstus name="input.b.isafstus"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isafstus
            
            #add-point:AFTER FIELD isafstus name="input.a.isafstus"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isafstus
            #add-point:ON CHANGE isafstus name="input.g.isafstus"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf008
            
            #add-point:AFTER FIELD isaf008 name="input.a.isaf008"
            CALL aist310_ref_show()
            CALL aist310_isaf008_get()
            IF NOT cl_null(g_isaf_m.isaf008) THEN
               IF g_isaf_m.isaf008 != g_isaf_m_o.isaf008 OR cl_null(g_isaf_m_o.isaf008) THEN #160822-00008#8
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_ooef019
                  LET g_chkparam.arg2 = g_isaf_m.isaf008
                  IF cl_chk_exist("v_isac002_2") THEN
                     #檢查成功時後續處理
                     CALL aist310_visible()
                     LET g_isac003 = '' #160822-00008#8
                     SELECT isac003 INTO g_isac003
                       FROM isac_t
                      WHERE isacent = g_enterprise
                        AND isac001 = g_ooef019
                        AND isac002 = g_isaf_m.isaf008
                     IF g_isac003 <> '2' AND g_isaf_m.isaf056 = '1' THEN 
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'ais-00157'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        #LET g_isaf_m.isaf008 = g_isaf_m_t.isaf008 #160822-00008#8 Mark
                        LET g_isaf_m.isaf008 = g_isaf_m_o.isaf008  #160822-00008#8
                        CALL aist310_ref_show()
                        CALL aist310_isaf008_get()
                        NEXT FIELD CURRENT
                     END IF
                     
                     IF g_isai006 = 'N' THEN
                        IF g_isac003 <> '4' AND g_isaf_m.isaf056 = '2' THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'ais-00158'
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           #LET g_isaf_m.isaf008 = g_isaf_m_t.isaf008 #160822-00008#8 Mark
                           LET g_isaf_m.isaf008 = g_isaf_m_o.isaf008  #160822-00008#8
                           CALL aist310_ref_show()
                           CALL aist310_isaf008_get()
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                     
                     #160712-00013#1-s
                     #檢查發票類型是否符合aisi090該據點設定可使用的
                     IF NOT cl_null(g_isaf_m.isaf052) THEN
                        LET l_cnt = 0 #160822-00008#8
                        #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
                        SELECT COUNT(1) INTO l_cnt #160907-00046#1
                          FROM isaq_t
                         WHERE isaqent = g_enterprise
                           AND isaqsite = g_isaf_m.isaf052
                           AND isaq001 = g_isaf_m.isaf008
                     ELSE
                        LET l_cnt = 0 #160822-00008#8
                        #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
                        SELECT COUNT(1) INTO l_cnt #160907-00046#1
                          FROM isaq_t
                         WHERE isaqent = g_enterprise
                           AND isaqsite = g_isaf_m.isafcomp
                           AND isaq001 = g_isaf_m.isaf008
                     END IF
                     IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                     IF l_cnt = 0 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'ais-00338'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        #LET g_isaf_m.isaf008 = g_isaf_m_t.isaf008 #160822-00008#8 Mark
                        LET g_isaf_m.isaf008 = g_isaf_m_o.isaf008  #160822-00008#8
                        CALL aist310_ref_show()
                        CALL aist310_isaf008_get()
                        NEXT FIELD CURRENT
                     END IF
                     #160712-00013#1-e
                     
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_isaf_m.isaf008 = g_isaf_m_t.isaf008 #160822-00008#8 Mark
                     LET g_isaf_m.isaf008 = g_isaf_m_o.isaf008  #160822-00008#8
                     CALL aist310_ref_show()
                     CALL aist310_isaf008_get()
                     NEXT FIELD CURRENT
                  END IF
               END IF  #160822-00008#8
            END IF 
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf008
            #add-point:BEFORE FIELD isaf008 name="input.b.isaf008"
            #161020-00021#1 --s add
            CALL aist310_set_entry(p_cmd)
            CALL aist310_set_no_entry(p_cmd)
            #161020-00021#1 --e add
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf008
            #add-point:ON CHANGE isaf008 name="input.g.isaf008"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf016
            
            #add-point:AFTER FIELD isaf016 name="input.a.isaf016"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf016) THEN 
#此段落由子樣板a19產生
               IF g_isaf_m.isaf016 != g_isaf_m_o.isaf016 OR cl_null(g_isaf_m_o.isaf016) THEN  #160822-00008#8
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_ooef019
                  LET g_chkparam.arg2 = g_isaf_m.isaf016
                  LET g_chkparam.err_str[1] = "aoo-00223:sub-01302|aooi610|",cl_get_progname("aooi610",g_lang,"2"),"|:EXEPROGaooi610"#要執行的建議程式待補 #160318-00025#30  add
                     
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_oodb002_2") THEN
                     #檢查成功時後續處理
                     #LET  = g_chkparam.return1
                     #DISPLAY BY NAME 
                     #IF NOT cl_null(g_isaf_m.isaf016) AND g_isaf_m.isaf016 <> g_isaf_m_t.isaf016 THEN #160822-00008#8 Mark
                     IF NOT cl_null(g_isaf_m.isaf016) AND g_isaf_m.isaf016 != g_isaf_m_o.isaf016 THEN 
                        CALL aist310_update_isaf016()
                     END IF
                     
                     IF g_oodb004 = '2' THEN 
                        CALL cl_set_comp_entry("isag113,isag114,isag115",FALSE)
                        CALL cl_set_comp_entry("isah113,isah114,isah115",FALSE)
                        IF g_isaf_m.isaf017 = 'N' THEN 
                           CALL cl_set_comp_entry("isag103,isah103",TRUE)
                           CALL cl_set_comp_entry("isag105,isah105",FALSE)
                        ELSE 
                           CALL cl_set_comp_entry("isag103,isah103",FALSE)
                           CALL cl_set_comp_entry("isag105,isah105",TRUE)
                        END IF
                     END IF
                     
                     #160316-00017#2--add--str--lujh
                     LET l_oodb005 = ''
                     SELECT oodb005 INTO l_oodb005
                       FROM oodb_t
                      WHERE oodbent = g_enterprise
                        AND oodb001 = g_ooef019
                        AND oodb002 = g_isaf_m.isaf016
                     #160920-00013#1--s mark
                     #IF g_isaf_m.isaf001 = '3' AND l_oodb005 = 'N' THEN 
                     #   INITIALIZE g_errparam TO NULL 
                     #   LET g_errparam.extend = "" 
                     #   LET g_errparam.code   = "ais-00311" 
                     #   LET g_errparam.popup  = TRUE 
                     #   CALL cl_err()
                     #   NEXT FIELD isaf016
                     #END IF
                     #160920-00013#1--e mark
                     
                     #160920-00032#1 mark-----s
                     ##160920-00013#1--s add
                     #IF g_isaf_m.isaf001 <> '3' AND l_oodb005 = 'N' THEN 
                     #   INITIALIZE g_errparam TO NULL 
                     #   LET g_errparam.extend = "" 
                     #   LET g_errparam.code   = "ais-00311" 
                     #   LET g_errparam.popup  = TRUE 
                     #   CALL cl_err()
                     #   NEXT FIELD isaf016
                     #END IF
                     ##160920-00013#1--e add
                     #160920-00032#1 mark-----e

                     
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_isaf_m.isaf016 = g_isaf_m_t.isaf016 #160822-00008#8 Mark
                     LET g_isaf_m.isaf016 = g_isaf_m_o.isaf016  #160822-00008#8
                     CALL aist310_ref_show()
                     NEXT FIELD CURRENT
                  END IF
                  
               END IF    #160822-00008#8     
            END IF 
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf016
            #add-point:BEFORE FIELD isaf016 name="input.b.isaf016"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf016
            #add-point:ON CHANGE isaf016 name="input.g.isaf016"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf014
            #add-point:BEFORE FIELD isaf014 name="input.b.isaf014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf014
            
            #add-point:AFTER FIELD isaf014 name="input.a.isaf014"
            IF NOT cl_null(g_isaf_m.isaf014) AND NOT cl_null(g_isaf_m.isaf051) THEN 
               LET l_isae002 = ''
               LET l_isae003 = ''
               SELECT isae002,isae003
                 INTO l_isae002,l_isae003
                 FROM isae_t
                WHERE isaeent = g_enterprise
                  AND isaecomp = g_isaf_m.isafcomp
                  AND isaesite = g_isaf_m.isaf052
                  AND isae001 = g_isaf_m.isaf051
                  AND isae004 = g_isaf_m.isaf008
                  
               IF g_isaf_m.isaf014 < l_isae002 OR g_isaf_m.isaf014 > l_isae003 THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00151'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_isaf_m.isaf014 = g_isaf_m_t.isaf014
                  CALL aist310_isaf051_get()
                  NEXT FIELD CURRENT
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf014
            #add-point:ON CHANGE isaf014 name="input.g.isaf014"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf053
            #add-point:BEFORE FIELD isaf053 name="input.b.isaf053"
 
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf053
            
            #add-point:AFTER FIELD isaf053 name="input.a.isaf053"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf053
            #add-point:ON CHANGE isaf053 name="input.g.isaf053"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf052
            
            #add-point:AFTER FIELD isaf052 name="input.a.isaf052"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf052) THEN  
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL      
               LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isaf_m.isaf052
               LET g_chkparam.err_str[1] = "aoo-00095:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"#要執行的建議程式待補 #160318-00025#30  add
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooef001") THEN
                  #檢查成功時後續處理
                  
               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf052 = g_isaf_m_t.isaf052
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF
               #--160315--s
               CALL s_fin_site_belong_to_comp_chk(g_isaf_m.isaf052,g_isaf_m.isafcomp) RETURNING g_sub_success,g_errno
               IF NOT g_sub_success THEN                  
                  INITIALIZE g_errparam TO NULL
                  IF g_errno = 'aap-00034' THEN LET g_errno = 'axr-00024' END IF
                  LET g_errparam.code = g_errno
                  LET g_errparam.extend = ''
                  #160321-00016#35 --s add
                  IF g_errno = 'sub-01302' THEN
                     LET g_errparam.replace[1] = 'aooi125'
                     LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
                     LET g_errparam.exeprog = 'aooi125'
                  END IF
                  #160321-00016#35 --e add
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_isaf_m.isaf052 = g_isaf_m_t.isaf052
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT                  
               END IF
               #--160315--e
            
            END IF 


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf052
            #add-point:BEFORE FIELD isaf052 name="input.b.isaf052"
            #161020-00021#1 --s add
            CALL aist310_set_entry(p_cmd)
            CALL aist310_set_no_entry(p_cmd)
            #161020-00021#1 --e add
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf052
            #add-point:ON CHANGE isaf052 name="input.g.isaf052"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf018
            #add-point:BEFORE FIELD isaf018 name="input.b.isaf018"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf018
            
            #add-point:AFTER FIELD isaf018 name="input.a.isaf018"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf018
            #add-point:ON CHANGE isaf018 name="input.g.isaf018"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf051
            #add-point:BEFORE FIELD isaf051 name="input.b.isaf051"
            #161020-00021#1 --s add
            CALL aist310_set_entry(p_cmd)
            CALL aist310_set_no_entry(p_cmd)
            #161020-00021#1 --e add
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf051
            
            #add-point:AFTER FIELD isaf051 name="input.a.isaf051"
            CALL aist310_isaf051_get()
            IF NOT cl_null(g_isaf_m.isaf051) THEN
               INITIALIZE g_chkparam.* TO NULL
               LET g_chkparam.arg1 = g_isaf_m.isaf052
               LET g_chkparam.arg2 = g_isaf_m.isaf051
               IF cl_chk_exist("v_isae001") THEN
                  #檢查成功時後續處理
                  #161214-00053#1 add ------
                  #輸入的發票簿是否OK
                  LET l_cnt = 0
                  SELECT COUNT(1) INTO l_cnt #160907-00046#1
                    FROM isae_t
                   WHERE isaeent = g_enterprise
                     AND isaesite = g_isaf_m.isaf052 #营运据点
                     AND isae001 = g_isaf_m.isaf051  #發票簿
                     AND isae004 = g_isaf_m.isaf008  #发票类型
                     AND isaestus = 'Y'
                  IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                  IF l_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "ais-00350"
                     LET g_errparam.extend = g_isaf_m.isaf051
                     LET g_errparam.replace[1] = g_isaf_m.isaf051
                     LET g_errparam.replace[2] = g_isaf_m.isaf008
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isaf_m.isaf051 = g_isaf_m_t.isaf051
                     LET g_isaf_m.isaf010 = g_isaf_m_t.isaf010
                     LET g_isaf_m.isaf011 = g_isaf_m_t.isaf011
                     NEXT FIELD CURRENT
                  END IF
                  #161214-00053#1 add end---
                  
                  LET l_cnt = 0
                  #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
                  SELECT COUNT(1) INTO l_cnt #160907-00046#1
                    FROM isaf_t
                   WHERE isafent = g_enterprise
                     AND isaf051  = g_isaf_m.isaf051
                     AND isaf052  = g_isaf_m.isaf052    #160909-00081#1
                     AND isafstus = 'N'
                     AND isafdocno<>g_isaf_m.isafdocno
                     AND isafcomp = g_isaf_m.isafcomp
                  IF l_cnt > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "ais-00160"
                     LET g_errparam.extend = g_isaf_m.isaf051
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isaf_m.isaf051 = g_isaf_m_t.isaf051
                     LET g_isaf_m.isaf010 = g_isaf_m_t.isaf010
                     LET g_isaf_m.isaf011 = g_isaf_m_t.isaf011
                     NEXT FIELD CURRENT
                  END IF
                  
                  LET l_isae002 = ''
                  LET l_isae003 = ''
                  LET l_isae016 = ''                       #150911
                  LET l_isae017 = ''                       #150911
                  LET l_isae016 = YEAR(g_isaf_m.isaf014)   #150911
                  LET l_isae017 = MONTH(g_isaf_m.isaf014)  #150911
                  SELECT isae002,isae003
                    INTO l_isae002,l_isae003
                    FROM isae_t
                   WHERE isaeent = g_enterprise
                     AND isaecomp = g_isaf_m.isafcomp
                     AND isaesite = g_isaf_m.isaf052
                     AND isae001 = g_isaf_m.isaf051
                     AND isae004 = g_isaf_m.isaf008
                     AND isae016 =  l_isae016                           #150911
                     AND (isae017 = l_isae017 OR isae018 =  l_isae017)  #150911
                     
                  IF g_isaf_m.isaf014 < l_isae002 OR g_isaf_m.isaf014 > l_isae003 THEN 
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00151'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isaf_m.isaf051 = g_isaf_m_t.isaf051
                     CALL aist310_isaf051_get()
                     NEXT FIELD CURRENT
                  END IF
               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf051 = g_isaf_m_t.isaf051
                  CALL aist310_isaf051_get()
                  NEXT FIELD CURRENT
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf051
            #add-point:ON CHANGE isaf051 name="input.g.isaf051"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf009
            #add-point:BEFORE FIELD isaf009 name="input.b.isaf009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf009
            
            #add-point:AFTER FIELD isaf009 name="input.a.isaf009"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf009
            #add-point:ON CHANGE isaf009 name="input.g.isaf009"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf017
            #add-point:BEFORE FIELD isaf017 name="input.b.isaf017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf017
            
            #add-point:AFTER FIELD isaf017 name="input.a.isaf017"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf017
            #add-point:ON CHANGE isaf017 name="input.g.isaf017"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf010
            #add-point:BEFORE FIELD isaf010 name="input.b.isaf010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf010
            
            #add-point:AFTER FIELD isaf010 name="input.a.isaf010"
            IF NOT cl_null(g_isaf_m.isaf010) THEN 
               LET l_isae008 = ''
               SELECT isae008 INTO l_isae008
                 FROM isae_t
                WHERE isaeent = g_enterprise
                  AND isaecomp = g_isaf_m.isafcomp
                  AND isaesite = g_isaf_m.isaf052
                  AND isae001 = g_isaf_m.isaf051
                  AND isae004 = g_isaf_m.isaf008
                  
               IF g_isaf_m.isaf010 <> l_isae008 THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00152'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_isaf_m.isaf010 = g_isaf_m_t.isaf010
                  NEXT FIELD CURRENT
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf010
            #add-point:ON CHANGE isaf010 name="input.g.isaf010"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf012
            #add-point:BEFORE FIELD isaf012 name="input.b.isaf012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf012
            
            #add-point:AFTER FIELD isaf012 name="input.a.isaf012"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf012
            #add-point:ON CHANGE isaf012 name="input.g.isaf012"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf100
            
            #add-point:AFTER FIELD isaf100 name="input.a.isaf100"
            CALL aist310_isaf100_get()
            IF NOT cl_null(g_isaf_m.isaf100) THEN
               IF g_isaf_m.isaf100 != g_isaf_m_o.isaf100 OR cl_null(g_isaf_m_o.isaf100) THEN #160822-00008#8 
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                  LET g_chkparam.arg1 = g_isaf_m.isaf100
                  LET g_chkparam.err_str[1] = "aoo-00011:sub-01302|aooi140|",cl_get_progname("aooi140",g_lang,"2"),"|:EXEPROGaooi140"#要執行的建議程式待補 #160318-00025#30  add
                  IF cl_chk_exist("v_ooai001") THEN
                     #檢查成功時後續處理
                     #LET  = g_chkparam.return1
                     #DISPLAY BY NAME
                     #IF g_isaf_m.isaf101 <> g_isaf_m_t.isaf101 OR cl_null(g_isaf_m_t.isaf101) THEN #160822-00008#8 Mark
                     IF g_isaf_m.isaf101 <> g_isaf_m_o.isaf101 OR cl_null(g_isaf_m_o.isaf101) THEN  #160822-00008#8
                        CALL aist310_update_isaf016()
                     END IF
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_isaf_m.isaf100 = g_isaf_m_t.isaf100 #160822-00008#8 Mark
                     LET g_isaf_m.isaf101 = g_isaf_m_o.isaf101  #160822-00008#8
                     LET g_isaf_m.isaf100 = g_isaf_m_o.isaf100  #160822-00008#8
                     CALL aist310_isaf100_get()
                     NEXT FIELD CURRENT
                  END IF
               END IF   #160822-00008#8 
            END IF
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf100
            #add-point:BEFORE FIELD isaf100 name="input.b.isaf100"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf100
            #add-point:ON CHANGE isaf100 name="input.g.isaf100"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf011
            #add-point:BEFORE FIELD isaf011 name="input.b.isaf011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf011
            
            #add-point:AFTER FIELD isaf011 name="input.a.isaf011"
            #IF NOT cl_null(g_isaf_m.isaf011) THEN  #170116-00020#1 mark
            IF NOT cl_null(g_isaf_m.isaf011) AND g_isaf_m.isaf011 <> 'MULTI' THEN #170116-00020#1 add
               #IF cl_null(g_isaf_m.isaf051) THEN 
               #   INITIALIZE g_errparam TO NULL
               #   LET g_errparam.code = 'ais-00161'
               #   LET g_errparam.extend = ''
               #   LET g_errparam.popup = TRUE
               #   CALL cl_err()
               #   LET g_isaf_m.isaf011 = ''
               #   NEXT FIELD isaf051
               #END IF
               #170103-00009#1 mark ------
               ##150717--(S)
               #IF g_isai002 = '1' THEN
               #   LET l_isaf011 = g_isaf_m.isaf011
               #   LET g_isaf_m.isaf011 = g_isaf_m.isaf011[3,10]
               #END IF
               ##150717--(E)
               #LET l_n = 0
               ##SELECT COUNT(*) INTO l_n #160907-00046#1 mark
               #SELECT COUNT(1) INTO l_n #160907-00046#1
               #  FROM isaf_t
               # WHERE isafent = g_enterprise
               #   AND isaf011 = g_isaf_m.isaf011
               #   AND isaf051 = g_isaf_m.isaf051 AND isafdocno <> g_isaf_m.isafdocno
               #170103-00009#1 mark end---
               #170103-00009#1 add ------
               LET l_sql ="SELECT COUNT(1)",
                          "  FROM isaf_t",
                          " WHERE isafent = ",g_enterprise,
                          "   AND isaf011 = '",g_isaf_m.isaf011,"'",
                          "   AND isafdocno <> '",g_isaf_m.isafdocno,"'"
               #如果發票聯別=4:收據，不用檢核是否存在發票簿
               IF g_isaf_m.isaf053 <> '4' THEN
                  LET l_sql = l_sql," AND isaf051 = '",g_isaf_m.isaf051,"'"
               END IF
               #大陸稅區要檢查發票代碼
               IF g_isai002 = '2' THEN
                  LET l_sql = l_sql," AND isaf010 = '",g_isaf_m.isaf010,"'"
               END IF
               PREPARE isaf_sel_pb1 FROM l_sql
               EXECUTE isaf_sel_pb1 INTO l_n
               #170103-00009#1 add end---
               IF l_n > 0 AND g_isaf_m.isaf011 <> 'MULTI' THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00156' #此發票號碼已經使用,請重新輸入！
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  #LET g_isaf_m.isaf011 = l_isae012         #170103-00009#1 mark
                  LET g_isaf_m.isaf011 = g_isaf_m_t.isaf011 #170103-00009#1
                  NEXT FIELD CURRENT
               END IF
               
               #170103-00009#1 add ------
               #如果發票聯別=4:收據，不用檢核是否存在發票簿
               IF g_isaf_m.isaf053 <> '4' THEN
                  IF g_isai002 = '1' THEN
                     LET l_isaf011 = g_isaf_m.isaf011
                     LET g_isaf_m.isaf011 = g_isaf_m.isaf011[3,10]
                  END IF
               #170103-00009#1 add end---
                  #150717--(S)
                  LET l_isae012 = ''
                  #161214-00053#1 mark ------
                  #SELECT isae007,isae012 INTO l_isae007,l_isae012
                  #  FROM isae_t
                  # WHERE isaeent = g_enterprise
                  #   AND isaecomp = g_isaf_m.isafcomp
                  #   AND isaesite = g_isaf_m.isaf052
                  #   AND isae001 = g_isaf_m.isaf051
                  #   AND isae004 = g_isaf_m.isaf008
                  #   AND isae016 = YEAR(g_isaf_m.isaf014)  #151013-00019#10
                  #   AND (isae017 = MONTH(g_isaf_m.isaf014) OR isae018 = MONTH(g_isaf_m.isaf014)) #151013-00019#10
                  #161214-00053#1 mark end---
                  #161214-00053#1 add ------
                  LET l_isae007 = ''
                  LET l_sql ="SELECT isae007,isae012",
                             "  FROM isae_t",
                             " WHERE isaeent = ",g_enterprise,
                             "   AND isaecomp = '",g_isaf_m.isafcomp,"'",
                             "   AND isaesite = '",g_isaf_m.isaf052,"'",
                             "   AND isae001 = '",g_isaf_m.isaf051,"'",
                             "   AND isae004 = '",g_isaf_m.isaf008,"'",
                             "   AND isae016 = ",YEAR(g_isaf_m.isaf014),
                             "   AND (isae017 = ",MONTH(g_isaf_m.isaf014)," OR isae018 = ",MONTH(g_isaf_m.isaf014),")"
                  PREPARE isae_sel_pb1 FROM l_sql
                  EXECUTE isae_sel_pb1 INTO l_isae007,l_isae012
                  #161214-00053#1 add end---
                  IF g_isaf_m.isaf011 <> l_isae012 AND g_isaf_m.isaf011 <> 'MULTI' THEN 
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00153' #發票號碼必須等於發票簿之下次列印號碼,請檢查！
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     IF g_isai002 = '1' THEN
                        LET g_isaf_m.isaf011 = l_isae007,l_isae007
                     END IF
                     LET g_isaf_m.isaf011 = l_isae007
                     NEXT FIELD CURRENT
                  END IF
                  #150717--(S)
                  IF g_isai002 = '1' THEN
                     LET g_isaf_m.isaf011 = l_isaf011
                  END IF
                  #150717--(S)
               END IF  #170103-00009#1
               
               #160111-00020#2-----s
               #160803-00044#1 mark ------
               #LET l_ooef019 = NULL
               #SELECT ooef019 INTO l_ooef019
               #  FROM ooef_t
               # WHERE ooefent = g_enterprise
               #   AND ooef001 = g_isaf_m.isafcomp
               #   AND ooefstus = 'Y'
               #LET l_isai008 = NULL
               #SELECT isai008 INTO l_isai008
               #  FROM isai_t 
               # WHERE isaient = g_enterprise
               #   AND isai001 = l_ooef019
               #160803-00044#1 mark end---
               IF g_isaf_m.isaf056 = '1' THEN
                  #正項
                 #IF l_isai008 = 'TW' THEN #160803-00044#1 mark
                  IF g_isai002 = '1' THEN  #160803-00044#1
                     LET l_isatcnt = NULL
                     #SELECT COUNT(*) INTO l_isatcnt FROM isat_t #160907-00046#1 mark
                     SELECT COUNT(1) INTO l_isatcnt FROM isat_t #160907-00046#1
                      WHERE isatent = g_enterprise
                        AND isat004 = g_isaf_m.isaf011
                        AND isat001 = g_isaf_m.isaf008
                        AND to_char(isat007,'yyyy') = to_char(g_isaf_m.isaf014,'yyyy')
                        AND isat014 = '11'
                        AND isatdocno <> g_isaf_m.isafdocno
                     IF cl_null(l_isatcnt)THEN LET l_isatcnt = 0 END IF
                  ELSE
                     LET l_isatcnt = NULL
                     #SELECT COUNT(*) INTO l_isatcnt FROM isat_t #160907-00046#1 mark
                     SELECT COUNT(1) INTO l_isatcnt FROM isat_t #160907-00046#1
                      WHERE isatent = g_enterprise
                        AND isat004 = g_isaf_m.isaf011
                        AND isat001 = g_isaf_m.isaf008
                        AND isat003 = g_isaf_m.isaf010
                        AND to_char(isat007,'yyyy') = to_char(g_isaf_m.isaf014,'yyyy')
                        AND isat014 = '11'
                        AND isatdocno <> g_isaf_m.isafdocno
                     IF cl_null(l_isatcnt)THEN LET l_isatcnt = 0 END IF
                  END IF
                  IF l_isatcnt > 0 THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = 'ais-00201' #發票代碼+發票號碼不可重複！
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isaf_m.isaf011 = g_isaf_m_t.isaf011
                     NEXT FIELD isaf011
                  END IF                  
               END IF
               #160111-00020#2-----e               
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf011
            #add-point:ON CHANGE isaf011 name="input.g.isaf011"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf101
            #add-point:BEFORE FIELD isaf101 name="input.b.isaf101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf101
            
            #add-point:AFTER FIELD isaf101 name="input.a.isaf101"
            #IF NOT cl_null(g_isaf_m.isaf101) AND (g_isaf_m.isaf101 <> g_isaf_m_t.isaf101 OR cl_null(g_isaf_m_t.isaf101)) THEN #160822-00008#8 Mark
            IF NOT cl_null(g_isaf_m.isaf101) AND (g_isaf_m.isaf101 <> g_isaf_m_o.isaf101 OR cl_null(g_isaf_m_o.isaf101)) THEN  #160822-00008#8
               CALL aist310_update_isaf016()
            END IF
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf101
            #add-point:ON CHANGE isaf101 name="input.g.isaf101"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf054
            #add-point:BEFORE FIELD isaf054 name="input.b.isaf054"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf054
            
            #add-point:AFTER FIELD isaf054 name="input.a.isaf054"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf054
            #add-point:ON CHANGE isaf054 name="input.g.isaf054"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf002
            
            #add-point:AFTER FIELD isaf002 name="input.a.isaf002"
            CALL aist310_ref_show()
            #CALL aist310_isaf002_get() #160922-00055#2 mark 避免修改後的值,因預帶又蓋過,因此僅在有異動欄位時處理
            IF NOT cl_null(g_isaf_m.isaf002) THEN  
               IF g_isaf_m.isaf002 != g_isaf_m_o.isaf002 OR cl_null(g_isaf_m_o.isaf002) THEN  #160822-00008#8
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL      
                  LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_isaf_m.isaf002
                  LET g_chkparam.err_str[1] = "apm-00044:sub-01302|apmm100|",cl_get_progname("apmm100",g_lang,"2"),"|:EXEPROGapmm100"#要執行的建議程式待補 #160318-00025#30  add
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_pmaa001_2") THEN
                     IF cl_null(g_isaf_m.isaf008) THEN  #160922-00055#2 add 發票類型為空時才做預帶
                     #檢查成功時後續處理
                     LET g_isaf_m.isaf008 = '' #160822-00008#8
                     SELECT pmab106 INTO g_isaf_m.isaf008
                       FROM pmab_t
                      WHERE pmabent = g_enterprise
                        AND pmabsite = g_isaf_m.isafcomp
                        AND pmab001 = g_isaf_m.isaf002
                     END IF #160922-00055#2 add
                     
                     #161125-00028#1---s
                     IF NOT cl_null(g_isaf_m.isaf008) THEN
                         LET l_isac_cnt = 0
                         #SELECT COUNT(*) INTO l_isac_cnt #170215-00025#1 mark
                         SELECT COUNT(1) INTO l_isac_cnt  #170215-00025#1
                           FROM isac_t
                           WHERE isacent = g_enterprise
                           AND isac001 = g_ooef019
                           AND isac002 = g_isaf_m.isaf008
                         IF l_isac_cnt = 0 THEN
                             LET g_isaf_m.isaf008 = null
                         ELSE
                             LET g_isac003 = ''
                             SELECT isac003 INTO g_isac003
                               FROM isac_t
                              WHERE isacent = g_enterprise
                                AND isac001 = g_ooef019
                                AND isac002 = g_isaf_m.isaf008
                             IF g_isac003 <> '2' AND g_isaf_m.isaf056 = '1' THEN
                                 LET g_isaf_m.isaf008 = null
                             END IF
                             IF g_isai006 = 'N' THEN
                                 IF g_isac003 <> '4' AND g_isaf_m.isaf056 = '2' THEN
                                     LET g_isaf_m.isaf008 = null
                                 END IF
                             END IF
                             #檢查發票類型是否符合aisi090該據點設定可使用的
                             IF NOT cl_null(g_isaf_m.isaf052) THEN
                                 LET l_cnt = 0
                                 SELECT COUNT(1) INTO l_cnt
                                   FROM isaq_t
                                  WHERE isaqent = g_enterprise
                                    AND isaqsite = g_isaf_m.isaf052
                                    AND isaq001 = g_isaf_m.isaf008
                             ELSE
                                 LET l_cnt = 0
                                 SELECT COUNT(1) INTO l_cnt
                                   FROM isaq_t
                                  WHERE isaqent = g_enterprise
                                    AND isaqsite = g_isaf_m.isafcomp
                                    AND isaq001 = g_isaf_m.isaf008
                            END IF
                            IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                            IF l_cnt = 0 THEN
                                LET g_isaf_m.isaf008 = null
                            END IF
                         END IF
                     END IF
                     #161125-00028#1---e
                     
                     CALL aist310_ref_show()
                     CALL aist310_isaf002_get() #160922-00055#2 add
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_isaf_m.isaf002 = g_isaf_m_t.isaf002 #160822-00008#8 mark
                     LET g_isaf_m.isaf002 = g_isaf_m_o.isaf002  #160822-00008#8
                     CALL aist310_ref_show()
                     #CALL aist310_isaf002_get() #160922-00055#2 mark
                     NEXT FIELD CURRENT
                  END IF
               END IF           #160822-00008#8
            END IF 
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf002
            #add-point:BEFORE FIELD isaf002 name="input.b.isaf002"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf002
            #add-point:ON CHANGE isaf002 name="input.g.isaf002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf021
            #add-point:BEFORE FIELD isaf021 name="input.b.isaf021"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf021
            
            #add-point:AFTER FIELD isaf021 name="input.a.isaf021"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf021
            #add-point:ON CHANGE isaf021 name="input.g.isaf021"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf022
            #add-point:BEFORE FIELD isaf022 name="input.b.isaf022"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf022
            
            #add-point:AFTER FIELD isaf022 name="input.a.isaf022"
            #161129-00042#1-add(s)
            LET l_ooef011 = ' '
            SELECT ooef011 INTO l_ooef011 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_isaf_m.isafcomp
            IF l_ooef011 = 'TW' THEN
               IF NOT cl_null(g_isaf_m.isaf022) THEN
                  #先檢查輸入的營利事業統一編號是否為8碼或都為數字
                  CALL s_rule_chk_vat_id_string(g_isaf_m.isaf022) RETURNING l_success
                  IF NOT l_success THEN
                     LET g_isaf_m.isaf022 = g_isaf_m_o.isaf022
                     NEXT FIELD isaf022
                  END IF
                  #檢查營利事業統一編號邏輯
                  CALL s_rule_chk_vat_id(l_ooef011,g_isaf_m.isaf022) RETURNING l_success
                  IF NOT l_success THEN
                     LET g_isaf_m.isaf022 = g_isaf_m.isaf022
                  END IF
               END IF
            END IF   
            #161129-00042#1-add(e)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf022
            #add-point:ON CHANGE isaf022 name="input.g.isaf022"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf023
            #add-point:BEFORE FIELD isaf023 name="input.b.isaf023"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf023
            
            #add-point:AFTER FIELD isaf023 name="input.a.isaf023"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf023
            #add-point:ON CHANGE isaf023 name="input.g.isaf023"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf024
            #add-point:BEFORE FIELD isaf024 name="input.b.isaf024"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf024
            
            #add-point:AFTER FIELD isaf024 name="input.a.isaf024"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf024
            #add-point:ON CHANGE isaf024 name="input.g.isaf024"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf025
            #add-point:BEFORE FIELD isaf025 name="input.b.isaf025"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf025
            
            #add-point:AFTER FIELD isaf025 name="input.a.isaf025"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf025
            #add-point:ON CHANGE isaf025 name="input.g.isaf025"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf026
            #add-point:BEFORE FIELD isaf026 name="input.b.isaf026"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf026
            
            #add-point:AFTER FIELD isaf026 name="input.a.isaf026"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf026
            #add-point:ON CHANGE isaf026 name="input.g.isaf026"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf045
            #add-point:BEFORE FIELD isaf045 name="input.b.isaf045"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf045
            
            #add-point:AFTER FIELD isaf045 name="input.a.isaf045"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf045
            #add-point:ON CHANGE isaf045 name="input.g.isaf045"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf027
            #add-point:BEFORE FIELD isaf027 name="input.b.isaf027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf027
            
            #add-point:AFTER FIELD isaf027 name="input.a.isaf027"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf027
            #add-point:ON CHANGE isaf027 name="input.g.isaf027"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf028
            #add-point:BEFORE FIELD isaf028 name="input.b.isaf028"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf028
            
            #add-point:AFTER FIELD isaf028 name="input.a.isaf028"
            #161129-00042#1-add(s)
            LET l_ooef011 = ' '
            SELECT ooef011 INTO l_ooef011 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_isaf_m.isafcomp
            IF l_ooef011 = 'TW' THEN
               IF NOT cl_null(g_isaf_m.isaf028) THEN
                  #先檢查輸入的營利事業統一編號是否為8碼或都為數字
                  CALL s_rule_chk_vat_id_string(g_isaf_m.isaf028) RETURNING l_success
                  IF NOT l_success THEN
                     LET g_isaf_m.isaf028 = g_isaf_m_o.isaf028
                     NEXT FIELD isaf028
                  END IF
                  #檢查營利事業統一編號邏輯
                  CALL s_rule_chk_vat_id(l_ooef011,g_isaf_m.isaf028) RETURNING l_success
                  IF NOT l_success THEN
                     LET g_isaf_m.isaf028 = g_isaf_m.isaf028
                  END IF
               END IF   
            END IF
            #161129-00042#1-add(e)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf028
            #add-point:ON CHANGE isaf028 name="input.g.isaf028"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf029
            #add-point:BEFORE FIELD isaf029 name="input.b.isaf029"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf029
            
            #add-point:AFTER FIELD isaf029 name="input.a.isaf029"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf029
            #add-point:ON CHANGE isaf029 name="input.g.isaf029"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf030
            #add-point:BEFORE FIELD isaf030 name="input.b.isaf030"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf030
            
            #add-point:AFTER FIELD isaf030 name="input.a.isaf030"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf030
            #add-point:ON CHANGE isaf030 name="input.g.isaf030"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf031
            #add-point:BEFORE FIELD isaf031 name="input.b.isaf031"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf031
            
            #add-point:AFTER FIELD isaf031 name="input.a.isaf031"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf031
            #add-point:ON CHANGE isaf031 name="input.g.isaf031"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf032
            #add-point:BEFORE FIELD isaf032 name="input.b.isaf032"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf032
            
            #add-point:AFTER FIELD isaf032 name="input.a.isaf032"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf032
            #add-point:ON CHANGE isaf032 name="input.g.isaf032"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf046
            #add-point:BEFORE FIELD isaf046 name="input.b.isaf046"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf046
            
            #add-point:AFTER FIELD isaf046 name="input.a.isaf046"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf046
            #add-point:ON CHANGE isaf046 name="input.g.isaf046"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf103
            #add-point:BEFORE FIELD isaf103 name="input.b.isaf103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf103
            
            #add-point:AFTER FIELD isaf103 name="input.a.isaf103"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf103
            #add-point:ON CHANGE isaf103 name="input.g.isaf103"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf104
            #add-point:BEFORE FIELD isaf104 name="input.b.isaf104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf104
            
            #add-point:AFTER FIELD isaf104 name="input.a.isaf104"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf104
            #add-point:ON CHANGE isaf104 name="input.g.isaf104"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf105
            #add-point:BEFORE FIELD isaf105 name="input.b.isaf105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf105
            
            #add-point:AFTER FIELD isaf105 name="input.a.isaf105"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf105
            #add-point:ON CHANGE isaf105 name="input.g.isaf105"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf106
            #add-point:BEFORE FIELD isaf106 name="input.b.isaf106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf106
            
            #add-point:AFTER FIELD isaf106 name="input.a.isaf106"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf106
            #add-point:ON CHANGE isaf106 name="input.g.isaf106"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf107
            #add-point:BEFORE FIELD isaf107 name="input.b.isaf107"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf107
            
            #add-point:AFTER FIELD isaf107 name="input.a.isaf107"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf107
            #add-point:ON CHANGE isaf107 name="input.g.isaf107"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf108
            #add-point:BEFORE FIELD isaf108 name="input.b.isaf108"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf108
            
            #add-point:AFTER FIELD isaf108 name="input.a.isaf108"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf108
            #add-point:ON CHANGE isaf108 name="input.g.isaf108"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf113
            #add-point:BEFORE FIELD isaf113 name="input.b.isaf113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf113
            
            #add-point:AFTER FIELD isaf113 name="input.a.isaf113"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf113
            #add-point:ON CHANGE isaf113 name="input.g.isaf113"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf114
            #add-point:BEFORE FIELD isaf114 name="input.b.isaf114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf114
            
            #add-point:AFTER FIELD isaf114 name="input.a.isaf114"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf114
            #add-point:ON CHANGE isaf114 name="input.g.isaf114"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf115
            #add-point:BEFORE FIELD isaf115 name="input.b.isaf115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf115
            
            #add-point:AFTER FIELD isaf115 name="input.a.isaf115"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf115
            #add-point:ON CHANGE isaf115 name="input.g.isaf115"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf116
            #add-point:BEFORE FIELD isaf116 name="input.b.isaf116"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf116
            
            #add-point:AFTER FIELD isaf116 name="input.a.isaf116"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf116
            #add-point:ON CHANGE isaf116 name="input.g.isaf116"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf117
            #add-point:BEFORE FIELD isaf117 name="input.b.isaf117"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf117
            
            #add-point:AFTER FIELD isaf117 name="input.a.isaf117"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf117
            #add-point:ON CHANGE isaf117 name="input.g.isaf117"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf118
            #add-point:BEFORE FIELD isaf118 name="input.b.isaf118"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf118
            
            #add-point:AFTER FIELD isaf118 name="input.a.isaf118"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf118
            #add-point:ON CHANGE isaf118 name="input.g.isaf118"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf119
            #add-point:BEFORE FIELD isaf119 name="input.b.isaf119"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf119
            
            #add-point:AFTER FIELD isaf119 name="input.a.isaf119"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf119
            #add-point:ON CHANGE isaf119 name="input.g.isaf119"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf120
            #add-point:BEFORE FIELD isaf120 name="input.b.isaf120"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf120
            
            #add-point:AFTER FIELD isaf120 name="input.a.isaf120"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf120
            #add-point:ON CHANGE isaf120 name="input.g.isaf120"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf121
            #add-point:BEFORE FIELD isaf121 name="input.b.isaf121"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf121
            
            #add-point:AFTER FIELD isaf121 name="input.a.isaf121"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf121
            #add-point:ON CHANGE isaf121 name="input.g.isaf121"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf033
            #add-point:BEFORE FIELD isaf033 name="input.b.isaf033"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf033
            
            #add-point:AFTER FIELD isaf033 name="input.a.isaf033"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf033
            #add-point:ON CHANGE isaf033 name="input.g.isaf033"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf034
            #add-point:BEFORE FIELD isaf034 name="input.b.isaf034"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf034
            
            #add-point:AFTER FIELD isaf034 name="input.a.isaf034"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf034
            #add-point:ON CHANGE isaf034 name="input.g.isaf034"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf035
            #add-point:BEFORE FIELD isaf035 name="input.b.isaf035"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf035
            
            #add-point:AFTER FIELD isaf035 name="input.a.isaf035"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf035
            #add-point:ON CHANGE isaf035 name="input.g.isaf035"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf048
            #add-point:BEFORE FIELD isaf048 name="input.b.isaf048"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf048
            
            #add-point:AFTER FIELD isaf048 name="input.a.isaf048"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf048
            #add-point:ON CHANGE isaf048 name="input.g.isaf048"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf049
            #add-point:BEFORE FIELD isaf049 name="input.b.isaf049"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf049
            
            #add-point:AFTER FIELD isaf049 name="input.a.isaf049"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf049
            #add-point:ON CHANGE isaf049 name="input.g.isaf049"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf201
            
            #add-point:AFTER FIELD isaf201 name="input.a.isaf201"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf201) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isaf_m.isaf201

                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_3801") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 

               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf201 = g_isaf_m_t.isaf201
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF
            

            END IF 
            

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf201
            #add-point:BEFORE FIELD isaf201 name="input.b.isaf201"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf201
            #add-point:ON CHANGE isaf201 name="input.g.isaf201"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf202
            
            #add-point:AFTER FIELD isaf202 name="input.a.isaf202"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf202) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isaf_m.isaf202

                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_3802") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 

               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf202 = g_isaf_m_t.isaf202
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF
            

            END IF 
            
            IF NOT cl_null(g_isaf_m.isaf207) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isaf_m.isaf207
               LET g_chkparam.arg2 = g_isaf_m.isaf202
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_3803") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 

               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf207 = ''
                  CALL aist310_ref_show()
                  NEXT FIELD isaf207
               END IF
            

            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf202
            #add-point:BEFORE FIELD isaf202 name="input.b.isaf202"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf202
            #add-point:ON CHANGE isaf202 name="input.g.isaf202"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf203
            #add-point:BEFORE FIELD isaf203 name="input.b.isaf203"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf203
            
            #add-point:AFTER FIELD isaf203 name="input.a.isaf203"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf203
            #add-point:ON CHANGE isaf203 name="input.g.isaf203"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf204
            #add-point:BEFORE FIELD isaf204 name="input.b.isaf204"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf204
            
            #add-point:AFTER FIELD isaf204 name="input.a.isaf204"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf204
            #add-point:ON CHANGE isaf204 name="input.g.isaf204"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf207
            
            #add-point:AFTER FIELD isaf207 name="input.a.isaf207"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf207) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isaf_m.isaf207
               LET g_chkparam.arg2 = g_isaf_m.isaf202
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_3803") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 

               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf207 = g_isaf_m_t.isaf207
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF
            

            END IF 
            

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf207
            #add-point:BEFORE FIELD isaf207 name="input.b.isaf207"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf207
            #add-point:ON CHANGE isaf207 name="input.g.isaf207"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf205
            #add-point:BEFORE FIELD isaf205 name="input.b.isaf205"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf205
            
            #add-point:AFTER FIELD isaf205 name="input.a.isaf205"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf205
            #add-point:ON CHANGE isaf205 name="input.g.isaf205"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf206
            #add-point:BEFORE FIELD isaf206 name="input.b.isaf206"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf206
            
            #add-point:AFTER FIELD isaf206 name="input.a.isaf206"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf206
            #add-point:ON CHANGE isaf206 name="input.g.isaf206"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf037
            
            #add-point:AFTER FIELD isaf037 name="input.a.isaf037"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf037) THEN
               INITIALIZE g_chkparam.* TO NULL
               LET g_chkparam.arg1 = g_isaf_m.isaf037
               IF cl_chk_exist("v_oocq002_3804") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME
               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf037 = g_isaf_m_t.isaf037
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf037
            #add-point:BEFORE FIELD isaf037 name="input.b.isaf037"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf037
            #add-point:ON CHANGE isaf037 name="input.g.isaf037"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf038
            #add-point:BEFORE FIELD isaf038 name="input.b.isaf038"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf038
            
            #add-point:AFTER FIELD isaf038 name="input.a.isaf038"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf038
            #add-point:ON CHANGE isaf038 name="input.g.isaf038"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf039
            #add-point:BEFORE FIELD isaf039 name="input.b.isaf039"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf039
            
            #add-point:AFTER FIELD isaf039 name="input.a.isaf039"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf039
            #add-point:ON CHANGE isaf039 name="input.g.isaf039"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf040
            #add-point:BEFORE FIELD isaf040 name="input.b.isaf040"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf040
            
            #add-point:AFTER FIELD isaf040 name="input.a.isaf040"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf040
            #add-point:ON CHANGE isaf040 name="input.g.isaf040"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf041
            
            #add-point:AFTER FIELD isaf041 name="input.a.isaf041"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf041) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isaf_m.isaf041
               LET g_chkparam.err_str[1] = "aim-00070:sub-01302|aooi130|",cl_get_progname("aooi130",g_lang,"2"),"|:EXEPROGaooi130"#要執行的建議程式待補 #160318-00025#30  add
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooag001") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 

               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf041 = g_isaf_m_t.isaf041
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF
            

            END IF 
            

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf041
            #add-point:BEFORE FIELD isaf041 name="input.b.isaf041"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf041
            #add-point:ON CHANGE isaf041 name="input.g.isaf041"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf042
            #add-point:BEFORE FIELD isaf042 name="input.b.isaf042"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf042
            
            #add-point:AFTER FIELD isaf042 name="input.a.isaf042"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf042
            #add-point:ON CHANGE isaf042 name="input.g.isaf042"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf055
            
            #add-point:AFTER FIELD isaf055 name="input.a.isaf055"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf055) THEN 
               IF g_isaf_m.isaf055 != g_isaf_m_o.isaf055 OR cl_null(g_isaf_m_o.isaf055) THEN #160822-00008#8
#此段落由子樣板a19產生
                  #校驗代值
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_isaf_m.isaf055
                  LET g_chkparam.err_str[1] = "apm-00044:sub-01302|apmm100|",cl_get_progname("apmm100",g_lang,"2"),"|:EXEPROGapmm100"#要執行的建議程式待補 #160318-00025#30  add
                     
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_pmaa001_2") THEN
                     #檢查成功時後續處理
                     #LET  = g_chkparam.return1
                     #DISPLAY BY NAME 
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_isaf_m.isaf055 = g_isaf_m_t.isaf055 #160822-00008#8 Mark
                     LET g_isaf_m.isaf055 = g_isaf_m_o.isaf055  #160822-00008#8
                     CALL aist310_ref_show()
                     NEXT FIELD CURRENT
                  END IF
               END IF #160822-00008#8
               
            END IF 
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf055
            #add-point:BEFORE FIELD isaf055 name="input.b.isaf055"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf055
            #add-point:ON CHANGE isaf055 name="input.g.isaf055"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf007
            #add-point:BEFORE FIELD isaf007 name="input.b.isaf007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf007
            
            #add-point:AFTER FIELD isaf007 name="input.a.isaf007"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf007
            #add-point:ON CHANGE isaf007 name="input.g.isaf007"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf006
            
            #add-point:AFTER FIELD isaf006 name="input.a.isaf006"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf006) THEN    
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL      
               LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isaf_m.isaf006
               LET g_chkparam.err_str[1] = "aoo-00095:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"#要執行的建議程式待補 #160318-00025#30  add
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooef001") THEN
                  #檢查成功時後續處理
               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf006 = g_isaf_m_t.isaf006
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF
               
               #161006-00005#29   add---s
               LET l_count = NULL
               SELECT count(1) INTO l_count 
                 FROM isao_t,ooef_t
                WHERE isaoent  = ooefent
                  AND ooefent = g_enterprise
                  AND ooef001 = g_isaf_m.isaf006
                  AND isaostus = 'Y'
                  
               IF cl_null(l_count) THEN LET l_count = 0 END IF 
                  
               IF l_count = 0 THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'aap-00115'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_isaf_m.isaf006 = g_isaf_m_t.isaf006
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF 

               CALL s_fin_apcborga_chk(g_isaf_m.isafsite,g_isaf_m.isafcomp,g_isaf_m.isaf006,today,'3') 
                    RETURNING g_sub_success,g_errno
      
               IF NOT g_sub_success THEN
                  LET g_errparam.code = g_errno
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_isaf_m.isaf006 = g_isaf_m_t.isaf006
                  CALL aist310_ref_show()
                  NEXT FIELD CURRENT
               END IF
               #161006-00005#29   add---e
            END IF 
            

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf006
            #add-point:BEFORE FIELD isaf006 name="input.b.isaf006"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf006
            #add-point:ON CHANGE isaf006 name="input.g.isaf006"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf050
            #add-point:BEFORE FIELD isaf050 name="input.b.isaf050"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf050
            
            #add-point:AFTER FIELD isaf050 name="input.a.isaf050"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf050
            #add-point:ON CHANGE isaf050 name="input.g.isaf050"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf004
            
            #add-point:AFTER FIELD isaf004 name="input.a.isaf004"
            CALL aist310_ref_show()
            IF NOT cl_null(g_isaf_m.isaf004) THEN  
               IF g_isaf_m.isaf004 != g_isaf_m_o.isaf004 OR cl_null(g_isaf_m_o.isaf004) THEN #160822-00008#8 
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL      
                  LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_isaf_m.isaf004
                  LET g_chkparam.err_str[1] = "aoo-00095:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"#要執行的建議程式待補 #160318-00025#30  add
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_ooef001") THEN
                     #檢查成功時後續處理
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_isaf_m.isaf004 = g_isaf_m_t.isaf004 #160822-00008#8 Mark
                     LET g_isaf_m.isaf004 = g_isaf_m_o.isaf004  #160822-00008#8
                     CALL aist310_ref_show()
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF 
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf004
            #add-point:BEFORE FIELD isaf004 name="input.b.isaf004"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf004
            #add-point:ON CHANGE isaf004 name="input.g.isaf004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf044
            #add-point:BEFORE FIELD isaf044 name="input.b.isaf044"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf044
            
            #add-point:AFTER FIELD isaf044 name="input.a.isaf044"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf044
            #add-point:ON CHANGE isaf044 name="input.g.isaf044"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf066
            #add-point:BEFORE FIELD isaf066 name="input.b.isaf066"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf066
            
            #add-point:AFTER FIELD isaf066 name="input.a.isaf066"
            #150904-00006#2 add ------
            IF NOT cl_null(g_isaf_m.isaf066) THEN
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isaf_m.isaf066 != g_isaf_m_t.isaf066 OR g_isaf_m_t.isaf066 IS NULL )) THEN #160822-00008#8 Mark
               IF g_isaf_m.isaf066 != g_isaf_m_o.isaf066 OR cl_null(g_isaf_m_o.isaf066) THEN #160822-00008#8
                  #151029-00001#3 mark ------
                  ##檢核是否存在Invoice(axmt620)
                  #LET l_cnt = 0
                  #SELECT COUNT(*) INTO l_cnt
                  #  FROM xmdo_t
                  # WHERE xmdoent = g_enterprise
                  #   AND xmdodocno = g_isaf_m.isaf066
                  #   AND xmdostus = 'Y'
                  #IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                  #IF l_cnt = 0 THEN
                  #   INITIALIZE g_errparam TO NULL
                  #   LET g_errparam.code = 'ais-00239'
                  #   LET g_errparam.extend = ''
                  #   LET g_errparam.popup = TRUE
                  #   CALL cl_err()
                  #   LET g_isaf_m.isaf066 = g_isaf_m_t.isaf066
                  #   NEXT FIELD CURRENT
                  #END IF
                  #151029-00001#3 mark end---
                  
                  #檢核是否有別張對帳單(aist310)使用
                  LET l_cnt = 0
                  #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
                  SELECT COUNT(1) INTO l_cnt #160907-00046#1
                    FROM isaf_t
                   WHERE isafent = g_enterprise
                     AND isaf066 = g_isaf_m.isaf066
                     AND isafstus <> 'X'
                  IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                  IF l_cnt > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00240'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     #LET g_isaf_m.isaf066 = g_isaf_m_t.isaf066 #160822-00008#8 Mark
                     LET g_isaf_m.isaf066 = g_isaf_m_o.isaf066  #160822-00008#8
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            #150904-00006#2 add end---
            LET g_isaf_m_o.* = g_isaf_m.*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf066
            #add-point:ON CHANGE isaf066 name="input.g.isaf066"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf019
            
            #add-point:AFTER FIELD isaf019 name="input.a.isaf019"
 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf019
            #add-point:BEFORE FIELD isaf019 name="input.b.isaf019"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf019
            #add-point:ON CHANGE isaf019 name="input.g.isaf019"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf059
            #add-point:BEFORE FIELD isaf059 name="input.b.isaf059"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf059
            
            #add-point:AFTER FIELD isaf059 name="input.a.isaf059"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf059
            #add-point:ON CHANGE isaf059 name="input.g.isaf059"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf060
            #add-point:BEFORE FIELD isaf060 name="input.b.isaf060"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf060
            
            #add-point:AFTER FIELD isaf060 name="input.a.isaf060"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf060
            #add-point:ON CHANGE isaf060 name="input.g.isaf060"
            
            CALL cl_set_comp_entry('isaf061,isaf062,isaf063,isaf064',TRUE)            
            CASE 
               WHEN g_isaf_m.isaf060 = '1'        
                  LET g_isaf_m.isaf063 = ''
                  LET g_isaf_m.isaf064 = ''
                  CALL cl_set_comp_entry('isaf063,isaf064',FALSE)
                  DISPLAY BY NAME g_isaf_m.isaf063,g_isaf_m.isaf064 

                  #150915-00009#3-----s
                  #非經海關出口預設值
                  IF cl_null(g_isaf_m.isaf061)THEN
                     LET g_isaf_m.isaf061 = 'REF'
                  END IF
                  
                  IF cl_null(g_isaf_m.isaf062)THEN
                     LET g_isaf_m.isaf062 = g_isaf_m.isaf066
                  END IF                  
                  DISPLAY BY NAME g_isaf_m.isaf061,g_isaf_m.isaf062
                  #150915-00009#3-----e
               WHEN g_isaf_m.isaf060 = '2'  
                  LET g_isaf_m.isaf061 = ''
                  LET g_isaf_m.isaf062 = ''
                  CALL cl_set_comp_entry('isaf061,isaf062',FALSE)
                  DISPLAY BY NAME g_isaf_m.isaf061,g_isaf_m.isaf062  
               OTHERWISE
                  CALL cl_set_comp_entry('isaf061,isaf062,isaf063,isaf064',TRUE)                   
            END CASE
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf061
            #add-point:BEFORE FIELD isaf061 name="input.b.isaf061"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf061
            
            #add-point:AFTER FIELD isaf061 name="input.a.isaf061"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf061
            #add-point:ON CHANGE isaf061 name="input.g.isaf061"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf063
            #add-point:BEFORE FIELD isaf063 name="input.b.isaf063"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf063
            
            #add-point:AFTER FIELD isaf063 name="input.a.isaf063"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf063
            #add-point:ON CHANGE isaf063 name="input.g.isaf063"
           
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf062
            #add-point:BEFORE FIELD isaf062 name="input.b.isaf062"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf062
            
            #add-point:AFTER FIELD isaf062 name="input.a.isaf062"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf062
            #add-point:ON CHANGE isaf062 name="input.g.isaf062"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf064
            #add-point:BEFORE FIELD isaf064 name="input.b.isaf064"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf064
            
            #add-point:AFTER FIELD isaf064 name="input.a.isaf064"
            IF NOT cl_null(g_isaf_m.isaf064) THEN            
               CALL s_chr_chk_str(g_isaf_m.isaf064,'14','')RETURNING g_sub_success
               IF NOT g_sub_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = "ais-00217"
                  LET g_errparam.extend = g_isaf_m.isaf051
                  LET g_errparam.popup = TRUE
                  CALL cl_err()                   
                  LET g_isaf_m.isaf064 = ''
                  NEXT FIELD CURRENT  
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf064
            #add-point:ON CHANGE isaf064 name="input.g.isaf064"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf065
            #add-point:BEFORE FIELD isaf065 name="input.b.isaf065"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf065
            
            #add-point:AFTER FIELD isaf065 name="input.a.isaf065"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf065
            #add-point:ON CHANGE isaf065 name="input.g.isaf065"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf208
            #add-point:BEFORE FIELD isaf208 name="input.b.isaf208"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf208
            
            #add-point:AFTER FIELD isaf208 name="input.a.isaf208"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf208
            #add-point:ON CHANGE isaf208 name="input.g.isaf208"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf209
            #add-point:BEFORE FIELD isaf209 name="input.b.isaf209"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf209
            
            #add-point:AFTER FIELD isaf209 name="input.a.isaf209"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf209
            #add-point:ON CHANGE isaf209 name="input.g.isaf209"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isaf210
            
            #add-point:AFTER FIELD isaf210 name="input.a.isaf210"
            

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isaf210
            #add-point:BEFORE FIELD isaf210 name="input.b.isaf210"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isaf210
            #add-point:ON CHANGE isaf210 name="input.g.isaf210"
            
            #END add-point 
 
 
 #欄位檢查
                  #Ctrlp:input.c.isafsite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafsite
            #add-point:ON ACTION controlp INFIELD isafsite name="input.c.isafsite"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isafsite             #給予default值
            LET g_qryparam.default2 = "" #g_isaf_m.ooefl003 #說明(簡稱)
            #給予arg
            LET g_qryparam.arg1 = "" #

            
            #CALL q_ooef001()     #161006-00005#29   mark
            CALL q_ooef001_46()   #161006-00005#29   add                         

            LET g_isaf_m.isafsite = g_qryparam.return1              

            DISPLAY g_isaf_m.isafsite TO isafsite              #
            CALL aist310_ref_show()
            NEXT FIELD isafsite                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isafdocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafdocno
            #add-point:ON ACTION controlp INFIELD isafdocno name="input.c.isafdocno"
            #此段落由子樣板a07產生
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isaf_m.isafdocno
            LET l_glaa024 = ''
            SELECT glaa024 INTO l_glaa024 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_glaald
            LET g_qryparam.arg1 = l_glaa024
            #LET g_qryparam.arg2 = "aist310"     #160705-00042#6 160712 by sakura mark
            LET g_qryparam.arg2 = g_prog         #160705-00042#6 160712 by sakura add
             #161104-00046#3-----s
            IF NOT cl_null(g_user_slip_wc)THEN
               LET g_qryparam.where = g_user_slip_wc 
            END IF
            #161104-00046#3-----e
            CALL q_ooba002_1()
            LET g_isaf_m.isafdocno = g_qryparam.return1
            DISPLAY g_isaf_m.isafdocno TO isafdocno
            CALL aist310_ref_show()
            NEXT FIELD isafdocno
            #END add-point
 
 
         #Ctrlp:input.c.isaf001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf001
            #add-point:ON ACTION controlp INFIELD isaf001 name="input.c.isaf001"
            
            #END add-point
 
 
         #Ctrlp:input.c.isafcomp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafcomp
            #add-point:ON ACTION controlp INFIELD isafcomp name="input.c.isafcomp"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isafcomp             #給予default值
            #CALL s_fin_create_account_center_tmp()
            CALL s_fin_azzi800_sons_query(g_today)                  #160907-00041#1 add
            CALL s_fin_account_center_sons_query('3',g_isaf_m.isafsite,g_today,'')
            CALL s_fin_account_center_comp_str()RETURNING l_origin_str
            CALL aist310_change_to_sql(l_origin_str)RETURNING l_origin_str
            LET g_qryparam.where    = "ooef003 = 'Y' AND ooef001 IN(",l_origin_str CLIPPED,")"
            #給予arg
            LET g_qryparam.arg1 = "" #

            
            CALL q_ooef001()                                #呼叫開窗

            LET g_isaf_m.isafcomp = g_qryparam.return1              
            CALL aist310_ref_show() 
            CALL aist310_isafcomp_get()
            DISPLAY g_isaf_m.isafcomp TO isafcomp              #

            NEXT FIELD isafcomp                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isafdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafdocdt
            #add-point:ON ACTION controlp INFIELD isafdocdt name="input.c.isafdocdt"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf056
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf056
            #add-point:ON ACTION controlp INFIELD isaf056 name="input.c.isaf056"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf005
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf005
            #add-point:ON ACTION controlp INFIELD isaf005 name="input.c.isaf005"
#此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf005             #給予default值

            #給予arg

            CALL q_ooag001()                                #呼叫開窗

            LET g_isaf_m.isaf005 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_isaf_m.isaf005 TO isaf005              #顯示到畫面上
            LET g_isaf_m.isaf006 = g_site
            CALL aist310_ref_show()
            NEXT FIELD isaf005                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf057
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf057
            #add-point:ON ACTION controlp INFIELD isaf057 name="input.c.isaf057"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf057             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #

            
            CALL q_ooag001()                                #呼叫開窗

            LET g_isaf_m.isaf057 = g_qryparam.return1              

            DISPLAY g_isaf_m.isaf057 TO isaf057              #
            CALL aist310_ref_show()
            NEXT FIELD isaf057                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf003
            #add-point:ON ACTION controlp INFIELD isaf003 name="input.c.isaf003"
            #帳款客戶
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isaf_m.isaf003
            #151231-00010#3-----s
            LET g_qryparam.where = g_ctl_where
            #151231-00010#3-----e
            #CALL q_pmaa001()     #160920-00019#5--mark
            CALL q_pmaa001_13()   #160920-00019#5--add
            LET g_isaf_m.isaf003 = g_qryparam.return1
            DISPLAY g_isaf_m.isaf003 TO isaf003
            CALL aist310_ref_show()
            NEXT FIELD isaf003
            #END add-point
 
 
         #Ctrlp:input.c.isaf067
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf067
            #add-point:ON ACTION controlp INFIELD isaf067 name="input.c.isaf067"
            
            #END add-point
 
 
         #Ctrlp:input.c.isafstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isafstus
            #add-point:ON ACTION controlp INFIELD isafstus name="input.c.isafstus"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf008
            #add-point:ON ACTION controlp INFIELD isaf008 name="input.c.isaf008"
            #發票類型       
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isaf_m.isaf008
            IF g_isaf_m.isaf056 = '1' THEN
               LET g_qryparam.where = " isac001 = '",g_ooef019,"'",
                                      " AND isac003 = '2'"
            ELSE
               IF g_isai006 = 'N' THEN
                  LET g_qryparam.where = " isac001 = '",g_ooef019,"'",
                                         " AND isac003 = '4'"
               ELSE
                  LET g_qryparam.where = " isac001 = '",g_ooef019,"'",
                                         " AND (isac003 = '2' OR isac003 = '4')"
               END IF
            END IF
            #160712-00013#1-s
            IF NOT cl_null(g_isaf_m.isaf052) THEN
               LET g_qryparam.where = g_qryparam.where,
                                      " AND isac002 IN (SELECT isaq001 FROM isaq_t ",
                                      "                  WHERE isaqent = ",g_enterprise,
                                      "                    AND isaqsite ='",g_isaf_m.isaf052,"')"
            ELSE
               LET g_qryparam.where = g_qryparam.where,
                                      " AND isac002 IN (SELECT isaq001 FROM isaq_t ",
                                      "                  WHERE isaqent = ",g_enterprise,
                                      "                    AND isaqsite ='",g_isaf_m.isafcomp,"')"
            END IF
            #160712-00013#1-e
            CALL q_isac002()
            LET g_isaf_m.isaf008 = g_qryparam.return1
            DISPLAY g_isaf_m.isaf008 TO isaf008
            CALL aist310_ref_show()
            CALL aist310_isaf008_get()
            NEXT FIELD isaf008
            #END add-point
 
 
         #Ctrlp:input.c.isaf016
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf016
            #add-point:ON ACTION controlp INFIELD isaf016 name="input.c.isaf016"
            #稅別
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isaf_m.isaf016
            LET g_qryparam.where = " oodb004 = '1'"
            #160920-00013#1--s mark
            #160316-00017#2--add--str--lujh
            #IF g_isaf_m.isaf001 = '3' THEN 
            #   LET g_qryparam.where = g_qryparam.where," AND oodb005 = 'Y'"
            #END IF
            #160316-00017#2--add--end--lujh
            #160920-00013#1--e mark
            
            #160920-00032#1 mark-----s
            ##160920-00013#1--s
            #IF g_isaf_m.isaf001 <> '3' THEN 
            #   LET g_qryparam.where = g_qryparam.where," AND oodb005 = 'Y'"
            #END IF
            ##160920-00013#1--e
            #160920-00032#1 mark-----e
            LET g_qryparam.arg1 = g_ooef019
            CALL q_oodb002_5()
            LET g_isaf_m.isaf016 = g_qryparam.return1
            DISPLAY g_isaf_m.isaf016 TO isaf016
            CALL aist310_ref_show()
            NEXT FIELD isaf016
            #END add-point
 
 
         #Ctrlp:input.c.isaf014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf014
            #add-point:ON ACTION controlp INFIELD isaf014 name="input.c.isaf014"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf053
            #add-point:ON ACTION controlp INFIELD isaf053 name="input.c.isaf053"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf052
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf052
            #add-point:ON ACTION controlp INFIELD isaf052 name="input.c.isaf052"
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isaf_m.isaf052
            LET g_qryparam.default1 = g_isaf_m.isaf051
            IF cl_null(g_isaf_m.isaf014) THEN LET g_isaf_m.isaf014 = g_today END IF  #161102-00041#1
            LET g_qryparam.where = " isaesite IN ('",g_isaf_m.isaf052,"','",g_isaf_m.isafcomp,"' ) ",
                                   " AND isae004  = '",g_isaf_m.isaf008,"'",
                                   " AND isae002 <= '",g_isaf_m.isaf014,"'",
                                   " AND isae003 >= '",g_isaf_m.isaf014,"'",
                                   " AND isac001 = '",g_ooef019,"'"
            CALL q_isaesite_3()
            LET g_isaf_m.isaf052 = g_qryparam.return1
            LET g_isaf_m.isaf051 = g_qryparam.return2
            DISPLAY g_isaf_m.isaf052 TO isaf052
            CALL aist310_ref_show()
            CALL aist310_isaf051_get()
            NEXT FIELD isaf052
            #END add-point
 
 
         #Ctrlp:input.c.isaf018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf018
            #add-point:ON ACTION controlp INFIELD isaf018 name="input.c.isaf018"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf051
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf051
            #add-point:ON ACTION controlp INFIELD isaf051 name="input.c.isaf051"
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isaf_m.isaf051
            IF cl_null(g_isaf_m.isaf014) THEN LET g_isaf_m.isaf014 = g_today END IF  #161102-00041#1
            IF g_isaf_m.isaf056 = '2' AND g_isai006 = 'Y' THEN
               LET g_qryparam.where = " isaesite IN ('",g_isaf_m.isaf052,"','",g_isaf_m.isafcomp,"' ) ",
                                      " AND isae002 <= '",g_isaf_m.isaf014,"'",
                                      " AND isae003 >= '",g_isaf_m.isaf014,"'",
                                      " AND isac001 = '",g_ooef019,"'"
            ELSE
               LET g_qryparam.where = " isaesite IN ('",g_isaf_m.isaf052,"','",g_isaf_m.isafcomp,"' ) ",
                                      " AND isae004  = '",g_isaf_m.isaf008,"'",
                                      " AND isae002 <= '",g_isaf_m.isaf014,"'",
                                      " AND isae003 >= '",g_isaf_m.isaf014,"'",
                                      " AND isac001 = '",g_ooef019,"'"
            END IF
            CALL q_isaesite_3()
            LET g_isaf_m.isaf051 = g_qryparam.return2
            DISPLAY g_isaf_m.isaf051 TO isaf051
            CALL aist310_isaf051_get()
            CALL aist310_isae_get()
            NEXT FIELD isaf051
            #END add-point
 
 
         #Ctrlp:input.c.isaf009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf009
            #add-point:ON ACTION controlp INFIELD isaf009 name="input.c.isaf009"
             
            #END add-point
 
 
         #Ctrlp:input.c.isaf017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf017
            #add-point:ON ACTION controlp INFIELD isaf017 name="input.c.isaf017"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf010
            #add-point:ON ACTION controlp INFIELD isaf010 name="input.c.isaf010"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf012
            #add-point:ON ACTION controlp INFIELD isaf012 name="input.c.isaf012"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf100
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf100
            #add-point:ON ACTION controlp INFIELD isaf100 name="input.c.isaf100"
#此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf100             #給予default值

            #給予arg

            CALL q_aooi001_1()                                #呼叫開窗

            LET g_isaf_m.isaf100 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_isaf_m.isaf100 TO isaf100              #顯示到畫面上
            
            NEXT FIELD isaf100                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf011
            #add-point:ON ACTION controlp INFIELD isaf011 name="input.c.isaf011"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf101
            #add-point:ON ACTION controlp INFIELD isaf101 name="input.c.isaf101"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf054
            #add-point:ON ACTION controlp INFIELD isaf054 name="input.c.isaf054"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf002
            #add-point:ON ACTION controlp INFIELD isaf002 name="input.c.isaf002"
#此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf002             #給予default值

            #給予arg
            #151231-00010#3-----s
            LET g_qryparam.where = g_ctl_where
            #151231-00010#3-----e
            #CALL q_pmaa001()     #160920-00019#5--mark   
            CALL q_pmaa001_13()   #160920-00019#5--add

            LET g_isaf_m.isaf002 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_isaf_m.isaf002 TO isaf002              #顯示到畫面上
            CALL aist310_ref_show()
            #CALL aist310_isaf002_get() #160922-00055#2 mark 避免修改後的值,因預帶又蓋過,因此僅在有異動欄位時處理
            NEXT FIELD isaf002                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf021
            #add-point:ON ACTION controlp INFIELD isaf021 name="input.c.isaf021"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf022
            #add-point:ON ACTION controlp INFIELD isaf022 name="input.c.isaf022"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf023
            #add-point:ON ACTION controlp INFIELD isaf023 name="input.c.isaf023"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf024
            #add-point:ON ACTION controlp INFIELD isaf024 name="input.c.isaf024"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf025
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf025
            #add-point:ON ACTION controlp INFIELD isaf025 name="input.c.isaf025"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf026
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf026
            #add-point:ON ACTION controlp INFIELD isaf026 name="input.c.isaf026"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf045
            #add-point:ON ACTION controlp INFIELD isaf045 name="input.c.isaf045"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf027
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf027
            #add-point:ON ACTION controlp INFIELD isaf027 name="input.c.isaf027"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf028
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf028
            #add-point:ON ACTION controlp INFIELD isaf028 name="input.c.isaf028"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf029
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf029
            #add-point:ON ACTION controlp INFIELD isaf029 name="input.c.isaf029"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf030
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf030
            #add-point:ON ACTION controlp INFIELD isaf030 name="input.c.isaf030"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf031
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf031
            #add-point:ON ACTION controlp INFIELD isaf031 name="input.c.isaf031"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf032
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf032
            #add-point:ON ACTION controlp INFIELD isaf032 name="input.c.isaf032"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf046
            #add-point:ON ACTION controlp INFIELD isaf046 name="input.c.isaf046"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf103
            #add-point:ON ACTION controlp INFIELD isaf103 name="input.c.isaf103"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf104
            #add-point:ON ACTION controlp INFIELD isaf104 name="input.c.isaf104"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf105
            #add-point:ON ACTION controlp INFIELD isaf105 name="input.c.isaf105"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf106
            #add-point:ON ACTION controlp INFIELD isaf106 name="input.c.isaf106"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf107
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf107
            #add-point:ON ACTION controlp INFIELD isaf107 name="input.c.isaf107"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf108
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf108
            #add-point:ON ACTION controlp INFIELD isaf108 name="input.c.isaf108"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf113
            #add-point:ON ACTION controlp INFIELD isaf113 name="input.c.isaf113"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf114
            #add-point:ON ACTION controlp INFIELD isaf114 name="input.c.isaf114"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf115
            #add-point:ON ACTION controlp INFIELD isaf115 name="input.c.isaf115"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf116
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf116
            #add-point:ON ACTION controlp INFIELD isaf116 name="input.c.isaf116"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf117
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf117
            #add-point:ON ACTION controlp INFIELD isaf117 name="input.c.isaf117"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf118
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf118
            #add-point:ON ACTION controlp INFIELD isaf118 name="input.c.isaf118"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf119
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf119
            #add-point:ON ACTION controlp INFIELD isaf119 name="input.c.isaf119"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf120
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf120
            #add-point:ON ACTION controlp INFIELD isaf120 name="input.c.isaf120"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf121
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf121
            #add-point:ON ACTION controlp INFIELD isaf121 name="input.c.isaf121"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf033
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf033
            #add-point:ON ACTION controlp INFIELD isaf033 name="input.c.isaf033"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf034
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf034
            #add-point:ON ACTION controlp INFIELD isaf034 name="input.c.isaf034"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf035
            #add-point:ON ACTION controlp INFIELD isaf035 name="input.c.isaf035"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf048
            #add-point:ON ACTION controlp INFIELD isaf048 name="input.c.isaf048"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf049
            #add-point:ON ACTION controlp INFIELD isaf049 name="input.c.isaf049"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf201
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf201
            #add-point:ON ACTION controlp INFIELD isaf201 name="input.c.isaf201"
#此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf201             #給予default值

            #給予arg
            LET g_qryparam.arg1 = '3801'

            CALL q_oocq002()                                #呼叫開窗

            LET g_isaf_m.isaf201 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_isaf_m.isaf201 TO isaf201              #顯示到畫面上
            CALL aist310_ref_show()
            NEXT FIELD isaf201                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf202
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf202
            #add-point:ON ACTION controlp INFIELD isaf202 name="input.c.isaf202"
#此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf202             #給予default值

            #給予arg
            LET g_qryparam.arg1 = '3802'

            CALL q_oocq002()                                #呼叫開窗

            LET g_isaf_m.isaf202 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_isaf_m.isaf202 TO isaf202              #顯示到畫面上
            CALL aist310_ref_show()
            NEXT FIELD isaf202                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf203
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf203
            #add-point:ON ACTION controlp INFIELD isaf203 name="input.c.isaf203"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf204
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf204
            #add-point:ON ACTION controlp INFIELD isaf204 name="input.c.isaf204"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf207
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf207
            #add-point:ON ACTION controlp INFIELD isaf207 name="input.c.isaf207"
#此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf207             #給予default值
            IF NOT cl_null(g_isaf_m.isaf202) THEN
               LET g_qryparam.where = " oocq004 = '",g_isaf_m.isaf202,"'"
            END IF
            #給予arg
            LET g_qryparam.arg1 = '3803'

            CALL q_oocq002()                                #呼叫開窗

            LET g_isaf_m.isaf207 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_isaf_m.isaf207 TO isaf207              #顯示到畫面上
            CALL aist310_ref_show()
            NEXT FIELD isaf207                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf205
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf205
            #add-point:ON ACTION controlp INFIELD isaf205 name="input.c.isaf205"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf206
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf206
            #add-point:ON ACTION controlp INFIELD isaf206 name="input.c.isaf206"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf037
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf037
            #add-point:ON ACTION controlp INFIELD isaf037 name="input.c.isaf037"
            #此段落由子樣板a07產生
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isaf_m.isaf037
            LET g_qryparam.arg1 = '3804'
            CALL q_oocq002()
            LET g_isaf_m.isaf037 = g_qryparam.return1
            DISPLAY g_isaf_m.isaf037 TO isaf037
            CALL aist310_ref_show()
            NEXT FIELD isaf037
            #END add-point
 
 
         #Ctrlp:input.c.isaf038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf038
            #add-point:ON ACTION controlp INFIELD isaf038 name="input.c.isaf038"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf039
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf039
            #add-point:ON ACTION controlp INFIELD isaf039 name="input.c.isaf039"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf040
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf040
            #add-point:ON ACTION controlp INFIELD isaf040 name="input.c.isaf040"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf041
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf041
            #add-point:ON ACTION controlp INFIELD isaf041 name="input.c.isaf041"
#此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf041             #給予default值

            #給予arg

            CALL q_ooag001()                                #呼叫開窗

            LET g_isaf_m.isaf041 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_isaf_m.isaf041 TO isaf041              #顯示到畫面上
            CALL aist310_ref_show()
            NEXT FIELD isaf041                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf042
            #add-point:ON ACTION controlp INFIELD isaf042 name="input.c.isaf042"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf055
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf055
            #add-point:ON ACTION controlp INFIELD isaf055 name="input.c.isaf055"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf055             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #

            #151231-00010#3-----s
            LET g_qryparam.where = g_ctl_where 
            #151231-00010#3-----e
            #CALL q_pmaa001()     #160920-00019#5--mark   
            CALL q_pmaa001_13()   #160920-00019#5--add

            LET g_isaf_m.isaf055 = g_qryparam.return1              

            DISPLAY g_isaf_m.isaf055 TO isaf055              #
            CALL aist310_ref_show()
            NEXT FIELD isaf055                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf007
            #add-point:ON ACTION controlp INFIELD isaf007 name="input.c.isaf007"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf006
            #add-point:ON ACTION controlp INFIELD isaf006 name="input.c.isaf006"
#此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isaf_m.isaf006             #給予default值

            #給予arg
            #161006-00005#29   add---s
			   LET g_qryparam.where = " EXISTS (SELECT 1 FROM isao_t WHERE isaoent = ooefent",
                                      " AND isaosite = ooef001 AND isaostus = 'Y' ",
                                               ") ",
                                      " AND ooef201= 'Y'" ,
                                      " AND ooef001 IN ",g_wc_isagorga
            #161006-00005#29   add---e
            CALL q_ooef001()                                #呼叫開窗

            LET g_isaf_m.isaf006 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_isaf_m.isaf006 TO isaf006              #顯示到畫面上
            CALL aist310_ref_show()
            NEXT FIELD isaf006                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.isaf050
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf050
            #add-point:ON ACTION controlp INFIELD isaf050 name="input.c.isaf050"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf004
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf004
            #add-point:ON ACTION controlp INFIELD isaf004 name="input.c.isaf004"
            ##業務部門
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isaf_m.isaf004
            LET g_qryparam.arg1 = g_today  #161006-00005#29 add
            #CALL q_ooef001()              #161006-00005#29   mark
            #LET g_qryparam.where = " ooegstus = 'Y' AND ooeg009 = '",g_isaf_m.isafcomp,"'" #161017-00005#1 add #170111-00031#1 mark
            LET g_qryparam.where = " ooeg009 = '",g_isaf_m.isafcomp,"'" #170111-00031#1
            CALL q_ooeg001_4() #161006-00005#29 add
            LET g_isaf_m.isaf004 = g_qryparam.return1
            DISPLAY g_isaf_m.isaf004 TO isaf004
            CALL aist310_ref_show()
            NEXT FIELD isaf004
            #END add-point
 
 
         #Ctrlp:input.c.isaf044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf044
            #add-point:ON ACTION controlp INFIELD isaf044 name="input.c.isaf044"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf066
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf066
            #add-point:ON ACTION controlp INFIELD isaf066 name="input.c.isaf066"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf019
            #add-point:ON ACTION controlp INFIELD isaf019 name="input.c.isaf019"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf059
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf059
            #add-point:ON ACTION controlp INFIELD isaf059 name="input.c.isaf059"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf060
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf060
            #add-point:ON ACTION controlp INFIELD isaf060 name="input.c.isaf060"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf061
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf061
            #add-point:ON ACTION controlp INFIELD isaf061 name="input.c.isaf061"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf063
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf063
            #add-point:ON ACTION controlp INFIELD isaf063 name="input.c.isaf063"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf062
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf062
            #add-point:ON ACTION controlp INFIELD isaf062 name="input.c.isaf062"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf064
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf064
            #add-point:ON ACTION controlp INFIELD isaf064 name="input.c.isaf064"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf065
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf065
            #add-point:ON ACTION controlp INFIELD isaf065 name="input.c.isaf065"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf208
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf208
            #add-point:ON ACTION controlp INFIELD isaf208 name="input.c.isaf208"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf209
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf209
            #add-point:ON ACTION controlp INFIELD isaf209 name="input.c.isaf209"
            
            #END add-point
 
 
         #Ctrlp:input.c.isaf210
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isaf210
            #add-point:ON ACTION controlp INFIELD isaf210 name="input.c.isaf210"
            
            #END add-point
 
 
 #欄位開窗
            
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
 
            #CALL cl_err_collect_show()      #錯誤訊息統整顯示
            #CALL cl_showmsg()
            DISPLAY BY NAME g_isaf_m.isafcomp,g_isaf_m.isafdocno
                        
            #add-point:單頭INPUT後 name="input.head.after_input"
            #160316-00017#2--add--str--lujh
            #160920-00013#1--s mark
            #IF g_isaf_m.isaf001 = '3' AND g_isaf_m.isaf017 = 'N' THEN 
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "" 
            #   LET g_errparam.code   = "ais-00311" 
            #   LET g_errparam.popup  = TRUE 
            #   CALL cl_err()
            #   NEXT FIELD isaf016
            #END IF
            #160920-00013#1--e mark
            #160316-00017#2--add--end--lujh
            #end add-point
                        
            IF p_cmd <> 'u' THEN
    
               CALL s_transaction_begin()
               
               #add-point:單頭新增前 name="input.head.b_insert"
               CALL s_aooi200_fin_gen_docno(g_glaald,'','',g_isaf_m.isafdocno,g_isaf_m.isafdocdt,g_prog)
               RETURNING l_success,g_isaf_m.isafdocno
               IF l_success  = 0  THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'apm-00003'
                  LET g_errparam.extend = g_isaf_m.isafdocno
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  RETURN
               END IF 
               DISPLAY BY NAME g_isaf_m.isafdocno
               #161206-00042#2-----s
               UPDATE pmak_t SET pmak006 = g_isaf_m.isafdocno
                WHERE pmakent = g_enterprise AND pmak001 = g_isaf_m.isaf067
               #161206-00042#2-----e
               #end add-point
               
               INSERT INTO isaf_t (isafent,isafsite,isafdocno,isaf001,isafcomp,isafdocdt,isaf056,isaf005, 
                   isaf057,isaf003,isaf067,isafstus,isaf008,isaf016,isaf014,isaf053,isaf052,isaf018, 
                   isaf051,isaf009,isaf017,isaf010,isaf012,isaf100,isaf011,isaf101,isaf054,isaf002,isaf021, 
                   isaf022,isaf023,isaf024,isaf025,isaf026,isaf045,isaf027,isaf028,isaf029,isaf030,isaf031, 
                   isaf032,isaf046,isaf103,isaf104,isaf105,isaf106,isaf107,isaf108,isaf113,isaf114,isaf115, 
                   isaf116,isaf117,isaf118,isaf119,isaf120,isaf121,isaf033,isaf034,isaf035,isaf048,isaf049, 
                   isaf201,isaf202,isaf203,isaf204,isaf207,isaf205,isaf206,isaf037,isaf038,isaf039,isaf040, 
                   isaf041,isaf042,isaf055,isaf007,isaf006,isaf050,isaf004,isaf044,isaf066,isaf019,isaf059, 
                   isaf060,isaf061,isaf063,isaf062,isaf064,isaf065,isaf208,isaf209,isaf210,isafownid, 
                   isafowndp,isafcrtid,isafcrtdp,isafcrtdt,isafmodid,isafmoddt,isafcnfid,isafcnfdt)
               VALUES (g_enterprise,g_isaf_m.isafsite,g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp, 
                   g_isaf_m.isafdocdt,g_isaf_m.isaf056,g_isaf_m.isaf005,g_isaf_m.isaf057,g_isaf_m.isaf003, 
                   g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf016,g_isaf_m.isaf014, 
                   g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009, 
                   g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011, 
                   g_isaf_m.isaf101,g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022, 
                   g_isaf_m.isaf023,g_isaf_m.isaf024,g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045, 
                   g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031, 
                   g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104,g_isaf_m.isaf105, 
                   g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114, 
                   g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119, 
                   g_isaf_m.isaf120,g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035, 
                   g_isaf_m.isaf048,g_isaf_m.isaf049,g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203, 
                   g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf205,g_isaf_m.isaf206,g_isaf_m.isaf037, 
                   g_isaf_m.isaf038,g_isaf_m.isaf039,g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf042, 
                   g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf050,g_isaf_m.isaf004, 
                   g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059,g_isaf_m.isaf060, 
                   g_isaf_m.isaf061,g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065, 
                   g_isaf_m.isaf208,g_isaf_m.isaf209,g_isaf_m.isaf210,g_isaf_m.isafownid,g_isaf_m.isafowndp, 
                   g_isaf_m.isafcrtid,g_isaf_m.isafcrtdp,g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmoddt, 
                   g_isaf_m.isafcnfid,g_isaf_m.isafcnfdt) 
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "g_isaf_m:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE 
                  LET g_errparam.popup = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭新增中 name="input.head.m_insert"
               
               #end add-point
               
               
               
               
               #add-point:單頭新增後 name="input.head.a_insert"
               #CALL aist310_01(g_isaf_m.isafdocno,g_isaf_m.isafcomp)  #150603-00046#1 mark
               #CALL aist310_isaf_sum()                                #150603-00046#1 mark
               #end add-point
               CALL s_transaction_end('Y','0') 
               
               IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                  CALL aist310_detail_reproduce()
                  #因應特定程式需求, 重新刷新單身資料
                  CALL aist310_b_fill()
                  CALL aist310_b_fill2('0')
               END IF
               
               #add-point:單頭新增後 name="input.head.a_insert2"
               
               #end add-point
               
               LET g_master_insert = TRUE
               
               LET p_cmd = 'u'
            ELSE
               CALL s_transaction_begin()
            
               #add-point:單頭修改前 name="input.head.b_update"
               
               #end add-point
               
               #將遮罩欄位還原
               CALL aist310_isaf_t_mask_restore('restore_mask_o')
               
               UPDATE isaf_t SET (isafsite,isafdocno,isaf001,isafcomp,isafdocdt,isaf056,isaf005,isaf057, 
                   isaf003,isaf067,isafstus,isaf008,isaf016,isaf014,isaf053,isaf052,isaf018,isaf051, 
                   isaf009,isaf017,isaf010,isaf012,isaf100,isaf011,isaf101,isaf054,isaf002,isaf021,isaf022, 
                   isaf023,isaf024,isaf025,isaf026,isaf045,isaf027,isaf028,isaf029,isaf030,isaf031,isaf032, 
                   isaf046,isaf103,isaf104,isaf105,isaf106,isaf107,isaf108,isaf113,isaf114,isaf115,isaf116, 
                   isaf117,isaf118,isaf119,isaf120,isaf121,isaf033,isaf034,isaf035,isaf048,isaf049,isaf201, 
                   isaf202,isaf203,isaf204,isaf207,isaf205,isaf206,isaf037,isaf038,isaf039,isaf040,isaf041, 
                   isaf042,isaf055,isaf007,isaf006,isaf050,isaf004,isaf044,isaf066,isaf019,isaf059,isaf060, 
                   isaf061,isaf063,isaf062,isaf064,isaf065,isaf208,isaf209,isaf210,isafownid,isafowndp, 
                   isafcrtid,isafcrtdp,isafcrtdt,isafmodid,isafmoddt,isafcnfid,isafcnfdt) = (g_isaf_m.isafsite, 
                   g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt,g_isaf_m.isaf056, 
                   g_isaf_m.isaf005,g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus, 
                   g_isaf_m.isaf008,g_isaf_m.isaf016,g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052, 
                   g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009,g_isaf_m.isaf017,g_isaf_m.isaf010, 
                   g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101,g_isaf_m.isaf054, 
                   g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024, 
                   g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028, 
                   g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046, 
                   g_isaf_m.isaf103,g_isaf_m.isaf104,g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107, 
                   g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114,g_isaf_m.isaf115,g_isaf_m.isaf116, 
                   g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120,g_isaf_m.isaf121, 
                   g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049, 
                   g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207, 
                   g_isaf_m.isaf205,g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039, 
                   g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007, 
                   g_isaf_m.isaf006,g_isaf_m.isaf050,g_isaf_m.isaf004,g_isaf_m.isaf044,g_isaf_m.isaf066, 
                   g_isaf_m.isaf019,g_isaf_m.isaf059,g_isaf_m.isaf060,g_isaf_m.isaf061,g_isaf_m.isaf063, 
                   g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208,g_isaf_m.isaf209, 
                   g_isaf_m.isaf210,g_isaf_m.isafownid,g_isaf_m.isafowndp,g_isaf_m.isafcrtid,g_isaf_m.isafcrtdp, 
                   g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmoddt,g_isaf_m.isafcnfid,g_isaf_m.isafcnfdt) 
 
                WHERE isafent = g_enterprise AND isafcomp = g_isafcomp_t
                  AND isafdocno = g_isafdocno_t
 
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "isaf_t:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE 
                  LET g_errparam.popup = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭修改中 name="input.head.m_update"
               #160824-00066#1 add--s 单头发票类型有变更，需同步更新单身的发票类型
               UPDATE isat_t SET isat001 = g_isaf_m.isaf008 
                WHERE isatent  = g_enterprise
                  AND isatcomp = g_isafcomp_t
                  AND isatdocno= g_isafdocno_t
               #160824-00066#1 add--e
               #161206-00042#2-----s
               UPDATE pmak_t SET pmak006 = g_isaf_m.isafdocno
                WHERE pmakent = g_enterprise AND pmak001 = g_isaf_m.isaf067
               #161206-00042#2-----e
               #end add-point
               
               
               
               
               #將遮罩欄位進行遮蔽
               CALL aist310_isaf_t_mask_restore('restore_mask_n')
               
               #修改歷程記錄(單頭修改)
               LET g_log1 = util.JSON.stringify(g_isaf_m_t)
               LET g_log2 = util.JSON.stringify(g_isaf_m)
               IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               ELSE
                  CALL s_transaction_end('Y','0')
               END IF
               
               #add-point:單頭修改後 name="input.head.a_update"
               #150603-00046#1 mark ------
               #SELECT COUNT(*) INTO l_n 
               #  FROM isag_t 
               # WHERE isagent = g_enterprise 
               #   AND isagdocno = g_isaf_m.isafdocno
               #   AND isagcomp = g_isaf_m.isafcomp
               #   
               #IF l_n = 0 THEN 
               #   CALL aist310_01(g_isaf_m.isafdocno,g_isaf_m.isafcomp)
               #   CALL aist310_isaf_sum()
               #END IF
               #150603-00046#1 mark end---
               #end add-point
            END IF
            
            LET g_master_commit = "Y"
            LET g_isafcomp_t = g_isaf_m.isafcomp
            LET g_isafdocno_t = g_isaf_m.isafdocno
 
            
      END INPUT
   
 
{</section>}
 
{<section id="aist310.input.body" >}
   
      #Page1 預設值產生於此處
      INPUT ARRAY g_isag_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                  INSERT ROW = l_allow_insert, 
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
 
         #自訂ACTION(detail_input,page_1)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body.before_input2"
            
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_isag_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aist310_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1',"))
            END IF
            LET g_loc = 'm'
            LET g_rec_b = g_isag_d.getLength()
            #add-point:資料輸入前 name="input.d.before_input"
            IF g_isaf_m.isaf050 = '1' THEN
               EXIT DIALOG
            END IF
            #150603-00046#1 add ------
            #單身沒資料就要開啟自動產生的視窗
            LET l_n = 0
            #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
            SELECT COUNT(1) INTO l_n #160907-00046#1
              FROM isag_t
             WHERE isagent = g_enterprise
               AND isagdocno = g_isaf_m.isafdocno
               AND isagcomp = g_isaf_m.isafcomp
            IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
            IF l_n = 0 AND l_isag_flag = 'N' THEN     #20160427 add AND l_isag_flag = 'N' lujh
               CALL aist310_01(g_isaf_m.isafdocno,g_isaf_m.isafcomp)
               CALL aist310_isaf_sum()
            END IF
            CALL aist310_show()
            #150603-00046#1 add end---
            #160826-00017#2 --s add
            #對帳單主畫面表尾合計
            CALL aist310_isaf_sum_button(g_isaf_m.isafcomp,g_isaf_m.isafdocno,'')
               RETURNING g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s,g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
            DISPLAY BY NAME g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s,g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
            #160826-00017#2 --e add
            #end add-point
         
         BEFORE ROW
            #add-point:modify段before row2 name="input.body.before_row2"
            
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_detail_idx_list[1] = l_ac
            LET g_current_page = 1
            
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist310_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE aist310_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_isag_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_isag_d[l_ac].isagseq IS NOT NULL
 
            THEN
               LET l_cmd='u'
               LET g_isag_d_t.* = g_isag_d[l_ac].*  #BACKUP
               LET g_isag_d_o.* = g_isag_d[l_ac].*  #BACKUP
               CALL aist310_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body.after_set_entry_b"
               
               #end add-point  
               CALL aist310_set_no_entry_b(l_cmd)
               IF NOT aist310_lock_b("isag_t","'1'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aist310_bcl INTO g_isag_d[l_ac].isagseq,g_isag_d[l_ac].isagorga,g_isag_d[l_ac].isag001, 
                      g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003,g_isag_d[l_ac].isag018,g_isag_d[l_ac].isag009, 
                      g_isag_d[l_ac].isag010,g_isag_d[l_ac].isag016,g_isag_d[l_ac].isag017,g_isag_d[l_ac].isag015, 
                      g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag008,g_isag_d[l_ac].isag012,g_isag_d[l_ac].isag004, 
                      g_isag_d[l_ac].isag005,g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104, 
                      g_isag_d[l_ac].isag105,g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115, 
                      g_isag_d[l_ac].isag116,g_isag_d[l_ac].isag117,g_isag_d[l_ac].isag013,g_isag_d[l_ac].isag014, 
                      g_isag_d[l_ac].isag011
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = g_isag_d_t.isagseq,":",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_isag_d_mask_o[l_ac].* =  g_isag_d[l_ac].*
                  CALL aist310_isag_t_mask()
                  LET g_isag_d_mask_n[l_ac].* =  g_isag_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL aist310_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body.before_row"
            CALL aist310_ref_b_1()
            CALL aist310_isag001_sel()
            CALL aist310_isag002_ref(g_isag_d[l_ac].isag009,g_isag_d[l_ac].isag010)
            IF NOT cl_null(g_isag_d[l_ac].isag002) THEN 
               CALL cl_set_comp_entry("isag012",FALSE)
            ELSE
               CALL cl_set_comp_entry("isag012",TRUE)
            END IF
            IF g_isag_d[l_ac].isag001 = '27' THEN
               CALL cl_set_comp_required('isag012,isag004,isag101',FALSE)
            ELSE
               CALL cl_set_comp_required('isag012,isag004,isag101',TRUE)
            END IF
            #160426-00013#2-s
            IF g_isag_d[l_ac].isag001 = '29' THEN
               IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN
                  CALL cl_set_comp_required("isag004,isag005,isag101,isag103,isag104",FALSE)
               ELSE
                  CALL cl_set_comp_required("isag004,isag005,isag101,isag103,isag104",FALSE)
               END IF
            END IF
            #160426-00013#2-e
            
            #160826-00017#2 --s add
            #對帳單主畫面表尾合計
            CALL aist310_isaf_sum_button(g_isaf_m.isafcomp,g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq)
               RETURNING g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s,g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
            DISPLAY BY NAME g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s,g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
            #160826-00017#2 --e add
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
        
         BEFORE INSERT  
            
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_isag_d[l_ac].* TO NULL 
            INITIALIZE g_isag_d_t.* TO NULL 
            INITIALIZE g_isag_d_o.* TO NULL 
            #公用欄位給值(單身)
            
            #自定義預設值
                  LET g_isag_d[l_ac].xmdl047 = "0"
      LET g_isag_d[l_ac].isag116 = "0"
      LET g_isag_d[l_ac].isag117 = "0"
 
            #add-point:modify段before備份 name="input.body.insert.before_bak"
            
            #end add-point
            LET g_isag_d_t.* = g_isag_d[l_ac].*     #新輸入資料
            LET g_isag_d_o.* = g_isag_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aist310_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body.insert.after_set_entry_b"
            
            #end add-point
            CALL aist310_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_isag_d[li_reproduce_target].* = g_isag_d[li_reproduce].*
 
               LET g_isag_d[li_reproduce_target].isagseq = NULL
 
            END IF
            
 
            #add-point:modify段before insert name="input.body.before_insert"
            IF l_cmd = 'a' THEN 
               IF cl_null(g_isag_d[g_detail_idx].isagseq) THEN 
                  SELECT MAX(isagseq) INTO g_isag_d[g_detail_idx].isagseq
                    FROM isag_t
                   WHERE isagent = g_enterprise
                     AND isagcomp = g_isaf_m.isafcomp
                     AND isagdocno = g_isaf_m.isafdocno
                     
                  IF cl_null(g_isag_d[g_detail_idx].isagseq) THEN 
                     LET g_isag_d[g_detail_idx].isagseq = 1
                  ELSE
                     LET g_isag_d[g_detail_idx].isagseq = g_isag_d[g_detail_idx].isagseq + 1
                  END IF
               END IF
               LET g_isag_d[l_ac].isag018   = ''  #訂金已開發票  #160823-00016#1
            END IF
            LET g_isag_d[l_ac].isag006 = g_isaf_m.isaf016
            LET g_isag_d[l_ac].isag008 = g_isaf_m.isaf018
            #LET g_isag_d[l_ac].isagorga = g_site #161018-00053#1 add #160922-00055#2 mark
            LET g_isag_d[l_ac].isagorga = g_isaf_m.isafsite           #160922-00055#2 add
            #end add-point  
  
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身新增 name="input.body.b_a_insert"
            
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM isag_t 
             WHERE isagent = g_enterprise AND isagcomp = g_isaf_m.isafcomp
               AND isagdocno = g_isaf_m.isafdocno
 
               AND isagseq = g_isag_d[l_ac].isagseq
 
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身新增前 name="input.body.b_insert"
               
               #end add-point
            
               #同步新增到同層的table
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys[3] = g_isag_d[g_detail_idx].isagseq
               CALL aist310_insert_b('isag_t',gs_keys,"'1'")
                           
               #add-point:單身新增後 name="input.body.a_insert"
               CALL aist310_isaf_sum()
               #end add-point
            ELSE    
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code = "std-00006" 
               LET g_errparam.popup = TRUE 
               INITIALIZE g_isag_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isag_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aist310_b_fill()
               #資料多語言用-增/改
               
               #add-point:input段-after_insert name="input.body.a_insert2"
               #151223-00001#3--add--str--lujh
               CALL aist310_upd_xmdl(g_isag_d[l_ac].isagseq,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003,'+') RETURNING l_success
               IF l_success = FALSE THEN 
                  CALL s_transaction_end('N','0')                    
                  CANCEL INSERT
               END IF
               #151223-00001#3--add--str--lujh                
               
               #160614-00025#2 mark ------
               #160614-00025#1 --s add
               ##新增時,將發票號碼寫入單身來源類型為13/22的來源單據
               #IF (g_isag_d[l_ac].isag001 = '13' AND NOT cl_null(g_isaf_m.isaf011)) OR (g_isag_d[l_ac].isag001 = '22' AND NOT cl_null(g_isag_d[l_ac].isag014)) THEN
               #   LET l_isag001 = ''
               #   LET l_isag002 = ''
               #   LET l_date = cl_get_current()
               #   LET l_sql = "SELECT isag001,isag002 FROM isag_t ",
               #               " WHERE isagent = '",g_enterprise,"'",
               #               "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
               #               "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
               #               "   AND isag001 IN ('13','22') "
               #   PREPARE isag_updins_rtia014_pre1 FROM l_sql
               #   DECLARE isag_updins_rtia014_cs1 CURSOR FOR isag_updins_rtia014_pre1
               #   FOREACH isag_updins_rtia014_cs1 INTO l_isag001,l_isag002
               #      IF SQLCA.sqlcode THEN
               #         INITIALIZE g_errparam TO NULL
               #         LET g_errparam.code = SQLCA.sqlcode
               #         LET g_errparam.extend = "FOREACH: isag_updins_rtia014_cs1 "
               #         LET g_errparam.popup = TRUE
               #         CALL cl_err()
               #         EXIT FOREACH
               #      END IF
               #      LET l_rtia014 = ''
               #      LET l_rtia015 = ''
               #      SELECT rtia014,rtia015 INTO l_rtia014,l_rtia015 FROM rtia_t
               #       WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
               #      IF cl_null(l_rtia014) OR cl_null(l_rtia015) THEN
               #         IF l_isag001 = '13' THEN
               #            #13銷售單
               #            UPDATE rtia_t SET (rtia014,rtia015,rtiamodid,rtiamoddt) = (g_isaf_m.isaf011,g_isaf_m.isaf011,g_user,l_date)
               #             WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
               #         ELSE
               #            #22銷退單
               #            LET l_isat004 = ''
               #            SELECT isat004 INTO l_isat004 FROM isat_t,isaf_t
               #             WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp AND isatdocno = g_isaf_m.isafdocno
               #               AND isatent = isafent AND isatcomp = isafcomp AND isatdocno = isafdocno AND isat014 = '21' AND isat025 <> '22'
               #               
               #            IF cl_null(l_isat004) THEN LET l_isat004 = g_isag_d[l_ac].isag014 END IF
               #            UPDATE rtia_t SET (rtia014,rtia015,rtiamodid,rtiamoddt) = (l_isat004,l_isat004,g_user,l_date)
               #             WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
               #         END IF
               #         IF SQLCA.SQLERRD[3] = 0 THEN
               #            INITIALIZE g_errparam TO NULL
               #            LET g_errparam.code = SQLCA.sqlcode
               #            LET g_errparam.extend = ""
               #            LET g_errparam.popup = FALSE
               #            CALL cl_err()
               #            CALL s_transaction_end('N','0') 
               #            CANCEL INSERT                         
               #         END IF
               #      END IF
               #   END FOREACH
               #END IF
               ##160614-00025#1 --e add
               #160614-00025#2 mark end---
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
              
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身刪除後(=d) name="input.body.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code = -263 
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身刪除前 name="input.body.b_delete"
               #151223-00001#3--add--str--lujh
               CALL aist310_upd_xmdl(g_isag_d[l_ac].isagseq,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003,'-') RETURNING l_success
               IF l_success = FALSE THEN 
                  CALL s_transaction_end('N','0')
                  CLOSE aist310_bcl
                  CANCEL DELETE
               END IF
               #151223-00001#3--add--str--lujh
               
               #160614-00025#2 mark ------
               ##160614-00025#1 --s add
               ##單身刪除時,更新單身來源類型為13/22的單據發票為空
               #LET l_isag002 = ''
               #LET l_date = cl_get_current()
               #LET l_sql = "SELECT DISTINCT isag002 FROM isag_t ",
               #            " WHERE isagent = '",g_enterprise,"'",
               #            "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
               #            "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
               #            "   AND isag001 IN ('13','22') "
               #PREPARE isag_upddel_rtia014_pre1 FROM l_sql
               #DECLARE isag_upddel_rtia014_cs1 CURSOR FOR isag_upddel_rtia014_pre1
               #FOREACH isag_upddel_rtia014_cs1 INTO l_isag002
               #   IF SQLCA.sqlcode THEN
               #      INITIALIZE g_errparam TO NULL
               #      LET g_errparam.code = SQLCA.sqlcode
               #      LET g_errparam.extend = "FOREACH: isag_upddel_rtia014_cs1 "
               #      LET g_errparam.popup = TRUE
               #      CALL cl_err()
               #      EXIT FOREACH
               #   END IF
               #   
               #   LET l_rtia014 = ''
               #   LET l_rtia015 = ''
               #   SELECT rtia014,rtia015 INTO l_rtia014,l_rtia015 FROM rtia_t
               #    WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
               #   IF NOT cl_null(l_rtia014) OR NOT cl_null(l_rtia015) THEN
               #      UPDATE rtia_t SET (rtia014,rtia015,rtiamodid,rtiamoddt) = ('','',g_user,l_date)
               #       WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
               #       
               #      IF SQLCA.SQLERRD[3] = 0 THEN
               #         INITIALIZE g_errparam TO NULL
               #         LET g_errparam.code = SQLCA.sqlcode
               #         LET g_errparam.extend = ""
               #         LET g_errparam.popup = FALSE
               #         CALL cl_err()
               #         CALL s_transaction_end('N','0') 
               #         CLOSE aist310_bcl
               #         CANCEL DELETE                         
               #      END IF
               #   END IF
               #END FOREACH
               ##160614-00025#1 --e add
               #160614-00025#2 mark end---
               #end add-point 
               
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_isaf_m.isafcomp
               LET gs_keys[gs_keys.getLength()+1] = g_isaf_m.isafdocno
 
               LET gs_keys[gs_keys.getLength()+1] = g_isag_d_t.isagseq
 
            
               #刪除同層單身
               IF NOT aist310_delete_b('isag_t',gs_keys,"'1'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist310_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT aist310_key_delete_b(gs_keys,'isag_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist310_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
               
               #add-point:單身刪除中 name="input.body.m_delete"
               DELETE FROM xrcd_t
                WHERE xrcdent = g_enterprise 
                  AND xrcdld = g_glaald
                  AND xrcddocno = g_isaf_m.isafdocno 
                  AND xrcdseq = g_isag_d_t.isagseq
                  AND xrcdseq2 = 0    
               #end add-point 
               
               CALL s_transaction_end('Y','0')
               CLOSE aist310_bcl
            
               LET g_rec_b = g_rec_b-1
               #add-point:單身刪除後 name="input.body.a_delete"
                  CALL aist310_isaf_sum()
               #end add-point
               LET l_count = g_isag_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body.after_delete"
               
               #end add-point
            END IF
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_isag_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isagseq
            #add-point:BEFORE FIELD isagseq name="input.b.page1.isagseq"
            IF cl_null(g_isag_d[g_detail_idx].isagseq) THEN 
               SELECT MAX(isagseq) INTO g_isag_d[g_detail_idx].isagseq
                 FROM isag_t
                WHERE isagent = g_enterprise
                  AND isagcomp = g_isaf_m.isafcomp
                  AND isagdocno = g_isaf_m.isafdocno
                  
               IF cl_null(g_isag_d[g_detail_idx].isagseq) THEN 
                  LET g_isag_d[g_detail_idx].isagseq = 1
               ELSE
                  LET g_isag_d[g_detail_idx].isagseq = g_isag_d[g_detail_idx].isagseq + 1
               END IF
            END IF
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isagseq
            
            #add-point:AFTER FIELD isagseq name="input.a.page1.isagseq"
            #此段落由子樣板a05產生
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag_d[g_detail_idx].isagseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag_d[g_detail_idx].isagseq != g_isag_d_t.isagseq)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isag_t WHERE "||"isagent = '" ||g_enterprise|| "' AND "||"isagcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isagdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isagseq = '"||g_isag_d[g_detail_idx].isagseq ||"'",'std-00004',0) THEN #160907-00046#1 mark 
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isag_t WHERE "||"isagent = '" ||g_enterprise|| "' AND "||"isagcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isagdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isagseq = '"||g_isag_d[g_detail_idx].isagseq ||"'",'std-00004',0) THEN #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isagseq
            #add-point:ON CHANGE isagseq name="input.g.page1.isagseq"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isagorga
            
            #add-point:AFTER FIELD isagorga name="input.a.page1.isagorga"
            CALL aist310_ref_b_1()       
            #160317-00024#1--mark--str--lujh            
            #IF NOT cl_null(g_isag_d[l_ac].isagorga) THEN 
            #   IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isagorga != g_isag_d_t.isagorga OR g_isag_d_t.isagorga IS NULL )) THEN
            #      CALL s_fin_apcborga_chk(g_isaf_m.isafsite,g_isaf_m.isafcomp,g_isag_d[l_ac].isagorga,g_isaf_m.isafdocdt,'3')
            #         RETURNING g_sub_success,g_errno
            #      IF NOT g_sub_success THEN
            #         INITIALIZE g_errparam TO NULL
            #         LET g_errparam.extend = ""
            #         LET g_errparam.code   = g_errno
            #         LET g_errparam.popup  = TRUE
            #         CALL cl_err()
            #         LET g_isag_d[l_ac].isagorga = g_isag_d_t.isagorga
            #         CALL aist310_ref_b_1()
            #         NEXT FIELD CURRENT
            #      END IF
            #   END IF
            #END IF 
            #160317-00024#1--mark--end--lujh
            
            #160317-00024#1--add--str--lujh
            IF NOT cl_null(g_isag_d[l_ac].isagorga) THEN
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isagorga != g_isag_d_t.isagorga OR g_isag_d_t.isagorga IS NULL )) THEN #160822-00008#8 Mark
               IF g_isag_d[l_ac].isagorga != g_isag_d_o.isagorga OR cl_null(g_isag_d_o.isagorga) THEN #160822-00008#8
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_isag_d[l_ac].isagorga
                  LET g_chkparam.err_str[1] = "aoo-00095:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"#要執行的建議程式待補 #160318-00025#30  add

                  IF NOT cl_chk_exist("v_ooef001") THEN
                     #檢查失敗時後續處理
                     #LET g_isag_d[l_ac].isagorga = g_isag_d_t.isagorga #160822-00008#8 Mark
                     LET g_isag_d[l_ac].isagorga = g_isag_d_o.isagorga  #160822-00008#8
                     NEXT FIELD CURRENT
                  END IF
                  #CALL s_fin_account_center_sons_query('3',g_isaf_m.isafcomp,g_today,'') #160907-00041#1 mark
                  CALL s_fin_account_center_sons_query('3',g_isaf_m.isafsite,g_today,'')  #160907-00041#1 add
                  LET l_origin_str = '' #160822-00008#8
                  CALL s_fin_account_center_sons_str()RETURNING l_origin_str
                  IF cl_null(l_origin_str) THEN LET l_origin_str = g_isaf_m.isafsite END IF
                  #檢查輸入組織代碼是否存在帳務中心下法人範圍內
                  IF s_chr_get_index_of(l_origin_str,g_isag_d[l_ac].isagorga,1) = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00312'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     #LET g_isag_d[l_ac].isagorga = g_isag_d_t.isagorga #160822-00008#8 Mark
                     LET g_isag_d[l_ac].isagorga = g_isag_d_o.isagorga  #160822-00008#8
                     NEXT FIELD CURRENT
                  END IF
                  
                  #161006-00005#29  add---s
               
                  CALL s_fin_apcborga_chk(g_isaf_m.isafsite,g_isaf_m.isafcomp,g_isag_d[l_ac].isagorga,today,'3') 
                       RETURNING g_sub_success,g_errno
                  
                  IF NOT g_sub_success THEN
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isag_d[l_ac].isagorga = g_isag_d_o.isagorga  #160822-00008#8
                     NEXT FIELD CURRENT
                  END IF
                    
                  #161006-00005#29  add---e
               END IF
            END IF
            #160317-00024#1--add--end--lujh
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isagorga
            #add-point:BEFORE FIELD isagorga name="input.b.page1.isagorga"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isagorga
            #add-point:ON CHANGE isagorga name="input.g.page1.isagorga"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag001
            #add-point:BEFORE FIELD isag001 name="input.b.page1.isag001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag001
            
            #add-point:AFTER FIELD isag001 name="input.a.page1.isag001"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag001
            #add-point:ON CHANGE isag001 name="input.g.page1.isag001"
            LET g_isag_d[l_ac].isag002 = ''
            LET g_isag_d[l_ac].isag003 = ''
            CALL aist310_ref_b_1()
            CALL aist310_isag002_ref(g_isag_d[l_ac].isag009,g_isag_d[l_ac].isag010)
            SELECT gzcb004 INTO g_isag_d[l_ac].isag015 FROM gzcb_t
             WHERE gzcb001 = '8341'
               AND gzcb002 = g_isag_d[l_ac].isag001
            DISPLAY g_isag_d[l_ac].isag015 TO s_detail1[l_ac].isag015
            #151117 add ------
            LET g_isag_d[l_ac].isag012 = ''
            IF g_isag_d[l_ac].isag001 = '19' THEN
               SELECT pmab087 INTO g_isag_d[l_ac].isag012
                 FROM pmab_t
                WHERE pmabent = g_enterprise
                  AND pmabsite = g_isaf_m.isaf052
                  AND pmab001 = g_isaf_m.isaf003
            END IF
            DISPLAY BY NAME g_isag_d[l_ac].isag012
            #151117 add end---
            
            #160316-00017#2--add--str--lujh
            IF g_isag_d[l_ac].isag001 = '10' THEN 
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "" 
               LET g_errparam.code   = "ais-00310" 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               NEXT FIELD isag002
            END IF
            #160316-00017#2--add--str--lujh
            
            #160426-00013#1-s
            CALL cl_set_comp_required("isag002,isag003",FALSE)
            IF g_isag_d[l_ac].isag001 = '27' THEN #27:其他待抵單
               LET l_sfin2022 = cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-2022')
               IF l_sfin2022 = '02' THEN
                  CALL cl_set_comp_required("isag002,isag003",TRUE)
               END IF
            END IF
            #160426-00013#1-e
            
            #160614-00025#1 --s add
            CALL cl_set_comp_entry("isag009,isag010,imaal004,isag016,isag017",TRUE)
            CALL cl_set_comp_entry("isag004,isag005_desc,isag101,isag103,isag104,isag105",TRUE)
            IF g_isag_d[l_ac].isag001 = '13' OR g_isag_d[l_ac].isag001 = '22' THEN
               CALL cl_set_comp_entry("isag009,isag010,imaal004,isag016,isag017",FALSE)
               CALL cl_set_comp_entry("isag004,isag005_desc,isag101,isag103,isag104,isag105",FALSE)
            END IF
            #160614-00025#1 --e add
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag002
            
            #add-point:AFTER FIELD isag002 name="input.a.page1.isag002"
            #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag002 != g_isag_d_t.isag002 OR g_isag_d_t.isag002 IS NULL )) THEN   #151124-00007#1 add lujh #160822-00008#8 Mark
            IF g_isag_d[l_ac].isag002 != g_isag_d_o.isag002 OR cl_null(g_isag_d_o.isag002) THEN #160822-00008#8 
               CALL aist310_ref_b_1()
               IF g_isag_d[l_ac].isag001 = '10' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                     LET g_chkparam.arg1 = g_isag_d[l_ac].isag002
                     LET g_chkparam.arg2 = g_isaf_m.isaf003
                     LET g_chkparam.arg3 = g_isaf_m.isafdocdt
                     LET g_chkparam.arg4 = g_isag_d[l_ac].isag003
                     LET g_chkparam.err_str[1] = "ais-00085:sub-01332|axmt500|",cl_get_progname("axmt500",g_lang,"2"),"|:EXEPROGaxmt500"#要執行的建議程式待補 #160318-00025#30  add
                     IF cl_chk_exist("v_xmdadocno_2") THEN
                        #檢查成功時後續處理
                        #LET  = g_chkparam.return1
                        #DISPLAY BY NAME
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN 
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag004_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        #151123-00010#1--mark--str--lujh
                        #IF NOT cl_null(g_isag_d[g_detail_idx].isag004) AND NOT cl_null(g_isag_d[g_detail_idx].isag101) THEN 
                        #   CALL aist310_isag_preinstall()
                        #END IF
                        #151123-00010#1--mark--end--lujh
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag002 = g_isag_d_t.isag002 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag002 = g_isag_d_o.isag002  #160822-00008#8 
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        NEXT FIELD CURRENT
                     END IF
                  END IF 
               END IF
               
               IF g_isag_d[l_ac].isag001 = '11' OR g_isag_d[l_ac].isag001 = '21' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN 
                     #151123-00013#7-----s
                     #INITIALIZE g_chkparam.* TO NULL
                     #LET g_chkparam.arg1 = g_isag_d[l_ac].isag002
                     #LET g_chkparam.arg2 = g_isaf_m.isaf003
                     #LET g_chkparam.arg3 = g_isaf_m.isafdocdt
                     #LET g_chkparam.arg4 = g_isag_d[l_ac].isag003
                     #LET g_chkparam.arg5 = g_isaf_m.isaf016  #稅別 #150603-00046#1
                     #LET g_chkparam.arg6 = g_isaf_m.isaf100  #幣別 #150603-00046#1
                     #IF cl_chk_exist("v_xmdkdocno") THEN
                     CALL aist310_isag002_chk2(g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003)
                          RETURNING g_sub_success,g_errno
                     IF  g_sub_success THEN
                     #151123-00013#7------e
                        #檢查成功時後續處理
                        #LET  = g_chkparam.return1
                        #DISPLAY BY NAME
                        LET g_errno = NULL
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag004_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        #151123-00010#1--mark--str--lujh
                        #IF NOT cl_null(g_isag_d[g_detail_idx].isag004) AND NOT cl_null(g_isag_d[g_detail_idx].isag101) THEN 
                        #   CALL aist310_isag_preinstall()
                        #END IF
                        #151123-00010#1--mark--end--lujh
                        #170117-00067#1 mark ------
                        ##151223-00001#3--add--str--lujh
                        ##IF g_isag_d[l_ac].isag002 != g_isag_d_t.isag002 THEN  #160822-00008#8 Mark
                        #IF g_isag_d[l_ac].isag002 != g_isag_d_o.isag002 THEN   #160822-00008#8
                        #   IF s_transaction_chk("N",0) THEN
                        #      CALL s_transaction_begin()
                        #   END IF
                        #   #CALL aist310_upd_xmdl(g_isag_d[l_ac].isagseq,g_isag_d_t.isag002,g_isag_d_t.isag003,'-') RETURNING l_success #160822-00008#8 Mark
                        #   CALL aist310_upd_xmdl(g_isag_d[l_ac].isagseq,g_isag_d_o.isag002,g_isag_d_o.isag003,'-') RETURNING l_success  #160822-00008#8
                        #   IF l_success = FALSE THEN 
                        #      CALL s_transaction_end('N','0')
                        #   ELSE
                        #      CALL s_transaction_end('Y','0')
                        #   END IF
                        #END IF
                        ##151223-00001#3--add--str--lujh
                        #170117-00067#1 mark end---
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag002 = g_isag_d_t.isag002 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag002 = g_isag_d_o.isag002  #160822-00008#8 
                        #151123-00013#7-----s
                        INITIALIZE g_errparam.* TO NULL
                        LET g_errparam.code = g_errno
                        #160318-00005#22  --add--str
                        CASE g_errno
                        WHEN 'sub-01311'
                           LET g_errparam.replace[1] ='axmt540'
                           LET g_errparam.replace[2] = cl_get_progname('axmt540',g_lang,"2")
                           LET g_errparam.exeprog    ='axmt540'
                        WHEN 'sub-01332'
                           LET g_errparam.replace[1] ='axmt580'
                           LET g_errparam.replace[2] = cl_get_progname('axmt580',g_lang,"2")
                           LET g_errparam.exeprog    ='axmt580'
                        END CASE
                        #160318-00005#22  --add--end
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        #151123-00013#7-----e
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               
               #150518-00046#4--s
               IF g_isag_d[l_ac].isag001 = '12' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN
                     CALL aist310_isag002_chk3(g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003)
                          RETURNING g_sub_success
                     IF  g_sub_success THEN
                        #檢查成功時後續處理
                        LET g_errno = NULL
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag004_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag002 = g_isag_d_t.isag002 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag002 = g_isag_d_o.isag002  #160822-00008#8
                        INITIALIZE g_errparam.* TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               #150518-00046#4--e
               #160614-00025#1 --s add
               IF g_isag_d[l_ac].isag001 = '13' OR g_isag_d[l_ac].isag001 = '22' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN
                     CALL aist310_isag002_chk4(g_isag_d[l_ac].isag001,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003)
                          RETURNING g_sub_success
                     IF  g_sub_success THEN
                        #檢查成功時後續處理
                        LET g_errno = NULL
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        CALL aist310_isag002_get()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag002 = g_isag_d_t.isag002 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag002 = g_isag_d_o.isag002  #160822-00008#8
                        INITIALIZE g_errparam.* TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               #160614-00025#1 --e add
               IF g_isag_d[l_ac].isag001 = '27' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = g_isag_d[l_ac].isag002
                     LET g_chkparam.arg2 = g_isaf_m.isaf003
                     LET g_chkparam.arg3 = g_isaf_m.isafdocdt
                     LET g_chkparam.arg4 = g_isag_d[l_ac].isag003
                     LET g_chkparam.arg5 = g_glaald
                     LET g_chkparam.arg6 = g_isaf_m.isafsite
                     IF cl_chk_exist("v_xrccdocno") THEN
                        #檢查成功時後續處理
                        #LET  = g_chkparam.return1
                        #DISPLAY BY NAME 
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN 
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag105_chk()
                        IF NOT cl_null(g_errno) THEN 
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag105
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        #151123-00010#1--mark--str--lujh
                        #IF NOT cl_null(g_isag_d[g_detail_idx].isag004) AND NOT cl_null(g_isag_d[g_detail_idx].isag101) THEN
                        #   CALL aist310_isag_preinstall()
                        #END IF
                        #151123-00010#1--mark--end--lujh
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag002 = g_isag_d_t.isag002 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag002 = g_isag_d_o.isag002  #160822-00008#8
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  CALL cl_set_comp_required('isag012,isag004,isag101',FALSE)
               END IF
               
               #160426-00013#2-s
               IF g_isaf_m.isaf001 = '1' AND g_isag_d[l_ac].isag001 = '29' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = g_isag_d[l_ac].isag002
                     LET g_chkparam.arg2 = g_isaf_m.isaf003
                     LET g_chkparam.arg3 = g_isaf_m.isafdocdt
                     LET g_chkparam.arg4 = g_isag_d[l_ac].isag003
                     LET g_chkparam.arg5 = g_glaald
                     LET g_chkparam.arg6 = g_isaf_m.isafsite
                     IF cl_chk_exist("v_xrccdocno") THEN
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag105_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag105
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        ELSE
                           CALL cl_set_comp_required("isag004,isag005,isag101,isag103,isag104",FALSE)
                        END IF
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag002 = g_isag_d_t.isag002 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag002 = g_isag_d_o.isag002  #160822-00008#8
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        CALL cl_set_comp_required("isag004,isag005,isag101,isag103,isag104",TRUE)
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               #160426-00013#2-e
               
               IF NOT cl_null(g_isag_d[l_ac].isag002) THEN
                  CALL cl_set_comp_entry("isag012",FALSE)
               ELSE
                  CALL cl_set_comp_entry("isag012",TRUE)
               END IF
            END IF   #151124-00007#1 add lujh
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag002
            #add-point:BEFORE FIELD isag002 name="input.b.page1.isag002"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag002
            #add-point:ON CHANGE isag002 name="input.g.page1.isag002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag003
            #add-point:BEFORE FIELD isag003 name="input.b.page1.isag003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag003
            
            #add-point:AFTER FIELD isag003 name="input.a.page1.isag003"
            #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag003 != g_isag_d_t.isag003 OR g_isag_d_t.isag003 IS NULL )) THEN   #151124-00007#1 add lujh #160822-00008#8 Mark
            IF g_isag_d[l_ac].isag003 != g_isag_d_o.isag003 OR cl_null(g_isag_d_o.isag003) THEN #160822-00008#8
               CALL aist310_ref_b_1()
               #CALL aist310_isag002_get()
               #IF g_isag_d[l_ac].isag001 = 'axmt500' THEN
               IF g_isag_d[l_ac].isag001 = '10' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN 
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
                     LET g_chkparam.arg1 = g_isag_d[l_ac].isag002
                     LET g_chkparam.arg2 = g_isaf_m.isaf003
                     LET g_chkparam.arg3 = g_isaf_m.isafdocdt
                     LET g_chkparam.arg4 = g_isag_d[l_ac].isag003
                     LET g_chkparam.err_str[1] = "ais-00085:sub-01332|axmt500|",cl_get_progname("axmt500",g_lang,"2"),"|:EXEPROGaxmt500"#要執行的建議程式待補 #160318-00025#30  add
                     IF cl_chk_exist("v_xmdadocno_2") THEN
                        #檢查成功時後續處理
                        #LET  = g_chkparam.return1
                        #DISPLAY BY NAME 
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag004_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                        #151123-00010#1--mark--str--lujh
                        #IF NOT cl_null(g_isag_d[g_detail_idx].isag004) AND NOT cl_null(g_isag_d[g_detail_idx].isag101) THEN 
                        #   CALL aist310_isag_preinstall()
                        #END IF
                        #151123-00010#1--mark--end--lujh
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag003 = g_isag_d_t.isag003 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag003 = g_isag_d_o.isag003  #160822-00008#8
                        CALL aist310_ref_b_1()
                        CALL aist310_isag002_get()
                        NEXT FIELD CURRENT
                     END IF
                  END IF 
               END IF
               
               #IF g_isag_d[l_ac].isag001 = 'axmt540' THEN
               IF g_isag_d[l_ac].isag001 = '11' OR g_isag_d[l_ac].isag001 = '21' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN 
                     #151123-00013#7------s
                     #INITIALIZE g_chkparam.* TO NULL
                     #LET g_chkparam.arg1 = g_isag_d[l_ac].isag002
                     #LET g_chkparam.arg2 = g_isaf_m.isaf003
                     #LET g_chkparam.arg3 = g_isaf_m.isafdocdt
                     #LET g_chkparam.arg4 = g_isag_d[l_ac].isag003
                     #LET g_chkparam.arg5 = g_isaf_m.isaf016  #稅別 #150603-00046#1
                     #LET g_chkparam.arg6 = g_isaf_m.isaf100  #幣別 #150603-00046#1
                     #IF cl_chk_exist("v_xmdkdocno") THEN
                     CALL aist310_isag002_chk2(g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003)
                          RETURNING g_sub_success,g_errno
                     IF  g_sub_success THEN
                     #151123-00013#7------e
                        #檢查成功時後續處理
                        #LET  = g_chkparam.return1
                        #DISPLAY BY NAME
                        LET g_errno = NULL
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag004_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                        #151123-00010#1--mark--str--lujh
                        #IF NOT cl_null(g_isag_d[g_detail_idx].isag004) AND NOT cl_null(g_isag_d[g_detail_idx].isag101) THEN 
                        #   CALL aist310_isag_preinstall()
                        #END IF
                        #151123-00010#1--mark--end--lujh
                        #170117-00067#1 mark ------
                        ##151223-00001#3--add--str--lujh
                        ##IF g_isag_d[l_ac].isag003 != g_isag_d_t.isag003 THEN #160822-00008#8 Mark
                        #IF g_isag_d[l_ac].isag003 != g_isag_d_o.isag003 THEN #160822-00008#8
                        #   IF s_transaction_chk("N",0) THEN
                        #      CALL s_transaction_begin()
                        #   END IF
                        #   #CALL aist310_upd_xmdl(g_isag_d[l_ac].isagseq,g_isag_d_t.isag002,g_isag_d_t.isag003,'-') RETURNING l_success #160822-00008#8 Mark
                        #   CALL aist310_upd_xmdl(g_isag_d[l_ac].isagseq,g_isag_d_o.isag002,g_isag_d_o.isag003,'-') RETURNING l_success  #160822-00008#8
                        #   IF l_success = FALSE THEN 
                        #      CALL s_transaction_end('N','0')
                        #   ELSE
                        #      CALL s_transaction_end('Y','0')
                        #   END IF
                        #END IF
                        ##151223-00001#3--add--str--lujh
                        #170117-00067#1 mark end---
                     ELSE
                        #檢查失敗時後續處理
                        #151123-00013#7-----s
                        INITIALIZE g_errparam.* TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = ''
                        #160318-00005#22  --add--str
                           CASE g_errno
                           WHEN 'sub-01311'
                               LET g_errparam.replace[1] ='axmt540'
                               LET g_errparam.replace[2] = cl_get_progname('axmt540',g_lang,"2")
                               LET g_errparam.exeprog    ='axmt540'
                           WHEN 'sub-01332'
                               LET g_errparam.replace[1] ='axmt580'
                               LET g_errparam.replace[2] = cl_get_progname('axmt580',g_lang,"2")
                               LET g_errparam.exeprog    ='axmt580'
                           END CASE
                        #160318-00005#22  --add--end
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        #151123-00013#7-----e                        
                        #LET g_isag_d[l_ac].isag003 = g_isag_d_t.isag003 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag003 = g_isag_d_o.isag003  #160822-00008#8
                        CALL aist310_ref_b_1()
                        CALL aist310_isag002_get()
                        NEXT FIELD CURRENT
                     END IF
                  END IF 
               END IF
               
               #150518-00046#4--s
               IF g_isag_d[l_ac].isag001 = '12' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN 
                     CALL aist310_isag002_chk3(g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003)
                          RETURNING g_sub_success
                     IF  g_sub_success THEN
                        #檢查成功時後續處理
                        LET g_errno = NULL
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag004_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag003 = g_isag_d_t.isag003 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag003 = g_isag_d_o.isag003  #160822-00008#8
                        INITIALIZE g_errparam.* TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               #150518-00046#4--e
               #160614-00025#1 --s add
               IF g_isag_d[l_ac].isag001 = '13' OR g_isag_d[l_ac].isag001 = '22' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN 
                     CALL aist310_isag002_chk4(g_isag_d[l_ac].isag001,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003)
                          RETURNING g_sub_success
                     IF  g_sub_success THEN
                        #檢查成功時後續處理
                        LET g_errno = NULL
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                        CALL aist310_isag002_get()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag003 = g_isag_d_t.isag003 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag003 = g_isag_d_o.isag003  #160822-00008#8
                        INITIALIZE g_errparam.* TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               #160614-00025#1 --e add
               #160426-00013#2-s
               IF g_isag_d[l_ac].isag001 = '27' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = g_isag_d[l_ac].isag002
                     LET g_chkparam.arg2 = g_isaf_m.isaf003
                     LET g_chkparam.arg3 = g_isaf_m.isafdocdt
                     LET g_chkparam.arg4 = g_isag_d[l_ac].isag003
                     LET g_chkparam.arg5 = g_glaald
                     LET g_chkparam.arg6 = g_isaf_m.isafsite
                     IF cl_chk_exist("v_xrccdocno") THEN
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag105_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag105
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag003
                        END IF
                     ELSE
                        #LET g_isag_d[l_ac].isag003 = g_isag_d_t.isag003 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag003 = g_isag_d_o.isag003  #160822-00008#8
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  CALL cl_set_comp_required('isag012,isag004,isag101',FALSE)
               END IF
               #160426-00013#2-e
               
               #160426-00013#2-s
               IF g_isaf_m.isaf001 = '1' AND g_isag_d[l_ac].isag001 = '29' THEN
                  IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = g_isag_d[l_ac].isag002
                     LET g_chkparam.arg2 = g_isaf_m.isaf003
                     LET g_chkparam.arg3 = g_isaf_m.isafdocdt
                     LET g_chkparam.arg4 = g_isag_d[l_ac].isag003
                     LET g_chkparam.arg5 = g_glaald
                     LET g_chkparam.arg6 = g_isaf_m.isafsite
                     IF cl_chk_exist("v_xrccdocno") THEN
                        CALL aist310_isag002_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag002
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        END IF
                        CALL aist310_isag002_get()
                        CALL aist310_isag105_chk()
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag_d[l_ac].isag105
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           CALL aist310_clear()
                           NEXT FIELD isag002
                        ELSE
                           CALL cl_set_comp_required("isag004,isag005,isag101,isag103,isag104",FALSE)
                        END IF
                     ELSE
                        #檢查失敗時後續處理
                        #LET g_isag_d[l_ac].isag002 = g_isag_d_t.isag002 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag002 = g_isag_d_o.isag002  #160822-00008#8
                        CALL aist310_ref_b_1()
                        CALL aist310_clear()
                        CALL cl_set_comp_required("isag004,isag005,isag101,isag103,isag104",TRUE)
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               #160426-00013#2-e
               
            END IF     #151124-00007#1 add lujh
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag003
            #add-point:ON CHANGE isag003 name="input.g.page1.isag003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag018
            #add-point:BEFORE FIELD isag018 name="input.b.page1.isag018"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag018
            
            #add-point:AFTER FIELD isag018 name="input.a.page1.isag018"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag018
            #add-point:ON CHANGE isag018 name="input.g.page1.isag018"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag009
            #add-point:BEFORE FIELD isag009 name="input.b.page1.isag009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag009
            
            #add-point:AFTER FIELD isag009 name="input.a.page1.isag009"
            CALL aist310_ref_b_1()
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag009
            #add-point:ON CHANGE isag009 name="input.g.page1.isag009"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag010
            #add-point:BEFORE FIELD isag010 name="input.b.page1.isag010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag010
            
            #add-point:AFTER FIELD isag010 name="input.a.page1.isag010"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag010
            #add-point:ON CHANGE isag010 name="input.g.page1.isag010"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD imaal004
            #add-point:BEFORE FIELD imaal004 name="input.b.page1.imaal004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD imaal004
            
            #add-point:AFTER FIELD imaal004 name="input.a.page1.imaal004"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE imaal004
            #add-point:ON CHANGE imaal004 name="input.g.page1.imaal004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag016
            #add-point:BEFORE FIELD isag016 name="input.b.page1.isag016"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag016
            
            #add-point:AFTER FIELD isag016 name="input.a.page1.isag016"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag016
            #add-point:ON CHANGE isag016 name="input.g.page1.isag016"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag017
            #add-point:BEFORE FIELD isag017 name="input.b.page1.isag017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag017
            
            #add-point:AFTER FIELD isag017 name="input.a.page1.isag017"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag017
            #add-point:ON CHANGE isag017 name="input.g.page1.isag017"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag015
            #add-point:BEFORE FIELD isag015 name="input.b.page1.isag015"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag015
            
            #add-point:AFTER FIELD isag015 name="input.a.page1.isag015"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag015
            #add-point:ON CHANGE isag015 name="input.g.page1.isag015"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD inag009
            #add-point:BEFORE FIELD inag009 name="input.b.page1.inag009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD inag009
            
            #add-point:AFTER FIELD inag009 name="input.a.page1.inag009"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE inag009
            #add-point:ON CHANGE inag009 name="input.g.page1.inag009"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xmdl047
            #add-point:BEFORE FIELD xmdl047 name="input.b.page1.xmdl047"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xmdl047
            
            #add-point:AFTER FIELD xmdl047 name="input.a.page1.xmdl047"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xmdl047
            #add-point:ON CHANGE xmdl047 name="input.g.page1.xmdl047"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD inag007
            
            #add-point:AFTER FIELD inag007 name="input.a.page1.inag007"


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD inag007
            #add-point:BEFORE FIELD inag007 name="input.b.page1.inag007"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE inag007
            #add-point:ON CHANGE inag007 name="input.g.page1.inag007"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD inag007_desc
            #add-point:BEFORE FIELD inag007_desc name="input.b.page1.inag007_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD inag007_desc
            
            #add-point:AFTER FIELD inag007_desc name="input.a.page1.inag007_desc"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE inag007_desc
            #add-point:ON CHANGE inag007_desc name="input.g.page1.inag007_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag006
            #add-point:BEFORE FIELD isag006 name="input.b.page1.isag006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag006
            
            #add-point:AFTER FIELD isag006 name="input.a.page1.isag006"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag006
            #add-point:ON CHANGE isag006 name="input.g.page1.isag006"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag008
            #add-point:BEFORE FIELD isag008 name="input.b.page1.isag008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag008
            
            #add-point:AFTER FIELD isag008 name="input.a.page1.isag008"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag008
            #add-point:ON CHANGE isag008 name="input.g.page1.isag008"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag012
            
            #add-point:AFTER FIELD isag012 name="input.a.page1.isag012"
            IF NOT cl_null(g_isag_d[l_ac].isag012) THEN 
#此段落由子樣板a19產生
               #校驗代值
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isag_d[l_ac].isag012
               LET g_chkparam.err_str[1] = "apm-00184:sub-01302|aooi714|",cl_get_progname("aooi714",g_lang,"2"),"|:EXEPROGaooi714"#要執行的建議程式待補 #160318-00025#30  add
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooib002_1") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 
               ELSE
                  #檢查失敗時後續處理
                  LET g_isag_d[l_ac].isag012 = g_isag_d_t.isag012
                  NEXT FIELD CURRENT
               END IF
            

            END IF 


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag012
            #add-point:BEFORE FIELD isag012 name="input.b.page1.isag012"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag012
            #add-point:ON CHANGE isag012 name="input.g.page1.isag012"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag004
            #add-point:BEFORE FIELD isag004 name="input.b.page1.isag004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag004
            
            #add-point:AFTER FIELD isag004 name="input.a.page1.isag004"
            IF NOT cl_null(g_isag_d[g_detail_idx].isag004) THEN 
               CALL aist310_isag004_chk()
               IF NOT cl_null(g_errno) THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = g_errno
                  LET g_errparam.extend = g_isag_d[l_ac].isag004
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_isag_d[l_ac].isag004 = g_isag_d_t.isag004
                  NEXT FIELD isag004
               END IF
               #170117-00067#1 mark ------
               ##151223-00001#3--add--str--lujh
               #IF g_isag_d[l_ac].isag004 != g_isag_d_t.isag004 THEN 
               #   IF s_transaction_chk("N",0) THEN
               #      CALL s_transaction_begin()
               #   END IF
               #   CALL aist310_upd_xmdl(g_isag_d[l_ac].isagseq,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003,'-') RETURNING l_success
               #   IF l_success = FALSE THEN 
               #      CALL s_transaction_end('N','0')    
               #   ELSE
               #      CALL s_transaction_end('Y','0')                            
               #   END IF
               #END IF
               ##151223-00001#3--add--end--lujh
               #170117-00067#1 mark end---
            END IF
            
            IF NOT cl_null(g_isag_d[l_ac].isag004) THEN
               IF NOT cl_null(g_isag_d[l_ac].isag101) AND NOT cl_null(g_isag_d[l_ac].isag006) THEN 
                  #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag004 <> g_isag_d_t.isag004 OR cl_null(g_isag_d_t.isag004))) THEN #160822-00008#8 Mark
                  IF g_isag_d[l_ac].isag004 != g_isag_d_o.isag004 OR cl_null(g_isag_d_o.isag004) THEN #160822-00008#8
                     #160822-00008#8---(S)
                     LET g_isag_d[l_ac].isag103 = 0
                     LET g_isag_d[l_ac].isag104 = 0
                     LET g_isag_d[l_ac].isag105 = 0
                     LET g_isag_d[l_ac].isag113 = 0
                     LET g_isag_d[l_ac].isag114 = 0
                     LET g_isag_d[l_ac].isag115 = 0
                     LET r_xrcd123              = 0
                     LET r_xrcd124              = 0
                     LET r_xrcd125              = 0
                     LET r_xrcd133              = 0
                     LET r_xrcd134              = 0
                     LET r_xrcd135              = 0
                     #160822-00008#8 ---(E)
                     CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
                                    g_isag_d[l_ac].isag004*g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag006,
                                    g_isag_d[l_ac].isag004,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,0,0)
                       RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                                 g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
                                 r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135    
                     #150518-00046#4--s
                     IF g_isag_d[l_ac].isag001 = '12' THEN   
                        #一次性立帳(本次數量=計價數量),則原幣金額全部從RMA覆出單身而來
                        IF g_isag_d[l_ac].isag004 = g_isag_d[l_ac].inag009 THEN
                           #160822-00008#8---(S)
                           LET l_rmba008 = ''
                           LET l_rmdb016 = 0
                           LET l_rmdb017 = 0
                           LET g_isag_d[l_ac].isag103 = 0
                           LET g_isag_d[l_ac].isag105 = 0
                           LET g_isag_d[l_ac].isag104 = 0
                           #160822-00008#8 ---(E)       
                           SELECT #含稅否 未稅金額 含稅金額
                                  rmba008,rmdb016,rmdb017
                             INTO l_rmba008,l_rmdb016,l_rmdb017
                             FROM rmda_t,rmdb_t,rmba_t a
                            WHERE rmdaent   = rmdbent
                              AND rmdadocno = rmdbdocno
                              AND rmdbent = rmbaent
                              AND rmdb001 = rmbadocno
                              AND rmba000 = (SELECT MAX (rmba000)     #以版次最大為準
                                               FROM rmba_t
                                              WHERE rmbadocno = a.rmbadocno AND rmbaent = a.rmbaent)      
                              AND rmdaent   = g_enterprise
                              AND rmdadocno = g_isag_d[l_ac].isag002
                              AND rmdbseq   = g_isag_d[l_ac].isag003
                              AND rmda007   = g_isaf_m.isaf003
                              AND rmda008   = g_isaf_m.isaf002                                 
                           LET g_isag_d[l_ac].isag103 = l_rmdb016
                           LET g_isag_d[l_ac].isag105 = l_rmdb017
                           LET g_isag_d[l_ac].isag104 = g_isag_d[l_ac].isag105 - g_isag_d[l_ac].isag103
                           LET l_isag105 = 0 #160822-00008#8
                           IF l_rmba008 = 'Y' THEN   #含稅
                              LET l_isag105 = l_rmdb017
                           ELSE
                              LET l_isag105 = l_rmdb016
                           END IF   
                           #160822-00008#8---(S)
                           LET r_xrcd103               = 0
                           LET r_xrcd104               = 0
                           LET r_xrcd105               = 0
                           LET g_isag_d[l_ac].isag113  = 0
                           LET g_isag_d[l_ac].isag114  = 0
                           LET g_isag_d[l_ac].isag115  = 0
                           LET r_xrcd123               = 0
                           LET r_xrcd124               = 0
                           LET r_xrcd125               = 0
                           LET r_xrcd133               = 0
                           LET r_xrcd134               = 0
                           LET r_xrcd135               = 0
                           #160822-00008#8 ---(E)                           
                           CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
                                          l_isag105,g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag004,g_isaf_m.isaf100,
                                          g_isaf_m.isaf101,g_glaald,0,0)
                             RETURNING r_xrcd103,r_xrcd104,r_xrcd105,
                                       g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
                                       r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135          
                        END IF
                     END IF                    
                     #150518-00046#4--e                                 
                      
                  END IF
               END IF
            END IF
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag004
            #add-point:ON CHANGE isag004 name="input.g.page1.isag004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag005
            #add-point:BEFORE FIELD isag005 name="input.b.page1.isag005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag005
            
            #add-point:AFTER FIELD isag005 name="input.a.page1.isag005"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag005
            #add-point:ON CHANGE isag005 name="input.g.page1.isag005"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag005_desc
            
            #add-point:AFTER FIELD isag005_desc name="input.a.page1.isag005_desc"
            LET g_isag_d[l_ac].isag005 = g_isag_d[l_ac].isag005_desc
            CALL aist310_ref_b_1()
            IF NOT cl_null(g_isag_d[l_ac].isag005) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isag_d[l_ac].isag005
               LET g_chkparam.err_str[1] = "aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"#要執行的建議程式待補 #160318-00025#30  add
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooca001") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 

               ELSE
                  #檢查失敗時後續處理
                  LET g_isag_d[l_ac].isag005 = g_isag_d_t.isag005
                  LET g_isag_d[l_ac].isag005_desc = g_isag_d_t.isag005_desc
                  CALL aist310_ref_b_1()
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag005_desc
            #add-point:BEFORE FIELD isag005_desc name="input.b.page1.isag005_desc"
            LET g_isag_d[l_ac].isag005_desc = g_isag_d[l_ac].isag005
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag005_desc
            #add-point:ON CHANGE isag005_desc name="input.g.page1.isag005_desc"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag101
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_isag_d[l_ac].isag101,"0","0","","","azz-00079",1) THEN
               NEXT FIELD isag101
            END IF 
 
 
 
            #add-point:AFTER FIELD isag101 name="input.a.page1.isag101"
            IF NOT cl_null(g_isag_d[l_ac].isag101) THEN
               IF NOT cl_null(g_isag_d[l_ac].isag004) AND NOT cl_null(g_isag_d[l_ac].isag006) THEN 
                  #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag101 <> g_isag_d_t.isag101 OR cl_null(g_isag_d_t.isag101))) THEN  #160822-00008#8 Mark         
                  IF g_isag_d[l_ac].isag101 != g_isag_d_o.isag101 OR cl_null(g_isag_d_o.isag101) THEN #160822-00008#8
                     #160822-00008#8---(S)
                     LET g_isag_d[l_ac].isag103  = 0
                     LET g_isag_d[l_ac].isag104  = 0
                     LET g_isag_d[l_ac].isag105  = 0
                     LET g_isag_d[l_ac].isag113  = 0
                     LET g_isag_d[l_ac].isag114  = 0
                     LET g_isag_d[l_ac].isag115  = 0
                     LET r_xrcd123               = 0
                     LET r_xrcd124               = 0
                     LET r_xrcd125               = 0
                     LET r_xrcd133               = 0
                     LET r_xrcd134               = 0
                     LET r_xrcd135               = 0
                     #160822-00008#8---(E)
                     CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
                                    g_isag_d[l_ac].isag004*g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag006,
                                    g_isag_d[l_ac].isag004,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,0,0)
                       RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                                 g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
                                 r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135                                   
                  END IF
               END IF
            END IF
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag101
            #add-point:BEFORE FIELD isag101 name="input.b.page1.isag101"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag101
            #add-point:ON CHANGE isag101 name="input.g.page1.isag101"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag103
            #add-point:BEFORE FIELD isag103 name="input.b.page1.isag103"
 
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag103
            
            #add-point:AFTER FIELD isag103 name="input.a.page1.isag103"
            IF NOT cl_null(g_isag_d[l_ac].isag103) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag103 <> g_isag_d_t.isag103 OR cl_null(g_isag_d_t.isag103))) THEN #160822-00008#8 Mark
               IF g_isag_d[l_ac].isag103 != g_isag_d_o.isag103 OR cl_null(g_isag_d_o.isag103) THEN #160822-00008#8
                  IF g_oodb004 = '2' OR (g_oodb004 = '1' AND g_isaf_m.isaf017 = 'N') THEN 
                     #160822-00008#8---(S)
                     LET g_isag_d[l_ac].isag104 = 0
                     LET g_isag_d[l_ac].isag105 = 0
                     LET g_isag_d[l_ac].isag113 = 0
                     LET g_isag_d[l_ac].isag114 = 0
                     LET g_isag_d[l_ac].isag115 = 0   
                     #160822-00008#8 ---(E)
                     IF NOT cl_null(g_isag_d[l_ac].isag004) THEN   
                        #160822-00008#8---(S)                     
                        LET r_xrcd123 = 0
                        LET r_xrcd124 = 0
                        LET r_xrcd125 = 0
                        LET r_xrcd133 = 0
                        LET r_xrcd134 = 0
                        LET r_xrcd135 = 0
                        #160822-00008#8---(E)
                        CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
                                       g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag006,
                                       g_isag_d[l_ac].isag004,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,0,0)
                          RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                                    g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
                                    r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135   
                     ELSE
                        CALL s_tax_count(g_isag_d[l_ac].isagorga,g_isaf_m.isaf016,g_isag_d[l_ac].isag103,
                                         0,g_isaf_m.isaf100,g_isaf_m.isaf101)
                             RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                                       g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115
                     END IF
                  ELSE
                     IF g_isaf_m.isaf017 = 'Y' THEN 
                        #160822-00008#8---(S)
                        LET g_isag_d[l_ac].isag113 = 0
                        LET g_isag_d[l_ac].isag114 = 0
                        LET g_isag_d[l_ac].isag115 = 0
                        #160822-00008#8---(E)
                        LET g_isag_d[l_ac].isag104 = g_isag_d[l_ac].isag105 - g_isag_d[l_ac].isag103
                        LET g_isag_d[l_ac].isag113 = g_isag_d[l_ac].isag103 * g_isaf_m.isaf101
                        LET g_isag_d[l_ac].isag114 = g_isag_d[l_ac].isag104 * g_isaf_m.isaf101
                        LET g_isag_d[l_ac].isag115 = g_isag_d[l_ac].isag105 * g_isaf_m.isaf101
                        #161214-00053#1 add ------
                        CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag113,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag113
                        CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag114,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag114
                        CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag115,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag115
                        #161214-00053#1 add end---
                     END IF
                  END IF
               END IF
               CALL aist310_isag105_chk()
               IF NOT cl_null(g_errno) THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = g_errno
                  LET g_errparam.extend = g_isag_d[l_ac].isag105
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  #LET g_isag_d[l_ac].isag103 = g_isag_d_t.isag103 #160822-00008#8 Mark
                  LET g_isag_d[l_ac].isag103 = g_isag_d_o.isag103  #160822-00008#8
                  NEXT FIELD isag103
               END IF
            END IF
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag103
            #add-point:ON CHANGE isag103 name="input.g.page1.isag103"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag104
            #add-point:BEFORE FIELD isag104 name="input.b.page1.isag104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag104
            
            #add-point:AFTER FIELD isag104 name="input.a.page1.isag104"
            IF NOT cl_null(g_isag_d[l_ac].isag104) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag104 <> g_isag_d_t.isag104 OR cl_null(g_isag_d_t.isag104))) THEN #160822-00008#8 Mark
               IF g_isag_d[l_ac].isag104 != g_isag_d_o.isag104 OR cl_null(g_isag_d_o.isag104) THEN #160822-00008#8
                  IF g_isaf_m.isaf017 = 'Y' THEN 
                     LET g_isag_d[l_ac].isag103 = 0 #160822-00008#8
                     LET g_isag_d[l_ac].isag103 = g_isag_d[l_ac].isag105 - g_isag_d[l_ac].isag104
                  ELSE
                     LET g_isag_d[l_ac].isag105 = 0 #160822-00008#8
                     LET g_isag_d[l_ac].isag105 = g_isag_d[l_ac].isag103 + g_isag_d[l_ac].isag104
                  END IF
                  LET g_isag_d[l_ac].isag113 = 0 #160822-00008#8
                  LET g_isag_d[l_ac].isag114 = 0 #160822-00008#8
                  LET g_isag_d[l_ac].isag115 = 0 #160822-00008#8
                  LET g_isag_d[l_ac].isag113 = g_isag_d[l_ac].isag103 * g_isaf_m.isaf101
                  LET g_isag_d[l_ac].isag114 = g_isag_d[l_ac].isag104 * g_isaf_m.isaf101
                  LET g_isag_d[l_ac].isag115 = g_isag_d[l_ac].isag105 * g_isaf_m.isaf101
                  #161214-00053#1 add ------
                  CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag113,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag113
                  CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag114,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag114
                  CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag115,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag115
                  #161214-00053#1 add end---
                  #170105-00017#1 add ------
                  IF NOT cl_null(g_isag_d_t.isag104) THEN  #170215-00025#1
                     LET g_isag3_d[l_ac].xrcd104 = g_isag_d[l_ac].isag104
                     CALL aist310_tax_amount('1')
                     IF g_success = 'N' THEN
                        LET g_isag_d[l_ac].isag104 = g_isag_d_o.isag104
                     END IF
                  END IF  #170215-00025#1
                  #170105-00017#1 add end---
               END IF
            END IF
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag104
            #add-point:ON CHANGE isag104 name="input.g.page1.isag104"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag105
            #add-point:BEFORE FIELD isag105 name="input.b.page1.isag105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag105
            
            #add-point:AFTER FIELD isag105 name="input.a.page1.isag105"
            IF NOT cl_null(g_isag_d[l_ac].isag105) THEN 
               CALL aist310_isag105_chk()
               IF NOT cl_null(g_errno) THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = g_errno
                  LET g_errparam.extend = g_isag_d[l_ac].isag105
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_isag_d[l_ac].isag105 = g_isag_d_t.isag105
                  NEXT FIELD isag105
               END IF
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag105 <> g_isag_d_t.isag105 OR cl_null(g_isag_d_t.isag105))) THEN #160822-00008#8 Mark
               IF g_isag_d[l_ac].isag105 != g_isag_d_o.isag105 OR cl_null(g_isag_d_o.isag105) THEN #160822-00008#8 
                  #170105-00017#1 mark ------
                  ##160822-00008#8---(S)
                  #LET g_isag_d[l_ac].isag103 = 0
                  #LET g_isag_d[l_ac].isag104 = 0
                  #LET g_isag_d[l_ac].isag113 = 0
                  #LET g_isag_d[l_ac].isag114 = 0
                  #LET g_isag_d[l_ac].isag115 = 0                  
                  ##160822-00008#8 ---(E)
                  #170105-00017#1 mark end---
                  IF g_oodb004 = '2' OR (g_oodb004 = '1' AND g_isaf_m.isaf017 = 'Y') THEN 
                     IF NOT cl_null(g_isag_d[l_ac].isag004) THEN
                        #160822-00008#8---(S)
                        LET r_xrcd123 = 0
                        LET r_xrcd124 = 0
                        LET r_xrcd125 = 0
                        LET r_xrcd133 = 0
                        LET r_xrcd134 = 0
                        LET r_xrcd135 = 0
                        #160822-00008#8 ---(E)
                        CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
                                       g_isag_d[l_ac].isag105,g_isag_d[l_ac].isag006,
                                       g_isag_d[l_ac].isag004,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,0,0)
                          RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                                    g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
                                    r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135   
                     ELSE
                        CALL s_tax_count(g_isag_d[l_ac].isagorga,g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag105,   #160322-00027#3 change g_isaf_m.isaf016 to g_isag_d[l_ac].isag006 lujh
                                         0,g_isaf_m.isaf100,g_isaf_m.isaf101)
                             RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                                       g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115
                     END IF
                  ELSE
                     IF g_isaf_m.isaf017 = 'N' THEN 
                        #160822-00008#8---(S)
                        LET g_isag_d[l_ac].isag104 = 0
                        LET g_isag_d[l_ac].isag113 = 0
                        LET g_isag_d[l_ac].isag114 = 0
                        LET g_isag_d[l_ac].isag115 = 0
                        #160822-00008#8 ---(E)
                        LET g_isag_d[l_ac].isag104 = g_isag_d[l_ac].isag105 - g_isag_d[l_ac].isag103
                        LET g_isag_d[l_ac].isag113 = g_isag_d[l_ac].isag103 * g_isaf_m.isaf101
                        LET g_isag_d[l_ac].isag114 = g_isag_d[l_ac].isag104 * g_isaf_m.isaf101
                        LET g_isag_d[l_ac].isag115 = g_isag_d[l_ac].isag105 * g_isaf_m.isaf101
                        #161214-00053#1 add ------
                        CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag113,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag113
                        CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag114,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag114
                        CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag115,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag115
                        #161214-00053#1 add end---
                     END IF
                  END IF
               END IF
            END IF
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag105
            #add-point:ON CHANGE isag105 name="input.g.page1.isag105"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag113
            #add-point:BEFORE FIELD isag113 name="input.b.page1.isag113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag113
            
            #add-point:AFTER FIELD isag113 name="input.a.page1.isag113"
            IF NOT cl_null(g_isag_d[l_ac].isag113) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag113 <> g_isag_d_t.isag113 OR cl_null(g_isag_d_t.isag113))) THEN #160822-00008#8 Mark
               IF g_isag_d[l_ac].isag113 != g_isag_d_o.isag113 OR cl_null(g_isag_d_o.isag113) THEN #160822-00008#8
                  IF g_oodb004 = '1' THEN 
                     IF g_isaf_m.isaf017 = 'Y' THEN 
                        LET g_isag_d[l_ac].isag114 = 0  #160822-00008#8
                        LET g_isag_d[l_ac].isag114 = g_isag_d[l_ac].isag115 - g_isag_d[l_ac].isag113
                     ELSE
                        LET g_isag_d[l_ac].isag115 = 0  #160822-00008#8
                        LET g_isag_d[l_ac].isag115 = g_isag_d[l_ac].isag113 + g_isag_d[l_ac].isag114
                     END IF 
                  END IF
               END IF
            END IF
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag113
            #add-point:ON CHANGE isag113 name="input.g.page1.isag113"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag114
            #add-point:BEFORE FIELD isag114 name="input.b.page1.isag114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag114
            
            #add-point:AFTER FIELD isag114 name="input.a.page1.isag114"
            IF NOT cl_null(g_isag_d[l_ac].isag114) THEN
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag114 <> g_isag_d_t.isag114 OR cl_null(g_isag_d_t.isag114))) THEN #160822-00008#8 Mark
               IF g_isag_d[l_ac].isag114 != g_isag_d_o.isag114 OR cl_null(g_isag_d_o.isag114) THEN #160822-00008#8
                  IF g_oodb004 = '1' THEN
                     IF g_isaf_m.isaf017 = 'Y' THEN
                        LET g_isag_d[l_ac].isag113 = 0 #160822-00008#8
                        LET g_isag_d[l_ac].isag113 = g_isag_d[l_ac].isag115 - g_isag_d[l_ac].isag114
                     ELSE
                        LET g_isag_d[l_ac].isag115 = 0 #160822-00008#8
                        LET g_isag_d[l_ac].isag115 = g_isag_d[l_ac].isag113 + g_isag_d[l_ac].isag114
                     END IF
                  END IF
                  #170105-00017#1 add ------
                  IF NOT cl_null(g_isag_d_t.isag104) THEN  #170215-00025#1
                     LET g_isag3_d[l_ac].xrcd114 = g_isag_d[l_ac].isag114
                     CALL aist310_tax_amount('2')
                     IF g_success = 'N' THEN
                        LET g_isag_d[l_ac].isag114 = g_isag_d_o.isag114
                     END IF
                  END IF #170215-00025#1
                  #170105-00017#1 add end---
               END IF
            END IF
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag114
            #add-point:ON CHANGE isag114 name="input.g.page1.isag114"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag115
            #add-point:BEFORE FIELD isag115 name="input.b.page1.isag115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag115
            
            #add-point:AFTER FIELD isag115 name="input.a.page1.isag115"
            IF NOT cl_null(g_isag_d[l_ac].isag115) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag115 <> g_isag_d_t.isag115 OR cl_null(g_isag_d_t.isag115))) THEN #160822-00008#8 Mark
               IF g_isag_d[l_ac].isag115 != g_isag_d_o.isag115 OR cl_null(g_isag_d_o.isag115) THEN #160822-00008#8
                  IF g_oodb004 = '1' THEN 
                     IF g_isaf_m.isaf017 = 'Y' THEN 
                        LET g_isag_d[l_ac].isag113 = 0 #160822-00008#8
                        LET g_isag_d[l_ac].isag113 = g_isag_d[l_ac].isag115 - g_isag_d[l_ac].isag114
                     ELSE
                        LET g_isag_d[l_ac].isag114 = 0 #160822-00008#8
                        LET g_isag_d[l_ac].isag114 = g_isag_d[l_ac].isag115 - g_isag_d[l_ac].isag113
                     END IF 
                  END IF
               END IF
            END IF
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag115
            #add-point:ON CHANGE isag115 name="input.g.page1.isag115"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag116
            #add-point:BEFORE FIELD isag116 name="input.b.page1.isag116"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag116
            
            #add-point:AFTER FIELD isag116 name="input.a.page1.isag116"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag116
            #add-point:ON CHANGE isag116 name="input.g.page1.isag116"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag117
            #add-point:BEFORE FIELD isag117 name="input.b.page1.isag117"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag117
            
            #add-point:AFTER FIELD isag117 name="input.a.page1.isag117"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag117
            #add-point:ON CHANGE isag117 name="input.g.page1.isag117"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag013
            #add-point:BEFORE FIELD isag013 name="input.b.page1.isag013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag013
            
            #add-point:AFTER FIELD isag013 name="input.a.page1.isag013"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag013
            #add-point:ON CHANGE isag013 name="input.g.page1.isag013"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag014
            #add-point:BEFORE FIELD isag014 name="input.b.page1.isag014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag014
            
            #add-point:AFTER FIELD isag014 name="input.a.page1.isag014"
            #151029-00001#3 add ------
            IF NOT cl_null(g_isag_d[l_ac].isag014) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag_d[l_ac].isag014 <> g_isag_d_t.isag014 OR cl_null(g_isag_d_t.isag014))) THEN #160822-00008#8 Mark
               IF g_isag_d[l_ac].isag014 != g_isag_d_o.isag014 OR cl_null(g_isag_d_o.isag014) THEN #160822-00008#8
                  #檢核發票碼是否存在於發票歷程檔
                  LET l_cnt = 0
                  IF g_isai002 = '1' THEN
                     #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
                     SELECT COUNT(1) INTO l_cnt #160907-00046#1
                       FROM isat_t
                      WHERE isatent = g_enterprise
                        AND isat004 = g_isag_d[l_ac].isag014
                        AND isat014 = '11'
                        AND isat025 <> '12'
                  ELSE
                     #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
                     SELECT COUNT(1) INTO l_cnt #160907-00046#1
                       FROM isat_t
                      WHERE isatent = g_enterprise
                        AND isat003 = g_isag_d[l_ac].isag013
                        AND isat004 = g_isag_d[l_ac].isag014
                        AND isat014 = '11'
                        AND isat025 <> '12'
                  END IF
                  IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                  IF l_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'aap-00201'
                     LET g_errparam.extend = g_isag_d[l_ac].isag014
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     #LET g_isag_d[l_ac].isag014 = g_isag_d_t.isag014 #160822-00008#8 Mark
                     LET g_isag_d[l_ac].isag014 = g_isag_d_o.isag014  #160822-00008#8
                     NEXT FIELD isat004
                  END IF
                  IF g_isaf_m.isaf056 = '2' AND g_isai002 = '1' THEN #161127-00002#1
                     #檢核金額有沒有超折
                     CALL aist310_isag014_chk("1",g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,g_isag_d[l_ac].isag013,g_isag_d[l_ac].isag014,g_isag_d[l_ac].isag103)
                          RETURNING g_sub_success,g_errno
                     IF NOT g_sub_success THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = g_isag_d[l_ac].isag014
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        #LET g_isag_d[l_ac].isag014 = g_isag_d_t.isag014 #160822-00008#8 Mark
                        LET g_isag_d[l_ac].isag014 = g_isag_d_o.isag014  #160822-00008#8
                        NEXT FIELD isag014
                     END IF
                  END IF #161127-00002#1
               END IF
            END IF
            LET g_isag_d_o.* = g_isag_d[l_ac].*  #160822-00008#8
            #151029-00001#3 add end---
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag014
            #add-point:ON CHANGE isag014 name="input.g.page1.isag014"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isag011
            #add-point:BEFORE FIELD isag011 name="input.b.page1.isag011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isag011
            
            #add-point:AFTER FIELD isag011 name="input.a.page1.isag011"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isag011
            #add-point:ON CHANGE isag011 name="input.g.page1.isag011"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page1.isagseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isagseq
            #add-point:ON ACTION controlp INFIELD isagseq name="input.c.page1.isagseq"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isagorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isagorga
            #add-point:ON ACTION controlp INFIELD isagorga name="input.c.page1.isagorga"
            #開窗i段-來源組織
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isag_d[l_ac].isagorga
           #CALL s_fin_create_account_center_tmp()
            #CALL s_fin_account_center_sons_query('3',g_isaf_m.isafcomp,g_today,'')    #160317-00024#1 change g_isaf_m.isafsite to g_isaf_m.isafcomp lujh  #160907-00041#1 mark
           #CALL s_fin_account_center_comp_str()RETURNING l_origin_str #150603-00046#1 mark
            CALL s_fin_account_center_sons_query('3',g_isaf_m.isafsite,g_today,'')    #160907-00041#1 add
            CALL s_fin_account_center_sons_str()RETURNING l_origin_str #150603-00046#1
            CALL aist310_change_to_sql(l_origin_str)RETURNING l_origin_str
            LET g_qryparam.where = " ooef001 IN (",l_origin_str CLIPPED,")",
                                   " AND ooef201 = 'Y'"   #161006-00005#29   add
            IF g_para_data = 'Y' THEN 
               LET g_qryparam.where = g_qryparam.where," AND ooef017 ='",g_isaf_m.isafcomp,"' "
            END IF
            CALL q_ooef001()
            LET g_isag_d[l_ac].isagorga = g_qryparam.return1
            DISPLAY g_isag_d[l_ac].isagorga TO isagorga
            CALL aist310_ref_b_1()
            NEXT FIELD isagorga
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag001
            #add-point:ON ACTION controlp INFIELD isag001 name="input.c.page1.isag001"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag002
            #add-point:ON ACTION controlp INFIELD isag002 name="input.c.page1.isag002"
            #開窗i段-來源單號
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isag_d[l_ac].isag002
            LET g_qryparam.default2 = g_isag_d[l_ac].isag003
            
            LET l_n = 0
            #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
            SELECT COUNT(1) INTO l_n #160907-00046#1
              FROM isag_t
             WHERE isagent = g_enterprise
               AND isagcomp = g_isaf_m.isafcomp
               AND isagdocno = g_isaf_m.isafdocno
            SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_xrca_m.xrca004   #160802-00007#1 Add
            #訂單
            IF g_isag_d[l_ac].isag001 = '10' THEN   #axmt500
               LET g_qryparam.where = "     xmdasite = '",g_isag_d[l_ac].isagorga,"'",
                                      " AND xmdb016 IN ('1','2')"   #160316-00017#2 add lujh
               IF l_n > 0 THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmda004 = '",g_isaf_m.isaf003,"'",
                                                          " AND xmda021 = '",g_isaf_m.isaf055,"'"
               END IF
               #160802-00007#1 Add  ---(S)---
               IF l_pmaa004 = '2' THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmda028 = '",g_isaf_m.isaf067,"'"
               END IF
               #160802-00007#1 Add  ---(E)---
               LET g_qryparam.arg1 = '1'
               LET g_qryparam.arg2 = g_isaf_m.isafdocdt
               LET g_qryparam.arg3 = g_isaf_m.isaf003
               CALL q_xmdb_1()
               #160316-00017#2--add--str--lujh
               LET g_isag_d[l_ac].isag002 = g_qryparam.return1
               LET l_isag011 = g_qryparam.return2
               IF NOT cl_null(g_qryparam.return1) THEN 
                  CALL aist310_isag_ins_10(g_isag_d[l_ac].isag002,l_isag011,g_isag_d[l_ac].isagorga)
                  LET l_flag = 'Y'
                  LET l_isag_flag = 'Y'
                  EXIT DIALOG
                ELSE
                  NEXT FIELD isag002
               END IF
               #160316-00017#2--add--end--lujh
            END IF
            
            #出貨單
            IF g_isag_d[l_ac].isag001 = '11' THEN    #axmt540
               #151123-00013#7-----s
               #LET g_qryparam.where = " xmdk000 <> '6'",
               #                       " AND xmdksite = '",g_isag_d[l_ac].isagorga,"'"
               #IF l_n > 0 THEN
               #   LET g_qryparam.where = g_qryparam.where," AND xmdk007 = '",g_isaf_m.isaf003,"'",
               #                                           " AND xmdk008 = '",g_isaf_m.isaf055,"'"
               #END IF
               #LET g_qryparam.arg1 = g_isaf_m.isafdocdt
               #LET g_qryparam.arg2 = g_isaf_m.isaf003
               #LET g_qryparam.arg3 = g_isaf_m.isaf016   #稅別 #150603-00046#1
               #LET g_qryparam.arg4 = g_isaf_m.isaf100   #幣別 #150603-00046#1
               #CALL q_xmdl_4()
               LET g_qryparam.where = " 1=1 ",
                                   " AND xmdksite = '",g_isag_d[l_ac].isagorga,"' ",
                                   " AND xmdk001 <= '",g_isaf_m.isafdocdt,"' ",
                                   " AND xmdl087 = 'Y' ",
                                   " AND (xmdl022 - xmdl047) > 0 ",
                                   " AND xmdk012 = '",g_isaf_m.isaf016,"'",
                                   " AND xmdk016 = '",g_isaf_m.isaf100,"'",
                                   " AND xmdk008 = '",g_isaf_m.isaf003,"'",
                                   " AND xmdk202 = '",g_isaf_m.isaf002,"'"
               LET g_qryparam.where = g_qryparam.where CLIPPED,
                                      " AND ((xmdk000 IN ('1','2','3') AND xmdkstus = 'S' AND xmdk002  ='1')  OR  (xmdk000 = '4' AND xmdkstus = 'Y' and xmdk002  ='3'))"   
               IF l_n > 0 THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmdk007 = '",g_isaf_m.isaf003,"'",
                                                          " AND xmdk008 = '",g_isaf_m.isaf055,"'"
               END IF
               #160802-00007#1 Add  ---(S)---
               IF l_pmaa004 = '2' THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmdk047 = '",g_isaf_m.isaf067,"'"
               END IF
               #160802-00007#1 Add  ---(E)---
               CALL q_xmdkdocno_17()
               #151123-00013#7-----e
            END IF
            
            #銷退單
            IF g_isag_d[l_ac].isag001 = '21' THEN   #axmt600
               #151123-00013#7-----s
               #LET g_qryparam.where = " xmdk000 = '6'",
               #                       " AND xmdksite = '",g_isag_d[l_ac].isagorga,"'",
               #                       " AND xmdk012 = '",g_isaf_m.isaf016,"'",
               #                       " AND xmdk016 = '",g_isaf_m.isaf100,"'"
               #IF l_n > 0 THEN
               #   LET g_qryparam.where = g_qryparam.where," AND xmdk007 = '",g_isaf_m.isaf003,"'",
               #                                           " AND xmdk008 = '",g_isaf_m.isaf055,"'"
               #END IF
               #LET g_qryparam.arg1 = '1'
               #LET g_qryparam.arg2 = g_isaf_m.isafdocdt
               #LET g_qryparam.arg3 = g_isaf_m.isaf003
               #CALL q_xmdl_21()
               LET g_qryparam.where = " 1=1 ",
                                   " AND xmdksite = '",g_isag_d[l_ac].isagorga,"' ",
                                   " AND xmdk001 <= '",g_isaf_m.isafdocdt,"' ",
                                   " AND xmdl087 = 'Y' ",
                                   " AND (xmdl022 - xmdl047) > 0 ",
                                   " AND xmdk012 = '",g_isaf_m.isaf016,"'",
                                   " AND xmdk016 = '",g_isaf_m.isaf100,"'",
                                   " AND xmdk008 = '",g_isaf_m.isaf003,"'",
                                   " AND xmdk202 = '",g_isaf_m.isaf002,"'"
               LET g_qryparam.where = g_qryparam.where CLIPPED,
                                      #" AND ((xmdk006 = '6' AND xmdkstus = 'S' AND xmdk002  ='1') OR (xmdk005 = '5' AND xmdkstus = 'Y' AND xmdk002  ='3')) "     #151207-00018#2 mark
                                      " AND (xmdk000 = '6' AND xmdkstus = 'S' AND xmdk082 <> '5') "   #albireo 151208 add
               IF l_n > 0 THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmdk007 = '",g_isaf_m.isaf003,"'",
                                                          " AND xmdk008 = '",g_isaf_m.isaf055,"'"
               END IF
               #160802-00007#1 Add  ---(S)---
               IF l_pmaa004 = '2' THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmdk047 = '",g_isaf_m.isaf067,"'"
               END IF
               #160802-00007#1 Add  ---(E)---
               CALL q_xmdkdocno_17()
               #151123-00013#7-----s
            END IF
            
            #其他待抵單
            IF g_isag_d[l_ac].isag001 = '27' THEN
               LET g_qryparam.arg1 = g_isaf_m.isaf003
               LET g_qryparam.arg2 = g_glaald
               LET g_qryparam.arg3 = g_isaf_m.isafsite
               LET g_qryparam.arg4 = g_isaf_m.isafdocdt
               #160909-00081#1-s
               #若訂金預收尚未收款則需控卡不可輸入
               LET g_qryparam.where = " xrca018 IN (SELECT xrcadocno ", 
                                      "               FROM xrcc_t",
                                      "               LEFT JOIN xrca_t ON xrccent=xrcaent AND xrccdocno=xrcadocno",
                                      "              WHERE xrccent = ",g_enterprise,
                                      "                AND xrcc108-xrcc109 = 0)"
               #160802-00007#1 Add  ---(S)---
               IF l_pmaa004 = '2' THEN
                  LET g_qryparam.where = g_qryparam.where," AND xrca057 = '",g_isaf_m.isaf067,"'"
               END IF
               #160802-00007#1 Add  ---(E)---
               CALL q_xrcadocno_11()
            END IF
            
            #160426-00013#2-s
            #訂金走axrt300
            IF g_isag_d[l_ac].isag001 = '29' THEN
               LET g_qryparam.where = " xrcastus = 'Y' AND xrca001='17' ",
                                      " AND xrca016='10' AND xrca018 IS NOT NULL",
                                      " AND xrcasite = '",g_isag_d[l_ac].isagorga,"' ",
                                      " AND xrcald = '",g_glaald,"' ",
                                      " AND xrcadocdt <= '",g_isaf_m.isafdocdt,"' ",
                                      " AND (xrcc108-xrcc109) > 0 ",
                                      " AND xrca011 = '",g_isaf_m.isaf016,"'",
                                      " AND xrca100 = '",g_isaf_m.isaf100,"'",
                                      " AND xrca004 = '",g_isaf_m.isaf003,"'"
               #160802-00007#1 Add  ---(S)---
               IF l_pmaa004 = '2' THEN
                  LET g_qryparam.where = g_qryparam.where," AND xrca057 = '",g_isaf_m.isaf067,"'"
               END IF
               #160802-00007#1 Add  ---(E)---
               CALL q_xrcadocno_13()
            END IF
            #160426-00013#2-e
            
            #150518-00046#4--s
            #維修單
            IF g_isag_d[l_ac].isag001 = '12' THEN
               CALL s_fin_account_center_sons_query('3',g_isaf_m.isafsite,g_today,'')
               CALL s_fin_account_center_sons_str()RETURNING l_origin_str
               CALL s_fin_get_wc_str(l_origin_str) RETURNING l_origin_str
               LET g_qryparam.arg1 = g_isaf_m.isaf003
               LET g_qryparam.arg2 = g_isaf_m.isaf002
               LET g_qryparam.arg3 = g_isaf_m.isaf016
               LET g_qryparam.arg4 = g_isaf_m.isaf100
               LET g_qryparam.where = " rmdasite IN ",l_origin_str," ",
                                      "   AND rmdasite IN(",
                                      "       SELECT ooef001 FROM ooef_t WHERE ooefent = ",g_enterprise," ",
                                      "         AND ooef017 = '",g_isaf_m.isafcomp,"') ",
                                      "   AND rmda001 <= '",g_isaf_m.isafdocdt,"' ",
                                      "   AND (rmdb013-COALESCE((SELECT SUM(isag004) FROM isag_t ",
                                      "                          WHERE isagent = ",g_enterprise," ",
                                      "                            AND isagcomp = '",g_isaf_m.isafcomp,"' ",
                                      "                            AND isagent = rmdaent ",
                                      "                            AND isag002 = rmdadocno ",
                                      "                            AND isag003 = rmdbseq ",
                                      "                            AND (EXISTS (SELECT 1 FROM isaf_t ",
                                      "                                  WHERE isafent = isagent ",
                                      "                                    AND isafcomp = isagcomp ",
                                      "                                    AND isafdocno = isagdocno ",
                                      "                                    AND isafstus <> 'X'))),0)) > 0 ",
                                      "   AND EXISTS (SELECT 1 FROM pmaa_t,pmab_t ",
                                      "                WHERE pmab001 = pmaa001 AND pmabent = pmaaent ",
                                      "                  AND pmaaent = ",g_enterprise," AND ",g_ctl_where,
                                      "                  AND pmabsite = '",g_isaf_m.isafcomp,"'",
                                      "                  AND pmaaent = rmdaent",
                                      "                  AND pmaa001 = rmda005 )"
               CALL q_rmdadocno_3()
            END IF
            #150518-00046#4--e
            #160614-00025#1 --s add
            #13:門店銷售單 /#22:門店銷退單
            IF g_isag_d[l_ac].isag001 = '13' OR g_isag_d[l_ac].isag001 = '22' THEN
               LET g_qryparam.where = " rtiastus = 'S' ",
                                      " AND rtiasite = '",g_isag_d[l_ac].isagorga,"'",
                                      " AND rtiadocdt <= '",g_isaf_m.isafdocdt,"' ",
                                      " AND rtib017 IS NOT NULL ", #計價數量
                                      " AND rtib006 = '",g_isaf_m.isaf016,"'",
                                      " AND rtia026 = '",g_isaf_m.isaf100,"'",
                                      " AND rtia002 = '",g_isaf_m.isaf003,"'",
                                      " AND NOT EXISTS (SELECT 1 FROM isaf_t,isag_t ",
                                      "                  WHERE isafent = isagent AND isafcomp = isagcomp AND isafdocno = isagdocno ",
                                      "                    AND isag002 = rtiadocno AND isag003 = rtibseq AND isafstus <> 'X' )"
               CASE
                  WHEN g_isag_d[l_ac].isag001 = '13'
                     LET g_qryparam.where = g_qryparam.where," AND rtia000 IN ('artt600','artt610','artt620') "
                  WHEN g_isag_d[l_ac].isag001 = '22'
                     LET g_qryparam.where = g_qryparam.where," AND rtia000 = 'artt700' "
               END CASE
               #161024-00065#2 add ------
               IF g_sfin2023 = '1' THEN
                  LET g_qryparam.where = g_qryparam.where," AND rtia032 IN ('1','4')"
               ELSE
                  LET g_qryparam.where = g_qryparam.where," AND rtia032 IN ('1')"
               END IF
               #161024-00065#2 add end---
               CALL q_rtiadocno_4()
            END IF
            #160614-00025#1 --e add

            LET g_isag_d[l_ac].isag002 = g_qryparam.return1
            LET g_isag_d[l_ac].isag003 = g_qryparam.return2
            DISPLAY g_isag_d[l_ac].isag002 TO isag002
            DISPLAY g_isag_d[l_ac].isag003 TO isag003
            CALL aist310_ref_b_1()
            NEXT FIELD isag002
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag003
            #add-point:ON ACTION controlp INFIELD isag003 name="input.c.page1.isag003"
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isag_d[l_ac].isag003
            CALL q_xrcadocno_2()
            LET g_isag_d[l_ac].isag003 = g_qryparam.return1
            DISPLAY g_isag_d[l_ac].isag003 TO isag003
            NEXT FIELD isag003
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag018
            #add-point:ON ACTION controlp INFIELD isag018 name="input.c.page1.isag018"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag009
            #add-point:ON ACTION controlp INFIELD isag009 name="input.c.page1.isag009"
            #此段落由子樣板a07產生
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isag_d[l_ac].isag009
            LET g_qryparam.arg1 = g_isag_d[l_ac].isagorga
            CALL q_imaf001_7()
            LET g_isag_d[l_ac].isag009 = g_qryparam.return1
            DISPLAY g_isag_d[l_ac].isag009 TO isag009
            CALL aist310_ref_b_1()
            NEXT FIELD isag009
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag010
            #add-point:ON ACTION controlp INFIELD isag010 name="input.c.page1.isag010"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.imaal004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD imaal004
            #add-point:ON ACTION controlp INFIELD imaal004 name="input.c.page1.imaal004"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag016
            #add-point:ON ACTION controlp INFIELD isag016 name="input.c.page1.isag016"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag017
            #add-point:ON ACTION controlp INFIELD isag017 name="input.c.page1.isag017"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag015
            #add-point:ON ACTION controlp INFIELD isag015 name="input.c.page1.isag015"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.inag009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD inag009
            #add-point:ON ACTION controlp INFIELD inag009 name="input.c.page1.inag009"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.xmdl047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xmdl047
            #add-point:ON ACTION controlp INFIELD xmdl047 name="input.c.page1.xmdl047"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.inag007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD inag007
            #add-point:ON ACTION controlp INFIELD inag007 name="input.c.page1.inag007"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.inag007_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD inag007_desc
            #add-point:ON ACTION controlp INFIELD inag007_desc name="input.c.page1.inag007_desc"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag006
            #add-point:ON ACTION controlp INFIELD isag006 name="input.c.page1.isag006"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag008
            #add-point:ON ACTION controlp INFIELD isag008 name="input.c.page1.isag008"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag012
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag012
            #add-point:ON ACTION controlp INFIELD isag012 name="input.c.page1.isag012"
            #收款條件
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isag_d[l_ac].isag012
            #CALL q_ooib001_1()  #161020-00002#1 mark
            #161020-00002#1 add ------
            IF cl_null(g_isaf_m.isaf003) THEN
               CALL q_ooib001_1()
            ELSE
               LET g_qryparam.arg1 = g_isaf_m.isaf003
               LET g_qryparam.arg2 = '2'
               CALL q_pmad002()
            END IF
            #161020-00002#1 add end---
            LET g_isag_d[l_ac].isag012 = g_qryparam.return1
            DISPLAY g_isag_d[l_ac].isag012 TO isag012
            NEXT FIELD isag012
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag004
            #add-point:ON ACTION controlp INFIELD isag004 name="input.c.page1.isag004"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag005
            #add-point:ON ACTION controlp INFIELD isag005 name="input.c.page1.isag005"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag005_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag005_desc
            #add-point:ON ACTION controlp INFIELD isag005_desc name="input.c.page1.isag005_desc"
            #發票單位
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isag_d[l_ac].isag005_desc
            CALL q_ooca001_1()
            LET g_isag_d[l_ac].isag005 = g_qryparam.return1
            CALL aist310_ref_b_1()
            DISPLAY g_isag_d[l_ac].isag005_desc TO isag005_desc
            NEXT FIELD isag005_desc
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag101
            #add-point:ON ACTION controlp INFIELD isag101 name="input.c.page1.isag101"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag103
            #add-point:ON ACTION controlp INFIELD isag103 name="input.c.page1.isag103"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag104
            #add-point:ON ACTION controlp INFIELD isag104 name="input.c.page1.isag104"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag105
            #add-point:ON ACTION controlp INFIELD isag105 name="input.c.page1.isag105"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag113
            #add-point:ON ACTION controlp INFIELD isag113 name="input.c.page1.isag113"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag114
            #add-point:ON ACTION controlp INFIELD isag114 name="input.c.page1.isag114"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag115
            #add-point:ON ACTION controlp INFIELD isag115 name="input.c.page1.isag115"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag116
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag116
            #add-point:ON ACTION controlp INFIELD isag116 name="input.c.page1.isag116"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag117
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag117
            #add-point:ON ACTION controlp INFIELD isag117 name="input.c.page1.isag117"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag013
            #add-point:ON ACTION controlp INFIELD isag013 name="input.c.page1.isag013"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag014
            #add-point:ON ACTION controlp INFIELD isag014 name="input.c.page1.isag014"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isag011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isag011
            #add-point:ON ACTION controlp INFIELD isag011 name="input.c.page1.isag011"
            
            #END add-point
 
 
 
 
         ON ROW CHANGE
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_isag_d[l_ac].* = g_isag_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE aist310_bcl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
              
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = g_isag_d[l_ac].isagseq 
               LET g_errparam.code = -263 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               LET g_isag_d[l_ac].* = g_isag_d_t.*
            ELSE
            
               #add-point:單身修改前 name="input.body.b_update"
               #170117-00067#1 add ------
               #先把舊的數量減掉，後面在新增
               IF g_isag_d[l_ac].isag001 != g_isag_d_t.isag001 OR g_isag_d[l_ac].isag002 != g_isag_d_t.isag002 OR g_isag_d[l_ac].isag003 != g_isag_d_t.isag003 OR g_isag_d[l_ac].isag004 != g_isag_d_t.isag004 THEN
                  CALL aist310_upd_xmdl(g_isag_d[l_ac].isagseq,g_isag_d_t.isag002,g_isag_d_t.isag003,'-') RETURNING l_success
                  IF l_success = FALSE THEN
                     CALL s_transaction_end('N','0')
                  END IF
               END IF
               #170117-00067#1 add end---
               #end add-point
               
               #寫入修改者/修改日期資訊(單身)
               
      
               #將遮罩欄位還原
               CALL aist310_isag_t_mask_restore('restore_mask_o')
      
               UPDATE isag_t SET (isagcomp,isagdocno,isagseq,isagorga,isag001,isag002,isag003,isag018, 
                   isag009,isag010,isag016,isag017,isag015,isag006,isag008,isag012,isag004,isag005,isag101, 
                   isag103,isag104,isag105,isag113,isag114,isag115,isag116,isag117,isag013,isag014,isag011) = (g_isaf_m.isafcomp, 
                   g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,g_isag_d[l_ac].isagorga,g_isag_d[l_ac].isag001, 
                   g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003,g_isag_d[l_ac].isag018,g_isag_d[l_ac].isag009, 
                   g_isag_d[l_ac].isag010,g_isag_d[l_ac].isag016,g_isag_d[l_ac].isag017,g_isag_d[l_ac].isag015, 
                   g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag008,g_isag_d[l_ac].isag012,g_isag_d[l_ac].isag004, 
                   g_isag_d[l_ac].isag005,g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104, 
                   g_isag_d[l_ac].isag105,g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115, 
                   g_isag_d[l_ac].isag116,g_isag_d[l_ac].isag117,g_isag_d[l_ac].isag013,g_isag_d[l_ac].isag014, 
                   g_isag_d[l_ac].isag011)
                WHERE isagent = g_enterprise AND isagcomp = g_isaf_m.isafcomp 
                  AND isagdocno = g_isaf_m.isafdocno 
 
                  AND isagseq = g_isag_d_t.isagseq #項次   
 
                  
               #add-point:單身修改中 name="input.body.m_update"
               IF l_ac = 1 THEN 
                  IF g_isag_d[l_ac].isag001 = '10' OR g_isag_d[l_ac].isag001 = '11' OR g_isag_d[l_ac].isag001 = '21' THEN
                     UPDATE isaf_t SET isaf003 = g_isaf003,
                                       isaf055 = g_isaf055
                      WHERE isafent = g_enterprise
                        AND isafcomp = g_isaf_m.isafcomp
                        AND isafdocno = g_isaf_m.isafdocno
                  END IF
               END IF   
               #end add-point
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_isag_d[l_ac].* = g_isag_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isag_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.SQLCODE #其他錯誤
                     LET g_isag_d[l_ac].* = g_isag_d_t.*  
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isag_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()                   
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys_bak[1] = g_isafcomp_t
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys_bak[2] = g_isafdocno_t
               LET gs_keys[3] = g_isag_d[g_detail_idx].isagseq
               LET gs_keys_bak[3] = g_isag_d_t.isagseq
               CALL aist310_update_b('isag_t',gs_keys,gs_keys_bak,"'1'")
               END CASE
 
               #將遮罩欄位進行遮蔽
               CALL aist310_isag_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT(g_isag_d[g_detail_idx].isagseq = g_isag_d_t.isagseq 
 
                  ) THEN
                  LET gs_keys[01] = g_isaf_m.isafcomp
                  LET gs_keys[gs_keys.getLength()+1] = g_isaf_m.isafdocno
 
                  LET gs_keys[gs_keys.getLength()+1] = g_isag_d_t.isagseq
 
                  CALL aist310_key_update_b(gs_keys,'isag_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag_d_t)
               LET g_log2 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身修改後 name="input.body.a_update"
               CALL aist310_xrcd_upd()
               CALL aist310_isaf_sum()
               #若整批產生會回寫已開發票數量，因此這邊增加判斷，數量不一樣才回寫即可，不然會重複回寫虛增
               IF g_isag_d[l_ac].isag004 != g_isag_d_t.isag004 THEN #160510-00020#1
                  #151223-00001#3--add--str--lujh
                  CALL aist310_upd_xmdl(g_isag_d[l_ac].isagseq,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003,'+') RETURNING l_success
                  IF l_success = FALSE THEN
                     CALL s_transaction_end('N','0')
                  END IF
                  #151223-00001#3--add--str--lujh
               END IF #160510-00020#1
               #end add-point
 
            END IF
            
         AFTER ROW
            #add-point:單身after_row name="input.body.after_row"
            
            #end add-point
            CALL aist310_unlock_b("isag_t","'1'")
            CALL s_transaction_end('Y','0')
            #其他table進行unlock
            #add-point:單身after_row2 name="input.body.after_row2"
            
            #end add-point
              
         AFTER INPUT
            #add-point:input段after input  name="input.body.after_input"
            
            #end add-point 
    
         ON ACTION controlo    
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_isag_d[li_reproduce_target].* = g_isag_d[li_reproduce].*
 
               LET g_isag_d[li_reproduce_target].isagseq = NULL
 
            ELSE
               CALL FGL_SET_ARR_CURR(g_isag_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_isag_d.getLength()+1
            END IF
            
         #ON ACTION cancel
         #   LET INT_FLAG = 1
         #   LET g_detail_idx = 1
         #   EXIT DIALOG 
 
      END INPUT
      
      INPUT ARRAY g_isag2_d FROM s_detail2.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = l_allow_insert, #此頁面insert功能由產生器控制, 手動之設定無效! 
 
                 DELETE ROW = l_allow_delete,
                 APPEND ROW = l_allow_insert)
                 
         #自訂ACTION(detail_input,page_2)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body2.before_input2"
            #161110-00004-----s
            LET l_n = NULL
            SELECT COUNT(1) INTO l_n 
              FROM isat_t
             WHERE isatent = g_enterprise
               AND isatcomp = g_isaf_m.isafcomp
               AND isatdocno = g_isaf_m.isafdocno
               
            IF l_n > 0 THEN 
               #INITIALIZE g_errparam TO NULL
               #LET g_errparam.code = 'ais-00179'
               #LET g_errparam.extend = ''
               #LET g_errparam.popup = TRUE
               #CALL cl_err()
               NEXT FIELD isagorga
            END IF
            #161110-00004-----e
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_isag2_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aist310_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'2',"))
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_isag2_d.getLength()
            #add-point:資料輸入前 name="input.body2.before_input"
            CALL g_isag2_d.deleteElement(g_rec_b)
            #end add-point
            
         BEFORE INSERT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_isag2_d[l_ac].* TO NULL 
            INITIALIZE g_isag2_d_t.* TO NULL 
            INITIALIZE g_isag2_d_o.* TO NULL 
            #公用欄位給值(單身2)
            
            #自定義預設值(單身2)
                  LET g_isag2_d[l_ac].isah006 = "0"
      LET g_isag2_d[l_ac].isah101 = "0"
      LET g_isag2_d[l_ac].isah103 = "0"
      LET g_isag2_d[l_ac].isah104 = "0"
      LET g_isag2_d[l_ac].isah105 = "0"
      LET g_isag2_d[l_ac].isah113 = "0"
      LET g_isag2_d[l_ac].isah114 = "0"
      LET g_isag2_d[l_ac].isah115 = "0"
      LET g_isag2_d[l_ac].isah011 = "0"
      LET g_isag2_d[l_ac].isah106 = "0"
      LET g_isag2_d[l_ac].isah116 = "0"
 
            #add-point:modify段before備份 name="input.body2.insert.before_bak"
            
            #end add-point
            LET g_isag2_d_t.* = g_isag2_d[l_ac].*     #新輸入資料
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aist310_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body2.insert.after_set_entry_b"
            
            #end add-point
            CALL aist310_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_isag2_d[li_reproduce_target].* = g_isag2_d[li_reproduce].*
 
               LET g_isag2_d[li_reproduce_target].isahseq = NULL
            END IF
            
 
            #add-point:modify段before insert name="input.body2.before_insert"
            SELECT isac006 INTO l_isac006
              FROM isac_t
             WHERE isacent = g_enterprise
               AND isac001 = g_ooef019
               AND isac002 = g_isaf_m.isaf008
            
            LET l_n = 0
            #SELECT COUNT(*) INTO l_n #160907-00046#1
            SELECT COUNT(1) INTO l_n  #160907-00046#1
              FROM isah_t
             WHERE isahent = g_enterprise
               AND isahcomp = g_isaf_m.isafcomp
               AND isahdocno = g_isaf_m.isafdocno 
            IF l_cmd = 'a' THEN
               IF l_n >= l_isac006 AND l_isac006 <> 0 THEN     
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00089'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  EXIT DIALOG
               ELSE
                  IF cl_null(g_isag2_d[g_detail_idx].isahseq) THEN 
                     SELECT MAX(isahseq) INTO g_isag2_d[g_detail_idx].isahseq
                       FROM isah_t
                      WHERE isahent = g_enterprise
                        AND isahcomp = g_isaf_m.isafcomp
                        AND isahdocno = g_isaf_m.isafdocno
                        
                     IF cl_null(g_isag2_d[g_detail_idx].isahseq) THEN 
                        LET g_isag2_d[g_detail_idx].isahseq = 1
                     ELSE
                        LET g_isag2_d[g_detail_idx].isahseq = g_isag2_d[g_detail_idx].isahseq + 1
                     END IF
                  END IF
               END IF
            END IF
            LET g_isag2_d[l_ac].isah007 = g_isaf_m.isaf018
            IF l_ac = 1 THEN 
               LET g_isag2_d[l_ac].isah001 = g_isaf_m.isaf010
               LET g_isag2_d[l_ac].isah002 = g_isaf_m.isaf011
            END IF
            
            IF l_ac > 1 THEN 
               LET g_isag2_d[l_ac].isah001 = g_isag2_d[l_ac-1].isah001
               LET g_isag2_d[l_ac].isah002 = g_isag2_d[l_ac-1].isah002
            END IF
            
            IF g_isaf_m.isaf056 = '1' THEN 
               LET g_isag2_d[l_ac].isah010 = 1
            ELSE
               LET g_isag2_d[l_ac].isah010 = -1
            END IF
            #end add-point  
 
         BEFORE ROW     
            #add-point:modify段before row2 name="input.body2.before_row2"
 
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[2] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 2
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist310_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE aist310_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_isag2_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_isag2_d[l_ac].isahseq IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_isag2_d_t.* = g_isag2_d[l_ac].*  #BACKUP
               LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #BACKUP
               CALL aist310_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body2.after_set_entry_b"
               
               #end add-point  
               CALL aist310_set_no_entry_b(l_cmd)
               IF NOT aist310_lock_b("isah_t","'2'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aist310_bcl2 INTO g_isag2_d[l_ac].isahseq,g_isag2_d[l_ac].isahorga,g_isag2_d[l_ac].isah003, 
                      g_isag2_d[l_ac].isah004,g_isag2_d[l_ac].isah013,g_isag2_d[l_ac].isah005,g_isag2_d[l_ac].isah010, 
                      g_isag2_d[l_ac].isah006,g_isag2_d[l_ac].isah101,g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah007, 
                      g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105,g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114, 
                      g_isag2_d[l_ac].isah115,g_isag2_d[l_ac].isah001,g_isag2_d[l_ac].isah002,g_isag2_d[l_ac].isah008, 
                      g_isag2_d[l_ac].isah009,g_isag2_d[l_ac].isah011,g_isag2_d[l_ac].isah106,g_isag2_d[l_ac].isah012, 
                      g_isag2_d[l_ac].isah116
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = SQLERRMESSAGE  
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_isag2_d_mask_o[l_ac].* =  g_isag2_d[l_ac].*
                  CALL aist310_isah_t_mask()
                  LET g_isag2_d_mask_n[l_ac].* =  g_isag2_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL aist310_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body2.before_row"
            CALL aist310_ref_b_2()
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身AFTER DELETE (=d) name="input.body2.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body2.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code = -263 
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身2刪除前 name="input.body2.b_delete"
               
               #end add-point    
                  
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_isaf_m.isafcomp
               LET gs_keys[gs_keys.getLength()+1] = g_isaf_m.isafdocno
               LET gs_keys[gs_keys.getLength()+1] = g_isag2_d_t.isahseq
            
               #刪除同層單身
               IF NOT aist310_delete_b('isah_t',gs_keys,"'2'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist310_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT aist310_key_delete_b(gs_keys,'isah_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist310_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
               
               #add-point:單身2刪除中 name="input.body2.m_delete"
               
               #end add-point    
               
               CALL s_transaction_end('Y','0')
               CLOSE aist310_bcl
 
               LET g_rec_b = g_rec_b-1
               #add-point:單身2刪除後 name="input.body2.a_delete"
 
               #end add-point
               LET l_count = g_isag_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body2.after_delete"
               
               #end add-point
            END IF 
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_isag2_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
         AFTER INSERT    
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身2新增前 name="input.body2.b_a_insert"
            
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM isah_t 
             WHERE isahent = g_enterprise AND isahcomp = g_isaf_m.isafcomp
               AND isahdocno = g_isaf_m.isafdocno
               AND isahseq = g_isag2_d[l_ac].isahseq
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身2新增前 name="input.body2.b_insert"
               
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys[3] = g_isag2_d[g_detail_idx].isahseq
               CALL aist310_insert_b('isah_t',gs_keys,"'2'")
                           
               #add-point:單身新增後2 name="input.body2.a_insert"
 
               #end add-point
            ELSE    
               INITIALIZE g_isag_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code = "std-00006" 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aist310_b_fill()
               #資料多語言用-增/改
               
               #add-point:單身新增後 name="input.body2.after_insert"
               
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_isag2_d[l_ac].* = g_isag2_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE aist310_bcl2
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = -263 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               LET g_isag2_d[l_ac].* = g_isag2_d_t.*
            ELSE
               #add-point:單身page2修改前 name="input.body2.b_update"
               
               #end add-point
               
               #寫入修改者/修改日期資訊(單身2)
               
               
               #將遮罩欄位還原
               CALL aist310_isah_t_mask_restore('restore_mask_o')
                              
               UPDATE isah_t SET (isahcomp,isahdocno,isahseq,isahorga,isah003,isah004,isah013,isah005, 
                   isah010,isah006,isah101,isah103,isah007,isah104,isah105,isah113,isah114,isah115,isah001, 
                   isah002,isah008,isah009,isah011,isah106,isah012,isah116) = (g_isaf_m.isafcomp,g_isaf_m.isafdocno, 
                   g_isag2_d[l_ac].isahseq,g_isag2_d[l_ac].isahorga,g_isag2_d[l_ac].isah003,g_isag2_d[l_ac].isah004, 
                   g_isag2_d[l_ac].isah013,g_isag2_d[l_ac].isah005,g_isag2_d[l_ac].isah010,g_isag2_d[l_ac].isah006, 
                   g_isag2_d[l_ac].isah101,g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah007,g_isag2_d[l_ac].isah104, 
                   g_isag2_d[l_ac].isah105,g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114,g_isag2_d[l_ac].isah115, 
                   g_isag2_d[l_ac].isah001,g_isag2_d[l_ac].isah002,g_isag2_d[l_ac].isah008,g_isag2_d[l_ac].isah009, 
                   g_isag2_d[l_ac].isah011,g_isag2_d[l_ac].isah106,g_isag2_d[l_ac].isah012,g_isag2_d[l_ac].isah116)  
                   #自訂欄位頁簽
                WHERE isahent = g_enterprise AND isahcomp = g_isaf_m.isafcomp
                  AND isahdocno = g_isaf_m.isafdocno
                  AND isahseq = g_isag2_d_t.isahseq #項次 
                  
               #add-point:單身page2修改中 name="input.body2.m_update"
               
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_isag2_d[l_ac].* = g_isag2_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isah_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.SQLCODE #其他錯誤
                     LET g_isag2_d[l_ac].* = g_isag2_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys_bak[1] = g_isafcomp_t
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys_bak[2] = g_isafdocno_t
               LET gs_keys[3] = g_isag2_d[g_detail_idx].isahseq
               LET gs_keys_bak[3] = g_isag2_d_t.isahseq
               CALL aist310_update_b('isah_t',gs_keys,gs_keys_bak,"'2'")
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL aist310_isah_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT (g_isag2_d[g_detail_idx].isahseq = g_isag2_d_t.isahseq 
                  ) THEN
                  LET gs_keys[01] = g_isaf_m.isafcomp
                  LET gs_keys[gs_keys.getLength()+1] = g_isaf_m.isafdocno
                  LET gs_keys[gs_keys.getLength()+1] = g_isag2_d_t.isahseq
                  CALL aist310_key_update_b(gs_keys,'isah_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag2_d_t)
               LET g_log2 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag2_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身page2修改後 name="input.body2.a_update"
 
               #end add-point
            END IF
         
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isahseq
            #add-point:BEFORE FIELD isahseq name="input.b.page2.isahseq"
            IF cl_null(g_isag2_d[g_detail_idx].isahseq) THEN 
              SELECT MAX(isahseq) INTO g_isag2_d[g_detail_idx].isahseq
                 FROM isah_t
                WHERE isahent = g_enterprise
                  AND isahcomp = g_isaf_m.isafcomp
                  AND isahdocno = g_isaf_m.isafdocno
                  
               IF cl_null(g_isag2_d[g_detail_idx].isahseq) THEN 
                  LET g_isag2_d[g_detail_idx].isahseq = 1
               ELSE
                  LET g_isag2_d[g_detail_idx].isahseq = g_isag2_d[g_detail_idx].isahseq + 1
               END IF
            END IF
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isahseq
            
            #add-point:AFTER FIELD isahseq name="input.a.page2.isahseq"
            #此段落由子樣板a05產生
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag2_d[g_detail_idx].isahseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag2_d[g_detail_idx].isahseq != g_isag2_d_t.isahseq)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isah_t WHERE "||"isahent = '" ||g_enterprise|| "' AND "||"isahcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isahdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isahseq = '"||g_isag2_d[g_detail_idx].isahseq ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isah_t WHERE "||"isahent = '" ||g_enterprise|| "' AND "||"isahcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isahdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isahseq = '"||g_isag2_d[g_detail_idx].isahseq ||"'",'std-00004',0) THEN#160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isahseq
            #add-point:ON CHANGE isahseq name="input.g.page2.isahseq"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isahorga
            
            #add-point:AFTER FIELD isahorga name="input.a.page2.isahorga"
            CALL aist310_ref_b_2()
            IF NOT cl_null(g_isag2_d[l_ac].isahorga) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isag2_d[l_ac].isahorga
               LET g_chkparam.err_str[1] = "aoo-00095:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"#要執行的建議程式待補 #160318-00025#30  add
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooef001") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 

               ELSE
                  #檢查失敗時後續處理
                  LET g_isag2_d[l_ac].isahorga = g_isag2_d_t.isahorga
                  CALL aist310_ref_b_2()
                  NEXT FIELD CURRENT
               END IF
               
               #161006-00005#29  add---s
               
               CALL s_fin_apcborga_chk(g_isaf_m.isafsite,g_isaf_m.isafcomp,g_isag2_d[l_ac].isahorga,today,'3') 
                    RETURNING g_sub_success,g_errno
      
               IF NOT g_sub_success THEN
                  LET g_errparam.code = g_errno
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_isag2_d[l_ac].isahorga = g_isag2_d_t.isahorga
                  CALL aist310_ref_b_2()
                  NEXT FIELD CURRENT
               END IF
                 
               #161006-00005#29  add---e
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isahorga
            #add-point:BEFORE FIELD isahorga name="input.b.page2.isahorga"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isahorga
            #add-point:ON CHANGE isahorga name="input.g.page2.isahorga"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah003
            #add-point:BEFORE FIELD isah003 name="input.b.page2.isah003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah003
            
            #add-point:AFTER FIELD isah003 name="input.a.page2.isah003"
            IF NOT cl_null(g_isag2_d[l_ac].isah003) THEN 
               #IF g_isag2_d[l_ac].isah003  MATCHES "*MISC*" THEN 
               #
               #ELSE
                  INITIALIZE g_ref_fields TO NULL
                  LET g_ref_fields[1] = g_isag2_d[l_ac].isah003
                  CALL ap_ref_array2(g_ref_fields,"SELECT imaal003 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
                  LET g_isag2_d[l_ac].isah004 = '', g_rtn_fields[1] , ''
                  DISPLAY g_isag2_d[l_ac].isah004 TO s_detail2[l_ac].isah004 
               #END IF
            END IF 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah003
            #add-point:ON CHANGE isah003 name="input.g.page2.isah003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah004
            #add-point:BEFORE FIELD isah004 name="input.b.page2.isah004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah004
            
            #add-point:AFTER FIELD isah004 name="input.a.page2.isah004"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah004
            #add-point:ON CHANGE isah004 name="input.g.page2.isah004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah013
            #add-point:BEFORE FIELD isah013 name="input.b.page2.isah013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah013
            
            #add-point:AFTER FIELD isah013 name="input.a.page2.isah013"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah013
            #add-point:ON CHANGE isah013 name="input.g.page2.isah013"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah005
            #add-point:BEFORE FIELD isah005 name="input.b.page2.isah005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah005
            
            #add-point:AFTER FIELD isah005 name="input.a.page2.isah005"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah005
            #add-point:ON CHANGE isah005 name="input.g.page2.isah005"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah005_desc
            
            #add-point:AFTER FIELD isah005_desc name="input.a.page2.isah005_desc"
            LET g_isag2_d[l_ac].isah005 = g_isag2_d[l_ac].isah005_desc
            CALL aist310_ref_b_2()
            IF NOT cl_null(g_isag2_d[l_ac].isah005) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               LET g_errshow = TRUE #是否開窗 #160318-00025#30  add
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isag2_d[l_ac].isah005
               LET g_chkparam.err_str[1] = "aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"#要執行的建議程式待補 #160318-00025#30  add
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooca001") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 

               ELSE
                  #檢查失敗時後續處理
                  LET g_isag2_d[l_ac].isah005 = g_isag2_d_t.isah005
                  LET g_isag2_d[l_ac].isah005_desc = g_isag2_d_t.isah005_desc
                  CALL aist310_ref_b_2()
                  NEXT FIELD CURRENT
               END IF
            

            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah005_desc
            #add-point:BEFORE FIELD isah005_desc name="input.b.page2.isah005_desc"
            LET g_isag2_d[l_ac].isah005_desc = g_isag2_d[l_ac].isah005
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah005_desc
            #add-point:ON CHANGE isah005_desc name="input.g.page2.isah005_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah010
            #add-point:BEFORE FIELD isah010 name="input.b.page2.isah010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah010
            
            #add-point:AFTER FIELD isah010 name="input.a.page2.isah010"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah010
            #add-point:ON CHANGE isah010 name="input.g.page2.isah010"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah006
            #add-point:BEFORE FIELD isah006 name="input.b.page2.isah006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah006
            
            #add-point:AFTER FIELD isah006 name="input.a.page2.isah006"
            #IF NOT cl_null(g_isag2_d[g_detail_idx].isah006) AND NOT cl_null(g_isag2_d[g_detail_idx].isah101) THEN
            #   CALL aist310_isah_preinstall()
            #END IF
            IF NOT cl_null(g_isag2_d[l_ac].isah006) THEN
               IF NOT cl_null(g_isag2_d[l_ac].isah101) AND NOT cl_null(g_isag2_d[l_ac].isah007) THEN 
                  #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah006 <> g_isag2_d_t.isah006 OR cl_null(g_isag2_d_t.isah006))) THEN  #160822-00008#8 Mark
                  IF g_isag2_d[l_ac].isah006 != g_isag2_d_o.isah006 OR cl_null(g_isag2_d_o.isah006) THEN #160822-00008#8
                     #160808-00030#1-----s
                     #CALL s_tax_ins(g_isaf_m.isafdocno,g_isag2_d[l_ac].isahseq,0,g_isag2_d[l_ac].isahorga,
                     #               g_isag2_d[l_ac].isah006*g_isag2_d[l_ac].isah101,g_isaf_m.isaf016,
                     #               g_isag2_d[l_ac].isah006,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,1,1)
                     #  RETURNING g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105,
                     #            g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114,g_isag2_d[l_ac].isah115,
                     #            r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135           
                     #
                     #160822-00008#8---(S)
                     LET g_isag2_d[l_ac].isah103 = 0
                     LET g_isag2_d[l_ac].isah104 = 0
                     LET g_isag2_d[l_ac].isah105 = 0
                     LET g_isag2_d[l_ac].isah113 = 0
                     LET g_isag2_d[l_ac].isah114 = 0
                     LET g_isag2_d[l_ac].isah115 = 0
                     #160822-00008#8 ---(E)
                     CALL s_tax_count(g_isag2_d[l_ac].isahorga,g_isaf_m.isaf016,g_isag2_d[l_ac].isah006*g_isag2_d[l_ac].isah101,0,g_isaf_m.isaf100,g_isaf_m.isaf101)
                        RETURNING g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105,
                                  g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114,g_isag2_d[l_ac].isah115
                     
                     #160808-00030#1-----e          
                  END IF
               END IF
            END IF
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #160822-00008#8
            #IF NOT cl_null(g_isag2_d[l_ac].isah006) THEN 
            #   IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah006 <> g_isag2_d_t.isah006 OR cl_null(g_isag2_d_t.isah006))) THEN
            #      IF g_oodb004 = '1' THEN 
            #         IF g_isaf_m.isaf017 = 'Y' THEN   
            #            LET g_isag2_d[l_ac].isah105 = g_isag2_d[l_ac].isah006 * g_isag2_d[l_ac].isah101
            #            LET g_isag2_d[l_ac].isah103 = g_isag2_d[l_ac].isah105 - g_isag2_d[l_ac].isah104                     
            #         ELSE
            #            LET g_isag2_d[l_ac].isah103 = g_isag2_d[l_ac].isah006 * g_isag2_d[l_ac].isah101
            #            LET g_isag2_d[l_ac].isah105 = g_isag2_d[l_ac].isah103 + g_isag2_d[l_ac].isah104
            #         END IF
            #         LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah103 * g_isaf_m.isaf101
            #         LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah104 * g_isaf_m.isaf101
            #         LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah105 * g_isaf_m.isaf101
            #      END IF
            #   END IF
            #END IF 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah006
            #add-point:ON CHANGE isah006 name="input.g.page2.isah006"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah101
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_isag2_d[l_ac].isah101,"0","0","","","azz-00079",1) THEN
               NEXT FIELD isah101
            END IF 
 
 
 
            #add-point:AFTER FIELD isah101 name="input.a.page2.isah101"
            #IF NOT cl_null(g_isag2_d[g_detail_idx].isah006) AND NOT cl_null(g_isag2_d[g_detail_idx].isah101) THEN
            #   CALL aist310_isah_preinstall()
            #END IF 
            IF NOT cl_null(g_isag2_d[l_ac].isah101) THEN
               IF NOT cl_null(g_isag2_d[l_ac].isah006) AND NOT cl_null(g_isag2_d[l_ac].isah007) THEN 
                  #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah101 <> g_isag2_d_t.isah101 OR cl_null(g_isag2_d_t.isah101))) THEN #160822-00008#8 Mark
                  IF g_isag2_d[l_ac].isah101 != g_isag2_d_o.isah101 OR cl_null(g_isag2_d_o.isah101) THEN #160822-00008#8 
                     #160808-00030#1-----s
                     #CALL s_tax_ins(g_isaf_m.isafdocno,g_isag2_d[l_ac].isahseq,0,g_isag2_d[l_ac].isahorga,
                     #               g_isag2_d[l_ac].isah006*g_isag2_d[l_ac].isah101,g_isaf_m.isaf016,
                     #               g_isag2_d[l_ac].isah006,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,1,1)
                     #  RETURNING g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105,
                     #            g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114,g_isag2_d[l_ac].isah115,
                     #            r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135           
                     #
                     #160822-00008#8---(S)
                     LET g_isag2_d[l_ac].isah103 = 0
                     LET g_isag2_d[l_ac].isah104 = 0
                     LET g_isag2_d[l_ac].isah105 = 0
                     LET g_isag2_d[l_ac].isah113 = 0
                     LET g_isag2_d[l_ac].isah114 = 0
                     LET g_isag2_d[l_ac].isah115 = 0
                     #160822-00008#8---(E)
                     CALL s_tax_count(g_isag2_d[l_ac].isahorga,g_isaf_m.isaf016,g_isag2_d[l_ac].isah006*g_isag2_d[l_ac].isah101,0,g_isaf_m.isaf100,g_isaf_m.isaf101)
                        RETURNING g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105,
                                  g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114,g_isag2_d[l_ac].isah115
                     
                     #160808-00030#1-----e          
                  END IF
               END IF
            END IF
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #160822-00008#8
            #IF NOT cl_null(g_isag2_d[l_ac].isah101) THEN 
            #   IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah101 <> g_isag2_d_t.isah101 OR cl_null(g_isag2_d_t.isah101))) THEN
            #      IF g_oodb004 = '1' THEN 
            #         IF g_isaf_m.isaf017 = 'Y' THEN   
            #            LET g_isag2_d[l_ac].isah105 = g_isag2_d[l_ac].isah006 * g_isag2_d[l_ac].isah101
            #            LET g_isag2_d[l_ac].isah103 = g_isag2_d[l_ac].isah105 - g_isag2_d[l_ac].isah104                     
            #         ELSE
            #            LET g_isag2_d[l_ac].isah103 = g_isag2_d[l_ac].isah006 * g_isag2_d[l_ac].isah101
            #            LET g_isag2_d[l_ac].isah105 = g_isag2_d[l_ac].isah103 + g_isag2_d[l_ac].isah104
            #         END IF
            #         LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah103 * g_isaf_m.isaf101
            #         LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah104 * g_isaf_m.isaf101
            #         LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah105 * g_isaf_m.isaf101
            #      END IF
            #   END IF
            #END IF 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah101
            #add-point:BEFORE FIELD isah101 name="input.b.page2.isah101"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah101
            #add-point:ON CHANGE isah101 name="input.g.page2.isah101"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah103
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_isag2_d[l_ac].isah103,"0","0","","","azz-00079",1) THEN
               NEXT FIELD isah103
            END IF 
 
 
 
            #add-point:AFTER FIELD isah103 name="input.a.page2.isah103"
            IF NOT cl_null(g_isag2_d[l_ac].isah103) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah103 <> g_isag2_d_t.isah103 OR cl_null(g_isag2_d_t.isah103))) THEN #160822-00008#8 Mark
               IF g_isag2_d[l_ac].isah103 != g_isag2_d_o.isah103 OR cl_null(g_isag2_d_o.isah103) THEN #160822-00008#8
                  #160831-00029#1 mark-----s
                  #IF g_oodb004 = '1' THEN 
                  #   IF g_isaf_m.isaf017 = 'Y' THEN 
                  #      LET g_isag2_d[l_ac].isah104 = g_isag2_d[l_ac].isah105 - g_isag2_d[l_ac].isah103                     
                  #   ELSE
                  #      LET g_isag2_d[l_ac].isah105 = g_isag2_d[l_ac].isah103 + g_isag2_d[l_ac].isah104
                  #   END IF
                  #   LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah103 * g_isaf_m.isaf101
                  #   LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah104 * g_isaf_m.isaf101
                  #   LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah105 * g_isaf_m.isaf101
                  #END IF
                  #160831-00029#1 mark-----e
                  #160831-00029#1-----s
                  IF g_isaf_m.isaf017 = 'Y' THEN
                      #160822-00008#8---(S)
                      LET g_isag2_d[l_ac].isah104 = 0
                      LET g_isag2_d[l_ac].isah114 = 0
                      #160822-00008#8---(E)
                      LET g_isag2_d[l_ac].isah104 = g_isag2_d[l_ac].isah105 - g_isag2_d[l_ac].isah103
                      LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah103 * g_isaf_m.isaf101
                      #LET g_isag2_d[l_ac].isah113 = s_curr_round(g_isaf_m.isafcomp,g_glaa001,g_isag2_d[l_ac].isah113,2) #161214-00053#1 mark
                      CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag2_d[l_ac].isah113,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah113 #161214-00053#1
                      LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah115 - g_isag2_d[l_ac].isah113                     
                  ELSE
                     #160822-00008#8---(S)
                     LET g_isag2_d[l_ac].isah104 = 0
                     LET g_isag2_d[l_ac].isah105 = 0
                     LET g_isag2_d[l_ac].isah113 = 0
                     LET g_isag2_d[l_ac].isah114 = 0
                     LET g_isag2_d[l_ac].isah115 = 0
                     #160822-00008#8---(E)
                     CALL s_tax_count(g_isag2_d[l_ac].isahorga,g_isaf_m.isaf016,g_isag2_d[l_ac].isah103,0,g_isaf_m.isaf100,g_isaf_m.isaf101)
                        RETURNING g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105,
                                  g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114,g_isag2_d[l_ac].isah115                  
                  END IF
                  #160831-00029#1-----e
               END IF
            END IF 
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah103
            #add-point:BEFORE FIELD isah103 name="input.b.page2.isah103"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah103
            #add-point:ON CHANGE isah103 name="input.g.page2.isah103"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah007
            #add-point:BEFORE FIELD isah007 name="input.b.page2.isah007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah007
            
            #add-point:AFTER FIELD isah007 name="input.a.page2.isah007"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah007
            #add-point:ON CHANGE isah007 name="input.g.page2.isah007"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah104
            #add-point:BEFORE FIELD isah104 name="input.b.page2.isah104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah104
            
            #add-point:AFTER FIELD isah104 name="input.a.page2.isah104"
            IF NOT cl_null(g_isag2_d[l_ac].isah104) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah104 <> g_isag2_d_t.isah104 OR cl_null(g_isag2_d_t.isah104))) THEN #160822-00008#8 Mark
               IF g_isag2_d[l_ac].isah104 != g_isag2_d_o.isah104 OR cl_null(g_isag2_d_o.isah104) THEN #160822-00008#8
                  #160831-00029#1 mark-----s
                  #IF g_oodb004 = '1' THEN 
                  #   IF g_isaf_m.isaf017 = 'Y' THEN 
                  #      LET g_isag2_d[l_ac].isah103 = g_isag2_d[l_ac].isah105 - g_isag2_d[l_ac].isah104                     
                  #   ELSE
                  #      LET g_isag2_d[l_ac].isah105 = g_isag2_d[l_ac].isah103 + g_isag2_d[l_ac].isah104
                  #   END IF
                  #   LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah103 * g_isaf_m.isaf101
                  #   LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah104 * g_isaf_m.isaf101
                  #   LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah105 * g_isaf_m.isaf101
                  #END IF
                  #160831-00029#1 mark-----e
                  #160831-00029#1-----s
                  IF g_isaf_m.isaf017 = 'Y' THEN
                     #160822-00008#8---(S)
                     LET g_isag2_d[l_ac].isah103 = 0
                     LET g_isag2_d[l_ac].isah113 = 0
                     #160822-00008#8---(E)
                     LET g_isag2_d[l_ac].isah103 = g_isag2_d[l_ac].isah105 - g_isag2_d[l_ac].isah104
                     LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah104 * g_isaf_m.isaf101
                     #LET g_isag2_d[l_ac].isah114 = s_curr_round(g_isaf_m.isafcomp,g_glaa001,g_isag2_d[l_ac].isah114,2) #161214-00053#1 mark
                     CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag2_d[l_ac].isah114,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah114 #161214-00053#1
                     LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah115 - g_isag2_d[l_ac].isah114
                  ELSE
                     #160822-00008#8---(S)
                     LET g_isag2_d[l_ac].isah105 = 0
                     LET g_isag2_d[l_ac].isah115 = 0
                     #160822-00008#8---(E)
                     LET g_isag2_d[l_ac].isah105 = g_isag2_d[l_ac].isah103 + g_isag2_d[l_ac].isah104
                     LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah104 * g_isaf_m.isaf101
                     #LET g_isag2_d[l_ac].isah114 = s_curr_round(g_isaf_m.isafcomp,g_glaa001,g_isag2_d[l_ac].isah114,2) #161214-00053#1 mark
                     CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag2_d[l_ac].isah114,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah114 #161214-00053#1
                     LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah113 + g_isag2_d[l_ac].isah114
                  END IF
                  #160831-00029#1-----e
               END IF
            END IF 
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah104
            #add-point:ON CHANGE isah104 name="input.g.page2.isah104"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah105
            #add-point:BEFORE FIELD isah105 name="input.b.page2.isah105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah105
            
            #add-point:AFTER FIELD isah105 name="input.a.page2.isah105"
            IF NOT cl_null(g_isag2_d[l_ac].isah105) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah105 <> g_isag2_d_t.isah105 OR cl_null(g_isag2_d_t.isah105))) THEN #160822-00008#8 Mark
               IF g_isag2_d[l_ac].isah105 != g_isag2_d_o.isah105 OR cl_null(g_isag2_d_o.isah105) THEN #160822-00008#8
                  #160831-00029#1 mark-----s
                  #IF g_oodb004 = '1' THEN 
                  #   IF g_isaf_m.isaf017 = 'Y' THEN 
                  #      LET g_isag2_d[l_ac].isah103 = g_isag2_d[l_ac].isah105 - g_isag2_d[l_ac].isah104                     
                  #   ELSE
                  #      LET g_isag2_d[l_ac].isah104 = g_isag2_d[l_ac].isah105 - g_isag2_d[l_ac].isah103
                  #   END IF
                  #   LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah103 * g_isaf_m.isaf101
                  #   LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah104 * g_isaf_m.isaf101
                  #   LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah105 * g_isaf_m.isaf101
                  #END IF
                  #160831-00029#1 mark-----e
                  #160831-00029#1-----s
                  IF g_isaf_m.isaf017 = 'N' THEN
                     #160822-00008#8---(S)
                     LET g_isag2_d[l_ac].isah104 = 0
                     LET g_isag2_d[l_ac].isah114 = 0
                     #160822-00008#8---(E)
                     LET g_isag2_d[l_ac].isah104 = g_isag2_d[l_ac].isah105 - g_isag2_d[l_ac].isah103
                     LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah105 * g_isaf_m.isaf101
                     #LET g_isag2_d[l_ac].isah115 = s_curr_round(g_isaf_m.isafcomp,g_glaa001,g_isag2_d[l_ac].isah115,2) #161214-00053#1 mark
                     CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag2_d[l_ac].isah115,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah115 #161214-00053#1
                     LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah115 - g_isag2_d[l_ac].isah113                   
                  ELSE
                     #160822-00008#8---(S)
                     LET g_isag2_d[l_ac].isah103 = 0
                     LET g_isag2_d[l_ac].isah104 = 0
                     LET g_isag2_d[l_ac].isah113 = 0
                     LET g_isag2_d[l_ac].isah114 = 0
                     LET g_isag2_d[l_ac].isah115 = 0
                     #160822-00008#8---(E)
                     CALL s_tax_count(g_isag2_d[l_ac].isahorga,g_isaf_m.isaf016,g_isag2_d[l_ac].isah105,0,g_isaf_m.isaf100,g_isaf_m.isaf101)
                        RETURNING g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105,
                                  g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114,g_isag2_d[l_ac].isah115                  
                  END IF                  
                  #160831-00029#1-----e
               END IF
            END IF
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah105
            #add-point:ON CHANGE isah105 name="input.g.page2.isah105"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah113
            #add-point:BEFORE FIELD isah113 name="input.b.page2.isah113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah113
            
            #add-point:AFTER FIELD isah113 name="input.a.page2.isah113"
            IF NOT cl_null(g_isag2_d[l_ac].isah113) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah113 <> g_isag2_d_t.isah113 OR cl_null(g_isag2_d_t.isah113))) THEN #160822-00008#8 Mark
               IF g_isag2_d[l_ac].isah113 != g_isag2_d_o.isah113 OR cl_null(g_isag2_d_o.isah113) THEN #160822-00008#8
                  #IF g_oodb004 = '1' THEN    #160831-00029#1 mark
                     IF g_isaf_m.isaf017 = 'Y' THEN 
                        LET g_isag2_d[l_ac].isah114 = 0 #160822-00008#8
                        LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah115 - g_isag2_d[l_ac].isah113                     
                     ELSE
                        LET g_isag2_d[l_ac].isah115 = 0 #160822-00008#8
                        LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah113 + g_isag2_d[l_ac].isah114
                     END IF
                  #END IF   #160831-00029#1 mark
               END IF
            END IF 
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah113
            #add-point:ON CHANGE isah113 name="input.g.page2.isah113"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah114
            #add-point:BEFORE FIELD isah114 name="input.b.page2.isah114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah114
            
            #add-point:AFTER FIELD isah114 name="input.a.page2.isah114"
            IF NOT cl_null(g_isag2_d[l_ac].isah114) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah114 <> g_isag2_d_t.isah114 OR cl_null(g_isag2_d_t.isah114))) THEN #160822-00008#8 Mark
               IF g_isag2_d[l_ac].isah114 != g_isag2_d_o.isah114 OR cl_null(g_isag2_d_o.isah114) THEN #160822-00008#8
                  #IF g_oodb004 = '1' THEN   #160831-00029#1 mark
                     IF g_isaf_m.isaf017 = 'Y' THEN 
                        LET g_isag2_d[l_ac].isah113 = 0 #160822-00008#8
                        LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah115 - g_isag2_d[l_ac].isah114                     
                     ELSE
                        LET g_isag2_d[l_ac].isah115 = 0 #160822-00008#8
                        LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah113 + g_isag2_d[l_ac].isah114
                     END IF
                  #END IF   #160831-00029#1 mark
               END IF
            END IF 
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah114
            #add-point:ON CHANGE isah114 name="input.g.page2.isah114"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah115
            #add-point:BEFORE FIELD isah115 name="input.b.page2.isah115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah115
            
            #add-point:AFTER FIELD isah115 name="input.a.page2.isah115"
            IF NOT cl_null(g_isag2_d[l_ac].isah115) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah115 <> g_isag2_d_t.isah115 OR cl_null(g_isag2_d_t.isah115))) THEN #160822-00008#8 Mark
               IF g_isag2_d[l_ac].isah115 != g_isag2_d_o.isah115 OR cl_null(g_isag2_d_o.isah115) THEN #160822-00008#8
                  #IF g_oodb004 = '1' THEN    #160831-00029#1 mark
                     IF g_isaf_m.isaf017 = 'Y' THEN 
                        LET g_isag2_d[l_ac].isah113 = 0 #160822-00008#8
                        LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah115 - g_isag2_d[l_ac].isah114                     
                     ELSE
                        LET g_isag2_d[l_ac].isah114 = 0 #160822-00008#8
                        LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah115 - g_isag2_d[l_ac].isah113
                     END IF
                  #END IF    #160831-00029#1 mark
               END IF
            END IF
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #160822-00008#8
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah115
            #add-point:ON CHANGE isah115 name="input.g.page2.isah115"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah001
            #add-point:BEFORE FIELD isah001 name="input.b.page2.isah001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah001
            
            #add-point:AFTER FIELD isah001 name="input.a.page2.isah001"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah001
            #add-point:ON CHANGE isah001 name="input.g.page2.isah001"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah002
            #add-point:BEFORE FIELD isah002 name="input.b.page2.isah002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah002
            
            #add-point:AFTER FIELD isah002 name="input.a.page2.isah002"
            #160111-00020#2-----s
            IF NOT cl_null(g_isag2_d[l_ac].isah002) THEN 
               #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isag2_d[l_ac].isah002 <> g_isag2_d_t.isah002 OR cl_null(g_isag2_d_t.isah002))) THEN #160822-00008#8 Mark
               IF g_isag2_d[l_ac].isah002 != g_isag2_d_o.isah002 OR cl_null(g_isag2_d_o.isah002) THEN #160822-00008#8
                  #160803-00044#1 mark ------
                  #LET l_ooef019 = NULL
                  #SELECT ooef019 INTO l_ooef019
                  #  FROM ooef_t
                  # WHERE ooefent = g_enterprise
                  #   AND ooef001 = g_isaf_m.isafcomp
                  #   AND ooefstus = 'Y'
                  #LET l_isai008 = NULL
                  #SELECT isai008 INTO l_isai008
                  #  FROM isai_t
                  # WHERE isaient = g_enterprise
                  #   AND isai001 = l_ooef019
                  #160803-00044#1 mark end---
                  IF g_isaf_m.isaf056 = '1' THEN
                     #正項
                    #IF l_isai008 = 'TW' THEN #160803-00044#1 mark
                     IF g_isai002 = '1' THEN  #160803-00044#1
                        LET l_isatcnt = NULL
                        #SELECT COUNT(*) INTO l_isatcnt FROM isat_t #160907-00046#1 mark
                        SELECT COUNT(1) INTO l_isatcnt FROM isat_t #160907-00046#1
                         WHERE isatent = g_enterprise
                           AND isat004 = g_isag2_d[l_ac].isah002
                           AND isat001 = g_isaf_m.isaf008
                           AND to_char(isat007,'yyyy') = to_char(g_isaf_m.isaf014,'yyyy')
                           AND isat014 = '11'
                           AND isatdocno <> g_isaf_m.isafdocno
                        IF cl_null(l_isatcnt)THEN LET l_isatcnt = 0 END IF
                     ELSE
                        LET l_isatcnt = NULL
                        #SELECT COUNT(*) INTO l_isatcnt FROM isat_t #160907-00046#1 mark
                        SELECT COUNT(1) INTO l_isatcnt FROM isat_t #160907-00046#1
                         WHERE isatent = g_enterprise
                           AND isat004 = g_isag2_d[l_ac].isah002
                           AND isat001 = g_isaf_m.isaf008
                           AND isat003 = g_isag2_d[l_ac].isah001
                           AND to_char(isat007,'yyyy') = to_char(g_isaf_m.isaf014,'yyyy')
                           AND isat014 = '11'
                           AND isatdocno <> g_isaf_m.isafdocno
                        IF cl_null(l_isatcnt)THEN LET l_isatcnt = 0 END IF
                     END IF
                     IF l_isatcnt > 0 THEN
                        INITIALIZE g_errparam.* TO NULL
                        LET g_errparam.code = 'ais-00201'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        #LET g_isag2_d[l_ac].isah002 = g_isag2_d_t.isah002 #160822-00008#8 Mark
                        LET g_isag2_d[l_ac].isah002 = g_isag2_d_o.isah002  #160822-00008#8
                        NEXT FIELD isah002
                     END IF                  
                  END IF
               END IF
            END IF
            LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #160822-00008#8
            #160111-00020#2-----e
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah002
            #add-point:ON CHANGE isah002 name="input.g.page2.isah002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah008
            #add-point:BEFORE FIELD isah008 name="input.b.page2.isah008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah008
            
            #add-point:AFTER FIELD isah008 name="input.a.page2.isah008"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah008
            #add-point:ON CHANGE isah008 name="input.g.page2.isah008"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah009
            #add-point:BEFORE FIELD isah009 name="input.b.page2.isah009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah009
            
            #add-point:AFTER FIELD isah009 name="input.a.page2.isah009"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah009
            #add-point:ON CHANGE isah009 name="input.g.page2.isah009"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah011
            #add-point:BEFORE FIELD isah011 name="input.b.page2.isah011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah011
            
            #add-point:AFTER FIELD isah011 name="input.a.page2.isah011"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah011
            #add-point:ON CHANGE isah011 name="input.g.page2.isah011"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah106
            #add-point:BEFORE FIELD isah106 name="input.b.page2.isah106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah106
            
            #add-point:AFTER FIELD isah106 name="input.a.page2.isah106"
            IF NOT cl_null(g_isag2_d[l_ac].isah106) THEN 
               LET g_isag2_d[l_ac].isah116 = g_isag2_d[l_ac].isah106 * g_isaf_m.isaf101
               DISPLAY g_isag2_d[l_ac].isah116 TO s_detail2[l_ac].isah116
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah106
            #add-point:ON CHANGE isah106 name="input.g.page2.isah106"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah012
            #add-point:BEFORE FIELD isah012 name="input.b.page2.isah012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah012
            
            #add-point:AFTER FIELD isah012 name="input.a.page2.isah012"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah012
            #add-point:ON CHANGE isah012 name="input.g.page2.isah012"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah116
            #add-point:BEFORE FIELD isah116 name="input.b.page2.isah116"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah116
            
            #add-point:AFTER FIELD isah116 name="input.a.page2.isah116"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah116
            #add-point:ON CHANGE isah116 name="input.g.page2.isah116"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page2.isahseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isahseq
            #add-point:ON ACTION controlp INFIELD isahseq name="input.c.page2.isahseq"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isahorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isahorga
            #add-point:ON ACTION controlp INFIELD isahorga name="input.c.page2.isahorga"
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isag2_d[l_ac].isahorga
            CALL s_fin_account_center_sons_query('3',g_isaf_m.isafsite,g_today,'')
            #CALL s_fin_account_center_comp_str()RETURNING l_origin_str #160907-00041#1 mark
            CALL s_fin_account_center_sons_str() RETURNING l_origin_str #160907-00041#1 add
            CALL aist310_change_to_sql(l_origin_str)RETURNING l_origin_str
            LET g_qryparam.where = " ooef001 IN (",l_origin_str CLIPPED,")",
                                   " AND ooef201 = 'Y'"   #161006-00005#29   add
            IF g_para_data = 'Y' THEN 
               LET g_qryparam.where = g_qryparam.where," AND ooef017 ='",g_isaf_m.isafcomp,"' "
            END IF
            CALL q_ooef001()
            LET g_isag2_d[l_ac].isahorga = g_qryparam.return1
            DISPLAY g_isag2_d[l_ac].isahorga TO isahorga
            CALL aist310_ref_b_2()
            NEXT FIELD isahorga
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah003
            #add-point:ON ACTION controlp INFIELD isah003 name="input.c.page2.isah003"
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isag2_d[l_ac].isah003
            LET g_qryparam.arg1 = g_isag2_d[l_ac].isahorga
            CALL q_imaf001_7()
            LET g_isag2_d[l_ac].isah003 = g_qryparam.return1
            DISPLAY g_isag2_d[l_ac].isah003 TO isah003
            CALL aist310_ref_b_2()
            NEXT FIELD isah003
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah004
            #add-point:ON ACTION controlp INFIELD isah004 name="input.c.page2.isah004"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah013
            #add-point:ON ACTION controlp INFIELD isah013 name="input.c.page2.isah013"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah005
            #add-point:ON ACTION controlp INFIELD isah005 name="input.c.page2.isah005"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah005_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah005_desc
            #add-point:ON ACTION controlp INFIELD isah005_desc name="input.c.page2.isah005_desc"
#此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isag2_d[l_ac].isah005_desc             #給予default值

            #給予arg

            CALL q_ooca001_1()                                #呼叫開窗

            LET g_isag2_d[l_ac].isah005 = g_qryparam.return1              #將開窗取得的值回傳到變數
            CALL aist310_ref_b_2()
            DISPLAY g_isag2_d[l_ac].isah005_desc TO isah005_desc              #顯示到畫面上
     
            NEXT FIELD isah005_desc                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.isah010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah010
            #add-point:ON ACTION controlp INFIELD isah010 name="input.c.page2.isah010"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah006
            #add-point:ON ACTION controlp INFIELD isah006 name="input.c.page2.isah006"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah101
            #add-point:ON ACTION controlp INFIELD isah101 name="input.c.page2.isah101"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah103
            #add-point:ON ACTION controlp INFIELD isah103 name="input.c.page2.isah103"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah007
            #add-point:ON ACTION controlp INFIELD isah007 name="input.c.page2.isah007"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah104
            #add-point:ON ACTION controlp INFIELD isah104 name="input.c.page2.isah104"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah105
            #add-point:ON ACTION controlp INFIELD isah105 name="input.c.page2.isah105"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah113
            #add-point:ON ACTION controlp INFIELD isah113 name="input.c.page2.isah113"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah114
            #add-point:ON ACTION controlp INFIELD isah114 name="input.c.page2.isah114"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah115
            #add-point:ON ACTION controlp INFIELD isah115 name="input.c.page2.isah115"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah001
            #add-point:ON ACTION controlp INFIELD isah001 name="input.c.page2.isah001"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah002
            #add-point:ON ACTION controlp INFIELD isah002 name="input.c.page2.isah002"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah008
            #add-point:ON ACTION controlp INFIELD isah008 name="input.c.page2.isah008"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah009
            #add-point:ON ACTION controlp INFIELD isah009 name="input.c.page2.isah009"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah011
            #add-point:ON ACTION controlp INFIELD isah011 name="input.c.page2.isah011"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah106
            #add-point:ON ACTION controlp INFIELD isah106 name="input.c.page2.isah106"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah012
            #add-point:ON ACTION controlp INFIELD isah012 name="input.c.page2.isah012"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah116
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah116
            #add-point:ON ACTION controlp INFIELD isah116 name="input.c.page2.isah116"
            
            #END add-point
 
 
 
 
         AFTER ROW
            #add-point:單身page2 after_row name="input.body2.after_row"
            
            #end add-point
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_isag2_d[l_ac].* = g_isag2_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE aist310_bcl2
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL aist310_unlock_b("isah_t","'2'")
            CALL s_transaction_end('Y','0')
            #add-point:單身page2 after_row2 name="input.body2.after_row2"
            
            #end add-point
 
         AFTER INPUT
            #add-point:input段after input  name="input.body2.after_input"
            
            #end add-point   
    
         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_isag2_d[li_reproduce_target].* = g_isag2_d[li_reproduce].*
 
               LET g_isag2_d[li_reproduce_target].isahseq = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_isag2_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_isag2_d.getLength()+1
            END IF
            
      END INPUT
      INPUT ARRAY g_isag3_d FROM s_detail3.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = FALSE, #此頁面insert功能由產生器控制, 手動之設定無效! 
 
                 DELETE ROW = FALSE,
                 APPEND ROW = FALSE)
                 
         #自訂ACTION(detail_input,page_3)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body3.before_input2"
            
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_isag3_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aist310_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_isag3_d.getLength()
            #add-point:資料輸入前 name="input.body3.before_input"
 
            #end add-point
            
         BEFORE INSERT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_isag3_d[l_ac].* TO NULL 
            INITIALIZE g_isag3_d_t.* TO NULL 
            INITIALIZE g_isag3_d_o.* TO NULL 
            #公用欄位給值(單身3)
            
            #自定義預設值(單身3)
                  LET g_isag3_d[l_ac].xrcd006 = "N"
      LET g_isag3_d[l_ac].xrcd005 = "1"
 
            #add-point:modify段before備份 name="input.body3.insert.before_bak"
            
            #end add-point
            LET g_isag3_d_t.* = g_isag3_d[l_ac].*     #新輸入資料
            LET g_isag3_d_o.* = g_isag3_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aist310_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body3.insert.after_set_entry_b"
            
            #end add-point
            CALL aist310_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_isag3_d[li_reproduce_target].* = g_isag3_d[li_reproduce].*
 
               LET g_isag3_d[li_reproduce_target].xrcdld = NULL
               LET g_isag3_d[li_reproduce_target].xrcdseq = NULL
               LET g_isag3_d[li_reproduce_target].xrcdseq2 = NULL
               LET g_isag3_d[li_reproduce_target].xrcd007 = NULL
            END IF
            
 
            #add-point:modify段before insert name="input.body3.before_insert"
            
            #end add-point  
 
         BEFORE ROW     
            #add-point:modify段before row2 name="input.body3.before_row2"
            
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[3] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 3
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist310_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE aist310_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_isag3_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_isag3_d[l_ac].xrcdld IS NOT NULL
               AND g_isag3_d[l_ac].xrcdseq IS NOT NULL
               AND g_isag3_d[l_ac].xrcdseq2 IS NOT NULL
               AND g_isag3_d[l_ac].xrcd007 IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_isag3_d_t.* = g_isag3_d[l_ac].*  #BACKUP
               LET g_isag3_d_o.* = g_isag3_d[l_ac].*  #BACKUP
               CALL aist310_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body3.after_set_entry_b"
 
               #end add-point  
               CALL aist310_set_no_entry_b(l_cmd)
               IF NOT aist310_lock_b("xrcd_t","'3'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aist310_bcl3 INTO g_isag3_d[l_ac].xrcdld,g_isag3_d[l_ac].xrcdseq2,g_isag3_d[l_ac].xrcdseq, 
                      g_isag3_d[l_ac].xrcd007,g_isag3_d[l_ac].xrcd002,g_isag3_d[l_ac].xrcd003,g_isag3_d[l_ac].xrcd006, 
                      g_isag3_d[l_ac].xrcd005,g_isag3_d[l_ac].xrcd104,g_isag3_d[l_ac].xrcd103,g_isag3_d[l_ac].xrcd105, 
                      g_isag3_d[l_ac].xrcd114
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = SQLERRMESSAGE  
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_isag3_d_mask_o[l_ac].* =  g_isag3_d[l_ac].*
                  CALL aist310_xrcd_t_mask()
                  LET g_isag3_d_mask_n[l_ac].* =  g_isag3_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL aist310_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body3.before_row"
            
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身AFTER DELETE (=d) name="input.body3.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body3.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code = -263 
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身3刪除前 name="input.body3.b_delete"
               
               #end add-point    
                  
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_isaf_m.isafcomp
               LET gs_keys[gs_keys.getLength()+1] = g_isaf_m.isafdocno
               LET gs_keys[gs_keys.getLength()+1] = g_isag3_d_t.xrcdld
               LET gs_keys[gs_keys.getLength()+1] = g_isag3_d_t.xrcdseq
               LET gs_keys[gs_keys.getLength()+1] = g_isag3_d_t.xrcdseq2
               LET gs_keys[gs_keys.getLength()+1] = g_isag3_d_t.xrcd007
            
               #刪除同層單身
               IF NOT aist310_delete_b('xrcd_t',gs_keys,"'3'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist310_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT aist310_key_delete_b(gs_keys,'xrcd_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist310_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
               
               #add-point:單身3刪除中 name="input.body3.m_delete"
               
               #end add-point    
               
               CALL s_transaction_end('Y','0')
               CLOSE aist310_bcl
 
               LET g_rec_b = g_rec_b-1
               #add-point:單身3刪除後 name="input.body3.a_delete"
               
               #end add-point
               LET l_count = g_isag_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body3.after_delete"
               
               #end add-point
            END IF 
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_isag3_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
         AFTER INSERT    
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身3新增前 name="input.body3.b_a_insert"
            
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM xrcd_t 
             WHERE xrcdent = g_enterprise AND xrcdcomp = g_isaf_m.isafcomp
               AND xrcddocno = g_isaf_m.isafdocno
               AND xrcdld = g_isag3_d[l_ac].xrcdld
               AND xrcdseq = g_isag3_d[l_ac].xrcdseq
               AND xrcdseq2 = g_isag3_d[l_ac].xrcdseq2
               AND xrcd007 = g_isag3_d[l_ac].xrcd007
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身3新增前 name="input.body3.b_insert"
               
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys[3] = g_isag3_d[g_detail_idx].xrcdld
               LET gs_keys[4] = g_isag3_d[g_detail_idx].xrcdseq
               LET gs_keys[5] = g_isag3_d[g_detail_idx].xrcdseq2
               LET gs_keys[6] = g_isag3_d[g_detail_idx].xrcd007
               CALL aist310_insert_b('xrcd_t',gs_keys,"'3'")
                           
               #add-point:單身新增後3 name="input.body3.a_insert"
               
               #end add-point
            ELSE    
               INITIALIZE g_isag_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code = "std-00006" 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aist310_b_fill()
               #資料多語言用-增/改
               
               #add-point:單身新增後 name="input.body3.after_insert"
               
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_isag3_d[l_ac].* = g_isag3_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE aist310_bcl3
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = -263 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               LET g_isag3_d[l_ac].* = g_isag3_d_t.*
            ELSE
               #add-point:單身page3修改前 name="input.body3.b_update"
               
               #end add-point
               
               #寫入修改者/修改日期資訊(單身3)
               
               
               #將遮罩欄位還原
               CALL aist310_xrcd_t_mask_restore('restore_mask_o')
                              
               UPDATE xrcd_t SET (xrcdcomp,xrcddocno,xrcdld,xrcdseq2,xrcdseq,xrcd007,xrcd002,xrcd003, 
                   xrcd006,xrcd005,xrcd104,xrcd103,xrcd105,xrcd114) = (g_isaf_m.isafcomp,g_isaf_m.isafdocno, 
                   g_isag3_d[l_ac].xrcdld,g_isag3_d[l_ac].xrcdseq2,g_isag3_d[l_ac].xrcdseq,g_isag3_d[l_ac].xrcd007, 
                   g_isag3_d[l_ac].xrcd002,g_isag3_d[l_ac].xrcd003,g_isag3_d[l_ac].xrcd006,g_isag3_d[l_ac].xrcd005, 
                   g_isag3_d[l_ac].xrcd104,g_isag3_d[l_ac].xrcd103,g_isag3_d[l_ac].xrcd105,g_isag3_d[l_ac].xrcd114)  
                   #自訂欄位頁簽
                WHERE xrcdent = g_enterprise AND xrcdcomp = g_isaf_m.isafcomp
                  AND xrcddocno = g_isaf_m.isafdocno
                  AND xrcdld = g_isag3_d_t.xrcdld #項次 
                  AND xrcdseq = g_isag3_d_t.xrcdseq
                  AND xrcdseq2 = g_isag3_d_t.xrcdseq2
                  AND xrcd007 = g_isag3_d_t.xrcd007
                  
               #add-point:單身page3修改中 name="input.body3.m_update"
               
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_isag3_d[l_ac].* = g_isag3_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "xrcd_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.SQLCODE #其他錯誤
                     LET g_isag3_d[l_ac].* = g_isag3_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys_bak[1] = g_isafcomp_t
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys_bak[2] = g_isafdocno_t
               LET gs_keys[3] = g_isag3_d[g_detail_idx].xrcdld
               LET gs_keys_bak[3] = g_isag3_d_t.xrcdld
               LET gs_keys[4] = g_isag3_d[g_detail_idx].xrcdseq
               LET gs_keys_bak[4] = g_isag3_d_t.xrcdseq
               LET gs_keys[5] = g_isag3_d[g_detail_idx].xrcdseq2
               LET gs_keys_bak[5] = g_isag3_d_t.xrcdseq2
               LET gs_keys[6] = g_isag3_d[g_detail_idx].xrcd007
               LET gs_keys_bak[6] = g_isag3_d_t.xrcd007
               CALL aist310_update_b('xrcd_t',gs_keys,gs_keys_bak,"'3'")
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL aist310_xrcd_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT (g_isag3_d[g_detail_idx].xrcdld = g_isag3_d_t.xrcdld 
                  AND g_isag3_d[g_detail_idx].xrcdseq = g_isag3_d_t.xrcdseq 
                  AND g_isag3_d[g_detail_idx].xrcdseq2 = g_isag3_d_t.xrcdseq2 
                  AND g_isag3_d[g_detail_idx].xrcd007 = g_isag3_d_t.xrcd007 
                  ) THEN
                  LET gs_keys[01] = g_isaf_m.isafcomp
                  LET gs_keys[gs_keys.getLength()+1] = g_isaf_m.isafdocno
                  LET gs_keys[gs_keys.getLength()+1] = g_isag3_d_t.xrcdld
                  LET gs_keys[gs_keys.getLength()+1] = g_isag3_d_t.xrcdseq
                  LET gs_keys[gs_keys.getLength()+1] = g_isag3_d_t.xrcdseq2
                  LET gs_keys[gs_keys.getLength()+1] = g_isag3_d_t.xrcd007
                  CALL aist310_key_update_b(gs_keys,'xrcd_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag3_d_t)
               LET g_log2 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag3_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身page3修改後 name="input.body3.a_update"
               
               #end add-point
            END IF
         
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcdld
            #add-point:BEFORE FIELD xrcdld name="input.b.page3.xrcdld"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcdld
            
            #add-point:AFTER FIELD xrcdld name="input.a.page3.xrcdld"
            #此段落由子樣板a05產生
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag3_d[g_detail_idx].xrcdld IS NOT NULL AND g_isag3_d[g_detail_idx].xrcdseq IS NOT NULL AND g_isag3_d[g_detail_idx].xrcdseq2 IS NOT NULL AND g_isag3_d[g_detail_idx].xrcd007 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag3_d[g_detail_idx].xrcdld != g_isag3_d_t.xrcdld OR g_isag3_d[g_detail_idx].xrcdseq != g_isag3_d_t.xrcdseq OR g_isag3_d[g_detail_idx].xrcdseq2 != g_isag3_d_t.xrcdseq2 OR g_isag3_d[g_detail_idx].xrcd007 != g_isag3_d_t.xrcd007)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xrcd_t WHERE "||"xrcdent = '" ||g_enterprise|| "' AND "||"xrcddocno = '"||g_isaf_m.isafcomp ||"' AND "|| "xrcdld = '"||g_isaf_m.isafdocno ||"' AND "|| "xrcdseq = '"||g_isag3_d[g_detail_idx].xrcdld ||"' AND "|| "xrcdseq2 = '"||g_isag3_d[g_detail_idx].xrcdseq ||"' AND "|| "xrcd007 = '"||g_isag3_d[g_detail_idx].xrcdseq2 ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM xrcd_t WHERE "||"xrcdent = '" ||g_enterprise|| "' AND "||"xrcddocno = '"||g_isaf_m.isafcomp ||"' AND "|| "xrcdld = '"||g_isaf_m.isafdocno ||"' AND "|| "xrcdseq = '"||g_isag3_d[g_detail_idx].xrcdld ||"' AND "|| "xrcdseq2 = '"||g_isag3_d[g_detail_idx].xrcdseq ||"' AND "|| "xrcd007 = '"||g_isag3_d[g_detail_idx].xrcdseq2 ||"'",'std-00004',0) THEN  #160907-00046#1                
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcdld
            #add-point:ON CHANGE xrcdld name="input.g.page3.xrcdld"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcdseq
            #add-point:BEFORE FIELD xrcdseq name="input.b.page3.xrcdseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcdseq
            
            #add-point:AFTER FIELD xrcdseq name="input.a.page3.xrcdseq"
            #此段落由子樣板a05產生
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag3_d[g_detail_idx].xrcdld IS NOT NULL AND g_isag3_d[g_detail_idx].xrcdseq IS NOT NULL AND g_isag3_d[g_detail_idx].xrcdseq2 IS NOT NULL AND g_isag3_d[g_detail_idx].xrcd007 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag3_d[g_detail_idx].xrcdld != g_isag3_d_t.xrcdld OR g_isag3_d[g_detail_idx].xrcdseq != g_isag3_d_t.xrcdseq OR g_isag3_d[g_detail_idx].xrcdseq2 != g_isag3_d_t.xrcdseq2 OR g_isag3_d[g_detail_idx].xrcd007 != g_isag3_d_t.xrcd007)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xrcd_t WHERE "||"xrcdent = '" ||g_enterprise|| "' AND "||"xrcddocno = '"||g_isaf_m.isafcomp ||"' AND "|| "xrcdld = '"||g_isaf_m.isafdocno ||"' AND "|| "xrcdseq = '"||g_isag3_d[g_detail_idx].xrcdld ||"' AND "|| "xrcdseq2 = '"||g_isag3_d[g_detail_idx].xrcdseq ||"' AND "|| "xrcd007 = '"||g_isag3_d[g_detail_idx].xrcdseq2 ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM xrcd_t WHERE "||"xrcdent = '" ||g_enterprise|| "' AND "||"xrcddocno = '"||g_isaf_m.isafcomp ||"' AND "|| "xrcdld = '"||g_isaf_m.isafdocno ||"' AND "|| "xrcdseq = '"||g_isag3_d[g_detail_idx].xrcdld ||"' AND "|| "xrcdseq2 = '"||g_isag3_d[g_detail_idx].xrcdseq ||"' AND "|| "xrcd007 = '"||g_isag3_d[g_detail_idx].xrcdseq2 ||"'",'std-00004',0) THEN #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcdseq
            #add-point:ON CHANGE xrcdseq name="input.g.page3.xrcdseq"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcb005
            #add-point:BEFORE FIELD xrcb005 name="input.b.page3.xrcb005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcb005
            
            #add-point:AFTER FIELD xrcb005 name="input.a.page3.xrcb005"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcb005
            #add-point:ON CHANGE xrcb005 name="input.g.page3.xrcb005"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd007
            #add-point:BEFORE FIELD xrcd007 name="input.b.page3.xrcd007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd007
            
            #add-point:AFTER FIELD xrcd007 name="input.a.page3.xrcd007"
            #此段落由子樣板a05產生
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag3_d[g_detail_idx].xrcdld IS NOT NULL AND g_isag3_d[g_detail_idx].xrcdseq IS NOT NULL AND g_isag3_d[g_detail_idx].xrcdseq2 IS NOT NULL AND g_isag3_d[g_detail_idx].xrcd007 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag3_d[g_detail_idx].xrcdld != g_isag3_d_t.xrcdld OR g_isag3_d[g_detail_idx].xrcdseq != g_isag3_d_t.xrcdseq OR g_isag3_d[g_detail_idx].xrcdseq2 != g_isag3_d_t.xrcdseq2 OR g_isag3_d[g_detail_idx].xrcd007 != g_isag3_d_t.xrcd007)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xrcd_t WHERE "||"xrcdent = '" ||g_enterprise|| "' AND "||"xrcddocno = '"||g_isaf_m.isafcomp ||"' AND "|| "xrcdld = '"||g_isaf_m.isafdocno ||"' AND "|| "xrcdseq = '"||g_isag3_d[g_detail_idx].xrcdld ||"' AND "|| "xrcdseq2 = '"||g_isag3_d[g_detail_idx].xrcdseq ||"' AND "|| "xrcd007 = '"||g_isag3_d[g_detail_idx].xrcdseq2 ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM xrcd_t WHERE "||"xrcdent = '" ||g_enterprise|| "' AND "||"xrcddocno = '"||g_isaf_m.isafcomp ||"' AND "|| "xrcdld = '"||g_isaf_m.isafdocno ||"' AND "|| "xrcdseq = '"||g_isag3_d[g_detail_idx].xrcdld ||"' AND "|| "xrcdseq2 = '"||g_isag3_d[g_detail_idx].xrcdseq ||"' AND "|| "xrcd007 = '"||g_isag3_d[g_detail_idx].xrcdseq2 ||"'",'std-00004',0) THEN  #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd007
            #add-point:ON CHANGE xrcd007 name="input.g.page3.xrcd007"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd002
            
            #add-point:AFTER FIELD xrcd002 name="input.a.page3.xrcd002"


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd002
            #add-point:BEFORE FIELD xrcd002 name="input.b.page3.xrcd002"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd002
            #add-point:ON CHANGE xrcd002 name="input.g.page3.xrcd002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd002_desc
            #add-point:BEFORE FIELD xrcd002_desc name="input.b.page3.xrcd002_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd002_desc
            
            #add-point:AFTER FIELD xrcd002_desc name="input.a.page3.xrcd002_desc"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd002_desc
            #add-point:ON CHANGE xrcd002_desc name="input.g.page3.xrcd002_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd003
            #add-point:BEFORE FIELD xrcd003 name="input.b.page3.xrcd003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd003
            
            #add-point:AFTER FIELD xrcd003 name="input.a.page3.xrcd003"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd003
            #add-point:ON CHANGE xrcd003 name="input.g.page3.xrcd003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd006
            #add-point:BEFORE FIELD xrcd006 name="input.b.page3.xrcd006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd006
            
            #add-point:AFTER FIELD xrcd006 name="input.a.page3.xrcd006"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd006
            #add-point:ON CHANGE xrcd006 name="input.g.page3.xrcd006"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd005
            #add-point:BEFORE FIELD xrcd005 name="input.b.page3.xrcd005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd005
            
            #add-point:AFTER FIELD xrcd005 name="input.a.page3.xrcd005"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd005
            #add-point:ON CHANGE xrcd005 name="input.g.page3.xrcd005"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd104
            #add-point:BEFORE FIELD xrcd104 name="input.b.page3.xrcd104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd104
            
            #add-point:AFTER FIELD xrcd104 name="input.a.page3.xrcd104"
           #IF NOT cl_null(g_isag3_d[l_ac].xrcd104) AND (g_isag3_d[l_ac].xrcd114 <> g_isag3_d_t.xrcd114 OR cl_null(g_isag3_d_t.xrcd114)) THEN #160801-00053#1 mark
           #IF NOT cl_null(g_isag3_d[l_ac].xrcd104) AND (g_isag3_d[l_ac].xrcd104 <> g_isag3_d_t.xrcd104 OR cl_null(g_isag3_d_t.xrcd104)) THEN #160801-00053#1 #170105-00017#1 mark
            IF g_isag3_d[l_ac].xrcd104 != g_isag3_d_o.xrcd104 OR cl_null(g_isag3_d_o.xrcd104) THEN #170105-00017#1
               CALL aist310_tax_amount('1')
               IF g_success = 'N' THEN 
                  #LET g_isag3_d[l_ac].xrcd104 = g_isag3_d_t.xrcd104 #170105-00017#1 mark
                  LET g_isag3_d[l_ac].xrcd104 = g_isag3_d_o.xrcd104  #170105-00017#1
               END IF 
            END IF
            LET g_isag3_d_o.* = g_isag3_d[l_ac].* #170105-00017#1
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd104
            #add-point:ON CHANGE xrcd104 name="input.g.page3.xrcd104"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd103
            #add-point:BEFORE FIELD xrcd103 name="input.b.page3.xrcd103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd103
            
            #add-point:AFTER FIELD xrcd103 name="input.a.page3.xrcd103"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd103
            #add-point:ON CHANGE xrcd103 name="input.g.page3.xrcd103"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd105
            #add-point:BEFORE FIELD xrcd105 name="input.b.page3.xrcd105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd105
            
            #add-point:AFTER FIELD xrcd105 name="input.a.page3.xrcd105"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd105
            #add-point:ON CHANGE xrcd105 name="input.g.page3.xrcd105"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd114
            #add-point:BEFORE FIELD xrcd114 name="input.b.page3.xrcd114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd114
            
            #add-point:AFTER FIELD xrcd114 name="input.a.page3.xrcd114"
            #IF NOT cl_null(g_isag3_d[l_ac].xrcd114) AND (g_isag3_d[l_ac].xrcd114 <> g_isag3_d_t.xrcd114 OR cl_null(g_isag3_d_t.xrcd114)) THEN #170105-00017#1 mark
            IF g_isag3_d[l_ac].xrcd114 != g_isag3_d_o.xrcd114 OR cl_null(g_isag3_d_o.xrcd114) THEN #170105-00017#1
               CALL aist310_tax_amount('2')
               IF g_success = 'N' THEN 
                  #LET g_isag3_d[l_ac].xrcd114 = g_isag3_d_t.xrcd114 #170105-00017#1 mark
                  LET g_isag3_d[l_ac].xrcd114 = g_isag3_d_o.xrcd114  #170105-00017#1
               END IF
            END IF
            LET g_isag3_d_o.* = g_isag3_d[l_ac].* #170105-00017#1
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE xrcd114
            #add-point:ON CHANGE xrcd114 name="input.g.page3.xrcd114"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page3.xrcdld
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcdld
            #add-point:ON ACTION controlp INFIELD xrcdld name="input.c.page3.xrcdld"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcdseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcdseq
            #add-point:ON ACTION controlp INFIELD xrcdseq name="input.c.page3.xrcdseq"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcb005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcb005
            #add-point:ON ACTION controlp INFIELD xrcb005 name="input.c.page3.xrcb005"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd007
            #add-point:ON ACTION controlp INFIELD xrcd007 name="input.c.page3.xrcd007"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd002
            #add-point:ON ACTION controlp INFIELD xrcd002 name="input.c.page3.xrcd002"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd002_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd002_desc
            #add-point:ON ACTION controlp INFIELD xrcd002_desc name="input.c.page3.xrcd002_desc"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd003
            #add-point:ON ACTION controlp INFIELD xrcd003 name="input.c.page3.xrcd003"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd006
            #add-point:ON ACTION controlp INFIELD xrcd006 name="input.c.page3.xrcd006"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd005
            #add-point:ON ACTION controlp INFIELD xrcd005 name="input.c.page3.xrcd005"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd104
            #add-point:ON ACTION controlp INFIELD xrcd104 name="input.c.page3.xrcd104"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd103
            #add-point:ON ACTION controlp INFIELD xrcd103 name="input.c.page3.xrcd103"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd105
            #add-point:ON ACTION controlp INFIELD xrcd105 name="input.c.page3.xrcd105"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.xrcd114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd114
            #add-point:ON ACTION controlp INFIELD xrcd114 name="input.c.page3.xrcd114"
            
            #END add-point
 
 
 
 
         AFTER ROW
            #add-point:單身page3 after_row name="input.body3.after_row"
            
            #end add-point
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_isag3_d[l_ac].* = g_isag3_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE aist310_bcl3
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL aist310_unlock_b("xrcd_t","'3'")
            CALL s_transaction_end('Y','0')
            #add-point:單身page3 after_row2 name="input.body3.after_row2"
            
            #end add-point
 
         AFTER INPUT
            #add-point:input段after input  name="input.body3.after_input"
            
            #end add-point   
    
         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_isag3_d[li_reproduce_target].* = g_isag3_d[li_reproduce].*
 
               LET g_isag3_d[li_reproduce_target].xrcdld = NULL
               LET g_isag3_d[li_reproduce_target].xrcdseq = NULL
               LET g_isag3_d[li_reproduce_target].xrcdseq2 = NULL
               LET g_isag3_d[li_reproduce_target].xrcd007 = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_isag3_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_isag3_d.getLength()+1
            END IF
            
      END INPUT
      INPUT ARRAY g_isag4_d FROM s_detail4.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = FALSE, #此頁面insert功能由產生器控制, 手動之設定無效! 
 
                 DELETE ROW = FALSE,
                 APPEND ROW = FALSE)
                 
         #自訂ACTION(detail_input,page_4)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body4.before_input2"
            EXIT DIALOG
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_isag4_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aist310_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'4',"))
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_isag4_d.getLength()
            #add-point:資料輸入前 name="input.body4.before_input"
            
            #end add-point
            
         BEFORE INSERT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_isag4_d[l_ac].* TO NULL 
            INITIALIZE g_isag4_d_t.* TO NULL 
            INITIALIZE g_isag4_d_o.* TO NULL 
            #公用欄位給值(單身4)
            
            #自定義預設值(單身4)
                  LET g_isag4_d[l_ac].isat002 = "N"
      LET g_isag4_d[l_ac].isat103 = "0"
      LET g_isag4_d[l_ac].isat104 = "0"
      LET g_isag4_d[l_ac].isat105 = "0"
      LET g_isag4_d[l_ac].isat113 = "0"
      LET g_isag4_d[l_ac].isat114 = "0"
      LET g_isag4_d[l_ac].isat115 = "0"
      LET g_isag4_d[l_ac].isat106 = "0"
      LET g_isag4_d[l_ac].isat107 = "0"
 
            #add-point:modify段before備份 name="input.body4.insert.before_bak"
            
            #end add-point
            LET g_isag4_d_t.* = g_isag4_d[l_ac].*     #新輸入資料
            LET g_isag4_d_o.* = g_isag4_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aist310_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body4.insert.after_set_entry_b"
            
            #end add-point
            CALL aist310_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_isag4_d[li_reproduce_target].* = g_isag4_d[li_reproduce].*
 
               LET g_isag4_d[li_reproduce_target].isatseq = NULL
               LET g_isag4_d[li_reproduce_target].isat003 = NULL
               LET g_isag4_d[li_reproduce_target].isat004 = NULL
            END IF
            
 
            #add-point:modify段before insert name="input.body4.before_insert"
            #150331-00006#5 add ------
            #LET g_isag4_d[l_ac].isatsite = g_isaf_m.isafsite   #150915 mark
            LET g_isag4_d[l_ac].isatsite = g_isaf_m.isaf052     #150915 add
            LET g_isag4_d[l_ac].isatdocdt= g_isaf_m.isafdocdt
            #150331-00006#5 add end---
            #end add-point  
 
         BEFORE ROW     
            #add-point:modify段before row2 name="input.body4.before_row2"
            
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[4] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 4
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist310_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE aist310_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_isag4_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_isag4_d[l_ac].isatseq IS NOT NULL
               AND g_isag4_d[l_ac].isat003 IS NOT NULL
               AND g_isag4_d[l_ac].isat004 IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_isag4_d_t.* = g_isag4_d[l_ac].*  #BACKUP
               LET g_isag4_d_o.* = g_isag4_d[l_ac].*  #BACKUP
               CALL aist310_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body4.after_set_entry_b"
               
               #end add-point  
               CALL aist310_set_no_entry_b(l_cmd)
               IF NOT aist310_lock_b("isat_t","'4'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aist310_bcl4 INTO g_isag4_d[l_ac].isatseq,g_isag4_d[l_ac].isat003,g_isag4_d[l_ac].isat004, 
                      g_isag4_d[l_ac].isat027,g_isag4_d[l_ac].isat006,g_isag4_d[l_ac].isat002,g_isag4_d[l_ac].isat103, 
                      g_isag4_d[l_ac].isat104,g_isag4_d[l_ac].isat105,g_isag4_d[l_ac].isat113,g_isag4_d[l_ac].isat114, 
                      g_isag4_d[l_ac].isat115,g_isag4_d[l_ac].isat007,g_isag4_d[l_ac].isat014,g_isag4_d[l_ac].isat106, 
                      g_isag4_d[l_ac].isat107,g_isag4_d[l_ac].isat017,g_isag4_d[l_ac].isatsite,g_isag4_d[l_ac].isatdocdt 
 
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = SQLERRMESSAGE  
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_isag4_d_mask_o[l_ac].* =  g_isag4_d[l_ac].*
                  CALL aist310_isat_t_mask()
                  LET g_isag4_d_mask_n[l_ac].* =  g_isag4_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL aist310_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body4.before_row"
            
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身AFTER DELETE (=d) name="input.body4.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body4.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code = -263 
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身4刪除前 name="input.body4.b_delete"
               
               #end add-point    
                  
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_isaf_m.isafcomp
               LET gs_keys[gs_keys.getLength()+1] = g_isaf_m.isafdocno
               LET gs_keys[gs_keys.getLength()+1] = g_isag4_d_t.isatseq
               LET gs_keys[gs_keys.getLength()+1] = g_isag4_d_t.isat003
               LET gs_keys[gs_keys.getLength()+1] = g_isag4_d_t.isat004
            
               #刪除同層單身
               IF NOT aist310_delete_b('isat_t',gs_keys,"'4'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist310_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT aist310_key_delete_b(gs_keys,'isat_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist310_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
               
               #add-point:單身4刪除中 name="input.body4.m_delete"
               
               #end add-point    
               
               CALL s_transaction_end('Y','0')
               CLOSE aist310_bcl
 
               LET g_rec_b = g_rec_b-1
               #add-point:單身4刪除後 name="input.body4.a_delete"
               
               #end add-point
               LET l_count = g_isag_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body4.after_delete"
               
               #end add-point
            END IF 
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_isag4_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
         AFTER INSERT    
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身4新增前 name="input.body4.b_a_insert"
            
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM isat_t 
             WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp
               AND isatdocno = g_isaf_m.isafdocno
               AND isatseq = g_isag4_d[l_ac].isatseq
               AND isat003 = g_isag4_d[l_ac].isat003
               AND isat004 = g_isag4_d[l_ac].isat004
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身4新增前 name="input.body4.b_insert"
               
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys[3] = g_isag4_d[g_detail_idx].isatseq
               LET gs_keys[4] = g_isag4_d[g_detail_idx].isat003
               LET gs_keys[5] = g_isag4_d[g_detail_idx].isat004
               CALL aist310_insert_b('isat_t',gs_keys,"'4'")
                           
               #add-point:單身新增後4 name="input.body4.a_insert"
               
               #end add-point
            ELSE    
               INITIALIZE g_isag_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code = "std-00006" 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aist310_b_fill()
               #資料多語言用-增/改
               
               #add-point:單身新增後 name="input.body4.after_insert"
               
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_isag4_d[l_ac].* = g_isag4_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE aist310_bcl4
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = -263 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               LET g_isag4_d[l_ac].* = g_isag4_d_t.*
            ELSE
               #add-point:單身page4修改前 name="input.body4.b_update"
               
               #end add-point
               
               #寫入修改者/修改日期資訊(單身4)
               
               
               #將遮罩欄位還原
               CALL aist310_isat_t_mask_restore('restore_mask_o')
                              
               UPDATE isat_t SET (isatcomp,isatdocno,isatseq,isat003,isat004,isat027,isat006,isat002, 
                   isat103,isat104,isat105,isat113,isat114,isat115,isat007,isat014,isat106,isat107,isat017, 
                   isatsite,isatdocdt) = (g_isaf_m.isafcomp,g_isaf_m.isafdocno,g_isag4_d[l_ac].isatseq, 
                   g_isag4_d[l_ac].isat003,g_isag4_d[l_ac].isat004,g_isag4_d[l_ac].isat027,g_isag4_d[l_ac].isat006, 
                   g_isag4_d[l_ac].isat002,g_isag4_d[l_ac].isat103,g_isag4_d[l_ac].isat104,g_isag4_d[l_ac].isat105, 
                   g_isag4_d[l_ac].isat113,g_isag4_d[l_ac].isat114,g_isag4_d[l_ac].isat115,g_isag4_d[l_ac].isat007, 
                   g_isag4_d[l_ac].isat014,g_isag4_d[l_ac].isat106,g_isag4_d[l_ac].isat107,g_isag4_d[l_ac].isat017, 
                   g_isag4_d[l_ac].isatsite,g_isag4_d[l_ac].isatdocdt) #自訂欄位頁簽
                WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp
                  AND isatdocno = g_isaf_m.isafdocno
                  AND isatseq = g_isag4_d_t.isatseq #項次 
                  AND isat003 = g_isag4_d_t.isat003
                  AND isat004 = g_isag4_d_t.isat004
                  
               #add-point:單身page4修改中 name="input.body4.m_update"
               
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_isag4_d[l_ac].* = g_isag4_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isat_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.SQLCODE #其他錯誤
                     LET g_isag4_d[l_ac].* = g_isag4_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys_bak[1] = g_isafcomp_t
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys_bak[2] = g_isafdocno_t
               LET gs_keys[3] = g_isag4_d[g_detail_idx].isatseq
               LET gs_keys_bak[3] = g_isag4_d_t.isatseq
               LET gs_keys[4] = g_isag4_d[g_detail_idx].isat003
               LET gs_keys_bak[4] = g_isag4_d_t.isat003
               LET gs_keys[5] = g_isag4_d[g_detail_idx].isat004
               LET gs_keys_bak[5] = g_isag4_d_t.isat004
               CALL aist310_update_b('isat_t',gs_keys,gs_keys_bak,"'4'")
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL aist310_isat_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT (g_isag4_d[g_detail_idx].isatseq = g_isag4_d_t.isatseq 
                  AND g_isag4_d[g_detail_idx].isat003 = g_isag4_d_t.isat003 
                  AND g_isag4_d[g_detail_idx].isat004 = g_isag4_d_t.isat004 
                  ) THEN
                  LET gs_keys[01] = g_isaf_m.isafcomp
                  LET gs_keys[gs_keys.getLength()+1] = g_isaf_m.isafdocno
                  LET gs_keys[gs_keys.getLength()+1] = g_isag4_d_t.isatseq
                  LET gs_keys[gs_keys.getLength()+1] = g_isag4_d_t.isat003
                  LET gs_keys[gs_keys.getLength()+1] = g_isag4_d_t.isat004
                  CALL aist310_key_update_b(gs_keys,'isat_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag4_d_t)
               LET g_log2 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag4_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身page4修改後 name="input.body4.a_update"
               
               #end add-point
            END IF
         
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isatseq
            #add-point:BEFORE FIELD isatseq name="input.b.page4.isatseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isatseq
            
            #add-point:AFTER FIELD isatseq name="input.a.page4.isatseq"
            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag4_d[g_detail_idx].isatseq IS NOT NULL AND g_isag4_d[g_detail_idx].isat003 IS NOT NULL AND g_isag4_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag4_d[g_detail_idx].isatseq != g_isag4_d_t.isatseq OR g_isag4_d[g_detail_idx].isat003 != g_isag4_d_t.isat003 OR g_isag4_d[g_detail_idx].isat004 != g_isag4_d_t.isat004)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatseq = '"||g_isaf_m.isafdocno ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat003 ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatseq = '"||g_isaf_m.isafdocno ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat003 ||"'",'std-00004',0) THEN #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag4_d[g_detail_idx].isatseq IS NOT NULL AND g_isag4_d[g_detail_idx].isat003 IS NOT NULL AND g_isag4_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag4_d[g_detail_idx].isatseq != g_isag4_d_t.isatseq OR g_isag4_d[g_detail_idx].isat003 != g_isag4_d_t.isat003 OR g_isag4_d[g_detail_idx].isat004 != g_isag4_d_t.isat004)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isatseq
            #add-point:ON CHANGE isatseq name="input.g.page4.isatseq"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat003
            #add-point:BEFORE FIELD isat003 name="input.b.page4.isat003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat003
            
            #add-point:AFTER FIELD isat003 name="input.a.page4.isat003"
            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag4_d[g_detail_idx].isatseq IS NOT NULL AND g_isag4_d[g_detail_idx].isat003 IS NOT NULL AND g_isag4_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag4_d[g_detail_idx].isatseq != g_isag4_d_t.isatseq OR g_isag4_d[g_detail_idx].isat003 != g_isag4_d_t.isat003 OR g_isag4_d[g_detail_idx].isat004 != g_isag4_d_t.isat004)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatseq = '"||g_isaf_m.isafdocno ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat003 ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatseq = '"||g_isaf_m.isafdocno ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat003 ||"'",'std-00004',0) THEN #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag4_d[g_detail_idx].isatseq IS NOT NULL AND g_isag4_d[g_detail_idx].isat003 IS NOT NULL AND g_isag4_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag4_d[g_detail_idx].isatseq != g_isag4_d_t.isatseq OR g_isag4_d[g_detail_idx].isat003 != g_isag4_d_t.isat003 OR g_isag4_d[g_detail_idx].isat004 != g_isag4_d_t.isat004)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1 mark 
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat003
            #add-point:ON CHANGE isat003 name="input.g.page4.isat003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat004
            #add-point:BEFORE FIELD isat004 name="input.b.page4.isat004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat004
            
            #add-point:AFTER FIELD isat004 name="input.a.page4.isat004"
            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag4_d[g_detail_idx].isatseq IS NOT NULL AND g_isag4_d[g_detail_idx].isat003 IS NOT NULL AND g_isag4_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag4_d[g_detail_idx].isatseq != g_isag4_d_t.isatseq OR g_isag4_d[g_detail_idx].isat003 != g_isag4_d_t.isat003 OR g_isag4_d[g_detail_idx].isat004 != g_isag4_d_t.isat004)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isaf_m.isafcomp ||"' AND "|| "isatdocno = '"||g_isaf_m.isafdocno ||"' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat004
            #add-point:ON CHANGE isat004 name="input.g.page4.isat004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat027
            #add-point:BEFORE FIELD isat027 name="input.b.page4.isat027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat027
            
            #add-point:AFTER FIELD isat027 name="input.a.page4.isat027"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat027
            #add-point:ON CHANGE isat027 name="input.g.page4.isat027"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat006
            #add-point:BEFORE FIELD isat006 name="input.b.page4.isat006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat006
            
            #add-point:AFTER FIELD isat006 name="input.a.page4.isat006"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat006
            #add-point:ON CHANGE isat006 name="input.g.page4.isat006"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat002
            #add-point:BEFORE FIELD isat002 name="input.b.page4.isat002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat002
            
            #add-point:AFTER FIELD isat002 name="input.a.page4.isat002"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat002
            #add-point:ON CHANGE isat002 name="input.g.page4.isat002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat103
            #add-point:BEFORE FIELD isat103 name="input.b.page4.isat103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat103
            
            #add-point:AFTER FIELD isat103 name="input.a.page4.isat103"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat103
            #add-point:ON CHANGE isat103 name="input.g.page4.isat103"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat104
            #add-point:BEFORE FIELD isat104 name="input.b.page4.isat104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat104
            
            #add-point:AFTER FIELD isat104 name="input.a.page4.isat104"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat104
            #add-point:ON CHANGE isat104 name="input.g.page4.isat104"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat105
            #add-point:BEFORE FIELD isat105 name="input.b.page4.isat105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat105
            
            #add-point:AFTER FIELD isat105 name="input.a.page4.isat105"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat105
            #add-point:ON CHANGE isat105 name="input.g.page4.isat105"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat113
            #add-point:BEFORE FIELD isat113 name="input.b.page4.isat113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat113
            
            #add-point:AFTER FIELD isat113 name="input.a.page4.isat113"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat113
            #add-point:ON CHANGE isat113 name="input.g.page4.isat113"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat114
            #add-point:BEFORE FIELD isat114 name="input.b.page4.isat114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat114
            
            #add-point:AFTER FIELD isat114 name="input.a.page4.isat114"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat114
            #add-point:ON CHANGE isat114 name="input.g.page4.isat114"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat115
            #add-point:BEFORE FIELD isat115 name="input.b.page4.isat115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat115
            
            #add-point:AFTER FIELD isat115 name="input.a.page4.isat115"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat115
            #add-point:ON CHANGE isat115 name="input.g.page4.isat115"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat007
            #add-point:BEFORE FIELD isat007 name="input.b.page4.isat007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat007
            
            #add-point:AFTER FIELD isat007 name="input.a.page4.isat007"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat007
            #add-point:ON CHANGE isat007 name="input.g.page4.isat007"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat014
            #add-point:BEFORE FIELD isat014 name="input.b.page4.isat014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat014
            
            #add-point:AFTER FIELD isat014 name="input.a.page4.isat014"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat014
            #add-point:ON CHANGE isat014 name="input.g.page4.isat014"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat106
            #add-point:BEFORE FIELD isat106 name="input.b.page4.isat106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat106
            
            #add-point:AFTER FIELD isat106 name="input.a.page4.isat106"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat106
            #add-point:ON CHANGE isat106 name="input.g.page4.isat106"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat107
            #add-point:BEFORE FIELD isat107 name="input.b.page4.isat107"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat107
            
            #add-point:AFTER FIELD isat107 name="input.a.page4.isat107"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat107
            #add-point:ON CHANGE isat107 name="input.g.page4.isat107"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat017
            #add-point:BEFORE FIELD isat017 name="input.b.page4.isat017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat017
            
            #add-point:AFTER FIELD isat017 name="input.a.page4.isat017"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat017
            #add-point:ON CHANGE isat017 name="input.g.page4.isat017"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page4.isatseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isatseq
            #add-point:ON ACTION controlp INFIELD isatseq name="input.c.page4.isatseq"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat003
            #add-point:ON ACTION controlp INFIELD isat003 name="input.c.page4.isat003"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat004
            #add-point:ON ACTION controlp INFIELD isat004 name="input.c.page4.isat004"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat027
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat027
            #add-point:ON ACTION controlp INFIELD isat027 name="input.c.page4.isat027"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat006
            #add-point:ON ACTION controlp INFIELD isat006 name="input.c.page4.isat006"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat002
            #add-point:ON ACTION controlp INFIELD isat002 name="input.c.page4.isat002"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat103
            #add-point:ON ACTION controlp INFIELD isat103 name="input.c.page4.isat103"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat104
            #add-point:ON ACTION controlp INFIELD isat104 name="input.c.page4.isat104"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat105
            #add-point:ON ACTION controlp INFIELD isat105 name="input.c.page4.isat105"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat113
            #add-point:ON ACTION controlp INFIELD isat113 name="input.c.page4.isat113"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat114
            #add-point:ON ACTION controlp INFIELD isat114 name="input.c.page4.isat114"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat115
            #add-point:ON ACTION controlp INFIELD isat115 name="input.c.page4.isat115"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat007
            #add-point:ON ACTION controlp INFIELD isat007 name="input.c.page4.isat007"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat014
            #add-point:ON ACTION controlp INFIELD isat014 name="input.c.page4.isat014"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat106
            #add-point:ON ACTION controlp INFIELD isat106 name="input.c.page4.isat106"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat107
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat107
            #add-point:ON ACTION controlp INFIELD isat107 name="input.c.page4.isat107"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.isat017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat017
            #add-point:ON ACTION controlp INFIELD isat017 name="input.c.page4.isat017"
            
            #END add-point
 
 
 
 
         AFTER ROW
            #add-point:單身page4 after_row name="input.body4.after_row"
            
            #end add-point
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_isag4_d[l_ac].* = g_isag4_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE aist310_bcl4
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL aist310_unlock_b("isat_t","'4'")
            CALL s_transaction_end('Y','0')
            #add-point:單身page4 after_row2 name="input.body4.after_row2"
            
            #end add-point
 
         AFTER INPUT
            #add-point:input段after input  name="input.body4.after_input"
            
            #end add-point   
    
         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_isag4_d[li_reproduce_target].* = g_isag4_d[li_reproduce].*
 
               LET g_isag4_d[li_reproduce_target].isatseq = NULL
               LET g_isag4_d[li_reproduce_target].isat003 = NULL
               LET g_isag4_d[li_reproduce_target].isat004 = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_isag4_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_isag4_d.getLength()+1
            END IF
            
      END INPUT
 
      
 
 
 
 
{</section>}
 
{<section id="aist310.input.other" >}
      
      #add-point:自定義input name="input.more_input"
      
      #end add-point
    
      BEFORE DIALOG 
         #CALL cl_err_collect_init()    
         #add-point:input段before dialog name="input.before_dialog"
         IF p_cmd = 'a' THEN
            NEXT FIELD isafsite
         ELSE
            CASE g_aw
               WHEN "s_detail1"
                  NEXT FIELD isagseq
               WHEN "s_detail2"
                  NEXT FIELD isahseq
               WHEN "s_detail3"
                  NEXT FIELD xrcdld
 
            END CASE
         END IF
         #end add-point    
         #重新導回資料到正確位置上
         CALL DIALOG.setCurrentRow("s_detail1",g_idx_group.getValue("'1',"))      
         CALL DIALOG.setCurrentRow("s_detail2",g_idx_group.getValue("'2',"))
         CALL DIALOG.setCurrentRow("s_detail3",g_idx_group.getValue("'3',"))
         CALL DIALOG.setCurrentRow("s_detail4",g_idx_group.getValue("'4',"))
 
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            #add-point:input段next_field name="input.next_field"
            
            #end add-point  
            NEXT FIELD isafcomp
         ELSE
            CASE g_aw
               WHEN "s_detail1"
                  NEXT FIELD isagseq
               WHEN "s_detail2"
                  NEXT FIELD isahseq
               WHEN "s_detail3"
                  NEXT FIELD xrcdld
               WHEN "s_detail4"
                  NEXT FIELD isatseq
 
               #add-point:input段modify_detail  name="input.modify_detail.other"
               
               #end add-point  
            END CASE
         END IF
      
      AFTER DIALOG
         #add-point:input段after_dialog name="input.after_dialog"
         
         #end add-point    
         
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden     
         END IF
 
      ON ACTION accept
         #add-point:input段accept  name="input.accept"
         
         #end add-point    
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         #add-point:input段cancel name="input.cancel"
         
         #end add-point  
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
         LET g_detail_idx_list[4] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
         CALL g_curr_diag.setCurrentRow("s_detail4",1)
 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         #add-point:input段close name="input.close"
         
         #end add-point  
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         #add-point:input段exit name="input.exit"
         
         #end add-point
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
         LET g_detail_idx_list[4] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
         CALL g_curr_diag.setCurrentRow("s_detail4",1)
 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
    
   #add-point:input段after input  name="input.after_input"
   #160316-00017#2--add--str--lujh
   IF l_flag = 'Y' THEN
      CONTINUE WHILE
   ELSE
   #160316-00017#2--add--end--lujh
      CALL aist310_show()
      IF g_isaf_m.isaf056 = '1' THEN 
         SELECT SUM(isag115 * isag015) INTO l_isag115_sum FROM isag_t
          WHERE isagent = g_enterprise
            AND isagcomp = g_isaf_m.isafcomp
            AND isagdocno = g_isaf_m.isafdocno
            AND (isag018 = 'Y' OR isag018 IS NULL) #160823-00016#1
         IF l_isag115_sum < 0 THEN 
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "" 
            LET g_errparam.code   = "ais-00159" 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
         END IF
      END IF
#160316-00017#2--add--str--lujh      
      EXIT WHILE
   END IF   
END WHILE
CALL aist310_isaf_sum()
CALL aist310_upd_xrcdcomp()       #160322-00027#3 add lujh
CALL aist310_show()
#160316-00017#2--add--end--lujh
   #end add-point    
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.show" >}
#+ 單頭資料重新顯示及單身資料重抓
PRIVATE FUNCTION aist310_show()
   #add-point:show段define(客製用) name="show.define_customerization"
   
   #end add-point  
   DEFINE l_ac_t    LIKE type_t.num10
   #add-point:show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="show.define"
   DEFINE l_ooba002  LIKE type_t.chr10
   DEFINE l_success  LIKE type_t.num5   #160802-00007#1 Add
   #end add-point  
   
   #add-point:Function前置處理 name="show.before"
   IF g_isaf_m.isafstus <> 'N' THEN
      CALL cl_set_act_visible("modify,delete,modify_detail", FALSE)   
   ELSE
      CALL cl_set_act_visible("modify,delete,modify_detail", TRUE)  
   END IF
   #160620-00010#3 --s mark
   #IF g_isaf_m.isaf001 = '2' THEN 
   #   CALL cl_set_comp_visible('bpage_1',FALSE)
   #ELSE
   #160620-00010#3 --e mark
      CALL cl_set_comp_visible('bpage_1',TRUE)
   #END IF  #160620-00010#3 mark
   CALL aist310_ref_show()
   
   IF g_oodb004 = '2' THEN 
      CALL cl_set_comp_entry("isag113,isag114,isag115",FALSE)
      CALL cl_set_comp_entry("isah113,isah114,isah115",FALSE)
      IF g_isaf_m.isaf017 = 'N' THEN 
         CALL cl_set_comp_entry("isag103,isah103",TRUE)
         CALL cl_set_comp_entry("isag105,isah105",FALSE)
      ELSE
         CALL cl_set_comp_entry("isag103,isah103",FALSE)
         CALL cl_set_comp_entry("isag105,isah105",TRUE)
      END IF
   END IF
   
   CALL aist310_visible() 
   
   CALL aist310_isag001_sel()

   #160802-00007#1 Add ---(S)---
   IF NOT cl_null(g_isaf_m.isaf067) THEN
      CALL s_axrt300_xrca_ref('xrca057',g_isaf_m.isaf067,'','') RETURNING l_success,g_isaf_m.isaf003_desc
   END IF
   #160802-00007#1 Add ---(E)---

   CALL cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-2013') RETURNING g_para_data
   #161024-00065#2 add ------
   #取得aoos020的參數S-FIN-2023(流通門店銷售立帳方式)
   CALL cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-2023') RETURNING g_sfin2023
   #161024-00065#2 add end---
   #end add-point
   
   
   
   IF g_bfill = "Y" THEN
      CALL aist310_b_fill() #單身填充
      CALL aist310_b_fill2('0') #單身填充
   END IF
     
   #帶出公用欄位reference值
   #應用 a12 樣板自動產生(Version:4)
 
 
 
   
   #顯示followup圖示
   #應用 a48 樣板自動產生(Version:3)
   CALL aist310_set_pk_array()
   #add-point:ON ACTION agendum name="show.follow_pic"
   
   #END add-point
   CALL cl_user_overview_set_follow_pic()
  
 
 
 
   
   LET l_ac_t = l_ac
   
   #讀入ref值(單頭)
   #add-point:show段reference name="show.head.reference"
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_isaf_m.isafownid
            CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            LET g_isaf_m.isafownid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_isaf_m.isafownid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_isaf_m.isafowndp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_isaf_m.isafowndp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_isaf_m.isafowndp_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_isaf_m.isafcrtid
            CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            LET g_isaf_m.isafcrtid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_isaf_m.isafcrtid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_isaf_m.isafcrtdp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_isaf_m.isafcrtdp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_isaf_m.isafcrtdp_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_isaf_m.isafmodid
            CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            LET g_isaf_m.isafmodid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_isaf_m.isafmodid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_isaf_m.isafcnfid
            CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            LET g_isaf_m.isafcnfid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_isaf_m.isafcnfid_desc
            
            
            #160826-00017#2 --s add
            #對帳單主畫面表尾合計
            IF NOT cl_null(g_isaf_m.isafcomp) AND NOT cl_null(g_isaf_m.isafdocno) THEN
               CALL aist310_isaf_sum_button(g_isaf_m.isafcomp,g_isaf_m.isafdocno,'')
                  RETURNING g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s,g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
               DISPLAY BY NAME g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s,g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
            END IF
            #160826-00017#2 --e add
   #end add-point
   
   #遮罩相關處理
   LET g_isaf_m_mask_o.* =  g_isaf_m.*
   CALL aist310_isaf_t_mask()
   LET g_isaf_m_mask_n.* =  g_isaf_m.*
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_isaf_m.isafsite,g_isaf_m.isafsite_desc,g_isaf_m.isafdocno,g_isaf_m.isafdocno_desc, 
       g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafcomp_desc,g_isaf_m.isafdocdt,g_isaf_m.isaf056, 
       g_isaf_m.isaf005,g_isaf_m.isaf005_desc,g_isaf_m.isaf057,g_isaf_m.isaf057_desc,g_isaf_m.isaf003, 
       g_isaf_m.isaf003_desc,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf008_desc, 
       g_isaf_m.isaf016,g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf016_desc,g_isaf_m.isaf052,g_isaf_m.isaf052_desc, 
       g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009,g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012, 
       g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101,g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf002_desc, 
       g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024,g_isaf_m.isaf025,g_isaf_m.isaf026, 
       g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031, 
       g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104,g_isaf_m.isaf105,g_isaf_m.isaf106, 
       g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114,g_isaf_m.isaf115,g_isaf_m.isaf116, 
       g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120,g_isaf_m.isaf121,g_isaf_m.isaf033, 
       g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049,g_isaf_m.isaf201,g_isaf_m.isaf201_desc, 
       g_isaf_m.isaf202,g_isaf_m.isaf202_desc,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf205,g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf037_desc,g_isaf_m.isaf038,g_isaf_m.isaf039, 
       g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf041_desc,g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf055_desc, 
       g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf006_desc,g_isaf_m.isaf050,g_isaf_m.isaf004,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf019_desc,g_isaf_m.isaf059,g_isaf_m.isaf060, 
       g_isaf_m.isaf061,g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208, 
       g_isaf_m.isaf209,g_isaf_m.isaf210,g_isaf_m.isaf210_desc,g_isaf_m.isafownid,g_isaf_m.isafownid_desc, 
       g_isaf_m.isafowndp,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid,g_isaf_m.isafcrtid_desc,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmodid_desc,g_isaf_m.isafmoddt, 
       g_isaf_m.isafcnfid,g_isaf_m.isafcnfid_desc,g_isaf_m.isafcnfdt,g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s, 
       g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_isaf_m.isafstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         
      END CASE
 
 
 
   
   #讀入ref值(單身)
   FOR l_ac = 1 TO g_isag_d.getLength()
      #add-point:show段單身reference name="show.body.reference"
      #161025-00016#1 add ------
      #抓取銷售通路(xmdk030)
      CASE
         WHEN g_isag_d[l_ac].isag001 = '10' #10:訂單
            SELECT xmda023 INTO g_isag_d[l_ac].l_xmdk030
              FROM xmda_t
             WHERE xmdaent = g_enterprise
               AND xmdadocno = g_isag_d[l_ac].isag002
         WHEN g_isag_d[l_ac].isag001 MATCHES '[12]1' #11:出貨單/21:銷退單
            SELECT xmdk030 INTO g_isag_d[l_ac].l_xmdk030
              FROM xmdk_t
             WHERE xmdkent = g_enterprise
               AND xmdkdocno = g_isag_d[l_ac].isag002
      END CASE
      LET g_isag_d[l_ac].l_xmdk030 = s_desc_show1(g_isag_d[l_ac].l_xmdk030,s_desc_get_oojdl003_desc(g_isag_d[l_ac].l_xmdk030))
      #161025-00016#1 add end---
      #end add-point
   END FOR
   
   FOR l_ac = 1 TO g_isag2_d.getLength()
      #add-point:show段單身reference name="show.body2.reference"
 
      #end add-point
   END FOR
   FOR l_ac = 1 TO g_isag3_d.getLength()
      #add-point:show段單身reference name="show.body3.reference"
 
      #end add-point
   END FOR
   FOR l_ac = 1 TO g_isag4_d.getLength()
      #add-point:show段單身reference name="show.body4.reference"
      
      #end add-point
   END FOR
 
   
    
   
   #add-point:show段other name="show.other"
   
   #end add-point  
   
   LET l_ac = l_ac_t
   
   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()     
 
   CALL aist310_detail_show()
 
   #add-point:show段之後 name="show.after"
   LET g_isaf_m_t.* = g_isaf_m.*
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.detail_show" >}
#+ 第二階單身reference
PRIVATE FUNCTION aist310_detail_show()
   #add-point:detail_show段define(客製用) name="detail_show.define_customerization"
   
   #end add-point  
   #add-point:detail_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_show.define"
   
   #end add-point  
   
   #add-point:Function前置處理 name="detail_show.before"
   
   #end add-point
   
   #add-point:detail_show段之後 name="detail_show.after"
   
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.reproduce" >}
#+ 資料複製
PRIVATE FUNCTION aist310_reproduce()
   #add-point:reproduce段define(客製用) name="reproduce.define_customerization"
   
   #end add-point   
   DEFINE l_newno     LIKE isaf_t.isafcomp 
   DEFINE l_oldno     LIKE isaf_t.isafcomp 
   DEFINE l_newno02     LIKE isaf_t.isafdocno 
   DEFINE l_oldno02     LIKE isaf_t.isafdocno 
 
   DEFINE l_master    RECORD LIKE isaf_t.* #此變數樣板目前無使用
   DEFINE l_detail    RECORD LIKE isag_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE isah_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE xrcd_t.* #此變數樣板目前無使用
 
   DEFINE l_detail4    RECORD LIKE isat_t.* #此變數樣板目前無使用
 
 
 
   DEFINE l_cnt       LIKE type_t.num10
   #add-point:reproduce段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="reproduce.define"
   
   #end add-point   
   
   #add-point:Function前置處理  name="reproduce.pre_function"
   
   #end add-point
   
   #切換畫面
   
   LET g_master_insert = FALSE
   
   IF g_isaf_m.isafcomp IS NULL
   OR g_isaf_m.isafdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
    
   LET g_isafcomp_t = g_isaf_m.isafcomp
   LET g_isafdocno_t = g_isaf_m.isafdocno
 
    
   LET g_isaf_m.isafcomp = ""
   LET g_isaf_m.isafdocno = ""
 
 
   CALL cl_set_head_visible("","YES")
 
   #公用欄位給予預設值
   #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_isaf_m.isafownid = g_user
      LET g_isaf_m.isafowndp = g_dept
      LET g_isaf_m.isafcrtid = g_user
      LET g_isaf_m.isafcrtdp = g_dept 
      LET g_isaf_m.isafcrtdt = cl_get_current()
      LET g_isaf_m.isafmodid = g_user
      LET g_isaf_m.isafmoddt = cl_get_current()
      LET g_isaf_m.isafstus = 'N'
 
 
 
   
   CALL s_transaction_begin()
   
   #add-point:複製輸入前 name="reproduce.head.b_input"
   
   #end add-point
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_isaf_m.isafstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         
      END CASE
 
 
 
   
   #清空key欄位的desc
      LET g_isaf_m.isafdocno_desc = ''
   DISPLAY BY NAME g_isaf_m.isafdocno_desc
   LET g_isaf_m.isafcomp_desc = ''
   DISPLAY BY NAME g_isaf_m.isafcomp_desc
 
   
   CALL aist310_input("r")
   
   IF INT_FLAG AND NOT g_master_insert THEN
      LET INT_FLAG = 0
      DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
      DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
      LET INT_FLAG = 0
      INITIALIZE g_isaf_m.* TO NULL
      INITIALIZE g_isag_d TO NULL
      INITIALIZE g_isag2_d TO NULL
      INITIALIZE g_isag3_d TO NULL
      INITIALIZE g_isag4_d TO NULL
 
      #add-point:複製取消後 name="reproduce.cancel"
      
      #end add-point
      CALL aist310_show()
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = '' 
      LET g_errparam.code = 9001 
      LET g_errparam.popup = FALSE 
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL aist310_set_act_visible()   
   CALL aist310_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_isafcomp_t = g_isaf_m.isafcomp
   LET g_isafdocno_t = g_isaf_m.isafdocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " isafent = " ||g_enterprise|| " AND",
                      " isafcomp = '", g_isaf_m.isafcomp, "' "
                      ," AND isafdocno = '", g_isaf_m.isafdocno, "' "
 
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL aist310_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   #add-point:完成複製段落後 name="reproduce.after_reproduce"
   
   #end add-point
   
   CALL aist310_idx_chk()
   
   LET g_data_owner = g_isaf_m.isafownid      
   LET g_data_dept  = g_isaf_m.isafowndp
   
   #功能已完成,通報訊息中心
   CALL aist310_msgcentre_notify('reproduce')
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.detail_reproduce" >}
#+ 單身自動複製
PRIVATE FUNCTION aist310_detail_reproduce()
   #add-point:delete段define(客製用) name="detail_reproduce.define_customerization"
   
   #end add-point    
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE isag_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE isah_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE xrcd_t.* #此變數樣板目前無使用
 
   DEFINE l_detail4    RECORD LIKE isat_t.* #此變數樣板目前無使用
 
 
 
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_reproduce.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="detail_reproduce.pre_function"
   
   #end add-point
   
   CALL s_transaction_begin()
   
   LET ld_date = cl_get_current()
   
   DROP TABLE aist310_detail
   
   #add-point:單身複製前1 name="detail_reproduce.body.table1.b_insert"
   
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM isag_t
    WHERE isagent = g_enterprise AND isagcomp = g_isafcomp_t
     AND isagdocno = g_isafdocno_t
 
    INTO TEMP aist310_detail
 
   #將key修正為調整後   
   UPDATE aist310_detail 
      #更新key欄位
      SET isagcomp = g_isaf_m.isafcomp
          , isagdocno = g_isaf_m.isafdocno
 
      #更新共用欄位
      
 
   #add-point:單身修改前 name="detail_reproduce.body.table1.b_update"
   
   #end add-point                                       
  
   #將資料塞回原table   
   INSERT INTO isag_t SELECT * FROM aist310_detail
   
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "reproduce:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE 
      LET g_errparam.popup = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #add-point:單身複製中1 name="detail_reproduce.body.table1.m_insert"
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE aist310_detail
   
   #add-point:單身複製後1 name="detail_reproduce.body.table1.a_insert"
   
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table2.b_insert"
   
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM isah_t 
    WHERE isahent = g_enterprise AND isahcomp = g_isafcomp_t
      AND isahdocno = g_isafdocno_t   
 
    INTO TEMP aist310_detail
 
   #將key修正為調整後   
   UPDATE aist310_detail SET isahcomp = g_isaf_m.isafcomp
                                       , isahdocno = g_isaf_m.isafdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table2.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO isah_t SELECT * FROM aist310_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table2.m_insert"
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE aist310_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table2.a_insert"
   
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table3.b_insert"
   
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM xrcd_t 
    WHERE xrcdent = g_enterprise AND xrcdcomp = g_isafcomp_t
      AND xrcddocno = g_isafdocno_t   
 
    INTO TEMP aist310_detail
 
   #將key修正為調整後   
   UPDATE aist310_detail SET xrcdcomp = g_isaf_m.isafcomp
                                       , xrcddocno = g_isaf_m.isafdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table3.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO xrcd_t SELECT * FROM aist310_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table3.m_insert"
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE aist310_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table3.a_insert"
   
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table4.b_insert"
   
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM isat_t 
    WHERE isatent = g_enterprise AND isatcomp = g_isafcomp_t
      AND isatdocno = g_isafdocno_t   
 
    INTO TEMP aist310_detail
 
   #將key修正為調整後   
   UPDATE aist310_detail SET isatcomp = g_isaf_m.isafcomp
                                       , isatdocno = g_isaf_m.isafdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table4.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO isat_t SELECT * FROM aist310_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table4.m_insert"
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE aist310_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table4.a_insert"
   
   #end add-point
 
 
   
 
   
   #多語言複製段落
   
   
   CALL s_transaction_end('Y','0')
   
   #已新增完, 調整資料內容(修改時使用)
   LET g_isafcomp_t = g_isaf_m.isafcomp
   LET g_isafdocno_t = g_isaf_m.isafdocno
 
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.delete" >}
#+ 資料刪除
PRIVATE FUNCTION aist310_delete()
   #add-point:delete段define(客製用) name="delete.define_customerization"
   
   #end add-point     
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete.define"
   DEFINE  l_success       LIKE type_t.num5     #151223-00001#3 add lujh
   
   #160614-00025#1 --s add
   DEFINE l_sql           STRING
   DEFINE l_isag002       LIKE isag_t.isag002
   DEFINE l_rtia014       LIKE rtia_t.rtia014
   DEFINE l_rtia015       LIKE rtia_t.rtia015
   DEFINE l_date          DATETIME YEAR TO SECOND
   #160614-00025#1 --e add
   #end add-point     
   
   #add-point:Function前置處理  name="delete.pre_function"
   
   #end add-point
   
   IF g_isaf_m.isafcomp IS NULL
   OR g_isaf_m.isafdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
   
   
   
   CALL s_transaction_begin()
 
   OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
   IF SQLCA.SQLCODE THEN   #(ver:78)
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN aist310_cl:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
      LET g_errparam.popup = TRUE 
      CLOSE aist310_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE aist310_master_referesh USING g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isaf_m.isafsite, 
       g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt,g_isaf_m.isaf056,g_isaf_m.isaf005, 
       g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf016, 
       g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009, 
       g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101, 
       g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024, 
       g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029, 
       g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104, 
       g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114, 
       g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120, 
       g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049, 
       g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf205, 
       g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039,g_isaf_m.isaf040,g_isaf_m.isaf041, 
       g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf050,g_isaf_m.isaf004, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059,g_isaf_m.isaf060,g_isaf_m.isaf061, 
       g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208,g_isaf_m.isaf209, 
       g_isaf_m.isaf210,g_isaf_m.isafownid,g_isaf_m.isafowndp,g_isaf_m.isafcrtid,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmoddt,g_isaf_m.isafcnfid,g_isaf_m.isafcnfdt, 
       g_isaf_m.isafsite_desc,g_isaf_m.isafcomp_desc,g_isaf_m.isaf005_desc,g_isaf_m.isaf057_desc,g_isaf_m.isaf003_desc, 
       g_isaf_m.isaf052_desc,g_isaf_m.isaf002_desc,g_isaf_m.isaf201_desc,g_isaf_m.isaf202_desc,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf037_desc,g_isaf_m.isaf041_desc,g_isaf_m.isaf055_desc,g_isaf_m.isaf006_desc,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf210_desc,g_isaf_m.isafownid_desc,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid_desc, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafmodid_desc,g_isaf_m.isafcnfid_desc
   
   
   #檢查是否允許此動作
   IF NOT aist310_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_isaf_m_mask_o.* =  g_isaf_m.*
   CALL aist310_isaf_t_mask()
   LET g_isaf_m_mask_n.* =  g_isaf_m.*
   
   CALL aist310_show()
   
   #add-point:delete段before ask name="delete.before_ask"
   #20150309--add--str--
   IF g_isaf_m.isafstus <> 'N' THEN 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00313'
      LET g_errparam.extend = g_isaf_m.isafdocno
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN
   END IF
   #20150309--add--end--
   #end add-point 
 
   IF cl_ask_del_master() THEN              #確認一下
   
      #add-point:單頭刪除前 name="delete.head.b_delete"
      
      #end add-point   
      
      #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL aist310_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove"
      
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
  
  
      #資料備份
      LET g_isafcomp_t = g_isaf_m.isafcomp
      LET g_isafdocno_t = g_isaf_m.isafdocno
 
 
      DELETE FROM isaf_t
       WHERE isafent = g_enterprise AND isafcomp = g_isaf_m.isafcomp
         AND isafdocno = g_isaf_m.isafdocno
 
       
      #add-point:單頭刪除中 name="delete.head.m_delete"
      
      #end add-point
       
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_isaf_m.isafcomp,":",SQLERRMESSAGE  
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF
      
      #add-point:單頭刪除後 name="delete.head.a_delete"
      #IF NOT s_aooi200_del_docno(g_isaf_m.isafdocno,g_isaf_m.isafdocdt) THEN
      #   CALL s_transaction_end('N','0')
      #   RETURN
      #END IF
      #end add-point
  
      #add-point:單身刪除前 name="delete.body.b_delete"
      DELETE FROM xrcd_t
       WHERE xrcdent = g_enterprise 
         AND xrcdld = g_glaald 
         AND xrcddocno = g_isaf_m.isafdocno
         
      #151223-00001#3--add--str--lujh
      CALL aist310_upd_xmdl('','','','-') RETURNING l_success
      IF l_success = FALSE THEN 
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #151223-00001#3--add--str--lujh  
      
      #160614-00025#1 --s add
      #刪除時,更新單身來源類型為13/22的單據發票為空
      LET l_isag002 = ''
      LET l_date = cl_get_current()
      LET l_sql = "SELECT DISTINCT isag002 FROM isag_t ",
                  " WHERE isagent = '",g_enterprise,"'",
                  "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
                  "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
                  "   AND isag001 IN ('13','22') "
      PREPARE isag_upd_rtia014_psdel FROM l_sql
      DECLARE isag_upd_rtia014_csdel CURSOR FOR isag_upd_rtia014_psdel
      FOREACH isag_upd_rtia014_csdel INTO l_isag002
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "FOREACH: isag_upd_rtia014_csdel"
            LET g_errparam.popup = TRUE
            CALL cl_err()
            EXIT FOREACH
         END IF
         LET l_rtia014 = ''
         LET l_rtia015 = ''
         SELECT rtia014,rtia015 INTO l_rtia014,l_rtia015 FROM rtia_t
          WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
         IF NOT cl_null(l_rtia014) OR NOT cl_null(l_rtia015) THEN
            UPDATE rtia_t SET (rtia014,rtia015,rtiamodid,rtiamoddt) = ('','',g_user,l_date)
             WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
            IF SQLCA.SQLERRD[3] = 0 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = ""
               LET g_errparam.popup = FALSE
               CALL cl_err()
               CALL s_transaction_end('N','0')
               RETURN
            END IF
         END IF
      END FOREACH
      #160614-00025#1 --e add
      #end add-point
      
      DELETE FROM isag_t
       WHERE isagent = g_enterprise AND isagcomp = g_isaf_m.isafcomp
         AND isagdocno = g_isaf_m.isafdocno
 
 
      #add-point:單身刪除中 name="delete.body.m_delete"
      
      #end add-point
         
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isag_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF    
 
      #add-point:單身刪除後 name="delete.body.a_delete"
      
      #end add-point
      
            
                                                               
      #add-point:單身刪除前 name="delete.body.b_delete2"
      
      #end add-point
      DELETE FROM isah_t
       WHERE isahent = g_enterprise AND
             isahcomp = g_isaf_m.isafcomp AND isahdocno = g_isaf_m.isafdocno
      #add-point:單身刪除中 name="delete.body.m_delete2"
      
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete2"
 
      #end add-point
 
      #add-point:單身刪除前 name="delete.body.b_delete3"
      
      #end add-point
      DELETE FROM xrcd_t
       WHERE xrcdent = g_enterprise AND
             xrcdcomp = g_isaf_m.isafcomp AND xrcddocno = g_isaf_m.isafdocno
      #add-point:單身刪除中 name="delete.body.m_delete3"
      
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete3"
      
      #end add-point
 
      #add-point:單身刪除前 name="delete.body.b_delete4"
      
      #end add-point
      DELETE FROM isat_t
       WHERE isatent = g_enterprise AND
             isatcomp = g_isaf_m.isafcomp AND isatdocno = g_isaf_m.isafdocno
      #add-point:單身刪除中 name="delete.body.m_delete4"
      
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete4"
      SELECT glaa001,glaald
        INTO g_glaa001,g_glaald
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaacomp = g_isaf_m.isafcomp
         AND glaa014 = 'Y'

      #刪除單號
      IF NOT s_aooi200_fin_del_docno(g_glaald,g_isaf_m.isafdocno,g_isaf_m.isafdocdt) THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #end add-point
 
 
 
 
      
      #修改歷程記錄(刪除)
      LET g_log1 = util.JSON.stringify(g_isaf_m)   #(ver:78)
      IF NOT cl_log_modified_record(g_log1,'') THEN    #(ver:78)
         CLOSE aist310_cl
         CALL s_transaction_end('N','0')
         RETURN
      END IF
             
      CLEAR FORM
      CALL g_isag_d.clear() 
      CALL g_isag2_d.clear()       
      CALL g_isag3_d.clear()       
      CALL g_isag4_d.clear()       
 
     
      CALL aist310_ui_browser_refresh()  
      #CALL aist310_ui_headershow()  
      #CALL aist310_ui_detailshow()
 
      #add-point:多語言刪除 name="delete.lang.before_delete"
      
      #end add-point
      
      #單頭多語言刪除
      
      
      #單身多語言刪除
      
      
      
      
 
   
      #add-point:多語言刪除 name="delete.lang.delete"
      
      #end add-point
      
      IF g_browser_cnt > 0 THEN 
         #CALL aist310_browser_fill("")
         CALL aist310_fetch('P')
         DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
         DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
      ELSE
         CLEAR FORM
      END IF
      
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
 
   CLOSE aist310_cl
 
   #功能已完成,通報訊息中心
   CALL aist310_msgcentre_notify('delete')
    
END FUNCTION
 
{</section>}
 
{<section id="aist310.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION aist310_b_fill()
   #add-point:b_fill段define(客製用) name="b_fill.define_customerization"
   
   #end add-point     
   DEFINE p_wc2      STRING
   DEFINE li_idx     LIKE type_t.num10
   #add-point:b_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill.define"
   DEFINE l_ac1      LIKE type_t.num5
   DEFINE l_sql      STRING   #160414-00018#2
   #end add-point     
   
   #add-point:Function前置處理  name="b_fill.pre_function"
   
   #end add-point
   
   #清空第一階單身
   CALL g_isag_d.clear()
   CALL g_isag2_d.clear()
   CALL g_isag3_d.clear()
   CALL g_isag4_d.clear()
 
 
   #add-point:b_fill段sql_before name="b_fill.sql_before"
   LET l_ac1 = 1
   
   #160414-00018#2  利用aist310_fill_chk 回傳false繞過原本要多做sub_query沒辦法直接FOREACH 入的限制
   #160414-00018#2  後續都要到加欄位要到b_fill邏輯後面維護  
   
   #160414-00018#2-----s
   #稅別說明
   LET l_sql = " SELECT oodbl004 FROM oodbl_t WHERE oodblent='",g_enterprise,"' AND oodbl001=? AND oodbl002=? AND oodbl003='",g_dlang,"' "
   PREPARE sel_oodblp1 FROM l_sql
   #160414-00018#2-----e
  
   #end add-point
   
   #判斷是否填充
   IF aist310_fill_chk(1) THEN
      #切換上下筆時不重組SQL
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
      #add-point:b_fill段long_sql_if name="b_fill.long_sql_if"
      
      #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT isagseq,isagorga,isag001,isag002,isag003,isag018,isag009,isag010, 
             isag016,isag017,isag015,isag006,isag008,isag012,isag004,isag005,isag101,isag103,isag104, 
             isag105,isag113,isag114,isag115,isag116,isag117,isag013,isag014,isag011 ,t1.ooefl003 FROM isag_t", 
                
                     " INNER JOIN isaf_t ON isafent = " ||g_enterprise|| " AND isafcomp = isagcomp ",
                     " AND isafdocno = isagdocno ",
 
                     #"",
                     
                     "",
                     #下層單身所需的join條件
 
                                    " LEFT JOIN ooefl_t t1 ON t1.ooeflent="||g_enterprise||" AND t1.ooefl001=isagorga AND t1.ooefl002='"||g_dlang||"' ",
 
                     " WHERE isagent=? AND isagcomp=? AND isagdocno=?"
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段sql_before name="b_fill.body.fill_sql"
         
         #end add-point
         IF NOT cl_null(g_wc2_table1) THEN
            LET g_sql = g_sql CLIPPED, " AND ", g_wc2_table1 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY isag_t.isagseq"
         
         #add-point:單身填充控制 name="b_fill.sql"
         
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist310_pb FROM g_sql
         DECLARE b_fill_cs CURSOR FOR aist310_pb
      END IF
      
      LET g_cnt = l_ac
      LET l_ac = 1
      
   #  OPEN b_fill_cs USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno   #(ver:78)
                                               
      FOREACH b_fill_cs USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isag_d[l_ac].isagseq, 
          g_isag_d[l_ac].isagorga,g_isag_d[l_ac].isag001,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003, 
          g_isag_d[l_ac].isag018,g_isag_d[l_ac].isag009,g_isag_d[l_ac].isag010,g_isag_d[l_ac].isag016, 
          g_isag_d[l_ac].isag017,g_isag_d[l_ac].isag015,g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag008, 
          g_isag_d[l_ac].isag012,g_isag_d[l_ac].isag004,g_isag_d[l_ac].isag005,g_isag_d[l_ac].isag101, 
          g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,g_isag_d[l_ac].isag113, 
          g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,g_isag_d[l_ac].isag116,g_isag_d[l_ac].isag117, 
          g_isag_d[l_ac].isag013,g_isag_d[l_ac].isag014,g_isag_d[l_ac].isag011,g_isag_d[l_ac].isagorga_desc  
            #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill.fill"
         CALL aist310_ref_b_1()
         CALL aist310_isag002_ref(g_isag_d[l_ac].isag009,g_isag_d[l_ac].isag010)
         #end add-point
      
         IF l_ac > g_max_rec THEN
            IF g_error_show = 1 THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = l_ac
               LET g_errparam.code = 9035 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
            END IF
            EXIT FOREACH
         END IF
         
         LET l_ac = l_ac + 1
      END FOREACH
      LET g_error_show = 0
   
   END IF
    
   #判斷是否填充
   IF aist310_fill_chk(2) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body2.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT isahseq,isahorga,isah003,isah004,isah013,isah005,isah010,isah006, 
             isah101,isah103,isah007,isah104,isah105,isah113,isah114,isah115,isah001,isah002,isah008, 
             isah009,isah011,isah106,isah012,isah116 ,t2.ooefl003 FROM isah_t",   
                     " INNER JOIN  isaf_t ON isafent = " ||g_enterprise|| " AND isafcomp = isahcomp ",
                     " AND isafdocno = isahdocno ",
 
                     "",
                     
                                    " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=isahorga AND t2.ooefl002='"||g_dlang||"' ",
 
                     " WHERE isahent=? AND isahcomp=? AND isahdocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body2.fill_sql"
         
         #end add-point
         IF NOT cl_null(g_wc2_table2) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table2 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY isah_t.isahseq"
         
         #add-point:單身填充控制 name="b_fill.sql2"
         
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist310_pb2 FROM g_sql
         DECLARE b_fill_cs2 CURSOR FOR aist310_pb2
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs2 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno   #(ver:78)
                                               
      FOREACH b_fill_cs2 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isag2_d[l_ac].isahseq, 
          g_isag2_d[l_ac].isahorga,g_isag2_d[l_ac].isah003,g_isag2_d[l_ac].isah004,g_isag2_d[l_ac].isah013, 
          g_isag2_d[l_ac].isah005,g_isag2_d[l_ac].isah010,g_isag2_d[l_ac].isah006,g_isag2_d[l_ac].isah101, 
          g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah007,g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105, 
          g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114,g_isag2_d[l_ac].isah115,g_isag2_d[l_ac].isah001, 
          g_isag2_d[l_ac].isah002,g_isag2_d[l_ac].isah008,g_isag2_d[l_ac].isah009,g_isag2_d[l_ac].isah011, 
          g_isag2_d[l_ac].isah106,g_isag2_d[l_ac].isah012,g_isag2_d[l_ac].isah116,g_isag2_d[l_ac].isahorga_desc  
            #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill2.fill"
         CALL aist310_ref_b_2()
         
         LET l_ac1 = l_ac1 + 1
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
   #判斷是否填充
   IF aist310_fill_chk(3) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body3.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT xrcdld,xrcdseq2,xrcdseq,xrcd007,xrcd002,xrcd003,xrcd006,xrcd005, 
             xrcd104,xrcd103,xrcd105,xrcd114  FROM xrcd_t",   
                     " INNER JOIN  isaf_t ON isafent = " ||g_enterprise|| " AND isafcomp = xrcdcomp ",
                     " AND isafdocno = xrcddocno ",
 
                     "",
                     
                     
                     " WHERE xrcdent=? AND xrcdcomp=? AND xrcddocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body3.fill_sql"
         
         #end add-point
         IF NOT cl_null(g_wc2_table3) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table3 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY xrcd_t.xrcdld,xrcd_t.xrcdseq,xrcd_t.xrcdseq2,xrcd_t.xrcd007"
         
         #add-point:單身填充控制 name="b_fill.sql3"
         
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist310_pb3 FROM g_sql
         DECLARE b_fill_cs3 CURSOR FOR aist310_pb3
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs3 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno   #(ver:78)
                                               
      FOREACH b_fill_cs3 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isag3_d[l_ac].xrcdld, 
          g_isag3_d[l_ac].xrcdseq2,g_isag3_d[l_ac].xrcdseq,g_isag3_d[l_ac].xrcd007,g_isag3_d[l_ac].xrcd002, 
          g_isag3_d[l_ac].xrcd003,g_isag3_d[l_ac].xrcd006,g_isag3_d[l_ac].xrcd005,g_isag3_d[l_ac].xrcd104, 
          g_isag3_d[l_ac].xrcd103,g_isag3_d[l_ac].xrcd105,g_isag3_d[l_ac].xrcd114   #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill3.fill"
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = g_ooef019
         LET g_ref_fields[2] = g_isag3_d[l_ac].xrcd002
         CALL ap_ref_array2(g_ref_fields,"SELECT oodbl004 FROM oodbl_t WHERE oodblent='"||g_enterprise||"' AND oodbl001=? AND oodbl002=? AND oodbl003='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET g_isag3_d[l_ac].xrcd002_desc = '', g_rtn_fields[1] , ''
         DISPLAY g_isag3_d[l_ac].xrcd002_desc TO xrcd002_desc 

         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
   #判斷是否填充
   IF aist310_fill_chk(4) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body4.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT isatseq,isat003,isat004,isat027,isat006,isat002,isat103,isat104, 
             isat105,isat113,isat114,isat115,isat007,isat014,isat106,isat107,isat017,isatsite,isatdocdt  FROM isat_t", 
                
                     " INNER JOIN  isaf_t ON isafent = " ||g_enterprise|| " AND isafcomp = isatcomp ",
                     " AND isafdocno = isatdocno ",
 
                     "",
                     
                     
                     " WHERE isatent=? AND isatcomp=? AND isatdocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body4.fill_sql"
         
         #end add-point
         IF NOT cl_null(g_wc2_table4) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table4 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY isat_t.isatseq,isat_t.isat003,isat_t.isat004"
         
         #add-point:單身填充控制 name="b_fill.sql4"
         
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist310_pb4 FROM g_sql
         DECLARE b_fill_cs4 CURSOR FOR aist310_pb4
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs4 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno   #(ver:78)
                                               
      FOREACH b_fill_cs4 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isag4_d[l_ac].isatseq, 
          g_isag4_d[l_ac].isat003,g_isag4_d[l_ac].isat004,g_isag4_d[l_ac].isat027,g_isag4_d[l_ac].isat006, 
          g_isag4_d[l_ac].isat002,g_isag4_d[l_ac].isat103,g_isag4_d[l_ac].isat104,g_isag4_d[l_ac].isat105, 
          g_isag4_d[l_ac].isat113,g_isag4_d[l_ac].isat114,g_isag4_d[l_ac].isat115,g_isag4_d[l_ac].isat007, 
          g_isag4_d[l_ac].isat014,g_isag4_d[l_ac].isat106,g_isag4_d[l_ac].isat107,g_isag4_d[l_ac].isat017, 
          g_isag4_d[l_ac].isatsite,g_isag4_d[l_ac].isatdocdt   #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill4.fill"
         
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
 
   
   #add-point:browser_fill段其他table處理 name="browser_fill.other_fill"
   
   #160414-00018#2-----s
   IF aist310_fill_chk2(1) THEN
      #切換上下筆時不重組SQL
      IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN
        #LET g_sql = "SELECT  DISTINCT isagseq,isagorga,isag001,isag002,isag003,isag009,isag010,isag016,",         #160823-00016#1 mark
         LET g_sql = "SELECT  DISTINCT isagseq,isagorga,isag001,isag002,isag018,isag003,isag009,isag010,isag016,", #160823-00016#1
             "isag017,isag015,isag006,isag008,isag012,isag004,isag005,isag101,isag103,isag104,isag105,",
             "isag113,isag114,isag115,isag116,isag117,isag013,isag014,isag011 ,t1.ooefl003, ",
             " (SELECT ta05.oocal003 FROM oocal_t ta05 WHERE ta05.oocalent = ",g_enterprise," AND ta05.oocal001= isag005 AND ta05.oocal002='",g_dlang,"' ),",
             " '',",
             " (SELECT ta09.imaal004 FROM imaal_t ta09 WHERE ta09.imaalent= ",g_enterprise," AND ta09.imaal001=isag009 AND imaal002='",g_dlang,"' ) ",
             "    FROM isag_t",
             #" INNER JOIN isaf_t ON isafcomp = isagcomp ",                        #170215-00025#1 mark
             "   INNER JOIN isaf_t ON isafent = isagent AND isafcomp = isagcomp ", #170215-00025#1
             "     AND isafdocno = isagdocno ",
             "    LEFT JOIN ooefl_t t1 ON t1.ooeflent='"||g_enterprise||"' AND t1.ooefl001=isagorga AND t1.ooefl002='"||g_dlang||"' ",
             "   WHERE isagent=? AND isagcomp=? AND isagdocno=?"
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料

         IF NOT cl_null(g_wc2_table1) THEN
            LET g_sql = g_sql CLIPPED, " AND ", g_wc2_table1 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY isag_t.isagseq"
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist310_pb02 FROM g_sql
         DECLARE b_fill_cs02 CURSOR FOR aist310_pb02
      END IF
      
      LET g_cnt = l_ac
      LET l_ac = 1
      
      OPEN b_fill_cs02 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
                                               
      FOREACH b_fill_cs02 INTO g_isag_d[l_ac].isagseq,g_isag_d[l_ac].isagorga,g_isag_d[l_ac].isag001,g_isag_d[l_ac].isag002,
          g_isag_d[l_ac].isag018,   #160823-00016#1 
          g_isag_d[l_ac].isag003,g_isag_d[l_ac].isag009,g_isag_d[l_ac].isag010,g_isag_d[l_ac].isag016, 
          g_isag_d[l_ac].isag017,g_isag_d[l_ac].isag015,g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag008, 
          g_isag_d[l_ac].isag012,g_isag_d[l_ac].isag004,g_isag_d[l_ac].isag005,g_isag_d[l_ac].isag101, 
          g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,g_isag_d[l_ac].isag113, 
          g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,g_isag_d[l_ac].isag116,g_isag_d[l_ac].isag117, 
          g_isag_d[l_ac].isag013,g_isag_d[l_ac].isag014,g_isag_d[l_ac].isag011,g_isag_d[l_ac].isagorga_desc,
          g_isag_d[l_ac].isag005_desc,g_isag_d[l_ac].inag007_desc,g_isag_d[l_ac].imaal004

         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill.fill"
         CALL aist310_isag002_ref(g_isag_d[l_ac].isag009,g_isag_d[l_ac].isag010)
         #end add-point
      
         IF l_ac > g_max_rec THEN
            IF g_error_show = 1 THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = l_ac
               LET g_errparam.code   = 9035 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
            END IF
            EXIT FOREACH
         END IF
         
         LET l_ac = l_ac + 1
      END FOREACH
      LET g_error_show = 0
   
   END IF
   
   
   #####
   #判斷是否填充
   IF aist310_fill_chk2(2) THEN
      IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN
         LET g_sql = "SELECT  DISTINCT isahseq,isahorga,isah003,isah004,isah013,isah005,isah010,isah006,
             isah101,isah103,isah007,isah104,isah105,isah113,isah114,isah115,isah001,isah002,isah008, 
             isah009,isah011,isah106,isah012,isah116 ,t2.ooefl003, ",
             "(SELECT tb05.oocal003 FROM oocal_t tb05 WHERE tb05.oocalent= ",g_enterprise," AND tb05.oocal001=isah005 AND tb05.oocal002='",g_dlang,"') ",
             "   FROM isah_t",   
             #" INNER JOIN isaf_t ON isafcomp = isahcomp ",                       #170215-00025#1 mark
             "  INNER JOIN isaf_t ON isafent = isahent AND isafcomp = isahcomp ", #170215-00025#1
             "    AND isafdocno = isahdocno ",
             "   LEFT JOIN ooefl_t t2 ON t2.ooeflent='"||g_enterprise||"' AND t2.ooefl001=isahorga AND t2.ooefl002='"||g_dlang||"' ",
             "  WHERE isahent=? AND isahcomp=? AND isahdocno=?"
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料

         IF NOT cl_null(g_wc2_table2) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table2 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY isah_t.isahseq"
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist310_pb22 FROM g_sql
         DECLARE b_fill_cs22 CURSOR FOR aist310_pb22
      END IF
    
      LET l_ac = 1
      
      OPEN b_fill_cs22 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
                                               
      FOREACH b_fill_cs22 INTO g_isag2_d[l_ac].isahseq,g_isag2_d[l_ac].isahorga,g_isag2_d[l_ac].isah003, 
          g_isag2_d[l_ac].isah004,g_isag2_d[l_ac].isah013,g_isag2_d[l_ac].isah005,g_isag2_d[l_ac].isah010, 
          g_isag2_d[l_ac].isah006,g_isag2_d[l_ac].isah101,g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah007, 
          g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105,g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114, 
          g_isag2_d[l_ac].isah115,g_isag2_d[l_ac].isah001,g_isag2_d[l_ac].isah002,g_isag2_d[l_ac].isah008, 
          g_isag2_d[l_ac].isah009,g_isag2_d[l_ac].isah011,g_isag2_d[l_ac].isah106,g_isag2_d[l_ac].isah012, 
          g_isag2_d[l_ac].isah116,g_isag2_d[l_ac].isahorga_desc,g_isag2_d[l_ac].isah005_desc
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
                
         LET l_ac1 = l_ac1 + 1
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code   = 9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
   
   IF aist310_fill_chk2(3) THEN
      IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN
         LET g_sql = "SELECT DISTINCT xrcdld,xrcdseq2,xrcdseq,xrcd007,xrcd002,xrcd003,xrcd006,xrcd005, 
                                      xrcd104,xrcd103,xrcd105,xrcd114  FROM xrcd_t",   
         #" INNER JOIN isaf_t ON isafcomp = xrcdcomp ",                      #170215-00025#1 mark
         " INNER JOIN isaf_t ON isafent = xrcdent AND isafcomp = xrcdcomp ", #170215-00025#1
         "   AND isafdocno = xrcddocno ",
         " WHERE xrcdent=? AND xrcdcomp=? AND xrcddocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料

         IF NOT cl_null(g_wc2_table3) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table3 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY xrcd_t.xrcdld,xrcd_t.xrcdseq,xrcd_t.xrcdseq2,xrcd_t.xrcd007"
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist310_pb32 FROM g_sql
         DECLARE b_fill_cs32 CURSOR FOR aist310_pb32
      END IF
    
      LET l_ac = 1
      
      OPEN b_fill_cs32 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
                                               
      FOREACH b_fill_cs32 INTO g_isag3_d[l_ac].xrcdld,g_isag3_d[l_ac].xrcdseq2,g_isag3_d[l_ac].xrcdseq, 
          g_isag3_d[l_ac].xrcd007,g_isag3_d[l_ac].xrcd002,g_isag3_d[l_ac].xrcd003,g_isag3_d[l_ac].xrcd006, 
          g_isag3_d[l_ac].xrcd005,g_isag3_d[l_ac].xrcd104,g_isag3_d[l_ac].xrcd103,g_isag3_d[l_ac].xrcd105, 
          g_isag3_d[l_ac].xrcd114
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
      
         EXECUTE sel_oodblp1 USING g_ooef019,g_isag3_d[l_ac].xrcd002 INTO g_isag3_d[l_ac].xrcd002_desc 
         DISPLAY g_isag3_d[l_ac].xrcd002_desc TO xrcd002_desc          
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code   = 9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF   
   
   IF aist310_fill_chk2(4) THEN
      IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN
         LET g_sql = "SELECT DISTINCT isatseq,isat003,isat004,isat027,isat006,isat002,isat103,isat104, 
                                      isat105,isat113,isat114,isat115,isat007,isat014,isat106,isat107,isat017,isatsite,isatdocdt  FROM isat_t",   
         #" INNER JOIN isaf_t ON isafcomp = isatcomp ",                      #170215-00025#1 mark
         " INNER JOIN isaf_t ON isafent = isatent AND isafcomp = isatcomp ", #170215-00025#1
         "   AND isafdocno = isatdocno ",
         " WHERE isatent=? AND isatcomp=? AND isatdocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料

         IF NOT cl_null(g_wc2_table4) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table4 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY isat_t.isatseq,isat_t.isat003,isat_t.isat004"
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist310_pb42 FROM g_sql
         DECLARE b_fill_cs42 CURSOR FOR aist310_pb42
      END IF
    
      LET l_ac = 1
      
      OPEN b_fill_cs42 USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
                                               
      FOREACH b_fill_cs42 INTO g_isag4_d[l_ac].isatseq,g_isag4_d[l_ac].isat003,g_isag4_d[l_ac].isat004, 
          g_isag4_d[l_ac].isat027,g_isag4_d[l_ac].isat006,g_isag4_d[l_ac].isat002,g_isag4_d[l_ac].isat103, 
          g_isag4_d[l_ac].isat104,g_isag4_d[l_ac].isat105,g_isag4_d[l_ac].isat113,g_isag4_d[l_ac].isat114, 
          g_isag4_d[l_ac].isat115,g_isag4_d[l_ac].isat007,g_isag4_d[l_ac].isat014,g_isag4_d[l_ac].isat106, 
          g_isag4_d[l_ac].isat107,g_isag4_d[l_ac].isat017,g_isag4_d[l_ac].isatsite,g_isag4_d[l_ac].isatdocdt 

         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF

      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code   = 9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
   #160414-00018#2 效能調校-----e
   
   
   #判斷是否填充
   IF l_ac1 > 1 THEN
      SELECT SUM(isah103*isah010),SUM(isah104*isah010),SUM(isah105*isah010),
             SUM(isah113*isah010),SUM(isah114*isah010),SUM(isah115*isah010)
        INTO g_isag2_d[l_ac1].isah103,g_isag2_d[l_ac1].isah104,g_isag2_d[l_ac1].isah105,
             g_isag2_d[l_ac1].isah113,g_isag2_d[l_ac1].isah114,g_isag2_d[l_ac1].isah115
        FROM isah_t
       WHERE isahent = g_enterprise
         AND isahdocno = g_isaf_m.isafdocno
         AND isahcomp = g_isaf_m.isafcomp
      LET g_isag2_d[l_ac1].isah005_desc = cl_getmsg('axc-00383',g_lang)
   ELSE
      CALL g_isag2_d.deleteElement(g_isag2_d.getLength())
   END IF
   
   CALL g_isag_d.deleteElement(g_isag_d.getLength())
   CALL g_isag3_d.deleteElement(g_isag3_d.getLength())
   CALL g_isag4_d.deleteElement(g_isag4_d.getLength())
 
   
 
   LET l_ac = g_cnt
   LET g_cnt = 0  
   
   FREE aist310_pb
   FREE aist310_pb2
 
   FREE aist310_pb3
 
   FREE aist310_pb4
 
 
   CALL cl_ap_performance_next_end()
   
   RETURN
   #end add-point
   
   CALL g_isag_d.deleteElement(g_isag_d.getLength())
   CALL g_isag2_d.deleteElement(g_isag2_d.getLength())
   CALL g_isag3_d.deleteElement(g_isag3_d.getLength())
   CALL g_isag4_d.deleteElement(g_isag4_d.getLength())
 
   
 
   LET l_ac = g_cnt
   LET g_cnt = 0  
   
   FREE aist310_pb
   FREE aist310_pb2
 
   FREE aist310_pb3
 
   FREE aist310_pb4
 
 
   
   LET li_idx = l_ac
   
   #遮罩相關處理
   FOR l_ac = 1 TO g_isag_d.getLength()
      LET g_isag_d_mask_o[l_ac].* =  g_isag_d[l_ac].*
      CALL aist310_isag_t_mask()
      LET g_isag_d_mask_n[l_ac].* =  g_isag_d[l_ac].*
   END FOR
   
   LET g_isag2_d_mask_o.* =  g_isag2_d.*
   FOR l_ac = 1 TO g_isag2_d.getLength()
      LET g_isag2_d_mask_o[l_ac].* =  g_isag2_d[l_ac].*
      CALL aist310_isah_t_mask()
      LET g_isag2_d_mask_n[l_ac].* =  g_isag2_d[l_ac].*
   END FOR
   LET g_isag3_d_mask_o.* =  g_isag3_d.*
   FOR l_ac = 1 TO g_isag3_d.getLength()
      LET g_isag3_d_mask_o[l_ac].* =  g_isag3_d[l_ac].*
      CALL aist310_xrcd_t_mask()
      LET g_isag3_d_mask_n[l_ac].* =  g_isag3_d[l_ac].*
   END FOR
   LET g_isag4_d_mask_o.* =  g_isag4_d.*
   FOR l_ac = 1 TO g_isag4_d.getLength()
      LET g_isag4_d_mask_o[l_ac].* =  g_isag4_d[l_ac].*
      CALL aist310_isat_t_mask()
      LET g_isag4_d_mask_n[l_ac].* =  g_isag4_d[l_ac].*
   END FOR
 
   
   LET l_ac = li_idx
   
   CALL cl_ap_performance_next_end()
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.delete_b" >}
#+ 刪除單身後其他table連動
PRIVATE FUNCTION aist310_delete_b(ps_table,ps_keys_bak,ps_page)
   #add-point:delete_b段define(客製用) name="delete_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete_b.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="delete_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete"
      
      #end add-point    
      DELETE FROM isag_t
       WHERE isagent = g_enterprise AND
         isagcomp = ps_keys_bak[1] AND isagdocno = ps_keys_bak[2] AND isagseq = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete"
      
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = ":",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_isag_d.deleteElement(li_idx) 
      END IF 
 
   END IF
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete2"
      
      #end add-point    
      DELETE FROM isah_t
       WHERE isahent = g_enterprise AND
             isahcomp = ps_keys_bak[1] AND isahdocno = ps_keys_bak[2] AND isahseq = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete2"
      
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'2'" THEN 
         CALL g_isag2_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete2"
      
      #end add-point    
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete3"
      
      #end add-point    
      DELETE FROM xrcd_t
       WHERE xrcdent = g_enterprise AND
             xrcdcomp = ps_keys_bak[1] AND xrcddocno = ps_keys_bak[2] AND xrcdld = ps_keys_bak[3] AND xrcdseq = ps_keys_bak[4] AND xrcdseq2 = ps_keys_bak[5] AND xrcd007 = ps_keys_bak[6]
      #add-point:delete_b段刪除中 name="delete_b.m_delete3"
      
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_isag3_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete3"
      
      #end add-point    
   END IF
 
   LET ls_group = "'4',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete4"
      
      #end add-point    
      DELETE FROM isat_t
       WHERE isatent = g_enterprise AND
             isatcomp = ps_keys_bak[1] AND isatdocno = ps_keys_bak[2] AND isatseq = ps_keys_bak[3] AND isat003 = ps_keys_bak[4] AND isat004 = ps_keys_bak[5]
      #add-point:delete_b段刪除中 name="delete_b.m_delete4"
      
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'4'" THEN 
         CALL g_isag4_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete4"
      
      #end add-point    
   END IF
 
 
   
 
   
   #add-point:delete_b段other name="delete_b.other"
   
   #end add-point  
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.insert_b" >}
#+ 新增單身後其他table連動
PRIVATE FUNCTION aist310_insert_b(ps_table,ps_keys,ps_page)
   #add-point:insert_b段define(客製用) name="insert_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:insert_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert_b.define"
   DEFINE  l_isat113             LIKE isat_t.isat113
   DEFINE  l_isat114             LIKE isat_t.isat114
   DEFINE  l_isat115             LIKE isat_t.isat115
   DEFINE  l_isat201             LIKE isat_t.isat201
   DEFINE  l_isat202             LIKE isat_t.isat202
   DEFINE  l_isat203             LIKE isat_t.isat203
   DEFINE  l_isat008             LIKE isat_t.isat008
   DEFINE  l_isat026             LIKE isat_t.isat026
   DEFINE  l_isat027             LIKE isat_t.isat027 #160215-00013#1
   #161214-00053#1 add ------
   DEFINE  l_sql                 STRING
   DEFINE  l_isag013             LIKE isag_t.isag013
   DEFINE  l_isag014             LIKE isag_t.isag014
   #161214-00053#1 add end---
   #end add-point     
   
   #add-point:Function前置處理  name="insert_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert"
 
      #end add-point 
      INSERT INTO isag_t
                  (isagent,
                   isagcomp,isagdocno,
                   isagseq
                   ,isagorga,isag001,isag002,isag003,isag018,isag009,isag010,isag016,isag017,isag015,isag006,isag008,isag012,isag004,isag005,isag101,isag103,isag104,isag105,isag113,isag114,isag115,isag116,isag117,isag013,isag014,isag011) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_isag_d[g_detail_idx].isagorga,g_isag_d[g_detail_idx].isag001,g_isag_d[g_detail_idx].isag002, 
                       g_isag_d[g_detail_idx].isag003,g_isag_d[g_detail_idx].isag018,g_isag_d[g_detail_idx].isag009, 
                       g_isag_d[g_detail_idx].isag010,g_isag_d[g_detail_idx].isag016,g_isag_d[g_detail_idx].isag017, 
                       g_isag_d[g_detail_idx].isag015,g_isag_d[g_detail_idx].isag006,g_isag_d[g_detail_idx].isag008, 
                       g_isag_d[g_detail_idx].isag012,g_isag_d[g_detail_idx].isag004,g_isag_d[g_detail_idx].isag005, 
                       g_isag_d[g_detail_idx].isag101,g_isag_d[g_detail_idx].isag103,g_isag_d[g_detail_idx].isag104, 
                       g_isag_d[g_detail_idx].isag105,g_isag_d[g_detail_idx].isag113,g_isag_d[g_detail_idx].isag114, 
                       g_isag_d[g_detail_idx].isag115,g_isag_d[g_detail_idx].isag116,g_isag_d[g_detail_idx].isag117, 
                       g_isag_d[g_detail_idx].isag013,g_isag_d[g_detail_idx].isag014,g_isag_d[g_detail_idx].isag011) 
 
      #add-point:insert_b段資料新增中 name="insert_b.m_insert"
      
      #end add-point 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isag_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_isag_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert"
      
      #end add-point 
   END IF
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert2"
 
      #end add-point 
      INSERT INTO isah_t
                  (isahent,
                   isahcomp,isahdocno,
                   isahseq
                   ,isahorga,isah003,isah004,isah013,isah005,isah010,isah006,isah101,isah103,isah007,isah104,isah105,isah113,isah114,isah115,isah001,isah002,isah008,isah009,isah011,isah106,isah012,isah116) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_isag2_d[g_detail_idx].isahorga,g_isag2_d[g_detail_idx].isah003,g_isag2_d[g_detail_idx].isah004, 
                       g_isag2_d[g_detail_idx].isah013,g_isag2_d[g_detail_idx].isah005,g_isag2_d[g_detail_idx].isah010, 
                       g_isag2_d[g_detail_idx].isah006,g_isag2_d[g_detail_idx].isah101,g_isag2_d[g_detail_idx].isah103, 
                       g_isag2_d[g_detail_idx].isah007,g_isag2_d[g_detail_idx].isah104,g_isag2_d[g_detail_idx].isah105, 
                       g_isag2_d[g_detail_idx].isah113,g_isag2_d[g_detail_idx].isah114,g_isag2_d[g_detail_idx].isah115, 
                       g_isag2_d[g_detail_idx].isah001,g_isag2_d[g_detail_idx].isah002,g_isag2_d[g_detail_idx].isah008, 
                       g_isag2_d[g_detail_idx].isah009,g_isag2_d[g_detail_idx].isah011,g_isag2_d[g_detail_idx].isah106, 
                       g_isag2_d[g_detail_idx].isah012,g_isag2_d[g_detail_idx].isah116)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert2"
      
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'2'" THEN 
         CALL g_isag2_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert2"
      
      #end add-point
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert3"
      
      #end add-point 
      INSERT INTO xrcd_t
                  (xrcdent,
                   xrcdcomp,xrcddocno,
                   xrcdld,xrcdseq,xrcdseq2,xrcd007
                   ,xrcd002,xrcd003,xrcd006,xrcd005,xrcd104,xrcd103,xrcd105,xrcd114) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5],ps_keys[6]
                   ,g_isag3_d[g_detail_idx].xrcd002,g_isag3_d[g_detail_idx].xrcd003,g_isag3_d[g_detail_idx].xrcd006, 
                       g_isag3_d[g_detail_idx].xrcd005,g_isag3_d[g_detail_idx].xrcd104,g_isag3_d[g_detail_idx].xrcd103, 
                       g_isag3_d[g_detail_idx].xrcd105,g_isag3_d[g_detail_idx].xrcd114)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert3"
      
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_isag3_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert3"
      
      #end add-point
   END IF
 
   LET ls_group = "'4',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert4"
      
      #end add-point 
      INSERT INTO isat_t
                  (isatent,
                   isatcomp,isatdocno,
                   isatseq,isat003,isat004
                   ,isat027,isat006,isat002,isat103,isat104,isat105,isat113,isat114,isat115,isat007,isat014,isat106,isat107,isat017,isatsite,isatdocdt) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5]
                   ,g_isag4_d[g_detail_idx].isat027,g_isag4_d[g_detail_idx].isat006,g_isag4_d[g_detail_idx].isat002, 
                       g_isag4_d[g_detail_idx].isat103,g_isag4_d[g_detail_idx].isat104,g_isag4_d[g_detail_idx].isat105, 
                       g_isag4_d[g_detail_idx].isat113,g_isag4_d[g_detail_idx].isat114,g_isag4_d[g_detail_idx].isat115, 
                       g_isag4_d[g_detail_idx].isat007,g_isag4_d[g_detail_idx].isat014,g_isag4_d[g_detail_idx].isat106, 
                       g_isag4_d[g_detail_idx].isat107,g_isag4_d[g_detail_idx].isat017,g_isag4_d[g_detail_idx].isatsite, 
                       g_isag4_d[g_detail_idx].isatdocdt)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert4"
      
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'4'" THEN 
         CALL g_isag4_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert4"
      
      #end add-point
   END IF
 
 
   
 
   
   #add-point:insert_b段other name="insert_b.other"
   LET ls_group = "'5',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前

      #end add-point 
      #150915-00009#3 mark-----s
#      LET l_isat113 = g_isag4_d[g_detail_idx].isat103 * g_isaf_m.isaf101
#      LET l_isat114 = g_isag4_d[g_detail_idx].isat104 * g_isaf_m.isaf101
#      LET l_isat115 = g_isag4_d[g_detail_idx].isat105 * g_isaf_m.isaf101
      #150915-00009#3 mark-----e
      
      #150915-00009#3-----s
      IF cl_null(g_isag4_d[g_detail_idx].isat103) OR
         (g_isag4_d[g_detail_idx].isat103=0 AND g_isag4_d[g_detail_idx].isat113 <> 0) THEN
         LET g_isag4_d[g_detail_idx].isat103 = g_isag4_d[g_detail_idx].isat113
      END IF
      
      IF cl_null(g_isag4_d[g_detail_idx].isat104) OR
         (g_isag4_d[g_detail_idx].isat104=0 AND g_isag4_d[g_detail_idx].isat114 <> 0) THEN
         LET g_isag4_d[g_detail_idx].isat104 = g_isag4_d[g_detail_idx].isat114
      END IF
      
      IF cl_null(g_isag4_d[g_detail_idx].isat105) OR
         (g_isag4_d[g_detail_idx].isat105=0 AND g_isag4_d[g_detail_idx].isat115 <> 0) THEN
         LET g_isag4_d[g_detail_idx].isat105 = g_isag4_d[g_detail_idx].isat115
      END IF
      #150915-00009#3-----e
      IF g_isaf_m.isaf054 = '1' THEN 
         LET l_isat201 = g_isag4_d[g_detail_idx].isat105
      ELSE
         LET l_isat201 = 0
      END IF
      IF g_isaf_m.isaf054 = '2' THEN 
         LET l_isat202 = g_isag4_d[g_detail_idx].isat105
      ELSE
         LET l_isat202 = 0
      END IF
      IF g_isaf_m.isaf054 = '3' THEN 
         LET l_isat203 = g_isag4_d[g_detail_idx].isat105
      ELSE
         LET l_isat203 = 0
      END IF
      
      IF cl_null(ps_keys[4]) THEN 
         LET ps_keys[4] = ' '
      END IF
      #160118-00007#2   ---s---
      LET l_isat008 = cl_get_current() 
      IF g_isaf_m.isaf009 = 'Y' THEN
         SELECT isak003 INTO l_isat026
           FROM isak_t WHERE isakent = g_enterprise
            AND isak001 = g_isaf_m.isaf002 AND isak002 = g_ooef019
      END IF
      #160118-00007#2   ---e---
      #161214-00053#1 mark ------
      ##160215-00013#1 ---s---  取最接近日期並且為折完之發票
      #IF g_isaf_m.isaf056 = '2' THEN 
      #   SELECT MAX(isat007) INTO l_isat027 FROM isat_t 
      #    WHERE isatent = g_enterprise 
      #      AND (isat103 -isat106 > 0)
      #      AND isat004 = ps_keys[5] AND isaf056 = '1'
      #      AND isat007 IS NOT NULL 
      #   SELECT DISTINCT isaf009 INTO g_isaf_m.isaf009 FROM isaf_t #取得原發票電子發票狀態
      #    WHERE isafent = g_enterprise AND isaf011 = ps_keys[5]
      #      AND isaf056 = '1' 
      #END IF
      ##160215-00013#1 ---e---
      #161214-00053#1 mark end---
      #170214-00045#1 mark ------
      ##161214-00053#1 add ------
      #LET l_isat027 = ''
      #IF g_isaf_m.isaf056 = '2' THEN
      #   #撈取來源明細的來源發票，若無，則來源發票日期給空
      #   LET l_sql = "SELECT isag013,isag014",
      #               "  FROM isag_t",
      #               " WHERE isagent = ",g_enterprise,
      #               "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
      #               "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
      #               "   AND isag014 IS NOT NULL"
      #   PREPARE sel_isag_p1 FROM l_sql
      #   DECLARE sel_isag_c1 SCROLL CURSOR FOR sel_isag_p1
      #   OPEN sel_isag_c1
      #   FETCH FIRST sel_isag_c1 INTO l_isag013,l_isag014
      #   
      #   IF NOT cl_null(l_isag014) THEN
      #      SELECT isat007 INTO l_isat027
      #        FROM isat_t
      #       WHERE isatent = g_enterprise
      #         AND isat003 = l_isag013
      #         AND isat004 = l_isag014
      #   END IF
      #END IF
      ##161214-00053#1 add end---
      #170214-00045#1 mark end---
      LET l_isat027 = g_isag4_d[g_detail_idx].isat027 #170214-00045#1
      #150331-00006#5 add isatsite,isatdocdt
      #151005-00007#2 add isat025
      #160118-00007#2 add isat008,isat026
      #160215-00013#1 add isat002,isat027,isat028,isat029
      INSERT INTO isat_t
            (isatent,isatcomp,isatdocno,isatseq,isat003,isat004,isat001,isat002,
             isat005,isat006,isat007,isat008,isat009,isat010,isat011,isat012,isat013,
             isat014,isat015,isat016,isat017,isat018,isat019,isat020,isat021,isat022,
             isat023,isat100,isat101,isat103,isat104,isat105,isat106,isat107,isat113,
             isat114,isat115,isat201,isat202,isat203,isat204,isat205,isat206,isat207,
             isat208,isat209,isatsite,isatdocdt,isat025,isat026,isat027,isat028,isat029)                
      VALUES(g_enterprise,ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5],
             g_isaf_m.isaf008,g_isaf_m.isaf009,
           #  g_isaf_m.isaf053,'','','',g_isaf_m.isaf021,g_isaf_m.isaf022,       #160118-00007#2 
             #g_isaf_m.isaf053,'','',l_isat008,g_isaf_m.isaf021,g_isaf_m.isaf022, #160118-00007#2              #160907-00041#1 mark     
             g_isaf_m.isaf053,'',g_isag4_d[g_detail_idx].isat007,l_isat008,g_isaf_m.isaf021,g_isaf_m.isaf022,  #160907-00041#1 add   補上發票日期
             g_isaf_m.isaf023,g_isaf_m.isaf028,g_isaf_m.isaf034,
             g_isag4_d[g_detail_idx].isat014,'','',g_isag4_d[g_detail_idx].isat017,
             g_time,g_user,'',0,g_isaf_m.isaf054,g_isaf_m.isaf018,g_isaf_m.isaf100,
             g_isaf_m.isaf101,g_isag4_d[g_detail_idx].isat103,g_isag4_d[g_detail_idx].isat104,
             g_isag4_d[g_detail_idx].isat105,0,0,g_isag4_d[g_detail_idx].isat113,g_isag4_d[g_detail_idx].isat114,g_isag4_d[g_detail_idx].isat115,
             l_isat201,
             l_isat202,l_isat203,g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,
             g_isaf_m.isaf204,'','',g_isag4_d[g_detail_idx].isatsite,g_isag4_d[g_detail_idx].isatdocdt,g_isag4_d[g_detail_idx].isat014,l_isat026,
             l_isat027,g_isaf_m.isaf016,g_isaf_m.isaf017)
      #add-point:insert_b段資料新增中

      #end add-point
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isat_t" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'5'" THEN 
         CALL g_isag4_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後

      #end add-point
   END IF
   #end add-point     
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.update_b" >}
#+ 修改單身後其他table連動
PRIVATE FUNCTION aist310_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   #add-point:update_b段define(客製用) name="update_b.define_customerization"
   
   #end add-point   
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num10 
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="update_b.define"
 
   #end add-point   
   
   #add-point:Function前置處理  name="update_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE   
   
   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR
   
   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "isag_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update"
      
      #end add-point 
      
      #將遮罩欄位還原
      CALL aist310_isag_t_mask_restore('restore_mask_o')
               
      UPDATE isag_t 
         SET (isagcomp,isagdocno,
              isagseq
              ,isagorga,isag001,isag002,isag003,isag018,isag009,isag010,isag016,isag017,isag015,isag006,isag008,isag012,isag004,isag005,isag101,isag103,isag104,isag105,isag113,isag114,isag115,isag116,isag117,isag013,isag014,isag011) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_isag_d[g_detail_idx].isagorga,g_isag_d[g_detail_idx].isag001,g_isag_d[g_detail_idx].isag002, 
                  g_isag_d[g_detail_idx].isag003,g_isag_d[g_detail_idx].isag018,g_isag_d[g_detail_idx].isag009, 
                  g_isag_d[g_detail_idx].isag010,g_isag_d[g_detail_idx].isag016,g_isag_d[g_detail_idx].isag017, 
                  g_isag_d[g_detail_idx].isag015,g_isag_d[g_detail_idx].isag006,g_isag_d[g_detail_idx].isag008, 
                  g_isag_d[g_detail_idx].isag012,g_isag_d[g_detail_idx].isag004,g_isag_d[g_detail_idx].isag005, 
                  g_isag_d[g_detail_idx].isag101,g_isag_d[g_detail_idx].isag103,g_isag_d[g_detail_idx].isag104, 
                  g_isag_d[g_detail_idx].isag105,g_isag_d[g_detail_idx].isag113,g_isag_d[g_detail_idx].isag114, 
                  g_isag_d[g_detail_idx].isag115,g_isag_d[g_detail_idx].isag116,g_isag_d[g_detail_idx].isag117, 
                  g_isag_d[g_detail_idx].isag013,g_isag_d[g_detail_idx].isag014,g_isag_d[g_detail_idx].isag011)  
 
         WHERE isagent = g_enterprise AND isagcomp = ps_keys_bak[1] AND isagdocno = ps_keys_bak[2] AND isagseq = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update"
      
      #end add-point   
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isag_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isag_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
 
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL aist310_isag_t_mask_restore('restore_mask_n')
               
      #add-point:update_b段修改後 name="update_b.after_update"
      
      #end add-point  
   END IF
   
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
   
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "isah_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update2"
      
      #end add-point  
      
      #將遮罩欄位還原
      CALL aist310_isah_t_mask_restore('restore_mask_o')
               
      UPDATE isah_t 
         SET (isahcomp,isahdocno,
              isahseq
              ,isahorga,isah003,isah004,isah013,isah005,isah010,isah006,isah101,isah103,isah007,isah104,isah105,isah113,isah114,isah115,isah001,isah002,isah008,isah009,isah011,isah106,isah012,isah116) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_isag2_d[g_detail_idx].isahorga,g_isag2_d[g_detail_idx].isah003,g_isag2_d[g_detail_idx].isah004, 
                  g_isag2_d[g_detail_idx].isah013,g_isag2_d[g_detail_idx].isah005,g_isag2_d[g_detail_idx].isah010, 
                  g_isag2_d[g_detail_idx].isah006,g_isag2_d[g_detail_idx].isah101,g_isag2_d[g_detail_idx].isah103, 
                  g_isag2_d[g_detail_idx].isah007,g_isag2_d[g_detail_idx].isah104,g_isag2_d[g_detail_idx].isah105, 
                  g_isag2_d[g_detail_idx].isah113,g_isag2_d[g_detail_idx].isah114,g_isag2_d[g_detail_idx].isah115, 
                  g_isag2_d[g_detail_idx].isah001,g_isag2_d[g_detail_idx].isah002,g_isag2_d[g_detail_idx].isah008, 
                  g_isag2_d[g_detail_idx].isah009,g_isag2_d[g_detail_idx].isah011,g_isag2_d[g_detail_idx].isah106, 
                  g_isag2_d[g_detail_idx].isah012,g_isag2_d[g_detail_idx].isah116) 
         WHERE isahent = g_enterprise AND isahcomp = ps_keys_bak[1] AND isahdocno = ps_keys_bak[2] AND isahseq = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update2"
      
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isah_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL aist310_isah_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update2"
      
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "xrcd_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update3"
      
      #end add-point  
      
      #將遮罩欄位還原
      CALL aist310_xrcd_t_mask_restore('restore_mask_o')
               
      UPDATE xrcd_t 
         SET (xrcdcomp,xrcddocno,
              xrcdld,xrcdseq,xrcdseq2,xrcd007
              ,xrcd002,xrcd003,xrcd006,xrcd005,xrcd104,xrcd103,xrcd105,xrcd114) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5],ps_keys[6]
              ,g_isag3_d[g_detail_idx].xrcd002,g_isag3_d[g_detail_idx].xrcd003,g_isag3_d[g_detail_idx].xrcd006, 
                  g_isag3_d[g_detail_idx].xrcd005,g_isag3_d[g_detail_idx].xrcd104,g_isag3_d[g_detail_idx].xrcd103, 
                  g_isag3_d[g_detail_idx].xrcd105,g_isag3_d[g_detail_idx].xrcd114) 
         WHERE xrcdent = g_enterprise AND xrcdcomp = ps_keys_bak[1] AND xrcddocno = ps_keys_bak[2] AND xrcdld = ps_keys_bak[3] AND xrcdseq = ps_keys_bak[4] AND xrcdseq2 = ps_keys_bak[5] AND xrcd007 = ps_keys_bak[6]
      #add-point:update_b段修改中 name="update_b.m_update3"
      
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "xrcd_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL aist310_xrcd_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update3"
      
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
   LET ls_group = "'4',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "isat_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update4"
      
      #end add-point  
      
      #將遮罩欄位還原
      CALL aist310_isat_t_mask_restore('restore_mask_o')
               
      UPDATE isat_t 
         SET (isatcomp,isatdocno,
              isatseq,isat003,isat004
              ,isat027,isat006,isat002,isat103,isat104,isat105,isat113,isat114,isat115,isat007,isat014,isat106,isat107,isat017,isatsite,isatdocdt) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5]
              ,g_isag4_d[g_detail_idx].isat027,g_isag4_d[g_detail_idx].isat006,g_isag4_d[g_detail_idx].isat002, 
                  g_isag4_d[g_detail_idx].isat103,g_isag4_d[g_detail_idx].isat104,g_isag4_d[g_detail_idx].isat105, 
                  g_isag4_d[g_detail_idx].isat113,g_isag4_d[g_detail_idx].isat114,g_isag4_d[g_detail_idx].isat115, 
                  g_isag4_d[g_detail_idx].isat007,g_isag4_d[g_detail_idx].isat014,g_isag4_d[g_detail_idx].isat106, 
                  g_isag4_d[g_detail_idx].isat107,g_isag4_d[g_detail_idx].isat017,g_isag4_d[g_detail_idx].isatsite, 
                  g_isag4_d[g_detail_idx].isatdocdt) 
         WHERE isatent = g_enterprise AND isatcomp = ps_keys_bak[1] AND isatdocno = ps_keys_bak[2] AND isatseq = ps_keys_bak[3] AND isat003 = ps_keys_bak[4] AND isat004 = ps_keys_bak[5]
      #add-point:update_b段修改中 name="update_b.m_update4"
      
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isat_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL aist310_isat_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update4"
      
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
 
   
 
   
   #add-point:update_b段other name="update_b.other"
   
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.key_update_b" >}
#+ 上層單身key欄位變動後, 連帶修正下層單身key欄位
PRIVATE FUNCTION aist310_key_update_b(ps_keys_bak,ps_table)
   #add-point:update_b段define(客製用) name="key_update_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_key       DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_update_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_update_b.pre_function"
   
   #end add-point
   
 
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.key_delete_b" >}
#+ 上層單身刪除後, 連帶刪除下層單身key欄位
PRIVATE FUNCTION aist310_key_delete_b(ps_keys_bak,ps_table)
   #add-point:delete_b段define(客製用) name="key_delete_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_keys      DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_delete_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_delete_b.pre_function"
   
   #end add-point
   
 
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.lock_b" >}
#+ 連動lock其他單身table資料
PRIVATE FUNCTION aist310_lock_b(ps_table,ps_page)
   #add-point:lock_b段define(客製用) name="lock_b.define_customerization"
   
   #end add-point   
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:lock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="lock_b.define"
   
   #end add-point   
   
   #add-point:Function前置處理  name="lock_b.pre_function"
   
   #end add-point
    
   #先刷新資料
   #CALL aist310_b_fill()
   
   #鎖定整組table
   #LET ls_group = "'1',"
   #僅鎖定自身table
   LET ls_group = "isag_t"
   
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN aist310_bcl USING g_enterprise,
                                       g_isaf_m.isafcomp,g_isaf_m.isafdocno,g_isag_d[g_detail_idx].isagseq  
                                               
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aist310_bcl:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
                                    
   #鎖定整組table
   #LET ls_group = "'2',"
   #僅鎖定自身table
   LET ls_group = "isah_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN aist310_bcl2 USING g_enterprise,
                                             g_isaf_m.isafcomp,g_isaf_m.isafdocno,g_isag2_d[g_detail_idx].isahseq 
 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aist310_bcl2:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
   #鎖定整組table
   #LET ls_group = "'3',"
   #僅鎖定自身table
   LET ls_group = "xrcd_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN aist310_bcl3 USING g_enterprise,
                                             g_isaf_m.isafcomp,g_isaf_m.isafdocno,g_isag3_d[g_detail_idx].xrcdld, 
                                                 g_isag3_d[g_detail_idx].xrcdseq,g_isag3_d[g_detail_idx].xrcdseq2, 
                                                 g_isag3_d[g_detail_idx].xrcd007
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aist310_bcl3:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
   #鎖定整組table
   #LET ls_group = "'4',"
   #僅鎖定自身table
   LET ls_group = "isat_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN aist310_bcl4 USING g_enterprise,
                                             g_isaf_m.isafcomp,g_isaf_m.isafdocno,g_isag4_d[g_detail_idx].isatseq, 
                                                 g_isag4_d[g_detail_idx].isat003,g_isag4_d[g_detail_idx].isat004 
 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aist310_bcl4:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
 
   
 
   
   #add-point:lock_b段other name="lock_b.other"
   #鎖定整組table
   #LET ls_group = "'5',"
   #僅鎖定自身table
   LET ls_group = "isat_1_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN aist310_bcl5 USING g_enterprise,
                                             g_isaf_m.isafcomp,g_isaf_m.isafdocno,g_isag4_d[g_detail_idx].isatseq, 
                                                 g_isag4_d[g_detail_idx].isat003,g_isag4_d[g_detail_idx].isat004 

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aist310_bcl5" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
   
   #鎖定整組table
   #LET ls_group = "'6',"
   #僅鎖定自身table
   LET ls_group = "isah_1_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN aist310_bcl6 USING g_enterprise,
                                             g_isaf_m.isafcomp,g_isaf_m.isafdocno,g_isag2_d[g_detail_idx].isahseq 

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aist310_bcl6" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
   #end add-point  
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.unlock_b" >}
#+ 連動unlock其他單身table資料
PRIVATE FUNCTION aist310_unlock_b(ps_table,ps_page)
   #add-point:unlock_b段define(客製用) name="unlock_b.define_customerization"
   
   #end add-point  
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:unlock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="unlock_b.define"
   
   #end add-point  
   
   #add-point:Function前置處理  name="unlock_b.pre_function"
   
   #end add-point
    
   LET ls_group = "'1',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE aist310_bcl
   END IF
   
   LET ls_group = "'2',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE aist310_bcl2
   END IF
 
   LET ls_group = "'3',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE aist310_bcl3
   END IF
 
   LET ls_group = "'4',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE aist310_bcl4
   END IF
 
 
   
 
 
   #add-point:unlock_b段other name="unlock_b.other"
   LET ls_group = "'5',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE aist310_bcl5
   END IF
   
   LET ls_group = "'6',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE aist310_bcl6
   END IF
   #end add-point  
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.set_entry" >}
#+ 單頭欄位開啟設定
PRIVATE FUNCTION aist310_set_entry(p_cmd)
   #add-point:set_entry段define(客製用) name="set_entry.define_customerization"
   
   #end add-point       
   DEFINE p_cmd   LIKE type_t.chr1  
   #add-point:set_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry.define"
   
   #end add-point       
   
   #add-point:Function前置處理  name="set_entry.pre_function"
   
   #end add-point
   
   CALL cl_set_comp_entry("isafdocno",TRUE)
   
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("isafcomp,isafdocno",TRUE)
      CALL cl_set_comp_entry("isafdocdt",TRUE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,TRUE)
      END IF
      #add-point:set_entry段欄位控制 name="set_entry.field_control"
      CALL cl_set_comp_entry("isafdocdt",TRUE)  #151130-00015#2
      CALL cl_set_comp_entry("isafsite,isaf001,isaf056",TRUE)   #151229-00001#2
      CALL cl_set_comp_entry("isaf003",TRUE)   #Reanna add 160108
      #end add-point  
   END IF
   
   #add-point:set_entry段欄位控制後 name="set_entry.after_control"
   CALL cl_set_comp_entry("isaf051,isaf052",TRUE) #161020-00021#1 add
   IF g_isaf_m.isaf050 = '0' THEN 
      CALL cl_set_comp_entry("isaf004,isaf005,isaf006,isafdocdt,isaf001,isaf002,isaf003",TRUE)
      CALL cl_set_comp_entry("isaf008,isaf014,isaf016,isaf100,isaf101,isaf027,isaf028",TRUE)
      CALL cl_set_comp_entry("isaf029,isaf030,isaf031,isaf032,isaf106,isaf116,isaf201",TRUE)
      CALL cl_set_comp_entry("isaf202,isaf207,isaf037,isaf038,isaf042",TRUE)
   END IF
   IF g_isaf_m.isaf001 <> '2' THEN
      CALL cl_set_comp_entry("isaf055",TRUE)
   END IF 
   CALL cl_set_comp_entry("isaf055",TRUE)
   CALL cl_set_comp_entry('isaf061,isaf062,isaf063,isaf064',TRUE)
   CALL cl_set_comp_entry("isaf016",TRUE)   #160517-00001#1 Add
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.set_no_entry" >}
#+ 單頭欄位關閉設定
PRIVATE FUNCTION aist310_set_no_entry(p_cmd)
   #add-point:set_no_entry段define(客製用) name="set_no_entry.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry.define"
   DEFINE l_dfin0033  LIKE type_t.chr1   #151130-00015#2
   DEFINE l_success   LIKE type_t.chr1   #151130-00015#2
   DEFINE l_slip      LIKE type_t.chr80  #151130-00015#2 
   DEFINE l_glaald    LIKE glaa_t.glaald #151130-00015#2
   DEFINE  l_cnt      LIKE type_t.num10  #160825-00040#1
   DEFINE  l_cnt_isat LIKE type_t.num10  #161020-00021#1 add
   #end add-point     
   
   #add-point:Function前置處理  name="set_no_entry.pre_function"
   CALL cl_set_comp_entry("isaf037,isaf038,isaf042",FALSE)   #160304-00023#1 add
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("isafcomp,isafdocno",FALSE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
      #add-point:set_no_entry段欄位控制 name="set_no_entry.field_control"
      CALL cl_set_comp_entry("isaf004",FALSE)
      #CALL cl_set_comp_entry("isafsite,isaf001,isaf056",FALSE)   #151229-00001#2 #160825-00040#1 mark
      #CALL cl_set_comp_entry("isaf003",FALSE)  #Reanna add 160108 #160825-00040#1 mark
      #160825-00040#1-s
      CALL cl_set_comp_entry("isafsite,isaf056",FALSE)
      #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
      SELECT COUNT(1) INTO l_cnt  #160907-00046#1
        FROM isag_t
       WHERE isagent = g_enterprise
         AND isagcomp = g_isaf_m.isafcomp
         AND isagdocno = g_isaf_m.isafdocno
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt > 0 THEN
         CALL cl_set_comp_entry("isaf001,isaf003",FALSE)
      END IF
      #160825-00040#1-e
      #end add-point 
   END IF 
   
   IF p_cmd = 'u' THEN  #docno,ld欄位確認是絕對關閉
      CALL cl_set_comp_entry("isafdocno",FALSE)
   END IF 
 
#  IF p_cmd = 'u' THEN  #docdt欄位依照設定關閉(FALSE則為設定不同意修正) #(ver:78)
      IF NOT cl_chk_update_docdt() THEN
         CALL cl_set_comp_entry("isafdocdt",FALSE)
      END IF
#  END IF 
   
   #add-point:set_no_entry段欄位控制後 name="set_no_entry.after_control"
   #161020-00021#1 --s add
   #當單身已存在發票歷程(isat_t)時,單頭限制不可異動發票類型與發票簿欄位
   IF NOT cl_null(g_isaf_m.isafdocno) AND NOT cl_null(g_isaf_m.isafcomp) THEN
      LET l_cnt_isat = 0
      SELECT COUNT(1) INTO l_cnt_isat
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isatcomp = g_isaf_m.isafcomp
         AND isatdocno = g_isaf_m.isafdocno  
      IF cl_null(l_cnt_isat) THEN LET l_cnt_isat = 0 END IF
      IF l_cnt_isat > 0 THEN
         CALL cl_set_comp_entry("isaf008,isaf051,isaf052",FALSE)
      END IF
   END IF
   #161020-00021#1 --e add
   
   IF g_isaf_m.isaf050 = '1' THEN 
      CALL cl_set_comp_entry("isaf004,isaf005,isaf006,isafdocdt,isaf001,isaf002,isaf003",FALSE)
      CALL cl_set_comp_entry("isaf008,isaf014,isaf016,isaf100,isaf101,isaf027,isaf028",FALSE)
      CALL cl_set_comp_entry("isaf029,isaf030,isaf031,isaf032,isaf106,isaf116,isaf201",FALSE)
      CALL cl_set_comp_entry("isaf202,isaf207,isaf037,isaf038,isaf042",FALSE)
   END IF
   IF g_isaf_m.isaf001 = '2' THEN
      CALL cl_set_comp_entry("isaf055",FALSE)
   END IF 
      
   IF g_isaf_m.isaf060 = '1' THEN #經海關出口
      CALL cl_set_comp_entry('isaf063,isaf064',FALSE)
   END IF
   IF g_isaf_m.isaf060 = '2' THEN #經海關出口
      CALL cl_set_comp_entry('isaf061,isaf062',FALSE)
   END IF
   
   #151130-00015#2  -add -str
   IF NOT cl_null(g_isaf_m.isafdocno) THEN  
      #获取单别
      CALL s_aooi200_fin_get_slip(g_isaf_m.isafdocno) RETURNING l_success,l_slip
      #是否可以更改單據日期
      SELECT glaald  INTO l_glaald
        FROM glaa_t
       WHERE glaaent = enterprise
         AND glaacomp = g_isaf_m.isafcomp
         AND glaa014 = 'Y'
      CALL s_fin_get_doc_para(l_glaald,g_isaf_m.isafcomp,l_slip,'D-FIN-0033') RETURNING l_dfin0033
      IF l_dfin0033 = "Y"  THEN 
         CALL cl_set_comp_entry("isafdocdt",TRUE)
    
      END IF          
   END IF 
   #151130-00015#2  -end -str
   #160517-00001#1 Add  ---(S)---
   LET l_cnt = 0
   #SELECT COUNT(*) INTO l_cnt FROM isag_t WHERE isagent = g_enterprise #160907-00046#1 mark
   SELECT COUNT(1) INTO l_cnt FROM isag_t WHERE isagent = g_enterprise  #160907-00046#1   
      AND isagdocno = g_isaf_m.isafdocno
      AND isag001   = '10'
   IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
   IF l_cnt > 0 THEN
      CALL cl_set_comp_entry("isaf016",FALSE)
   END IF
   #160517-00001#1 Add  ---(E)---
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.set_entry_b" >}
#+ 單身欄位開啟設定
PRIVATE FUNCTION aist310_set_entry_b(p_cmd)
   #add-point:set_entry_b段define(客製用) name="set_entry_b.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry_b.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="set_entry_b.pre_function"
   
   #end add-point
    
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("",TRUE)
      #add-point:set_entry段欄位控制 name="set_entry_b.field_control"
      
      #end add-point  
   END IF
   
   #add-point:set_entry_b段 name="set_entry_b.set_entry_b"
   
   #end add-point  
END FUNCTION
 
{</section>}
 
{<section id="aist310.set_no_entry_b" >}
#+ 單身欄位關閉設定
PRIVATE FUNCTION aist310_set_no_entry_b(p_cmd)
   #add-point:set_no_entry_b段define(客製用) name="set_no_entry_b.define_customerization"
   
   #end add-point    
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry_b.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="set_no_entry_b.pre_function"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("",FALSE)
      #add-point:set_no_entry_b段欄位控制 name="set_no_entry_b.field_control"
      
      #end add-point 
   END IF 
   
   #add-point:set_no_entry_b段 name="set_no_entry_b.set_no_entry_b"
 
   #end add-point     
END FUNCTION
 
{</section>}
 
{<section id="aist310.set_act_visible" >}
#+ 單頭權限開啟
PRIVATE FUNCTION aist310_set_act_visible()
   #add-point:set_act_visible段define(客製用) name="set_act_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible.define"
   
   #end add-point   
   #add-point:set_act_visible段 name="set_act_visible.set_act_visible"
   CALL cl_set_act_visible("open_aist310_02", TRUE)    #151020-00003#2
   CALL cl_set_act_visible("aist310_invpnt,compile,invoice,invoice_update,open_aist310_01,", TRUE) #151029-00001#3
   CALL cl_set_comp_visible('isat027',TRUE) #160215-00013#1
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="aist310.set_act_no_visible" >}
#+ 單頭權限關閉
PRIVATE FUNCTION aist310_set_act_no_visible()
   #add-point:set_act_no_visible段define(客製用) name="set_act_no_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible.define"
   DEFINE l_open_02 LIKE type_t.num10 #151020-00003#2
   #end add-point   
   #add-point:set_act_no_visible段 name="set_act_no_visible.set_act_no_visible"
   IF g_isaf_m.isafstus <> 'N' THEN
      CALL cl_set_act_visible("modify,delete,modify_detail", FALSE)   
   ELSE
      CALL cl_set_act_visible("modify,delete,modify_detail", TRUE)  
   END IF
   
   #151020-00003#2 --s
   IF g_isaf_m.isafstus = 'X' THEN
      CALL cl_set_act_visible("open_aist310_02", FALSE)
      CALL cl_set_act_visible("aist310_invpnt,compile,invoice,invoice_update,open_aist310_01,", FALSE) #151029-00001#3
   END IF
   LET l_open_02 = 0
   #SELECT COUNT(*) INTO l_open_02 FROM isat_t #160907-00046#1 mark
   SELECT COUNT(1) INTO l_open_02 FROM isat_t #160907-00046#1
    WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp AND isatdocno = g_isaf_m.isafdocno 
      AND isat025 NOT IN ('12','22') AND isat014 IN ('11','21') AND isat106 = 0
   IF cl_null(l_open_02) THEN LET l_open_02 = 0 END IF
   IF l_open_02 = 0 THEN
      CALL cl_set_act_visible("open_aist310_02", FALSE)
   END IF
   #151020-00003#2 --e
   #151029-00001#3 add ------
   IF g_isaf_m.isafstus = 'Y' THEN
      CALL cl_set_act_visible("invoice_update,compile", FALSE)
   END IF
   IF g_isaf_m.isafstus = 'N' THEN
      CALL cl_set_act_visible("aist310_invpnt,open_aist310_01", FALSE)
   END IF
   #151029-00001#3 add end---
   #160215-00013#1 ---s---
   IF g_isaf_m.isaf056 = 1 THEN
      CALL cl_set_comp_visible('isat027',FALSE)
   END IF
   #160215-00013#1 ---e---
   #161214-00053#1 add ------
   #台灣地區開立折讓單時，限制不可使用換開與作廢的功能
   IF g_isai002 = '1' AND g_isaf_m.isaf056 = '2' THEN
      CALL cl_set_comp_visible('open_aist310_02',FALSE)
   END IF
   #161214-00053#1 add end---
   #170116-00020#1 add ------
   #未確認時，不產生發票歷程，也不開放發票歷程維護
   IF g_isaf_m.isafstus = 'N' THEN
      CALL cl_set_act_visible("invoice", FALSE)
   END IF
   #170116-00020#1 add ------
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="aist310.set_act_visible_b" >}
#+ 單身權限開啟
PRIVATE FUNCTION aist310_set_act_visible_b()
   #add-point:set_act_visible_b段define(客製用) name="set_act_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible_b.define"
   
   #end add-point   
   #add-point:set_act_visible_b段 name="set_act_visible_b.set_act_visible_b"
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="aist310.set_act_no_visible_b" >}
#+ 單身權限關閉
PRIVATE FUNCTION aist310_set_act_no_visible_b()
   #add-point:set_act_no_visible_b段define(客製用) name="set_act_no_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible_b.define"
   
   #end add-point   
   #add-point:set_act_no_visible_b段 name="set_act_no_visible_b.set_act_no_visible_b"
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="aist310.default_search" >}
#+ 外部參數搜尋
PRIVATE FUNCTION aist310_default_search()
   #add-point:default_search段define(客製用) name="default_search.define_customerization"
   
   #end add-point  
   DEFINE li_idx     LIKE type_t.num10
   DEFINE li_cnt     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE ls_where   STRING
   #add-point:default_search段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="default_search.define"
   
   #end add-point  
   
   #add-point:Function前置處理 name="default_search.before"
   
   #end add-point  
   
   LET g_pagestart = 1
   
   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF
   
   IF NOT cl_null(g_argv[01]) THEN
      LET ls_wc = ls_wc, " isafcomp = '", g_argv[01], "' AND "
   END IF
   
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = ls_wc, " isafdocno = '", g_argv[02], "' AND "
   END IF
 
   
   #add-point:default_search段after sql name="default_search.after_sql"
   #151231-00010#3-----s
   #有外部參數處理
   IF NOT cl_null(ls_wc)THEN
      LET ls_wc = ls_wc, " isaf003 IN (SELECT pmaa001 FROM pmaa_t ",
                                            " WHERE pmaaent = ",g_enterprise," AND ",g_ctl_where,")",
                                            "  AND "
   END IF
   #151231-00010#3-----e
   #end add-point  
   
   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_default = TRUE
   ELSE
      #若無外部參數則預設為1=2
      LET g_default = FALSE
      
      #預設查詢條件
      CALL cl_qbe_get_default_qryplan() RETURNING ls_where
      IF NOT cl_null(ls_where) THEN
         CALL util.JSON.parse(ls_where, la_wc)
         INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
         INITIALIZE g_wc2_table2 TO NULL
 
         INITIALIZE g_wc2_table3 TO NULL
 
         INITIALIZE g_wc2_table4 TO NULL
 
 
         FOR li_idx = 1 TO la_wc.getLength()
            CASE
               WHEN la_wc[li_idx].tableid = "isaf_t" 
                  LET g_wc = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "isag_t" 
                  LET g_wc2_table1 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "isah_t" 
                  LET g_wc2_table2 = la_wc[li_idx].wc
 
               WHEN la_wc[li_idx].tableid = "xrcd_t" 
                  LET g_wc2_table3 = la_wc[li_idx].wc
 
               WHEN la_wc[li_idx].tableid = "isat_t" 
                  LET g_wc2_table4 = la_wc[li_idx].wc
 
 
               WHEN la_wc[li_idx].tableid = "EXTENDWC"
                  LET g_wc2_extend = la_wc[li_idx].wc
            END CASE
         END FOR
         IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
            OR NOT cl_null(g_wc2_table2)
 
            OR NOT cl_null(g_wc2_table3)
 
            OR NOT cl_null(g_wc2_table4)
 
 
            OR NOT cl_null(g_wc2_extend)
            THEN
            #組合g_wc2
            IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
               LET g_wc2 = g_wc2_table1
            END IF
            IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
            END IF
 
            IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
            END IF
 
            IF g_wc2_table4 <> " 1=1" AND NOT cl_null(g_wc2_table4) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
            END IF
 
 
            IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
            END IF
         
            IF g_wc2.subString(1,5) = " AND " THEN
               LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
            END IF
         END IF
      END IF
    
      IF cl_null(g_wc) AND cl_null(g_wc2) THEN
         LET g_wc = " 1=2"
      END IF
   END IF
   
   #add-point:default_search段結束前 name="default_search.after"
  
   #end add-point  
 
   IF g_wc.getIndexOf(" 1=2", 1) THEN
      LET g_default = TRUE
   END IF
 
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.state_change" >}
   #應用 a09 樣板自動產生(Version:17)
#+ 確認碼變更 
PRIVATE FUNCTION aist310_statechange()
   #add-point:statechange段define(客製用) name="statechange.define_customerization"
   
   #end add-point  
   DEFINE lc_state LIKE type_t.chr5
   #add-point:statechange段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="statechange.define"
   DEFINE l_success    LIKE type_t.num5
   DEFINE l_count LIKE type_t.num5 #160215-00013#1
   #end add-point  
   
   #add-point:Function前置處理 name="statechange.before"
   #CALL aist310_statechange1() #150603-00046#1 mark
   #150603-00046#1 add ------
   CALL cl_err_collect_init()
   CALL aist310_statechange1()
   CALL cl_err_collect_show()
   
   #150603-00046#1 add end--- 
   RETURN
   #end add-point  
   
   ERROR ""     #清空畫面右下側ERROR區塊
 
   IF g_isaf_m.isafcomp IS NULL
      OR g_isaf_m.isafdocno IS NULL
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   CALL s_transaction_begin()
   
   OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
   IF STATUS THEN
      CLOSE aist310_cl
      CALL s_transaction_end('N','0')
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN aist310_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #顯示最新的資料
   EXECUTE aist310_master_referesh USING g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isaf_m.isafsite, 
       g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt,g_isaf_m.isaf056,g_isaf_m.isaf005, 
       g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf016, 
       g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009, 
       g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101, 
       g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024, 
       g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029, 
       g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104, 
       g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114, 
       g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120, 
       g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049, 
       g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf205, 
       g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039,g_isaf_m.isaf040,g_isaf_m.isaf041, 
       g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf050,g_isaf_m.isaf004, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059,g_isaf_m.isaf060,g_isaf_m.isaf061, 
       g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208,g_isaf_m.isaf209, 
       g_isaf_m.isaf210,g_isaf_m.isafownid,g_isaf_m.isafowndp,g_isaf_m.isafcrtid,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmoddt,g_isaf_m.isafcnfid,g_isaf_m.isafcnfdt, 
       g_isaf_m.isafsite_desc,g_isaf_m.isafcomp_desc,g_isaf_m.isaf005_desc,g_isaf_m.isaf057_desc,g_isaf_m.isaf003_desc, 
       g_isaf_m.isaf052_desc,g_isaf_m.isaf002_desc,g_isaf_m.isaf201_desc,g_isaf_m.isaf202_desc,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf037_desc,g_isaf_m.isaf041_desc,g_isaf_m.isaf055_desc,g_isaf_m.isaf006_desc,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf210_desc,g_isaf_m.isafownid_desc,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid_desc, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafmodid_desc,g_isaf_m.isafcnfid_desc
   
 
   #檢查是否允許此動作
   IF NOT aist310_action_chk() THEN
      CLOSE aist310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #將資料顯示到畫面上
   DISPLAY BY NAME g_isaf_m.isafsite,g_isaf_m.isafsite_desc,g_isaf_m.isafdocno,g_isaf_m.isafdocno_desc, 
       g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafcomp_desc,g_isaf_m.isafdocdt,g_isaf_m.isaf056, 
       g_isaf_m.isaf005,g_isaf_m.isaf005_desc,g_isaf_m.isaf057,g_isaf_m.isaf057_desc,g_isaf_m.isaf003, 
       g_isaf_m.isaf003_desc,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf008_desc, 
       g_isaf_m.isaf016,g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf016_desc,g_isaf_m.isaf052,g_isaf_m.isaf052_desc, 
       g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009,g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012, 
       g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101,g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf002_desc, 
       g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023,g_isaf_m.isaf024,g_isaf_m.isaf025,g_isaf_m.isaf026, 
       g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028,g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031, 
       g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103,g_isaf_m.isaf104,g_isaf_m.isaf105,g_isaf_m.isaf106, 
       g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113,g_isaf_m.isaf114,g_isaf_m.isaf115,g_isaf_m.isaf116, 
       g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119,g_isaf_m.isaf120,g_isaf_m.isaf121,g_isaf_m.isaf033, 
       g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048,g_isaf_m.isaf049,g_isaf_m.isaf201,g_isaf_m.isaf201_desc, 
       g_isaf_m.isaf202,g_isaf_m.isaf202_desc,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf207_desc, 
       g_isaf_m.isaf205,g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf037_desc,g_isaf_m.isaf038,g_isaf_m.isaf039, 
       g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf041_desc,g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf055_desc, 
       g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf006_desc,g_isaf_m.isaf050,g_isaf_m.isaf004,g_isaf_m.isaf004_desc, 
       g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf019_desc,g_isaf_m.isaf059,g_isaf_m.isaf060, 
       g_isaf_m.isaf061,g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208, 
       g_isaf_m.isaf209,g_isaf_m.isaf210,g_isaf_m.isaf210_desc,g_isaf_m.isafownid,g_isaf_m.isafownid_desc, 
       g_isaf_m.isafowndp,g_isaf_m.isafowndp_desc,g_isaf_m.isafcrtid,g_isaf_m.isafcrtid_desc,g_isaf_m.isafcrtdp, 
       g_isaf_m.isafcrtdp_desc,g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmodid_desc,g_isaf_m.isafmoddt, 
       g_isaf_m.isafcnfid,g_isaf_m.isafcnfid_desc,g_isaf_m.isafcnfdt,g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s, 
       g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s,g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
 
   CASE g_isaf_m.isafstus
      WHEN "N"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
      WHEN "Y"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
      WHEN "S"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
      WHEN "A"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
      WHEN "D"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
      WHEN "R"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
      WHEN "W"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
      WHEN "X"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
      
   END CASE
 
   #add-point:資料刷新後 name="statechange.after_refresh"
   
   #end add-point
 
   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         HIDE OPTION "approved"
         HIDE OPTION "rejection"
         CASE g_isaf_m.isafstus
            
            WHEN "N"
               HIDE OPTION "unconfirmed"
            WHEN "Y"
               HIDE OPTION "confirmed"
            WHEN "S"
               HIDE OPTION "posted"
            WHEN "A"
               HIDE OPTION "approved"
            WHEN "D"
               HIDE OPTION "withdraw"
            WHEN "R"
               HIDE OPTION "rejection"
            WHEN "W"
               HIDE OPTION "signing"
            WHEN "X"
               HIDE OPTION "invalid"
         END CASE
     
      #add-point:menu前 name="statechange.before_menu"
 
      #end add-point
      
      #應用 a36 樣板自動產生(Version:5)
      #提交
      ON ACTION signing
         IF cl_auth_chk_act("signing") THEN
            IF NOT aist310_send() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE aist310_cl
            RETURN
         END IF
    
      #抽單
      ON ACTION withdraw
         IF cl_auth_chk_act("withdraw") THEN
            IF NOT aist310_draw_out() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE aist310_cl
            RETURN
         END IF
 
 
 
	  
      ON ACTION unconfirmed
         IF cl_auth_chk_act("unconfirmed") THEN
            LET lc_state = "N"
            #add-point:action控制 name="statechange.unconfirmed"
            
            #end add-point
         END IF
         EXIT MENU
      ON ACTION confirmed
         IF cl_auth_chk_act("confirmed") THEN
            LET lc_state = "Y"
            #add-point:action控制 name="statechange.confirmed"
            IF g_isaf_m.isafstus = 'X' THEN 
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'anm-00044'
               LET g_errparam.extend = g_isaf_m.isafdocno
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CALL s_transaction_end('N','0')   #160812-00017#4 20160819 add by beckxie
               RETURN
            END IF 
            
            IF g_isaf_m.isafstus = 'V' THEN 
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'anm-00054'
               LET g_errparam.extend = g_isaf_m.isafdocno
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CALL s_transaction_end('N','0')   #160812-00017#4 20160819 add by beckxie
               RETURN
            END IF 
            
            IF g_isaf_m.isafstus = 'S' THEN 
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'ais-00090'
               LET g_errparam.extend = g_isaf_m.isafdocno
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CALL s_transaction_end('N','0')   #160812-00017#4 20160819 add by beckxie
               RETURN
            END IF
            
            #end add-point
         END IF
         EXIT MENU
      ON ACTION posted
         IF cl_auth_chk_act("posted") THEN
            LET lc_state = "S"
            #add-point:action控制 name="statechange.posted"
         IF g_isaf_m.isafstus <> 'V' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00092'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            CALL s_transaction_end('N','0')   #160812-00017#4 20160819 add by beckxie
            RETURN
         END IF 
            #end add-point
         END IF
         EXIT MENU
      ON ACTION approved
         IF cl_auth_chk_act("approved") THEN
            LET lc_state = "A"
            #add-point:action控制 name="statechange.approved"
            
            #end add-point
         END IF
         EXIT MENU
      #ON ACTION withdraw
      #   IF cl_auth_chk_act("withdraw") THEN
      #      LET lc_state = "D"
      #      #add-point:action控制 name="statechange.withdraw"
      #      
      #      #end add-point
      #   END IF
      #   EXIT MENU
      ON ACTION rejection
         IF cl_auth_chk_act("rejection") THEN
            LET lc_state = "R"
            #add-point:action控制 name="statechange.rejection"
            
            #end add-point
         END IF
         EXIT MENU
      #ON ACTION signing
      #   IF cl_auth_chk_act("signing") THEN
      #      LET lc_state = "W"
      #      #add-point:action控制 name="statechange.signing"
      #      
      #      #end add-point
      #   END IF
      #   EXIT MENU
      ON ACTION invalid
         IF cl_auth_chk_act("invalid") THEN
            LET lc_state = "X"
            #add-point:action控制 name="statechange.invalid"
            IF g_isaf_m.isafstus = 'Y' THEN 
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'anm-00045'
               LET g_errparam.extend = g_isaf_m.isafdocno
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CALL s_transaction_end('N','0')   #160812-00017#4 20160819 add by beckxie
               RETURN
            END IF 
            IF g_isaf_m.isafstus = 'V' THEN 
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'anm-00055'
               LET g_errparam.extend = g_isaf_m.isafdocno
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CALL s_transaction_end('N','0')   #160812-00017#4 20160819 add by beckxie
               RETURN
            END IF
            IF g_isaf_m.isafstus = 'S' THEN 
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'ais-00091'
               LET g_errparam.extend = g_isaf_m.isafdocno
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CALL s_transaction_end('N','0')   #160812-00017#4 20160819 add by beckxie
               RETURN
            END IF
            #end add-point
         END IF
         EXIT MENU
 
      #add-point:stus控制 name="statechange.more_control"
         
      ON ACTION unposted
         LET lc_state = "Y"
         
         IF g_isaf_m.isafstus <> 'S' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00093'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            CALL s_transaction_end('N','0')   #160812-00017#4 20160819 add by beckxie
            RETURN
         END IF
      #end add-point
      
   END MENU
   
   #確認被選取的狀態碼在清單中
   IF (lc_state <> "N" 
      AND lc_state <> "Y"
      AND lc_state <> "S"
      AND lc_state <> "A"
      AND lc_state <> "D"
      AND lc_state <> "R"
      AND lc_state <> "W"
      AND lc_state <> "X"
      ) OR 
      g_isaf_m.isafstus = lc_state OR cl_null(lc_state) THEN
      CLOSE aist310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #add-point:stus修改前 name="statechange.b_update"
 
   #end add-point
   
   LET g_isaf_m.isafmodid = g_user
   LET g_isaf_m.isafmoddt = cl_get_current()
   LET g_isaf_m.isafstus = lc_state
   
   #異動狀態碼欄位/修改人/修改日期
   UPDATE isaf_t 
      SET (isafstus,isafmodid,isafmoddt) 
        = (g_isaf_m.isafstus,g_isaf_m.isafmodid,g_isaf_m.isafmoddt)     
    WHERE isafent = g_enterprise AND isafcomp = g_isaf_m.isafcomp
      AND isafdocno = g_isaf_m.isafdocno
    
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         
      END CASE
    
      #撈取異動後的資料
      EXECUTE aist310_master_referesh USING g_isaf_m.isafcomp,g_isaf_m.isafdocno INTO g_isaf_m.isafsite, 
          g_isaf_m.isafdocno,g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafdocdt,g_isaf_m.isaf056, 
          g_isaf_m.isaf005,g_isaf_m.isaf057,g_isaf_m.isaf003,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008, 
          g_isaf_m.isaf016,g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf052,g_isaf_m.isaf018,g_isaf_m.isaf051, 
          g_isaf_m.isaf009,g_isaf_m.isaf017,g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011, 
          g_isaf_m.isaf101,g_isaf_m.isaf054,g_isaf_m.isaf002,g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023, 
          g_isaf_m.isaf024,g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028, 
          g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103, 
          g_isaf_m.isaf104,g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113, 
          g_isaf_m.isaf114,g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119, 
          g_isaf_m.isaf120,g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048, 
          g_isaf_m.isaf049,g_isaf_m.isaf201,g_isaf_m.isaf202,g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207, 
          g_isaf_m.isaf205,g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf039,g_isaf_m.isaf040, 
          g_isaf_m.isaf041,g_isaf_m.isaf042,g_isaf_m.isaf055,g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf050, 
          g_isaf_m.isaf004,g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059,g_isaf_m.isaf060, 
          g_isaf_m.isaf061,g_isaf_m.isaf063,g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208, 
          g_isaf_m.isaf209,g_isaf_m.isaf210,g_isaf_m.isafownid,g_isaf_m.isafowndp,g_isaf_m.isafcrtid, 
          g_isaf_m.isafcrtdp,g_isaf_m.isafcrtdt,g_isaf_m.isafmodid,g_isaf_m.isafmoddt,g_isaf_m.isafcnfid, 
          g_isaf_m.isafcnfdt,g_isaf_m.isafsite_desc,g_isaf_m.isafcomp_desc,g_isaf_m.isaf005_desc,g_isaf_m.isaf057_desc, 
          g_isaf_m.isaf003_desc,g_isaf_m.isaf052_desc,g_isaf_m.isaf002_desc,g_isaf_m.isaf201_desc,g_isaf_m.isaf202_desc, 
          g_isaf_m.isaf207_desc,g_isaf_m.isaf037_desc,g_isaf_m.isaf041_desc,g_isaf_m.isaf055_desc,g_isaf_m.isaf006_desc, 
          g_isaf_m.isaf004_desc,g_isaf_m.isaf210_desc,g_isaf_m.isafownid_desc,g_isaf_m.isafowndp_desc, 
          g_isaf_m.isafcrtid_desc,g_isaf_m.isafcrtdp_desc,g_isaf_m.isafmodid_desc,g_isaf_m.isafcnfid_desc 
 
      
      #將資料顯示到畫面上
      DISPLAY BY NAME g_isaf_m.isafsite,g_isaf_m.isafsite_desc,g_isaf_m.isafdocno,g_isaf_m.isafdocno_desc, 
          g_isaf_m.isaf001,g_isaf_m.isafcomp,g_isaf_m.isafcomp_desc,g_isaf_m.isafdocdt,g_isaf_m.isaf056, 
          g_isaf_m.isaf005,g_isaf_m.isaf005_desc,g_isaf_m.isaf057,g_isaf_m.isaf057_desc,g_isaf_m.isaf003, 
          g_isaf_m.isaf003_desc,g_isaf_m.isaf067,g_isaf_m.isafstus,g_isaf_m.isaf008,g_isaf_m.isaf008_desc, 
          g_isaf_m.isaf016,g_isaf_m.isaf014,g_isaf_m.isaf053,g_isaf_m.isaf016_desc,g_isaf_m.isaf052, 
          g_isaf_m.isaf052_desc,g_isaf_m.isaf018,g_isaf_m.isaf051,g_isaf_m.isaf009,g_isaf_m.isaf017, 
          g_isaf_m.isaf010,g_isaf_m.isaf012,g_isaf_m.isaf100,g_isaf_m.isaf011,g_isaf_m.isaf101,g_isaf_m.isaf054, 
          g_isaf_m.isaf002,g_isaf_m.isaf002_desc,g_isaf_m.isaf021,g_isaf_m.isaf022,g_isaf_m.isaf023, 
          g_isaf_m.isaf024,g_isaf_m.isaf025,g_isaf_m.isaf026,g_isaf_m.isaf045,g_isaf_m.isaf027,g_isaf_m.isaf028, 
          g_isaf_m.isaf029,g_isaf_m.isaf030,g_isaf_m.isaf031,g_isaf_m.isaf032,g_isaf_m.isaf046,g_isaf_m.isaf103, 
          g_isaf_m.isaf104,g_isaf_m.isaf105,g_isaf_m.isaf106,g_isaf_m.isaf107,g_isaf_m.isaf108,g_isaf_m.isaf113, 
          g_isaf_m.isaf114,g_isaf_m.isaf115,g_isaf_m.isaf116,g_isaf_m.isaf117,g_isaf_m.isaf118,g_isaf_m.isaf119, 
          g_isaf_m.isaf120,g_isaf_m.isaf121,g_isaf_m.isaf033,g_isaf_m.isaf034,g_isaf_m.isaf035,g_isaf_m.isaf048, 
          g_isaf_m.isaf049,g_isaf_m.isaf201,g_isaf_m.isaf201_desc,g_isaf_m.isaf202,g_isaf_m.isaf202_desc, 
          g_isaf_m.isaf203,g_isaf_m.isaf204,g_isaf_m.isaf207,g_isaf_m.isaf207_desc,g_isaf_m.isaf205, 
          g_isaf_m.isaf206,g_isaf_m.isaf037,g_isaf_m.isaf037_desc,g_isaf_m.isaf038,g_isaf_m.isaf039, 
          g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf041_desc,g_isaf_m.isaf042,g_isaf_m.isaf055, 
          g_isaf_m.isaf055_desc,g_isaf_m.isaf007,g_isaf_m.isaf006,g_isaf_m.isaf006_desc,g_isaf_m.isaf050, 
          g_isaf_m.isaf004,g_isaf_m.isaf004_desc,g_isaf_m.isaf044,g_isaf_m.isaf066,g_isaf_m.isaf019, 
          g_isaf_m.isaf019_desc,g_isaf_m.isaf059,g_isaf_m.isaf060,g_isaf_m.isaf061,g_isaf_m.isaf063, 
          g_isaf_m.isaf062,g_isaf_m.isaf064,g_isaf_m.isaf065,g_isaf_m.isaf208,g_isaf_m.isaf209,g_isaf_m.isaf210, 
          g_isaf_m.isaf210_desc,g_isaf_m.isafownid,g_isaf_m.isafownid_desc,g_isaf_m.isafowndp,g_isaf_m.isafowndp_desc, 
          g_isaf_m.isafcrtid,g_isaf_m.isafcrtid_desc,g_isaf_m.isafcrtdp,g_isaf_m.isafcrtdp_desc,g_isaf_m.isafcrtdt, 
          g_isaf_m.isafmodid,g_isaf_m.isafmodid_desc,g_isaf_m.isafmoddt,g_isaf_m.isafcnfid,g_isaf_m.isafcnfid_desc, 
          g_isaf_m.isafcnfdt,g_isaf_m.l_isaf103_s,g_isaf_m.l_isaf104_s,g_isaf_m.l_isaf105_s,g_isaf_m.l_isaf113_s, 
          g_isaf_m.l_isaf114_s,g_isaf_m.l_isaf115_s
   END IF
 
   #add-point:stus修改後 name="statechange.a_update"
   
   #end add-point
 
   #add-point:statechange段結束前 name="statechange.after"
   CALL aist310_show()
   #end add-point  
 
   CLOSE aist310_cl
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL aist310_msgcentre_notify('statechange:'||lc_state)
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="aist310.idx_chk" >}
#+ 顯示正確的單身資料筆數
PRIVATE FUNCTION aist310_idx_chk()
   #add-point:idx_chk段define(客製用) name="idx_chk.define_customerization"
   
   #end add-point  
   #add-point:idx_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="idx_chk.define"
   
   #end add-point  
   
   #add-point:Function前置處理  name="idx_chk.pre_function"
   
   #end add-point
   
   IF g_current_page = 1 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail1")
      IF g_detail_idx > g_isag_d.getLength() THEN
         LET g_detail_idx = g_isag_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_isag_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_isag_d.getLength() TO FORMONLY.cnt
   END IF
   
   IF g_current_page = 2 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail2")
      IF g_detail_idx > g_isag2_d.getLength() THEN
         LET g_detail_idx = g_isag2_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_isag2_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_isag2_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 3 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail3")
      IF g_detail_idx > g_isag3_d.getLength() THEN
         LET g_detail_idx = g_isag3_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_isag3_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_isag3_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 4 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail4")
      IF g_detail_idx > g_isag4_d.getLength() THEN
         LET g_detail_idx = g_isag4_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_isag4_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_isag4_d.getLength() TO FORMONLY.cnt
   END IF
 
   
   #add-point:idx_chk段other name="idx_chk.other"
 
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.b_fill2" >}
#+ 單身陣列填充2
PRIVATE FUNCTION aist310_b_fill2(pi_idx)
   #add-point:b_fill2段define(客製用) name="b_fill2.define_customerization"
   
   #end add-point
   DEFINE pi_idx                 LIKE type_t.num10
   DEFINE li_ac                  LIKE type_t.num10
   DEFINE li_detail_idx_tmp      LIKE type_t.num10
   DEFINE ls_chk                 LIKE type_t.chr1
   #add-point:b_fill2段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill2.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="b_fill2.pre_function"
   
   #end add-point
   
   LET li_ac = l_ac 
   
   IF g_detail_idx <= 0 THEN
      RETURN
   END IF
   
   LET li_detail_idx_tmp = g_detail_idx
   
 
      
 
      
   #add-point:單身填充後 name="b_fill2.after_fill"
   
   #end add-point
    
   LET l_ac = li_ac
   
   CALL aist310_detail_show()
   
   LET g_detail_idx = li_detail_idx_tmp
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.fill_chk" >}
#+ 單身填充確認
PRIVATE FUNCTION aist310_fill_chk(ps_idx)
   #add-point:fill_chk段define(客製用) name="fill_chk.define_customerization"
   
   #end add-point
   DEFINE ps_idx        LIKE type_t.chr10
   #add-point:fill_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fill_chk.define"
 
   #end add-point
   
   #add-point:Function前置處理 name="fill_chk.before_chk"
   RETURN FALSE   ##160414-00018#2 效能調校 走自己的b_fill段因為FOREACH變數限制
   #end add-point
   
   #此funtion功能暫時停用(2015/1/12)
   #無論傳入值為何皆回傳true(代表要填充該單身)
 
   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1')  AND 
      (cl_null(g_wc2_table2) OR g_wc2_table2.trim() = '1=1')  AND 
      (cl_null(g_wc2_table3) OR g_wc2_table3.trim() = '1=1')  AND 
      (cl_null(g_wc2_table4) OR g_wc2_table4.trim() = '1=1') THEN
      #add-point:fill_chk段other_chk name="fill_chk.other_chk"
      
      #end add-point
      RETURN TRUE
   END IF
   
   #add-point:fill_chk段after_chk name="fill_chk.after_chk"
   
   #end add-point
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="aist310.status_show" >}
PRIVATE FUNCTION aist310_status_show()
   #add-point:status_show段define(客製用) name="status_show.define_customerization"
   
   #end add-point
   #add-point:status_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="status_show.define"
   
   #end add-point
   
   #add-point:status_show段status_show name="status_show.status_show"
   
   #end add-point
END FUNCTION
 
{</section>}
 
{<section id="aist310.mask_functions" >}
&include "erp/ais/aist310_mask.4gl"
 
{</section>}
 
{<section id="aist310.signature" >}
   #應用 a39 樣板自動產生(Version:10)
#+ BPM提交
PRIVATE FUNCTION aist310_send()
   #add-point:send段define(客製用) name="send.define_customerization"
   
   #end add-point 
   #add-point:send段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="send.define"
   
   #end add-point 
   
   #add-point:Function前置處理  name="send.pre_function"
   
   #end add-point
   
   #依據單據個數，需要指定所有單身條件為" 1=1"  (單身有幾個就要設幾個)
   LET g_wc2_table1 = " 1=1"
   LET g_wc2_table2 = " 1=1"
   LET g_wc2_table3 = " 1=1"
   LET g_wc2_table4 = " 1=1"
 
 
   CALL aist310_show()
   CALL aist310_set_pk_array()
   
   #add-point: 初始化的ADP name="send.before_send"
   
   #end add-point
   
   #公用變數初始化
   CALL cl_bpm_data_init()
                  
   #依照主檔/單身個數產生 CALL cl_bpm_set_master_data() / cl_bpm_set_detail_data() 
   #單頭固定為 CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(xxxx)) 傳入參數: (1)單頭陣列  ; 回傳值: 無
   CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(g_isaf_m))
                              
   #單身固定為 CALL cl_bpm_set_detail_data(s_detailX, util.JSONArray.fromFGL(xxxx)) 傳入參數: (1)單身SR名稱  (2)單身陣列  ; 回傳值: 無
   CALL cl_bpm_set_detail_data("s_detail1", util.JSONArray.fromFGL(g_isag_d))
   CALL cl_bpm_set_detail_data("s_detail2", util.JSONArray.fromFGL(g_isag2_d))
   CALL cl_bpm_set_detail_data("s_detail3", util.JSONArray.fromFGL(g_isag3_d))
   CALL cl_bpm_set_detail_data("s_detail4", util.JSONArray.fromFGL(g_isag4_d))
 
 
   # cl_bpm_cli() 裡有包含以前的aws_condition()=>送簽資料檢核和更新單據狀況碼為'W'
   # cl_bpm_cli() 傳入參數:無  ;  回傳值: 0 開單失敗; 1 開單成功
 
   #add-point: 提交前的ADP name="send.before_cli"
   
   #end add-point
 
   #開單失敗
   IF NOT cl_bpm_cli() THEN 
      RETURN FALSE
   END IF
 
   #add-point: 提交後的ADP name="send.after_send"
   
   #end add-point
 
   #此段落不需要刪除資料,但是否需要refresh圖片樣式???
   #CALL aist310_ui_browser_refresh()
 
   #重新指定此筆單據資料狀態圖片=>送簽中
   LET g_browser[g_current_idx].b_statepic = "stus/16/signing.png"
 
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL aist310_ui_headershow()
   CALL aist310_ui_detailshow()
 
   RETURN TRUE
   
END FUNCTION
 
 
 
#應用 a40 樣板自動產生(Version:9)
#+ BPM抽單
PRIVATE FUNCTION aist310_draw_out()
   #add-point:draw段define name="draw.define_customerization"
   
   #end add-point
   #add-point:draw段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="draw.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="draw.pre_function"
   
   #end add-point
   
   #抽單失敗
   IF NOT cl_bpm_draw_out() THEN 
      RETURN FALSE
   END IF    
          
   #重新指定此筆單據資料狀態圖片=>抽單
   LET g_browser[g_current_idx].b_statepic = "stus/16/draw_out.png"
 
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL aist310_ui_headershow()  
   CALL aist310_ui_detailshow()
 
   #add-point:Function後置處理  name="draw.after_function"
   
   #end add-point
 
   RETURN TRUE
   
END FUNCTION
 
 
 
 
 
{</section>}
 
{<section id="aist310.set_pk_array" >}
   #應用 a51 樣板自動產生(Version:8)
#+ 給予pk_array內容
PRIVATE FUNCTION aist310_set_pk_array()
   #add-point:set_pk_array段define name="set_pk_array.define_customerization"
   
   #end add-point
   #add-point:set_pk_array段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_pk_array.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="set_pk_array.before"
   
   #end add-point  
   
   #若l_ac<=0代表沒有資料
   IF l_ac <= 0 THEN
      RETURN
   END IF
   
   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_isaf_m.isafcomp
   LET g_pk_array[1].column = 'isafcomp'
   LET g_pk_array[2].values = g_isaf_m.isafdocno
   LET g_pk_array[2].column = 'isafdocno'
   
   #add-point:set_pk_array段之後 name="set_pk_array.after"
   
   #end add-point  
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="aist310.other_dialog" readonly="Y" >}
   
 
{</section>}
 
{<section id="aist310.msgcentre_notify" >}
#應用 a66 樣板自動產生(Version:6)
PRIVATE FUNCTION aist310_msgcentre_notify(lc_state)
   #add-point:msgcentre_notify段define name="msgcentre_notify.define_customerization"
   
   #end add-point   
   DEFINE lc_state LIKE type_t.chr80
   #add-point:msgcentre_notify段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="msgcentre_notify.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="msgcentre_notify.pre_function"
   
   #end add-point
   
   INITIALIZE g_msgparam TO NULL
 
   #action-id與狀態填寫
   LET g_msgparam.state = lc_state
 
   #PK資料填寫
   CALL aist310_set_pk_array()
   #單頭資料填寫
   LET g_msgparam.data[1] = util.JSON.stringify(g_isaf_m)
 
   #add-point:msgcentre其他通知 name="msgcentre_notify.process"
   
   #end add-point
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()
 
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="aist310.action_chk" >}
#+ 修改/刪除前行為檢查(是否可允許此動作), 若有其他行為須管控也可透過此段落
PRIVATE FUNCTION aist310_action_chk()
   #add-point:action_chk段define(客製用) name="action_chk.define_customerization"
   
   #end add-point
   #add-point:action_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="action_chk.define"
   
   #end add-point
   
   #add-point:action_chk段action_chk name="action_chk.action_chk"
   
   #end add-point
      
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="aist310.other_function" readonly="Y" >}
# 单头参考栏位带值
PRIVATE FUNCTION aist310_ref_show()
  #DEFINE l_isai002           LIKE isai_t.isai002 #160803-00044#1 mark

  #IF g_action_choice <> 'fetch' THEN             #160414-00018#2 #160708-00012#1 mark
   #IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN #160708-00012#1  #161207-00038#1 mark
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isafsite
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isafsite_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isafsite_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf004
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf004_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf004_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isafcomp
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isafcomp_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isafcomp_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf005
      CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf005_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf005_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf057
      CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf057_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf057_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf006
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf006_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf006_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf055
      CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf055_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf055_desc
   #END IF    #160414-00018#2 #161207-00038#1 mark
      
   SELECT ooef002,ooef004,ooef019 
     INTO g_ooef002,g_ooef004,g_ooef019
     FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = g_isaf_m.isafcomp
      AND ooefstus = 'Y'
      
   #CALL aist310_visible() #161101-00042#1 add 取稅區時做欄位隱顯 #161214-00053#1 mark

   #SELECT isai002,isai004,isai006 INTO g_isai002,g_isai004,g_isai006 #161214-00053#1 mark
   #SELECT isai002,isai003,isai004,isai006 INTO g_isai002,g_isai003,g_isai004,g_isai006 #161214-00053#1 add #161129-00042#1 mark
   SELECT isai002,isai003,isai004,isai006,isai008                #161129-00042#1-add
     INTO g_isai002,g_isai003,g_isai004,g_isai006,g_isai008      #161129-00042#1-add
     FROM isai_t 
    WHERE isaient = g_enterprise
      AND isai001 = g_ooef019
   
   CALL aist310_visible() #取稅區時做欄位隱顯 #161214-00053#1 add
   
   SELECT glaa001,glaald
     INTO g_glaa001,g_glaald
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaacomp = g_isaf_m.isafcomp 
      AND glaa014 = 'Y'

   CALL s_aooi200_fin_get_slip_desc(g_isaf_m.isafdocno)
   RETURNING g_isaf_m.isafdocno_desc
   DISPLAY g_isaf_m.isafdocno_desc TO isafdocno_desc
   
  #IF g_action_choice <> 'fetch' THEN             #160414-00018#2 #160708-00012#1 mark
   #IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN #160708-00012#1 #161207-00038#1 mark
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf002
      CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf002_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf002_desc
      
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf003
      CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf003_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf003_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_ooef019
      LET g_ref_fields[2] = g_isaf_m.isaf008
      CALL ap_ref_array2(g_ref_fields,"SELECT isacl004 FROM isacl_t WHERE isaclent='"||g_enterprise||"' AND isacl001=? AND isacl002 = ? AND isacl003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf008_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf008_desc 
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf052
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf052_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf052_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_ooef019
      LET g_ref_fields[2] = g_isaf_m.isaf019
      CALL ap_ref_array2(g_ref_fields,"SELECT isapl004 FROM isapl_t WHERE isaplent='"||g_enterprise||"' AND isapl001=? AND isapl002=? AND isapl003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf019_desc = '', g_rtn_fields[1] , ''
      DISPLAY g_isaf_m.isaf019_desc TO isaf019_desc 
      
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_ooef019
      LET g_ref_fields[2] = g_isaf_m.isaf016
      CALL ap_ref_array2(g_ref_fields,"SELECT oodbl004 FROM oodbl_t WHERE oodblent='"||g_enterprise||"' AND oodbl001=? AND oodbl002=? AND oodbl003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf016_desc = '', g_rtn_fields[1] , ''
      DISPLAY g_isaf_m.isaf016_desc TO isaf016_desc 
   #END IF   #160414-00018#2 #161207-00038#1 mark
   
   LET g_isaf_m.isaf017 = ''
   LET g_isaf_m.isaf018 = ''
   SELECT oodb004,oodb005,oodb006,oodb008 INTO g_oodb004,g_isaf_m.isaf017,g_isaf_m.isaf018,g_isaf_m.isaf054
     FROM oodb_t
    WHERE oodbent = g_enterprise
      AND oodb001 = g_ooef019
      AND oodb002 = g_isaf_m.isaf016
      
   DISPLAY g_isaf_m.isaf017 TO isaf017
   DISPLAY g_isaf_m.isaf018 TO isaf018
   
  #IF g_action_choice <> 'fetch' THEN             #160414-00018#2 #160708-00012#1 mark
   #IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN #160708-00012#1 #161207-00038#1 mark
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf201
      CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='3801' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf201_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf201_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf202
      CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='3802' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf202_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf202_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf207
      CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='3803' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf207_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf207_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf037
      CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='3804' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf037_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf037_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf041
      CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa003=? ","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf041_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf041_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf210
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf210_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf210_desc
   #END IF   #160414-00018#2  #161207-00038#1 mark
   
   SELECT isaa001 INTO g_isaf_m.isaf210 FROM isaa_t,isao_t  
    WHERE isaaent = g_enterprise
      AND isaa002  = isao001         
      AND isaosite = isaa001
      AND isaosite = g_isaf_m.isaf052 
   DISPLAY g_isaf_m.isaf210 TO isaf210
   #161018-00053#1 --s mark
   ##150512-00024#1  ---s---
   #CALL cl_set_comp_required("isaf065",FALSE)
   #IF g_isaf_m.isaf018 = 0 THEN
   #   CALL cl_set_comp_required("isaf065",TRUE)
   #END IF
   ##150512-00024#1  ---e---
   #161018-00053#1 --e mark
   #161018-00053#1 --s add
   IF cl_null(g_isaf_m.isaf065) THEN
      LET g_isaf_m.isaf065 = g_isaf_m.isaf014
      DISPLAY g_isaf_m.isaf014 TO isaf014
   END IF
   #161018-00053#1 --e add
   
   LET g_isaf_m.isaf037_desc = s_desc_get_acc_desc('3804',g_isaf_m.isaf037)   #作廢理由碼  #160304-00023#1 add
   #161206-00042#2-----s
   IF NOT cl_null(g_isaf_m.isaf067) THEN
      CALL s_axrt300_xrca_ref('xrca057',g_isaf_m.isaf067,'','') RETURNING g_sub_success,g_isaf_m.isaf003_desc
   END IF
   DISPLAY BY NAME g_isaf_m.isaf003_desc
   #161206-00042#2-----e
END FUNCTION
# isafcomp法人帶值
PRIVATE FUNCTION aist310_isafcomp_get()
   DEFINE l_isao001           LIKE isao_t.isao001
   DEFINE l_isao002           LIKE isao_t.isao002
   DEFINE l_isao003           LIKE isao_t.isao003
   DEFINE l_isao004           LIKE isao_t.isao004
   DEFINE l_isao005           LIKE isao_t.isao005
  #DEFINE l_isai002           LIKE isai_t.isai002 #160803-00044#1 mark
   DEFINE l_ooef002           LIKE ooef_t.ooef002

   SELECT ooef002 INTO l_ooef002
     FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = g_isaf_m.isafcomp
   
   SELECT isao001,isao002,isao003,isao004,isao005
     INTO l_isao001,l_isao002,l_isao003,l_isao004,l_isao005
     FROM isao_t
    WHERE isaoent = g_enterprise
      AND isaosite = g_isaf_m.isafcomp
      AND isaostus = 'Y'
      
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_isaf_m.isafcomp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl004 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isaf_m.isaf027 = '', g_rtn_fields[1] , ''
   DISPLAY BY NAME g_isaf_m.isaf027

  #IF g_isai008 = 'TW' THEN #160803-00044#1 mark
   IF g_isai002 = '1' THEN  #160803-00044#1
      LET g_isaf_m.isaf028 = l_ooef002
   ELSE
      LET g_isaf_m.isaf028 = l_isao001
   END IF
   LET g_isaf_m.isaf029 = l_isao002
   LET g_isaf_m.isaf030 = l_isao003
   LET g_isaf_m.isaf031 = l_isao004
   LET g_isaf_m.isaf032 = l_isao005
   LET g_isaf_m.isaf046 = g_ooef002
   DISPLAY g_isaf_m.isaf028 TO isaf028
   DISPLAY g_isaf_m.isaf029 TO isaf029
   DISPLAY g_isaf_m.isaf030 TO isaf030
   DISPLAY g_isaf_m.isaf031 TO isaf031
   DISPLAY g_isaf_m.isaf032 TO isaf032
   DISPLAY g_isaf_m.isaf046 TO isaf046
   
END FUNCTION
# isaf002 發票客戶帶值
PRIVATE FUNCTION aist310_isaf002_get()
   DEFINE l_isak002           LIKE isak_t.isak002
   DEFINE l_isak008           LIKE isak_t.isak008
   DEFINE l_isak009           LIKE isak_t.isak009
   DEFINE l_isak010           LIKE isak_t.isak010
   DEFINE l_isak011           LIKE isak_t.isak011
   DEFINE l_isak012           LIKE isak_t.isak012
   DEFINE l_pmaa003           LIKE pmaa_t.pmaa003
   DEFINE l_isaf100           LIKE isaf_t.isaf100  #add 161018-00050#1
   
   #抓取交易對象稅務資料aisi020
   SELECT isak002,isak008,isak009,isak010,isak011,isak012
     INTO l_isak002,l_isak008,l_isak009,l_isak010,l_isak011,l_isak012
     FROM isak_t
    WHERE isakent = g_enterprise
      AND isak001 = g_isaf_m.isaf002
      AND isak002 = g_ooef019
      AND isakstus = 'Y'
   
   #抓取稅籍編號>>apmm102
   SELECT pmaa003 INTO l_pmaa003
     FROM pmaa_t
    WHERE pmaaent = g_enterprise
      AND pmaa001 = g_isaf_m.isaf002
      AND pmaastus = 'Y'
   
   #慣用交易稅區/慣用交易幣別
  #SELECT pmab084 INTO g_isaf_m.isaf016                           #151029-00001#3 mark
  #SELECT pmab084,pmab083 INTO g_isaf_m.isaf016,g_isaf_m.isaf100  #151029-00001#3
   IF cl_null(g_isaf_m.isaf016) THEN #161018-00053#1 add
   SELECT pmab084,pmab083 INTO g_isaf_m.isaf016,l_isaf100  #151029-00001#3  #mod 161018-00050#1
     FROM pmab_t
    WHERE pmabent = g_enterprise
      AND pmabsite = g_isaf_m.isafcomp
      AND pmab001 = g_isaf_m.isaf002
   END IF #161018-00053#1 add
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooef019
   LET g_ref_fields[2] = g_isaf_m.isaf016
   CALL ap_ref_array2(g_ref_fields,"SELECT oodbl004 FROM oodbl_t WHERE oodblent='"||g_enterprise||"' AND oodbl001=? AND oodbl002=? AND oodbl003='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isaf_m.isaf016_desc = '', g_rtn_fields[1] , ''
   DISPLAY g_isaf_m.isaf016_desc TO isaf016_desc
   
   #add 161018-00050#1 --s
   IF NOT cl_null(l_isaf100) THEN
      LET g_isaf_m.isaf100 = l_isaf100
   END IF
   IF cl_null(g_isaf_m.isaf100) THEN
      #无法获取币种资料！
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = ""
      LET g_errparam.code   = 'apm-01132'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF
   #add 161018-00050#1 --e
   
   #抓取該幣別的匯率
   CALL aist310_isaf100_get() #151029-00001#3
   
  #LET g_isaf_m.isaf021 = g_isaf_m.isaf002_desc                                    #150609-00004#1 mark
   LET g_isaf_m.isaf021 = s_desc_get_trading_partner_full_desc(g_isaf_m.isaf002)   #150609-00004#1
  #IF g_isai008 = 'TW' THEN #160803-00044#1 mark
   IF g_isai002 = '1' THEN  #160803-00044#1
      LET g_isaf_m.isaf022 = l_pmaa003
   ELSE
      LET g_isaf_m.isaf022 = l_isak008
   END IF
   LET g_isaf_m.isaf023 = l_isak009
   LET g_isaf_m.isaf024 = l_isak010
   LET g_isaf_m.isaf025 = l_isak011
   LET g_isaf_m.isaf026 = l_isak012
   LET g_isaf_m.isaf045 = l_pmaa003

   DISPLAY g_isaf_m.isaf021 TO isaf021
   DISPLAY g_isaf_m.isaf022 TO isaf022
   DISPLAY g_isaf_m.isaf023 TO isaf023
   DISPLAY g_isaf_m.isaf024 TO isaf024
   DISPLAY g_isaf_m.isaf025 TO isaf025
   DISPLAY g_isaf_m.isaf026 TO isaf026
   DISPLAY g_isaf_m.isaf008 TO isaf008
   DISPLAY g_isaf_m.isaf016 TO isaf016
   DISPLAY g_isaf_m.isaf045 TO isaf045
   DISPLAY g_isaf_m.isaf100 TO isaf100  #151029-00001#3
   
   IF cl_null(g_isaf_m.isaf003) THEN 
      SELECT pmac002 INTO g_isaf_m.isaf003
        FROM pmac_t
       WHERE pmacent = g_enterprise
         AND pmac001 = g_isaf_m.isaf002
         AND pmac003 = '2'
         AND pmac004 = 'Y'
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isaf_m.isaf003
      CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isaf_m.isaf003_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_isaf_m.isaf003_desc
      DISPLAY g_isaf_m.isaf003 TO isaf003
   END IF
   
   #抓取媒體申報格式
   SELECT isac004 INTO g_isaf_m.isaf019
     FROM isac_t
    WHERE isacent = g_enterprise
      AND isac001 = g_ooef019
      AND isac002 = g_isaf_m.isaf008
   DISPLAY g_isaf_m.isaf019 TO isaf019
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooef019
   LET g_ref_fields[2] = g_isaf_m.isaf019
   CALL ap_ref_array2(g_ref_fields,"SELECT isapl004 FROM isapl_t WHERE isaplent='"||g_enterprise||"' AND isapl001=? AND isapl002=? AND isapl003='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isaf_m.isaf019_desc = '', g_rtn_fields[1] , ''
   DISPLAY g_isaf_m.isaf019_desc TO isaf019_desc 
   
   #含稅否/稅率
   SELECT oodb005,oodb006 INTO g_isaf_m.isaf017,g_isaf_m.isaf018
     FROM oodb_t
    WHERE oodbent = g_enterprise
      AND oodb001 = g_ooef019
      AND oodb002 = g_isaf_m.isaf016
   DISPLAY g_isaf_m.isaf017 TO isaf017
   DISPLAY g_isaf_m.isaf018 TO isaf018
END FUNCTION
# isaf008 發票類型帶值
PRIVATE FUNCTION aist310_isaf008_get()
   SELECT isac004,isac008  INTO g_isaf_m.isaf019,g_isaf_m.isaf053
     FROM isac_t
    WHERE isacent = g_enterprise
      AND isac001 = g_ooef019
      AND isac002 = g_isaf_m.isaf008
   DISPLAY g_isaf_m.isaf019 TO isaf019
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooef019
   LET g_ref_fields[2] = g_isaf_m.isaf019
   CALL ap_ref_array2(g_ref_fields,"SELECT isapl004 FROM isapl_t WHERE isaplent='"||g_enterprise||"' AND isapl001=? AND isapl002=? AND isapl003='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isaf_m.isaf019_desc = '', g_rtn_fields[1] , ''
   DISPLAY g_isaf_m.isaf019_desc TO isaf019_desc 
   
   DISPLAY g_isaf_m.isaf053 TO isaf053
END FUNCTION
# 根據幣別抓取匯率
PRIVATE FUNCTION aist310_isaf100_get()
   DEFINE l_ooab002         LIKE ooab_t.ooab002
   #160111-00020#2-----s
   DEFINE lc_param RECORD
                   apca004   LIKE apca_t.apca004
                   END RECORD
   DEFINE ls_js    STRING
   DEFINE l_dummy121   LIKE type_t.num20_6
   DEFINE l_dummy131   LIKE type_t.num20_6
   #160111-00020#2-----e
   
   
   #160111-00020#2-----s
#   SELECT ooab002 INTO l_ooab002 FROM ooab_t
#    WHERE ooabent = g_enterprise
#      AND ooabsite= g_site
#      AND ooab001 = 'S-BAS-0010'
#                            #匯率參照表;帳套;           日期;       來源幣別
#   CALL s_aooi160_get_exrate('2',g_glaald,g_isaf_m.isaf014,g_isaf_m.isaf100,
#                            #目的幣別;  交易金額;              匯類類型
#                             g_glaa001,0,l_ooab002)
#      RETURNING g_isaf_m.isaf101

   LET lc_param.apca004 = g_isaf_m.isaf003
   LET ls_js = util.JSON.stringify(lc_param)
   CALL s_fin_get_curr_rate(g_isaf_m.isafcomp,g_glaald,g_isaf_m.isaf014,g_isaf_m.isaf100,ls_js)    
        RETURNING g_isaf_m.isaf101,l_dummy121,l_dummy131
   DISPLAY BY NAME g_isaf_m.isaf101

   #160111-00020#2-----e
   DISPLAY g_isaf_m.isaf101 TO isaf101
END FUNCTION
# 發票簿號帶默認值
PRIVATE FUNCTION aist310_isaf051_get()
DEFINE   l_isae007      LIKE isae_t.isae007
DEFINE   l_isae008      LIKE isae_t.isae008
#DEFINE   l_ooef019      LIKE ooef_t.ooef019 #160803-00044#1 mark
#DEFINE   l_isai008      LIKE isai_t.isai008  #160803-00044#1 mark

  #150717--(S)
  #SELECT isae005,isae008,isae012   #150609-00006#1 mark
  ##150609-00006#1--(s)
  #SELECT isae005,CASE g_isai002
  #          WHEN '1' THEN isae007
  #          WHEN '2' THEN isae008
  #       END CASE,isae012
  #  INTO g_isaf_m.isaf009,g_isaf_m.isaf010,g_isaf_m.isaf011
  ##150609-00006#1--(e)       
  #150717--(E)
  SELECT isae005,isae007,isae008,isae012
     INTO g_isaf_m.isaf009,l_isae007,l_isae008,g_isaf_m.isaf011
  #150717--(E)
     FROM isae_t
    WHERE isaeent = g_enterprise
      AND isaecomp = g_isaf_m.isafcomp
      AND isaesite = g_isaf_m.isaf052
      AND isae001 = g_isaf_m.isaf051
      AND isae002 <= g_isaf_m.isaf014
      AND isae003 >= g_isaf_m.isaf014
      AND isae004 = g_isaf_m.isaf008
   
   #161212-00008#1 mark-----s
   ##150717--(S)
   ##IF g_isai002 = '1' THEN   #150911
   #IF g_isai002 = '2' THEN   #150911     
   #   #LET g_isaf_m.isaf011 = l_isae007 ,g_isaf_m.isaf011
   #ELSE
   #   LET g_isaf_m.isaf010 = l_isae008
   #END IF
   ##150717--(E)
   #161212-00008#1 mark-----e
   
   #161212-00008#1-----s
   IF g_isai002 = '1' THEN   
      LET g_isaf_m.isaf011 = l_isae007 ,g_isaf_m.isaf011
   ELSE
      LET g_isaf_m.isaf010 = l_isae008
   END IF   
   #161212-00008#1-----e
   
   #150915-00009#3-----s
   #160803-00044#1 mark ------
   #LET l_ooef019 = NULL
   #SELECT ooef019 INTO l_ooef019 FROM ooef_t
   # WHERE ooefent = g_enterprise
   #   AND ooef001 = g_isaf_m.isafcomp
   #
   #LET l_isai008 = NULL
   #SELECT isai008 INTO l_isai008 FROM isai_t
   # WHERE isaient = g_enterprise
   #   AND isai001 = l_ooef019
   #160803-00044#1 mark end---
   #161212-00008#1 mark-----s 
   ##IF l_isai008 = 'TW' THEN #160803-00044#1 mark
   #IF g_isai002 = '1' THEN  #160803-00044#1
   #   LET g_isaf_m.isaf011 = l_isae007 ,g_isaf_m.isaf011
   #END IF
   ##150915-00009#3-----e
   #161212-00008#1 mark-----e
   
   DISPLAY g_isaf_m.isaf009 TO isaf009
   DISPLAY g_isaf_m.isaf010 TO isaf010
   DISPLAY g_isaf_m.isaf011 TO isaf011
END FUNCTION


# 單身1參考欄位帶值
PRIVATE FUNCTION aist310_ref_b_1()
DEFINE l_inbc002          LIKE inbc_t.inbc002
DEFINE l_inbc003          LIKE inbc_t.inbc003
DEFINE l_xrcbdocno        LIKE xrcb_t.xrcbdocno
DEFINE l_xrcbseq          LIKE xrcb_t.xrcbseq
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_isag_d[l_ac].isagorga
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isag_d[l_ac].isagorga_desc = '', g_rtn_fields[1] , ''
   DISPLAY BY NAME g_isag_d[l_ac].isagorga_desc
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_isag_d[l_ac].isag005
   CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isag_d[l_ac].isag005_desc = '', g_rtn_fields[1] , ''
   DISPLAY g_isag_d[l_ac].isag005_desc TO s_detail1[l_ac].isag005_desc
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_isag_d[l_ac].inag007
   CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isag_d[l_ac].inag007_desc = '', g_rtn_fields[1] , ''
   DISPLAY g_isag_d[l_ac].inag007_desc TO s_detail1[l_ac].inag007_desc
   
   IF NOT cl_null(g_isag_d[l_ac].isag009) AND cl_null(g_isag_d[l_ac].isag010) THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isag_d[l_ac].isag009
      CALL ap_ref_array2(g_ref_fields,"SELECT imaal003 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isag_d[l_ac].isag010 = '', g_rtn_fields[1] , ''
      DISPLAY g_isag_d[l_ac].isag010 TO s_detail1[l_ac].isag010
   END IF
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_isag_d[l_ac].isag009
   CALL ap_ref_array2(g_ref_fields,"SELECT imaal004 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isag_d[l_ac].imaal004 = '', g_rtn_fields[1] , ''
   DISPLAY g_isag_d[l_ac].imaal004 TO s_detail1[l_ac].imaal004
END FUNCTION


# 單身2參考欄位帶值
PRIVATE FUNCTION aist310_ref_b_2()
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_isag2_d[l_ac].isahorga
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isag2_d[l_ac].isahorga_desc = '', g_rtn_fields[1] , ''
   DISPLAY BY NAME g_isag2_d[l_ac].isahorga_desc
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_isag2_d[l_ac].isah005
   CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isag2_d[l_ac].isah005_desc = '', g_rtn_fields[1] , ''
   DISPLAY g_isag2_d[l_ac].isah005_desc TO s_detail2[l_ac].isah005_desc
   
END FUNCTION
# 营运据点名称
PRIVATE FUNCTION aist310_isaesite_desc()
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_isae_m.isaesite
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_isae_m.isaesite_desc = '', g_rtn_fields[1] , ''
   DISPLAY BY NAME g_isae_m.isaesite_desc
END FUNCTION

################################################################################
# Descriptions...: prepare
# Date & Author..: 160415 By albireo
# Modify.........: #160414-00018#2
################################################################################
PRIVATE FUNCTION aist310_isag002_ref_pre()
   DEFINE l_sql   STRING
    
  #計價單位 計價數量 客戶編號  帳款客戶
  LET l_sql = "SELECT xmdc010,xmdc011,xmda004,xmda021 ",
              "  FROM xmda_t,xmdc_t ",
              " WHERE xmdaent = ? ",
              " AND xmdadocno = ? ",
              " AND xmdcseq = ? ",
              " AND xmdaent = xmdcent ",
              " AND xmdadocno = xmdcdocno "
  PREPARE sel_xmdcp1 FROM l_sql
  
  LET l_sql = "SELECT oocal003 FROM oocal_t ",
              "  WHERE oocalent= ",g_enterprise," ",
              "    AND oocal001=? ",
              "    AND oocal002='",g_dlang,"'"
  PREPARE sel_oocalp1 FROM l_sql
  
  #計價單位 計價數量 已開發票數量 訂單客戶 收款客戶 
  LET l_sql = " SELECT xmdl021,xmdl022,xmdl047,xmdk007,xmdk008 ",
              "   FROM xmdk_t,xmdl_t ",
              "  WHERE xmdkent = ? ",
              "    AND xmdkdocno = ? ",
              "    AND xmdlseq = ? ",
              "    AND xmdkent = xmdlent ",
              "    AND xmdkdocno = xmdldocno "
  PREPARE sel_xmdlp1 FROM l_sql
        
  LET l_sql = " SELECT rmdb005,rmdb013 ",
              "   FROM rmda_t,rmdb_t,rmba_t a ",
              "  WHERE rmdaent   = rmdbent ",
              "    AND rmdadocno = rmdbdocno ",
              "    AND rmdbent = rmbaent ",
              "    AND rmdb001 = rmbadocno ",
              "    AND rmba000 = (SELECT MAX (rmba000) ",    #以版次最大為準
              "                     FROM rmba_t ",
              "                    WHERE rmbadocno = a.rmbadocno AND rmbaent = a.rmbaent) ",
              "    AND rmdaent   = ?  ",
              "    AND rmdadocno = ?  ",
              "    AND rmdbseq   = ?  ",
              "    AND rmda007   = ?  ",
              "    AND rmda008   = ?  "
  PREPARE sel_rmdbp1 FROM l_sql
     
	#已存在aist310單身之數量與金額
	
	LET l_sql = " SELECT SUM(isag004) ",
	            "   FROM isaf_t,isag_t ",
	            "  WHERE isagent = ? ",
	            "    AND isag002 = ? ",
	            "    AND isag003 = ? ",
	            "    AND isafent = isagent ",
              "    AND isafdocno = isagdocno ",
              "    AND isafcomp = isafcomp　 ",
              "    AND isafstus <> 'X'       " 
  PREPARE sel_isagp2 FROM l_sql
  
  #160614-00025#1 --s add
  #計價單位 計價數量 客戶編號
  LET l_sql = " SELECT rtib018,rtib017,rtia002 ",
              "   FROM rtia_t,rtib_t ",
              "  WHERE rtiaent = ? ",
              "    AND rtiadocno = ? ",
              "    AND rtibseq = ? ",
              "    AND rtiaent = rtibent ",
              "    AND rtiadocno = rtibdocno ",
              "    AND rtiastus = 'S' "
              
  PREPARE sel_rtibp1 FROM l_sql 
  #160614-00025#1 --e add
END FUNCTION
# 根據來源單號、項次帶值
PRIVATE FUNCTION aist310_isag002_ref(p_xrcbdocno,p_xrcbseq)
   DEFINE p_xrcbdocno        LIKE xrcb_t.xrcbdocno
   DEFINE p_xrcbseq          LIKE xrcb_t.xrcbseq
   DEFINE l_isag004          LIKE isag_t.isag004
   DEFINE l_isag004_2        LIKE isag_t.isag004
   DEFINE l_xmdl003          LIKE xmdl_t.xmdl003
   DEFINE l_xmdl004          LIKE xmdl_t.xmdl004
   DEFINE l_isag101          LIKE isag_t.isag101
   DEFINE l_xrcb030          LIKE xrcb_t.xrcb030
   DEFINE l_isag006          LIKE isag_t.isag006
   DEFINE l_xmdl022          LIKE xmdl_t.xmdl022
   DEFINE l_xmdl047          LIKE xmdl_t.xmdl047
   DEFINE l_isaf003          LIKE isaf_t.isaf003
   DEFINE l_isaf055          LIKE isaf_t.isaf055
   DEFINE l_success          LIKE type_t.num5      #160316-00017#2 add lujh
   
   #訂單
   IF g_isag_d[l_ac].isag001 = '10' THEN   #axmt500

      LET g_isag_d[l_ac].inag007 = ''
      LET g_isag_d[l_ac].inag009 = ''
      LET g_isaf003 = ''
      LET g_isaf055 = ''
      
      #160414-00018#2 modify-----s
#      #計價單位 計價數量 客戶編號  帳款客戶
#      SELECT xmdc010,xmdc011,xmda004,xmda021
#        INTO g_isag_d[l_ac].inag007,g_isag_d[l_ac].inag009,g_isaf003,g_isaf055
#        FROM xmda_t,xmdc_t
#       WHERE xmdaent = g_enterprise
#         AND xmdadocno = g_isag_d[l_ac].isag002
#         AND xmdcseq = g_isag_d[l_ac].isag003
#         AND xmdaent = xmdcent
#         AND xmdadocno = xmdcdocno

      EXECUTE sel_xmdcp1 USING g_enterprise,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003
                          INTO g_isag_d[l_ac].inag007,g_isag_d[l_ac].inag009,g_isaf003,g_isaf055
      #160414-00018#2 modify-----e
         
      #160316-00017#2--add--str--lujh
      IF NOT cl_null(g_isag_d[l_ac].isag002) THEN 
         LET g_isag_d[l_ac].inag007 = ''
         LET g_isag_d[l_ac].inag009 = ''
         CALL s_dep_pay(g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag011,
                        g_isaf_m.isaf016,g_isag_d[l_ac].isagorga,g_isaf_m.isaf101,'') RETURNING l_success
         IF l_success = FALSE THEN 
            RETURN
         END IF
         #计价单位/计价数量改从订金分摊元件里抓
         SELECT xmdc010,xmdc011     #160517-00001#1 Mod qty  --> xmdc011
           INTO g_isag_d[l_ac].inag007,g_isag_d[l_ac].inag009
           FROM s_dep_pay_tmp
          WHERE xmdadocno = g_isag_d[l_ac].isag002
            AND xmdcseq = g_isag_d[l_ac].isag003
            AND xmdb001 = g_isag_d[l_ac].isag011
      END IF
      #160316-00017#2--add--end--lujh
         
      DISPLAY g_isag_d[l_ac].inag007 TO s_detail1[l_ac].inag007
      DISPLAY g_isag_d[l_ac].inag009 TO s_detail1[l_ac].inag009
      
      #160414-00018#2 modify-----s
#      INITIALIZE g_ref_fields TO NULL
#      LET g_ref_fields[1] = g_isag_d[l_ac].inag007
#      CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
#      LET g_isag_d[l_ac].inag007_desc = '', g_rtn_fields[1] , ''
#      DISPLAY g_isag_d[l_ac].inag007_desc TO s_detail1[l_ac].inag007_desc 
      EXECUTE sel_oocalp1 USING g_isag_d[l_ac].inag007 INTO g_isag_d[l_ac].inag007_desc
      DISPLAY g_isag_d[l_ac].inag007_desc TO s_detail1[l_ac].inag007_desc 
      #160414-00018#2 modify-----e
   END IF
   
   #出貨單
   IF g_isag_d[l_ac].isag001 = '11' OR g_isag_d[l_ac].isag001 = '21' THEN   #axmt540/axmt600
      LET l_isag004 = ''
      LET g_isag_d[l_ac].inag007 = ''
      LET g_isag_d[l_ac].inag009 = ''
      LET l_isag101 = ''
      LET l_isag006 = ''
      LET g_isaf003 = ''
      LET g_isaf055 = ''
      
      #160414-00018#2 modify-----s
#             #計價單位 計價數量 已開發票數量 訂單客戶 收款客戶 
#      SELECT xmdl021,xmdl022,xmdl047,xmdk007,xmdk008
#        INTO g_isag_d[l_ac].inag007,l_xmdl022,l_xmdl047,g_isaf003,g_isaf055
#        FROM xmdk_t,xmdl_t
#       WHERE xmdkent = g_enterprise
#         AND xmdkdocno = g_isag_d[l_ac].isag002
#         AND xmdlseq = g_isag_d[l_ac].isag003
#         AND xmdkent = xmdlent
#         AND xmdkdocno = xmdldocno

      EXECUTE sel_xmdlp1 USING g_enterprise,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003
         INTO g_isag_d[l_ac].inag007,l_xmdl022,l_xmdl047,g_isaf003,g_isaf055
      #160414-00018#2 modify-----e
         
      IF cl_null(l_xmdl022) THEN LET l_xmdl022 = 0 END IF
      IF cl_null(l_xmdl047) THEN LET l_xmdl047 = 0 END IF
         
      LET g_isag_d[l_ac].inag009 = l_xmdl022
      LET g_isag_d[l_ac].xmdl047 = l_xmdl047
      

      DISPLAY g_isag_d[l_ac].inag007 TO s_detail1[l_ac].inag007
      DISPLAY g_isag_d[l_ac].inag009 TO s_detail1[l_ac].inag009
      
      #160414-00018#2 modify-----s
#      INITIALIZE g_ref_fields TO NULL
#      LET g_ref_fields[1] = g_isag_d[l_ac].inag007
#      CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
#      LET g_isag_d[l_ac].inag007_desc = '', g_rtn_fields[1] , ''
      EXECUTE sel_oocalp1 USING g_isag_d[l_ac].inag007 INTO g_isag_d[l_ac].inag007_desc  
      #160414-00018#2 modify-----e
      DISPLAY g_isag_d[l_ac].inag007_desc TO s_detail1[l_ac].inag007_desc
   END IF
   #150518-00046#4--s
   #RMA單
   IF g_isag_d[l_ac].isag001 = '12' THEN   #armt400
      LET g_isag_d[l_ac].inag007 = ''
      LET g_isag_d[l_ac].inag009 = ''     
      LET g_isag_d[l_ac].xmdl047 = ''     
      
      #160414-00018#2 modify-----s
#             #單位    計價數量 
#      SELECT rmdb005,rmdb013 INTO g_isag_d[l_ac].inag007,g_isag_d[l_ac].inag009
#        FROM rmda_t,rmdb_t,rmba_t a
#       WHERE rmdaent   = rmdbent
#         AND rmdadocno = rmdbdocno
#         AND rmdbent = rmbaent
#         AND rmdb001 = rmbadocno
#         AND rmba000 = (SELECT MAX (rmba000)     #以版次最大為準
#                          FROM rmba_t
#                         WHERE rmbadocno = a.rmbadocno AND rmbaent = a.rmbaent)      
#         AND rmdaent   = g_enterprise
#         AND rmdadocno = g_isag_d[l_ac].isag002
#         AND rmdbseq   = g_isag_d[l_ac].isag003
#         AND rmda007   = g_isaf_m.isaf003
#         AND rmda008   = g_isaf_m.isaf002         

      EXECUTE sel_rmdbp1 USING g_enterprise,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003,g_isaf_m.isaf003,g_isaf_m.isaf002
                          INTO g_isag_d[l_ac].inag007,g_isag_d[l_ac].inag009
      #160414-00018#2 modify-----e
      IF cl_null(g_isag_d[l_ac].inag009) THEN LET g_isag_d[l_ac].inag009 = 0 END IF
      LET g_isag_d[l_ac].inag007_desc = s_desc_get_unit_desc(g_isag_d[l_ac].inag007)
        
       #160414-00018#2 modify-----s
	    #已存在aist310單身之數量與金額
#　　　 SELECT SUM(isag004) INTO g_isag_d[l_ac].xmdl047
#        FROM isaf_t,isag_t 
#       WHERE isagent = g_enterprise
#         AND isag002 = g_isag_d[l_ac].isag002  
#         AND isag003 = g_isag_d[l_ac].isag003  
#         AND isafent = isagent
#         AND isafdocno = isagdocno
#         AND isafcomp = isafcomp　
#         AND isafstus <> 'X'

      EXECUTE sel_isagp2 USING g_enterprise,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003 INTO g_isag_d[l_ac].xmdl047
      #160414-00018#2 modify-----e
      
      IF cl_null(g_isag_d[l_ac].xmdl047) THEN LET g_isag_d[l_ac].xmdl047 = 0 END IF
      DISPLAY BY NAME g_isag_d[l_ac].xmdl047,g_isag_d[l_ac].inag007,g_isag_d[l_ac].inag009,g_isag_d[l_ac].inag007_desc
   END IF
   #150518-00046#4--e
   
   #160614-00025#1 --s add
   #13:門店銷售單/22:門店銷退單
   IF g_isag_d[l_ac].isag001 = '13' OR g_isag_d[l_ac].isag001 = '22' THEN   
      LET g_isag_d[l_ac].inag007 = ''
      LET g_isag_d[l_ac].inag009 = ''     
      LET g_isag_d[l_ac].xmdl047 = ''   
      LET g_isaf003 = ''

      EXECUTE sel_rtibp1 USING g_enterprise,g_isag_d[l_ac].isag002,g_isag_d[l_ac].isag003,g_isaf_m.isaf003,g_isaf_m.isaf002
                          INTO g_isag_d[l_ac].inag007,g_isag_d[l_ac].inag009,g_isaf003
      IF cl_null(g_isag_d[l_ac].inag009) THEN LET g_isag_d[l_ac].inag009 = 0 END IF
      LET g_isag_d[l_ac].inag007_desc = s_desc_get_unit_desc(g_isag_d[l_ac].inag007)
      LET g_isag_d[l_ac].xmdl047 = 0 #已開發票數量為 0 
      DISPLAY BY NAME g_isag_d[l_ac].xmdl047,g_isag_d[l_ac].inag007,g_isag_d[l_ac].inag009,g_isag_d[l_ac].inag007_desc
   END IF
   #160614-00025#1 --e add
END FUNCTION
#
PRIVATE FUNCTION aist310_isag002_get()
   DEFINE l_xrcbdocno        LIKE xrcb_t.xrcbdocno
   DEFINE l_xrcbseq          LIKE xrcb_t.xrcbseq
   DEFINE l_isag004          LIKE isag_t.isag004
   DEFINE l_isag004_2        LIKE isag_t.isag004
   DEFINE l_xmdl003          LIKE xmdl_t.xmdl003
   DEFINE l_xmdl004          LIKE xmdl_t.xmdl004
   DEFINE l_isag101          LIKE isag_t.isag101
   DEFINE l_xrcb030          LIKE xrcb_t.xrcb030
   DEFINE l_isag006          LIKE isag_t.isag006
   DEFINE r_xrcd123          LIKE xrcd_t.xrcd113
   DEFINE r_xrcd124          LIKE xrcd_t.xrcd114
   DEFINE r_xrcd125          LIKE xrcd_t.xrcd115
   DEFINE r_xrcd133          LIKE xrcd_t.xrcd113
   DEFINE r_xrcd134          LIKE xrcd_t.xrcd114
   DEFINE r_xrcd135          LIKE xrcd_t.xrcd115
   DEFINE l_isag105          LIKE isag_t.isag105
   DEFINE l_isag115          LIKE isag_t.isag115
   DEFINE l_isag105_sum      LIKE isag_t.isag105
   DEFINE l_isag115_sum      LIKE isag_t.isag115
   #150518-00046#4--s
   DEFINE l_rmba008          LIKE rmba_t.rmba008
   DEFINE l_rmdb016          LIKE rmdb_t.rmdb016
   DEFINE l_rmdb017          LIKE rmdb_t.rmdb017
   DEFINE l_rmdb016_u        LIKE rmdb_t.rmdb016    #已立帳未稅
   DEFINE l_rmdb017_u        LIKE rmdb_t.rmdb017    #已立帳含稅
   DEFINE r_xrcd103          LIKE xrcd_t.xrcd113
   DEFINE r_xrcd104          LIKE xrcd_t.xrcd114
   DEFINE r_xrcd105          LIKE xrcd_t.xrcd115   
   #150518-00046#4--e
   #DEFINE l_xrcd             RECORD LIKE xrcd_t.*   #160322-00027#3 add lujh #161104-00024#10 mark
   #161104-00024#10 --s add
   DEFINE l_xrcd RECORD  #交易稅明細檔
          xrcdent LIKE xrcd_t.xrcdent, #企業編號
          xrcdcomp LIKE xrcd_t.xrcdcomp, #法人
          xrcdld LIKE xrcd_t.xrcdld, #帳套
          xrcdsite LIKE xrcd_t.xrcdsite, #營運據點
          xrcddocno LIKE xrcd_t.xrcddocno, #交易單據編號
          xrcdseq LIKE xrcd_t.xrcdseq, #項次
          xrcdseq2 LIKE xrcd_t.xrcdseq2, #項次2
          xrcdorga LIKE xrcd_t.xrcdorga, #帳務來源SITE
          xrcd001 LIKE xrcd_t.xrcd001, #來源作業別
          xrcd002 LIKE xrcd_t.xrcd002, #稅別
          xrcd003 LIKE xrcd_t.xrcd003, #稅率
          xrcd004 LIKE xrcd_t.xrcd004, #固定課稅金額
          xrcd005 LIKE xrcd_t.xrcd005, #課稅數量
          xrcd006 LIKE xrcd_t.xrcd006, #含稅否
          xrcd007 LIKE xrcd_t.xrcd007, #計算序
          xrcd008 LIKE xrcd_t.xrcd008, #no use
          xrcd009 LIKE xrcd_t.xrcd009, #稅額會計科目
          xrcd010 LIKE xrcd_t.xrcd010, #no use
          xrcd100 LIKE xrcd_t.xrcd100, #幣別
          xrcd101 LIKE xrcd_t.xrcd101, #匯率
          xrcd102 LIKE xrcd_t.xrcd102, #原幣計算基準
          xrcd103 LIKE xrcd_t.xrcd103, #原幣未稅金額
          xrcd104 LIKE xrcd_t.xrcd104, #原幣稅額
          xrcd105 LIKE xrcd_t.xrcd105, #原幣含稅金額
          xrcd106 LIKE xrcd_t.xrcd106, #原幣留抵稅額
          xrcd112 LIKE xrcd_t.xrcd112, #本幣計算基準
          xrcd113 LIKE xrcd_t.xrcd113, #本幣未稅金額
          xrcd114 LIKE xrcd_t.xrcd114, #本幣稅額
          xrcd115 LIKE xrcd_t.xrcd115, #本幣含稅金額
          xrcd116 LIKE xrcd_t.xrcd116, #本幣留抵稅額
          xrcd117 LIKE xrcd_t.xrcd117, #已開發票原幣未稅金額
          xrcd118 LIKE xrcd_t.xrcd118, #已開發票原幣稅額
          xrcd121 LIKE xrcd_t.xrcd121, #本位幣二匯率
          xrcd124 LIKE xrcd_t.xrcd124, #本位幣二稅額
          xrcd131 LIKE xrcd_t.xrcd131, #本位幣三匯率
          xrcd134 LIKE xrcd_t.xrcd134, #本位幣三稅額
          xrcd123 LIKE xrcd_t.xrcd123, #本位幣二未稅金額
          xrcd125 LIKE xrcd_t.xrcd125, #本位幣二含稅金額
          xrcd133 LIKE xrcd_t.xrcd133, #本位幣三未稅金額
          xrcd135 LIKE xrcd_t.xrcd135, #本位幣三含稅金額
          xrcdud001 LIKE xrcd_t.xrcdud001, #自定義欄位(文字)001
          xrcdud002 LIKE xrcd_t.xrcdud002, #自定義欄位(文字)002
          xrcdud003 LIKE xrcd_t.xrcdud003, #自定義欄位(文字)003
          xrcdud004 LIKE xrcd_t.xrcdud004, #自定義欄位(文字)004
          xrcdud005 LIKE xrcd_t.xrcdud005, #自定義欄位(文字)005
          xrcdud006 LIKE xrcd_t.xrcdud006, #自定義欄位(文字)006
          xrcdud007 LIKE xrcd_t.xrcdud007, #自定義欄位(文字)007
          xrcdud008 LIKE xrcd_t.xrcdud008, #自定義欄位(文字)008
          xrcdud009 LIKE xrcd_t.xrcdud009, #自定義欄位(文字)009
          xrcdud010 LIKE xrcd_t.xrcdud010, #自定義欄位(文字)010
          xrcdud011 LIKE xrcd_t.xrcdud011, #自定義欄位(數字)011
          xrcdud012 LIKE xrcd_t.xrcdud012, #自定義欄位(數字)012
          xrcdud013 LIKE xrcd_t.xrcdud013, #自定義欄位(數字)013
          xrcdud014 LIKE xrcd_t.xrcdud014, #自定義欄位(數字)014
          xrcdud015 LIKE xrcd_t.xrcdud015, #自定義欄位(數字)015
          xrcdud016 LIKE xrcd_t.xrcdud016, #自定義欄位(數字)016
          xrcdud017 LIKE xrcd_t.xrcdud017, #自定義欄位(數字)017
          xrcdud018 LIKE xrcd_t.xrcdud018, #自定義欄位(數字)018
          xrcdud019 LIKE xrcd_t.xrcdud019, #自定義欄位(數字)019
          xrcdud020 LIKE xrcd_t.xrcdud020, #自定義欄位(數字)020
          xrcdud021 LIKE xrcd_t.xrcdud021, #自定義欄位(日期時間)021
          xrcdud022 LIKE xrcd_t.xrcdud022, #自定義欄位(日期時間)022
          xrcdud023 LIKE xrcd_t.xrcdud023, #自定義欄位(日期時間)023
          xrcdud024 LIKE xrcd_t.xrcdud024, #自定義欄位(日期時間)024
          xrcdud025 LIKE xrcd_t.xrcdud025, #自定義欄位(日期時間)025
          xrcdud026 LIKE xrcd_t.xrcdud026, #自定義欄位(日期時間)026
          xrcdud027 LIKE xrcd_t.xrcdud027, #自定義欄位(日期時間)027
          xrcdud028 LIKE xrcd_t.xrcdud028, #自定義欄位(日期時間)028
          xrcdud029 LIKE xrcd_t.xrcdud029, #自定義欄位(日期時間)029
          xrcdud030 LIKE xrcd_t.xrcdud030, #自定義欄位(日期時間)030
          xrcd011 LIKE xrcd_t.xrcd011, #發票編號
          xrcd012 LIKE xrcd_t.xrcd012, #發票號碼
          xrcd013 LIKE xrcd_t.xrcd013  #稅別項次
   END RECORD
   #161104-00024#10 --e add
   DEFINE l_xrca060          LIKE xrca_t.xrca060    #160823-00016#1
   DEFINE l_xrca012          LIKE xrca_t.xrca012    #161005-00018#3
   DEFINE l_xmdl009          LIKE xmdl_t.xmdl009    #170116-00020#1
   
   #訂單
   IF g_isag_d[l_ac].isag001 = '10' THEN     #axmt500
      LET l_isag004 = ''
      LET g_isag_d[l_ac].isag009 = ''
      LET g_isag_d[l_ac].inag007 = ''
      LET g_isag_d[l_ac].inag009 = ''
      LET l_isag101 = ''
      LET l_isag006 = ''
      CALL aist310_isag002_ref(l_xrcbdocno,l_xrcbseq)
             #料號     單價    稅別   收款條件 客戶料號 
      SELECT xmdc001,xmdc015,xmdc016,xmda009,xmdc027
            ,xmdc002    #170116-00020#1
        INTO g_isag_d[l_ac].isag009,l_isag101,l_isag006,g_isag_d[l_ac].isag012,
             g_isag_d[l_ac].isag016
            ,l_xmdl009  #170116-00020#1
        FROM xmda_t,xmdc_t
       WHERE xmdaent = g_enterprise
         AND xmdadocno = g_isag_d[l_ac].isag002
         AND xmdcseq = g_isag_d[l_ac].isag003
         AND xmdaent = xmdcent
         AND xmdadocno = xmdcdocno
           
      SELECT SUM(isag004) INTO l_isag004 
        FROM isag_t,isaf_t 
       WHERE isagent = g_enterprise
         AND isag002 = g_isag_d[l_ac].isag002  
         AND isag003 = g_isag_d[l_ac].isag003  
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp 
         AND isag011 = g_isag_d[l_ac].isag011
         #151124-00007#1--add--str--lujh
         AND isafstus <> 'X'
         AND ((isagdocno = g_isaf_m.isafdocno
         AND   isagseq <> g_isag_d[l_ac].isagseq)
          OR   isagdocno <> g_isaf_m.isafdocno )   
         #151124-00007#1--add--str--lujh
      IF cl_null(l_isag004) THEN LET l_isag004 = 0 END IF
      IF cl_null(g_isag_d[l_ac].inag009) THEN LET g_isag_d[l_ac].inag009 = 0 END IF
	   IF cl_null(g_isag_d[l_ac].isag004) OR g_isag_d[l_ac].isag004 = 0 THEN 
         LET g_isag_d[l_ac].isag004 = g_isag_d[l_ac].inag009 - l_isag004
      END IF
      
      #160322-00027#3--mark--str--lujh
      #IF cl_null(g_isag_d[l_ac].isag006) THEN
      #   LET g_isag_d[l_ac].isag006 = l_isag006
      #   IF g_isag_d[l_ac].isag006 <> g_isaf_m.isaf016 THEN 
      #      INITIALIZE g_errparam TO NULL
      #      LET g_errparam.code = 'ais-00102'
      #      LET g_errparam.extend = g_isag_d[l_ac].isag008
      #      LET g_errparam.popup = FALSE
      #      CALL cl_err()
      #
      #      LET g_isag_d[l_ac].isag006 = g_isaf_m.isaf016
      #   END IF
      #END IF
      #160322-00027#3--mark--end--lujh
      
      #160322-00027#3--add--str--lujh
      LET g_isag_d[l_ac].isag006 = l_isag006              
      IF cl_null(g_isag_d[l_ac].isag006) THEN
         LET g_isag_d[l_ac].isag006 = g_isaf_m.isaf016    
      END IF
      #160322-00027#3--add--end--lujh
      
      IF cl_null(g_isag_d[l_ac].isag101) THEN 
         LET g_isag_d[l_ac].isag101 = l_isag101
      END IF
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isag_d[l_ac].isag009
      CALL ap_ref_array2(g_ref_fields,"SELECT imaal003 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isag_d[l_ac].isag010 = '', g_rtn_fields[1] , ''
      DISPLAY g_isag_d[l_ac].isag010 TO s_detail1[l_ac].isag010 
         
      DISPLAY g_isag_d[l_ac].isag004 TO s_detail1[l_ac].isag004
      DISPLAY g_isag_d[l_ac].isag006 TO s_detail1[l_ac].isag006
      DISPLAY g_isag_d[l_ac].isag101 TO s_detail1[l_ac].isag101
      
      CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
                     g_isag_d[l_ac].isag004*g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag006,
                     g_isag_d[l_ac].isag004,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,0,0)
        RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                  g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
                  r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135
   END IF
   
   #出貨單
   IF g_isag_d[l_ac].isag001 = '11' OR g_isag_d[l_ac].isag001 = '21' THEN    #axmt540/axmt600
      LET l_isag004 = ''
      LET g_isag_d[l_ac].isag009 = ''  
      LET g_isag_d[l_ac].inag007 = ''
      LET g_isag_d[l_ac].inag009 = ''
      LET l_isag101 = ''
      LET l_isag006 = ''
      
      CALL aist310_isag002_ref(l_xrcbdocno,l_xrcbseq)
      
             #料號    單價    稅別    收款條件 客戶料號 發票代碼 發票號碼 未税金额 含税金额
      SELECT xmdl008,xmdl024,xmdl025,xmdk010,xmdl033,xmdl048,xmdl049,xmdl027,xmdl028   #160322-00027#3 add xmdl027,xmdl028 lujh
            ,xmdl009     #170116-00020#1
        INTO g_isag_d[l_ac].isag009,l_isag101,l_isag006,g_isag_d[l_ac].isag012,
             g_isag_d[l_ac].isag016,g_isag_d[l_ac].isag013,g_isag_d[l_ac].isag014,
             g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag105   #160322-00027#3 add lujh
            ,l_xmdl009   #170116-00020#1
        FROM xmdk_t,xmdl_t
       WHERE xmdkent = g_enterprise
         AND xmdkdocno = g_isag_d[l_ac].isag002
         AND xmdlseq = g_isag_d[l_ac].isag003
         AND xmdkent = xmdlent
         AND xmdkdocno = xmdldocno
      
      # 由出貨單串訂單
      SELECT xmdl003,xmdl004 INTO l_xmdl003,l_xmdl004  
        FROM xmdl_t 
       WHERE xmdlent = g_enterprise
         AND xmdldocno = g_isag_d[l_ac].isag002
         AND xmdlseq = g_isag_d[l_ac].isag003
      
      SELECT sum(isag004) INTO l_isag004 
        FROM isag_t,isaf_t 
       WHERE isagent = g_enterprise
         AND isag002 = l_xmdl003  # 訂單號碼 
         AND isag003 = l_xmdl004  #-訂單項次
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp
         AND isafstus <> 'X'      #151124-00007#1 add lujh
         AND isaf001 = '1'        #160623-00019#1
      IF cl_null(l_isag004) THEN LET l_isag004 = 0 END IF
	     
	   # 出貨單 
      SELECT SUM(isag004) INTO l_isag004_2 
        FROM isag_t,isaf_t
       WHERE isagent = g_enterprise
         AND isag002 = g_isag_d[l_ac].isag002
         AND isag003 = g_isag_d[l_ac].isag003
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp
         #151124-00007#1--add--str--lujh
         AND isafstus <> 'X'
         AND ((isagdocno = g_isaf_m.isafdocno
         AND   isagseq <> g_isag_d[l_ac].isagseq)
         OR   isagdocno <> g_isaf_m.isafdocno )
         #151124-00007#1--add--str--lujh
      
      IF cl_null(l_isag004_2) THEN LET l_isag004_2 = 0 END IF
      IF cl_null(g_isag_d[l_ac].inag009) THEN LET g_isag_d[l_ac].inag009 = 0 END IF
	   
      #LET g_isag_d[l_ac].isag004 = g_isag_d[l_ac].inag009 - l_isag004 - l_isag004_2           #160426-00013#2 mark
      LET g_isag_d[l_ac].isag004 = g_isag_d[l_ac].inag009 - l_isag004 - g_isag_d[l_ac].xmdl047 #160426-00013#2
      
      #160322-00027#3--mark--str--lujh
      #IF cl_null(g_isag_d[l_ac].isag006) THEN
      #   LET g_isag_d[l_ac].isag006 = l_isag006 
      #   IF g_isag_d[l_ac].isag006 <> g_isaf_m.isaf016 THEN 
      #      INITIALIZE g_errparam TO NULL
      #      LET g_errparam.code = 'ais-00102'
      #      LET g_errparam.extend = g_isag_d[l_ac].isag008
      #      LET g_errparam.popup = FALSE
      #      CALL cl_err()
      #
      #      LET g_isag_d[l_ac].isag006 = g_isaf_m.isaf016
      #   END IF
      #END IF
      #160322-00027#3--mark--end--lujh
      
      #160322-00027#3--add--str--lujh
      LET g_isag_d[l_ac].isag006 = l_isag006              
      IF cl_null(g_isag_d[l_ac].isag006) THEN
         LET g_isag_d[l_ac].isag006 = g_isaf_m.isaf016    
      END IF
      #160322-00027#3--add--end--lujh
      
      LET g_isag_d[l_ac].isag101 = l_isag101
      
      LET g_isag_d[l_ac].isag005 = g_isag_d[l_ac].inag007
 
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_isag_d[l_ac].isag009
      CALL ap_ref_array2(g_ref_fields,"SELECT imaal003,imaal004 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_isag_d[l_ac].isag010 = '', g_rtn_fields[1] , ''
      LET g_isag_d[l_ac].imaal004 = '', g_rtn_fields[2] , ''
      DISPLAY g_isag_d[l_ac].isag010 TO s_detail1[l_ac].isag010 
      DISPLAY g_isag_d[l_ac].imaal004 TO s_detail1[l_ac].imaal004 
         
      DISPLAY g_isag_d[l_ac].isag004 TO s_detail1[l_ac].isag004
      DISPLAY g_isag_d[l_ac].isag005 TO s_detail1[l_ac].isag005
      DISPLAY g_isag_d[l_ac].isag006 TO s_detail1[l_ac].isag006
      DISPLAY g_isag_d[l_ac].isag101 TO s_detail1[l_ac].isag101
      DISPLAY g_isag_d[l_ac].isag013 TO s_detail1[l_ac].isag013
      DISPLAY g_isag_d[l_ac].isag014 TO s_detail1[l_ac].isag014
      
      #160322-00027#3--add--str--lujh
      LET g_isag_d[l_ac].isag104 = g_isag_d[l_ac].isag105 - g_isag_d[l_ac].isag103
      LET g_isag_d[l_ac].isag113 = g_isag_d[l_ac].isag103 * g_isaf_m.isaf101
      LET g_isag_d[l_ac].isag115 = g_isag_d[l_ac].isag105 * g_isaf_m.isaf101
      LET g_isag_d[l_ac].isag114 = g_isag_d[l_ac].isag104 * g_isaf_m.isaf101
      #161214-00053#1 add ------
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag113,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag113
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag114,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag114
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag115,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag115
      #161214-00053#1 add end---
      
      #SELECT * INTO l_xrcd.*  #161208-00026#19   mark
      #161208-00026#19   add---s
      SELECT xrcdent,xrcdcomp,xrcdld,xrcdsite,xrcddocno,
             xrcdseq,xrcdseq2,xrcdorga,xrcd001,xrcd002,
             xrcd003,xrcd004,xrcd005,xrcd006,xrcd007,
             xrcd008,xrcd009,xrcd010,xrcd100,xrcd101,
             xrcd102,xrcd103,xrcd104,xrcd105,xrcd106,
             xrcd112,xrcd113,xrcd114,xrcd115,xrcd116,
             xrcd117,xrcd118,xrcd121,xrcd124,xrcd131,
             xrcd134,xrcd123,xrcd125,xrcd133,xrcd135,
             xrcdud001,xrcdud002,xrcdud003,xrcdud004,xrcdud005,
             xrcdud006,xrcdud007,xrcdud008,xrcdud009,xrcdud010,
             xrcdud011,xrcdud012,xrcdud013,xrcdud014,xrcdud015,
             xrcdud016,xrcdud017,xrcdud018,xrcdud019,xrcdud020,
             xrcdud021,xrcdud022,xrcdud023,xrcdud024,xrcdud025,
             xrcdud026,xrcdud027,xrcdud028,xrcdud029,xrcdud030,
             xrcd011,xrcd012,xrcd013 
        INTO l_xrcd.*
      #161208-00026#19   add---e
        FROM xrcd_t
       WHERE xrcdent = g_enterprise
         AND xrcddocno = g_isag_d[l_ac].isag002
         AND xrcdseq = g_isag_d[l_ac].isag003
      
      LET l_xrcd.xrcddocno = g_isaf_m.isafdocno
      LET l_xrcd.xrcdseq = g_isag_d[l_ac].isagseq
      LET l_xrcd.xrcd001 = g_prog
      LET l_xrcd.xrcdld = g_glaald  #170208-00018#1
      
     #INSERT INTO xrcd_t VALUES(l_xrcd.*) #161108-00017#6 mark
      #161108-00017#6 --s add
      INSERT INTO xrcd_t(xrcdent,xrcdcomp,xrcdld,xrcdsite,xrcddocno,
                         xrcdseq,xrcdseq2,xrcdorga,xrcd001,xrcd002,
                         xrcd003,xrcd004,xrcd005,xrcd006,xrcd007,
                         xrcd008,xrcd009,xrcd010,xrcd100,xrcd101,
                         xrcd102,xrcd103,xrcd104,xrcd105,xrcd106,
                         xrcd112,xrcd113,xrcd114,xrcd115,xrcd116,
                         xrcd117,xrcd118,xrcd121,xrcd124,xrcd131,
                         xrcd134,xrcd123,xrcd125,xrcd133,xrcd135,
                         xrcdud001,xrcdud002,xrcdud003,xrcdud004,xrcdud005,
                         xrcdud006,xrcdud007,xrcdud008,xrcdud009,xrcdud010,
                         xrcdud011,xrcdud012,xrcdud013,xrcdud014,xrcdud015,
                         xrcdud016,xrcdud017,xrcdud018,xrcdud019,xrcdud020,
                         xrcdud021,xrcdud022,xrcdud023,xrcdud024,xrcdud025,
                         xrcdud026,xrcdud027,xrcdud028,xrcdud029,xrcdud030,
                         xrcd011,xrcd012,xrcd013)
      VALUES(l_xrcd.xrcdent,l_xrcd.xrcdcomp,l_xrcd.xrcdld,l_xrcd.xrcdsite,l_xrcd.xrcddocno,
             l_xrcd.xrcdseq,l_xrcd.xrcdseq2,l_xrcd.xrcdorga,l_xrcd.xrcd001,l_xrcd.xrcd002,
             l_xrcd.xrcd003,l_xrcd.xrcd004,l_xrcd.xrcd005,l_xrcd.xrcd006,l_xrcd.xrcd007,
             l_xrcd.xrcd008,l_xrcd.xrcd009,l_xrcd.xrcd010,l_xrcd.xrcd100,l_xrcd.xrcd101,
             l_xrcd.xrcd102,l_xrcd.xrcd103,l_xrcd.xrcd104,l_xrcd.xrcd105,l_xrcd.xrcd106,
             l_xrcd.xrcd112,l_xrcd.xrcd113,l_xrcd.xrcd114,l_xrcd.xrcd115,l_xrcd.xrcd116,
             l_xrcd.xrcd117,l_xrcd.xrcd118,l_xrcd.xrcd121,l_xrcd.xrcd124,l_xrcd.xrcd131,
             l_xrcd.xrcd134,l_xrcd.xrcd123,l_xrcd.xrcd125,l_xrcd.xrcd133,l_xrcd.xrcd135,
             l_xrcd.xrcdud001,l_xrcd.xrcdud002,l_xrcd.xrcdud003,l_xrcd.xrcdud004,l_xrcd.xrcdud005,
             l_xrcd.xrcdud006,l_xrcd.xrcdud007,l_xrcd.xrcdud008,l_xrcd.xrcdud009,l_xrcd.xrcdud010,
             l_xrcd.xrcdud011,l_xrcd.xrcdud012,l_xrcd.xrcdud013,l_xrcd.xrcdud014,l_xrcd.xrcdud015,
             l_xrcd.xrcdud016,l_xrcd.xrcdud017,l_xrcd.xrcdud018,l_xrcd.xrcdud019,l_xrcd.xrcdud020,
             l_xrcd.xrcdud021,l_xrcd.xrcdud022,l_xrcd.xrcdud023,l_xrcd.xrcdud024,l_xrcd.xrcdud025,
             l_xrcd.xrcdud026,l_xrcd.xrcdud027,l_xrcd.xrcdud028,l_xrcd.xrcdud029,l_xrcd.xrcdud030,
             l_xrcd.xrcd011,l_xrcd.xrcd012,l_xrcd.xrcd013)
      #161108-00017#6 --e add
      #160322-00027#3--add--end--lujh
      #160322-00027#3--mark--str--lujh
      #CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
      #               g_isag_d[l_ac].isag004*g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag006,
      #               g_isag_d[l_ac].isag004,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,0,0)
      #  RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
      #            g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
      #            r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135
      #160322-00027#3--mark--end--lujh
   END IF
   
   #其他待抵單
   IF g_isag_d[l_ac].isag001 = '27' THEN
      LET l_xrca012 = NULL  #161005-00018#3
      
     #SELECT xrcc108 - xrcc109,xrcc118 - xrcc119 + xrcc113         #160823-00016#1 mark
     #INTO l_isag105,l_isag115                                     #160823-00016#1 mark
      SELECT xrcc108 - xrcc109,xrcc118 - xrcc119 + xrcc113,xrca060, #160823-00016#1
             xrca012    #161005-00018#3
        INTO l_isag105,l_isag115,l_xrca060,                         #160823-00016#1
             l_xrca012                                              #161005-00018#3
        FROM xrca_t,xrcc_t
       WHERE xrcaent = g_enterprise
         AND xrcaent = xrccent
         AND xrcadocno = xrccdocno
         AND xrcald = xrccld
         AND xrca001  LIKE '2%'
         AND xrca004 = g_isaf_m.isaf003
         AND xrcald = g_glaald
         AND xrcasite = g_isaf_m.isafsite
         AND xrcc108 - xrcc109 > 0
         AND xrcastus ='Y'
         AND xrcadocdt <= g_isaf_m.isafdocdt
         AND xrcadocno = g_isag_d[l_ac].isag002
         AND xrccseq = g_isag_d[l_ac].isag003
         
      IF cl_null(l_xrca012)THEN LET l_xrca012 = 0 END IF
         
      SELECT SUM(isag105),SUM(isag115) INTO l_isag105_sum,l_isag115_sum
        FROM isag_t,isaf_t
       WHERE isagent = g_enterprise
         AND isag002 = g_isag_d[l_ac].isag002
         AND isag003 = g_isag_d[l_ac].isag003
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp
         AND isafstus = 'N'
         AND ((isafdocno = g_isaf_m.isafdocno
         AND isagseq <> g_isag_d[l_ac].isagseq)
          OR isafdocno <> g_isaf_m.isafdocno)
         
      IF cl_null(l_isag105_sum) THEN LET l_isag105_sum = 0 END IF
      IF cl_null(l_isag115_sum) THEN LET l_isag115_sum = 0 END IF
      
      LET g_isag_d[l_ac].isag105 = l_isag105 - l_isag105_sum
      LET g_isag_d[l_ac].isag115 = l_isag115 - l_isag115_sum
      
      #161005-00018#3-----s
      LET g_isag_d[l_ac].isag103 = g_isag_d[l_ac].isag105 /  (1 + l_xrca012 / 100) 
      CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,g_isag_d[l_ac].isag103,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag103
      LET g_isag_d[l_ac].isag104 = g_isag_d[l_ac].isag105 - g_isag_d[l_ac].isag103
      
      LET g_isag_d[l_ac].isag113 = g_isag_d[l_ac].isag115 /  (1 + l_xrca012 / 100) 
      #CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,g_isag_d[l_ac].isag113,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag113 #161209-00037#1 mark
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag113,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag113         #161209-00037#1 add
      LET g_isag_d[l_ac].isag114 = g_isag_d[l_ac].isag115 - g_isag_d[l_ac].isag113
      #161005-00018#3-----e
      
      DISPLAY g_isag_d[l_ac].isag105 TO s_detail1[l_ac].isag105
      DISPLAY g_isag_d[l_ac].isag115 TO s_detail1[l_ac].isag115
            
      #160823-00016#1-s
      #訂金已開發票
      CASE
         WHEN l_xrca060 = '1'  #1:不開立發票
            LET g_isag_d[l_ac].isag018 = 'N'
         WHEN l_xrca060 = '2'  #2:應開立發票
            LET g_isag_d[l_ac].isag018 = 'Y'
         WHEN l_xrca060 = '3'  #3:普通收據
            LET g_isag_d[l_ac].isag018 = 'N'
      END CASE
      DISPLAY BY NAME g_isag_d[l_ac].isag018
      #160823-00016#1-e
   END IF
   
   #150518-00046#4--s
   #維修單
   IF g_isag_d[l_ac].isag001 = '12' THEN    #armt400
      LET l_isag004 = ''
      LET g_isag_d[l_ac].isag009 = ''
      LET g_isag_d[l_ac].inag007 = ''
      LET g_isag_d[l_ac].inag009 = ''
      
             #料號    單價    稅別    收款條件 單位    計價數量 
      SELECT rmdb003,rmdb015,rmba006,rmba004,rmdb005,rmdb013,
             #含稅否 未稅金額 含稅金額
             rmba008,rmdb016,rmdb017
        INTO g_isag_d[l_ac].isag009,g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag006,
             g_isag_d[l_ac].isag012,g_isag_d[l_ac].isag005,g_isag_d[l_ac].inag009,
             l_rmba008,l_rmdb016,l_rmdb017
        FROM rmda_t,rmdb_t,rmba_t a
       WHERE rmdaent   = rmdbent
         AND rmdadocno = rmdbdocno
         AND rmdbent = rmbaent
         AND rmdb001 = rmbadocno
         AND rmba000 = (SELECT MAX (rmba000)     #以版次最大為準
                          FROM rmba_t
                         WHERE rmbadocno = a.rmbadocno AND rmbaent = a.rmbaent)
         AND rmdaent   = g_enterprise
         AND rmdadocno = g_isag_d[l_ac].isag002
         AND rmdbseq   = g_isag_d[l_ac].isag003
         AND rmda007   = g_isaf_m.isaf003
         AND rmda008   = g_isaf_m.isaf002
      IF cl_null(g_isag_d[l_ac].inag009) THEN LET g_isag_d[l_ac].inag009 = 0 END IF
      
      #已存在aist310單身之數量與金額
      SELECT SUM(isag004),SUM(isag103),SUM(isag105)
        INTO g_isag_d[l_ac].xmdl047,l_rmdb016_u,l_rmdb017_u
        FROM isaf_t,isag_t
       WHERE isagent = g_enterprise
         AND isag002 = g_isag_d[l_ac].isag002
         AND isag003 = g_isag_d[l_ac].isag003
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp
         AND isafstus <> 'X'
         AND ((isagdocno = g_isaf_m.isafdocno
         AND   isagseq <> g_isag_d[l_ac].isagseq)
         OR   isagdocno <> g_isaf_m.isafdocno )
      IF cl_null(g_isag_d[l_ac].xmdl047) THEN LET g_isag_d[l_ac].xmdl047 = 0 END IF
      IF cl_null(l_rmdb016_u) THEN LET l_rmdb016_u = 0 END IF
      IF cl_null(l_rmdb017_u) THEN LET l_rmdb017_u = 0 END IF
      LET g_isag_d[l_ac].isag004 = g_isag_d[l_ac].inag009 - g_isag_d[l_ac].xmdl047

      #一次性立帳(本次數量=計價數量),則原幣金額全部從RMA覆出單身而來
      IF g_isag_d[l_ac].isag004 = g_isag_d[l_ac].inag009 THEN
         LET g_isag_d[l_ac].isag103 = l_rmdb016
         LET g_isag_d[l_ac].isag105 = l_rmdb017
         LET g_isag_d[l_ac].isag104 = g_isag_d[l_ac].isag105 - g_isag_d[l_ac].isag103
         IF l_rmba008 = 'Y' THEN   #含稅
            LET l_isag105 = l_rmdb017
         ELSE
            LET l_isag105 = l_rmdb016
         END IF         
         CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
                        l_isag105,g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag004,g_isaf_m.isaf100,
                        g_isaf_m.isaf101,g_glaald,0,0)
           RETURNING r_xrcd103,r_xrcd104,r_xrcd105,
                     g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
                     r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135          
      ELSE
         IF l_rmba008 = 'Y' THEN   #含稅
            LET l_isag105 = l_rmdb017 - l_rmdb017_u
         ELSE
            LET l_isag105 = l_rmdb016 - l_rmdb016_u
         END IF
         CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
                        l_isag105,g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag004,g_isaf_m.isaf100,
                        g_isaf_m.isaf101,g_glaald,0,0)
           RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                     g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
                     r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135     
      END IF                     
      
      LET g_isag_d[l_ac].isag005_desc = s_desc_get_unit_desc(g_isag_d[l_ac].isag005)
      LET g_isag_d[l_ac].inag007 = g_isag_d[l_ac].isag005
      LET g_isag_d[l_ac].inag007_desc = s_desc_get_unit_desc(g_isag_d[l_ac].inag007)
      CALL s_desc_get_item_desc(g_isag_d[l_ac].isag009) RETURNING g_isag_d[l_ac].isag010,g_isag_d[l_ac].imaal004
      DISPLAY BY NAME g_isag_d[l_ac].isag010,g_isag_d[l_ac].imaal004,g_isag_d[l_ac].isag004,
                      g_isag_d[l_ac].isag005,g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag101,
                      g_isag_d[l_ac].isag013,g_isag_d[l_ac].isag014,g_isag_d[l_ac].inag007,
                      g_isag_d[l_ac].inag009,g_isag_d[l_ac].isag005_desc,g_isag_d[l_ac].xmdl047,
                      g_isag_d[l_ac].inag007_desc
      DISPLAY BY NAME g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                      g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115
      
                  
   END IF   
   #150518-00046#4--e
   
   #160426-00013#2-s
   #訂金走axmt300
   IF g_isag_d[l_ac].isag001 = '29' THEN
     #SELECT xrcc108 - xrcc109,xrcc118 - xrcc119 + xrcc113,xrcc108         #160823-00016#1 mark
     #  INTO l_isag105,l_isag115,g_isag_d[l_ac].isag105                    #160823-00016#1 mark
      SELECT xrcc108 - xrcc109,xrcc118 - xrcc119 + xrcc113,xrcc108,xrca060 #160823-00016#1
        INTO l_isag105,l_isag115,g_isag_d[l_ac].isag105,l_xrca060          #160823-00016#1
        FROM xrca_t,xrcc_t
       WHERE xrcaent = g_enterprise AND xrcaent = xrccent
         AND xrcadocno = xrccdocno AND xrcald = xrccld
         AND xrca001 = '17'
         AND xrca004 = g_isaf_m.isaf003
         AND xrcald = g_glaald
         AND xrcasite = g_isaf_m.isafsite
         AND xrcc108 - xrcc109 > 0
         AND xrcastus ='Y'
         AND xrcadocdt <= g_isaf_m.isafdocdt
         AND xrcadocno = g_isag_d[l_ac].isag002
         AND xrccseq = g_isag_d[l_ac].isag003
         
      SELECT SUM(isag105),SUM(isag115) INTO l_isag105_sum,l_isag115_sum
        FROM isag_t,isaf_t
       WHERE isagent = g_enterprise
         AND isag002 = g_isag_d[l_ac].isag002
         AND isag003 = g_isag_d[l_ac].isag003
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp
         AND isafstus = 'N'
         AND ((isafdocno = g_isaf_m.isafdocno
         AND isagseq <> g_isag_d[l_ac].isagseq)
          OR isafdocno <> g_isaf_m.isafdocno)
         
      IF cl_null(l_isag105_sum) THEN LET l_isag105_sum = 0 END IF
      IF cl_null(l_isag115_sum) THEN LET l_isag115_sum = 0 END IF
      
      LET g_isag_d[l_ac].isag105 = l_isag105 - l_isag105_sum
      LET g_isag_d[l_ac].isag115 = l_isag115 - l_isag115_sum

      DISPLAY BY NAME g_isag_d[l_ac].isag105,g_isag_d[l_ac].isag115
      
      #160823-00016#1-s
      #訂金已開發票
      CASE
         WHEN l_xrca060 = '1'  #1:不開立發票
            LET g_isag_d[l_ac].isag018 = 'N'
         WHEN l_xrca060 = '2'  #2:應開立發票
            LET g_isag_d[l_ac].isag018 = 'Y'
         WHEN l_xrca060 = '3'  #3:普通收據
            LET g_isag_d[l_ac].isag018 = 'N'
      END CASE
      DISPLAY BY NAME g_isag_d[l_ac].isag018
      #160823-00016#1-e
   END IF
   #160426-00013#2-e
   
   #160614-00025#1 --s add
   IF g_isag_d[l_ac].isag001 = '13' OR g_isag_d[l_ac].isag001 = '22' THEN
      LET l_isag004 = ''
      LET g_isag_d[l_ac].isag009 = ''  
      LET g_isag_d[l_ac].inag007 = ''
      LET g_isag_d[l_ac].inag009 = ''
      LET l_isag006 = ''
      
      CALL aist310_isag002_ref(l_xrcbdocno,l_xrcbseq)
      
           #商品編號 交易售價  單價    稅別  收款條件 客戶料號 發票代碼 發票號碼 計價數量
      SELECT rtib004,rtib010,rtib018,rtib006,rtia025,'','',rtia014,rtib017,
             (SELECT imaal003 FROM imaal_t WHERE imaalent = rtibent AND imaal001 = rtib004 AND imaal002 = g_dlang),
             (SELECT imaal004 FROM imaal_t WHERE imaalent = rtibent AND imaal001 = rtib004 AND imaal002 = g_dlang)
        INTO g_isag_d[l_ac].isag009,g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag005,
             g_isag_d[l_ac].isag006,g_isag_d[l_ac].isag012,g_isag_d[l_ac].isag016,
             g_isag_d[l_ac].isag013,g_isag_d[l_ac].isag014,g_isag_d[l_ac].inag009,
             g_isag_d[l_ac].isag010,g_isag_d[l_ac].imaal004
          FROM rtia_t,rtib_t 
         WHERE rtiaent = g_enterprise 
           AND rtiadocno = g_isag_d[l_ac].isag002
           AND rtibseq = g_isag_d[l_ac].isag003 
           AND rtiaent = rtibent 
           AND rtiadocno = rtibdocno
           AND rtiastus = 'S'       

      IF g_isag_d[l_ac].inag009 <0 THEN LET g_isag_d[l_ac].inag009 = g_isag_d[l_ac].inag009 * -1 END IF
      LET g_isag_d[l_ac].isag004 = g_isag_d[l_ac].inag009
                 
      IF cl_null(g_isag_d[l_ac].isag006) THEN
         LET g_isag_d[l_ac].isag006 = g_isaf_m.isaf016    
      END IF
      
      LET g_isag_d[l_ac].isag005_desc = s_desc_get_unit_desc(g_isag_d[l_ac].isag005)
      LET g_isag_d[l_ac].inag007 = g_isag_d[l_ac].isag005
      LET g_isag_d[l_ac].inag007_desc = s_desc_get_unit_desc(g_isag_d[l_ac].inag007)
 
      DISPLAY g_isag_d[l_ac].isag010 TO s_detail1[l_ac].isag010 
      DISPLAY g_isag_d[l_ac].imaal004 TO s_detail1[l_ac].imaal004 

      DISPLAY BY NAME g_isag_d[l_ac].isag004,g_isag_d[l_ac].isag005,g_isag_d[l_ac].isag006,
                      g_isag_d[l_ac].inag007,g_isag_d[l_ac].isag005_desc,g_isag_d[l_ac].inag007_desc,
                      g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag013,g_isag_d[l_ac].isag014,
                      g_isag_d[l_ac].inag009
      
      #從xrcd_t撈出稅額
      #原幣稅前金額/原幣稅額/原幣稅後金額/本幣稅前金額/本幣稅額/本幣稅後金額
      SELECT xrcd103,xrcd104,xrcd105,xrcd113,xrcd114,xrcd115
        INTO g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
             g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115
        FROM xrcd_t
       WHERE xrcdent = g_enterprise AND xrcddocno = g_isag_d[l_ac].isag002 AND xrcdseq = g_isag_d[l_ac].isag003

      LET g_isag_d[l_ac].isag116 = 0
      LET g_isag_d[l_ac].isag117 = 0
      
      LET g_isag_d[l_ac].isag103 = g_isag_d[l_ac].isag103 * g_isag_d[l_ac].isag015
      LET g_isag_d[l_ac].isag104 = g_isag_d[l_ac].isag104 * g_isag_d[l_ac].isag015
      LET g_isag_d[l_ac].isag105 = g_isag_d[l_ac].isag105 * g_isag_d[l_ac].isag015
      LET g_isag_d[l_ac].isag113 = g_isag_d[l_ac].isag113 * g_isag_d[l_ac].isag015
      LET g_isag_d[l_ac].isag114 = g_isag_d[l_ac].isag114 * g_isag_d[l_ac].isag015
      LET g_isag_d[l_ac].isag115 = g_isag_d[l_ac].isag115 * g_isag_d[l_ac].isag015
      
      DISPLAY BY NAME g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
                      g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
                      g_isag_d[l_ac].isag116,g_isag_d[l_ac].isag117

   END IF
   #160614-00025#1 --e add
   
   #170116-00020#1 add ------
   IF NOT cl_null(l_xmdl009)THEN
      SELECT pmao009
        INTO g_isag_d[l_ac].isag017
        FROM pmao_t
       WHERE pmaoent = g_enterprise
         AND pmao001 = g_isaf_m.isaf003
         AND pmao002 = g_isag_d[l_ac].isag009
         AND pmao003 = l_xmdl009
         AND pmao004 = g_isag_d[l_ac].isag013
   END IF
   #170116-00020#1 add end---
   
   #若收款条件没有值或没有来源单据,则抓取客户档的设置
   IF cl_null(g_isag_d[l_ac].isag012) THEN 
      SELECT pmab106 INTO g_isag_d[l_ac].isag012
        FROM pmab_t
       WHERE pmabent = g_enterprise
         AND pmabsite = g_isaf_m.isafcomp
         AND pmab001 = g_isaf_m.isaf002
   END IF
   
#   CALL s_tax_ins(g_isaf_m.isafdocno,g_isag_d[l_ac].isagseq,0,g_isag_d[l_ac].isagorga,
#                  g_isag_d[l_ac].isag004*g_isag_d[l_ac].isag101,g_isag_d[l_ac].isag006,
#                  g_isag_d[l_ac].isag004,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,0,0)
#     RETURNING g_isag_d[l_ac].isag103,g_isag_d[l_ac].isag104,g_isag_d[l_ac].isag105,
#               g_isag_d[l_ac].isag113,g_isag_d[l_ac].isag114,g_isag_d[l_ac].isag115,
#               r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135
END FUNCTION
# 发票薄带值
PRIVATE FUNCTION aist310_isae_get()
   DEFINE l_isae007     LIKE isae_t.isae007
   DEFINE l_isae008     LIKE isae_t.isae008
   DEFINE l_isae012     LIKE isae_t.isae012
   DEFINE l_today       LIKE isaf_t.isaf014
   
   IF cl_null(g_isaf_m.isaf014) THEN 
      LET l_today = g_today
   ELSE
      LET l_today = g_isaf_m.isaf014
   END IF
   
   SELECT isae014,isae007,isae008,isae012
     INTO g_isae_m.isae014,l_isae007,l_isae008,l_isae012
     FROM isae_t           
    WHERE isaeent = g_enterprise
      AND isaesite = g_isae_m.isaesite
      AND isae001  = g_isae_m.isae001
      AND isae002 <= l_today
      AND isae003 >= l_today
      AND isae004 = g_isaf_m.isaf008   #albireo 160721 無單
   
   IF g_isai002 = '1' THEN 
      LET g_isae_m.isae008 = l_isae007
   END IF
   
   IF g_isai002 = '2' THEN 
      LET g_isae_m.isae008 = l_isae008
   END IF
   
   LET g_isae_m.isae012 = l_isae012
END FUNCTION
# 营运据点检查
PRIVATE FUNCTION aist310_isaesite_chk()
   DEFINE l_count     LIKE type_t.num10  # 錯誤數目  
   DEFINE l_site      LIKE isae_t.isaesite  
   DEFINE l_today     LIKE isaf_t.isaf014   

   LET g_errno = ''
   
   IF cl_null(g_isaf_m.isaf014) THEN 
      LET l_today = g_today
   ELSE
      LET l_today = g_isaf_m.isaf014
   END IF
   
   LET l_count = 0
   SELECT count (*) INTO l_count 
     FROM isae_t 
    WHERE isaeent = g_enterprise
      AND isaesite IN (g_isae_m.isaesite,g_isaf_m.isafcomp) 
      AND isae004  = g_isaf_m.isaf008
      AND isae002 <= l_today
      AND isae003 >= l_today
    
   IF l_count = 0 THEN
      LET g_errno ='ais-00144'
   END IF
    
   SELECT isaesite INTO l_site 
     FROM isae_t 
    WHERE isaeent = g_enterprise
      AND isaesite = g_isae_m.isaesite
      AND isae004  = g_isaf_m.isaf008
      AND isae002 <= l_today
      AND isae003 >= l_today

   IF cl_null(l_site) THEN
      LET g_errno ='ais-00144'
   END IF
END FUNCTION
# 控制單身的訂單/出貨/銷退單都是相同發票客戶/收款客戶/帳款客戶
PRIVATE FUNCTION aist310_isag002_chk()
DEFINE l_n           LIKE type_t.num5
DEFINE l_cnt         LIKE type_t.num5
DEFINE l_xmdk000     LIKE xmdk_t.xmdk000
DEFINE l_cal         LIKE xrcc_t.xrcc108   #160909-00081#1
DEFINE l_pmaa004     LIKE pmaa_t.pmaa004   #160802-00007#1 Add
DEFINE l_count       LIKE type_t.num5      #160802-00007#1 Add

   LET g_errno = ''
   
   LET l_n = 0
   #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
   SELECT COUNT(1) INTO l_n  #160907-00046#1
     FROM isag_t
    WHERE isagent = g_enterprise
      AND isagcomp = g_isaf_m.isafcomp
      AND isagdocno = g_isaf_m.isafdocno
      
   SELECT xmdk000 INTO l_xmdk000
     FROM xmdk_t
    WHERE xmdkent = g_enterprise
      AND xmdkdocno = g_isag_d[l_ac].isag002
   
   IF g_isag_d[l_ac].isag001 = '10' THEN  #訂單
      IF l_n > 0 THEN 
         LET l_cnt = 0
         #SELECT COUNT(*) INTO l_cnt  #160907-00046#1 mark
         SELECT COUNT(1) INTO l_cnt   #160907-00046#1
           FROM xmda_t
          WHERE xmdaent = g_enterprise
            AND xmdadocno = g_isag_d[l_ac].isag002
            AND xmda004 = g_isaf_m.isaf003
            AND xmda021 = g_isaf_m.isaf055
         IF l_cnt = 0 THEN 
            LET g_errno = 'ais-00163'
         END IF
      END IF
      #160802-00007#1 Add  ---(S)---
      SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_isaf_m.isaf003
      IF l_pmaa004 = '2' THEN
         LET l_count = 0 
         SELECT COUNT(1) INTO l_count FROM xmda_t WHERE xmdaent = g_enterprise AND xmdadocno = g_isag_d[l_ac].isag002
            AND xmda028 = g_isaf_m.isaf067
         IF cl_null(l_count) THEN LET l_count = 0 END IF
         IF l_count = 0 THEN
            LET g_errno = 'axr-00379'
         END IF
      END IF
      #160802-00007#1 Add  ---(E)---
   END IF
   
   IF g_isag_d[l_ac].isag001 = '11' OR g_isag_d[l_ac].isag001 = '21' THEN  #出貨單/銷退單
      IF l_n > 0 THEN 
         LET l_cnt = 0
         #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
         SELECT COUNT(1) INTO l_cnt  #160907-00046#1
           FROM xmdk_t
          WHERE xmdkent = g_enterprise
            AND xmdkdocno = g_isag_d[l_ac].isag002
            AND xmdk007 = g_isaf_m.isaf003
            AND xmdk008 = g_isaf_m.isaf055
         IF l_cnt = 0 THEN
            LET g_errno = 'ais-00163'
         END IF
         IF g_isag_d[l_ac].isag001 = '11' AND l_xmdk000 = '6' THEN
            LET g_errno = 'ais-00164'
         END IF
         IF g_isag_d[l_ac].isag001 = '21' AND l_xmdk000 <> '6' THEN
            LET g_errno = 'ais-00165'
         END IF
      END IF
      #160802-00007#1 Add  ---(S)---
      SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_isaf_m.isaf003
      IF l_pmaa004 = '2' THEN
         LET l_count = 0 
         SELECT COUNT(1) INTO l_count FROM xmdk_t WHERE xmdkent = g_enterprise AND xmdkdocno = g_isag_d[l_ac].isag002
            AND xmdk047 = g_isaf_m.isaf067
         IF cl_null(l_count) THEN LET l_count = 0 END IF
         IF l_count = 0 THEN
            LET g_errno = 'axr-00379'
         END IF
      END IF
      #160802-00007#1 Add  ---(E)---
   END IF
   
   #IF g_isag_d[l_ac].isag001 = '27' THEN  #其他待抵單  #160426-00013#2 mark
   IF g_isag_d[l_ac].isag001 = '27' OR g_isag_d[l_ac].isag001 = '29' THEN  #其他待抵單/訂金走axrt300 #160426-00013#2
      #IF l_n > 0 THEN  #160909-00081#1 mark
         LET l_cnt = 0
         #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
         SELECT COUNT(1) INTO l_cnt  #160907-00046#1
           FROM xrca_t
          WHERE xrcaent = g_enterprise
            AND xrcadocno = g_isag_d[l_ac].isag002
            AND xrca004 = g_isaf_m.isaf003
            AND xrca005 = g_isaf_m.isaf055
         IF l_cnt = 0 THEN
            LET g_errno = 'ais-00163'
         END IF
         #160909-00081#1-s
         #若訂金預收尚未收款則需控卡不可輸入
         IF g_isag_d[l_ac].isag001 = '27' THEN
            SELECT SUM(xrcc108-xrcc109) INTO l_cal
              FROM xrcc_t
              LEFT JOIN xrca_t ON xrccent=xrcaent AND xrccdocno=xrcadocno
             WHERE xrccent = g_enterprise
               AND xrca019 = g_isag_d[l_ac].isag002
            IF cl_null(l_cal) THEN LET l_cal = 0 END IF
            IF l_cal > 0 THEN
               LET g_errno = 'aap-00369'
            END IF
         END IF
         #160909-00081#1-e
         #160802-00007#1 Add  ---(S)---
         SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_isaf_m.isaf003
         IF l_pmaa004 = '2' THEN
            LET l_count = 0 
            SELECT COUNT(1) INTO l_count FROM xrca_t WHERE xrcaent = g_enterprise AND xrcadocno = g_isag_d[l_ac].isag002
               AND xrca057 = g_isaf_m.isaf067
            IF cl_null(l_count) THEN LET l_count = 0 END IF
            IF l_count = 0 THEN
               LET g_errno = 'axr-00379'
            END IF
         END IF
         #160802-00007#1 Add  ---(E)---
      #END IF #160909-00081#1 mark
   END IF
   
   #150518-00046#4--s
   IF g_isag_d[l_ac].isag001 = '12' THEN  #覆出單
      IF l_n > 0 THEN
         LET l_cnt = 0
         #SELECT COUNT(*) INTO l_cnt  #160907-00046#1 mark
         SELECT COUNT(1) INTO l_cnt   #160907-00046#1
           FROM rmda_t
          WHERE rmdaent = g_enterprise
            AND rmdadocno = g_isag_d[l_ac].isag002
            AND rmda007 = g_isaf_m.isaf003
            AND rmda008 = g_isaf_m.isaf002
         IF l_cnt = 0 THEN
            LET g_errno = 'arm-00009'
         END IF
      END IF
   END IF
   #150518-00046#4--e
   
   #160614-00025#1 --s add
   IF g_isag_d[l_ac].isag001 = '13' OR g_isag_d[l_ac].isag001 = '22' THEN  #13:門店銷售單/22:門店銷退單
      IF l_n > 0 THEN 
         LET l_cnt = 0
         #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
         SELECT COUNT(1) INTO l_cnt  #160907-00046#1
           FROM rtia_t
          WHERE rtiaent = g_enterprise
            AND rtiadocno = g_isag_d[l_ac].isag002
            AND rtia011 = g_isaf_m.isaf003
           #AND rtia012 = g_isaf_m.isaf055  #160614-00025#2
         IF l_cnt = 0 THEN 
            LET g_errno = 'ais-00163'
         END IF
      END IF
   END IF
   #160614-00025#1 --e add
   
END FUNCTION

PRIVATE FUNCTION aist310_isag002_chk2(p_isag002,p_isag003)
   DEFINE p_isag002   LIKE isag_t.isag002
   DEFINE p_isag003   LIKE isag_t.isag003
   DEFINE r_success   LIKE type_t.num5
   DEFINE r_errno     LIKE gzze_t.gzze001
   DEFINE l_xmdk      RECORD
                      xmdkstus   LIKE xmdk_t.xmdkstus,
                      xmdk000    LIKE xmdk_t.xmdk000,
                      xmdk002    LIKE xmdk_t.xmdk002
                      END RECORD
   DEFINE l_pmaa004   LIKE pmaa_t.pmaa004   #160802-00007#1 Add
   DEFINE l_count     LIKE type_t.num5      #160802-00007#1 Add

   LET r_success = TRUE
   LET r_errno   = ''
   
   INITIALIZE l_xmdk.* TO NULL
   SELECT xmdkstus,xmdk000,xmdk002 
     INTO l_xmdk.*
     FROM xmdk_t,xmdl_t
    WHERE xmdkent = g_enterprise
      AND xmdkdocno = p_isag002
      AND xmdlseq   = p_isag003
      AND xmdkent = xmdlent
      AND xmdkdocno = xmdldocno
      AND xmdk008   = g_isaf_m.isaf003
      AND xmdk202 = g_isaf_m.isaf002
      AND xmdkdocdt <= g_isaf_m.isafdocdt
      AND xmdk012   = g_isaf_m.isaf016
      AND xmdk016   = g_isaf_m.isaf100
      
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET r_errno = 'ais-00108'
         LET r_success = FALSE
      #WHEN l_xmdk.xmdk000 MATCHES '[1236]' AND l_xmdk.xmdk002 <> '1' 
#      WHEN l_xmdk.xmdk000 MATCHES '[45]'   AND l_xmdk.xmdk002 <> '3'
#         LET r_errno = ''
#         LET r_success = FALSE
      #160623-00023#1 mark ------
      #WHEN l_xmdk.xmdk000 MATCHES '[1236]' AND l_xmdk.xmdkstus <> 'S'
      #   LET r_errno = 'sub-01311' #160318-00005#22 mod #'ais-00109'
      #   LET r_success = FALSE      
      #WHEN l_xmdk.xmdk000 MATCHES '[4]'   AND l_xmdk.xmdkstus <> 'Y' 
      #   LET r_errno = 'sub-01332'#160318-00005#22 mod #'axm-00399'
      #   LET r_success = FALSE     
      #160623-00023#1 mark end---
      
      #151207-00018#2-----s
      WHEN l_xmdk.xmdk000 MATCHES '[5]'
         LET r_errno = 'ais-00108'
         LET r_success = FALSE         
      #151207-00018#2-----e
      
      #160623-00023#1 mark ------
      ##151223-00001#3--add--str--lujh
      #WHEN l_xmdk.xmdk000 MATCHES '[123]'   AND  l_xmdk.xmdk002 = '3' 
      #   LET r_errno = 'ais-00255'
      #   LET r_success = FALSE  
      ##151223-00001#3--add--end--lujh
      #160623-00023#1 mark end---
      
      #160623-00023#1 add ------
      WHEN l_xmdk.xmdk000 MATCHES '[123]'
         IF l_xmdk.xmdkstus <> 'S' THEN RETURN 'axm-00280' END IF
         IF l_xmdk.xmdk002 <> '1' THEN RETURN 'axr-00359' END IF
      WHEN l_xmdk.xmdk000 = '4'
         IF l_xmdk.xmdkstus <> 'Y' THEN RETURN 'aap-00324' END IF
         IF l_xmdk.xmdk002 <> '3' THEN RETURN 'axr-00360' END IF
      #160623-00023#1 add end---

   END CASE

   #160802-00007#1 Add  ---(S)---
   SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_isaf_m.isaf003
   IF l_pmaa004 = '2' THEN
      LET l_count = 0 
      SELECT COUNT(1) INTO l_count FROM xmda_t WHERE xmdaent = g_enterprise AND xmdadocno = g_isag_d[l_ac].isag002
         AND xmda028 = g_isaf_m.isaf067
      IF cl_null(l_count) THEN LET l_count = 0 END IF
      IF l_count = 0 THEN
      RETURN 'axr-00379'
      END IF
   END IF
   #160802-00007#1 Add  ---(E)---

   RETURN r_success,r_errno
END FUNCTION

################################################################################
# Descriptions...: 12:維修單 檢查合理性
# Memo...........:
# Usage..........: CALL aist310_isag002_chk3(p_isag002,p_isag003)
#                  RETURNING r_success
# Input parameter: p_isag002      來源單號
#                : p_isag003      來源項次
# Return code....: r_success
# Date & Author..: 160304 By 03538(#150518-00046#4)
# Modify.........:
################################################################################
PRIVATE FUNCTION aist310_isag002_chk3(p_isag002,p_isag003)
   DEFINE p_isag002   LIKE isag_t.isag002
   DEFINE p_isag003   LIKE isag_t.isag003
   DEFINE r_success   LIKE type_t.num5
   DEFINE l_rmda      RECORD
                      rmdastus   LIKE rmda_t.rmdastus,
                      rmda001    LIKE rmda_t.rmda001,
                      rmdasite   LIKE rmda_t.rmdasite,
                      rmdb013    LIKE rmdb_t.rmdb013,
                      rmba006    LIKE rmba_t.rmba006,
                      rmba010    LIKE rmba_t.rmba010
                      END RECORD
   DEFINE  l_site_str STRING   #組織範圍                      
   
   LET r_success = TRUE
   CALL s_fin_account_center_sons_str() RETURNING l_site_str
   CALL s_fin_get_wc_str(l_site_str) RETURNING l_site_str
   
   INITIALIZE l_rmda.* TO NULL
   SELECT rmdastus,rmda001,rmdasite,rmdb013,rmba006,rmba010
     INTO l_rmda.*
     FROM rmda_t,rmdb_t,rmba_t a
    WHERE rmdaent   = rmdbent
      AND rmdadocno = rmdbdocno
      AND rmdbent = rmbaent
      AND rmdb001 = rmbadocno
      AND rmba000 = (SELECT MAX (rmba000)     #以版次最大為準
                       FROM rmba_t
                      WHERE rmbadocno = a.rmbadocno AND rmbaent = a.rmbaent)      
      AND rmdaent   = g_enterprise
      AND rmdadocno = p_isag002
      AND rmdbseq   = p_isag003
      AND rmda007   = g_isaf_m.isaf003
      AND rmda008   = g_isaf_m.isaf002

      
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'ais-00307'
         LET r_success = FALSE         
      #已過帳
      WHEN l_rmda.rmdastus <> 'S'
         LET g_errno = 'sub-00231'
         LET r_success = FALSE      
      #扣帳日需小於單據日期   
      WHEN l_rmda.rmda001 > g_isaf_m.isafdocdt
         LET g_errno = 'ais-00308'
         LET r_success = FALSE     
      #稅別或幣別不合
      WHEN l_rmda.rmba006 <> g_isaf_m.isaf016 OR l_rmda.rmba010 <> g_isaf_m.isaf100
         LET g_errno = 'ais-00309'
         LET r_success = FALSE     

   END CASE
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 13:門店銷售單/22:門店銷退單 檢查合理性
# Memo...........: #160614-00025#1
# Usage..........: CALL aist310_isag002_chk4(p_isag001,p_isag002,p_isag003)
# Input parameter: p_isag001      來源類型
#                : p_isag002      來源單號
#                : p_isag003      來源項次
# Return code....: r_success
# Date & Author..: 160705 By 06821
# Modify.........:
################################################################################
PRIVATE FUNCTION aist310_isag002_chk4(p_isag001,p_isag002,p_isag003)
   DEFINE p_isag001   LIKE isag_t.isag001
   DEFINE p_isag002   LIKE isag_t.isag002
   DEFINE p_isag003   LIKE isag_t.isag003
   DEFINE r_success   LIKE type_t.num5
   DEFINE l_rtia      RECORD
                      rtiastus   LIKE rtia_t.rtiastus,
                      rtiadocdt  LIKE rtia_t.rtiadocdt,
                      rtiasite   LIKE rtia_t.rtiasite,
                      rtib006    LIKE rtib_t.rtib006,
                      rtia026    LIKE rtia_t.rtia026
                      END RECORD                   
   
   LET r_success = TRUE
   
   INITIALIZE l_rtia.* TO NULL
   
   
   IF p_isag001 = '13' THEN
      #161024-00065#2 add ------
      IF g_sfin2023 = '1' THEN
         SELECT rtiastus,rtiadocdt,rtiasite,rtib006,rtia026
           INTO l_rtia.*
           FROM rtia_t,rtib_t
          WHERE rtiaent   = rtibent
            AND rtiadocno = rtibdocno
            AND rtia000 IN ('artt600','artt610','artt620')
            AND rtiaent   = g_enterprise
            AND rtiadocno = p_isag002
            AND rtibseq   = p_isag003
            AND rtia002   = g_isaf_m.isaf003
            AND rtia032 IN ('1','4')
      ELSE
      #161024-00065#2 add end---
         SELECT rtiastus,rtiadocdt,rtiasite,rtib006,rtia026
           INTO l_rtia.*
           FROM rtia_t,rtib_t
          WHERE rtiaent   = rtibent
            AND rtiadocno = rtibdocno
            AND rtia000 IN ('artt600','artt610','artt620')
            AND rtiaent   = g_enterprise
            AND rtiadocno = p_isag002
            AND rtibseq   = p_isag003
            AND rtia002   = g_isaf_m.isaf003
            AND rtia032 IN ('1') #161024-00065#2
      END IF  #161024-00065#2
   END IF

   IF p_isag001 = '22' THEN 
      SELECT rtiastus,rtiadocdt,rtiasite,rtib006,rtia026
        INTO l_rtia.*
        FROM rtia_t,rtib_t 
       WHERE rtiaent   = rtibent
         AND rtiadocno = rtibdocno
         AND rtia000 = 'artt700'    
         AND rtiaent   = g_enterprise
         AND rtiadocno = p_isag002
         AND rtibseq   = p_isag003
         AND rtia002   = g_isaf_m.isaf003
   END IF
   
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'art-00277'
         LET r_success = FALSE         
      #已過帳
      WHEN l_rtia.rtiastus <> 'S'
         LET g_errno = 'sub-00231'
         LET r_success = FALSE      
      #單據日期需小於來源單據日期   
      WHEN l_rtia.rtiadocdt > g_isaf_m.isafdocdt
         LET g_errno = 'ais-00308'
         LET r_success = FALSE     
      #稅別或幣別不合
      WHEN l_rtia.rtib006 <> g_isaf_m.isaf016 OR l_rtia.rtia026 <> g_isaf_m.isaf100
         LET g_errno = 'ais-00309'
         LET r_success = FALSE     
   END CASE
   
   RETURN r_success
END FUNCTION
# isag004發票數量欄位檢查
PRIVATE FUNCTION aist310_isag004_chk()
   DEFINE  l_isag004             LIKE isag_t.isag004
   DEFINE  l_xrcb030             LIKE xrcb_t.xrcb030
   DEFINE  l_xmdl003             LIKE xmdl_t.xmdl003
   DEFINE  l_xmdl004             LIKE xmdl_t.xmdl004
   DEFINE  l_isag004_2           LIKE isag_t.isag004
   
   LET g_errno = ''
   IF g_isag_d[l_ac].isag001 = '10' THEN  #訂單    #axmt500
      #IF cl_null(g_isag_d[l_ac].isag009) AND cl_null(g_isag_d[l_ac].isag010) THEN     #160316-00017#2 mark lujh
         SELECT sum(isag004) INTO l_isag004 
           FROM isag_t,isaf_t 
          WHERE isagent = g_enterprise
            AND isag002 = g_isag_d[l_ac].isag002  
            AND isag003 = g_isag_d[l_ac].isag003  
            AND isafent = isagent
            AND isafdocno = isagdocno
            AND isafcomp = isafcomp
            AND isag011 = g_isag_d[l_ac].isag011
            #AND (isafstus ='Y'  OR isafstus ='S')  #160316-00017#2 mark lujh
            AND isafstus <> 'X'                     #160316-00017#2 add lujh
            AND ((isafdocno = g_isaf_m.isafdocno   
            AND isagseq <> g_isag_d[l_ac].isagseq)  
             OR isafdocno <> g_isaf_m.isafdocno)            
            
      
         IF cl_null(l_isag004) THEN 
            LET l_isag004 = 0
         END IF
         
         IF cl_null(g_isag_d[l_ac].inag009) THEN 
            LET g_isag_d[l_ac].inag009 = 0
         END IF
         
         IF l_isag004 + g_isag_d[l_ac].isag004 > g_isag_d[l_ac].inag009 THEN 
            LET g_errno = 'ais-00133'     #160316-00017#2 change ais-00154 to ais-00133 lujh
         END IF
      #END IF    #160316-00017#2 mark lujh
   END IF
   
   IF g_isag_d[l_ac].isag001 = '11' OR g_isag_d[l_ac].isag001 = '21' THEN  #axmt540出貨單/axmt600銷退單
      # 由出貨單串訂單
      SELECT xmdl003,xmdl004 INTO l_xmdl003,l_xmdl004  
        FROM xmdl_t 
       WHERE xmdlent = g_enterprise
         AND xmdldocno = g_isag_d[l_ac].isag002
         AND xmdlseq = g_isag_d[l_ac].isag003
      
      SELECT sum(isag004) INTO l_isag004 
        FROM isag_t,isaf_t 
       WHERE isagent = g_enterprise
         AND isag002 = l_xmdl003  # 訂單號碼 
         AND isag003 = l_xmdl004  #-訂單項次
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp
         AND isafstus <> 'X'      #151124-00007#1 add lujh
         AND isaf001 = '1'        #160623-00019#1

      IF cl_null(l_isag004) THEN 
         LET l_isag004 = 0
      END IF
         
      IF l_isag004 < 0 THEN 
         LET l_isag004 = l_isag004 * -1
      END IF
	     
	   # 出貨單 
      SELECT sum(isag004) INTO l_isag004_2 
        FROM isag_t,isaf_t 
       WHERE isagent = g_enterprise
         AND isag002 = g_isag_d[l_ac].isag002  
         AND isag003 = g_isag_d[l_ac].isag003  
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp   
         AND isafstus <> 'X'
         AND ((isafdocno = g_isaf_m.isafdocno   
         AND isagseq <> g_isag_d[l_ac].isagseq)
          OR isafdocno <> g_isaf_m.isafdocno)
         AND isaf001 = '1'        #160623-00019#1
      IF cl_null(l_isag004_2) THEN LET l_isag004_2 = 0 END IF
      IF l_isag004_2 < 0 THEN LET l_isag004_2 = l_isag004_2 * -1 END IF
      IF cl_null(g_isag_d[l_ac].inag009) THEN LET g_isag_d[l_ac].inag009 = 0 END IF
      IF g_isag_d[l_ac].isag004 < 0 THEN LET g_isag_d[l_ac].isag004 = g_isag_d[l_ac].isag004 * -1 END IF
      IF g_isag_d[l_ac].inag009 < 0 THEN LET g_isag_d[l_ac].inag009 = g_isag_d[l_ac].inag009 * -1 END IF
	   IF cl_null(g_isag_d[l_ac].isag004) OR g_isag_d[l_ac].isag004 = 0 THEN 
         LET g_isag_d[l_ac].isag004 = g_isag_d[l_ac].inag009 - l_isag004 - l_isag004_2
         IF g_isag_d[l_ac].isag004 = 0 THEN 
            LET g_errno = 'ais-00154'
            RETURN
         END IF
      END IF
      IF l_isag004 + l_isag004_2 + g_isag_d[l_ac].isag004 > g_isag_d[l_ac].inag009 THEN
         LET g_errno = 'ais-00133'
      END IF
   END IF
   
   #150518-00046#4--s   
   IF g_isag_d[l_ac].isag001 = '12' THEN   #維修單   #armt400
	    #已存在aist310單身之數量
　　　 SELECT SUM(isag004) INTO l_isag004
        FROM isaf_t,isag_t 
       WHERE isagent = g_enterprise
         AND isag002 = g_isag_d[l_ac].isag002  
         AND isag003 = g_isag_d[l_ac].isag003  
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp　
         AND isafstus <> 'X'
         AND ((isagdocno = g_isaf_m.isafdocno
         AND   isagseq <> g_isag_d[l_ac].isagseq)
          OR   isagdocno <> g_isaf_m.isafdocno )
      IF cl_null(l_isag004) THEN LET l_isag004 = 0 END IF
      IF l_isag004 + g_isag_d[l_ac].isag004 > g_isag_d[l_ac].inag009 THEN 
         LET g_errno = 'ais-00133'
      END IF
   END IF
   #150518-00046#4--e
END FUNCTION
# 發票數量檢查(NO USE)
PRIVATE FUNCTION aist310_isag009_chk()
   DEFINE l_xrcb007    LIKE xrcb_t.xrcb007
   DEFINE l_xrcb030    LIKE xrcb_t.xrcb030
   
   LET g_errno = ''
   SELECT xrcb007,xrcb030 
     INTO l_xrcb007,l_xrcb030
     FROM xrca_t,xrcb_t 
    WHERE xrcbent = g_enterprise
      AND xrcbdocno = g_isag_d[l_ac].isag009
      AND xrcbseq = g_isag_d[l_ac].isag010
      AND xrcaent = xrcbent 
      AND xrcald = xrcbld 
      AND xrcadocno = xrcbdocno 
      AND xrca001 <> '01' 
      
   IF l_xrcb007 <= l_xrcb030 THEN 
      LET g_errno = 'ais-00132' 
   END IF
END FUNCTION

################################################################################
# Descriptions...: 折讓發票是否超折
# Memo...........: #151029-00001#3
# Usage..........: CALL aist310_isag014_chk()
# Date & Author..: 2015/12/01 By Reanna
# Modify.........:
################################################################################
PRIVATE FUNCTION aist310_isag014_chk(p_type,p_docno,p_seq,p_isag013,p_isag014,p_isag103)
DEFINE p_type           LIKE type_t.chr1
DEFINE p_docno          LIKE isaf_t.isafdocno
DEFINE p_seq            LIKE isag_t.isagseq
DEFINE p_isag013        LIKE isag_t.isag013
DEFINE p_isag014        LIKE isag_t.isag014
DEFINE p_isag103        LIKE isag_t.isag103
DEFINE l_orig_isat103   LIKE isat_t.isat103
DEFINE l_used_isat103   LIKE isat_t.isat103
DEFINE l_used_isag103   LIKE isag_t.isag103
DEFINE r_success        LIKE type_t.num5
DEFINE r_errno          LIKE gzze_t.gzze001
   
   LET r_success = TRUE
   LET r_errno   = ''
   
   IF g_isai002 = '1' THEN
      #取得原始開立發票的總額
      SELECT isat103 INTO l_orig_isat103
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isat004 = p_isag014  #原始發票號碼
         AND (isat014 = '11' OR isat025 <> '12')
      
      #取得已折總額
      SELECT SUM(isag103) INTO l_used_isag103
        FROM isaf_t
        LEFT JOIN isag_t ON isafent = isagent AND isafcomp = isagcomp AND isafdocno = isagdocno
       WHERE isafent = g_enterprise
         AND isag014 = p_isag014  #原始發票號碼
         AND ((isagdocno = p_docno AND isagseq <> p_seq) OR (isagdocno <> p_docno))
         AND isafstus <> 'X'
         AND isaf056 ='2'  #2:扣抵折讓單
         AND (isag018 = 'Y' OR isag018 IS NULL) #160823-00016#1
      
      #取得歷程檔已折總額
      SELECT SUM(isat103) INTO l_used_isat103
        FROM isaf_t
        LEFT JOIN isat_t ON isafent = isatent AND isafcomp = isatcomp AND isafdocno = isatdocno
       WHERE isatent = g_enterprise
         AND isat004 = p_isag014  #原始發票號碼
         AND (isat014 = '11' OR isat025 <> '12')
         AND ((isatdocno = p_docno AND isatseq <> p_seq) OR (isatdocno <> p_docno))
         AND isafstus <> 'X'
         AND isaf056 ='2'  #2:扣抵折讓單
   ELSE
      SELECT isat103 INTO l_orig_isat103
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isat003 = p_isag013  #原始發票代碼
         AND isat004 = p_isag014  #原始發票號碼
         AND (isat014 = '11' OR isat025 <> '12')
      
      SELECT SUM(isag103) INTO l_used_isag103
        FROM isaf_t
        LEFT JOIN isag_t ON isafent = isagent AND isafcomp = isagcomp AND isafdocno = isagdocno
       WHERE isafent = g_enterprise
         AND isag013 = p_isag013  #原始發票代碼
         AND isag014 = p_isag014  #原始發票號碼
         AND ((isagdocno = p_docno AND isagseq  = p_seq) OR (isagdocno <> p_docno))
         AND isafstus ='N'
         AND isaf056 ='2'  #2:扣抵折讓單
         AND (isag018 = 'Y' OR isag018 IS NULL) #160823-00016#1
      
      #取得歷程檔已折總額
      SELECT SUM(isat103) INTO l_used_isat103
        FROM isaf_t
        LEFT JOIN isat_t ON isafent = isatent AND isafcomp = isatcomp AND isafdocno = isatdocno
       WHERE isatent = g_enterprise
         AND isat003 = p_isag013  #原始發票代碼
         AND isat004 = p_isag014  #原始發票號碼
         AND (isat014 = '11' OR isat025 <> '12')
         AND ((isatdocno = p_docno AND isatseq <> p_seq) OR (isatdocno <> p_docno))
         AND isafstus <> 'X'
         AND isaf056 ='2'  #2:扣抵折讓單
   END IF
   IF cl_null(l_orig_isat103) THEN LET l_orig_isat103 = 0 END IF
   IF cl_null(l_used_isat103) THEN LET l_used_isat103 = 0 END IF
   IF cl_null(l_used_isag103) THEN LET l_used_isag103 = 0 END IF
   
   IF p_type = "1" THEN #來源明細用
      #已折金額+現在的這個折讓金額 > 原開立發票金額
      IF l_used_isag103 + p_isag103 > l_orig_isat103 THEN
         LET r_errno = 'ais-00251'
         LET r_success = FALSE
      END IF
   ELSE
      IF l_used_isat103 + p_isag103 > l_orig_isat103 THEN
         LET r_errno = 'ais-00251'
         LET r_success = FALSE
      END IF
   END IF
   RETURN r_success,r_errno
END FUNCTION
# 來源為其他待抵單時原幣稅後金額檢查
PRIVATE FUNCTION aist310_isag105_chk()
DEFINE  l_isag105             LIKE isag_t.isag105
DEFINE  l_isag115             LIKE isag_t.isag115
DEFINE  l_isag105_sum         LIKE isag_t.isag105
DEFINE  l_xmdl004             LIKE xmdl_t.xmdl004
DEFINE  l_isag004_2           LIKE isag_t.isag004
   
   LET g_errno = ''
   #IF g_isag_d[l_ac].isag001 = '27' THEN  #其他待抵單 #160426-00013#2 mark
   IF g_isag_d[l_ac].isag001 = '27' OR g_isag_d[l_ac].isag001 = '29' THEN  #其他待抵單 #160426-00013#2
      IF NOT cl_null(g_isag_d[l_ac].isag002) AND NOT cl_null(g_isag_d[l_ac].isag003) THEN #160426-00013#2
         SELECT xrcc108 - xrcc109,xrcc118 - xrcc119 + xrcc113
           INTO l_isag105,l_isag115
           FROM xrcc_t 
          WHERE xrccent = g_enterprise
            AND xrccld = g_glaald
            AND xrccdocno = g_isag_d[l_ac].isag002
            AND xrccseq = g_isag_d[l_ac].isag003
         IF cl_null(l_isag105) THEN LET l_isag105 = 0 END IF
         IF cl_null(l_isag115) THEN LET l_isag115 = 0 END IF
	      
         #發票未確認的金額
         SELECT SUM(isag105) INTO l_isag105_sum
           FROM isag_t,isaf_t
          WHERE isagent = g_enterprise
            AND isag002 = g_isag_d[l_ac].isag002
            AND isag003 = g_isag_d[l_ac].isag003
            AND isafent = isagent AND isafdocno = isagdocno AND isafcomp = isafcomp
            AND isafstus = 'N'
            AND ((isafdocno = g_isaf_m.isafdocno AND isagseq <> g_isag_d[l_ac].isagseq)
                  OR isafdocno <> g_isaf_m.isafdocno)
         IF cl_null(l_isag105_sum) THEN LET l_isag105_sum = 0 END IF
         IF l_isag105_sum + g_isag_d[l_ac].isag105 > l_isag105 THEN
            LET g_errno = 'ais-00177'
         END IF
         #160426-00013#2-s
         IF g_isag_d[l_ac].isag105 = 0 THEN
            LET g_errno = 'ais-00330'
         END IF
         #160426-00013#2-e
      END IF #160426-00013#2
   END IF
   
END FUNCTION


# 第一單身金額欄位預設(NO USE)
PRIVATE FUNCTION aist310_isag_preinstall()
    
   #原幣稅前金額
   IF g_isaf_m.isaf017 = 'Y' THEN 
      LET g_isag_d[l_ac].isag103 = (g_isag_d[l_ac].isag101/(1+g_isag_d[l_ac].isag008/100))*g_isag_d[l_ac].isag004
   ELSE
      LET g_isag_d[l_ac].isag103 = g_isag_d[l_ac].isag101 * g_isag_d[l_ac].isag004
   END IF 
   
   #原幣稅額
   IF g_isaf_m.isaf017 = 'Y' THEN 
      LET g_isag_d[l_ac].isag104 = (g_isag_d[l_ac].isag101 * g_isag_d[l_ac].isag004) - 
                                           (g_isag_d[l_ac].isag101/(1+g_isag_d[l_ac].isag008/100))*g_isag_d[l_ac].isag004
   ELSE
      LET g_isag_d[l_ac].isag104 = g_isag_d[l_ac].isag103 * g_isag_d[l_ac].isag008/100
   END IF 
   
   #原幣稅後金額
   LET g_isag_d[l_ac].isag105 = g_isag_d[l_ac].isag103 + g_isag_d[l_ac].isag104
   
   #預設本幣稅前金額
   LET g_isag_d[l_ac].isag113 = g_isag_d[l_ac].isag103 * g_isaf_m.isaf101
   
   #預設本幣稅額
   LET g_isag_d[l_ac].isag114 = g_isag_d[l_ac].isag104 * g_isaf_m.isaf101
   
   #預設本幣稅後金額
   LET g_isag_d[l_ac].isag115 = g_isag_d[l_ac].isag113 + g_isag_d[l_ac].isag114
   
   #161214-00053#1 mark ------
   #LET g_isag_d[l_ac].isag103 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag_d[l_ac].isag103,2)
   #LET g_isag_d[l_ac].isag104 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag_d[l_ac].isag104,2)
   #LET g_isag_d[l_ac].isag105 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag_d[l_ac].isag105,2)
   ##161209-00037#1 mark ------
   ##LET g_isag_d[l_ac].isag113 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag_d[l_ac].isag113,2)
   ##LET g_isag_d[l_ac].isag114 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag_d[l_ac].isag114,2)
   ##LET g_isag_d[l_ac].isag115 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag_d[l_ac].isag115,2)
   ##161209-00037#1 mark end---
   ##161209-00037#1 add ------
   #LET g_isag_d[l_ac].isag113 = s_curr_round(g_site,g_glaa001,g_isag_d[l_ac].isag113,2)
   #LET g_isag_d[l_ac].isag114 = s_curr_round(g_site,g_glaa001,g_isag_d[l_ac].isag114,2)
   #LET g_isag_d[l_ac].isag115 = s_curr_round(g_site,g_glaa001,g_isag_d[l_ac].isag115,2)
   ##161209-00037#1 add end---
   #161214-00053#1 mark end---
   #161214-00053#1 add ------
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,g_isag_d[l_ac].isag103,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag103
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,g_isag_d[l_ac].isag104,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag104
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,g_isag_d[l_ac].isag105,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag105
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag113,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag113
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag114,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag114
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag_d[l_ac].isag115,2) RETURNING g_sub_success,g_errno,g_isag_d[l_ac].isag115
   #161214-00053#1 add end---
   
   DISPLAY g_isag_d[l_ac].isag101 TO s_detail1[l_ac].isag101
   DISPLAY g_isag_d[l_ac].isag103 TO s_detail1[l_ac].isag103
   DISPLAY g_isag_d[l_ac].isag104 TO s_detail1[l_ac].isag104
   DISPLAY g_isag_d[l_ac].isag105 TO s_detail1[l_ac].isag105
   DISPLAY g_isag_d[l_ac].isag113 TO s_detail1[l_ac].isag113
   DISPLAY g_isag_d[l_ac].isag114 TO s_detail1[l_ac].isag114
   DISPLAY g_isag_d[l_ac].isag115 TO s_detail1[l_ac].isag115
END FUNCTION


# 第二單身金額欄位預設(NO USE)
PRIVATE FUNCTION aist310_isah_preinstall()
   #預設發票稅前金額
   IF g_isaf_m.isaf017 = 'Y' THEN 
      LET g_isag2_d[l_ac].isah103 = (g_isag2_d[l_ac].isah101/(1+g_isag2_d[l_ac].isah007/100)) * g_isag2_d[l_ac].isah006
   ELSE
      LET g_isag2_d[l_ac].isah103 = g_isag2_d[l_ac].isah101 * g_isag2_d[l_ac].isah006
   END IF 
   #預設發票稅額
   IF g_isaf_m.isaf017 = 'Y' THEN 
      LET g_isag2_d[l_ac].isah104 = (g_isag2_d[l_ac].isah101 * g_isag2_d[l_ac].isah006) - 
                                    (g_isag2_d[l_ac].isah101/(1+g_isag2_d[l_ac].isah007/100)) * g_isag2_d[l_ac].isah006     
   ELSE
      LET g_isag2_d[l_ac].isah104 = g_isag2_d[l_ac].isah006 * g_isag2_d[l_ac].isah007/100
   END IF
   #預設發票稅後金額
   LET g_isag2_d[l_ac].isah105 = g_isag2_d[l_ac].isah103 + g_isag2_d[l_ac].isah104
   #預設發票本幣稅前金額
   LET g_isag2_d[l_ac].isah113 = g_isag2_d[l_ac].isah103 * g_isaf_m.isaf101
   #預設發票本幣稅額
   LET g_isag2_d[l_ac].isah114 = g_isag2_d[l_ac].isah104 * g_isaf_m.isaf101
   #預設發票本幣稅後金額
   LET g_isag2_d[l_ac].isah115 = g_isag2_d[l_ac].isah113 + g_isag2_d[l_ac].isah114
   #161214-00053#1 mark ------
   #LET g_isag2_d[l_ac].isah103 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag2_d[l_ac].isah103,2)
   #LET g_isag2_d[l_ac].isah104 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag2_d[l_ac].isah104,2)
   #LET g_isag2_d[l_ac].isah105 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag2_d[l_ac].isah105,2)
   ##161209-00037#1 mark ------
   ##LET g_isag2_d[l_ac].isah113 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag2_d[l_ac].isah113,2)
   ##LET g_isag2_d[l_ac].isah114 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag2_d[l_ac].isah114,2)
   ##LET g_isag2_d[l_ac].isah115 = s_curr_round(g_site,g_isaf_m.isaf100,g_isag2_d[l_ac].isah115,2)
   ##161209-00037#1 mark end---
   ##161209-00037#1 add ------
   #LET g_isag2_d[l_ac].isah113 = s_curr_round(g_site,g_glaa001,g_isag2_d[l_ac].isah113,2)
   #LET g_isag2_d[l_ac].isah114 = s_curr_round(g_site,g_glaa001,g_isag2_d[l_ac].isah114,2)
   #LET g_isag2_d[l_ac].isah115 = s_curr_round(g_site,g_glaa001,g_isag2_d[l_ac].isah115,2)
   ##161209-00037#1 add end---
   #161214-00053#1 mark end---
   #161214-00053#1 add ------
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,g_isag2_d[l_ac].isah103,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah103
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,g_isag2_d[l_ac].isah104,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah104
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,g_isag2_d[l_ac].isah105,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah105
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag2_d[l_ac].isah113,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah113
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag2_d[l_ac].isah114,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah114
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag2_d[l_ac].isah115,2) RETURNING g_sub_success,g_errno,g_isag2_d[l_ac].isah115
   #161214-00053#1 add end---
   DISPLAY g_isag2_d[l_ac].isah103 TO s_detail2[l_ac].isah103
   DISPLAY g_isag2_d[l_ac].isah104 TO s_detail2[l_ac].isah104
   DISPLAY g_isag2_d[l_ac].isah105 TO s_detail2[l_ac].isah105
   DISPLAY g_isag2_d[l_ac].isah113 TO s_detail2[l_ac].isah113
   DISPLAY g_isag2_d[l_ac].isah114 TO s_detail2[l_ac].isah114
   DISPLAY g_isag2_d[l_ac].isah115 TO s_detail2[l_ac].isah115
END FUNCTION
# 根據來源單號串應收單號(NO USE)
PRIVATE FUNCTION aist310_xrcbdocno_get(p_xrcb002,p_xrcb003)
   DEFINE p_xrcb002     LIKE xrcb_t.xrcb002
   DEFINE p_xrcb003     LIKE xrcb_t.xrcb003
   DEFINE r_xrcbdocno   LIKE xrcb_t.xrcbdocno
   DEFINE r_xrcbseq     LIKE xrcb_t.xrcbseq
   
   LET r_xrcbdocno = ''
   LET r_xrcbseq = ''
   LET g_sql = "SELECT xrcbdocno,xrcbseq ", 
               "  FROM xrca_t,xrcb_t ",
               " WHERE xrcbent = '",g_enterprise,"'",
               "   AND xrcb002 = '",p_xrcb002,"'",
               "   AND xrcb003 = '",p_xrcb003,"'",
               "   AND xrcaent = xrcbent ",
               "   AND xrcald = xrcbld ",
               "   AND xrcadocno = xrcbdocno ",
               "   AND xrca001 <> '01' ",
               "   AND xrcb007 - xrcb030 > 0 "
   PREPARE xrcbdocno_pre FROM g_sql
   DECLARE xrcbdocno_cur CURSOR FOR xrcbdocno_pre
   OPEN xrcbdocno_cur
   FETCH xrcbdocno_cur INTO r_xrcbdocno,r_xrcbseq
      
   RETURN r_xrcbdocno,r_xrcbseq
END FUNCTION
#
PRIVATE FUNCTION aist310_change_to_sql(p_wc)
   DEFINE p_wc       STRING
   DEFINE r_wc       STRING
   DEFINE tok        base.StringTokenizer
   DEFINE l_str      STRING

   LET tok = base.StringTokenizer.create(p_wc,",")
   WHILE tok.hasMoreTokens()
      IF cl_null(l_str) THEN
         LET l_str = tok.nextToken()
      ELSE
         LET l_str = l_str,"','",tok.nextToken()
      END IF
   END WHILE
   LET r_wc = "'",l_str,"'"

   RETURN r_wc
END FUNCTION
# 来源类型选项
PRIVATE FUNCTION aist310_isag001_sel()
   DEFINE  l_sql                 STRING
   DEFINE  l_str                 STRING
   DEFINE  l_gzcb002             LIKE gzcb_t.gzcb002
   
   IF g_isaf_m.isaf056 = '1' THEN
      #CALL cl_set_combo_scc('isag001','8341')   #160316-00017#2 mark lujh
      #160316-00017#2--add--str--lujh
       IF g_isaf_m.isaf001 = '3' THEN
          #CALL cl_set_combo_scc('isag001','8341') #160622-00019#1 mark
          CALL cl_set_combo_scc_part('isag001','8341','10,19,29') #160622-00019#1 add
       ELSE
          #CALL cl_set_combo_scc_part('isag001','8341','11,12,16,19,21,26,27,29')    #160614-00025#1 mark
          #CALL cl_set_combo_scc_part('isag001','8341','11,12,13,16,19,21,26,27,29') #160614-00025#1 add 13類型 #160426-00013#2 mark
          CALL cl_set_combo_scc_part('isag001','8341','10,11,12,13,16,19,21,26,27,29') #160426-00013#2
       END IF
       #160316-00017#2--add--end--lujh
   ELSE
      LET l_sql = "SELECT gzcb002 FROM gzcb_t WHERE gzcb001 = '8341' AND gzcb004 = '-1'"
      PREPARE aist310_isaf001_prep FROM l_sql
      DECLARE aist310_isaf001_curs CURSOR FOR aist310_isaf001_prep
      LET l_str = Null
      LET l_gzcb002 = Null
      FOREACH aist310_isaf001_curs INTO l_gzcb002
         IF cl_null(l_str) THEN 
            LET l_str = l_gzcb002 
            CONTINUE FOREACH 
         END IF
         LET l_str = l_str,",",l_gzcb002
      END FOREACH
      CALL cl_set_combo_scc_part('isag001','8341',l_str)
   END IF
END FUNCTION
# 清空栏位值
PRIVATE FUNCTION aist310_clear()
   LET g_isag_d[l_ac].isag009 = ''
   LET g_isag_d[l_ac].isag010 = ''
   LET g_isag_d[l_ac].isag016 = '' 
   LET g_isag_d[l_ac].isag017 = '' 
   LET g_isag_d[l_ac].isag015 = '' 
   LET g_isag_d[l_ac].inag009 = '' 
   LET g_isag_d[l_ac].xmdl047 = '' 
   LET g_isag_d[l_ac].inag007 = '' 
   LET g_isag_d[l_ac].inag007_desc = '' 
   LET g_isag_d[l_ac].isag006 = ''
   LET g_isag_d[l_ac].isag012 = '' 
   LET g_isag_d[l_ac].isag004 = ''  
   LET g_isag_d[l_ac].isag005 = ''  
   LET g_isag_d[l_ac].isag005_desc = ''
END FUNCTION
# 發票主檔金額合計
PRIVATE FUNCTION aist310_isaf_sum()
   DEFINE  l_isaf103       LIKE isaf_t.isaf103
   DEFINE  l_isaf104       LIKE isaf_t.isaf104
   DEFINE  l_isaf105       LIKE isaf_t.isaf105
   DEFINE  l_isaf113       LIKE isaf_t.isaf113
   DEFINE  l_isaf114       LIKE isaf_t.isaf114
   DEFINE  l_isaf115       LIKE isaf_t.isaf115
   
   SELECT SUM(isag103*isag015),SUM(isag104*isag015),SUM(isag105*isag015),
          SUM(isag113*isag015),SUM(isag114*isag015),SUM(isag115*isag015)
     INTO l_isaf103,l_isaf104,l_isaf105,l_isaf113,l_isaf114,l_isaf115
     FROM isag_t
    WHERE isagent = g_enterprise
      AND isagcomp = g_isaf_m.isafcomp
      AND isagdocno = g_isaf_m.isafdocno
      AND (isag018 = 'Y' OR isag018 IS NULL) #160823-00016#1

   IF cl_null(l_isaf103) THEN
      LET l_isaf103 = 0
   END IF
   IF cl_null(l_isaf104) THEN
      LET l_isaf104 = 0
   END IF
   IF cl_null(l_isaf105) THEN
      LET l_isaf105 = 0
   END IF
   IF cl_null(l_isaf113) THEN
      LET l_isaf113 = 0
   END IF
   IF cl_null(l_isaf114) THEN
      LET l_isaf114 = 0
   END IF
   IF cl_null(l_isaf115) THEN
      LET l_isaf115 = 0
   END IF
   
   #161214-00053#1 mark ------
   #LET l_isaf103 = s_curr_round(g_site,g_isaf_m.isaf100,l_isaf103,2)
   #LET l_isaf104 = s_curr_round(g_site,g_isaf_m.isaf100,l_isaf104,2)
   #LET l_isaf105 = s_curr_round(g_site,g_isaf_m.isaf100,l_isaf105,2)
   ##161209-00037#1 mark ------
   ##LET l_isaf113 = s_curr_round(g_site,g_isaf_m.isaf100,l_isaf113,2)
   ##LET l_isaf114 = s_curr_round(g_site,g_isaf_m.isaf100,l_isaf114,2)
   ##LET l_isaf115 = s_curr_round(g_site,g_isaf_m.isaf100,l_isaf115,2)
   ##161209-00037#1 mark end---
   ##161209-00037#1 add ------
   #LET l_isaf113 = s_curr_round(g_site,g_glaa001,l_isaf113,2)
   #LET l_isaf114 = s_curr_round(g_site,g_glaa001,l_isaf114,2)
   #LET l_isaf115 = s_curr_round(g_site,g_glaa001,l_isaf115,2)
   ##161209-00037#1 add end---
   #161214-00053#1 mark end---
   
   #161214-00053#1 add ------
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,l_isaf103,2) RETURNING g_sub_success,g_errno,l_isaf103
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,l_isaf104,2) RETURNING g_sub_success,g_errno,l_isaf104
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,l_isaf105,2) RETURNING g_sub_success,g_errno,l_isaf105
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isaf113,2) RETURNING g_sub_success,g_errno,l_isaf113
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isaf114,2) RETURNING g_sub_success,g_errno,l_isaf114
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isaf115,2) RETURNING g_sub_success,g_errno,l_isaf115

   IF g_isai004 = '1' THEN
      IF l_isaf103 < 0 THEN
         LET l_isaf103 = l_isaf103 * -1
      END IF
      IF l_isaf104 < 0 THEN
         LET l_isaf104 = l_isaf104 * -1
      END IF
      IF l_isaf105 < 0 THEN
         LET l_isaf105 = l_isaf105 * -1
      END IF
      IF l_isaf113 < 0 THEN
         LET l_isaf113 = l_isaf113 * -1
      END IF
      IF l_isaf114 < 0 THEN
         LET l_isaf114 = l_isaf114 * -1
      END IF
      IF l_isaf115 < 0 THEN
         LET l_isaf115 = l_isaf115 * -1
      END IF
   END IF
   #161214-00053#1 add end---
   
   LET g_isaf_m.isaf103 = l_isaf103
   LET g_isaf_m.isaf104 = l_isaf104
   LET g_isaf_m.isaf105 = l_isaf105
   LET g_isaf_m.isaf113 = l_isaf113
   LET g_isaf_m.isaf114 = l_isaf114
   LET g_isaf_m.isaf115 = l_isaf115
   
   #1.應稅
   IF g_isaf_m.isaf054 = '1' THEN
      LET g_isaf_m.isaf119 = g_isaf_m.isaf105
      LET g_isaf_m.isaf120 = 0
      LET g_isaf_m.isaf121 = 0
   END IF

   #2.零稅
   IF g_isaf_m.isaf054 = '2' THEN
      LET g_isaf_m.isaf119 = 0
      LET g_isaf_m.isaf120 = g_isaf_m.isaf105
      LET g_isaf_m.isaf121 = 0
   END IF

   #3.免稅
   IF g_isaf_m.isaf054 = '3' THEN
      LET g_isaf_m.isaf119 = 0
      LET g_isaf_m.isaf120 = 0
      LET g_isaf_m.isaf121 = g_isaf_m.isaf105
   END IF
   
   UPDATE isaf_t
      SET isaf103 = l_isaf103,
          isaf104 = l_isaf104,
          isaf105 = l_isaf105,
          isaf113 = l_isaf113,
          isaf114 = l_isaf114,
          isaf115 = l_isaf115,
          isaf119 = g_isaf_m.isaf119,
          isaf120 = g_isaf_m.isaf120,
          isaf121 = g_isaf_m.isaf121
    WHERE isafent = g_enterprise
      AND isafcomp = g_isaf_m.isafcomp
      AND isafdocno = g_isaf_m.isafdocno
   
   IF SQLCA.SQLcode  THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "upd isaf_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CALL s_transaction_end('N','0')
   ELSE
      #CALL s_transaction_end('Y','0')     #161212-00075#1   破壞transaction故mark
   END IF
   
END FUNCTION
# 確認碼變更
PRIVATE FUNCTION aist310_statechange1()
   {<Local define>}
   DEFINE lc_state LIKE type_t.chr5
   {</Local define>}

   DEFINE l_success       LIKE type_t.num5
   DEFINE l_n             LIKE type_t.num5
   DEFINE r_success       LIKE type_t.chr1
   DEFINE l_today         DATETIME YEAR TO SECOND
   DEFINE l_isae006       LIKE isae_t.isae006
   DEFINE l_ooba002       LIKE type_t.chr10       #151209-00023#1 add lujh
   DEFINE l_count         LIKE type_t.num5
   #160308-00006#2 add ------
   DEFINE l_isae012       LIKE isae_t.isae012
   DEFINE l_isae012_o     LIKE isae_t.isae012
   DEFINE l_isae012_str   STRING
   DEFINE l_len           LIKE type_t.num5
   DEFINE l_sql           STRING
   #160308-00006#2 add end---
   #160614-00025#1 --s add
   DEFINE l_isag002       LIKE isag_t.isag002
   DEFINE l_rtia014       LIKE rtia_t.rtia014
   DEFINE l_rtia015       LIKE rtia_t.rtia015
   DEFINE l_date          DATETIME YEAR TO SECOND
   #160614-00025#1 --e add
   
   CALL aist310_ui_headershow()
   
   ERROR ""     #清空畫面右下側ERROR區塊
   LET l_success = TRUE  #150603-00046#1
 
   IF g_isaf_m.isafcomp IS NULL OR g_isaf_m.isafdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         CASE g_isaf_m.isafstus
            WHEN "N"
               HIDE OPTION "open"
               #151209-00023#1--add--str--lujh
               HIDE OPTION "posted"       
               HIDE OPTION "unposted"   
               #151209-00023#1--add--end--lujh               
            WHEN "V"
               HIDE OPTION "verify"
            WHEN "Y"
               HIDE OPTION "confirmed"
               HIDE OPTION "unposted"     #151209-00023#1 add lujh
               
            WHEN "S"
               HIDE OPTION "posted"
               #151209-00023#1--add--str--lujh
               HIDE OPTION "confirmed"    
               HIDE OPTION "open"
               HIDE OPTION "invalid"
               #151209-00023#1--add--end--lujh
            WHEN "X"
               HIDE OPTION "invalid"
               #151209-00023#1--add--str--lujh
               HIDE OPTION "posted"
               HIDE OPTION "unposted" 
               #151209-00023#1--add--end--lujh
         END CASE
      
      #151209-00023#1--add--str--lujh
      LET l_ooba002 = ''
      LET l_ooba002 = cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-1003')
      IF l_ooba002 <> '3' THEN 
      #151209-00023#1--add--end--lujh
         HIDE OPTION "posted"
         HIDE OPTION "unposted"
      END IF     #151209-00023#1 add lujh
      
      ON ACTION open
         LET lc_state = "N"
         IF g_isaf_m.isafstus = 'X' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'anm-00044'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         #IF g_isaf_m.isafstus = 'V' THEN 
         #   CALL cl_err(g_isaf_m.isafdocno,'anm-00054',1)
         #   RETURN
         #END IF 
         
         IF g_isaf_m.isafstus = 'S' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00090'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         
         IF NOT cl_null(g_isaf_m.isaf035) AND g_isaf_m.isafstus = 'Y' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00136'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         
         SELECT isae006 INTO l_isae006
           FROM isae_t
          WHERE isaeent = g_enterprise
            AND isaesite = g_isaf_m.isaf052
            AND isae001  = g_isaf_m.isaf051
            AND isae002 <= g_isaf_m.isaf014
            AND isae003 >= g_isaf_m.isaf014
            AND isae004  = g_isaf_m.isaf008   #albireo 160721 無單
         
         #已經開發票不可取消審核
         IF NOT cl_null(g_isaf_m.isaf011) AND l_isae006 = '1' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00166'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         
         #170116-00020#1 add ------
         LET l_n = 0
         SELECT COUNT(1) INTO l_n
           FROM isat_t
          WHERE isatent = g_enterprise
            AND isatdocno = g_isaf_m.isafdocno
            AND isat025 = '11'  #170216-00030#1
         IF cl_null(l_n) THEN LET l_n = 0 END IF
         IF l_n > 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00351' #已有發票歷程檔，不可取消確認!!
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         #170116-00020#1 add end---
         
         CALL aist310_unconfirm()
         
         #DELETE FROM isat_t 
         # WHERE isatent = g_enterprise
         #   AND isatcomp = g_isaf_m.isafcomp
         #   AND isatdocno = g_isaf_m.isafdocno
         #   
         #IF SQLCA.SQLcode THEN
         #   INITIALIZE g_errparam TO NULL
         #   LET g_errparam.code = SQLCA.sqlcode
         #   LET g_errparam.extend = "isat_t"
         #   LET g_errparam.popup = TRUE
         #   CALL cl_err()
         #
         #   LET g_success = 'N'                            
         #END IF
         
         #150603-00046#1 mark ------
         #IF g_success = 'N' THEN 
         #   CALL s_transaction_end('N','1')
         #   RETURN
         #ELSE
         #   CALL s_transaction_end('Y','1')
         #END IF
         #150603-00046#1 mark end---
         
         EXIT MENU
      
      
      #ON ACTION verify
      #   LET lc_state = "V"
      #   #add-point:action控制
      #   IF g_isaf_m.isafstus = 'X' THEN 
      #      INITIALIZE g_errparam TO NULL
      #      LET g_errparam.code = 'anm-00044'
      #      LET g_errparam.extend = g_isaf_m.isafdocno
      #      LET g_errparam.popup = TRUE
      #      CALL cl_err()
      #      RETURN
      #   END IF
      #   IF g_isaf_m.isafstus <> 'Y' THEN 
      #      CALL cl_err(g_isaf_m.isafdocno,'anm-00053',1)
      #      RETURN
      #   END IF 
      #   #end add-point
      #   EXIT MENU
 
      ON ACTION confirmed
         LET lc_state = "Y"
        #CALL cl_err_collect_init() #150603-00046#1 mark
         
         LET l_n = 0
         #SELECT COUNT(*) INTO l_n  #160907-00046#1 mark
         SELECT COUNT(1) INTO l_n  #160907-00046#1 
           FROM isag_t
          WHERE isagent = g_enterprise
            AND isagcomp = g_isaf_m.isafcomp
            AND isagdocno = g_isaf_m.isafdocno
         IF cl_null(l_n) THEN LET l_n = 0 END IF   #150603-00046#1
         IF l_n = 0 THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00101'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         
         IF g_isaf_m.isafstus = 'X' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'anm-00044'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF 
         
         #IF g_isaf_m.isafstus = 'V' THEN 
         #   CALL cl_err(g_isaf_m.isafdocno,'anm-00054',1)
         #   RETURN
         #END IF
         
         IF g_isaf_m.isafstus = 'S' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00090'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         
         #150603-00046#1 mark ------
         ##20150309--add--str--
         #IF g_isaf_m.isaf103 < 0 AND g_isaf_m.isaf056 = '1' THEN 
         #   INITIALIZE g_errparam TO NULL
         #   LET g_errparam.code = 'ais-00188'
         #   LET g_errparam.extend = g_isaf_m.isafdocno
         #   LET g_errparam.popup = TRUE
         #   CALL cl_err()
         #   #RETURN  #150603-00046#1 mark
         #END IF
         ##20150309--add--end--
         #150603-00046#1 mark end---
         #150603-00046#1 add ------
         #藍字發票金額要>=0
         IF g_isaf_m.isaf056 = 1 THEN
            IF g_isaf_m.isaf103 < 0 OR g_isaf_m.isaf105 < 0 OR g_isaf_m.isaf113 < 0 OR g_isaf_m.isaf115 < 0 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aap-00363'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               RETURN
            END IF
         ELSE
         #紅字發票<0
            #IF g_isai002 = '1' THEN  #161214-00053#1    #170116-00020#1 mark
            IF g_isai002 = '1' AND g_isai004 = '2' THEN  #170116-00020#1 add
               IF g_isaf_m.isaf103 > 0 AND g_isaf_m.isaf105 > 0 AND g_isaf_m.isaf113 > 0 AND g_isaf_m.isaf115 > 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'aap-00364'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  RETURN
               END IF
            END IF #161214-00053#1
         END IF
         #150603-00046#1 add end---
         #160215-00013#1 ---s---
         LET l_count = 0
         #SELECT COUNT(*) INTO l_count #160907-00046#1 mark
         SELECT COUNT(1) INTO l_count #160907-00046#1
           FROM isah_t
          WHERE isahent = g_enterprise
            AND isahcomp = g_isaf_m.isafcomp
            AND isahdocno = g_isaf_m.isafdocno
         IF cl_null(l_count) THEN LET l_count = 0 END IF  
         IF l_count = 0 THEN  CALL aist310_s01()　END IF 
         #160215-00013#1 ---e---
         LET l_n = 0
         #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
         SELECT COUNT(1) INTO l_n  #160907-00046#1 
           FROM isah_t
          WHERE isahent = g_enterprise
            AND isahcomp = g_isaf_m.isafcomp
            AND isahdocno = g_isaf_m.isafdocno
         IF cl_null(l_n) THEN LET l_n = 0 END IF   #150603-00046#1
         IF l_n = 0 THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00155'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()     
            RETURN         ##160215-00013#無發票明細　無法確認    
         END IF

         #150603-00046#1 mark ------
         #CALL aist310_confirm()
         #
         #LET l_n = 0
         #SELECT COUNT(*) INTO l_n
         #  FROM isat_t
         # WHERE isatent = g_enterprise
         #   AND isatcomp = g_isaf_m.isafcomp
         #   AND isatdocno = g_isaf_m.isafdocno
         #IF cl_null(l_n) THEN LET l_n = 0 END IF   #150603-00046#1
         #IF l_n = 0 THEN 
         #   CALL aist310_isat_ins() RETURNING r_success
         #   IF r_success = 'N' THEN 
         #      LET g_success = 'N'
         #   END IF
         #END IF
         #CALL cl_err_collect_show()
         #
         #IF g_success = 'N' THEN 
         #   CALL s_transaction_end('N','1')
         #   RETURN
         #ELSE
         #   CALL s_transaction_end('Y','1')
         #END IF
         #CALL aist310_isaf011_update()
         #150603-00046#1 mark end---
         EXIT MENU
 
      ON ACTION posted
         LET lc_state = "S"
         IF g_isaf_m.isafstus <> 'Y' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00092'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF 
         
         #151209-00023#1--add--str--lujh
         LET l_ooba002 = ''
         LET l_ooba002 = cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-1003')
         IF l_ooba002 <> '3' THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00289'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF     
         
         CALL s_transaction_begin()
         CALL aist310_post('post') RETURNING l_success     
         IF NOT l_success THEN 
            CALL s_transaction_end('N','0')
            RETURN
         ELSE
            CALL s_transaction_end('Y','0')
         END IF
         #151209-00023#1--add--end--lujh
         
         EXIT MENU
	  
      #add-point:stus控制
      #ON ACTION unapproved
      #   LET lc_state = "Y"
      #   
      #   IF g_isaf_m.isafstus <> 'V' THEN 
      #      CALL cl_err(g_isaf_m.isafdocno,'anm-00056',1)
      #      RETURN
      #   END IF 
      
      ON ACTION unposted
         LET lc_state = "Y"
         IF g_isaf_m.isafstus <> 'S' THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00093'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         
         IF NOT cl_null(g_isaf_m.isaf035) THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00136'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         
         #151209-00023#1--add--str--lujh
         LET l_ooba002 = ''
         LET l_ooba002 = cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-1003')
         IF l_ooba002 <> '3' THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00290'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         
         CALL s_transaction_begin()
         CALL aist310_post('unpos') RETURNING l_success
         IF NOT l_success THEN 
            CALL s_transaction_end('N','0')
            RETURN
         ELSE
            CALL s_transaction_end('Y','0')
         END IF
         #151209-00023#1--add--end--lujh
         
         EXIT MENU #150603-00046#1
         
      ON ACTION invalid
         LET lc_state = "X"
         #add-point:action控制
         #IF NOT cl_null(g_isaf_m.isaf011) THEN 
         #   INITIALIZE g_errparam TO NULL
         #   LET g_errparam.code = 'ais-00107'
         #   LET g_errparam.extend = g_isaf_m.isafdocno
         #   LET g_errparam.popup = TRUE
         #   CALL cl_err()
         #   RETURN
         #END IF
         #IF g_isaf_m.isafstus = 'Y' THEN 
         #   INITIALIZE g_errparam TO NULL
         #   LET g_errparam.code = 'anm-00045'
         #   LET g_errparam.extend = g_isaf_m.isafdocno
         #   LET g_errparam.popup = TRUE
         #   CALL cl_err()
         #   RETURN
         #END IF
         
         IF NOT cl_null(g_isaf_m.isaf035) THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00136'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF

         #IF g_isaf_m.isafstus = 'V' THEN
         #   CALL cl_err(g_isaf_m.isafdocno,'anm-00055',1)
         #   RETURN
         #END IF
         IF g_isaf_m.isafstus = 'S' THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'ais-00091'
            LET g_errparam.extend = g_isaf_m.isafdocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN
         END IF
         
         #160304-00023#1 mark ------
         ##此段移到下面去
         #LET l_n = 0
         #SELECT COUNT(*) INTO l_n
         #  FROM isat_t
         # WHERE isatent = g_enterprise
         #   AND isatcomp = g_isaf_m.isafcomp
         #   AND isatdocno = g_isaf_m.isafdocno
         #   AND isat014 <> '12' 
         #   AND isat014 <> '22'
         #IF l_n > 0 THEN 
         #   IF cl_ask_confirm('ais-00194') THEN
         #      CALL aist310_invalid()
         #   ELSE
         #      RETURN
         #   END IF
         #END IF
         #IF g_isaf_m.isafstus = 'Y' THEN
         #   CALL aist310_unconfirm()
         #END IF
         ##151223-00001#3--add--str--lujh
         #CALL aist310_upd_xmdl('','','','-') RETURNING l_success
         #IF l_success = FALSE THEN 
         #   CALL s_transaction_end('N','0')
         #   RETURN
         #END IF
         ##151223-00001#3--add--str--lujh
         #160304-00023#1 mark end---
         
         #IF g_isaf_m.isaf056 = '1' THEN 
         #   UPDATE isat_t SET isat014 = '12'
         #    WHERE isatent = g_enterprise
         #      AND isatcomp = g_isaf_m.isafcomp
         #      AND isatdocno = g_isaf_m.isafdocno
         #ELSE
         #   UPDATE isat_t SET isat014 = '22'
         #    WHERE isatent = g_enterprise
         #      AND isatcomp = g_isaf_m.isafcomp
         #      AND isatdocno = g_isaf_m.isafdocno          
         #END IF
         #IF SQLCA.SQLcode THEN
         #   INITIALIZE g_errparam TO NULL
         #   LET g_errparam.code = SQLCA.sqlcode
         #   LET g_errparam.extend = "update"
         #   LET g_errparam.popup = TRUE
         #   CALL cl_err()
         #
         #   LET g_success = 'N'                         
         #END IF  
         
         #150603-00046#1 mark ------
         #IF g_success = 'N' THEN 
         #   CALL s_transaction_end('N','1')
         #   RETURN
         #ELSE
         #   CALL s_transaction_end('Y','1')
         #END IF
         #150603-00046#1 mark end---
         EXIT MENU

   END MENU
   
   IF (lc_state <> "N" 
      AND lc_state <> "V"
      AND lc_state <> "Y"
      AND lc_state <> "S"
      AND lc_state <> "X"
      ) OR 
      cl_null(lc_state) THEN
      RETURN
   END IF
  
   
   CALL s_transaction_begin() #150603-00046#1
   
   #151125-00001#3 ---add (S)---
   IF lc_state = "X" THEN
      CALL cl_set_comp_entry("isaf037,isaf038,isaf042",TRUE)
      IF NOT cl_ask_confirm('aim-00109') THEN
         CALL s_transaction_end('N','0')
         RETURN
      #160304-00023#1 add ------
      ELSE
         INPUT BY NAME g_isaf_m.isaf037,g_isaf_m.isaf038,g_isaf_m.isaf042 WITHOUT DEFAULTS
            BEFORE INPUT
               LET INT_FLAG = 0
               LET g_isaf_m.isaf039 = g_today
               LET g_isaf_m.isaf040 = cl_get_time()
               LET g_isaf_m.isaf041 = g_user
               LET g_isaf_m.isaf041_desc = s_desc_get_person_desc(g_isaf_m.isaf041)
               DISPLAY BY NAME g_isaf_m.isaf039,g_isaf_m.isaf040,g_isaf_m.isaf041,g_isaf_m.isaf041_desc
            
            ON ACTION controlp INFIELD isaf037
               #作廢
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_isaf_m.isaf037
               LET g_qryparam.arg1 = "3804"
               CALL q_oocq002()
               LET g_isaf_m.isaf037 = g_qryparam.return1
               CALL s_desc_get_acc_desc('3804',g_isaf_m.isaf037) RETURNING g_isaf_m.isaf037_desc
               DISPLAY BY NAME g_isaf_m.isaf037,g_isaf_m.isaf037_desc
               NEXT FIELD isaf037
            
            AFTER FIELD isaf037
               LET g_isaf_m.isaf037_desc = ' '
               IF NOT cl_null(g_isaf_m.isaf037) THEN
                  IF NOT s_azzi650_chk_exist('3804',g_isaf_m.isaf037) THEN
                     LET g_isaf_m.isaf037 = g_isaf_m_t.isaf037
                     CALL s_desc_get_acc_desc('3804',g_isaf_m.isaf037) RETURNING g_isaf_m.isaf037_desc
                     DISPLAY BY NAME g_isaf_m.isaf037_desc
                     NEXT FIELD CURRENT
                  END IF
               ELSE
                  NEXT FIELD CURRENT
               END IF
               CALL s_desc_get_acc_desc('3804',g_isaf_m.isaf037) RETURNING g_isaf_m.isaf037_desc
               DISPLAY BY NAME g_isaf_m.isaf037_desc
            
            AFTER INPUT
               IF NOT cl_null(g_isaf_m.isafcomp) THEN
                  UPDATE isaf_t SET isaf037 = g_isaf_m.isaf037
                                   ,isaf038 = g_isaf_m.isaf038
                                   ,isaf039 = g_isaf_m.isaf039
                                   ,isaf040 = g_isaf_m.isaf040
                                   ,isaf041 = g_isaf_m.isaf041
                                   ,isaf042 = g_isaf_m.isaf042
                   WHERE isafent   = g_enterprise
                     AND isafcomp  = g_isaf_m.isafcomp
                     AND isafdocno = g_isaf_m.isafdocno
               END IF
            ON ACTION accept
               ACCEPT INPUT
           
            ON ACTION cancel
               LET INT_FLAG = 1
               LET g_isaf_m.isaf037 = ''
               LET g_isaf_m.isaf038 = ''
               LET g_isaf_m.isaf042 = ''
               LET g_isaf_m.isaf037_desc = ''
               DISPLAY BY NAME g_isaf_m.isaf037,g_isaf_m.isaf037_desc,g_isaf_m.isaf038,g_isaf_m.isaf042
               EXIT INPUT
               
            IF INT_FLAG THEN
               CALL s_transaction_end('N','0')
               RETURN
            END IF
         END INPUT
         IF cl_null(g_isaf_m.isaf037) THEN
            LET g_isaf_m.isaf038 = ''
            LET g_isaf_m.isaf042 = ''
            LET lc_state = g_isaf_m.isafstus
            CALL s_transaction_end('N','0')
            DISPLAY BY NAME g_isaf_m.isaf037,g_isaf_m.isaf037_desc,g_isaf_m.isafstus
            RETURN
         END IF
         
         LET l_n = 0
         #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
         SELECT COUNT(1) INTO l_n #160907-00046#1
           FROM isat_t
          WHERE isatent = g_enterprise
            AND isatcomp = g_isaf_m.isafcomp
            AND isatdocno = g_isaf_m.isafdocno
            AND isat014 <> '12' 
            AND isat014 <> '22'
         IF l_n > 0 THEN 
            IF cl_ask_confirm('ais-00194') THEN
               CALL aist310_invalid()
               #160510-00020#1 mark ------
               #下面已有回寫，故此mark不然會重複多扣
               ##160413-00018#1 ---s---
               #CALL aist310_upd_xmdl('','','','-') RETURNING g_sub_success
               #IF NOT g_sub_success THEN
               #   CALL s_transaction_end('N','0')
               #   RETURN
               #END IF
               ##160413-00018#1---e---
               #160510-00020#1 mark end---
            ELSE
               LET g_isaf_m.isaf037 = ''
               LET g_isaf_m.isaf038 = ''
               LET g_isaf_m.isaf042 = ''
               LET g_isaf_m.isaf037_desc = ''
               DISPLAY BY NAME g_isaf_m.isaf037,g_isaf_m.isaf037_desc,g_isaf_m.isaf038,g_isaf_m.isaf042
               CALL s_transaction_end('N','0')
               RETURN
            END IF
         END IF
         
         #160308-00006#2 add ------
         #先取得該發票簿下次列印號碼
         SELECT isae012 INTO l_isae012
           FROM isae_t
          WHERE isaeent  = g_enterprise
            AND isaesite = g_isaf_m.isaf052
            AND isae001  = g_isaf_m.isaf051
            AND isae002 <= g_isaf_m.isaf014
            AND isae003 >= g_isaf_m.isaf014
            AND isae004  = g_isaf_m.isaf008    #albireo 160721 無單
         LET l_isae012_o = g_isaf_m.isaf011
         IF g_isai002 = '1' THEN
            LET l_isae012_o = g_isaf_m.isaf011[3,10]
         END IF
         LET l_date = cl_get_current()   #170120-00040#1
         #若有要回收發票號碼，最終狀態isat025='14'發票號碼回收
         IF cl_ask_confirm('ais-00313') THEN
            UPDATE isat_t
               SET isat025 = '14'
             WHERE isatent = g_enterprise
               AND isatcomp = g_isaf_m.isafcomp
               AND isatdocno = g_isaf_m.isafdocno
            #作廢的發票記錄也要改成發票回收
            UPDATE isat_t
               SET isat014 = '14'
             WHERE isatent = g_enterprise
               AND isatcomp = g_isaf_m.isafcomp
               AND isatdocno = g_isaf_m.isafdocno
               AND isat014 = '12'
            #若單據狀態=N時作廢，回收發票號碼，下次列印號碼要從現在這張開始
            IF l_isae012-l_isae012_o=1 AND g_isaf_m.isafstus = 'Y' THEN
               LET l_isae012_str = l_isae012_o
               LET l_len = l_isae012_str.getLength()
               LET l_sql = "SELECT lpad('",l_isae012_o,"',",l_len,",'0') FROM dual"
               PREPARE isae012_change_pre2 FROM l_sql
               EXECUTE isae012_change_pre2 INTO l_isae012_o
               UPDATE isae_t SET isae012 = l_isae012_o,     #發票簿下次列印號碼
                                 isae013 = isae013 - 1      #已開張數
                                ,isaemodid = g_user         #170120-00040#1
                                ,isaemoddt = l_date         #170120-00040#1
                WHERE isaeent  = g_enterprise
                  AND isaesite = g_isaf_m.isaf052
                  AND isae001  = g_isaf_m.isaf051
                  AND isae002 <= g_isaf_m.isaf014
                  AND isae003 >= g_isaf_m.isaf014
            END IF
         ELSE
            #若單據狀態=N時作廢，不回收發票號碼，下次列印號碼要+1
            IF l_isae012_o = l_isae012 AND g_isaf_m.isafstus = 'N' THEN
               LET l_isae012_str = l_isae012
               LET l_len = l_isae012_str.getLength()
               LET l_sql = "SELECT lpad('",l_isae012,"'+1,",l_len,",'0') FROM dual"
               PREPARE isae012_change_pre3 FROM l_sql
               EXECUTE isae012_change_pre3 INTO l_isae012
               UPDATE isae_t SET isae012 = l_isae012,    #發票簿下次列印號碼
                                 isae013 = isae013 + 1   #已開張數
                                ,isaemodid = g_user      #170120-00040#1
                                ,isaemoddt = l_date      #170120-00040#1
                WHERE isaeent  = g_enterprise
                  AND isaesite = g_isaf_m.isaf052
                  AND isae001  = g_isaf_m.isaf051
                  AND isae002 <= g_isaf_m.isaf014
                  AND isae003 >= g_isaf_m.isaf014
            END IF
         END IF
         #160308-00006#2 add end---
         
         IF g_isaf_m.isafstus = 'Y' THEN
            #CALL aist310_unconfirm()     #160308-00006#2 mark
            #160308-00006#2 add ------
            #albireo #150915-00009#3-----s
            IF g_isaf_m.isaf056 = '2' THEN
               #回寫折讓金額
               CALL s_aisp320_upd_source_isat(g_isaf_m.isafcomp,g_isaf_m.isafdocno,'-')
                  RETURNING g_sub_success
               IF NOT g_sub_success THEN
                  LET g_success = 'N'
               END IF
            END IF
            #albireo #150915-00009#3-----e
            #160308-00006#2 add end---
         END IF
         
         #151223-00001#3--add--str--lujh
         CALL aist310_upd_xmdl('','','','-') RETURNING l_success
         IF l_success = FALSE THEN 
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         #151223-00001#3--add--str--lujh
      #160304-00023#1 add end---
         #160614-00025#1 --s add
         #作廢時,更新單身來源類型為13/22的單據發票為空
         LET l_isag002 = ''
         LET l_date = cl_get_current()
         LET l_sql = "SELECT DISTINCT isag002 FROM isag_t ",
                     " WHERE isagent = '",g_enterprise,"'",
                     "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
                     "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
                     "   AND isag001 IN ('13','22') "
         PREPARE isag_upd_rtia014_pre1 FROM l_sql
         DECLARE isag_upd_rtia014_cs1 CURSOR FOR isag_upd_rtia014_pre1
         FOREACH isag_upd_rtia014_cs1 INTO l_isag002
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "FOREACH: isag_upd_rtia014_cs1 "
               LET g_errparam.popup = TRUE
               CALL cl_err()
               EXIT FOREACH
            END IF
            LET l_rtia014 = ''
            LET l_rtia015 = ''
            SELECT rtia014,rtia015 INTO l_rtia014,l_rtia015 FROM rtia_t
             WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
            IF NOT cl_null(l_rtia014) OR NOT cl_null(l_rtia015) THEN
               UPDATE rtia_t SET (rtia014,rtia015,rtiamodid,rtiamoddt) = ('','',g_user,l_date)
                WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
               IF SQLCA.SQLERRD[3] = 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = FALSE
                  CALL cl_err()
                  CALL s_transaction_end('N','0') 
                  RETURN
               END IF
            END IF
         END FOREACH
         #160614-00025#1 --e add
      END IF
   END IF
   #151125-00001#3 ---add (E)---

  #LET g_success = 'Y' #150603-00046#1 mark
   
   IF lc_state = 'Y' THEN 
      LET l_today  = cl_get_current() 
      UPDATE isaf_t SET isafcnfid = g_user,
                        isafcnfdt = l_today,
                        isaf007 = ''
       WHERE isafent = g_enterprise 
         AND isafdocno = g_isaf_m.isafdocno
         AND isafcomp = g_isaf_m.isafcomp
      LET g_isaf_m.isafcnfid = g_user
      LET g_isaf_m.isafcnfdt = l_today
      
      #150603-00046#1 add ------
      IF SQLCA.SQLERRD[3] = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ""
         LET g_errparam.popup = FALSE
         CALL cl_err()
        #LET l_success = FALSE           #160413-00019#1 mark
         CALL s_transaction_end('N','0') #160413-00019#1
         RETURN                          #160413-00019#1
      ELSE
        #CALL aist310_confirm()                     #160413-00019#1 mark
         #160413-00019#1 add ------
         CALL aist310_confirm() RETURNING r_success
         IF r_success = 'N' THEN 
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         #160413-00019#1 add end---
         #170116-00020#1 mark ------
         #LET l_n = 0
         ##SELECT COUNT(*) INTO l_n #160907-00046#1 mark
         #SELECT COUNT(1) INTO l_n #160907-00046#1
         #  FROM isat_t
         # WHERE isatent = g_enterprise
         #   AND isatcomp = g_isaf_m.isafcomp
         #   AND isatdocno = g_isaf_m.isafdocno
         #IF cl_null(l_n) THEN LET l_n = 0 END IF
         #IF l_n = 0 THEN 
         #   CALL aist310_isat_ins() RETURNING r_success
         #   IF r_success = 'N' THEN 
         #     #LET l_success = FALSE           #160413-00019#1 mark
         #      CALL s_transaction_end('N','0') #160413-00019#1
         #      RETURN                          #160413-00019#1
         #   END IF
         #END IF
         #CALL aist310_isaf011_update()
         #170116-00020#1 mark end---
      END IF
      
      #150603-00046#1 add end---
      #150603-00046#1 mark ------
      #IF g_success = 'Y' THEN
      #   CALL s_transaction_end('Y','1')
      #END IF
      #IF g_success = 'N' THEN
      #   CALL s_transaction_end('N','1')
      #END IF
      #150603-00046#1 mark end---
   END IF
   
   IF lc_state = 'N' THEN 
      UPDATE isaf_t SET isafcnfid = '',
                        isafcnfdt = ''
       WHERE isafent = g_enterprise 
         AND isafdocno = g_isaf_m.isafdocno
         AND isafcomp = g_isaf_m.isafcomp
      LET g_isaf_m.isafcnfid = ''
      LET g_isaf_m.isafcnfdt = ''  
      #150603-00046#1 add ------
      IF SQLCA.SQLERRD[3] = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ""
         LET g_errparam.popup = FALSE
         CALL cl_err()
        #LET l_success = FALSE           #160413-00019#1 mark
         CALL s_transaction_end('N','0') #160413-00019#1
         RETURN                          #160413-00019#1
      END IF
      #150603-00046#1 add end---  
      #150603-00046#1 mark ------
      #IF g_success = 'Y' THEN
      #   CALL s_transaction_end('Y','1')
      #END IF
      #IF g_success = 'N' THEN
      #   CALL s_transaction_end('N','1')
      #END IF
      #150603-00046#1 mark end---
      
      #160614-00025#2-s
      #取消確認時,更新單身來源類型為13/22的單據發票為空
      LET l_isag002 = ''
      LET l_date = cl_get_current()
      LET l_sql = "SELECT DISTINCT isag002 FROM isag_t ",
                  " WHERE isagent = '",g_enterprise,"'",
                  "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
                  "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
                  "   AND isag001 IN ('13','22') "
      PREPARE isag_upd_rtia014_pre2 FROM l_sql
      DECLARE isag_upd_rtia014_cs2 CURSOR FOR isag_upd_rtia014_pre2
      FOREACH isag_upd_rtia014_cs2 INTO l_isag002
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "FOREACH: isag_upd_rtia014_cs2 "
            LET g_errparam.popup = TRUE
            CALL cl_err()
            EXIT FOREACH
         END IF
         LET l_rtia014 = ''
         LET l_rtia015 = ''
         SELECT rtia014,rtia015 INTO l_rtia014,l_rtia015 FROM rtia_t
          WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
         IF NOT cl_null(l_rtia014) OR NOT cl_null(l_rtia015) THEN
            UPDATE rtia_t SET (rtia014,rtia015,rtiamodid,rtiamoddt) = ('','',g_user,l_date)
             WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
            IF SQLCA.SQLERRD[3] = 0 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = ""
               LET g_errparam.popup = FALSE
               CALL cl_err()
               CALL s_transaction_end('N','0') 
               RETURN
            END IF
         END IF
      END FOREACH
      #160614-00025#2-e
      
   END IF
   
   IF lc_state = 'S' THEN
      UPDATE isaf_t SET isaf007 = g_today
       WHERE isafent = g_enterprise 
         AND isafdocno = g_isaf_m.isafdocno
         AND isafcomp = g_isaf_m.isafcomp
      #150603-00046#1 add ------
      IF SQLCA.SQLERRD[3] = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ""
         LET g_errparam.popup = FALSE
         CALL cl_err()
        #LET l_success = FALSE           #160413-00019#1 mark
         CALL s_transaction_end('N','0') #160413-00019#1
         RETURN                          #160413-00019#1
      END IF
      
      #150603-00046#1 add end---
      #150603-00046#1 mark ------
      #IF g_success = 'Y' THEN
      #   CALL s_transaction_end('Y','1')
      #END IF
      #IF g_success = 'N' THEN
      #   CALL s_transaction_end('N','1')
      #END IF
      #150603-00046#1 mark end---
   END IF
   
   UPDATE isaf_t SET isafstus = lc_state 
    WHERE isafent = g_enterprise AND isafcomp = g_isaf_m.isafcomp
      AND isafdocno = g_isaf_m.isafdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
     #LET l_success = FALSE  #150603-00046#1 #160413-00019#1 mark
      CALL s_transaction_end('N','0') #160413-00019#1
      RETURN                          #160413-00019#1
   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/open.png")
         WHEN "V"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/verify.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
      END CASE
      LET g_isaf_m.isafstus = lc_state
      DISPLAY BY NAME g_isaf_m.isafstus
   END IF
   
   #150603-00046#1 add ------
   IF NOT l_success THEN 
      CALL s_transaction_end('N','0')
      RETURN
   ELSE
      CALL s_transaction_end('Y','0')
   END IF
   #150603-00046#1 add end---
   
   CALL aist310_show()

END FUNCTION
# 審核
PRIVATE FUNCTION aist310_confirm()
DEFINE l_isah103_sum            LIKE isah_t.isah103
DEFINE l_isah104_sum            LIKE isah_t.isah104
DEFINE l_isah105_sum            LIKE isah_t.isah105
DEFINE l_isag103_sum            LIKE isag_t.isag103
DEFINE l_isag104_sum            LIKE isag_t.isag104
DEFINE l_isag105_sum            LIKE isag_t.isag105
DEFINE l_n                      LIKE type_t.num5
DEFINE l_isag004                LIKE isag_t.isag004
DEFINE l_isag001                LIKE isag_t.isag001
DEFINE l_isag002                LIKE isag_t.isag002
DEFINE l_isag003                LIKE isag_t.isag003
DEFINE l_len                    LIKE type_t.num5
DEFINE l_isae012                LIKE isae_t.isae012    
DEFINE l_isae012_n              LIKE isae_t.isae012    #下次列印號碼
DEFINE l_isae012_max            LIKE isae_t.isae012
DEFINE l_cnt                    LIKE type_t.num5
DEFINE l_isae012_str            STRING
DEFINE l_xmdl047                LIKE xmdl_t.xmdl047
DEFINE l_isag115_sum            LIKE isag_t.isag115
DEFINE l_sql                    STRING
#albireo 151030-----s
DEFINE l_isae010                LIKE isae_t.isae010
DEFINE l_isae007                LIKE isae_t.isae007
DEFINE l_str                    STRING
#DEFINE l_isai008                LIKE isai_t.isai008 #160803-00044#1 mark
#DEFINE l_ooef019                LIKE ooef_t.ooef019 #160803-00044#1 mark
#albireo 151030-----e
#160623-00019#1-s
DEFINE l_sfin2022               LIKE type_t.chr10
DEFINE l_xmdk006                LIKE xmdk_t.xmdk006
DEFINE l_xrca019                LIKE xrca_t.xrca019
#160623-00019#1-e
#160614-00025#2-s
DEFINE l_rtia014                LIKE rtia_t.rtia014
DEFINE l_rtia015                LIKE rtia_t.rtia015
DEFINE l_date                   DATETIME YEAR TO SECOND
DEFINE l_rtib_cnt               LIKE type_t.num5
DEFINE l_isag_cnt               LIKE type_t.num5
#160614-00025#2-e
DEFINE l_count                  LIKE type_t.num5
DEFINE r_success                LIKE type_t.chr1        #160413-00019#1

  #LET g_success = 'Y' #160413-00019#1 mark
   LET r_success = 'Y' #160413-00019#1
   
   LET l_isah103_sum = 0
   LET l_isah104_sum = 0
   LET l_isah105_sum = 0
   LET l_isag103_sum = 0
   LET l_isag104_sum = 0
   LET l_isag105_sum = 0
   
   #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
   SELECT COUNT(1) INTO l_n  #160907-00046#1
     FROM isag_t
    WHERE isagent = g_enterprise
      AND isagdocno = g_isaf_m.isafdocno
      AND isagcomp = g_isaf_m.isafcomp
   IF l_n = 0 THEN
     #RETURN           #160413-00019#1 mark
      RETURN r_success #160413-00019#1
   END IF
   
   SELECT SUM(isah103*isah010),SUM(isah104*isah010),SUM(isah105*isah010)
     INTO l_isah103_sum,l_isah104_sum,l_isah105_sum
     FROM isah_t
    WHERE isahent = g_enterprise
      AND isahdocno = g_isaf_m.isafdocno
      AND isahcomp = g_isaf_m.isafcomp
      
   SELECT SUM(isag103*isag015),SUM(isag104*isag015),SUM(isag105*isag015)
     INTO l_isag103_sum,l_isag104_sum,l_isag105_sum
     FROM isag_t
    WHERE isagent = g_enterprise
      AND isagdocno = g_isaf_m.isafdocno
      AND isagcomp = g_isaf_m.isafcomp
      AND (isag018 = 'Y' OR isag018 IS NULL) #160823-00016#1
   
   #161214-00053#1 add ------
   IF g_isai004 = '1' THEN
      IF l_isah103_sum < 0 THEN LET l_isah103_sum = l_isah103_sum * -1 END IF
      IF l_isah104_sum < 0 THEN LET l_isah104_sum = l_isah104_sum * -1 END IF
      IF l_isah105_sum < 0 THEN LET l_isah105_sum = l_isah105_sum * -1 END IF
      IF l_isag103_sum < 0 THEN LET l_isag103_sum = l_isag103_sum * -1 END IF
      IF l_isag104_sum < 0 THEN LET l_isag104_sum = l_isag104_sum * -1 END IF
      IF l_isag105_sum < 0 THEN LET l_isag105_sum = l_isag105_sum * -1 END IF
   END IF
   #161214-00053#1 add end---
   
   IF g_isaf_m.isaf105 <> l_isah105_sum OR g_isaf_m.isaf105 <> l_isag105_sum THEN 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ais-00106'
      LET g_errparam.extend = g_isaf_m.isaf105
      LET g_errparam.popup = TRUE
      CALL cl_err()
      #LET g_success = 'N'
      #RETURN
      LET r_success = 'N'   #160413-00019#1
      RETURN r_success      #160413-00019#1
   END IF 
   
   #150603-00046#1 mark ------
   #IF g_isaf_m.isaf056 = '1' THEN
   #   SELECT SUM(isag115 * isag015) INTO l_isag115_sum FROM isag_t
   #    WHERE isagent = g_enterprise
   #      AND isagcomp = g_isaf_m.isafcomp
   #      AND isagdocno = g_isaf_m.isafdocno
   #   
   #   IF l_isag115_sum < 0 THEN 
   #      INITIALIZE g_errparam TO NULL 
   #      LET g_errparam.extend = "" 
   #      LET g_errparam.code   = "ais-00159" 
   #      LET g_errparam.popup  = TRUE 
   #      CALL cl_err()
   #      LET g_success = 'N'
   #      RETURN
   #   END IF
   #END IF
   #150603-00046#1 mark end---
   
   IF cl_null(g_isaf_m.isaf003) AND cl_null(g_isaf_m.isaf055) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ""
      LET g_errparam.code   = "ais-00167"
      LET g_errparam.popup  = TRUE
      CALL cl_err()
     #LET g_success = 'N'   #160413-00019#1 mark
     #RETURN                #160413-00019#1 mark
      LET r_success = 'N'   #160413-00019#1
      RETURN r_success      #160413-00019#1
   END IF
   
   #160803-00044#1 mark ------
   ##albireo 151030-----s
   ##增加國別條件
   #LET l_ooef019 = NULL
   #SELECT ooef019
   #  INTO l_ooef019
   #  FROM ooef_t
   # WHERE ooefent = g_enterprise
   #   AND ooef001 = g_isaf_m.isafcomp
   #   AND ooefstus = 'Y'
   #
   #LET l_isai008 = NULL
   #SELECT isai008
   #  INTO l_isai008
   #  FROM isai_t
   # WHERE isaient = g_enterprise
   #   AND isai001 = l_ooef019
   ##albireo 151030-----e
   #160803-00044#1 mark end---
   
   #170116-00020#1 mark ------
   ##151209-00019#1-----s
   ##IF l_isai008 = 'TW' THEN #160803-00044#1 mark
   #IF g_isai002 = '1' THEN   #160803-00044#1
   #   IF NOT cl_null(g_isaf_m.isaf011) THEN
   #      LET l_cnt = NULL
   #      #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
   #      SELECT COUNT(1) INTO l_cnt  #160907-00046#1 
   #        FROM isat_t
   #       WHERE isatent = g_enterprise
   #         AND isatdocno = g_isaf_m.isafdocno
   #         AND isatcomp  = g_isaf_m.isafcomp
   #         AND isat004   = g_isaf_m.isaf011
   #   ELSE
   #      LET l_cnt = 1
   #   END IF
   #ELSE
   #   IF NOT cl_null(g_isaf_m.isaf011) AND NOT cl_null(g_isaf_m.isaf010)THEN
   #      LET l_cnt = NULL
   #      #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
   #      SELECT COUNT(1) INTO l_cnt  #160907-00046#1
   #        FROM isat_t
   #       WHERE isatent = g_enterprise
   #         AND isatdocno = g_isaf_m.isafdocno
   #         AND isatcomp  = g_isaf_m.isafcomp
   #         AND isat003   = g_isaf_m.isaf010
   #         AND isat004   = g_isaf_m.isaf011
   #   ELSE
   #      LET l_cnt = 1
   #   END IF
   #END IF
   #IF cl_null(l_cnt)THEN LET l_cnt = 0 END IF
   #IF l_cnt = 0 AND g_isaf_m.isaf011 <> 'MULTI' THEN    #albireo 160506 add g_isaf_m.isaf011 <> 'MULTI'
   #   INITIALIZE g_errparam.* TO NULL
   #   LET g_errparam.code = 'ais-00252'
   #   LET g_errparam.extend = ''
   #   CALL cl_err()
   #  #LET g_success = 'N'   #160413-00019#1 mark
   #  #RETURN                #160413-00019#1 mark
   #   LET r_success = 'N'   #160413-00019#1
   #   RETURN r_success      #160413-00019#1
   #END IF
   ##151209-00019#1-----e
   #170116-00020#1 mark end---
   
   #151223-00001#3--mark--str--lujh
   #LET g_sql = "SELECT isag001,isag002,isag003,isag004 ",
   #            "  FROM isag_t ",
   #            " WHERE isagent = '",g_enterprise,"'",
   #            "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
   #            "   AND isagcomp = '",g_isaf_m.isafcomp,"'"
   #PREPARE isag_pre_1 FROM g_sql
   #DECLARE isag_cur_1 CURSOR FOR isag_pre_1              
   #            
   #FOREACH isag_cur_1 INTO l_isag001,l_isag002,l_isag003,l_isag004          
   #   IF SQLCA.sqlcode THEN
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "FOREACH:"
   #      LET g_errparam.popup = TRUE
   #      CALL cl_err()
   #      EXIT FOREACH
   #   END IF   
   #   
   #   #IF l_isag001 = 'axmt500' THEN 
   #   IF l_isag001 = '10' THEN
   #      UPDATE xmdb_t SET xmdb016 = g_isaf_m.isaf103 
   #       WHERE xmdbent = g_enterprise
   #         AND xmdbdocno = l_isag002 
   #         AND xmdb001 = l_isag003  # 期別
   #   END IF
   #   
   #   #IF l_isag001 = 'axmt540' OR l_isag001 = 'axmt600' THEN 
   #   IF l_isag001 = '11' OR l_isag001 = '21' THEN
   #      #IF l_isag001 = 'axmt600' THEN 
   #      #   IF l_isag004 < 0 THEN 
   #      #      LET l_isag004 = l_isag004 * -1
   #      #   END IF
   #      #END IF
   #      
   #      SELECT xmdl047 INTO l_xmdl047
   #        FROM xmdl_t
   #       WHERE xmdlent = g_enterprise
   #         AND xmdldocno = l_isag002 
   #         AND xmdlseq = l_isag003 
   #      
   #      IF cl_null(l_xmdl047) THEN 
   #         LET l_xmdl047 = 0
   #      END IF
   #      
   #      UPDATE xmdl_t SET xmdl047 = l_xmdl047 + l_isag004  #已開發票數量
   #       WHERE xmdlent = g_enterprise
   #         AND xmdldocno = l_isag002 
   #         AND xmdlseq = l_isag003 
   #   END IF
   #   
   #   IF SQLCA.SQLcode THEN
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "update"
   #      LET g_errparam.popup = TRUE
   #      CALL cl_err()
   #      LET g_success = 'N'
   #      EXIT FOREACH
   #   END IF
   #   
   #END FOREACH
   #151223-00001#3--mark--end--lujh   

      
   #151209-00019#1-----s   
   #本次开立的最大的发票
   #SELECT MAX(isah002) INTO l_isae012
   #  FROM isah_t
   # WHERE isahent = g_enterprise
   #   AND isahcomp = g_isaf_m.isafcomp
   #   AND isahdocno = g_isaf_m.isafdocno
   #

   #本次開立最大的發票取isat發票歷程檔中
   SELECT MAX(isat004) INTO l_isae012
     FROM isat_t
    WHERE isatent = g_enterprise
      AND isatcomp = g_isaf_m.isafcomp
      AND isatdocno = g_isaf_m.isafdocno   
   #151209-00019#1-----e
#   #150717--(S)
#   IF g_isai002 = '1' THEN
#      LET l_isae012 = l_isae012[3,10]
#   END IF
#   #150717--(E)

   #albireo 151030-----s
   SELECT isae010,isae007
     INTO l_isae010,l_isae007
     FROM isae_t
    WHERE isaeent  = g_enterprise
      AND isaesite = g_isaf_m.isaf052
      AND isae001  = g_isaf_m.isaf051
      AND isae002 <= g_isaf_m.isaf014
      AND isae003 >= g_isaf_m.isaf014
      AND isae004  = g_isaf_m.isaf008   #albireo 160721 無單
  #IF l_isai008 = 'TW' THEN #160803-00044#1 mark
   IF g_isai002 = '1' THEN  #160803-00044#1
      IF NOT cl_null(l_isae007)THEN
         LET l_str = cl_replace_str(l_isae012,l_isae007,'')
         LET l_isae012 = l_str.trim()
      END IF
   END IF
   #albireo 151030-----e

   #计算下次列印号码
   LET l_isae012_str = l_isae012
   LET l_len = l_isae012_str.getLength()
   LET l_sql = "SELECT lpad('",l_isae012,"'+1,",l_len,",'0') FROM dual"
   PREPARE isae012_pre2 FROM l_sql
   EXECUTE isae012_pre2 INTO l_isae012_n

   #151209-00019#1-----s
#   #本次开了几张发票
#   SELECT COUNT(DISTINCT isah002) INTO l_cnt
#     FROM isah_t
#    WHERE isahent = g_enterprise
#      AND isahcomp = g_isaf_m.isafcomp
#      AND isahdocno = g_isaf_m.isafdocno  

   #總共開了幾張發票改取發票歷程檔的計算
   SELECT COUNT(DISTINCT isat004) INTO l_cnt
     FROM isat_t
    WHERE isatent = g_enterprise
      AND isatcomp = g_isaf_m.isafcomp
      AND isatdocno = g_isaf_m.isafdocno  
   #151209-00019#1-----e

   IF l_cnt > 0 THEN   #151209-00019#1 add
      LET l_date = cl_get_current()   #170120-00040#1
      IF g_isaf_m.isaf056 = '2' AND g_isai006 = 'Y' THEN
         UPDATE isae_t SET isae012 = l_isae012_n,       #發票簿下次列印號碼
                           isae013 = isae013 + l_cnt,   #已開張數 
                           isae014 = g_isaf_m.isaf014   #已開發票日期 = 目前列印發票日期
                          ,isaemodid = g_user           #170120-00040#1
                          ,isaemoddt = l_date           #170120-00040#1
          WHERE isaeent  = g_enterprise
            AND isaesite = g_isaf_m.isaf052
            AND isae001  = g_isaf_m.isaf051
            AND isae002 <= g_isaf_m.isaf014
            AND isae003 >= g_isaf_m.isaf014
      ELSE
         UPDATE isae_t SET isae012 = l_isae012_n,       #發票簿下次列印號碼
                           isae013 = isae013 + l_cnt,   #已開張數 
                           isae014 = g_isaf_m.isaf014   #已開發票日期 = 目前列印發票日期
                          ,isaemodid = g_user           #170120-00040#1
                          ,isaemoddt = l_date           #170120-00040#1
          WHERE isaeent  = g_enterprise
            AND isaesite = g_isaf_m.isaf052
            AND isae001  = g_isaf_m.isaf051
            AND isae002 <= g_isaf_m.isaf014
            AND isae003 >= g_isaf_m.isaf014
            AND isae004  = g_isaf_m.isaf008
      END IF
      IF SQLCA.SQLcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "update"
         LET g_errparam.popup = TRUE
         CALL cl_err()
        #LET g_success = 'N'   #160413-00019#1 mark
         LET r_success = 'N'   #160413-00019#1
         RETURN r_success      #160413-00019#1
      END IF
   END IF    ##151209-00019#1 add

   #albireo #150915-00009#3-----s
   IF g_isaf_m.isaf056 = '2' THEN
      #回寫折讓金額
      CALL s_aisp320_upd_source_isat(g_isaf_m.isafcomp,g_isaf_m.isafdocno,'+')
         RETURNING g_sub_success
      IF NOT g_sub_success THEN
         #LET g_success = 'N'   #160413-00019#1 mark
          LET r_success = 'N'   #160413-00019#1
          RETURN r_success      #160413-00019#1
      END IF
   END IF
   #albireo #150915-00009#3-----e
   
   
   #160623-00019#1-s
   #2.單據確認時，檢查出貨對應的待抵，若無維護則提示錯誤訊息
   LET l_sfin2022 = cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-2022')
   LET l_sql = "SELECT DISTINCT isag002",
               "  FROM isag_t",
               " WHERE isagent = ",g_enterprise,
               "   AND isagcomp ='",g_isaf_m.isafcomp,"'",
               "   AND isagdocno ='",g_isaf_m.isafdocno,"'",
               "   AND isag001 = '11'"  #出貨單
   PREPARE aist310_sel_pre1 FROM l_sql
   DECLARE aist310_sel_cur1 CURSOR FOR aist310_sel_pre1
   
   LET l_sql = "SELECT DISTINCT xmdk006",
               "  FROM xmdk_t",
               " WHERE xmdkent = ",g_enterprise,
               "   AND xmdkdocno = ? "
   PREPARE aist310_sel_pre2 FROM l_sql
   #先撈取出貨單號
   FOREACH aist310_sel_cur1 INTO l_isag002
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = 'N'
         RETURN r_success
         EXIT FOREACH
      END IF
      
      #取得訂單單號
      EXECUTE aist310_sel_pre2 USING l_isag002 INTO l_xmdk006
      
      #計算有沒有訂金發票的待抵單號
      CASE
         WHEN l_sfin2022 = '01'  #認列收入
            SELECT xrcbdocno INTO l_xrca019
              FROM xrcb_t
             WHERE xrcbent = g_enterprise
               AND xrcb002 = l_xmdk006
         WHEN l_sfin2022 = '02'  #認列預收
            #161123-00012#1 mark ------
            #SELECT xrca019 INTO l_xrca019
            #  FROM xrca_t
            # WHERE xrcaent = g_enterprise
            #   AND xrca018 = l_xmdk006
            #161123-00012#1 mark end---
            #161123-00012#1 add ------
            #因為單頭來源有可能是10.訂單&12.銷項發票，但單身都有紀錄訂單單號，所以改串單身取得單頭的待抵單號
            SELECT xrca019 INTO l_xrca019
              FROM xrca_t
              LEFT JOIN xrcb_t ON xrcaent=xrcbent AND xrcadocno=xrcbdocno AND xrcald=xrcbld
             WHERE xrcaent = g_enterprise
               AND xrcb002 = l_xmdk006
            #161123-00012#1 add end---
      END CASE
      
      #有待抵單才進來檢查
      IF NOT cl_null(l_xrca019) THEN   #160706-00024#1
         #檢查此張對帳單是否有打該待抵單
         LET l_cnt = 0
         #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
         SELECT COUNT(1) INTO l_cnt  #160907-00046#1
           FROM isag_t
          WHERE isagent = g_enterprise
            AND isagcomp = g_isaf_m.isafcomp
            AND isagdocno = g_isaf_m.isafdocno
            AND isag002 = l_xrca019
         IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
         IF l_cnt = 0 THEN
            INITIALIZE g_errparam.* TO NULL
            LET g_errparam.code = 'ais-00331'
            LET g_errparam.extend = ''
            LET g_errparam.replace[1] = l_isag002
            LET g_errparam.replace[2] = l_xrca019
            CALL cl_err()
            LET r_success = 'N'   #160920-00032#1 mark #161123-00012#1 remark
            RETURN r_success
         END IF
      END IF  #160706-00024#1
   END FOREACH
   #160623-00019#1-e
   
   #160614-00025#2-s
   #檢查門店銷售單項次數量是否與對帳單單身的門市銷售單項次數量一致
   LET l_sql = "SELECT DISTINCT isag001,isag002",
               "  FROM isag_t",
               " WHERE isagent = ",g_enterprise,
               "   AND isagcomp ='",g_isaf_m.isafcomp,"'",
               "   AND isagdocno ='",g_isaf_m.isafdocno,"'",
               "   AND isag001 IN ('13','22')"  #13:門店銷售單|22:門店銷退單
   PREPARE aist310_sel_pre3 FROM l_sql
   DECLARE aist310_sel_cur3 CURSOR FOR aist310_sel_pre3
   
   #LET l_sql = "SELECT COUNT(*)", #160907-00046#1 mark
   LET l_sql = "SELECT COUNT(1)",  #160907-00046#1
               "  FROM rtib_t",
               " WHERE rtibent = ",g_enterprise,
               "   AND rtibdocno = ? "
   PREPARE aist310_sel_rtib_pre FROM l_sql
   
   #LET l_sql = "SELECT COUNT(*)", #160907-00046#1 mark
   LET l_sql = "SELECT COUNT(1)",  #160907-00046#1
               "  FROM isag_t",
               " WHERE isagent = ",g_enterprise,
               "   AND isagcomp ='",g_isaf_m.isafcomp,"'",
               "   AND isagdocno ='",g_isaf_m.isafdocno,"'",
               "   AND isag002 = ? "
   PREPARE aist310_sel_pre4 FROM l_sql
   
   FOREACH aist310_sel_cur3 INTO l_isag001,l_isag002
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:aist310_sel_cur3"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = 'N'
         RETURN r_success
         EXIT FOREACH
      END IF

      #取得原始門店單項次數量
      EXECUTE aist310_sel_rtib_pre USING l_isag002 INTO l_rtib_cnt
      IF cl_null(l_rtib_cnt) THEN LET l_rtib_cnt = 0 END IF
      
      #取得該對帳單裡面門店單項次數量
      EXECUTE aist310_sel_pre4 USING l_isag002 INTO l_isag_cnt
      IF cl_null(l_isag_cnt) THEN LET l_isag_cnt = 0 END IF
      
      IF l_rtib_cnt <> l_isag_cnt THEN
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'ais-00337'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = l_isag002
         LET g_errparam.replace[2] = l_rtib_cnt
         LET g_errparam.replace[3] = l_isag_cnt
         CALL cl_err()
         LET r_success = 'N'
         RETURN r_success
      ELSE
         LET l_date = cl_get_current()
         IF l_isag001 = '13' THEN
            #13銷售單
            LET l_rtia014 = g_isaf_m.isaf011
         ELSE
            #22銷退單
            LET l_rtia014 = ''
            SELECT isat004 INTO l_rtia014
              FROM isat_t
              LEFT JOIN isaf_t ON isatent = isafent AND isatcomp = isafcomp AND isatdocno = isafdocno
             WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp
               AND isatdocno = g_isaf_m.isafdocno AND isat014 = '21' AND isat025 <> '22'
            IF cl_null(l_rtia014) THEN LET l_rtia014 = g_isag_d[l_ac].isag014 END IF
            
         END IF
         UPDATE rtia_t SET (rtia014,rtia015,rtiamodid,rtiamoddt)
                         = (l_rtia014,l_rtia014,g_user,l_date)
          WHERE rtiaent = g_enterprise AND rtiadocno = l_isag002
         IF SQLCA.SQLERRD[3] = 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = ""
            LET g_errparam.popup = FALSE
            CALL cl_err()
            LET r_success = 'N'
            RETURN r_success
         END IF
      END IF
   END FOREACH
   #160614-00025#2-e
   

   RETURN r_success      #160413-00019#1
  
END FUNCTION
# 取消審核
PRIVATE FUNCTION aist310_unconfirm()
   DEFINE l_isag009                LIKE isag_t.isag009
   DEFINE l_isag010                LIKE isag_t.isag010
   DEFINE l_isag004                LIKE isag_t.isag004
   DEFINE l_isag001                LIKE isag_t.isag001
   DEFINE l_isag002                LIKE isag_t.isag002
   DEFINE l_isag003                LIKE isag_t.isag003
   DEFINE l_len                    LIKE type_t.num5
   DEFINE l_isae012                LIKE type_t.num20
   DEFINE l_isae012_o              LIKE type_t.num20
   DEFINE l_cnt                    LIKE type_t.num5
   DEFINE l_isae012_str            STRING
   DEFINE l_xmdl047                LIKE xmdl_t.xmdl047
   DEFINE l_sql                    STRING
   
   LET g_success = 'Y'
   
   #151223-00001#3--mark--str--lujh
   #LET g_sql = "SELECT isag001,isag002,isag003,isag004 ",
   #            "  FROM isag_t ",
   #            " WHERE isagent = '",g_enterprise,"'",
   #            "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
   #            "   AND isagcomp = '",g_isaf_m.isafcomp,"'"
   #PREPARE isag_pre_3 FROM g_sql
   #DECLARE isag_cur_3 CURSOR FOR isag_pre_3              
   #            
   #FOREACH isag_cur_3 INTO l_isag001,l_isag002,l_isag003,l_isag004          
   #   IF SQLCA.sqlcode THEN
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "FOREACH:"
   #      LET g_errparam.popup = TRUE
   #      CALL cl_err()
   #
   #      EXIT FOREACH
   #   END IF   
   #   
   #   #IF l_isag001 = 'axmt500' THEN 
   #   IF l_isag001 = '10' THEN
   #      UPDATE xmdb_t SET xmdb016 = xmdb016 - g_isaf_m.isaf103 
   #       WHERE xmdbent = g_enterprise
   #         AND xmdbdocno = l_isag002 
   #         AND xmdb001 = l_isag003  # 期別
   #   END IF
   #   
   #   #IF l_isag001 = 'axmt540' OR l_isag001 = 'axmt600' THEN 
   #   IF l_isag001 = '11' OR l_isag001 = '21' THEN
   #      #IF l_isag001 = 'axmt600' THEN 
   #      #   IF l_isag004 < 0 THEN 
   #      #      LET l_isag004 = l_isag004 * -1
   #      #   END IF
   #      #END IF
   #      
   #      SELECT xmdl047 INTO l_xmdl047
   #        FROM xmdl_t
   #       WHERE xmdlent = g_enterprise
   #         AND xmdldocno = l_isag002 
   #         AND xmdlseq = l_isag003 
   #      
   #      IF cl_null(l_xmdl047) THEN 
   #         LET l_xmdl047 = 0
   #      END IF
   #   
   #      UPDATE xmdl_t SET xmdl047 = l_xmdl047 - l_isag004  #已開發票數量
   #       WHERE xmdlent = g_enterprise
   #         AND xmdldocno = l_isag002 
   #         AND xmdlseq = l_isag003 
   #   END IF
   #      
   #   IF SQLCA.SQLcode THEN
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "update"
   #      LET g_errparam.popup = TRUE
   #      CALL cl_err()
   #
   #      LET g_success = 'N'                  
   #      EXIT FOREACH         
   #   END IF   
   #   
   #END FOREACH   
   #151223-00001#3--mark--end--lujh
   
   #170116-00020#1 mark ------
   ##150717--(S)
   #LET l_isae012_o = g_isaf_m.isaf011
   #IF g_isai002 = '1' THEN
   #   LET l_isae012_o = g_isaf_m.isaf011[3,10]
   #END IF
   #
   #SELECT isae012 INTO l_isae012
   #  FROM isae_t
   # WHERE isaeent  = g_enterprise
   #   AND isaesite = g_isaf_m.isaf052
   #   AND isae001  = g_isaf_m.isaf051
   #   AND isae002 <= g_isaf_m.isaf014  
   #   AND isae003 >= g_isaf_m.isaf014
   #   AND isae004  = g_isaf_m.isaf008    #albireo 160721 無單
   #IF l_isae012 = l_isae012_o THEN
   #   LET l_isae012_o = l_isae012_o -1
   #   UPDATE isae_t SET isae012 = l_isae012_o,   #發票簿下次列印號碼
   #                     isae013 = isae013 - 1    #已開張數
   #    WHERE isaeent  = g_enterprise
   #      AND isaesite = g_isaf_m.isaf052
   #      AND isae001  = g_isaf_m.isaf051
   #      AND isae002 <= g_isaf_m.isaf014
   #      AND isae003 >= g_isaf_m.isaf014
   #END IF
   ##150717--(E)
   #170116-00020#1 mark end---
   
   #albireo #150915-00009#3-----s
   IF g_isaf_m.isaf056 = '2' THEN
      #回寫折讓金額
      CALL s_aisp320_upd_source_isat(g_isaf_m.isafcomp,g_isaf_m.isafdocno,'-')
         RETURNING g_sub_success
      IF NOT g_sub_success THEN
         LET g_success = 'N'
      END IF
   END IF
   #albireo #150915-00009#3-----e

   ##本次开立的最小的发票
   #SELECT MIN(isah002) INTO l_isae012
   #  FROM isah_t
   # WHERE isahent = g_enterprise
   #   AND isahcomp = g_isaf_m.isafcomp
   #   AND isahdocno = g_isaf_m.isafdocno
   #   
   ##本次开了几张发票
   #SELECT COUNT(DISTINCT isah002) INTO l_cnt
   #  FROM isah_t
   # WHERE isahent = g_enterprise
   #   AND isahcomp = g_isaf_m.isafcomp
   #   AND isahdocno = g_isaf_m.isafdocno
   #
   #IF g_isaf_m.isaf056 = '2' AND g_isai006 = 'Y' THEN
   #   UPDATE isae_t SET isae012 = l_isae012,                        #發票簿下次列印號碼 
   #                     isae013 = isae013 - l_cnt                   #已開張數  
   #    WHERE isaeent  = g_enterprise
   #      AND isaesite = g_isaf_m.isaf052
   #      AND isae001  = g_isaf_m.isaf051
   #      AND isae002 <= g_isaf_m.isaf014  
   #      AND isae003 >= g_isaf_m.isaf014
   #ELSE
   #   UPDATE isae_t SET isae012 = l_isae012,                        #發票簿下次列印號碼 
   #                     isae013 = isae013 - l_cnt                   #已開張數  
   #    WHERE isaeent  = g_enterprise
   #      AND isaesite = g_isaf_m.isaf052
   #      AND isae001  = g_isaf_m.isaf051
   #      AND isae002 <= g_isaf_m.isaf014  
   #      AND isae003 >= g_isaf_m.isaf014
   #      AND isae004  = g_isaf_m.isaf008
   #END IF
   #   
   #IF SQLCA.SQLcode THEN
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = SQLCA.sqlcode
   #   LET g_errparam.extend = "update"
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #
   #   LET g_success = 'N'                        
   #END IF  
END FUNCTION
# 彙整至發票明細
PRIVATE FUNCTION aist310_compile_to_isah()
   DEFINE l_ac            LIKE type_t.num5
   DEFINE l_success       LIKE type_t.chr1
   DEFINE r_success       LIKE type_t.chr1
   DEFINE l_isae001       LIKE isae_t.isae001
   DEFINE l_isaesite      LIKE isae_t.isaesite
   DEFINE l_isae008       LIKE isae_t.isae008
   DEFINE l_isae012       LIKE isae_t.isae012
   DEFINE l_isae020       LIKE isae_t.isae020
   DEFINE l_today         LIKE isaf_t.isaf014
   DEFINE l_isah113       LIKE isah_t.isah113
   DEFINE l_isah001       LIKE isah_t.isah001
   DEFINE l_isah002       LIKE isah_t.isah002
   DEFINE l_isah010       LIKE isah_t.isah010
   DEFINE l_len           LIKE type_t.num5
   DEFINE l_isae012_str   STRING
   DEFINE l_sql           STRING
   DEFINE l_flag          LIKE type_t.chr1
   DEFINE l_isah006_t     LIKE isah_t.isah006
   DEFINE l_isah103_t     LIKE isah_t.isah103
   DEFINE l_isah104_t     LIKE isah_t.isah104
   DEFINE l_isah105_t     LIKE isah_t.isah105
   DEFINE l_isah113_t     LIKE isah_t.isah113
   DEFINE l_isah114_t     LIKE isah_t.isah114
   DEFINE l_isah115_t     LIKE isah_t.isah115
   DEFINE l_isah006_tot   LIKE isah_t.isah006
   DEFINE l_isah103_tot   LIKE isah_t.isah103
   DEFINE l_isah104_tot   LIKE isah_t.isah104
   DEFINE l_isah105_tot   LIKE isah_t.isah105
   DEFINE l_isah113_tot   LIKE isah_t.isah113
   DEFINE l_isah114_tot   LIKE isah_t.isah114
   DEFINE l_isah115_tot   LIKE isah_t.isah115
   DEFINE l_amt           LIKE isah_t.isah113       
   DEFINE l_isah    RECORD          
                isahdocno LIKE isah_t.isahdocno, 
                isahcomp  LIKE isah_t.isahcomp, 
                isahorga  LIKE isah_t.isahorga, 
                isah003   LIKE isah_t.isah003, 
                isah004   LIKE isah_t.isah004, 
                isah005   LIKE isah_t.isah005, 
                isah006   LIKE isah_t.isah006, 
                isah101   LIKE isah_t.isah101, 
                isah103   LIKE isah_t.isah103, 
                isah007   LIKE isah_t.isah007,
                isah104   LIKE isah_t.isah104,                
                isah105   LIKE isah_t.isah105, 
                isah113   LIKE isah_t.isah113,
                isah114   LIKE isah_t.isah114,
                isah115   LIKE isah_t.isah115,
                isah008   LIKE isah_t.isah008,
                isah009   LIKE isah_t.isah009
                END RECORD
   DEFINE l_cnt           LIKE type_t.num5
   DEFINE l_field1        LIKE type_t.chr1000
   DEFINE l_field2        LIKE type_t.chr1000
   DEFINE l_group_field   LIKE type_t.chr1000   
   DEFINE l_str           STRING
   DEFINE l_isah013       LIKE isah_t.isah013
   DEFINE l_isag015       LIKE isag_t.isag015
   DEFINE l_isah011       LIKE isah_t.isah011
   #150915-00009#3-----s
   DEFINE l_isae010       LIKE isae_t.isae010   #結束號碼
   DEFINE l_isae007       LIKE isae_t.isae007   #字軌
   DEFINE l_isah0022      LIKE isah_t.isah002   #結束號碼含字軌
   DEFINE l_isah002do     LIKE isah_t.isah002   #實際迴寫的號碼
  #DEFINE l_isai008       LIKE isai_t.isai008   #國別  #160803-00044#1 mark
   DEFINE l_ooef019       LIKE ooef_t.ooef019
   #150915-00009#3-----e
  #DEFINE l_isai002       LIKE isai_t.isai002   #發票編碼方式 #160104-00015#1  #160803-00044#1 mark
   
   CALL s_transaction_begin()
   CALL cl_err_collect_init()
   LET l_success = 'Y'
   LET l_flag = 'N'
   
   #20150309--add--str--
   IF g_isaf_m.isaf103 < 0 AND g_isaf_m.isaf056 = '1' THEN 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ais-00187'
      LET g_errparam.extend = g_isaf_m.isafdocno
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CALL cl_err_collect_show()
      
      RETURN
   END IF 
   #20150309--add--end--
   
   LET l_isah006_tot = 0
   LET l_isah103_tot = 0
   LET l_isah104_tot = 0
   LET l_isah105_tot = 0
   LET l_isah113_tot = 0
   LET l_isah114_tot = 0
   LET l_isah115_tot = 0
   
   DELETE FROM isah_t
    WHERE isahent = g_enterprise
      AND isahcomp = g_isaf_m.isafcomp
      AND isahdocno = g_isaf_m.isafdocno

   IF g_isae_m.type = '1' OR g_isae_m.type = '3' THEN   #依出貨料號彙總/#依項次出貨料號不彙總產生
      IF g_isae_m.merge = 'Y' THEN
         LET l_field1 = "isag009,isag010,''"
      ELSE
         LET l_field1 = "isag009,isag010,isag015"
      END IF
   END IF
   
   IF g_isae_m.type = '2' OR g_isae_m.type = '4' THEN   #依客戶料號彙總/#依項次客戶料號不彙總產生
      IF g_isae_m.merge = 'Y' THEN
         LET l_field1 = "isag016,isag017,''"
      ELSE
         LET l_field1 = "isag016,isag017,isag015"
      END IF
   END IF
   
   IF g_isaf_m.isaf056 = '1' THEN    #蓝字发票
      LET l_field2 = "'',''"
   ELSE  #红字发票
      LET l_field2 = "isag013,isag014"
   END IF
   
   IF g_isae_m.type = '1' OR g_isae_m.type = '2' THEN   #汇总
      LET l_str = " SUM(isag004*isag015),SUM(isag103*isag015),SUM(isag104*isag015),SUM(isag105*isag015), ",
                  " SUM(isag113*isag015),SUM(isag114*isag015),SUM(isag115*isag015)"
      LET l_group_field = " GROUP BY isagdocno,isagcomp,isagorga,isag005,isag008,isag101,",l_field1,",",l_field2
   END IF
   
   IF g_isae_m.type = '3' OR g_isae_m.type = '4' THEN   #不汇总
      LET l_str = " isag004*isag015,isag103*isag015,isag104*isag015,isag105*isag015,",
                  " isag113*isag015,isag114*isag015,isag115*isag015 "    
      LET l_group_field = " "
   END IF
   
   LET g_sql = "SELECT isagdocno,isagcomp,isagorga,",l_field1,",isag005,isag008,isag101,",l_str,",",l_field2,
               "  FROM isag_t ",
               " WHERE isagdocno = '",g_isaf_m.isafdocno,"'",
               "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
               "   AND isagent = ",g_enterprise,             #160823-00016#1
               "   AND (isag018 = 'Y' OR isag018 IS NULL) ", #160823-00016#1
               l_group_field
   PREPARE isag_pre FROM g_sql
   DECLARE isag_cur CURSOR FOR isag_pre
   
   #160803-00044#1 mark ------
   ##albireo #150915-00009#3-----s
   ##增加國別條件
   #LET l_ooef019 = NULL
   #SELECT ooef019 
   #  INTO l_ooef019
   #  FROM ooef_t
   # WHERE ooefent = g_enterprise
   #   AND ooef001 = g_isaf_m.isafcomp
   #   AND ooefstus = 'Y'
   #160803-00044#1 mark ------
   ##160104-00015#1 add isai002
   #LET l_isai008 = NULL
   #SELECT isai008,isai002
   #  INTO l_isai008,l_isai002
   #  FROM isai_t 
   # WHERE isaient = g_enterprise
   #   AND isai001 = l_ooef019
   ##albireo #150915-00009#3-----e
   #160803-00044#1 mark end---

   LET l_ac = 1
   LET l_isah010 = 1   
   
   #若单头发票薄不为空,则已单头值为准
   #IF NOT cl_null(g_isaf_m.isaf051) AND NOT cl_null(g_isaf_m.isaf011) THEN 
   IF NOT cl_null(g_isaf_m.isaf011) THEN
      LET l_isae001 = g_isaf_m.isaf051
      LET l_isaesite = g_isaf_m.isaf052
      LET l_isae008 = g_isaf_m.isaf010
      LET l_isae012 = g_isaf_m.isaf011
      LET l_flag = 'Y'
             
      #albireo 150717-----s
      SELECT isae010,isae007
        INTO l_isae010,l_isae007
        FROM isae_t
       WHERE isaeent  = g_enterprise
         AND isaesite = g_isaf_m.isaf052
         AND isae001  = g_isaf_m.isaf051
         AND isae002 <= g_isaf_m.isaf014
         AND isae003 >= g_isaf_m.isaf014
         AND isae004  = g_isaf_m.isaf008   #albireo 160721 無單
      
     #IF l_isai008 = 'TW' THEN  #160104-00015#1 mark
      IF g_isai002 = '1' THEN   #160104-00015#1
         IF NOT cl_null(l_isae007)THEN
            LET l_str = cl_replace_str(l_isae012,l_isae007,'')
            LET l_isae012 = l_str.trim()
         END IF
      END IF
      #albireo 150717-----e
   ELSE
      LET l_isae001 = g_isae_m.isae001
      LET l_isaesite = g_isae_m.isaesite
      LET l_isae008 = g_isae_m.isae008
      LET l_isae012 = g_isae_m.isae012
   END IF
   IF cl_null(g_isaf_m.isaf014) THEN 
      LET l_today = g_today
   ELSE
      LET l_today = g_isaf_m.isaf014
   END IF
   
   #150915-00009#3 modify-----s
   #取得发票薄限额
   #SELECT isae020 INTO l_isae020   
   LET l_isae010 = NULL
   LET l_isae007 = NULL
   SELECT isae020 ,isae010, isae007
     INTO l_isae020 ,l_isae010 ,l_isae007
     FROM isae_t           
    WHERE isaeent = g_enterprise
      AND isaesite = l_isaesite
      AND isae001  = l_isae001
      AND isae002 <= l_today
      AND isae003 >= l_today
      AND isae004  = g_isaf_m.isaf008   #albireo 160721 無單
      
   IF cl_null(l_isae020) THEN 
      LET l_isae020 = 0
   END IF
   #150915-00009#3 modify-----e
   
   IF g_isae_m.quota > 0 THEN 
      LET l_isae020 = g_isae_m.quota
   END IF
   

   
   LET l_amt = 0
   #160104-00015#1 add ------
  #IF l_isai002 = '1' THEN  #160803-00044#1 mark
   IF g_isai002 = '1' THEN  #160803-00044#1
      LET l_isah001 = " "
   ELSE
      LET l_isah001 = l_isae008
   END IF
   #160104-00015#1 add end---
  #LET l_isah001 = l_isae008  #160104-00015#1 mark
   LET l_isah002 = l_isae012
   
   ##150915-00009#3-----s
   LET l_isah0022 = l_isae010
   ##150915-00009#3-----e
   
   LET l_isah011 = 1
   FOREACH isag_cur INTO l_isah.isahdocno,l_isah.isahcomp,l_isah.isahorga,
                         l_isah.isah003,l_isah.isah004,l_isag015,l_isah.isah005,
                         l_isah.isah007,l_isah.isah101,l_isah.isah006,
                         l_isah.isah103,l_isah.isah104,l_isah.isah105,
                         l_isah.isah113,l_isah.isah114,l_isah.isah115,
                         l_isah.isah008,l_isah.isah009
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF  
      
#      INITIALIZE g_ref_fields TO NULL
#      LET g_ref_fields[1] = l_isah.isah003
#      CALL ap_ref_array2(g_ref_fields,"SELECT imaal004 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
#      LET l_isah013 = '', g_rtn_fields[1] , ''
      SELECT imaal004 INTO l_isah013 FROM imaal_t
       WHERE imaalent = g_enterprise
         AND imaal001 = l_isah.isah003
         AND imaal002 = g_dlang
      
      IF l_amt = 0 THEN 
         LET l_amt = l_isae020
      END IF 
      
      #发票没有限额
      IF l_isae020 = 0 THEN 
         LET l_amt = l_isah.isah113
      END IF
      
      IF l_amt < 0 THEN LET l_amt = l_amt * -1 END IF
      
      #IF l_flag = 'Y' AND l_amt < l_isah.isah113 THEN 
      #   INITIALIZE g_errparam TO NULL
      #   LET g_errparam.code = 'ais-00162'
      #   LET g_errparam.extend = l_isah.isah003
      #   LET g_errparam.popup = TRUE
      #   CALL cl_err()
      #
      #   CONTINUE FOREACH
      #END IF
      
      LET l_isah006_t = l_isah.isah006
      LET l_isah103_t = l_isah.isah103
      LET l_isah104_t = l_isah.isah104
      LET l_isah105_t = l_isah.isah105
      LET l_isah113_t = l_isah.isah113
      LET l_isah114_t = l_isah.isah114
      LET l_isah115_t = l_isah.isah115
      
      IF l_isah006_t < 0 THEN LET l_isah006_t = l_isah006_t * -1 END IF
      IF l_isah103_t < 0 THEN LET l_isah103_t = l_isah103_t * -1 END IF
      IF l_isah104_t < 0 THEN LET l_isah104_t = l_isah104_t * -1 END IF
      IF l_isah105_t < 0 THEN LET l_isah105_t = l_isah105_t * -1 END IF
      IF l_isah113_t < 0 THEN LET l_isah113_t = l_isah113_t * -1 END IF
      IF l_isah114_t < 0 THEN LET l_isah114_t = l_isah114_t * -1 END IF
      IF l_isah115_t < 0 THEN LET l_isah115_t = l_isah115_t * -1 END IF
      
      LET l_isah113 = l_isah.isah113
      
      #IF l_isah113 < 0 THEN                         #170215-00025#1 mark
      #IF l_isah113 < 0 OR l_isah.isah115 < 0THEN    #170215-00025#1 #170217-00019#1 mark
      IF l_isah.isah103 < 0 OR l_isah.isah105 < 0 OR l_isah113 < 0 OR l_isah.isah115 < 0 THEN #170217-00019#1
         LET l_isah113 = l_isah113 * -1
         LET l_isah010 = -1
      ELSE
         LET l_isah010 = 1
      END IF
      
      LET l_isah006_tot = 0
      LET l_isah103_tot = 0
      LET l_isah104_tot = 0
      LET l_isah105_tot = 0
      LET l_isah113_tot = 0
      LET l_isah114_tot = 0
      LET l_isah115_tot = 0

      WHILE TRUE
         IF l_amt = 0 AND l_isah113 > 0 THEN    #150915-00009#3 add AND l_isah113 > 0

            LET l_isae012_str = l_isae012
            LET l_len = l_isae012_str.getLength()
            LET l_sql = "SELECT lpad('",l_isah002,"'+1,",l_len,",'0') FROM dual"
            PREPARE isae012_pre1 FROM l_sql
            EXECUTE isae012_pre1 INTO l_isah002
            
            LET l_amt = l_isae020
            
            ##150915-00009#3-----s
            IF l_isah002 > l_isah0022 THEN   #下次發票號碼已經超出發票簿最後號碼 
               LET r_success = FALSE
               EXIT WHILE
            END IF
            ##150915-00009#3-----e
         END IF
         
         IF l_amt < l_isah113 THEN
            #重新计算原币金额,数量等
            LET l_isah.isah103 = l_amt / g_isaf_m.isaf101
            LET l_isah.isah006 = l_isah.isah103 / l_isah.isah101
            
            
            #161212-00075#1 mark-----s
            ##發票稅額
            #IF g_isaf_m.isaf017 = 'Y' THEN 
            #   LET l_isah.isah104 = (l_isah.isah101 * l_isah.isah006) - 
            #                                         (l_isah.isah101/(1+l_isah.isah007/100)) * l_isah.isah006     
            #ELSE
            #   LET l_isah.isah104 = l_isah.isah103 * l_isah.isah007/100
            #END IF 
            #161212-00075#1 mark-----e
            #161212-00075#1-----s
            LET l_isah.isah104 = l_isah.isah103 * l_isah.isah007/100
            #161212-00075#1-----e
            
            #發票稅後金額
            LET l_isah.isah105 = l_isah.isah103 + l_isah.isah104
            
            #發票本幣稅額
            LET l_isah.isah114 = l_isah.isah104 * g_isaf_m.isaf101
            
            #發票本幣稅後金額
            LET l_isah.isah115 = l_amt + l_isah.isah114

            #150915-00009#3-----s
            LET l_isah002do = l_isah002
            
           #IF l_isai008 = 'TW' THEN #albireo 150916 kris 加上國別台灣才要組字軌 #160104-00015#1 mark
           #IF l_isai002 = '1' THEN  #160104-00015#1 #160803-00044#1 mark
            IF g_isai002 = '1' THEN  #160803-00044#1
               IF NOT cl_null(l_isae007)THEN
                  LET l_isah002do = l_isae007 CLIPPED,l_isah002do CLIPPED
               END IF
            END IF
            #150915-00009#3-----e

            INSERT INTO isah_t(isahent,isahcomp,isahorga,isahdocno,isahseq,isah003,isah004,isah005,isah006,
                               isah007,isah101,isah103,isah104,isah105,isah113,isah114,isah115,isah001,isah002,
                               isah010,isah008,isah009,isah011,isah013) 
                        VALUES(g_enterprise,l_isah.isahcomp,l_isah.isahorga,l_isah.isahdocno,l_ac,
                               l_isah.isah003,l_isah.isah004,l_isah.isah005,
                               l_isah.isah006,l_isah.isah007,l_isah.isah101,
                               l_isah.isah103,l_isah.isah104,l_isah.isah105,
                               l_amt,l_isah.isah114,l_isah.isah115,
                               l_isah001,l_isah002do,l_isah010,l_isah.isah008,l_isah.isah009,
                               l_isah011,l_isah013)
            LET l_isah113 = l_isah113 - l_amt
            LET l_isah006_tot = l_isah006_tot + l_isah.isah006
            LET l_isah103_tot = l_isah103_tot + l_isah.isah103
            LET l_isah104_tot = l_isah104_tot + l_isah.isah104
            LET l_isah105_tot = l_isah105_tot + l_isah.isah105
            LET l_isah113_tot = l_isah113_tot + l_amt
            LET l_isah114_tot = l_isah114_tot + l_isah.isah114
            LET l_isah115_tot = l_isah115_tot + l_isah.isah115
            LET l_amt = 0
            LET l_ac = l_ac + 1 
            LET l_isah011 = l_isah011 + 1
         ELSE

            LET l_isah.isah006 = l_isah006_t - l_isah006_tot
            LET l_isah.isah103 = l_isah103_t - l_isah103_tot
            LET l_isah.isah104 = l_isah104_t - l_isah104_tot
            LET l_isah.isah105 = l_isah105_t - l_isah105_tot
            LET l_isah.isah114 = l_isah114_t - l_isah114_tot
            LET l_isah.isah115 = l_isah115_t - l_isah115_tot
            
            #150915-00009#3-----s
            LET l_isah002do = l_isah002
            
           #IF l_isai008 = 'TW' THEN #albireo 150916 kris 加上國別台灣才要組字軌 #160104-00015#1 mark
           #IF l_isai002 = '1' THEN  #160104-00015#1 #160803-00044#1 mark
            IF g_isai002 = '1' THEN  #160803-00044#1
               IF NOT cl_null(l_isae007)THEN
                  LET l_isah002do = l_isae007 CLIPPED,l_isah002do CLIPPED
               END IF
            END IF
            #150915-00009#3-----e
            
            INSERT INTO isah_t(isahent,isahcomp,isahorga,isahdocno,isahseq,isah003,isah004,isah005,isah006,
                               isah007,isah101,isah103,isah104,isah105,isah113,isah114,isah115,isah001,isah002,
                               isah010,isah008,isah009,isah011,isah013) 
                        VALUES(g_enterprise,l_isah.isahcomp,l_isah.isahorga,l_isah.isahdocno,l_ac,
                               l_isah.isah003,l_isah.isah004,l_isah.isah005,
                               l_isah.isah006,l_isah.isah007,l_isah.isah101,
                               l_isah.isah103,l_isah.isah104,l_isah.isah105,
                               l_isah113,l_isah.isah114,l_isah.isah115,
                               l_isah001,l_isah002do,l_isah010,l_isah.isah008,l_isah.isah009,
                               l_isah011,l_isah013)
            LET l_amt = l_amt - l_isah113
            LET l_isah113 = 0
            LET l_ac = l_ac + 1 
         END IF  
         
         IF SQLCA.SQLcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "isah_t"
            LET g_errparam.popup = TRUE
            CALL cl_err()
         
            LET l_success = 'N'                            
         END IF

         IF l_isah113 = 0 THEN 
            EXIT WHILE
         END IF 
      END WHILE
      
      #albireo #150915-00009#3-----s 
      IF l_isah002 > l_isah0022 THEN   #下次發票號碼已經超出發票簿最後號碼 
         LET l_success = 'N'
         EXIT FOREACH
      END IF
      #albireo #150915-00009#3-----e
   END FOREACH 
       
   #albireo #150915-00009#3-----s    
   IF l_isah002 > l_isah0022 THEN   #下次發票號碼已經超出發票簿最後號碼 
      INITIALIZE g_errparam.* TO NULL
      LET g_errparam.code = 'ais-00234'
      LET g_errparam.extend = 'ins_isah:'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET l_success = 'N'
   END IF    
   #albireo #150915-00009#3-----e


   CALL aist310_isaf_sum()
   
   #161212-00075#1 mark-----s
   #IF g_isaf_m.isaf011 <> 'MULTI' THEN   #160807-00010#1
   #   CALL aist310_isat_ins() RETURNING r_success
   #END IF                                #160807-00010#1
   #161212-00075#1 mark-----e
   
   #170116-00020#1 mark ------
   ##161212-00075#1-----s
   ##NULL 應要執行產生isat
   #IF g_isaf_m.isaf011 = 'MULTI' THEN
   #ELSE
   #   CALL aist310_isat_ins() RETURNING r_success
   #END IF
   ##161212-00075#1-----e
   #IF r_success = 'N' THEN
   #   LET l_success = 'N'
   #END IF
   #IF l_success = 'Y' AND cl_null(g_isaf_m.isaf011) THEN 
   #   SELECT COUNT(distinct isat004) INTO l_cnt FROM isat_t 
   #    WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp
   #      AND isatdocno = g_isaf_m.isafdocno 
   #   IF l_cnt>1 THEN ###多比发票则回写MULTI
   #      LET g_isaf_m.isaf011 = 'MULTI'
   #   ELSE 
   #      ##150915-00009#3-----s
   #      SELECT DISTINCT isat004 INTO l_isah002 FROM isat_t 
   #       WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp
   #         AND isatdocno = g_isaf_m.isafdocno          
   #      LET g_isaf_m.isaf011 = l_isah002
   #      #150915-00009#3------e
   #   END IF
   #   #160104-00015#1 add ------
   #  #IF l_isai002 = '1' THEN #160803-00044#1 mark
   #   IF g_isai002 = '1' THEN #160803-00044#1
   #      LET g_isaf_m.isaf010 =  " "
   #   ELSE
   #      LET g_isaf_m.isaf010 = l_isah001
   #   END IF
   #   #160104-00015#1 add end---
   #  #LET g_isaf_m.isaf010 = l_isah001 #160104-00015#1 mark
   #   LET g_isaf_m.isaf051 = g_isae_m.isae001
   #   LET g_isaf_m.isaf052 = g_isae_m.isaesite
   #   LET g_sql = "UPDATE isaf_t SET isaf051 = '",g_isaf_m.isaf051,"' ," ,
   #                                 "isaf052 = '",g_isaf_m.isaf052,"', ",
   #                                 "isaf010 = '",g_isaf_m.isaf010,"' , ",
   #                                 "isaf011 = '",g_isaf_m.isaf011,"' ",
   #               " WHERE isafent = '",g_enterprise,"' AND isafcomp = '",g_isaf_m.isafcomp,"' ",
   #               "   AND isafdocno = '",g_isaf_m.isafdocno,"'"
   #   PREPARE upd_isaf051 FROM g_sql
   #   EXECUTE upd_isaf051
   #    IF SQLCA.SQLcode THEN
   #       INITIALIZE g_errparam TO NULL
   #       LET g_errparam.code = SQLCA.sqlcode
   #       LET g_errparam.extend = "update isaf051"
   #       LET g_errparam.popup = TRUE
   #       CALL cl_err()
   #       LET l_success = 'N'
   #    END IF
   #END IF
   #170116-00020#1 mark end---
   
   CALL cl_err_collect_show()
   IF l_success = 'Y' THEN 
      CALL s_transaction_end('Y','1')
   ELSE
      CALL s_transaction_end('N','1')
   END IF
   
   #DROP TABLE aist310_tmp
   CALL aist310_show() 
END FUNCTION
# 插入发票历程档
PRIVATE FUNCTION aist310_isat_ins()
   DEFINE l_isah001    LIKE isah_t.isah001
   DEFINE l_isah002    LIKE isah_t.isah002
   DEFINE l_isah103    LIKE isah_t.isah103
   DEFINE l_isah104    LIKE isah_t.isah104
   DEFINE l_isah105    LIKE isah_t.isah105
   #DEFINE l_isat       RECORD LIKE isat_t.* #161104-00024#10 mark
   #161104-00024#10 --s add
   DEFINE l_isat RECORD  #發票歷程檔
          isatent LIKE isat_t.isatent, #企業編碼
          isatcomp LIKE isat_t.isatcomp, #法人
          isatdocno LIKE isat_t.isatdocno, #開票單號
          isatseq LIKE isat_t.isatseq, #發票歷程項次
          isat001 LIKE isat_t.isat001, #發票類型
          isat002 LIKE isat_t.isat002, #電子發票否
          isat003 LIKE isat_t.isat003, #發票編號
          isat004 LIKE isat_t.isat004, #發票號碼
          isat005 LIKE isat_t.isat005, #發票聯別
          isat006 LIKE isat_t.isat006, #發票防偽隨機碼
          isat007 LIKE isat_t.isat007, #發票日期
          isat008 LIKE isat_t.isat008, #發票時間
          isat009 LIKE isat_t.isat009, #發票客戶全名
          isat010 LIKE isat_t.isat010, #購貨方統一編號
          isat011 LIKE isat_t.isat011, #購貨方地址
          isat012 LIKE isat_t.isat012, #銷方統一編號
          isat013 LIKE isat_t.isat013, #POS單號
          isat014 LIKE isat_t.isat014, #發票異動狀態
          isat015 LIKE isat_t.isat015, #異動理由碼
          isat016 LIKE isat_t.isat016, #異動備註
          isat017 LIKE isat_t.isat017, #異動日期
          isat018 LIKE isat_t.isat018, #異動時間
          isat019 LIKE isat_t.isat019, #異動人員
          isat020 LIKE isat_t.isat020, #專案作廢核准文號
          isat021 LIKE isat_t.isat021, #列印次數
          isat022 LIKE isat_t.isat022, #課稅別
          isat023 LIKE isat_t.isat023, #稅率
          isat024 LIKE isat_t.isat024, #檢查碼
          isat100 LIKE isat_t.isat100, #幣別
          isat101 LIKE isat_t.isat101, #匯率
          isat103 LIKE isat_t.isat103, #發票原幣未稅金額
          isat104 LIKE isat_t.isat104, #發票原幣稅額
          isat105 LIKE isat_t.isat105, #發票原幣含稅金額
          isat106 LIKE isat_t.isat106, #已折讓本幣未稅金額
          isat107 LIKE isat_t.isat107, #已折讓本幣稅額
          isat113 LIKE isat_t.isat113, #發票本幣未稅金額
          isat114 LIKE isat_t.isat114, #發票本幣稅額
          isat115 LIKE isat_t.isat115, #發票本幣含稅金額
          isat201 LIKE isat_t.isat201, #帳款應稅金額
          isat202 LIKE isat_t.isat202, #帳款零稅金額
          isat203 LIKE isat_t.isat203, #帳款免稅金額
          isat204 LIKE isat_t.isat204, #愛心碼
          isat205 LIKE isat_t.isat205, #載具類別號碼
          isat206 LIKE isat_t.isat206, #載具顯碼 ID
          isat207 LIKE isat_t.isat207, #載具隱碼 ID
          isat208 LIKE isat_t.isat208, #電子發票匯出狀態
          isat209 LIKE isat_t.isat209, #電子發票匯出序號
          isatud001 LIKE isat_t.isatud001, #自定義欄位(文字)001
          isatud002 LIKE isat_t.isatud002, #自定義欄位(文字)002
          isatud003 LIKE isat_t.isatud003, #自定義欄位(文字)003
          isatud004 LIKE isat_t.isatud004, #自定義欄位(文字)004
          isatud005 LIKE isat_t.isatud005, #自定義欄位(文字)005
          isatud006 LIKE isat_t.isatud006, #自定義欄位(文字)006
          isatud007 LIKE isat_t.isatud007, #自定義欄位(文字)007
          isatud008 LIKE isat_t.isatud008, #自定義欄位(文字)008
          isatud009 LIKE isat_t.isatud009, #自定義欄位(文字)009
          isatud010 LIKE isat_t.isatud010, #自定義欄位(文字)010
          isatud011 LIKE isat_t.isatud011, #自定義欄位(數字)011
          isatud012 LIKE isat_t.isatud012, #自定義欄位(數字)012
          isatud013 LIKE isat_t.isatud013, #自定義欄位(數字)013
          isatud014 LIKE isat_t.isatud014, #自定義欄位(數字)014
          isatud015 LIKE isat_t.isatud015, #自定義欄位(數字)015
          isatud016 LIKE isat_t.isatud016, #自定義欄位(數字)016
          isatud017 LIKE isat_t.isatud017, #自定義欄位(數字)017
          isatud018 LIKE isat_t.isatud018, #自定義欄位(數字)018
          isatud019 LIKE isat_t.isatud019, #自定義欄位(數字)019
          isatud020 LIKE isat_t.isatud020, #自定義欄位(數字)020
          isatud021 LIKE isat_t.isatud021, #自定義欄位(日期時間)021
          isatud022 LIKE isat_t.isatud022, #自定義欄位(日期時間)022
          isatud023 LIKE isat_t.isatud023, #自定義欄位(日期時間)023
          isatud024 LIKE isat_t.isatud024, #自定義欄位(日期時間)024
          isatud025 LIKE isat_t.isatud025, #自定義欄位(日期時間)025
          isatud026 LIKE isat_t.isatud026, #自定義欄位(日期時間)026
          isatud027 LIKE isat_t.isatud027, #自定義欄位(日期時間)027
          isatud028 LIKE isat_t.isatud028, #自定義欄位(日期時間)028
          isatud029 LIKE isat_t.isatud029, #自定義欄位(日期時間)029
          isatud030 LIKE isat_t.isatud030, #自定義欄位(日期時間)030
          isatsite LIKE isat_t.isatsite, #營運據點
          isatdocdt LIKE isat_t.isatdocdt, #單據日期
          isat025 LIKE isat_t.isat025, #發票最終狀態
          isat026 LIKE isat_t.isat026, #電子發票類型
          isat027 LIKE isat_t.isat027, #原發票日期
          isat028 LIKE isat_t.isat028, #稅別
          isat029 LIKE isat_t.isat029, #含稅否
          isat108 LIKE isat_t.isat108, #留抵原幣稅額
          isat118 LIKE isat_t.isat118  #留抵本幣稅額
   END RECORD
   #161104-00024#10 --e add
   DEFINE r_success    LIKE type_t.chr1
   #161212-00008#1-----s
   DEFINE l_isah113    LIKE isah_t.isah113
   DEFINE l_isah114    LIKE isah_t.isah114
   DEFINE l_isah115    LIKE isah_t.isah115
   #161212-00008#1-----e
   #161223-00053#1 add ------
   DEFINE  l_sql       STRING
   DEFINE  l_isag013   LIKE isag_t.isag013
   DEFINE  l_isag014   LIKE isag_t.isag014
   #161223-00053#1 add end---
   
   LET r_success = 'Y'
   
   DELETE FROM isat_t WHERE isatent = g_enterprise
                        AND isatcomp = g_isaf_m.isafcomp
                        AND isatdocno = g_isaf_m.isafdocno
   #161214-00042#1 mark-----s
   ##IF g_isai008 = 'TW' AND g_isaf_m.isaf056 = '2' THEN  #160104-00015#1 mark
   #IF g_isai002 = '1' AND g_isaf_m.isaf056 = '2' THEN   #160104-00015#1
   #  #LET g_sql = "SELECT isah008,isah009,isah103,isah104,isah105",                 #151007-00002#3 mark
   #   LET g_sql = "SELECT ' ',isah009,SUM(isah103),SUM(isah104),SUM(isah105)   ",   #151007-00002#3
   #               "      ,SUM(isah113),SUM(isah114),SUM(isah115) ",                 #161212-00008#1
   #               "  FROM isah_t ",
   #               " WHERE isahent = '",g_enterprise,"'",
   #               "   AND isahcomp = '",g_isaf_m.isafcomp,"'",
   #               "   AND isahdocno = '",g_isaf_m.isafdocno,"'",
   #               " GROUP BY isah009 ",
   #               " ORDER BY isah009 "
   #              #" ORDER BY isah002"                                                #151007-00002#3
   #ELSE
   #   LET g_sql = "SELECT isah001,isah002,SUM(isah103*isah010),SUM(isah104*isah010),SUM(isah105*isah010)",
   #               "      ,SUM(isah113*isah010),SUM(isah114*isah010),SUM(isah115*isah010) ",    #161212-00008#1
   #               "  FROM isah_t ",
   #               " WHERE isahent = '",g_enterprise,"'",
   #               "   AND isahcomp = '",g_isaf_m.isafcomp,"'",
   #               "   AND isahdocno = '",g_isaf_m.isafdocno,"'",
   #               " GROUP BY isah001,isah002 ",
   #               " ORDER BY isah002"
   #END IF
   #161214-00042#1 mark-----e
   #161214-00042#1-----s
   #有以下幾種情境
   #1.正項   isah001,isah002
   #2.負項共用發票簿    isah001,isah002
   #3.負項不共用發票簿  isah008,isah009
   CASE
      WHEN (g_isaf_m.isaf056 = '1')  OR  (g_isaf_m.isaf056 = '2' AND g_isai006 = 'Y')
         LET g_sql = "SELECT isah001,isah002,SUM(isah103*isah010),SUM(isah104*isah010),SUM(isah105*isah010),",
                     "       SUM(isah113*isah010) ,SUM(isah114*isah010) ,SUM(isah115*isah010)  " , 
                     "  FROM isah_t ",
                     " WHERE isahent = '",g_enterprise,"'",
                     "   AND isahcomp = '",g_isaf_m.isafcomp,"'",
                     "   AND isahdocno = '",g_isaf_m.isafdocno,"'",
                     " GROUP BY isah001,isah002 ",
                     " ORDER BY isah002"
      WHEN g_isaf_m.isaf056 = '2' AND g_isai006 = 'N'
         IF g_isai008 = 'TW' THEN
            LET g_sql = " SELECT ' ',isah009,SUM(isah103),SUM(isah104),SUM(isah105),  ", 
                        "         SUM(isah113),SUM(isah114),SUM(isah115)              ", 
                        "   FROM isah_t ",                                                
                        "  WHERE isahent = '",g_enterprise,"'       ",                    
                        "    AND isahcomp = '",g_isaf_m.isafcomp,"'   ",                    
                        "    AND isahdocno = '",g_isaf_m.isafdocno,"' ",                    
                        "   GROUP BY isah009  ",                                         
                        "   ORDER BY isah009  "                                                   
         ELSE                                                                             
            LET g_sql = " SELECT isah008,isah009,SUM(isah103),SUM(isah104),SUM(isah105),  ", 
                        "         SUM(isah113),SUM(isah114),SUM(isah115)              ", 
                        "   FROM isah_t ",                                                
                        "  WHERE isahent = '",g_enterprise,"'       ",                    
                        "    AND isahcomp = '",g_isaf_m.isafcomp,"'   ",                    
                        "    AND isahdocno = '",g_isaf_m.isafdocno,"' ",                    
                        "   GROUP BY isah008,isah009  ",                                         
                        "   ORDER BY isah008,isah009  "                                          
         END IF
   END CASE
   #161214-00042#1-----e
               
   PREPARE isat_pre FROM g_sql
   DECLARE isat_cus CURSOR FOR isat_pre
   
   FOREACH isat_cus INTO l_isah001,l_isah002,l_isah103,l_isah104,l_isah105
                        ,l_isah113,l_isah114,l_isah115    #161212-00008#1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = 'N'
         EXIT FOREACH
      END IF 
      
      IF cl_null(l_isah001) THEN 
         LET l_isah001 = ' '
      END IF
      
      IF cl_null(l_isah002) THEN 
         CONTINUE FOREACH
      END IF
      
      LET l_isat.isatent   = g_enterprise
      LET l_isat.isatcomp  = g_isaf_m.isafcomp
      LET l_isat.isatdocno = g_isaf_m.isafdocno 
      
      SELECT MAX(isatseq) + 1 INTO l_isat.isatseq FROM isat_t 
        WHERE isatent = g_enterprise 
#          AND isatcomp = g_isaf_m.isafcomp  
#          AND isatdocno = g_isaf_m.isafdocno
          AND isat003 = l_isah001   
          AND isat004 = l_isah002
      IF cl_null(l_isat.isatseq) THEN 
         LET l_isat.isatseq = 1
      END IF
      LET l_isat.isat001 = g_isaf_m.isaf008
      LET l_isat.isat002 = g_isaf_m.isaf009
      #160118-00007#2
      IF l_isat.isat002 = 'Y' THEN
         SELECT isak003 INTO l_isat.isat026
           FROM isak_t WHERE isakent = g_enterprise
            AND isak001 = g_isaf_m.isaf002 AND isak002 = g_ooef019
      END IF
      #160118-00007#2
      LET l_isat.isat003 = l_isah001
      LET l_isat.isat004 = l_isah002
      LET l_isat.isat005 = g_isaf_m.isaf053
      LET l_isat.isat006 = ''
      LET l_isat.isat007 = g_isaf_m.isaf014
      LET l_isat.isat008 = ''
      LET l_isat.isat008 = cl_get_current() 
      LET l_isat.isat009 = g_isaf_m.isaf021
      LET l_isat.isat010 = g_isaf_m.isaf022
      LET l_isat.isat011 = g_isaf_m.isaf023
      LET l_isat.isat012 = g_isaf_m.isaf028
      LET l_isat.isat013 = g_isaf_m.isaf034
      
      #albireo 151026-----s
      IF g_isaf_m.isaf056 = '1' THEN
         LET l_isat.isat014 = '11' 
      ELSE
         LET l_isat.isat014 = '21'
      END IF
      #albireo 151026-----e
      LET l_isat.isat015 = g_isaf_m.isaf037
      LET l_isat.isat016 = g_isaf_m.isaf038 
      LET l_isat.isat017 = g_isaf_m.isaf039
      LET l_isat.isat018 = g_isaf_m.isaf040
      LET l_isat.isat019 = g_isaf_m.isaf041
      LET l_isat.isat020 = g_isaf_m.isaf042 	
      LET l_isat.isat021 = 0
      LET l_isat.isat022 = g_isaf_m.isaf054
      LET l_isat.isat023 = g_isaf_m.isaf018
      LET l_isat.isat100 = g_isaf_m.isaf100
      LET l_isat.isat101 = g_isaf_m.isaf101
      LET l_isat.isat103 = l_isah103         
      LET l_isat.isat104 = l_isah104      
      LET l_isat.isat105 = l_isah105     
      LET l_isat.isat106 = 0
      LET l_isat.isat107 = 0
      #161212-00008#1 mark-----s
      #LET l_isat.isat113 = l_isat.isat103 * g_isaf_m.isaf101
      #LET l_isat.isat114 = l_isat.isat104 * g_isaf_m.isaf101
      #LET l_isat.isat115 = l_isat.isat105 * g_isaf_m.isaf101
      #161212-00008#1 mark-----e
      #161212-00008#1-----s
      LET l_isat.isat113 = l_isah113
      LET l_isat.isat114 = l_isah114
      LET l_isat.isat115 = l_isah115     
      #161212-00008#1-----e
      
      IF g_isai004 = '1' THEN
         IF l_isat.isat103 < 0 THEN
            LET l_isat.isat103 = l_isat.isat103 * -1
         END IF
         IF l_isat.isat104 < 0 THEN
            LET l_isat.isat104 = l_isat.isat104 * -1
         END IF
         IF l_isat.isat105 < 0 THEN
            LET l_isat.isat105 = l_isat.isat105 * -1
         END IF
         IF l_isat.isat113 < 0 THEN
            LET l_isat.isat113 = l_isat.isat113 * -1
         END IF
         IF l_isat.isat114 < 0 THEN
            LET l_isat.isat114 = l_isat.isat114 * -1
         END IF
         IF l_isat.isat115 < 0 THEN
            LET l_isat.isat115 = l_isat.isat115 * -1
         END IF
      END IF
      
      IF l_isat.isat022 = '1' THEN 
         LET l_isat.isat201 = l_isat.isat105
      ELSE
         LET l_isat.isat201 = 0
      END IF
      
      IF l_isat.isat022 = '2' THEN 
         LET l_isat.isat202 = l_isat.isat105
      ELSE
         LET l_isat.isat202 = 0
      END IF
      
      IF l_isat.isat022 = '3' THEN 
         LET l_isat.isat203 = l_isat.isat105
      ELSE
         LET l_isat.isat203 = 0
      END IF
      LET l_isat.isat204 = g_isaf_m.isaf201
      LET l_isat.isat205 = g_isaf_m.isaf202
      LET l_isat.isat206 = g_isaf_m.isaf203
      LET l_isat.isat207 = g_isaf_m.isaf204
      LET l_isat.isat208 = ''
      LET l_isat.isat209 = ''
      LET l_isat.isat025 = l_isat.isat014     #151005-00007#2
      #150915-----s
#      #150331-00006#5 add ------
#      LET g_isag4_d[l_ac].isatsite = g_isaf_m.isafsite
#      LET g_isag4_d[l_ac].isatdocdt= g_isaf_m.isafdocdt
#      #150331-00006#5 add end---
      LET l_isat.isatsite = g_isaf_m.isaf052
      LET l_isat.isatdocdt = g_isaf_m.isafdocdt
      #150915-----e

      #161223-00053#1 mark ------
      ##160215-00013#1 ---s---  取最接近日期並且為折完之發票
      #IF g_isaf_m.isaf056 = '2' THEN #原始發票日期
      #   SELECT MAX(isat007) INTO l_isat.isat027 FROM isat_t 
      #    WHERE isatent = g_enterprise 
      #      AND (isat103 -isat106 > 0)
      #      AND isat004 = l_isat.isat004 AND isaf056 = '1'
      #      AND isat007 IS NOT NULL
      #   SELECT DISTINCT isaf009 INTO l_isat.isat002 FROM isaf_t #取得原發票電子發票狀態
      #    WHERE isafent = g_enterprise AND isaf011 = l_isat.isat004
      #      AND isaf056 = '1'
      #   IF l_isat.isat002 = 'Y' THEN
      #      SELECT isak003 INTO l_isat.isat026
      #        FROM isak_t WHERE isakent = g_enterprise
      #         AND isak001 = g_isaf_m.isaf002 AND isak002 = g_ooef019
      #   END IF
      #END IF
      #161223-00053#1 mark end---
      #161223-00053#1 add ------
      LET l_isat.isat027 = ''
      IF g_isaf_m.isaf056 = '2' THEN
         #撈取來源明細的來源發票，若無，則來源發票日期給空
         LET l_sql = "SELECT isag013,isag014",
                     "  FROM isag_t",
                     " WHERE isagent = ",g_enterprise,
                     "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
                     "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
                     "   AND isag014 IS NOT NULL"
         PREPARE sel_isag_p2 FROM l_sql
         DECLARE sel_isag_c2 SCROLL CURSOR FOR sel_isag_p2
         OPEN sel_isag_c2
         FETCH FIRST sel_isag_c2 INTO l_isag013,l_isag014
         
         IF NOT cl_null(l_isag014) THEN
            IF g_isai002 = '1' THEN
               SELECT isat007 INTO l_isat.isat027
                 FROM isat_t
                WHERE isatent = g_enterprise
                  AND isat004 = l_isag014
                  AND (isat014 = '11' AND isat025 <> '12')
            ELSE
               SELECT isat007 INTO l_isat.isat027
                 FROM isat_t
                WHERE isatent = g_enterprise
                  AND isat003 = l_isag013
                  AND isat004 = l_isag014
                  AND (isat014 = '11' AND isat025 <> '12')
            END IF
         END IF
      END IF
      #161223-00053#1 add end---
      LET l_isat.isat028 = g_isaf_m.isaf016 #稅別
      LET l_isat.isat029 = g_isaf_m.isaf017 #含稅否
      #160215-00013#1 ---e---
     #INSERT INTO isat_t VALUES(l_isat.*) #161108-00017#6 mark
      #161108-00017#6 --s add
      INSERT INTO isat_t(isatent,isatcomp,isatdocno,isatseq,isat001,
                         isat002,isat003,isat004,isat005,isat006,
                         isat007,isat008,isat009,isat010,isat011,
                         isat012,isat013,isat014,isat015,isat016,
                         isat017,isat018,isat019,isat020,isat021,
                         isat022,isat023,isat024,isat100,isat101,
                         isat103,isat104,isat105,isat106,isat107,
                         isat113,isat114,isat115,isat201,isat202,
                         isat203,isat204,isat205,isat206,isat207,
                         isat208,isat209,isatud001,isatud002,isatud003,
                         isatud004,isatud005,isatud006,isatud007,isatud008,
                         isatud009,isatud010,isatud011,isatud012,isatud013,
                         isatud014,isatud015,isatud016,isatud017,isatud018,
                         isatud019,isatud020,isatud021,isatud022,isatud023,
                         isatud024,isatud025,isatud026,isatud027,isatud028,
                         isatud029,isatud030,isatsite,isatdocdt,isat025,
                         isat026,isat027,isat028,isat029,isat108,
                         isat118)
      VALUES(l_isat.isatent,l_isat.isatcomp,l_isat.isatdocno,l_isat.isatseq,l_isat.isat001,
             l_isat.isat002,l_isat.isat003,l_isat.isat004,l_isat.isat005,l_isat.isat006,
             l_isat.isat007,l_isat.isat008,l_isat.isat009,l_isat.isat010,l_isat.isat011,
             l_isat.isat012,l_isat.isat013,l_isat.isat014,l_isat.isat015,l_isat.isat016,
             l_isat.isat017,l_isat.isat018,l_isat.isat019,l_isat.isat020,l_isat.isat021,
             l_isat.isat022,l_isat.isat023,l_isat.isat024,l_isat.isat100,l_isat.isat101,
             l_isat.isat103,l_isat.isat104,l_isat.isat105,l_isat.isat106,l_isat.isat107,
             l_isat.isat113,l_isat.isat114,l_isat.isat115,l_isat.isat201,l_isat.isat202,
             l_isat.isat203,l_isat.isat204,l_isat.isat205,l_isat.isat206,l_isat.isat207,
             l_isat.isat208,l_isat.isat209,l_isat.isatud001,l_isat.isatud002,l_isat.isatud003,
             l_isat.isatud004,l_isat.isatud005,l_isat.isatud006,l_isat.isatud007,l_isat.isatud008,
             l_isat.isatud009,l_isat.isatud010,l_isat.isatud011,l_isat.isatud012,l_isat.isatud013,
             l_isat.isatud014,l_isat.isatud015,l_isat.isatud016,l_isat.isatud017,l_isat.isatud018,
             l_isat.isatud019,l_isat.isatud020,l_isat.isatud021,l_isat.isatud022,l_isat.isatud023,
             l_isat.isatud024,l_isat.isatud025,l_isat.isatud026,l_isat.isatud027,l_isat.isatud028,
             l_isat.isatud029,l_isat.isatud030,l_isat.isatsite,l_isat.isatdocdt,l_isat.isat025,
             l_isat.isat026,l_isat.isat027,l_isat.isat028,l_isat.isat029,l_isat.isat108,
             l_isat.isat118)  
      #161108-00017#6 --e add             
      IF SQLCA.SQLcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "isat_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
  
         LET r_success = 'N'                            
      END IF
   END FOREACH 
   
   RETURN r_success        
END FUNCTION
# 彙整至發票明細
PRIVATE FUNCTION aist310_s01()
   DEFINE lwin_curr     ui.Window
   DEFINE lfrm_curr     ui.Form
   DEFINE ls_path       STRING
   DEFINE l_msg         STRING
   DEFINE l_today       LIKE isaf_t.isaf014
   DEFINE l_cnt         LIKE type_t.num5
   DEFINE l_isaq005     LIKE isaq_t.isaq005
   
   IF g_isaf_m.isafstus = 'Y' THEN 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "ais-00180"
      LET g_errparam.extend =  g_isaf_m.isafstus
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN
   END IF 
   
   IF NOT cl_null(g_isaf_m.isaf051) THEN
      #SELECT COUNT(*) INTO l_cnt FROM isaf_t #160907-00046#1 mark
      SELECT COUNT(1) INTO l_cnt FROM isaf_t  #160907-00046#1
       WHERE isafent = g_enterprise
         AND isaf051 = g_isaf_m.isaf051
         AND isaf052  = g_isaf_m.isaf052      #160909-00081#1
         AND isafstus = 'N' 
         AND isafdocno<>g_isaf_m.isafdocno
      IF l_cnt>0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = "ais-00160"
         LET g_errparam.extend =  g_isaf_m.isaf051
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN
      END IF 
   END IF
   
   OPEN WINDOW w_aist310_s01 WITH FORM cl_ap_formpath("ais","aist310_s01")
   LET lwin_curr = ui.Window.getCurrent()
   LET lfrm_curr = lwin_curr.getForm()
   LET ls_path = os.Path.join(os.Path.join(FGL_GETENV("ERP"),"cfg"),"4tb")
   LET ls_path = os.Path.join(ls_path,"toolbar_lib.4tb")
   CALL lfrm_curr.loadToolBar(ls_path)
   
      
   IF g_isai002 = '1' THEN 
      LET l_msg = cl_getmsg('ais-00112',g_dlang)
      CALL cl_set_comp_att_text('isae008',l_msg)
   END IF
   IF g_isai002 = '2' THEN 
      LET l_msg = cl_getmsg('ais-00113',g_dlang)
      CALL cl_set_comp_att_text('isae008',l_msg)
   END IF
   
   SELECT isaq005 INTO l_isaq005 
     FROM isaq_t
    WHERE isaqent = g_enterprise
      AND isaqsite = g_isaf_m.isafcomp
      AND isaq001 = g_isaf_m.isaf008
      
   SELECT isac003 INTO g_isac003
     FROM isac_t
    WHERE isacent = g_enterprise
      AND isac001 = g_ooef019
      AND isac002 = g_isaf_m.isaf008
   #WHILE TRUE

      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

         INPUT BY NAME g_isae_m.type,g_isae_m.quota,g_isae_m.merge,g_isae_m.isaesite,
                       g_isae_m.isaesite_desc,g_isae_m.isae001,
                       g_isae_m.isae014,g_isae_m.isae008,g_isae_m.isae012
                       
         BEFORE INPUT
            LET g_isae_m.type = '1'
            LET g_isae_m.merge = 'N'
            LET g_isae_m.isaesite = g_isaf_m.isaf052
         
         
            #160707-00023#2-----s
            IF cl_null(l_isaq005)THEN
               LET l_isaq005 = '1'
               INITIALIZE g_errparam.* TO NULL
               LET g_errparam.code = 'ais-00336'
               LET g_errparam.popup = TRUE
               LET g_errparam.extend = ''
               CALL cl_err()
            END IF
            #160707-00023#2-----e
            #170103-00009#1 add(s)
            #如果發票聯別=4:收據，隱藏發票簿group
            IF g_isaf_m.isaf053 = '4' THEN
               CALL cl_set_comp_visible('lbl_group2',FALSE)
            ELSE 
            #170103-00009#1 add(e)
               IF NOT cl_null(g_isaf_m.isaf051) AND NOT cl_null(g_isaf_m.isaf011) THEN 
                  LET g_isae_m.isae001 = g_isaf_m.isaf051
                  CALL cl_set_comp_visible('lbl_group2',FALSE) 
               ELSE
                  IF l_isaq005 = '1' THEN   #1:列印時回寫  隱藏發票薄條件
                     CALL cl_set_comp_visible('lbl_group2',FALSE) 
                     CALL cl_set_comp_visible('lbl_quota,quota,merge',TRUE) 
                  ELSE
                     CALL cl_set_comp_visible('lbl_group2',TRUE)
                     CALL cl_set_comp_visible('lbl_quota,quota,merge',FALSE)
                     IF g_isac003 = '4' THEN  #發票類型為銷項折單
                        IF g_isai006 = 'N' THEN   #紅字發票與藍字發票共用發票簿
                           CALL cl_set_comp_visible('lbl_group2',FALSE)
                        END IF
                     END IF
                  END IF
               END IF
            END IF    #170103-00009#1 add
            
         ON CHANGE type
            IF g_isae_m.type = '1' OR g_isae_m.type = '2' THEN 
               CALL cl_set_comp_entry("merge",TRUE)
            ELSE
               CALL cl_set_comp_entry("merge",FALSE)
               LET g_isae_m.merge = 'N'
            END IF
            
         AFTER FIELD quota
            IF NOT cl_null(g_isae_m.quota) THEN 
               IF g_isae_m.quota <= 0 THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00178'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
            
                  LET g_isae_m.quota = ''
                  NEXT FIELD CURRENT
               END IF
            END IF
            
         AFTER FIELD isaesite
            IF NOT cl_null(g_isae_m.isaesite) THEN            
               CALL aist310_isaesite_chk()             
               IF NOT cl_null(g_errno) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = g_errno
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
            
                  LET g_isae_m.isaesite = ''
                  NEXT FIELD CURRENT
               END IF
            END IF
            CALL aist310_isaesite_desc()
            CALL aist310_isae_get()
            
         AFTER FIELD isae001
               IF NOT cl_null(g_isae_m.isae001) THEN
                 INITIALIZE g_chkparam.* TO NULL
                 LET g_chkparam.arg1 = g_isae_m.isaesite
                 LET g_chkparam.arg2 = g_isae_m.isae001
                 IF cl_chk_exist("v_isae001") THEN
                    #檢查成功時後續處理
                    CALL aist310_isae_get()
                 ELSE
                    #檢查失敗時後續處理
                    LET g_isae_m.isae001 = ''
                    NEXT FIELD CURRENT
                 END IF
                 #SELECT COUNT(*) INTO l_cnt FROM isaf_t #160907-00046#1 mark
                 SELECT COUNT(1) INTO l_cnt FROM isaf_t  #160907-00046#1 
                  WHERE isafent = g_enterprise
                    AND isaf051 = g_isae_m.isae001
                    AND isaf052  = g_isae_m.isaesite    #160909-00081#1
                    AND isafstus = 'N'
                    AND isafdocno<>g_isaf_m.isafdocno
                 IF l_cnt>0 THEN
                    INITIALIZE g_errparam TO NULL
                    LET g_errparam.code = "ais-00160"
                    LET g_errparam.extend = g_isae_m.isae001
                    LET g_errparam.popup = TRUE
                    CALL cl_err()
                    LET g_isae_m.isae001 = ''
                    NEXT FIELD CURRENT
                 END IF
              END IF
         
         
         ON ACTION controlp INFIELD isaesite
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
	    		   LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_isae_m.isaesite
               IF cl_null(g_isaf_m.isaf014) THEN LET g_isaf_m.isaf014 = g_today END IF  #161102-00041#1
               LET g_qryparam.where = "   isaesite IN ('",g_isae_m.isaesite,"','",g_isaf_m.isafcomp,"' ) ",
                                      "   AND isae004  = '",g_isaf_m.isaf008,"'",
                                      "   AND isae002 <= '",g_isaf_m.isaf014,"'",
                                      "   AND isae003 >= '",g_isaf_m.isaf014,"'",
                                      "   AND isac001 = '",g_ooef019,"'"
               CALL q_isaesite_3()
               LET g_isae_m.isaesite = g_qryparam.return1
               LET g_isae_m.isae001  = g_qryparam.return2
               DISPLAY g_isae_m.isaesite TO isaesite
               CALL aist310_isaesite_desc()
               NEXT FIELD isaesite
               
         ON ACTION controlp INFIELD isae001
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
	    		   LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_isae_m.isae001
               IF cl_null(g_isaf_m.isaf014) THEN
                  LET l_today = g_today
               ELSE
                  LET l_today = g_isaf_m.isaf014
               END IF
               IF g_isaf_m.isaf056 = '2' AND g_isai006 = 'Y' THEN
                  LET g_qryparam.where = "   isaesite IN ('",g_isae_m.isaesite,"','",g_isaf_m.isafcomp,"' ) ",
                                         "   AND isae002 <= '",l_today,"'",
                                         "   AND isae003 >= '",l_today,"'",
                                         "   AND isac001 = '",g_ooef019,"'"
               ELSE
                  LET g_qryparam.where = "   isaesite IN ('",g_isae_m.isaesite,"','",g_isaf_m.isafcomp,"' ) ",
                                         "   AND isae004  = '",g_isaf_m.isaf008,"'",
                                         "   AND isae002 <= '",l_today,"'",
                                         "   AND isae003 >= '",l_today,"'",
                                         "   AND isac001 = '",g_ooef019,"'"
               END IF
               CALL q_isaesite_3()
               LET g_isae_m.isae001 = g_qryparam.return2
               DISPLAY g_isae_m.isae001 TO isae001
               NEXT FIELD isae001 
         
         AFTER INPUT
            IF NOT cl_null(g_isae_m.isae001) THEN
               #SELECT COUNT(*) INTO l_cnt FROM isaf_t #160907-00046#1 mark
               SELECT COUNT(1) INTO l_cnt FROM isaf_t  #160907-00046#1
                WHERE isafent = g_enterprise
                  AND isaf051 = g_isae_m.isae001
                  AND isaf052  = g_isae_m.isaesite    #160909-00081#1
                  AND isafstus = 'N'
                  AND isafdocmp = g_siaf_m.isafcomp
               IF l_cnt>0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = "ais-00160"
                  LET g_errparam.extend = g_isae_m.isae001 
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_isae_m.isae001 = ''
                  NEXT FIELD isae001
               END IF
            END IF              
         END INPUT
         
         ON ACTION accept
            ACCEPT DIALOG

         ON ACTION cancel      #在dialog button (放棄)
            LET g_action_choice=""
            LET INT_FLAG = TRUE
            EXIT DIALOG

         ON ACTION close
            LET INT_FLAG = TRUE
            EXIT DIALOG

         ON ACTION exit
            LET INT_FLAG = TRUE
            EXIT DIALOG
      END DIALOG

      IF INT_FLAG THEN
         LET INT_FLAG = TRUE 
         #EXIT WHILE
      ELSE
         CALL aist310_compile_to_isah()
      END IF
  
   #END WHILE

   #畫面關閉
   CLOSE WINDOW w_aist310_s01
   CALL aist310_show() 
END FUNCTION
#發票補登
PRIVATE FUNCTION aist310_invoice()
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_n                   LIKE type_t.num5                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num5                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num5
   DEFINE  l_i                   LIKE type_t.num5
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num5
   DEFINE  li_reproduce_target   LIKE type_t.num5
   DEFINE  ls_keys               DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE  l_isat105             LIKE isat_t.isat105
   #150918-00001#7-----s
   DEFINE l_oodb004   LIKE oodb_t.oodb004
   DEFINE l_oodb005   LIKE oodb_t.oodb005
   DEFINE l_oodb006   LIKE oodb_t.oodb006
   DEFINE l_oodb011   LIKE oodb_t.oodb011
   #150918-00001#7-----e
   #151028 albireo-----s
   DEFINE l_isaf105   LIKE isaf_t.isaf105
   #151028 albireo-----e
   DEFINE l_isatcnt   LIKE type_t.num10   #160105-00015#2
  #DEFINE l_ooef019   LIKE ooef_t.ooef019 #160105-00015#2 #160803-00044#1 mark
  #DEFINE l_isai008   LIKE isai_t.isai008 #160105-00015#2 #160803-00044#1 mark
   #160907-00041#1 --s add
   DEFINE l_isae007              LIKE isae_t.isae007
   DEFINE l_isae012              LIKE isae_t.isae012
   DEFINE l_len                  LIKE type_t.num5
   DEFINE l_isae012_n            LIKE isae_t.isae012    #下次列印號碼
   DEFINE l_isae012_max          LIKE isae_t.isae012    #該次發票號碼最大號
   DEFINE l_add                  LIKE type_t.num10      #該次發票開票數
   DEFINE l_str                  STRING
   DEFINE l_sql                  STRING
   DEFINE l_isae012_str          STRING
   DEFINE l_isae002              LIKE isae_t.isae002
   DEFINE l_isae003              LIKE isae_t.isae003
   DEFINE l_isae008              LIKE isae_t.isae008
   DEFINE l_isae016              LIKE isae_t.isae016
   DEFINE l_isae017              LIKE isae_t.isae017
   DEFINE l_isaf011              LIKE isaf_t.isaf011
   #160907-00041#1 --e add
   DEFINE l_isat_cnt             LIKE type_t.num10       #161101-00039#1
   DEFINE l_cnt_isat             LIKE type_t.num10       #161020-00021#1 add 計算isat目前有無資料
   DEFINE l_isae012_o            LIKE isae_t.isae012     #161201-00028#1 add
   DEFINE l_date                 DATETIME YEAR TO SECOND #170120-00040#1
   #170214-00045#1 add ------
   DEFINE  l_isag013             LIKE isag_t.isag013
   DEFINE  l_isag014             LIKE isag_t.isag014
   #170214-00045#1 add end---
   
   #150918-00001#7-----s
   #取單頭稅別含稅否
   CALL s_tax_chk(g_isaf_m.isafcomp,g_isaf_m.isaf016) RETURNING g_sub_success,l_oodb004,l_oodb005,l_oodb006,l_oodb011
   #150918-00001#7-----e
   
   #160803-00044#1 mark ------
   ##160105-00015#2-----s
   ##增加國別條件
   #LET l_ooef019 = NULL
   #SELECT ooef019 
   #  INTO l_ooef019
   #  FROM ooef_t
   # WHERE ooefent = g_enterprise
   #   AND ooef001 = g_isaf_m.isafcomp
   #   AND ooefstus = 'Y'
   #
   #LET l_isai008 = NULL
   #SELECT isai008
   #  INTO l_isai008
   #  FROM isai_t 
   # WHERE isaient = g_enterprise
   #   AND isai001 = l_ooef019
   ##160105-00015#2-----e
   #160803-00044#1 mark end---

   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
   
       INPUT ARRAY g_isag4_d FROM s_detail4.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = TRUE, #此頁面insert功能由產生器控制, 手動之設定無效! 

                 DELETE ROW = TRUE,
                 APPEND ROW = TRUE)
                 
         #自訂ACTION(detail_input,page_4)
         
         
         BEFORE INPUT
            #add-point:資料輸入前
            #160907-00041#1 --s add
            
            #161214-00053#1 mark ------
            ##SELECT isai002 INTO g_isai002                  #161020-00002#1 mark
            #SELECT isai002,isai006 INTO g_isai002,g_isai006 #161020-00002#1
            #  FROM isai_t
            # WHERE isaient = g_enterprise
            #   AND isai001 = g_ooef019
            #161214-00053#1 mark end---
            
            CALL cl_set_comp_visible('isaf010',TRUE)
            IF g_isai002 = '1' THEN 
               CALL cl_set_comp_visible('isaf010',FALSE)  
            END IF
            #160907-00041#1 --e add

            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_isag4_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aist310_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_detail_idx)
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_isag4_d.getLength()
            #add-point:資料輸入前
            
            #end add-point
            
         BEFORE INSERT
            
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_isag4_d[l_ac].* TO NULL 
            INITIALIZE g_isag4_d_t.* TO NULL 
            INITIALIZE g_isag4_d_o.* TO NULL 
            #公用欄位給值(單身4)
            
            #自定義預設值(單身4)
                  LET g_isag4_d[l_ac].isat105 = "0"
      LET g_isag4_d[l_ac].isat104 = "0"
      LET g_isag4_d[l_ac].isat106 = "0"
      LET g_isag4_d[l_ac].isat107 = "0"
      LET g_isag4_d[l_ac].isat002 = 'N'    #160118-00007#2
 
            #add-point:modify段before備份
            LET g_isag4_d[l_ac].isat103 = 0
            LET g_isag4_d[l_ac].isat113 = 0
            LET g_isag4_d[l_ac].isat104 = 0
            LET g_isag4_d[l_ac].isat114 = 0
            LET g_isag4_d[l_ac].isat105 = 0
            LET g_isag4_d[l_ac].isat115 = 0
            #161214-00053#1 add ------
            #IF g_isaf_m.isaf011 <> 'MULTI' THEN #170116-00020#1 mark
            IF g_isaf_m.isaf011 <> 'MULTI' AND l_ac = 1 THEN #170116-00020#1 add
               LET g_isag4_d[l_ac].isat003 = g_isaf_m.isaf010
               LET g_isag4_d[l_ac].isat004 = g_isaf_m.isaf011
               DISPLAY By NAME g_isag4_d[l_ac].isat003,g_isag4_d[l_ac].isat004
            END IF
            #161214-00053#1 add end---
            #170116-00020#1 add ------
            IF g_isaf_m.isaf056='1' AND l_ac > 1 THEN
               SELECT isae007,isae008,isae012 INTO l_isae007,l_isae008,l_isae012
                 FROM isae_t
                WHERE isaeent  = g_enterprise
                  AND isaesite = g_isaf_m.isaf052
                  AND isae001  = g_isaf_m.isaf051
                  AND isae002 <= g_isaf_m.isaf014
                  AND isae003 >= g_isaf_m.isaf014
                  AND isae004  = g_isaf_m.isaf008
               IF g_isai002 = '1' THEN
                  LET g_isag4_d[l_ac].isat004 = l_isae007 CLIPPED,l_isae012 CLIPPED
               ELSE
                  LET g_isag4_d[l_ac].isat003 = l_isae008
                  LET g_isag4_d[l_ac].isat004 = l_isae012
               END IF
            END IF
            #170116-00020#1 add ------
            #end add-point
            LET g_isag4_d_t.* = g_isag4_d[l_ac].*     #新輸入資料
            LET g_isag4_d_o.* = g_isag4_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aist310_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b

            #end add-point
            CALL aist310_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_isag4_d[li_reproduce_target].* = g_isag4_d[li_reproduce].*
 
               LET g_isag4_d[li_reproduce_target].isatseq = NULL
               LET g_isag4_d[li_reproduce_target].isat003 = NULL
               LET g_isag4_d[li_reproduce_target].isat004 = NULL
            END IF
            
            #add-point:modify段before insert
#            IF cl_null(g_isag4_d[g_detail_idx].isatseq) THEN 
#               SELECT MAX(isatseq) INTO g_isag4_d[g_detail_idx].isatseq
#                 FROM isat_t
#                WHERE isatent = g_enterprise
#                  AND isatcomp = g_isaf_m.isafcomp  
#                  AND isatdocno = g_isaf_m.isafdocno
#                  
#               IF cl_null(g_isag4_d[g_detail_idx].isatseq) THEN 
#                  LET g_isag4_d[g_detail_idx].isatseq = 1
#               ELSE
#                  LET g_isag4_d[g_detail_idx].isatseq = g_isag4_d[g_detail_idx].isatseq + 1
#               END IF
#            END IF
            
            IF g_isaf_m.isaf056 = '1' THEN 
               LET g_isag4_d[g_detail_idx].isat014 = '11'
            ELSE
               LET g_isag4_d[g_detail_idx].isat014 = '21'
            END IF 
            LET g_isag4_d[g_detail_idx].isat017 = g_today
            IF g_detail_idx = 1 THEN
               LET g_isag4_d[g_detail_idx].isat103 = g_isaf_m.isaf103
               LET g_isag4_d[g_detail_idx].isat104 = g_isaf_m.isaf104
               LET g_isag4_d[g_detail_idx].isat105 = g_isaf_m.isaf105
               #150915-00009#3-----s
               LET g_isag4_d[g_detail_idx].isat113 = g_isaf_m.isaf113
               LET g_isag4_d[g_detail_idx].isat114 = g_isaf_m.isaf114
               LET g_isag4_d[g_detail_idx].isat115 = g_isaf_m.isaf115
               #150915-00009#3-----e
               #161214-00053#1 add ------
               IF g_isai004 = '1' THEN
                  IF g_isag4_d[g_detail_idx].isat103 < 0 THEN
                     LET g_isag4_d[g_detail_idx].isat103 = g_isag4_d[g_detail_idx].isat103 * -1
                  END IF
                  IF g_isag4_d[g_detail_idx].isat104 < 0 THEN
                     LET g_isag4_d[g_detail_idx].isat104 = g_isag4_d[g_detail_idx].isat104 * -1
                  END IF
                  IF g_isag4_d[g_detail_idx].isat105 < 0 THEN
                     LET g_isag4_d[g_detail_idx].isat105 = g_isag4_d[g_detail_idx].isat105 * -1
                  END IF
                  IF g_isag4_d[g_detail_idx].isat113 < 0 THEN
                     LET g_isag4_d[g_detail_idx].isat113 = g_isag4_d[g_detail_idx].isat113 * -1
                  END IF
                  IF g_isag4_d[g_detail_idx].isat114 < 0 THEN
                     LET g_isag4_d[g_detail_idx].isat114 = g_isag4_d[g_detail_idx].isat114 * -1
                  END IF
                  IF g_isag4_d[g_detail_idx].isat115 < 0 THEN
                     LET g_isag4_d[g_detail_idx].isat115 = g_isag4_d[g_detail_idx].isat115 * -1
                  END IF
               END IF
               #161214-00053#1 add end---
            END IF
            
            #161214-00053#1 mark ------
            ##albireo 151026-----s
            ##AIS發票明細對帳單仍是存正數
            #IF g_isag4_d[g_detail_idx].isat103 <0 THEN LET g_isag4_d[g_detail_idx].isat103 = g_isag4_d[g_detail_idx].isat103 * -1 END IF
            #IF g_isag4_d[g_detail_idx].isat104 <0 THEN LET g_isag4_d[g_detail_idx].isat104 = g_isag4_d[g_detail_idx].isat104 * -1 END IF
            #IF g_isag4_d[g_detail_idx].isat105 <0 THEN LET g_isag4_d[g_detail_idx].isat105 = g_isag4_d[g_detail_idx].isat105 * -1 END IF
            #IF g_isag4_d[g_detail_idx].isat113 <0 THEN LET g_isag4_d[g_detail_idx].isat113 = g_isag4_d[g_detail_idx].isat113 * -1 END IF
            #IF g_isag4_d[g_detail_idx].isat114 <0 THEN LET g_isag4_d[g_detail_idx].isat114 = g_isag4_d[g_detail_idx].isat114 * -1 END IF
            #IF g_isag4_d[g_detail_idx].isat115 <0 THEN LET g_isag4_d[g_detail_idx].isat115 = g_isag4_d[g_detail_idx].isat115 * -1 END IF
            ##albireo 151026-----e
            #161214-00053#1 mark end---
            #150331-00006#5 add ------
            #LET g_isag4_d[g_detail_idx].isatsite = g_isaf_m.isafsite    #150915 mark
            LET g_isag4_d[g_detail_idx].isatsite = g_isaf_m.isaf052      #150915 add
            LET g_isag4_d[g_detail_idx].isatdocdt= g_isaf_m.isafdocdt
            #150331-00006#5 add end---
            #160104-00015#1 add ------
            #預待日期帶單頭的發票日期
            LET g_isag4_d[l_ac].isat007 = g_isaf_m.isaf014
            CALL cl_set_comp_required("isat007",TRUE)
            #160104-00015#1 add end---                       
            #end add-point  
            
         BEFORE ROW     
            #add-point:modify段before row2

            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist310_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CLOSE aist310_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            
            LET g_rec_b = g_isag4_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_isag4_d[l_ac].isatseq IS NOT NULL
               AND g_isag4_d[l_ac].isat003 IS NOT NULL
               AND g_isag4_d[l_ac].isat004 IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_isag4_d_t.* = g_isag4_d[l_ac].*  #BACKUP
               LET g_isag4_d_o.* = g_isag4_d[l_ac].*  #BACKUP
               CALL aist310_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b

               #end add-point  
               CALL aist310_set_no_entry_b(l_cmd)
               IF NOT aist310_lock_b("isat_1_t","'5'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aist310_bcl5 INTO g_isag4_d[l_ac].isatseq,g_isag4_d[l_ac].isat003,g_isag4_d[l_ac].isat004,
                                          g_isag4_d[l_ac].isat103,g_isag4_d[l_ac].isat104,g_isag4_d[l_ac].isat105,
                                          g_isag4_d[l_ac].isat007,g_isag4_d[l_ac].isat014,g_isag4_d[l_ac].isat106,
                                          g_isag4_d[l_ac].isat107,g_isag4_d[l_ac].isat017
                                                
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = '' 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  LET g_bfill = "N"
                  CALL aist310_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row
            CALL cl_set_act_visible("delete", TRUE)
            
            #151029-00001#3 add ------
            #如果是開立發票，發票補登時，若該發票已被折，則不可修改
            CALL cl_set_comp_entry("isat003,isat004,isat103,isat104,isat105",TRUE)
            CALL cl_set_comp_entry("isat113,isat114,isat115,isat007,isat014",TRUE)
            CALL cl_set_comp_entry("isat106,isat107",TRUE)
            IF g_isaf_m.isaf056 = '1' AND NOT cl_null(g_isag4_d[l_ac].isat004) THEN
               LET l_cnt = 0
               #SELECT COUNT(*) INTO l_cnt  #160907-00046#1 mark
               SELECT COUNT(1) INTO l_cnt   #160907-00046#1
                 FROM isaf_t
                 LEFT JOIN isat_t ON isafent = isatent AND isafcomp = isatcomp AND isafdocno = isatdocno
                WHERE isatent = g_enterprise
                  AND isat004 = g_isag4_d[l_ac].isat004
                  AND (isat014 = '11' OR isat025 <> '12')
                  AND ((isatdocno = g_isaf_m.isafdocno AND isatseq <> g_isag4_d[l_ac].isatseq) OR (isatdocno <> g_isaf_m.isafdocno))
                  AND isafstus <> 'X'
                  AND isaf056 ='2'
               IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
               IF l_cnt > 0 THEN
                  CALL cl_set_comp_entry("isat003,isat004,isat103,isat104,isat105",FALSE)
                  CALL cl_set_comp_entry("isat113,isat114,isat115,isat007,isat014",FALSE)
                  CALL cl_set_comp_entry("isat106,isat107",FALSE)
               END IF
            END IF
            #151029-00001#3 add end---
            
            CALL cl_set_comp_entry("isat014",FALSE)  #狀態一律給預設值不可更改 #151229-00001#2
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
            #其他table進行lock
            
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
            ELSE
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = -263 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身4刪除前
               #161206-00035#1   mark---s
               #161201-00028#1   add---s
               #取isat發票歷程檔中本次開立最大的發票
               #LET l_isae012_max = ''
               #SELECT MAX(isat004) INTO l_isae012_max
               #  FROM isat_t
               # WHERE isatent = g_enterprise
               #   AND isatcomp = g_isaf_m.isafcomp
               #   AND isatdocno = g_isaf_m.isafdocno
               #   AND isat025 IN ('11','21')   #開立狀態
               #
               #IF NOT cl_null(l_isae012_max) THEN
               #   IF g_isai002 = '1' THEN
               #      IF NOT cl_null(l_isae007)THEN
               #         LET l_str = cl_replace_str(l_isae012,l_isae007,'')
               #         LET l_isae012 = l_str.trim()
               #         LET l_str = cl_replace_str(l_isae012_max,l_isae007,'')
               #         LET l_isae012_max = l_str.trim()                           
               #      END IF
               #   END IF
               #END IF
               #LET l_isae012_o = g_isaf_m.isaf011
               #IF g_isai002 = '1' THEN
               #   LET l_isae012_o = g_isaf_m.isaf011[3,10]
               #END IF
               #161206-00035#1   mark---e
               #161206-00035#1   add---s
               LET l_isae012_o = g_isag4_d[l_ac].isat004
               IF g_isai002 = '1' THEN
                  LET l_isae012_o = g_isag4_d[l_ac].isat004[3,10]
               END IF
               #抓取發票簿下次列印發票號碼
               LET l_isae012 = ''
               SELECT isae012 INTO l_isae012
                 FROM isae_t
                WHERE isaeent  = g_enterprise
                  AND isaesite = g_isaf_m.isaf052
                  AND isae001  = g_isaf_m.isaf051
                  AND isae002 <= g_isaf_m.isaf014  
                  AND isae003 >= g_isaf_m.isaf014
                  AND isae004  = g_isaf_m.isaf008    

               IF l_isae012 = (l_isae012_o +1) THEN
                  LET l_date = cl_get_current()              #170120-00040#1
                  UPDATE isae_t SET isae012 = l_isae012_o ,  #發票簿下次列印號碼
                                    isae013 = isae013 - 1    #已開張數
                                   ,isaemodid = g_user       #170120-00040#1
                                   ,isaemoddt = l_date       #170120-00040#1
                   WHERE isaeent  = g_enterprise
                     AND isaesite = g_isaf_m.isaf052
                     AND isae001  = g_isaf_m.isaf051
                     AND isae002 <= g_isaf_m.isaf014
                     AND isae003 >= g_isaf_m.isaf014
               END IF
               #161206-00035#1   add---e
               #161201-00028#1   add---e
               #end add-point    
               
               DELETE FROM isat_t
                WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp AND
                                          isatdocno = g_isaf_m.isafdocno AND
                      isatseq = g_isag4_d_t.isatseq
                  AND isat003 = g_isag4_d_t.isat003
                  AND isat004 = g_isag4_d_t.isat004
                  
               #add-point:單身4刪除中
               #161206-00035#1   mark---s
               #161201-00028#1   add---s
               #LET l_isae012_o = g_isaf_m.isaf011
               #IF g_isai002 = '1' THEN
               #   LET l_isae012_o = g_isaf_m.isaf011[3,10]
               #   LET l_isae012_max = l_isae012_max[3,10]
               #END IF
               #
               ##抓取發票簿下次列印發票號碼
               #LET l_isae012 = ''
               #SELECT isae012 INTO l_isae012
               # FROM isae_t
               #WHERE isaeent  = g_enterprise
               #  AND isaesite = g_isaf_m.isaf052
               #  AND isae001  = g_isaf_m.isaf051
               #  AND isae002 <= g_isaf_m.isaf014  
               #  AND isae003 >= g_isaf_m.isaf014
               #  AND isae004  = g_isaf_m.isaf008
               ##發票號碼小於發票簿下次列印發票號碼,則須更新發票簿下次列印號碼
               #IF l_isae012 > l_isae012_max THEN
               #   LET l_add = l_isae012 - l_isae012_max #減少的張數
               #   IF s_transaction_chk("N",0) THEN
               #      CALL s_transaction_begin()
               #   END IF
               #   #計算下次列印號碼
               #   LET l_isae012_str = l_isae012
               #   LET l_len = l_isae012_str.getLength()
               #   LET l_sql = "SELECT lpad('",l_isae012,"'-",l_add,",",l_len,",'0') FROM dual"
               #   PREPARE isae012_change_pre6 FROM l_sql
               #   EXECUTE isae012_change_pre6 INTO l_isae012_o
               #   UPDATE isae_t SET isae012 = l_isae012_o,     #發票簿下次列印號碼
               #                     isae013 = isae013 - l_add  #已開張數
               #    WHERE isaeent  = g_enterprise
               #      AND isaesite = g_isaf_m.isaf052
               #      AND isae001  = g_isaf_m.isaf051
               #      AND isae002 <= g_isaf_m.isaf014
               #      AND isae003 >= g_isaf_m.isaf014
               #   IF SQLCA.SQLcode THEN
               #      INITIALIZE g_errparam TO NULL
               #      LET g_errparam.code = SQLCA.sqlcode
               #      LET g_errparam.extend = "update_isae012_erro"
               #      LET g_errparam.popup = TRUE
               #      CALL cl_err()
               #      CALL s_transaction_end('N','0')
               #      EXIT DIALOG 
               #   ELSE
               #      CALL s_transaction_end('Y','0')
               #   END IF
               #END IF
               #161201-00028#1   add---e
               #161206-00035#1   mark---e
               #end add-point    
                  
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "isag_t" 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE   
               ELSE
                  LET g_rec_b = g_rec_b-1
                  
                  #add-point:單身4刪除後
                  
                  #end add-point
                  
                  #取得該筆資料key值
                  INITIALIZE gs_keys TO NULL
                  LET gs_keys[01] = g_isaf_m.isafcomp
                  LET gs_keys[gs_keys.getLength()+1] = g_isaf_m.isafdocno
                  LET gs_keys[gs_keys.getLength()+1] = g_isag4_d[g_detail_idx].isatseq
                  
                  #刪除同層單身
                  IF NOT aist310_delete_b('isat_t',gs_keys,"'4'") THEN
                     CALL s_transaction_end('N','0')
                     CLOSE aist310_bcl
                     CANCEL DELETE
                  END IF
    
                  #刪除下層單身
                  IF NOT aist310_key_delete_b(gs_keys,'isat_t') THEN
                     CALL s_transaction_end('N','0')
                     CLOSE aist310_bcl
                     CANCEL DELETE
                  END IF
                  
               END IF 
               CLOSE aist310_bcl
               LET l_count = g_isag_d.getLength()
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys[3] = g_isag4_d[g_detail_idx].isatseq
               LET gs_keys[4] = g_isag4_d[g_detail_idx].isat003
               LET gs_keys[5] = g_isag4_d[g_detail_idx].isat004
 
            END IF 
    
         AFTER DELETE 
            #如果是最後一筆
            IF l_ac = (g_isag4_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
         AFTER INSERT    
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身4新增前
            IF cl_null(g_isag4_d[l_ac].isat003)THEN LET g_isag4_d[l_ac].isat003 = ' ' END IF #albireo 151026 add
            
            SELECT MAX(isatseq) INTO g_isag4_d[g_detail_idx].isatseq
                FROM isat_t
               WHERE isatent = g_enterprise
                 AND isat003 = g_isag4_d[l_ac].isat003  
                 AND isat004 = g_isag4_d[l_ac].isat004
            IF cl_null(g_isag4_d[g_detail_idx].isatseq) THEN 
               LET g_isag4_d[g_detail_idx].isatseq = 1
            ELSE
               LET g_isag4_d[g_detail_idx].isatseq = g_isag4_d[g_detail_idx].isatseq + 1
            END IF
            #end add-point
               
            LET l_count = 1  
            #SELECT COUNT(*) INTO l_count FROM isat_t #160907-00046#1 mark
            SELECT COUNT(1) INTO l_count FROM isat_t  #160907-00046#1 
             WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp
               AND isatdocno = g_isaf_m.isafdocno
               AND isatseq = g_isag4_d[l_ac].isatseq
               AND isat003 = g_isag4_d[l_ac].isat003
               AND isat004 = g_isag4_d[l_ac].isat004
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身4新增前

               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys[3] = g_isag4_d[g_detail_idx].isatseq
               LET gs_keys[4] = g_isag4_d[g_detail_idx].isat003
               LET gs_keys[5] = g_isag4_d[g_detail_idx].isat004
               CALL aist310_insert_b('isat_t',gs_keys,"'5'")
               
               
                           
               #add-point:單身新增後4

               #end add-point
            ELSE    
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code   = "std-00006" 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               INITIALIZE g_isag_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isat_t" 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CALL s_transaction_end('N','0')                    
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aist310_b_fill()
               #資料多語言用-增/改
               
               #add-point:單身新增後

               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               LET g_isag4_d[l_ac].* = g_isag4_d_t.*
               CLOSE aist310_bcl5
               CALL s_transaction_end('N','0')
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_isag4_d[l_ac].* = g_isag4_d_t.*
            ELSE
               #add-point:單身page4修改前
               #151021    ---s---
               IF g_isag4_d[l_ac].isat004 <>  g_isag4_d_t.isat004 THEN
                   SELECT MAX(isatseq) + 1 INTO g_isag4_d[l_ac].isatseq FROM isat_t 
                    WHERE isatent = g_enterprise 
                      AND isat003 = g_isag4_d[l_ac].isat003      
                      AND isat004 = g_isag4_d[l_ac].isat004
                   IF cl_null(g_isag4_d[l_ac].isatseq) THEN 
                      LET g_isag4_d[l_ac].isatseq = 1
                   ELSE
                      LET g_isag4_d[l_ac].isatseq = g_isag4_d[l_ac].isatseq + 1
                   END IF                                                                                                              
               END IF                                  
               #151021   ---e---
               #end add-point
               
               #寫入修改者/修改日期資訊(單身4)
               #150918-00001#7 mark-----s
#               #150915-00009#3-----s
#               LET g_isag4_d[l_ac].isat103 = g_isag4_d[l_ac].isat113
#               LET g_isag4_d[l_ac].isat104 = g_isag4_d[l_ac].isat114
#               LET g_isag4_d[l_ac].isat105 = g_isag4_d[l_ac].isat115
#               #150915-00009#3-----e
               #150918-00001#7 mark------e
               
               UPDATE isat_t SET (isatcomp,isatdocno,isatseq,isat003,isat004,isat103,isat104,isat105,isat007,
                                  isat113,isat114,isat115,                #150915-00009#3 add
                                  isat014,isat106,isat107,isat017,isat027,isat002,isat006) ##160215-00013#1 add isat027,isat002,isat006
                               = (g_isaf_m.isafcomp,g_isaf_m.isafdocno,g_isag4_d[l_ac].isatseq, 
                                  g_isag4_d[l_ac].isat003,g_isag4_d[l_ac].isat004,g_isag4_d[l_ac].isat103,
                                  g_isag4_d[l_ac].isat104,g_isag4_d[l_ac].isat105,g_isag4_d[l_ac].isat007, 
                                  g_isag4_d[l_ac].isat113,g_isag4_d[l_ac].isat114,g_isag4_d[l_ac].isat115,  #150915-00009#3 add
                                  g_isag4_d[l_ac].isat014,g_isag4_d[l_ac].isat106,g_isag4_d[l_ac].isat107, 
                                  g_isag4_d[l_ac].isat017,g_isag4_d[l_ac].isat027,g_isag4_d[l_ac].isat002,g_isag4_d[l_ac].isat006)
                                  
                WHERE isatent = g_enterprise AND isatcomp = g_isaf_m.isafcomp
                  AND isatdocno = g_isaf_m.isafdocno
                  AND isatseq = g_isag4_d_t.isatseq #項次 
                  AND isat003 = g_isag4_d_t.isat003
                  AND isat004 = g_isag4_d_t.isat004
                  
               #add-point:單身page4修改中

               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isat_t" 
                     LET g_errparam.code   = "std-00009" 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     CALL s_transaction_end('N','0')
                     LET g_isag4_d[l_ac].* = g_isag4_d_t.*
                  WHEN SQLCA.sqlcode #其他錯誤
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isat_t" 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     CALL s_transaction_end('N','0')
                     LET g_isag4_d[l_ac].* = g_isag4_d_t.*
                  OTHERWISE
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys_bak[1] = g_isafcomp_t
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys_bak[2] = g_isafdocno_t
               LET gs_keys[3] = g_isag4_d[g_detail_idx].isatseq
               LET gs_keys_bak[3] = g_isag4_d_t.isatseq
               LET gs_keys[4] = g_isag4_d[g_detail_idx].isat003
               LET gs_keys_bak[4] = g_isag4_d_t.isat003
               LET gs_keys[5] = g_isag4_d[g_detail_idx].isat004
               LET gs_keys_bak[5] = g_isag4_d_t.isat004
               CALL aist310_update_b('isat_t',gs_keys,gs_keys_bak,"'4'")
                     #資料多語言用-增/改
                     
               END CASE
               
               #判斷key是否有改變
               INITIALIZE ls_keys TO NULL
               IF NOT (g_isag4_d[g_detail_idx].isatseq = g_isag4_d_t.isatseq 
                  AND g_isag4_d[g_detail_idx].isat003 = g_isag4_d_t.isat003 
                  AND g_isag4_d[g_detail_idx].isat004 = g_isag4_d_t.isat004 
                  ) THEN
                  LET ls_keys[01] = g_isaf_m.isafcomp
                  LET ls_keys[ls_keys.getLength()+1] = g_isaf_m.isafdocno
                  LET ls_keys[ls_keys.getLength()+1] = g_isag4_d_t.isatseq
                  LET ls_keys[ls_keys.getLength()+1] = g_isag4_d_t.isat003
                  LET ls_keys[ls_keys.getLength()+1] = g_isag4_d_t.isat004
                  CALL aist310_key_update_b(ls_keys,'isat_t')
               END IF
               
               #修改歷程記錄
               LET g_log1 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag4_d_t)
               LET g_log2 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag4_d[l_ac])
               IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身page4修改後

               #end add-point
            END IF
         
                  #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isatseq
            #add-point:BEFORE FIELD isatseq

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isatseq
            
            #add-point:AFTER FIELD isatseq
            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag4_d[g_detail_idx].isatseq IS NOT NULL AND g_isag4_d[g_detail_idx].isat003 IS NOT NULL AND g_isag4_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isag4_d[g_detail_idx].isatseq != g_isag4_d_t.isatseq OR g_isag4_d[g_detail_idx].isat003 != g_isag4_d_t.isat003 OR g_isag4_d[g_detail_idx].isat004 != g_isag4_d_t.isat004)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isatseq
            #add-point:ON CHANGE isatseq

            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat003
            #add-point:BEFORE FIELD isat003

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat003
            
            #add-point:AFTER FIELD isat003
            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag4_d[g_detail_idx].isatseq IS NOT NULL AND g_isag4_d[g_detail_idx].isat003 IS NOT NULL AND g_isag4_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isag4_d[g_detail_idx].isatseq != g_isag4_d_t.isatseq OR g_isag4_d[g_detail_idx].isat003 != g_isag4_d_t.isat003 OR g_isag4_d[g_detail_idx].isat004 != g_isag4_d_t.isat004)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN  #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
                  
               END IF
            END IF
            #161214-00053#1 add ------
            #輸入的發票代碼是否存在發票簿
            IF NOT cl_null(g_isag4_d[l_ac].isat003) THEN
               IF g_isai002 = '2' THEN
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n
                    FROM isae_t
                   WHERE isaeent = g_enterprise
                     AND isaecomp = g_isaf_m.isafcomp
                     AND isaesite = g_isaf_m.isaf052
                     AND isae002 <= g_isaf_m.isaf014
                     AND isae003 >= g_isaf_m.isaf014
                     AND isae008 = g_isag4_d[l_ac].isat003
                  IF cl_null(l_n) THEN LET l_n = 0 END IF
                  IF l_n = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00152'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isag4_d[l_ac].isat003 = g_isag4_d_t.isat003
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            #161214-00053#1 add end---
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat003
            #add-point:ON CHANGE isat003

            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat004
            #add-point:BEFORE FIELD isat004
            #161214-00053#1 mark ------
            ##160907-00041#1 --s add
            #IF cl_null(g_isag4_d[l_ac].isat004) AND g_isaf_m.isaf011 <> 'MULTI' THEN
            #   IF NOT cl_null(g_isaf_m.isaf011) AND g_isaf_m.isaf011 != g_isaf_m_o.isaf011 OR cl_null(g_isaf_m_t.isaf011) THEN
            #      LET g_isag4_d[l_ac].isat004 = g_isaf_m.isaf011 
            #      DISPLAY By NAME g_isag4_d[l_ac].isat004
            #   END IF
            #END IF
            ##160907-00041#1 --e add
            #161214-00053#1 mark end---
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat004
            
            #add-point:AFTER FIELD isat004
            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_isaf_m.isafcomp IS NOT NULL AND g_isaf_m.isafdocno IS NOT NULL AND g_isag4_d[g_detail_idx].isatseq IS NOT NULL AND g_isag4_d[g_detail_idx].isat003 IS NOT NULL AND g_isag4_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isaf_m.isafcomp != g_isafcomp_t OR g_isaf_m.isafdocno != g_isafdocno_t OR g_isag4_d[g_detail_idx].isatseq != g_isag4_d_t.isatseq OR g_isag4_d[g_detail_idx].isat003 != g_isag4_d_t.isat003 OR g_isag4_d[g_detail_idx].isat004 != g_isag4_d_t.isat004)) THEN 
                  #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1 mark 
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "|| "isatseq = '"||g_isag4_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isag4_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isag4_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN #160907-00046#1   
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            
            #151029-00001#3 add ------
            IF NOT cl_null(g_isag4_d[l_ac].isat004) THEN
               IF g_isag4_d[l_ac].isat004 != g_isag4_d_o.isat004 OR g_isag4_d_o.isat004 IS NULL THEN
                  #170103-00009#1 add ------
                  #如果發票聯別=4:收據，不用檢核是否存在發票簿
                  IF g_isaf_m.isaf053 <> '4' THEN
                  #170103-00009#1 add end---
                     #161214-00053#1 add ------
                     LET l_n = 0
                     IF g_isai002 = '1' THEN
                        LET l_sql ="SELECT COUNT(1)",
                                   "  FROM isae_t",
                                   " WHERE isaeent = ",g_enterprise,
                                   "   AND isaecomp = '",g_isaf_m.isafcomp,"'",
                                   "   AND isaesite = '",g_isaf_m.isaf052,"'",
                                   #"   AND (isae009 <= ",g_isag4_d[l_ac].isat004," AND isae010 >= ",g_isag4_d[l_ac].isat004,")" #170116-00020#1 mark
                                   "   AND (isae009 <= ",g_isag4_d[l_ac].isat004[3,10]," AND isae010 >= ",g_isag4_d[l_ac].isat004[3,10],")" #170116-00020#1 add
                     ELSE
                        LET l_sql ="SELECT COUNT(1)",
                                   "  FROM isae_t",
                                   " WHERE isaeent = ",g_enterprise,
                                   "   AND isaecomp = '",g_isaf_m.isafcomp,"'",
                                   "   AND isaesite = '",g_isaf_m.isaf052,"'",
                                   "   AND isae008 = '",g_isag4_d[l_ac].isat003,"'",
                                   "   AND (isae009 <= ",g_isag4_d[l_ac].isat004," AND isae010 >= ",g_isag4_d[l_ac].isat004,")"
                     END IF
                     PREPARE isae_sel_pb3 FROM l_sql
                     EXECUTE isae_sel_pb3 INTO l_n
                     IF cl_null(l_n) THEN LET l_n = 0 END IF
                     IF l_n = 0 THEN 
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'ais-00236' #發票號碼不存在於發票簿的起始號碼及截止號碼之間!
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD CURRENT
                     END IF
                     #161214-00053#1 add end---
                  END IF  #170103-00009#1
                  
                  IF g_isaf_m.isaf056 = '2' THEN
                     LET l_cnt = 0
                     #161020-00002#1 add ------
                     #紅字發票,在發票號碼的檢核方式,若使用isat006='Y',則檢核有無重覆開立ELSE檢核有無對應的原始藍字發票
                     IF g_isai006 = 'Y' THEN 
                        IF g_isai002 = '1' THEN
                           SELECT COUNT(1) INTO l_cnt
                             FROM isat_t
                            WHERE isatent = g_enterprise
                              AND isat004 = g_isag4_d[g_detail_idx].isat004
                              AND isat014 = '11'
                              AND isat025 <> '12'
                        ELSE
                           SELECT COUNT(1) INTO l_cnt
                             FROM isat_t
                            WHERE isatent = g_enterprise
                              AND isat003 = g_isag4_d[g_detail_idx].isat003
                              AND isat004 = g_isag4_d[g_detail_idx].isat004
                              AND isat014 = '11'
                              AND isat025 <> '12'
                        END IF
                        IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                        IF l_cnt > 0 THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'ais-00240'
                           LET g_errparam.extend = g_isag4_d[g_detail_idx].isat004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_isag4_d[g_detail_idx].isat004 = g_isag4_d_t.isat004
                           NEXT FIELD isat004
                        END IF
                     ELSE
                     #161020-00002#1 add end---
                        IF g_isai002 = '1' THEN
                           #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
                           SELECT COUNT(1) INTO l_cnt  #160907-00046#1
                             FROM isat_t
                            WHERE isatent = g_enterprise
                              AND isat004 = g_isag4_d[g_detail_idx].isat004
                              AND isat014 = '11'
                              AND isat025 <> '12'
                        ELSE
                           #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
                           SELECT COUNT(1) INTO l_cnt  #160907-00046#1
                             FROM isat_t
                            WHERE isatent = g_enterprise
                              AND isat003 = g_isag4_d[g_detail_idx].isat003
                              AND isat004 = g_isag4_d[g_detail_idx].isat004
                              AND isat014 = '11'
                              AND isat025 <> '12'
                        END IF
                        IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                        IF l_cnt = 0 THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'aap-00201' #該交易發票號碼不存在!
                           LET g_errparam.extend = g_isag4_d[g_detail_idx].isat004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_isag4_d[g_detail_idx].isat004 = g_isag4_d_t.isat004
                           NEXT FIELD isat004
                        END IF
                     END IF #161020-00002#1
                     IF g_isaf_m.isaf056 = '2' AND g_isai002 = '1' THEN #161127-00002#1
                        #檢核金額有沒有超折
                        CALL aist310_isag014_chk("2",g_isaf_m.isafdocno,g_isag4_d[l_ac].isatseq,g_isag4_d[l_ac].isat003,g_isag4_d[l_ac].isat004,g_isag4_d[l_ac].isat103)
                             RETURNING g_sub_success,g_errno
                        IF NOT g_sub_success THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag4_d[l_ac].isat103
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_isag4_d[l_ac].isat103 = g_isag4_d_t.isat103
                           NEXT FIELD isat103
                        END IF
                     END IF #161127-00002#1
                  #160105-00015#2-----s
                     #負項
                  ELSE
                     #正項               
                    #IF l_isai008 = 'TW' THEN #160803-00044#1 mark
                     IF g_isai002 = '1' THEN  #160803-00044#1
                        LET l_isatcnt = NULL
                        #SELECT COUNT(*) INTO l_isatcnt FROM isat_t #160907-00046#1 mark
                        SELECT COUNT(1) INTO l_isatcnt FROM isat_t  #160907-00046#1
                         WHERE isatent = g_enterprise
                           AND isat004 = g_isag4_d[l_ac].isat004
                           AND isat001 = g_isaf_m.isaf008
                           AND to_char(isat007,'yyyy') = to_char(g_isaf_m.isaf014,'yyyy')
                           AND isat014 = '11'
                           AND isat025 <> '12' #160907-00041#1 add
                        IF cl_null(l_isatcnt)THEN LET l_isatcnt = 0 END IF
                     ELSE
                        LET l_isatcnt = NULL
                        #SELECT COUNT(*) INTO l_isatcnt FROM isat_t #160907-00046#1 mark
                        SELECT COUNT(1) INTO l_isatcnt FROM isat_t  #160907-00046#1
                         WHERE isatent = g_enterprise
                           AND isat004 = g_isag4_d[l_ac].isat004
                           AND isat001 = g_isaf_m.isaf008
                           AND isat003 = g_isag4_d[l_ac].isat003
                           AND to_char(isat007,'yyyy') = to_char(g_isaf_m.isaf014,'yyyy')
                           AND isat014 = '11'
                           AND isat025 <> '12' #160907-00041#1 add
                        IF cl_null(l_isatcnt)THEN LET l_isatcnt = 0 END IF
                     END IF
                     IF l_isatcnt > 0 THEN
                        INITIALIZE g_errparam.* TO NULL
                        LET g_errparam.code = 'ais-00201' #發票代碼+發票號碼不可重複！
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_isag4_d[g_detail_idx].isat004 = g_isag4_d_t.isat004
                        NEXT FIELD isat004
                     END IF   
                  #160105-00015#2-----e
                  END IF
                  #170214-00045#1 add ------
                  IF g_isaf_m.isaf056 = '2' THEN
                     #撈取來源明細的來源發票，若無，則來源發票日期給空
                     LET l_sql = "SELECT isag013,isag014",
                                 "  FROM isag_t",
                                 " WHERE isagent = ",g_enterprise,
                                 "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
                                 "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
                                 "   AND isag014 IS NOT NULL"
                     PREPARE sel_isag_p1 FROM l_sql
                     DECLARE sel_isag_c1 SCROLL CURSOR FOR sel_isag_p1
                     OPEN sel_isag_c1
                     FETCH FIRST sel_isag_c1 INTO l_isag013,l_isag014
                     IF NOT cl_null(l_isag014) THEN
                        IF g_isai002 = '1' THEN
                           SELECT isat007 INTO g_isag4_d[g_detail_idx].isat027
                             FROM isat_t
                            WHERE isatent = g_enterprise
                              AND isat004 = l_isag014
                              AND (isat014 = '11' AND isat025 <> '12')
                        ELSE
                           SELECT isat007 INTO g_isag4_d[g_detail_idx].isat027
                             FROM isat_t
                            WHERE isatent = g_enterprise
                              AND isat003 = l_isag013
                              AND isat004 = l_isag014
                              AND (isat014 = '11' AND isat025 <> '12')
                        END IF
                        DISPLAY BY NAME g_isag4_d[g_detail_idx].isat027
                     END IF
                  END IF
                  #170214-00045#1 add end---
               END IF
            END IF
            #151029-00001#3 add end---
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat004
            #add-point:ON CHANGE isat004

            #END add-point 
          #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat103
            #add-point:BEFORE FIELD isat105

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat103
            
            #add-point:AFTER FIELD isat105
            #150918-00001#7 modify-----s
#            IF NOT cl_null(g_isag4_d[l_ac].isat103) AND NOT cl_null(g_isag4_d[l_ac].isat104) THEN 
#               LET g_isag4_d[l_ac].isat105 = g_isag4_d[l_ac].isat103 + g_isag4_d[l_ac].isat104
#            END IF
            IF NOT cl_null(g_isag4_d[l_ac].isat103) THEN
               IF g_isag4_d[l_ac].isat103 != g_isag4_d_o.isat103 OR g_isag4_d_o.isat103 IS NULL THEN
                  IF l_oodb005 = 'N' THEN   #稅別未稅時修改未稅金額使用s_tax_ins
                     #l_glaacomp營運據點/p_oodb002稅別/p_money計稅基礎/p_num數量/p_curr幣別/p_rate匯率
                     CALL s_tax_count(g_isaf_m.isafcomp,g_isaf_m.isaf016,g_isag4_d[l_ac].isat103,1,g_isaf_m.isaf100,g_isaf_m.isaf101)
                          RETURNING g_isag4_d[l_ac].isat103,g_isag4_d[l_ac].isat104,g_isag4_d[l_ac].isat105,
                                    g_isag4_d[l_ac].isat113,g_isag4_d[l_ac].isat114,g_isag4_d[l_ac].isat115
                  #稅別含稅,修改未稅金额后使用公式反推稅額、計算本幣金額
                  ELSE
                     LET g_isag4_d[l_ac].isat104 = g_isag4_d[l_ac].isat105 - g_isag4_d[l_ac].isat103
                     
                     IF g_glaa001 = g_isaf_m.isaf100 THEN
                        LET g_isag4_d[l_ac].isat113 = g_isag4_d[l_ac].isat103
                        LET g_isag4_d[l_ac].isat114 = g_isag4_d[l_ac].isat104
                        LET g_isag4_d[l_ac].isat115 = g_isag4_d[l_ac].isat105
                     ELSE
                        LET g_isag4_d[l_ac].isat113 = g_isag4_d[l_ac].isat103 * g_isaf_m.isaf101
                        #LET g_isag4_d[l_ac].isat113 = s_curr_round(g_isaf_m.isafcomp,g_glaa001,g_isag4_d[l_ac].isat113,2) #161214-00053#1 mark
                        CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag4_d[l_ac].isat113,2) RETURNING g_sub_success,g_errno,g_isag4_d[l_ac].isat113 #161214-00053#1
                        LET g_isag4_d[l_ac].isat114 = g_isag4_d[l_ac].isat115 - g_isag4_d[l_ac].isat113
                     END IF
                  END IF
                  #151029-00001#3 add ------
                  IF g_isaf_m.isaf056 = '2' THEN
                     IF g_isai002 = '1' THEN #161127-00002#1
                        #檢核金額有沒有超折
                        CALL aist310_isag014_chk("2",g_isaf_m.isafdocno,g_isag4_d[l_ac].isatseq,g_isag4_d[l_ac].isat003,g_isag4_d[l_ac].isat004,g_isag4_d[l_ac].isat103)
                             RETURNING g_sub_success,g_errno
                        IF NOT g_sub_success THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = g_isag4_d[l_ac].isat103
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_isag4_d[l_ac].isat103 = g_isag4_d_t.isat103
                           NEXT FIELD isat103
                        END IF
                     END IF #161127-00002#1
                  END IF
                  #151029-00001#3 add end---
               END IF
            END IF
            LET g_isag4_d_o.isat103 = g_isag4_d[l_ac].isat103
            LET g_isag4_d_o.isat104 = g_isag4_d[l_ac].isat104
            LET g_isag4_d_o.isat105 = g_isag4_d[l_ac].isat105
            LET g_isag4_d_o.isat113 = g_isag4_d[l_ac].isat113
            LET g_isag4_d_o.isat114 = g_isag4_d[l_ac].isat114
            LET g_isag4_d_o.isat115 = g_isag4_d[l_ac].isat115
            #150918-00001#7 modify-----e
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat103
            #add-point:ON CHANGE isat105

            #END add-point     
         
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat104
            #add-point:BEFORE FIELD isat104

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat104
            
            #add-point:AFTER FIELD isat104
            #150918-00001#7 modify-----s
#            IF NOT cl_null(g_isag4_d[l_ac].isat103) AND NOT cl_null(g_isag4_d[l_ac].isat104) THEN 
#               LET g_isag4_d[l_ac].isat105 = g_isag4_d[l_ac].isat103 + g_isag4_d[l_ac].isat104
#            END IF
            IF NOT cl_null(g_isag4_d[l_ac].isat104) THEN
               IF g_isag4_d[l_ac].isat104 != g_isag4_d_o.isat104 OR g_isag4_d_o.isat104 IS NULL  THEN
                  IF l_oodb005 = 'Y' THEN
                     LET g_isag4_d[l_ac].isat103 = g_isag4_d[l_ac].isat105 - g_isag4_d[l_ac].isat104
                     LET g_isag4_d[l_ac].isat114 = g_isag4_d[l_ac].isat104 * g_isaf_m.isaf101  
                     #LET g_isag4_d[l_ac].isat114 = s_curr_round(g_isaf_m.isafcomp,g_glaa001,g_isag4_d[l_ac].isat114,2) #161214-00053#1 mark
                     CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag4_d[l_ac].isat114,2) RETURNING g_sub_success,g_errno,g_isag4_d[l_ac].isat114 #161214-00053#1
                     LET g_isag4_d[l_ac].isat113 = g_isag4_d[l_ac].isat115 - g_isag4_d[l_ac].isat114
                  ELSE
                     LET g_isag4_d[l_ac].isat105 = g_isag4_d[l_ac].isat103 + g_isag4_d[l_ac].isat104
                     LET g_isag4_d[l_ac].isat114 = g_isag4_d[l_ac].isat104 * g_isaf_m.isaf101
                     #LET g_isag4_d[l_ac].isat114 = s_curr_round(g_isaf_m.isafcomp,g_glaa001,g_isag4_d[l_ac].isat114,2) #161214-00053#1 mark
                     CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag4_d[l_ac].isat114,2) RETURNING g_sub_success,g_errno,g_isag4_d[l_ac].isat114 #161214-00053#1
                     LET g_isag4_d[l_ac].isat115 = g_isag4_d[l_ac].isat113 + g_isag4_d[l_ac].isat114
                  END IF
               END IF
            END IF
            LET g_isag4_d_o.isat103 = g_isag4_d[l_ac].isat103
            LET g_isag4_d_o.isat104 = g_isag4_d[l_ac].isat104
            LET g_isag4_d_o.isat105 = g_isag4_d[l_ac].isat105
            LET g_isag4_d_o.isat113 = g_isag4_d[l_ac].isat113
            LET g_isag4_d_o.isat114 = g_isag4_d[l_ac].isat114
            LET g_isag4_d_o.isat115 = g_isag4_d[l_ac].isat115
            #150918-00001#7 modify-----e
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat104
            #add-point:ON CHANGE isat104

            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat105
            #add-point:BEFORE FIELD isat105

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat105
            
            #add-point:AFTER FIELD isat105
            #150918-00001#7-----s
            IF NOT cl_null(g_isag4_d[l_ac].isat105) THEN
               IF g_isag4_d[l_ac].isat105 != g_isag4_d_o.isat105 OR g_isag4_d_o.isat105 IS NULL  THEN
                  IF l_oodb005 = 'Y' THEN   
                     #l_glaacomp營運據點/p_oodb002稅別/p_money計稅基礎/p_num數量/p_curr幣別/p_rate匯率
                     CALL s_tax_count(g_isaf_m.isafcomp,g_isaf_m.isaf016,g_isag4_d[l_ac].isat105,1,g_isaf_m.isaf100,g_isaf_m.isaf101)
                           RETURNING g_isag4_d[l_ac].isat103,g_isag4_d[l_ac].isat104,g_isag4_d[l_ac].isat105,
                                     g_isag4_d[l_ac].isat113,g_isag4_d[l_ac].isat114,g_isag4_d[l_ac].isat115                     
                  ELSE
                     LET g_isag4_d[l_ac].isat104 = g_isag4_d[l_ac].isat105 - g_isag4_d[l_ac].isat103
                     
                     IF g_glaa001 = g_isaf_m.isaf100 THEN
                        LET g_isag4_d[l_ac].isat113 = g_isag4_d[l_ac].isat103
                        LET g_isag4_d[l_ac].isat114 = g_isag4_d[l_ac].isat104
                        LET g_isag4_d[l_ac].isat115 = g_isag4_d[l_ac].isat105                     
                     ELSE
                        LET g_isag4_d[l_ac].isat115 = g_isag4_d[l_ac].isat105 * g_isaf_m.isaf101
                        #LET g_isag4_d[l_ac].isat115 = s_curr_round(g_isaf_m.isafcomp,g_glaa001,g_isag4_d[l_ac].isat115,2) #161214-00053#1 mark
                        CALL s_curr_round_ld('1',g_glaald,g_glaa001,g_isag4_d[l_ac].isat115,2) RETURNING g_sub_success,g_errno,g_isag4_d[l_ac].isat115 #161214-00053#1
                        LET g_isag4_d[l_ac].isat114 = g_isag4_d[l_ac].isat115 - g_isag4_d[l_ac].isat113                       
                     END IF
                  END IF
               END IF
            END IF
            LET g_isag4_d_o.isat103 = g_isag4_d[l_ac].isat103
            LET g_isag4_d_o.isat104 = g_isag4_d[l_ac].isat104
            LET g_isag4_d_o.isat105 = g_isag4_d[l_ac].isat105
            LET g_isag4_d_o.isat113 = g_isag4_d[l_ac].isat113
            LET g_isag4_d_o.isat114 = g_isag4_d[l_ac].isat114
            LET g_isag4_d_o.isat115 = g_isag4_d[l_ac].isat115            
            #150918-00001#7-----e
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat105
            #add-point:ON CHANGE isat105

            #END add-point 
            
            
         #150915-00009#3-----s
         AFTER FIELD isat113
            #150918-00001#7 modify-----s
#            IF NOT cl_null(g_isag4_d[l_ac].isat113) AND NOT cl_null(g_isag4_d[l_ac].isat114) THEN 
#               LET g_isag4_d[l_ac].isat115 = g_isag4_d[l_ac].isat113 + g_isag4_d[l_ac].isat114
#            END IF
            IF NOT cl_null(g_isag4_d[l_ac].isat113) THEN
               IF g_isag4_d[l_ac].isat113 != g_isag4_d_o.isat113 OR g_isag4_d_o.isat113 IS NULL  THEN
                  IF l_oodb005 = 'Y' THEN
                     LET g_isag4_d[l_ac].isat114 = g_isag4_d[l_ac].isat115 - g_isag4_d[l_ac].isat113
                  ELSE
                     LET g_isag4_d[l_ac].isat115 = g_isag4_d[l_ac].isat113 + g_isag4_d[l_ac].isat114
                  END IF
               END IF
            END IF
            LET g_isag4_d_o.isat113 = g_isag4_d[l_ac].isat113
            LET g_isag4_d_o.isat114 = g_isag4_d[l_ac].isat114
            LET g_isag4_d_o.isat115 = g_isag4_d[l_ac].isat115             
            #150918-00001#7------------e
            
         AFTER FIELD isat114
            #150918-00001#7 modify-----s         
#            IF NOT cl_null(g_isag4_d[l_ac].isat113) AND NOT cl_null(g_isag4_d[l_ac].isat114) THEN 
#               LET g_isag4_d[l_ac].isat115 = g_isag4_d[l_ac].isat113 + g_isag4_d[l_ac].isat114
#            END IF   
            IF NOT cl_null(g_isag4_d[l_ac].isat114) THEN
               IF g_isag4_d[l_ac].isat114 != g_isag4_d_o.isat114 OR g_isag4_d_o.isat114 IS NULL  THEN
                  IF l_oodb005 = 'Y' THEN
                     LET g_isag4_d[l_ac].isat113 = g_isag4_d[l_ac].isat115 - g_isag4_d[l_ac].isat114
                  ELSE
                     LET g_isag4_d[l_ac].isat115 = g_isag4_d[l_ac].isat113 + g_isag4_d[l_ac].isat114
                  END IF
               END IF
            END IF
            LET g_isag4_d_o.isat113 = g_isag4_d[l_ac].isat113
            LET g_isag4_d_o.isat114 = g_isag4_d[l_ac].isat114
            LET g_isag4_d_o.isat115 = g_isag4_d[l_ac].isat115 

            #150918-00001#7 modify-----e    


         #150915-00009#3-----e
         
         #150918-00001#7-----s
         AFTER FIELD isat115
            IF NOT cl_null(g_isag4_d[l_ac].isat115) THEN
               IF g_isag4_d[l_ac].isat115 != g_isag4_d_o.isat115 OR g_isag4_d_o.isat115 IS NULL  THEN
                  IF l_oodb005 = 'Y' THEN
                     LET g_isag4_d[l_ac].isat113 = g_isag4_d[l_ac].isat115 - g_isag4_d[l_ac].isat114  
                  ELSE
                     LET g_isag4_d[l_ac].isat114 = g_isag4_d[l_ac].isat115 - g_isag4_d[l_ac].isat113  
                  END IF             
               END IF
            END IF
            LET g_isag4_d_o.isat113 = g_isag4_d[l_ac].isat113
            LET g_isag4_d_o.isat114 = g_isag4_d[l_ac].isat114
            LET g_isag4_d_o.isat115 = g_isag4_d[l_ac].isat115         
         #150918-00001#7-----e
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat007
            #add-point:BEFORE FIELD isat007

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat007
            
            #add-point:AFTER FIELD isat007

            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat007
            #add-point:ON CHANGE isat007

            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat014
            #add-point:BEFORE FIELD isat014

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat014
            
            #add-point:AFTER FIELD isat014

            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat014
            #add-point:ON CHANGE isat014

            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat106
            #add-point:BEFORE FIELD isat106

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat106
            
            #add-point:AFTER FIELD isat106

            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat106
            #add-point:ON CHANGE isat106

            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat107
            #add-point:BEFORE FIELD isat107

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat107
            
            #add-point:AFTER FIELD isat107

            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat107
            #add-point:ON CHANGE isat107

            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD isat017
            #add-point:BEFORE FIELD isat017

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD isat017
            
            #add-point:AFTER FIELD isat017

            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE isat017
            #add-point:ON CHANGE isat017

            #END add-point 
 
 
                  #Ctrlp:input.c.page4.isatseq
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isatseq
            #add-point:ON ACTION controlp INFIELD isatseq

            #END add-point
 
         #Ctrlp:input.c.page4.isat003
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isat003
            #add-point:ON ACTION controlp INFIELD isat003

            #END add-point
 
         #Ctrlp:input.c.page4.isat004
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isat004
            #add-point:ON ACTION controlp INFIELD isat004

            #END add-point
 
         #Ctrlp:input.c.page4.isat105
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isat105
            #add-point:ON ACTION controlp INFIELD isat105

            #END add-point
 
         #Ctrlp:input.c.page4.isat104
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isat104
            #add-point:ON ACTION controlp INFIELD isat104

            #END add-point
 
         #Ctrlp:input.c.page4.isat007
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isat007
            #add-point:ON ACTION controlp INFIELD isat007

            #END add-point
 
         #Ctrlp:input.c.page4.isat014
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isat014
            #add-point:ON ACTION controlp INFIELD isat014

            #END add-point
 
         #Ctrlp:input.c.page4.isat106
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isat106
            #add-point:ON ACTION controlp INFIELD isat106

            #END add-point
 
         #Ctrlp:input.c.page4.isat107
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isat107
            #add-point:ON ACTION controlp INFIELD isat107

            #END add-point
 
         #Ctrlp:input.c.page4.isat017
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD isat017
            #add-point:ON ACTION controlp INFIELD isat017

            #END add-point
 
 
 
         AFTER ROW
            #add-point:單身page4 after_row

            #end add-point
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_isag4_d[l_ac].* = g_isag4_d_t.*
               END IF
               CLOSE aist310_bcl5
               CALL s_transaction_end('N','0')
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL aist310_unlock_b("isat_1_t","'5'")
            CALL s_transaction_end('Y','0')
            #add-point:單身page4 after_row2

            #end add-point
 
         AFTER INPUT
            #add-point:input段after input 
            #160907-00041#1 --s add
            #補登發票回寫發票簿下次列印號碼
            IF g_isaf_m.isafstus = 'Y' THEN #單據確認時會做發票簿回寫動作,因此僅在已是確認狀態下做回寫
               IF NOT cl_null(g_isaf_m.isaf052) AND NOT cl_null(g_isaf_m.isaf051) AND
                  NOT cl_null(g_isaf_m.isaf014) AND NOT cl_null(g_isaf_m.isaf008) THEN
                  LET l_isae007 = ''
                  LET l_isae012 = ''
                   SELECT isae007,isae012    #發票字軌,下次列印號碼
                    INTO l_isae007,l_isae012
                    FROM isae_t
                   WHERE isaeent  = g_enterprise
                     AND isaesite = g_isaf_m.isaf052
                     AND isae001  = g_isaf_m.isaf051
                     AND isae002 <= g_isaf_m.isaf014
                     AND isae003 >= g_isaf_m.isaf014
                     AND isae004  = g_isaf_m.isaf008
                     
                  #取isat發票歷程檔中本次開立最大的發票
                  LET l_isae012_max = ''
                  SELECT MAX(isat004) INTO l_isae012_max
                    FROM isat_t
                   WHERE isatent = g_enterprise
                     AND isatcomp = g_isaf_m.isafcomp
                     AND isatdocno = g_isaf_m.isafdocno
                     AND isat025 IN ('11','21')
                     
                  IF g_isai002 = '1' THEN  
                     IF NOT cl_null(l_isae007)THEN
                        LET l_str = cl_replace_str(l_isae012,l_isae007,'')
                        LET l_isae012 = l_str.trim()
                        LET l_str = cl_replace_str(l_isae012_max,l_isae007,'')
                        LET l_isae012_max = l_str.trim()                           
                     END IF
                  END IF
             
                  #如輸入之發票號碼同發票簿下次列印發票號碼,則須更新發票簿下次列印號碼
                  IF l_isae012 = l_isae012_max OR l_isae012 < l_isae012_max THEN
                     LET l_add = l_isae012_max - (l_isae012-1)
                     
                     IF s_transaction_chk("N",0) THEN
                        CALL s_transaction_begin()
                     END IF
                     
                     #计算下次列印号码
                     LET l_isae012_n = ''
                     LET l_isae012_str = l_isae012
                     LET l_len = l_isae012_str.getLength()
                     LET l_sql = "SELECT lpad('",l_isae012,"'+",l_add,",",l_len,",'0') FROM dual"
                     PREPARE isae012_pre3 FROM l_sql
                     EXECUTE isae012_pre3 INTO l_isae012_n
                     LET l_date = cl_get_current()                 #170120-00040#1
                     UPDATE isae_t SET isae012 = l_isae012_n,      #發票簿下次列印號碼
                                       isae013 = isae013 + l_add,  #已開張數 
                                       isae014 = g_isaf_m.isaf014  #已開發票日期 = 目前列印發票日期
                                      ,isaemodid = g_user          #170120-00040#1
                                      ,isaemoddt = l_date          #170120-00040#1
                      WHERE isaeent  = g_enterprise
                        AND isaesite = g_isaf_m.isaf052
                        AND isae001  = g_isaf_m.isaf051
                        AND isae002 <= g_isaf_m.isaf014
                        AND isae003 >= g_isaf_m.isaf014
                        AND isae004  = g_isaf_m.isaf008
                     
                     IF SQLCA.SQLcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "update_isae012_erro"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        CALL s_transaction_end('N','0')
                        NEXT FIELD CURRENT 
                     ELSE
                        CALL s_transaction_end('Y','0')
                     END IF
                  END IF
               END IF
            END IF
            #160907-00041#1 --e add
            #end add-point   
    
         ON ACTION controlo
            CALL FGL_SET_ARR_CURR(g_isag4_d.getLength()+1)
            LET lb_reproduce = TRUE
            LET li_reproduce = l_ac
            LET li_reproduce_target = g_isag4_d.getLength()+1
 
      END INPUT
      
      
      #150915-00009#3-----s
      INPUT BY NAME g_isaf_m.isaf066,g_isaf_m.isaf019,g_isaf_m.isaf059,
                    g_isaf_m.isaf060,g_isaf_m.isaf061,g_isaf_m.isaf062,
                    g_isaf_m.isaf063,g_isaf_m.isaf064,g_isaf_m.isaf065,
                    g_isaf_m.isaf051,g_isaf_m.isaf011,g_isaf_m.isaf010 #160907-00041#1 add
         ATTRIBUTE(WITHOUT DEFAULTS)
         
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist310_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CLOSE aist310_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            
            #因應離開單頭後已寫入資料庫, 若重新回到單頭則視為修改
            #因此需於此處開啟/關閉欄位
            #CALL aist310_set_entry(p_cmd)
            #CALL aist310_set_no_entry(p_cmd)
            
            #160907-00041#1 --s add
            #add-point:資料輸入前
            CALL cl_set_comp_entry("isaf051",TRUE)  #161214-00053#1
            IF g_isaf_m.isaf056 <> '2' THEN 
               #161020-00021#1 --s add
               #當單身已存在發票歷程(isat_t)時,單頭限制不可異動發票類型與發票簿欄位
               IF NOT cl_null(g_isaf_m.isafdocno) AND NOT cl_null(g_isaf_m.isafcomp) THEN
                  CALL cl_set_comp_entry("isaf051",TRUE)
                  LET l_cnt_isat = 0
                  SELECT COUNT(1) INTO l_cnt_isat
                    FROM isat_t
                   WHERE isatent = g_enterprise
                     AND isatcomp = g_isaf_m.isafcomp
                     AND isatdocno = g_isaf_m.isafdocno  
                  IF cl_null(l_cnt_isat) THEN LET l_cnt_isat = 0 END IF
                  IF l_cnt_isat = 0 THEN
                     #170103-00009#1 add(s)
                     IF g_isaf_m.isaf053 = '4' THEN 
                        NEXT FIELD isaf011          
                     ELSE     
                     #170103-00009#1 add(e)
                        NEXT FIELD isaf051
                        CALL cl_set_comp_required('isaf051',TRUE)
                     END IF #170103-00009#1 add
                  ELSE
                     CALL cl_set_comp_entry("isaf051",FALSE)
                     NEXT FIELD isaf011 #161214-00053#1
                  END IF
               END IF
               #161020-00021#1 --e add
               #161020-00021#1 --s mark
               #搬到以上條件式中
               #NEXT FIELD isaf051
               #CALL cl_set_comp_required('isaf051',TRUE)
               #161020-00021#1 --e mark
            END IF
            #end add-point
            #160907-00041#1 --e add
               
         AFTER FIELD isaf066
            
            IF NOT cl_null(g_isaf_m.isaf066) THEN
               IF (g_isaf_m.isaf066 != g_isaf_m_t.isaf066 OR g_isaf_m_t.isaf066 IS NULL ) THEN
                  #151029-00001#3 mark ------
                  ##檢核是否存在Invoice(axmt620)
                  #LET l_cnt = 0
                  #SELECT COUNT(*) INTO l_cnt
                  #  FROM xmdo_t
                  # WHERE xmdoent = g_enterprise
                  #   AND xmdodocno = g_isaf_m.isaf066
                  #   AND xmdostus = 'Y'
                  #IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                  #IF l_cnt = 0 THEN
                  #   INITIALIZE g_errparam TO NULL
                  #   LET g_errparam.code = 'ais-00239'
                  #   LET g_errparam.extend = ''
                  #   LET g_errparam.popup = TRUE
                  #   CALL cl_err()
                  #   LET g_isaf_m.isaf066 = g_isaf_m_t.isaf066
                  #   NEXT FIELD CURRENT
                  #END IF
                  #151029-00001#3 mark end---
                  
                  #檢核是否有別張對帳單(aist310)使用
                  LET l_cnt = 0
                  #SELECT COUNT(*) INTO l_cnt #160907-00046#1 mark
                  SELECT COUNT(1) INTO l_cnt  #160907-00046#1
                    FROM isaf_t
                   WHERE isafent = g_enterprise
                     AND isaf066 = g_isaf_m.isaf066
                     AND isafstus <> 'X'
                  IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                  IF l_cnt > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00240'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isaf_m.isaf066 = g_isaf_m_t.isaf066
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF      
         
         ON CHANGE isaf060
            CALL cl_set_comp_entry('isaf061,isaf062,isaf063,isaf064',TRUE)            
            CASE 
               WHEN g_isaf_m.isaf060 = '1'        
                  LET g_isaf_m.isaf063 = ''
                  LET g_isaf_m.isaf064 = ''
                  CALL cl_set_comp_entry('isaf063,isaf064',FALSE)
                  DISPLAY BY NAME g_isaf_m.isaf063,g_isaf_m.isaf064 
      
                  #非經海關出口預設值
                  IF cl_null(g_isaf_m.isaf061)THEN
                     LET g_isaf_m.isaf061 = 'REF'
                  END IF
                  
                  IF cl_null(g_isaf_m.isaf062)THEN
                     LET g_isaf_m.isaf062 = g_isaf_m.isaf066
                  END IF                  
                  DISPLAY BY NAME g_isaf_m.isaf061,g_isaf_m.isaf062
               WHEN g_isaf_m.isaf060 = '2'  
                  LET g_isaf_m.isaf061 = ''
                  LET g_isaf_m.isaf062 = ''
                  CALL cl_set_comp_entry('isaf061,isaf062',FALSE)
                  DISPLAY BY NAME g_isaf_m.isaf061,g_isaf_m.isaf062  
               OTHERWISE
                  CALL cl_set_comp_entry('isaf061,isaf062,isaf063,isaf064',TRUE)                   
            END CASE
            
         AFTER FIELD isaf064
            IF NOT cl_null(g_isaf_m.isaf064) THEN            
               CALL s_chr_chk_str(g_isaf_m.isaf064,'14','')RETURNING g_sub_success
               IF NOT g_sub_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = "ais-00217"
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()                   
                  LET g_isaf_m.isaf064 = ''
                  NEXT FIELD CURRENT  
               END IF
            END IF            
            
         #160907-00041#1 --s add
         AFTER FIELD isaf051
            #add-point:AFTER FIELD isaf051 name="input.a.isaf051"
            #IF g_isaf_m.isaf011 <> 'MULTI' THEN   #160907-00041#1 add         #161103-00004#1 mark
            IF g_isaf_m.isaf011 <> 'MULTI' OR cl_null(g_isaf_m.isaf011) THEN   #161103-00004#1 add
               CALL aist310_isaf051_get()
            END IF                              #160907-00041#1 add
            IF NOT cl_null(g_isaf_m.isaf051) THEN  
               INITIALIZE g_chkparam.* TO NULL      
               LET g_chkparam.arg1 = g_isaf_m.isaf052
               LET g_chkparam.arg2 = g_isaf_m.isaf051
               IF cl_chk_exist("v_isae001") THEN
                  #檢查成功時後續處理
                  #161214-00053#1 add ------
                  #輸入的發票簿是否OK
                  LET l_cnt = 0
                  SELECT COUNT(1) INTO l_cnt #160907-00046#1
                    FROM isae_t
                   WHERE isaeent = g_enterprise
                     AND isaesite = g_isaf_m.isaf052 #营运据点
                     AND isae001 = g_isaf_m.isaf051  #發票簿
                     AND isae004 = g_isaf_m.isaf008  #发票类型
                     AND isaestus = 'Y'
                  IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                  IF l_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "ais-00350"
                     LET g_errparam.extend = g_isaf_m.isaf051
                     LET g_errparam.replace[1] = g_isaf_m.isaf051
                     LET g_errparam.replace[2] = g_isaf_m.isaf008
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isaf_m.isaf051 = g_isaf_m_t.isaf051
                     LET g_isaf_m.isaf010 = g_isaf_m_t.isaf010
                     LET g_isaf_m.isaf011 = g_isaf_m_t.isaf011
                     NEXT FIELD CURRENT
                  END IF
                  #161214-00053#1 add end---
                  
                  LET l_cnt = 0
                  SELECT COUNT(1) INTO l_cnt
                    FROM isaf_t
                   WHERE isafent = g_enterprise
                     AND isaf051  = g_isaf_m.isaf051
                     AND isaf052  = g_isaf_m.isaf052    #160909-00081#1
                     AND isafstus = 'N'
                     AND isafdocno<>g_isaf_m.isafdocno
                     AND isafcomp = g_isaf_m.isafcomp
                  IF l_cnt > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "ais-00160"
                     LET g_errparam.extend = g_isaf_m.isaf051
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isaf_m.isaf051 = g_isaf_m_t.isaf051
                     LET g_isaf_m.isaf010 = g_isaf_m_t.isaf010
                     LET g_isaf_m.isaf011 = g_isaf_m_t.isaf011
                     NEXT FIELD CURRENT
                  END IF
                  
                  LET l_isae002 = ''
                  LET l_isae003 = ''
                  LET l_isae016 = ''
                  LET l_isae017 = ''
                  LET l_isae016 = YEAR(g_isaf_m.isaf014)
                  LET l_isae017 = MONTH(g_isaf_m.isaf014)
                  SELECT isae002,isae003
                    INTO l_isae002,l_isae003
                    FROM isae_t
                   WHERE isaeent = g_enterprise
                     AND isaecomp = g_isaf_m.isafcomp
                     AND isaesite = g_isaf_m.isaf052
                     AND isae001 = g_isaf_m.isaf051
                     AND isae004 = g_isaf_m.isaf008
                     AND isae016 =  l_isae016
                     AND (isae017 = l_isae017 OR isae018 =  l_isae017)
                  IF g_isaf_m.isaf014 < l_isae002 OR g_isaf_m.isaf014 > l_isae003 THEN 
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00151'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isaf_m.isaf051 = g_isaf_m_t.isaf051
                     CALL aist310_isaf051_get()
                     NEXT FIELD CURRENT
                  END IF     
               ELSE
                  #檢查失敗時後續處理
                  LET g_isaf_m.isaf051 = g_isaf_m_t.isaf051
                  CALL aist310_isaf051_get()
                  NEXT FIELD CURRENT
               END IF
            ELSE
               IF g_isaf_m.isaf056 <> '2' THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'aap-00216'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = FALSE
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
            END IF

         ON ACTION controlp INFIELD isaf051
            #add-point:ON ACTION controlp INFIELD isaf051 name="input.c.isaf051"
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isaf_m.isaf051
            IF cl_null(g_isaf_m.isaf014) THEN LET g_isaf_m.isaf014 = g_today END IF  #161102-00041#1
            IF g_isaf_m.isaf056 = '2' AND g_isai006 = 'Y' THEN
               LET g_qryparam.where = "   isaesite IN ('",g_isaf_m.isaf052,"','",g_isaf_m.isafcomp,"' ) ",
                                      "   AND isae002 <= '",g_isaf_m.isaf014,"'",
                                      "   AND isae003 >= '",g_isaf_m.isaf014,"'",
                                      "   AND isac001 = '",g_ooef019,"'"
            ELSE
               LET g_qryparam.where = "   isaesite IN ('",g_isaf_m.isaf052,"','",g_isaf_m.isafcomp,"' ) ",
                                      "   AND isae004  = '",g_isaf_m.isaf008,"'",
                                      "   AND isae002 <= '",g_isaf_m.isaf014,"'",
                                      "   AND isae003 >= '",g_isaf_m.isaf014,"'",
                                      "   AND isac001 = '",g_ooef019,"'"
            END IF
            CALL q_isaesite_3()
            LET g_isaf_m.isaf051 = g_qryparam.return2
            DISPLAY g_isaf_m.isaf051 TO isaf051
            #IF g_isaf_m.isaf011 <> 'MULTI' THEN   #160907-00041#1 add         #161103-00004#1 mark
            IF g_isaf_m.isaf011 <> 'MULTI' OR cl_null(g_isaf_m.isaf011) THEN   #161103-00004#1 add
               CALL aist310_isaf051_get()
            END IF                                 #160907-00041#1 add
            CALL aist310_isae_get()
            NEXT FIELD isaf051
            #END add-point

         AFTER FIELD isaf010
            #add-point:AFTER FIELD isaf010 name="input.a.isaf010"
            IF NOT cl_null(g_isaf_m.isaf010) THEN 
               LET l_isae008 = ''
               SELECT isae008 INTO l_isae008
                 FROM isae_t
                WHERE isaeent = g_enterprise
                  AND isaecomp = g_isaf_m.isafcomp
                  AND isaesite = g_isaf_m.isaf052
                  AND isae001 = g_isaf_m.isaf051
                  AND isae004 = g_isaf_m.isaf008
                  
               IF g_isaf_m.isaf010 <> l_isae008 THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00152'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_isaf_m.isaf010 = g_isaf_m_t.isaf010
                  NEXT FIELD CURRENT
               END IF
            END IF
            #END add-point

         AFTER FIELD isaf011
            #add-point:AFTER FIELD isaf011 name="input.a.isaf011"
            #IF NOT cl_null(g_isaf_m.isaf011) THEN #170116-00020#1 mark
            IF NOT cl_null(g_isaf_m.isaf011) AND g_isaf_m.isaf011 <> 'MULTI' THEN #170116-00020#1 add
               #170103-00009#1 mark ------
               #IF g_isai002 = '1' THEN
               #   LET l_isaf011 = g_isaf_m.isaf011
               #   LET g_isaf_m.isaf011 = g_isaf_m.isaf011[3,10]
               #END IF
               #LET l_n = 0 
               #SELECT COUNT(1) INTO l_n
               #  FROM isaf_t
               # WHERE isafent = g_enterprise
               #   AND isaf011 = g_isaf_m.isaf011
               #   AND isaf051 = g_isaf_m.isaf051 AND isafdocno <> g_isaf_m.isafdocno
               #170103-00009#1 mark end---
               #170103-00009#1 add ------
               LET l_sql ="SELECT COUNT(1)",
                          "  FROM isaf_t",
                          " WHERE isafent = ",g_enterprise,
                          "   AND isaf011 = '",g_isaf_m.isaf011,"'",
                          "   AND isafdocno <> '",g_isaf_m.isafdocno,"'"
               #如果發票聯別=4:收據，不用檢核是否存在發票簿
               IF g_isaf_m.isaf053 <> '4' THEN
                  LET l_sql = l_sql," AND isaf051 = '",g_isaf_m.isaf051,"'"
               END IF
               #大陸稅區要檢查發票代碼
               IF g_isai002 = '2' THEN
                  LET l_sql = l_sql," AND isaf010 = '",g_isaf_m.isaf010,"'"
               END IF
               PREPARE isaf_sel_pb2 FROM l_sql
               EXECUTE isaf_sel_pb2 INTO l_n
               IF cl_null(l_n) THEN LET l_n = 0 END IF
               #170103-00009#1 add end---
               IF l_n > 0 AND g_isaf_m.isaf011 <> 'MULTI' THEN 
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ais-00156' #此發票號碼已經使用,請重新輸入！
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  #LET g_isaf_m.isaf011 = l_isae012         #170103-00009#1 mark
                  LET g_isaf_m.isaf011 = g_isaf_m_t.isaf011 #170103-00009#1
                  NEXT FIELD CURRENT
               END IF
               LET l_isae012 = ''
               #161214-00053#1 mark ------
               #SELECT isae007,isae012 INTO l_isae007,l_isae012
               #  FROM isae_t
               # WHERE isaeent = g_enterprise
               #   AND isaecomp = g_isaf_m.isafcomp
               #   AND isaesite = g_isaf_m.isaf052
               #   AND isae001 = g_isaf_m.isaf051
               #   AND isae004 = g_isaf_m.isaf008
               #   AND isae016 = YEAR(g_isaf_m.isaf014)  
               #   AND (isae017 = MONTH(g_isaf_m.isaf014) OR isae018 = MONTH(g_isaf_m.isaf014)) 
               #161214-00053#1 mark end---
               #170116-00020#1 mark ------
               ##161214-00053#1 add ------
               #LET l_isae007 = ''
               #LET l_sql ="SELECT isae007,isae012",
               #           "  FROM isae_t",
               #           " WHERE isaeent = ",g_enterprise,
               #           "   AND isaecomp = '",g_isaf_m.isafcomp,"'",
               #           "   AND isaesite = '",g_isaf_m.isaf052,"'",
               #           "   AND isae001 = '",g_isaf_m.isaf051,"'",
               #           "   AND isae004 = '",g_isaf_m.isaf008,"'",
               #           "   AND isae016 = ",YEAR(g_isaf_m.isaf014),
               #           "   AND (isae017 = ",MONTH(g_isaf_m.isaf014)," OR isae018 = ",MONTH(g_isaf_m.isaf014),")"
               #PREPARE isae_sel_pb2 FROM l_sql
               #EXECUTE isae_sel_pb2 INTO l_isae007,l_isae012
               ##161214-00053#1 add end---
               #IF g_isaf_m.isaf011 <> l_isae012 AND g_isaf_m.isaf011 <> 'MULTI' THEN 
               #   INITIALIZE g_errparam TO NULL
               #   LET g_errparam.code = 'ais-00153' #發票號碼必須等於發票簿之下次列印號碼,請檢查！
               #   LET g_errparam.extend = ''
               #   LET g_errparam.popup = TRUE
               #   CALL cl_err()
               #   IF g_isai002 = '1' THEN
               #      LET g_isaf_m.isaf011 = l_isae007,l_isae007
               #   END IF
               #   LET g_isaf_m.isaf011 = l_isae007
               #   NEXT FIELD CURRENT
               #END IF
               #170116-00020#1 mark end---
               #170103-00009#1 mark ------
               #IF g_isai002 = '1' THEN
               #   LET g_isaf_m.isaf011 = l_isaf011
               #END IF
               #170103-00009#1 mark end---
               IF g_isaf_m.isaf056 = '1' THEN
                  #正項
                  IF g_isai002 = '1' THEN 
                     LET l_isatcnt = NULL
                     SELECT COUNT(1) INTO l_isatcnt FROM isat_t
                      WHERE isatent = g_enterprise
                        AND isat004 = g_isaf_m.isaf011
                        AND isat001 = g_isaf_m.isaf008
                        AND to_char(isat007,'yyyy') = to_char(g_isaf_m.isaf014,'yyyy')
                        AND isat014 = '11'
                        AND isatdocno <> g_isaf_m.isafdocno
                     IF cl_null(l_isatcnt)THEN LET l_isatcnt = 0 END IF
                  ELSE
                     LET l_isatcnt = NULL
                     SELECT COUNT(1) INTO l_isatcnt FROM isat_t
                      WHERE isatent = g_enterprise
                        AND isat004 = g_isaf_m.isaf011
                        AND isat001 = g_isaf_m.isaf008
                        AND isat003 = g_isaf_m.isaf010
                        AND to_char(isat007,'yyyy') = to_char(g_isaf_m.isaf014,'yyyy')
                        AND isat014 = '11'
                        AND isatdocno <> g_isaf_m.isafdocno
                     IF cl_null(l_isatcnt)THEN LET l_isatcnt = 0 END IF
                  END IF
                  IF l_isatcnt > 0 THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = 'ais-00201' #發票代碼+發票號碼不可重複！
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isaf_m.isaf011 = g_isaf_m_t.isaf011
                     NEXT FIELD isaf011
                  END IF                  
               END IF
            END IF
         #160907-00041#1 --e add
         
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF  
      
            CALL s_transaction_begin()             
            UPDATE isaf_t SET isafstus = g_isaf_m.isafstus,
                              isaf066=g_isaf_m.isaf066,
                              isaf019=g_isaf_m.isaf019,
                              isaf059=g_isaf_m.isaf059,
                              isaf060=g_isaf_m.isaf060,
                              isaf061=g_isaf_m.isaf061,
                              isaf062=g_isaf_m.isaf062,
                              isaf063=g_isaf_m.isaf063,
                              isaf064=g_isaf_m.isaf064,
                              isaf065=g_isaf_m.isaf065,
                              isafdocdt=g_isaf_m.isafdocdt,
                              isaf051=g_isaf_m.isaf051, #160907-00041#1 add
                              isaf011=g_isaf_m.isaf011, #160907-00041#1 add
                              isaf010=g_isaf_m.isaf010  #160907-00041#1 add
             WHERE isafent = g_enterprise
               AND isafcomp = g_isaf_m.isafcomp
               AND isafdocno = g_isaf_m.isafdocno
      
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isaf_t" 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CALL s_transaction_end('N','0')
               NEXT FIELD CURRENT            
            END IF
            CALL s_transaction_end('Y','0')
      END INPUT
      #150915-00009#3-----e
      
      
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden     
         END IF
 
      ON ACTION accept
         #add-point:input段accept 
         #161124-00070#1 --s mark 改寫到aist310_isaf011_update 統一處理
         ##161101-00039#1 --s add
         ##dido:發票補登時，如未維護發票歷程檔，則單頭發票號碼不做寫入
         #LET l_isat_cnt = 0
         #SELECT COUNT(1) INTO l_isat_cnt
         #  FROM isat_t
         # WHERE isatent = g_enterprise
         #   AND isatcomp = g_isaf_m.isafcomp
         #   AND isatdocno = g_isaf_m.isafdocno
         #
         #IF cl_null(l_isat_cnt) THEN LET l_isat_cnt = 0 END IF
         #IF l_isat_cnt = 0 THEN
         #   NEXT FIELD isat004
         #END IF
         ##161101-00039#1 --e add
         #161124-00070#1 --e mark

         #end add-point    
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         #161124-00070#1 --s mark 改寫到aist310_isaf011_update 統一處理
         ##161101-00039#1 --s add
         ##dido:發票補登時，如未維護發票歷程檔，則單頭發票號碼不做寫入
         #LET l_isat_cnt = 0
         #SELECT COUNT(1) INTO l_isat_cnt
         #  FROM isat_t
         # WHERE isatent = g_enterprise
         #   AND isatcomp = g_isaf_m.isafcomp
         #   AND isatdocno = g_isaf_m.isafdocno
         #
         #IF cl_null(l_isat_cnt) THEN LET l_isat_cnt = 0 END IF
         #IF l_isat_cnt = 0 THEN
         #   CALL s_transaction_begin()             
         #   UPDATE isaf_t SET isaf051='',isaf011='',isaf010=''
         #    WHERE isafent = g_enterprise
         #      AND isafcomp = g_isaf_m.isafcomp
         #      AND isafdocno = g_isaf_m.isafdocno
         #
         #   IF SQLCA.sqlcode THEN
         #      INITIALIZE g_errparam TO NULL 
         #      LET g_errparam.extend = "isaf_t" 
         #      LET g_errparam.code   = SQLCA.sqlcode 
         #      LET g_errparam.popup  = TRUE 
         #      CALL cl_err()
         #      CALL s_transaction_end('N','0')    
         #   END IF
         #   CALL s_transaction_end('Y','0')
         #   DISPLAY BY NAME g_isaf_m.isaf051,g_isaf_m.isaf011,g_isaf_m.isaf010
         #END IF
         ##161101-00039#1 --e add
         #161124-00070#1 --e mark
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
   
   CALL aist310_isaf011_update()
   
   SELECT SUM(isat105) INTO l_isat105
     FROM isat_t
    WHERE isatent = g_enterprise
      AND isatcomp = g_isaf_m.isafcomp
      AND isatdocno = g_isaf_m.isafdocno
      AND isat014 <> '12'
      AND isat014 <> '22'
      AND isat025 NOT IN ('12','22')       #160907-00041#1 add
      
   #161214-00053#1 mark ------
   ##albireo 151028-----s
   #LET l_isaf105 = g_isaf_m.isaf105 
   #IF g_isaf_m.isaf056   = '2' THEN
   #   LET l_isaf105 = l_isaf105 * -1
   #END IF   
   ##albireo 151028-----e   
   #161214-00053#1 mark end---
   
   #IF l_isat105 <> g_isaf_m.isaf105 THEN #albireo 151028 mark
   #IF l_isat105 <> l_isaf105 THEN        #albireo 151028 add #161214-00053#1 mark
   IF l_isat105 <> g_isaf_m.isaf105 THEN  #161214-00053#1
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ais-00173'
      LET g_errparam.extend = l_isat105
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF

   CALL aist310_show()
END FUNCTION
#發票明細修改
PRIVATE FUNCTION aist310_invoice_update()
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_n                   LIKE type_t.num5                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num5                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num5
   DEFINE  l_i                   LIKE type_t.num5
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num5
   DEFINE  li_reproduce_target   LIKE type_t.num5
   DEFINE  ls_keys               DYNAMIC ARRAY OF VARCHAR(500)

   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      INPUT ARRAY g_isag2_d FROM s_detail2.*
           ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                    INSERT ROW = FALSE, #此頁面insert功能由產生器控制, 手動之設定無效! 
      
                    DELETE ROW = FALSE,
                    APPEND ROW = FALSE)
                    
         BEFORE INPUT
            #add-point:資料輸入前
      
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
               CALL FGL_SET_ARR_CURR(g_isag2_d.getLength()+1) 
               LET g_insert = 'N' 
            END IF 
      
            CALL aist310_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_detail_idx)
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_isag2_d.getLength()
            #add-point:資料輸入前         
                    
         BEFORE ROW     
            #add-point:modify段before row2

            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN aist310_cl USING g_enterprise,g_isaf_m.isafcomp,g_isaf_m.isafdocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist310_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CLOSE aist310_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            
            LET g_rec_b = g_isag2_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_isag2_d[l_ac].isahseq IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_isag2_d_t.* = g_isag2_d[l_ac].*  #BACKUP
               LET g_isag2_d_o.* = g_isag2_d[l_ac].*  #BACKUP
               
               CALL aist310_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b

               #end add-point  
               CALL aist310_set_no_entry_b(l_cmd)
               
               IF NOT aist310_lock_b("isah_1_t","'6'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aist310_bcl6 INTO g_isag2_d[l_ac].isahseq,g_isag2_d[l_ac].isahorga,g_isag2_d[l_ac].isah003, 
                      g_isag2_d[l_ac].isah004,g_isag2_d[l_ac].isah013,g_isag2_d[l_ac].isah005,g_isag2_d[l_ac].isah010, 
                      g_isag2_d[l_ac].isah006,g_isag2_d[l_ac].isah101,g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah007, 
                      g_isag2_d[l_ac].isah104,g_isag2_d[l_ac].isah105,g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114, 
                      g_isag2_d[l_ac].isah115,g_isag2_d[l_ac].isah001,g_isag2_d[l_ac].isah002,g_isag2_d[l_ac].isah008, 
                      g_isag2_d[l_ac].isah009,g_isag2_d[l_ac].isah011,g_isag2_d[l_ac].isah106,g_isag2_d[l_ac].isah012 

                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = '' 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  LET g_bfill = "N"
                  CALL aist310_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF

            CALL aist310_ref_b_2()
            
            CALL cl_set_comp_entry("isahorga,isah005_desc,isah010,isah006,isah101",FALSE)
            CALL cl_set_comp_entry("isah001,isah002,isah011,isah103,isah105",FALSE)   
     
         ON ROW CHANGE 
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               LET g_isag2_d[l_ac].* = g_isag2_d_t.*
               CLOSE aist310_bcl6
               CALL s_transaction_end('N','0')
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_isag2_d[l_ac].* = g_isag2_d_t.*
            ELSE
               #add-point:單身page2修改前

               #end add-point
               
               #寫入修改者/修改日期資訊(單身2)
               
               
               UPDATE isah_t SET (isahcomp,isahdocno,isahseq,isahorga,isah003,isah004,isah013,isah005, 
                   isah010,isah006,isah101,isah103,isah007,isah104,isah105,isah113,isah114,isah115,isah001, 
                   isah002,isah008,isah009,isah011,isah106,isah012,isah116) = (g_isaf_m.isafcomp,g_isaf_m.isafdocno, 
                   g_isag2_d[l_ac].isahseq,g_isag2_d[l_ac].isahorga,g_isag2_d[l_ac].isah003,g_isag2_d[l_ac].isah004, 
                   g_isag2_d[l_ac].isah013,g_isag2_d[l_ac].isah005,g_isag2_d[l_ac].isah010,g_isag2_d[l_ac].isah006, 
                   g_isag2_d[l_ac].isah101,g_isag2_d[l_ac].isah103,g_isag2_d[l_ac].isah007,g_isag2_d[l_ac].isah104, 
                   g_isag2_d[l_ac].isah105,g_isag2_d[l_ac].isah113,g_isag2_d[l_ac].isah114,g_isag2_d[l_ac].isah115, 
                   g_isag2_d[l_ac].isah001,g_isag2_d[l_ac].isah002,g_isag2_d[l_ac].isah008,g_isag2_d[l_ac].isah009, 
                   g_isag2_d[l_ac].isah011,g_isag2_d[l_ac].isah106,g_isag2_d[l_ac].isah012,g_isag2_d[l_ac].isah116)  #自訂欄位頁簽 

                WHERE isahent = g_enterprise AND isahcomp = g_isaf_m.isafcomp
                  AND isahdocno = g_isaf_m.isafdocno
                  AND isahseq = g_isag2_d_t.isahseq #項次 
                  
               #add-point:單身page2修改中

               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isah_t" 
                     LET g_errparam.code   = "std-00009" 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     CALL s_transaction_end('N','0')
                     LET g_isag2_d[l_ac].* = g_isag2_d_t.*
                  WHEN SQLCA.sqlcode #其他錯誤
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isah_t" 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     CALL s_transaction_end('N','0')
                     LET g_isag2_d[l_ac].* = g_isag2_d_t.*
                  OTHERWISE
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isaf_m.isafcomp
               LET gs_keys_bak[1] = g_isafcomp_t
               LET gs_keys[2] = g_isaf_m.isafdocno
               LET gs_keys_bak[2] = g_isafdocno_t
               LET gs_keys[3] = g_isag2_d[g_detail_idx].isahseq
               LET gs_keys_bak[3] = g_isag2_d_t.isahseq
               CALL aist310_update_b('isah_t',gs_keys,gs_keys_bak,"'2'")
                     #資料多語言用-增/改
                     
               END CASE
               
               #判斷key是否有改變
               INITIALIZE ls_keys TO NULL
               IF NOT (g_isag2_d[g_detail_idx].isahseq = g_isag2_d_t.isahseq 
                  ) THEN
                  LET ls_keys[01] = g_isaf_m.isafcomp
                  LET ls_keys[ls_keys.getLength()+1] = g_isaf_m.isafdocno
                  LET ls_keys[ls_keys.getLength()+1] = g_isag2_d_t.isahseq
                  CALL aist310_key_update_b(ls_keys,'isah_t')
               END IF
               
               #修改歷程記錄
               LET g_log1 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag2_d_t)
               LET g_log2 = util.JSON.stringify(g_isaf_m),util.JSON.stringify(g_isag2_d[l_ac])
               IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身page2修改後

               #end add-point
            END IF  
            
          AFTER FIELD isah106
             #add-point:AFTER FIELD isah106
             IF NOT cl_null(g_isag2_d[l_ac].isah106) THEN 
                LET g_isag2_d[l_ac].isah116 = g_isag2_d[l_ac].isah106 * g_isaf_m.isaf101
                DISPLAY g_isag2_d[l_ac].isah116 TO s_detail2[l_ac].isah116
             END IF

          AFTER ROW
            #add-point:單身page2 after_row

            #end add-point
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_isag2_d[l_ac].* = g_isag2_d_t.*
               END IF
               CLOSE aist310_bcl6
               CALL s_transaction_end('N','0')
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL aist310_unlock_b("isah_t","'2'")
            CALL s_transaction_end('Y','0')
            #add-point:單身page2 after_row2

            #end add-point
 
         AFTER INPUT
            #add-point:input段after input 

            #end add-point   
    
         ON ACTION controlo
            CALL FGL_SET_ARR_CURR(g_isag2_d.getLength()+1)
            LET lb_reproduce = TRUE
            LET li_reproduce = l_ac
            LET li_reproduce_target = g_isag2_d.getLength()+1
 
                    
      END INPUT
      
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden     
         END IF
 
      ON ACTION accept
         #add-point:input段accept 

         #end add-point    
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
   
   CALL cl_set_comp_entry("isahorga,isah005_desc,isah010,isah006,isah101",TRUE)
   CALL cl_set_comp_entry("isah001,isah002,isah011,isah103,isah105",TRUE)  
END FUNCTION

##############################
#發票作廢時新增一筆作廢isat_t
##############################
PRIVATE FUNCTION aist310_invalid()
#DEFINE l_isat       RECORD LIKE isat_t.* #161104-00024#10 mark
#161104-00024#10 --s add
DEFINE l_isat RECORD  #發票歷程檔
       isatent LIKE isat_t.isatent, #企業編碼
       isatcomp LIKE isat_t.isatcomp, #法人
       isatdocno LIKE isat_t.isatdocno, #開票單號
       isatseq LIKE isat_t.isatseq, #發票歷程項次
       isat001 LIKE isat_t.isat001, #發票類型
       isat002 LIKE isat_t.isat002, #電子發票否
       isat003 LIKE isat_t.isat003, #發票編號
       isat004 LIKE isat_t.isat004, #發票號碼
       isat005 LIKE isat_t.isat005, #發票聯別
       isat006 LIKE isat_t.isat006, #發票防偽隨機碼
       isat007 LIKE isat_t.isat007, #發票日期
       isat008 LIKE isat_t.isat008, #發票時間
       isat009 LIKE isat_t.isat009, #發票客戶全名
       isat010 LIKE isat_t.isat010, #購貨方統一編號
       isat011 LIKE isat_t.isat011, #購貨方地址
       isat012 LIKE isat_t.isat012, #銷方統一編號
       isat013 LIKE isat_t.isat013, #POS單號
       isat014 LIKE isat_t.isat014, #發票異動狀態
       isat015 LIKE isat_t.isat015, #異動理由碼
       isat016 LIKE isat_t.isat016, #異動備註
       isat017 LIKE isat_t.isat017, #異動日期
       isat018 LIKE isat_t.isat018, #異動時間
       isat019 LIKE isat_t.isat019, #異動人員
       isat020 LIKE isat_t.isat020, #專案作廢核准文號
       isat021 LIKE isat_t.isat021, #列印次數
       isat022 LIKE isat_t.isat022, #課稅別
       isat023 LIKE isat_t.isat023, #稅率
       isat024 LIKE isat_t.isat024, #檢查碼
       isat100 LIKE isat_t.isat100, #幣別
       isat101 LIKE isat_t.isat101, #匯率
       isat103 LIKE isat_t.isat103, #發票原幣未稅金額
       isat104 LIKE isat_t.isat104, #發票原幣稅額
       isat105 LIKE isat_t.isat105, #發票原幣含稅金額
       isat106 LIKE isat_t.isat106, #已折讓本幣未稅金額
       isat107 LIKE isat_t.isat107, #已折讓本幣稅額
       isat113 LIKE isat_t.isat113, #發票本幣未稅金額
       isat114 LIKE isat_t.isat114, #發票本幣稅額
       isat115 LIKE isat_t.isat115, #發票本幣含稅金額
       isat201 LIKE isat_t.isat201, #帳款應稅金額
       isat202 LIKE isat_t.isat202, #帳款零稅金額
       isat203 LIKE isat_t.isat203, #帳款免稅金額
       isat204 LIKE isat_t.isat204, #愛心碼
       isat205 LIKE isat_t.isat205, #載具類別號碼
       isat206 LIKE isat_t.isat206, #載具顯碼 ID
       isat207 LIKE isat_t.isat207, #載具隱碼 ID
       isat208 LIKE isat_t.isat208, #電子發票匯出狀態
       isat209 LIKE isat_t.isat209, #電子發票匯出序號
       isatud001 LIKE isat_t.isatud001, #自定義欄位(文字)001
       isatud002 LIKE isat_t.isatud002, #自定義欄位(文字)002
       isatud003 LIKE isat_t.isatud003, #自定義欄位(文字)003
       isatud004 LIKE isat_t.isatud004, #自定義欄位(文字)004
       isatud005 LIKE isat_t.isatud005, #自定義欄位(文字)005
       isatud006 LIKE isat_t.isatud006, #自定義欄位(文字)006
       isatud007 LIKE isat_t.isatud007, #自定義欄位(文字)007
       isatud008 LIKE isat_t.isatud008, #自定義欄位(文字)008
       isatud009 LIKE isat_t.isatud009, #自定義欄位(文字)009
       isatud010 LIKE isat_t.isatud010, #自定義欄位(文字)010
       isatud011 LIKE isat_t.isatud011, #自定義欄位(數字)011
       isatud012 LIKE isat_t.isatud012, #自定義欄位(數字)012
       isatud013 LIKE isat_t.isatud013, #自定義欄位(數字)013
       isatud014 LIKE isat_t.isatud014, #自定義欄位(數字)014
       isatud015 LIKE isat_t.isatud015, #自定義欄位(數字)015
       isatud016 LIKE isat_t.isatud016, #自定義欄位(數字)016
       isatud017 LIKE isat_t.isatud017, #自定義欄位(數字)017
       isatud018 LIKE isat_t.isatud018, #自定義欄位(數字)018
       isatud019 LIKE isat_t.isatud019, #自定義欄位(數字)019
       isatud020 LIKE isat_t.isatud020, #自定義欄位(數字)020
       isatud021 LIKE isat_t.isatud021, #自定義欄位(日期時間)021
       isatud022 LIKE isat_t.isatud022, #自定義欄位(日期時間)022
       isatud023 LIKE isat_t.isatud023, #自定義欄位(日期時間)023
       isatud024 LIKE isat_t.isatud024, #自定義欄位(日期時間)024
       isatud025 LIKE isat_t.isatud025, #自定義欄位(日期時間)025
       isatud026 LIKE isat_t.isatud026, #自定義欄位(日期時間)026
       isatud027 LIKE isat_t.isatud027, #自定義欄位(日期時間)027
       isatud028 LIKE isat_t.isatud028, #自定義欄位(日期時間)028
       isatud029 LIKE isat_t.isatud029, #自定義欄位(日期時間)029
       isatud030 LIKE isat_t.isatud030, #自定義欄位(日期時間)030
       isatsite LIKE isat_t.isatsite, #營運據點
       isatdocdt LIKE isat_t.isatdocdt, #單據日期
       isat025 LIKE isat_t.isat025, #發票最終狀態
       isat026 LIKE isat_t.isat026, #電子發票類型
       isat027 LIKE isat_t.isat027, #原發票日期
       isat028 LIKE isat_t.isat028, #稅別
       isat029 LIKE isat_t.isat029, #含稅否
       isat108 LIKE isat_t.isat108, #留抵原幣稅額
       isat118 LIKE isat_t.isat118  #留抵本幣稅額
END RECORD
#161104-00024#10 --e add
DEFINE l_success  LIKE type_t.num5


   #LET g_sql = "SELECT * FROM isat_t",   #161208-00026#19   mark
   #161208-00026#19   add---s
   LET g_sql = "SELECT isatent,isatcomp,isatdocno,isatseq,isat001,
                       isat002,isat003,isat004,isat005,isat006,
                       isat007,isat008,isat009,isat010,isat011,
                       isat012,isat013,isat014,isat015,isat016,
                       isat017,isat018,isat019,isat020,isat021,
                       isat022,isat023,isat024,isat100,isat101,
                       isat103,isat104,isat105,isat106,isat107,
                       isat113,isat114,isat115,isat201,isat202,
                       isat203,isat204,isat205,isat206,isat207,
                       isat208,isat209,isatud001,isatud002,isatud003,
                       isatud004,isatud005,isatud006,isatud007,isatud008,
                       isatud009,isatud010,isatud011,isatud012,isatud013,
                       isatud014,isatud015,isatud016,isatud017,isatud018,
                       isatud019,isatud020,isatud021,isatud022,isatud023,
                       isatud024,isatud025,isatud026,isatud027,isatud028,
                       isatud029,isatud030,isatsite,isatdocdt,isat025,
                       isat026,isat027,isat028,isat029,isat108,
                       isat118
                  FROM isat_t",
   #161208-00026#19   add---e
               " WHERE isatent = ",g_enterprise,
               "   AND isatcomp = '",g_isaf_m.isafcomp,"'",
               "   AND isatdocno = '",g_isaf_m.isafdocno,"'",
               "   AND isat014 <> '12' ",
               "   AND isat014 <> '2' "
   PREPARE isat_pre1 FROM g_sql
   DECLARE isat_cus1 CURSOR FOR isat_pre1
   #FOREACH isat_cus1 INTO l_isat.*   #161208-00026#19   mark
   #161208-00026#19   add---s
   FOREACH isat_cus1 
      INTO l_isat.isatent,l_isat.isatcomp,l_isat.isatdocno,l_isat.isatseq,l_isat.isat001,
           l_isat.isat002,l_isat.isat003,l_isat.isat004,l_isat.isat005,l_isat.isat006,
           l_isat.isat007,l_isat.isat008,l_isat.isat009,l_isat.isat010,l_isat.isat011,
           l_isat.isat012,l_isat.isat013,l_isat.isat014,l_isat.isat015,l_isat.isat016,
           l_isat.isat017,l_isat.isat018,l_isat.isat019,l_isat.isat020,l_isat.isat021,
           l_isat.isat022,l_isat.isat023,l_isat.isat024,l_isat.isat100,l_isat.isat101,
           l_isat.isat103,l_isat.isat104,l_isat.isat105,l_isat.isat106,l_isat.isat107,
           l_isat.isat113,l_isat.isat114,l_isat.isat115,l_isat.isat201,l_isat.isat202,
           l_isat.isat203,l_isat.isat204,l_isat.isat205,l_isat.isat206,l_isat.isat207,
           l_isat.isat208,l_isat.isat209,l_isat.isatud001,l_isat.isatud002,l_isat.isatud003,
           l_isat.isatud004,l_isat.isatud005,l_isat.isatud006,l_isat.isatud007,l_isat.isatud008,
           l_isat.isatud009,l_isat.isatud010,l_isat.isatud011,l_isat.isatud012,l_isat.isatud013,
           l_isat.isatud014,l_isat.isatud015,l_isat.isatud016,l_isat.isatud017,l_isat.isatud018,
           l_isat.isatud019,l_isat.isatud020,l_isat.isatud021,l_isat.isatud022,l_isat.isatud023,
           l_isat.isatud024,l_isat.isatud025,l_isat.isatud026,l_isat.isatud027,l_isat.isatud028,
           l_isat.isatud029,l_isat.isatud030,l_isat.isatsite,l_isat.isatdocdt,l_isat.isat025,
           l_isat.isat026,l_isat.isat027,l_isat.isat028,l_isat.isat029,l_isat.isat108,
           l_isat.isat118
   #161208-00026#19   add---e
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET g_success = 'N'
         EXIT FOREACH
      END IF

      SELECT MAX(isatseq) + 1 INTO l_isat.isatseq
        FROM isat_t 
        WHERE isatent = g_enterprise
          #AND isatcomp = g_isaf_m.isafcomp   #151021
          #AND isatdocno = g_isaf_m.isafdocno #151021
          AND isat003 =  l_isat.isat003       #151021
          AND isat004 =  l_isat.isat004       #151021
      IF cl_null(l_isat.isatseq) THEN
         LET l_isat.isatseq = 1
      END IF
      
      IF g_isaf_m.isaf056 = '1' THEN
         LET l_isat.isat014 = '12'
         LET l_isat.isat025 = l_isat.isat014 #151005-00007#2
      ELSE
         LET l_isat.isat014 = '22'
         LET l_isat.isat025 = l_isat.isat014 #151005-00007#2
      END IF
      
      #160304-00023#1 add ------
      LET l_isat.isat015 = g_isaf_m.isaf037  #異動理由碼
      LET l_isat.isat016 = g_isaf_m.isaf038  #異動備註
      LET l_isat.isat017 = g_isaf_m.isaf039  #異動日期
      LET l_isat.isat018 = g_isaf_m.isaf040  #異動時間
      LET l_isat.isat019 = g_isaf_m.isaf041  #異動人員
      LET l_isat.isat020 = g_isaf_m.isaf042  #專案作廢核准文號
      #160304-00023#1 add end---
      
     #INSERT INTO isat_t VALUES(l_isat.*) #161108-00017#6 mark
      #161108-00017#6 --s add
      INSERT INTO isat_t(isatent,isatcomp,isatdocno,isatseq,isat001,
                         isat002,isat003,isat004,isat005,isat006,
                         isat007,isat008,isat009,isat010,isat011,
                         isat012,isat013,isat014,isat015,isat016,
                         isat017,isat018,isat019,isat020,isat021,
                         isat022,isat023,isat024,isat100,isat101,
                         isat103,isat104,isat105,isat106,isat107,
                         isat113,isat114,isat115,isat201,isat202,
                         isat203,isat204,isat205,isat206,isat207,
                         isat208,isat209,isatud001,isatud002,isatud003,
                         isatud004,isatud005,isatud006,isatud007,isatud008,
                         isatud009,isatud010,isatud011,isatud012,isatud013,
                         isatud014,isatud015,isatud016,isatud017,isatud018,
                         isatud019,isatud020,isatud021,isatud022,isatud023,
                         isatud024,isatud025,isatud026,isatud027,isatud028,
                         isatud029,isatud030,isatsite,isatdocdt,isat025,
                         isat026,isat027,isat028,isat029,isat108,
                         isat118)
      VALUES(l_isat.isatent,l_isat.isatcomp,l_isat.isatdocno,l_isat.isatseq,l_isat.isat001,
             l_isat.isat002,l_isat.isat003,l_isat.isat004,l_isat.isat005,l_isat.isat006,
             l_isat.isat007,l_isat.isat008,l_isat.isat009,l_isat.isat010,l_isat.isat011,
             l_isat.isat012,l_isat.isat013,l_isat.isat014,l_isat.isat015,l_isat.isat016,
             l_isat.isat017,l_isat.isat018,l_isat.isat019,l_isat.isat020,l_isat.isat021,
             l_isat.isat022,l_isat.isat023,l_isat.isat024,l_isat.isat100,l_isat.isat101,
             l_isat.isat103,l_isat.isat104,l_isat.isat105,l_isat.isat106,l_isat.isat107,
             l_isat.isat113,l_isat.isat114,l_isat.isat115,l_isat.isat201,l_isat.isat202,
             l_isat.isat203,l_isat.isat204,l_isat.isat205,l_isat.isat206,l_isat.isat207,
             l_isat.isat208,l_isat.isat209,l_isat.isatud001,l_isat.isatud002,l_isat.isatud003,
             l_isat.isatud004,l_isat.isatud005,l_isat.isatud006,l_isat.isatud007,l_isat.isatud008,
             l_isat.isatud009,l_isat.isatud010,l_isat.isatud011,l_isat.isatud012,l_isat.isatud013,
             l_isat.isatud014,l_isat.isatud015,l_isat.isatud016,l_isat.isatud017,l_isat.isatud018,
             l_isat.isatud019,l_isat.isatud020,l_isat.isatud021,l_isat.isatud022,l_isat.isatud023,
             l_isat.isatud024,l_isat.isatud025,l_isat.isatud026,l_isat.isatud027,l_isat.isatud028,
             l_isat.isatud029,l_isat.isatud030,l_isat.isatsite,l_isat.isatdocdt,l_isat.isat025,
             l_isat.isat026,l_isat.isat027,l_isat.isat028,l_isat.isat029,l_isat.isat108,
             l_isat.isat118)  
      #161108-00017#6 --e add
      
      #151005-00007#2 ---s---
      #160304-00023#1 add update isat015~isat020
      UPDATE isat_t
         SET isat025 = l_isat.isat014
            ,isat015 = l_isat.isat015
            ,isat016 = l_isat.isat016
            ,isat017 = l_isat.isat017
            ,isat018 = l_isat.isat018
            ,isat019 = l_isat.isat019
            ,isat020 = l_isat.isat020
       WHERE isatent = g_enterprise
         AND isatcomp = g_isaf_m.isafcomp
         AND isatdocno = g_isaf_m.isafdocno
         AND isat004 = l_isat.isat004
         AND isat014 IN ('11','21')
      #151005-00007#2 ---e---
      IF SQLCA.SQLcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "isat_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET g_success = 'N'
         EXIT FOREACH
      END IF
   END FOREACH


END FUNCTION


# 修改发票历程档的发票代码,发票号码时,回写单头和发票明细的发票号码,发票代码
PRIVATE FUNCTION aist310_isaf011_update()
DEFINE  l_n                   LIKE type_t.num5
DEFINE  l_isaf010             LIKE isaf_t.isaf010
DEFINE  l_isaf011             LIKE isaf_t.isaf011
DEFINE  l_success             LIKE type_t.num5
   
   #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
   SELECT COUNT(1) INTO l_n  #160907-00046#1
     FROM isat_t 
    WHERE isatent = g_enterprise
      AND isatcomp = g_isaf_m.isafcomp
      AND isatdocno = g_isaf_m.isafdocno
   IF l_n = 0 THEN
      #161101-00039#1 --e add
      CALL s_transaction_begin()
      CALL cl_err_collect_init()
      UPDATE isaf_t SET isaf051='',isaf011='',isaf010=''
       WHERE isafent = g_enterprise
         AND isafcomp = g_isaf_m.isafcomp
         AND isafdocno = g_isaf_m.isafdocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "isaf_t"
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         CALL s_transaction_end('N','0')
      ELSE
         CALL s_transaction_end('Y','0')
      END IF
      CALL cl_err_collect_show()
      CALL aist310_ui_headershow()
      #161101-00039#1 --e add
      RETURN
   END IF
   
   SELECT COUNT(DISTINCT isat003) INTO l_n
     FROM isat_t
    WHERE isatent = g_enterprise
      AND isatcomp = g_isaf_m.isafcomp
      AND isatdocno = g_isaf_m.isafdocno
   IF l_n > 1 THEN
      LET l_isaf010 = 'MULTI'
   ELSE
      SELECT DISTINCT isat003 INTO l_isaf010
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isatcomp = g_isaf_m.isafcomp
         AND isatdocno = g_isaf_m.isafdocno
   END IF
   
   SELECT COUNT(DISTINCT isat004) INTO l_n
     FROM isat_t
    WHERE isatent = g_enterprise
      AND isatcomp = g_isaf_m.isafcomp
      AND isatdocno = g_isaf_m.isafdocno
   IF l_n > 1 THEN
      LET l_isaf011 = 'MULTI'
   ELSE
      SELECT isat004 INTO l_isaf011
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isatcomp = g_isaf_m.isafcomp
         AND isatdocno = g_isaf_m.isafdocno
   END IF
   
   #开启事务
   CALL s_transaction_begin()
   CALL cl_err_collect_init()
   LET l_success = TRUE
   
   UPDATE isaf_t SET isaf010 = l_isaf010,
                     isaf011 = l_isaf011
    WHERE isafent = g_enterprise
      AND isafcomp = g_isaf_m.isafcomp
      AND isafdocno = g_isaf_m.isafdocno
   IF SQLCA.SQLcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "UPDATE isaf_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET l_success = FALSE
   END IF
   
   UPDATE isah_t SET isah001 = l_isaf010,
                     isah002 = l_isaf011
    WHERE isahent = g_enterprise
      AND isahcomp = g_isaf_m.isafcomp
      AND isahdocno = g_isaf_m.isafdocno
      #AND isah002 IS NULL                     #160111-00020#2 #170112-00008#2 mark
      AND (isah002 IS NULL OR isah002 = ' ')   #170112-00008#2
   IF SQLCA.SQLcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "UPDATE isah_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET l_success = FALSE
   END IF 
   
   IF l_success = TRUE THEN 
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
   CALL cl_err_collect_show()
   CALL aist310_ui_headershow()
   
END FUNCTION


# 修改單頭稅額、匯率 重新計算單身金額
PRIVATE FUNCTION aist310_update_isaf016()
   DEFINE l_isagseq       LIKE isag_t.isagseq
   DEFINE l_isagorga      LIKE isag_t.isagorga
   DEFINE l_isag001       LIKE isag_t.isag001
   DEFINE l_isag004       LIKE isag_t.isag004
   DEFINE l_isag006       LIKE isag_t.isag006
   DEFINE l_isag008       LIKE isag_t.isag008
   DEFINE l_isag101       LIKE isag_t.isag101
   DEFINE l_isag103       LIKE isag_t.isag103
   DEFINE l_isag104       LIKE isag_t.isag104
   DEFINE l_isag105       LIKE isag_t.isag105
   DEFINE l_isag113       LIKE isag_t.isag113
   DEFINE l_isag114       LIKE isag_t.isag114
   DEFINE l_isag115       LIKE isag_t.isag115
   DEFINE l_isahseq       LIKE isah_t.isahseq
   DEFINE l_isahorga      LIKE isah_t.isahorga
   DEFINE l_isah006       LIKE isah_t.isah006
   DEFINE l_isah007       LIKE isah_t.isah007
   DEFINE l_isah101       LIKE isah_t.isah101
   DEFINE l_isah103       LIKE isah_t.isah103
   DEFINE l_isah104       LIKE isah_t.isah104
   DEFINE l_isah105       LIKE isah_t.isah105
   DEFINE l_isah113       LIKE isah_t.isah113
   DEFINE l_isah114       LIKE isah_t.isah114
   DEFINE l_isah115       LIKE isah_t.isah115
   DEFINE l_xrcd123       LIKE xrcd_t.xrcd113
   DEFINE l_xrcd124       LIKE xrcd_t.xrcd114
   DEFINE l_xrcd125       LIKE xrcd_t.xrcd115
   DEFINE l_xrcd133       LIKE xrcd_t.xrcd113
   DEFINE l_xrcd134       LIKE xrcd_t.xrcd114
   DEFINE l_xrcd135       LIKE xrcd_t.xrcd115
   DEFINE l_n             LIKE type_t.num5
   
   
   LET g_sql = "SELECT isagseq,isagorga,isag001,isag004,isag101,isag103,isag105 ",
               "  FROM isag_t ",
               " WHERE isagent = '",g_enterprise,"'",
               "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
               "   AND isagdocno = '",g_isaf_m.isafdocno,"'"
   PREPARE isaf016_pre FROM g_sql
   DECLARE isaf016_cur CURSOR FOR isaf016_pre  
   FOREACH isaf016_cur INTO l_isagseq,l_isagorga,l_isag001,l_isag004,l_isag101,l_isag103,l_isag105
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "foreach:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      
      LET l_isag006 = g_isaf_m.isaf016
      LET l_isag008 = g_isaf_m.isaf018  
      
      IF cl_null(l_isag004) OR l_isag004 = 0 THEN 
         IF g_isaf_m.isaf017 = 'N' THEN 
            CALL s_tax_count(l_isagorga,g_isaf_m.isaf016,l_isag103,0,g_isaf_m.isaf100,g_isaf_m.isaf101)
                   RETURNING l_isag103,l_isag104,l_isag105,
                             l_isag113,l_isag114,l_isag115
         ELSE
            CALL s_tax_count(l_isagorga,g_isaf_m.isaf016,l_isag105,0,g_isaf_m.isaf100,g_isaf_m.isaf101)
                   RETURNING l_isag103,l_isag104,l_isag105,
                             l_isag113,l_isag114,l_isag115
         END IF
      ELSE
         CALL s_tax_ins(g_isaf_m.isafdocno,l_isagseq,0,l_isagorga,
                        l_isag004*l_isag101,l_isag006,
                        l_isag004,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,1,1)
           RETURNING l_isag103,l_isag104,l_isag105,
                     l_isag113,l_isag114,l_isag115,
                     l_xrcd123,l_xrcd124,l_xrcd125,
                     l_xrcd133,l_xrcd134,l_xrcd135
      END IF
                    
      #161214-00053#1 mark ------
      #LET l_isag103 = s_curr_round(g_site,g_isaf_m.isaf100,l_isag103,2)
      #LET l_isag104 = s_curr_round(g_site,g_isaf_m.isaf100,l_isag104,2)
      #LET l_isag105 = s_curr_round(g_site,g_isaf_m.isaf100,l_isag105,2)
      ##161209-00037#1 mark ------
      ##LET l_isag113 = s_curr_round(g_site,g_isaf_m.isaf100,l_isag113,2)
      ##LET l_isag114 = s_curr_round(g_site,g_isaf_m.isaf100,l_isag114,2)
      ##LET l_isag115 = s_curr_round(g_site,g_isaf_m.isaf100,l_isag115,2)
      ##161209-00037#1 mark end---
      ##161209-00037#1 add ------
      #LET l_isag113 = s_curr_round(g_site,g_glaa001,l_isag113,2)
      #LET l_isag114 = s_curr_round(g_site,g_glaa001,l_isag114,2)
      #LET l_isag115 = s_curr_round(g_site,g_glaa001,l_isag115,2)
      ##161209-00037#1 add end---
      #161214-00053#1 mark end---
      #161214-00053#1 add ------
      CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,l_isag103,2) RETURNING g_sub_success,g_errno,l_isag103
      CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,l_isag104,2) RETURNING g_sub_success,g_errno,l_isag104
      CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,l_isag105,2) RETURNING g_sub_success,g_errno,l_isag105
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isag113,2) RETURNING g_sub_success,g_errno,l_isag113
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isag114,2) RETURNING g_sub_success,g_errno,l_isag114
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isag115,2) RETURNING g_sub_success,g_errno,l_isag115
      #161214-00053#1 add end---
      
      UPDATE isag_t
         SET isag006 = l_isag006,
             isag008 = l_isag008,
             isag103 = l_isag103,
             isag104 = l_isag104,
             isag105 = l_isag105,
             isag113 = l_isag113,
             isag114 = l_isag114,
             isag115 = l_isag115
       WHERE isagent = g_enterprise
         AND isagcomp = g_isaf_m.isafcomp
         AND isagdocno = g_isaf_m.isafdocno
         AND isagseq   = l_isagseq
      
   END FOREACH 
               
   LET g_sql = "SELECT isahseq,isahorga,isah006,isah101 ",
               "  FROM isah_t ",
               " WHERE isahent = '",g_enterprise,"'",
               "   AND isahcomp = '",g_isaf_m.isafcomp,"'",
               "   AND isahdocno = '",g_isaf_m.isafdocno,"'"
   PREPARE isaf016_pre_1 FROM g_sql
   DECLARE isaf016_cur_1 CURSOR FOR isaf016_pre_1
   FOREACH isaf016_cur_1 INTO l_isahseq,l_isahorga,l_isah006,l_isah101
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "foreach:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      LET l_isah007 = g_isaf_m.isaf018    
      
      #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
      SELECT COUNT(1) INTO l_n #160907-00046#1
        FROM isag_t 
       WHERE isagent = g_enterprise
         AND isagcomp = g_isaf_m.isafcomp
         AND isagdocno = g_isaf_m.isafdocno
         
      IF l_n = 0 THEN #沒有立帳來源,由發票明細展稅
         CALL s_tax_ins(g_isaf_m.isafdocno,l_isahseq,0,l_isahorga,
                        l_isah006*l_isah101,g_isaf_m.isaf016,
                        l_isah006,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,1,1)
           RETURNING l_isah103,l_isah104,l_isah105,
                     l_isah113,l_isah114,l_isah115,
                     l_xrcd123,l_xrcd124,l_xrcd125,
                     l_xrcd133,l_xrcd134,l_xrcd135
      ELSE 
         #預設發票稅前金額
         IF g_isaf_m.isaf017 = 'Y' THEN 
            LET l_isah103 = (l_isah101/(1+l_isah007/100)) * l_isah006
         ELSE
            LET l_isah103 = l_isah101 * l_isah006
         END IF 
         
         #預設發票稅額
         IF g_isaf_m.isaf017 = 'Y' THEN 
            LET l_isah104 = (l_isah101 * l_isah006) - (l_isah101/(1+l_isah007/100)) * l_isah006    
         ELSE
            LET l_isah104 = (l_isah101 * l_isah006) * l_isah007/100
         END IF 
         
         #預設發票稅後金額
         LET l_isah105 = l_isah103 + l_isah104
         
         #預設發票本幣稅前金額
         LET l_isah113 = l_isah103 * g_isaf_m.isaf101
         
         #預設發票本幣稅額
         LET l_isah114 = l_isah104 * g_isaf_m.isaf101
         
         #預設發票本幣稅後金額
         LET l_isah115 = l_isah113 + l_isah114
      END IF
      #161214-00053#1 mark ------
      #LET l_isah103 = s_curr_round(g_site,g_isaf_m.isaf100,l_isah103,2)
      #LET l_isah104 = s_curr_round(g_site,g_isaf_m.isaf100,l_isah104,2)
      #LET l_isah105 = s_curr_round(g_site,g_isaf_m.isaf100,l_isah105,2)
      ##161209-00037#1 mark ------
      ##LET l_isah113 = s_curr_round(g_site,g_isaf_m.isaf100,l_isah113,2)
      ##LET l_isah114 = s_curr_round(g_site,g_isaf_m.isaf100,l_isah114,2)
      ##LET l_isah115 = s_curr_round(g_site,g_isaf_m.isaf100,l_isah115,2)
      ##161209-00037#1 mark end---
      ##161209-00037#1 add ------
      #LET l_isah113 = s_curr_round(g_site,g_glaa001,l_isah113,2)
      #LET l_isah114 = s_curr_round(g_site,g_glaa001,l_isah114,2)
      #LET l_isah115 = s_curr_round(g_site,g_glaa001,l_isah115,2)
      ##161209-00037#1 add end---
      #161214-00053#1 mark end---
      #161214-00053#1 add ------
      CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,l_isah103,2) RETURNING g_sub_success,g_errno,l_isah103
      CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,l_isah104,2) RETURNING g_sub_success,g_errno,l_isah104
      CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,l_isah105,2) RETURNING g_sub_success,g_errno,l_isah105
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isah113,2) RETURNING g_sub_success,g_errno,l_isah113
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isah114,2) RETURNING g_sub_success,g_errno,l_isah114
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isah115,2) RETURNING g_sub_success,g_errno,l_isah115
      #161214-00053#1 add end---
      
      UPDATE isah_t
         SET isah007 = l_isah007,
             isah103 = l_isah103,
             isah104 = l_isah104,
             isah105 = l_isah105,
             isah113 = l_isah113,
             isah114 = l_isah114,
             isah115 = l_isah115
       WHERE isahent = g_enterprise
         AND isahcomp = g_isaf_m.isafcomp
         AND isahdocno = g_isaf_m.isafdocno
         AND isahseq   = l_isahseq
   END FOREACH
   
   CALL aist310_isaf_sum()
END FUNCTION
# 回写交易税明细档xrcd_t
PRIVATE FUNCTION aist310_xrcd_upd()
   
   UPDATE xrcd_t SET xrcd103 = g_isag_d[l_ac].isag103,
                     xrcd104 = g_isag_d[l_ac].isag104,
                     xrcd105 = g_isag_d[l_ac].isag105,
                     xrcd113 = g_isag_d[l_ac].isag113,
                     xrcd114 = g_isag_d[l_ac].isag114,
                     xrcd115 = g_isag_d[l_ac].isag115
    WHERE xrcdent = g_enterprise
      AND xrcdld = g_glaald
      AND xrcddocno = g_isaf_m.isafdocno
      AND xrcdseq = g_isag_d[l_ac].isagseq
      AND xrcdseq2 = 0
      AND xrcd007 = g_isag_d[l_ac].isagseq
      
   IF SQLCA.SQLcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "upd xrcd_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
  
      CALL s_transaction_end('N','0')  
   ELSE
      CALL s_transaction_end('Y','0')   
   END IF
   
END FUNCTION
# 回写出货/销退单已开发票数量
#151223-00001#3 add lujh
PUBLIC FUNCTION aist310_upd_xmdl(p_seq,p_isag002,p_isag003,p_sign)
   DEFINE l_sql                STRING
   DEFINE p_seq                LIKE isag_t.isagseq
   DEFINE p_sign               LIKE type_t.chr1     #1.+  2.- 
   DEFINE p_isag002            LIKE isag_t.isag002
   DEFINE p_isag003            LIKE isag_t.isag003
   DEFINE l_isag002            LIKE isag_t.isag002
   DEFINE l_isag003            LIKE isag_t.isag003
   DEFINE l_isag004            LIKE isag_t.isag004
   DEFINE r_success            LIKE type_t.num5
   
   LET r_success = TRUE
   
   LET l_sql = "SELECT isag002,isag003,isag004 ",
               "  FROM isag_t ",
               " WHERE isagent = '",g_enterprise,"'",
               "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
               "   AND isagcomp = '",g_isaf_m.isafcomp,"'",
               "   AND isag001 IN ('11','21')"
   IF NOT cl_null(p_seq)  THEN 
      LET l_sql = l_sql," AND isagseq = ",p_seq
   END IF 
   IF NOT cl_null(p_isag002) AND NOT cl_null(p_isag003) THEN
      LET l_sql = l_sql," AND isag002 = '",p_isag002,"'",
                        " AND isag003 = ",p_isag003
   END IF    
   PREPARE isag_upd_xmdl_pre1 FROM l_sql
   DECLARE isag_upd_xmdl_cs1 CURSOR FOR isag_upd_xmdl_pre1

   LET l_sql = "UPDATE xmdl_t SET xmdl047 = COALESCE(xmdl047,0)",p_sign," ? ",
               " WHERE xmdlent = ",g_enterprise,
               "   AND xmdldocno = ? ",
               "   AND xmdlseq = ? "
   PREPARE aist310_upd_xmdl_pre2 FROM l_sql
   
   FOREACH isag_upd_xmdl_cs1 INTO l_isag002,l_isag003,l_isag004
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      
      EXECUTE aist310_upd_xmdl_pre2 USING l_isag004,l_isag002,l_isag003
      IF SQLCA.SQLcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "update"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         EXIT FOREACH
      END IF
   END FOREACH
   
   RETURN r_success
END FUNCTION
# 稅額異動后重新計算含稅及未稅額
PRIVATE FUNCTION aist310_tax_amount(p_type)
   DEFINE p_type       LIKE type_t.chr1     #1.修改原幣稅額 2.修改本幣稅額
   DEFINE l_n          LIKE type_t.num5
   DEFINE r_xrcd       RECORD
          xrcd103      LIKE xrcd_t.xrcd103,
          xrcd104      LIKE xrcd_t.xrcd104,  
          xrcd105      LIKE xrcd_t.xrcd105,
          xrcd113      LIKE xrcd_t.xrcd113,
          xrcd114      LIKE xrcd_t.xrcd114,
          xrcd115      LIKE xrcd_t.xrcd115,
          xrcd123      LIKE xrcd_t.xrcd123,
          xrcd124      LIKE xrcd_t.xrcd124,
          xrcd125      LIKE xrcd_t.xrcd125,
          xrcd133      LIKE xrcd_t.xrcd133,
          xrcd134      LIKE xrcd_t.xrcd134,
          xrcd135      LIKE xrcd_t.xrcd135
                       END RECORD
   
   INITIALIZE r_xrcd.* TO NULL
   LET g_success = 'Y'
   
   #稅額異動后重新計算含稅及未稅額
   
   IF p_type = '1' THEN 
      CALL s_tax_calc_curr_tax_amount(g_glaald,g_isaf_m.isafdocno,g_isag3_d[l_ac].xrcdseq,0,
                                      g_isag3_d[l_ac].xrcd104,'')
                           RETURNING r_xrcd.*
                           
      LET g_isag3_d[l_ac].xrcd103 = r_xrcd.xrcd103
      LET g_isag3_d[l_ac].xrcd105 = r_xrcd.xrcd105
      LET g_isag3_d[l_ac].xrcd114 = r_xrcd.xrcd114
      
      DISPLAY g_isag3_d[l_ac].xrcd103 TO s_detail3[l_ac].xrcd103
      DISPLAY g_isag3_d[l_ac].xrcd105 TO s_detail3[l_ac].xrcd105
      DISPLAY g_isag3_d[l_ac].xrcd114 TO s_detail3[l_ac].xrcd114
   ELSE
      CALL s_tax_calc_curr_tax_amount(g_glaald,g_isaf_m.isafdocno,g_isag3_d[l_ac].xrcdseq,0,
                                      '',g_isag3_d[l_ac].xrcd114)
                           RETURNING r_xrcd.*
                           
      LET r_xrcd.xrcd103 = g_isag3_d[l_ac].xrcd103
      LET r_xrcd.xrcd104 = g_isag3_d[l_ac].xrcd104
      LET r_xrcd.xrcd105 = g_isag3_d[l_ac].xrcd105
   END IF
   
   UPDATE xrcd_t SET xrcd103 = r_xrcd.xrcd103,
                     xrcd104 = r_xrcd.xrcd104,
                     xrcd105 = r_xrcd.xrcd105,
                     xrcd113 = r_xrcd.xrcd113,
                     xrcd114 = r_xrcd.xrcd114,
                     xrcd115 = r_xrcd.xrcd115,
                     xrcd123 = r_xrcd.xrcd123,
                     xrcd124 = r_xrcd.xrcd124,
                     xrcd125 = r_xrcd.xrcd125,
                     xrcd133 = r_xrcd.xrcd133,
                     xrcd134 = r_xrcd.xrcd134,
                     xrcd135 = r_xrcd.xrcd135
    WHERE xrcdent   = g_enterprise 
      AND xrcdld    = g_glaald
      AND xrcddocno = g_isaf_m.isafdocno      
      AND xrcdseq   = g_isag3_d[l_ac].xrcdseq
      AND xrcdseq2  = 0
      AND xrcd007   = g_isag3_d[l_ac].xrcd007


   #交易稅被異動後要重新更新 isag
   INITIALIZE r_xrcd.* TO NULL
        
   SELECT (CASE WHEN xrcd103 IS NULL THEN 0 ELSE xrcd103 END) xrcd103,
          (CASE WHEN xrcd104 IS NULL THEN 0 ELSE xrcd104 END) xrcd104,
          (CASE WHEN xrcd105 IS NULL THEN 0 ELSE xrcd105 END) xrcd105,
          (CASE WHEN xrcd113 IS NULL THEN 0 ELSE xrcd113 END) xrcd113,
          (CASE WHEN xrcd114 IS NULL THEN 0 ELSE xrcd114 END) xrcd114,
          (CASE WHEN xrcd115 IS NULL THEN 0 ELSE xrcd115 END) xrcd115,
          (CASE WHEN xrcd123 IS NULL THEN 0 ELSE xrcd123 END) xrcd123,
          (CASE WHEN xrcd124 IS NULL THEN 0 ELSE xrcd124 END) xrcd124,
          (CASE WHEN xrcd125 IS NULL THEN 0 ELSE xrcd125 END) xrcd125,
          (CASE WHEN xrcd133 IS NULL THEN 0 ELSE xrcd133 END) xrcd133,
          (CASE WHEN xrcd134 IS NULL THEN 0 ELSE xrcd134 END) xrcd134,
          (CASE WHEN xrcd135 IS NULL THEN 0 ELSE xrcd135 END) xrcd135
     INTO r_xrcd.*
     FROM (
         SELECT SUM(xrcd103) xrcd103,SUM(xrcd104) xrcd104,SUM(xrcd105) xrcd105,
                SUM(xrcd113) xrcd113,SUM(xrcd114) xrcd114,SUM(xrcd115) xrcd115,
                SUM(xrcd123) xrcd123,SUM(xrcd124) xrcd124,SUM(xrcd125) xrcd125,
                SUM(xrcd133) xrcd133,SUM(xrcd134) xrcd134,SUM(xrcd135) xrcd135
           FROM xrcd_t
          WHERE xrcdent   = g_enterprise
            AND xrcdld    = g_glaald 
            AND xrcddocno = g_isaf_m.isafdocno
            AND xrcdseq   = g_isag3_d[l_ac].xrcdseq
            AND xrcdseq2  = 0
          )
          
   #SELECT COUNT(*) INTO l_n #160907-00046#1 mark
   SELECT COUNT(1) INTO l_n  #160907-00046#1
     FROM isag_t 
    WHERE isagent = g_enterprise
      AND isagcomp = g_isaf_m.isafcomp
      AND isagdocno = g_isaf_m.isafdocno
   IF l_n = 0 THEN 
      LET g_isag2_d[l_ac].isah103 = r_xrcd.xrcd103
      LET g_isag2_d[l_ac].isah104 = r_xrcd.xrcd104
      LET g_isag2_d[l_ac].isah105 = r_xrcd.xrcd105
      LET g_isag2_d[l_ac].isah113 = r_xrcd.xrcd113
      LET g_isag2_d[l_ac].isah114 = r_xrcd.xrcd114
      LET g_isag2_d[l_ac].isah115 = r_xrcd.xrcd115
      
      DISPLAY g_isag2_d[l_ac].isah103 TO s_detail2[l_ac].isah103
      DISPLAY g_isag2_d[l_ac].isah104 TO s_detail2[l_ac].isah104
      DISPLAY g_isag2_d[l_ac].isah105 TO s_detail2[l_ac].isah105
      
      UPDATE isah_t SET isah103 = r_xrcd.xrcd103,
                        isah104 = r_xrcd.xrcd104,
                        isah105 = r_xrcd.xrcd105,
                        isah113 = r_xrcd.xrcd113,
                        isah114 = r_xrcd.xrcd114,
                        isah115 = r_xrcd.xrcd115
       WHERE isahent   = g_enterprise 
         AND isahcomp  = g_isaf_m.isafcomp
         AND isahdocno = g_isaf_m.isafdocno      
         AND isahseq   = g_isag3_d[l_ac].xrcdseq
         
   ELSE
      LET g_isag_d[l_ac].isag103 = r_xrcd.xrcd103
      LET g_isag_d[l_ac].isag104 = r_xrcd.xrcd104
      LET g_isag_d[l_ac].isag105 = r_xrcd.xrcd105
      LET g_isag_d[l_ac].isag113 = r_xrcd.xrcd113
      LET g_isag_d[l_ac].isag114 = r_xrcd.xrcd114
      LET g_isag_d[l_ac].isag115 = r_xrcd.xrcd115
      
      DISPLAY g_isag_d[l_ac].isag103 TO s_detail1[l_ac].isag103
      DISPLAY g_isag_d[l_ac].isag104 TO s_detail1[l_ac].isag104
      DISPLAY g_isag_d[l_ac].isag105 TO s_detail1[l_ac].isag105
      DISPLAY g_isag_d[l_ac].isag113 TO s_detail1[l_ac].isag113
      DISPLAY g_isag_d[l_ac].isag114 TO s_detail1[l_ac].isag114
      DISPLAY g_isag_d[l_ac].isag115 TO s_detail1[l_ac].isag115
      
      UPDATE isag_t SET isag103 = r_xrcd.xrcd103,
                        isag104 = r_xrcd.xrcd104,
                        isag105 = r_xrcd.xrcd105,
                        isag113 = r_xrcd.xrcd113,
                        isag114 = r_xrcd.xrcd114,
                        isag115 = r_xrcd.xrcd115
       WHERE isagent   = g_enterprise 
         AND isagcomp  = g_isaf_m.isafcomp
         AND isagdocno = g_isaf_m.isafdocno      
         AND isagseq   = g_isag3_d[l_ac].xrcdseq
         
      CALL aist310_compile_to_isah()
   END IF
   
   CALL aist310_isaf_sum()
   
   IF SQLCA.SQLcode THEN
      CALL s_transaction_end('N','1')  
      LET g_success = 'N'      
   END IF  
END FUNCTION



# 栏位显示
PRIVATE FUNCTION aist310_visible()

   IF g_isaf_m.isaf056 = '2' THEN 
      CALL cl_set_comp_visible("isag013,isag014,isah008,isah009",TRUE)
   ELSE
      CALL cl_set_comp_visible("isag013,isag014,isah008,isah009",FALSE)
   END IF
   
   
   #161214-00053#1 mark ------
   ##SELECT isai002,isai008 INTO g_isai002,g_isai008                  #161020-00002#1 mark
   #SELECT isai002,isai006,isai008 INTO g_isai002,g_isai006,g_isai008 #161020-00002#1
   #  FROM isai_t
   # WHERE isaient = g_enterprise
   #   AND isai001 = g_ooef019
   #161214-00053#1 mark end---
   
   CALL cl_set_comp_visible('isaf010,isag013.isah001,isah008,isat003',TRUE)  #151029-00001#3
   IF g_isai002 = '1' THEN
      CALL cl_set_comp_visible('isaf010,isag013,isah001,isah008,isat003',FALSE)
   ELSE
      CALL cl_set_comp_visible('isaf010,isag013.isah001,isah008,isat003',TRUE)
   END IF
   
  #IF g_isai008 = 'TW' THEN #160803-00044#1 mark
   IF g_isai002 = '1' THEN  #160803-00044#1
      CALL cl_set_comp_visible("isaf023,isaf024,isaf025,isaf026,isaf029,isaf030,isaf031,isaf032",FALSE)
      CALL cl_set_comp_visible("isah011,isah106,isah012",FALSE)
     #CALL cl_set_comp_visible('page_6',TRUE) #161101-00042#1 mark
   ELSE
      CALL cl_set_comp_visible("isaf023,isaf024,isaf025,isaf026,isaf029,isaf030,isaf031,isaf032",TRUE)
      CALL cl_set_comp_visible("isah011,isah106,isah012",TRUE)
     #CALL cl_set_comp_visible('page_6',FALSE) #161101-00042#1 mark
   END IF
      
  #IF g_isai008 = 'TW' AND g_isaf_m.isaf056 = '2' THEN #160803-00044#1 mark
  #IF g_isai002 = '1' AND g_isaf_m.isaf056 = '2' THEN  #160803-00044#1 #160920-00032#1 mark
   IF g_isai006 = 'N' AND g_isaf_m.isaf056 = '2' THEN   #160920-00032#1
      CALL cl_set_comp_visible("isaf011,isah002,isaf052,isaf052_desc,isaf051,isaf009",FALSE)
   ELSE
      CALL cl_set_comp_visible("isaf011,isah002,isaf052,isaf052_desc,isaf051,isaf009",TRUE)
      #170215-00040#1 add ------
      IF g_isaf_m.isaf053 = '4' THEN
         CALL cl_set_comp_visible('isaf051',FALSE)
      END IF
      #170215-00040#1 add end---
   END IF
   
   #161101-00042#1 --s add
   IF g_isai008 = 'TW' THEN 
      CALL cl_set_comp_visible("isaf019,isaf059,isaf060,isaf061,isaf062,isaf063,isaf064",TRUE)
   ELSE
      CALL cl_set_comp_visible("isaf019,isaf059,isaf060,isaf061,isaf062,isaf063,isaf064",FALSE)
   END IF
   #161101-00042#1 --e add
   
   #161214-00053#1 add ------
   CALL cl_set_comp_required("isag013,isag014",FALSE)
   IF g_isaf_m.isaf001 = '4' OR g_isaf_m.isaf001 = '5' THEN
      IF g_isai003 = 'Y' THEN
         IF g_isai002 = '1' THEN
            CALL cl_set_comp_required("isag014",TRUE)
         ELSE
            CALL cl_set_comp_required("isag013,isag014",TRUE)
         END IF
      END IF
   END IF
   #161214-00053#1 add end---
   #170215-00040#1 mark ------
   ##170103-00009#1 add(s)
   #IF g_isaf_m.isaf053 = '4' THEN 
   #   CALL cl_set_comp_visible('isaf051',FALSE)
   #ELSE 
   #   CALL cl_set_comp_visible('isaf051',TRUE)
   #END IF
   ##170103-00009#1 add(s)
   #170215-00040#1 mark end---
END FUNCTION
# 库存过账/取消過賬
#151209-00023#1 add
PRIVATE FUNCTION aist310_post(p_cmd)
   DEFINE p_cmd            LIKE type_t.chr10        #post:過帳,unpos:取消過帳
   DEFINE l_sql            STRING
   DEFINE l_ope1           LIKE type_t.num5         #本庫運算
   DEFINE l_ope2           LIKE type_t.num5         #在途庫運算
   DEFINE l_flag           LIKE type_t.chr1         #1.扣帳  2.扣帳還原
   DEFINE l_isag002        LIKE isag_t.isag002
   DEFINE l_isag003        LIKE isag_t.isag003
   DEFINE l_isagdocno      LIKE isag_t.isagdocno
   DEFINE l_isagseq        LIKE isag_t.isagseq
   DEFINE l_xmdmseq        LIKE xmdm_t.xmdmseq
   DEFINE l_xmdmseq1       LIKE xmdm_t.xmdmseq1
   DEFINE l_xmdm001        LIKE xmdm_t.xmdm001
   DEFINE l_xmdm002        LIKE xmdm_t.xmdm002
   DEFINE l_xmdm005        LIKE xmdm_t.xmdm005
   DEFINE l_xmdm006        LIKE xmdm_t.xmdm006
   DEFINE l_xmdm007        LIKE xmdm_t.xmdm007
   DEFINE l_xmdm009        LIKE xmdm_t.xmdm009
   DEFINE l_xmdm008        LIKE xmdm_t.xmdm008
   DEFINE l_xmdm010        LIKE xmdm_t.xmdm010
   DEFINE l_xmdm011        LIKE xmdm_t.xmdm011
   DEFINE l_xmdm033        LIKE xmdm_t.xmdm033
   DEFINE l_xmdk001        LIKE xmdk_t.xmdk001
   DEFINE l_xmdk002        LIKE xmdk_t.xmdk002
   DEFINE l_xmdk007        LIKE xmdk_t.xmdk007
   DEFINE l_warehouse      LIKE xmdk_t.xmdk039
   DEFINE l_type           LIKE type_t.chr1
   DEFINE l_xmdk087        LIKE xmdk_t.xmdk087
   DEFINE r_success        LIKE type_t.num5
   
   LET r_success = TRUE
   
   IF p_cmd = 'post' THEN   #過帳
      LET l_ope1 = 1
      LET l_ope2 = -1
      LET l_flag = 1
   ELSE                     #取消過帳
      LET l_ope1 = -1
      LET l_ope2 = 1
      LET l_flag = 2
   END IF
   
   LET l_sql = "SELECT isag002,isag003,isagdocno,isagseq ",
               "  FROM isag_t ",
               " WHERE isagent = ",g_enterprise,
               "   AND isagdocno = '",g_isaf_m.isafdocno,"'",
               "   AND isagcomp = '",g_isaf_m.isafcomp,"'"
   PREPARE aist310_post_pre FROM l_sql
   DECLARE aist310_post_cs CURSOR FOR aist310_post_pre 
   
   LET l_sql = "SELECT xmdmseq,xmdmseq1,xmdm001,xmdm002,",
               "       xmdm005,xmdm006,xmdm007,xmdm009,xmdm008,xmdm010,xmdm011,",
               "       xmdm033,",
               "       xmdk001,xmdk007",
               "  FROM xmdk_t,xmdl_t,xmdm_t",
               " WHERE xmdkent = xmdlent AND xmdlent = xmdment AND xmdment = ",g_enterprise,
               "   AND xmdkdocno = xmdldocno AND xmdldocno = xmdmdocno AND xmdmdocno = ? ",
               "   AND xmdlseq = ? ",
               "   AND xmdlseq = xmdmseq",
               " ORDER BY xmdmseq,xmdmseq1"
   PREPARE aist310_post_pre1 FROM l_sql
   DECLARE aist310_post_cs1 CURSOR FOR aist310_post_pre1
   
   FOREACH aist310_post_cs INTO l_isag002,l_isag003,l_isagdocno,l_isagseq
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
       
         LET r_success = FALSE
         EXIT FOREACH
      END IF   
      
      IF cl_null(l_isag002) THEN 
         CONTINUE FOREACH
      END IF
   
      SELECT xmdk002,xmdk087 INTO l_xmdk002,l_xmdk087
        FROM xmdk_t
       WHERE xmdkent = g_enterprise
         AND xmdkdocno = l_isag002
         
      IF l_xmdk087 <> 'Y' THEN 
         CONTINUE FOREACH
      END IF
      
      FOREACH aist310_post_cs1 USING l_isag002,l_isag003 INTO l_xmdmseq,l_xmdmseq1,l_xmdm001,l_xmdm002,
                                                              l_xmdm005,l_xmdm006,l_xmdm007,l_xmdm009,
                                                              l_xmdm008,l_xmdm010,l_xmdm011,l_xmdm033,
                                                              l_xmdk001,l_xmdk007
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "FOREACH:"
            LET g_errparam.popup = TRUE
            CALL cl_err()
          
            LET r_success = FALSE
            EXIT FOREACH
         END IF          
         
         #檢查來源是否為成本倉
         CALL s_axmt540_inag012_chk(g_isaf_m.isafcomp,l_xmdm001,l_xmdm002,l_xmdm033,l_xmdm005,l_xmdm006,l_xmdm007,l_xmdm008)
         RETURNING l_type
         
         LET l_warehouse = ''         
         IF l_type = 'Y' THEN    #成本倉
            LET l_warehouse = cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-1005')
         ELSE
            LET l_warehouse = cl_get_para(g_enterprise,g_isaf_m.isafcomp,'S-FIN-1006')
         END IF
         
         IF NOT cl_null(l_warehouse) THEN
            #更新庫存明細檔
            #料件编号,产品特征,库存管理特征,库位,储位,批号,
            #异动类型(1:入库,-1:出库,0:报废,2:盘点),异动数量,异动日期,
            #单据编号,项次,项序,单位,参考数量
            #扣帳or扣帳還原,營運據點
            CALL s_inventory_upd_inag(l_xmdm001,l_xmdm002,l_xmdm033,l_warehouse,l_xmdk007,l_xmdm007,
                                      #l_ope2,l_xmdm009,g_today,            #160907-00041#1 mark 過帳時,call s_inventory_upd_inag 傳遞參數異動日期 g_today 改用發票日期
                                      l_ope2,l_xmdm009,g_isaf_m.isaf014,    #160907-00041#1 add 
                                      l_isag002,l_xmdmseq,l_xmdmseq1,l_xmdm008,l_xmdm011,
                                      l_flag,g_isaf_m.isafcomp) RETURNING r_success            
            IF NOT r_success THEN
               EXIT FOREACH
            END IF
            
            IF p_cmd = 'post' THEN
               #更新庫存交易明細表
               #出入庫碼(1入庫-1出庫),單據編號,項次,項序,料件編號,產品特徵
               #庫位編號,儲位編號,批號,數量,單位,參考單位,參考數量                  
               CALL aist310_inaj_ins(l_ope2,l_isag002,l_isag003,l_xmdmseq1,
                                     l_xmdm001,l_xmdm002,l_warehouse,l_xmdk007,l_xmdm007,l_xmdm033,
                                     l_xmdm009,l_xmdm008,l_xmdm010,l_xmdm011,g_isaf_m.isafdocdt,l_xmdk007,l_xmdk002,
                                     l_isagdocno,l_isagseq)
               RETURNING r_success
               IF NOT r_success THEN
                  EXIT FOREACH
               END IF
            END IF
         END IF
         
         IF p_cmd = 'unpos' THEN
            DELETE FROM inao_t
             WHERE inaoent = g_enterprise
               AND inaodocno = l_isagdocno
               AND inaoseq   = l_isagseq
               AND inao000 = '2'
            CALL aist310_del_inaj(l_isagdocno,l_isagseq,g_isaf_m.isafcomp) RETURNING r_success
            
            IF NOT r_success THEN
                RETURN r_success
            END IF
            
         END IF
      END FOREACH
   END FOREACH
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 庫存交易明細新增
# Memo...........:
# Usage..........: CALL aist310_inaj_ins(p_inaj004,p_xmdkdocno,p_xmdmseq,p_xmdmseq1,
#                                        p_xmdm001,p_xmdm002,p_xmdm005,p_xmdm006,p_xmdm007,p_xmdm033,
#                                        p_xmdm009,p_xmdm008,p_xmdm010,p_xmdm011,p_xmdk001,p_xmdk002,
#                                        p_isagdocno,p_seq)
#                  RETURNING r_success
# Input parameter: p_inaj004           #出入庫碼(1入庫-1出庫)
#                : p_xmdkdocno         #單據編號
#                : p_xmdmseq           #項次
#                : p_xmdmseq1          #項序
#                : p_xmdm001           #料件編號
#                : p_xmdm002           #產品特徵
#                : p_xmdm005           #庫位編號
#                : p_xmdm006           #儲位編號
#                : p_xmdm007           #批號
#                : p_xmdm033           #庫存管理特徵
#                : p_xmdm009           #數量
#                : p_xmdm008           #單位
#                : p_xmdm010           #參考單位
#                : p_xmdm011           #參考數量
#                : p_xmdk001           #扣帳日期
#                : p_xmdk007           #客戶編號
#                : p_xmdk002           #出貨性質
#                : p_isagdocno         #对账单单号
#                : p_isagseq           #对账单项次
# Return code....: r_success           #執行結果
#                : 
# Date & Author..: 151209-00023#1 By lujh  
################################################################################
PRIVATE FUNCTION aist310_inaj_ins(p_inaj004,p_xmdkdocno,p_xmdmseq,p_xmdmseq1,p_xmdm001,p_xmdm002,p_xmdm005,p_xmdm006,p_xmdm007,p_xmdm033,p_xmdm009,p_xmdm008,p_xmdm010,p_xmdm011,p_xmdk001,p_xmdk007,p_xmdk002,p_isagdocno,p_isagseq)
   DEFINE p_inaj004        LIKE inaj_t.inaj004     #出入庫碼(1入庫,-1出庫)   
   DEFINE p_xmdkdocno      LIKE xmdk_t.xmdkdocno
   DEFINE p_xmdmseq        LIKE xmdm_t.xmdmseq
   DEFINE p_xmdmseq1       LIKE xmdm_t.xmdmseq1
   DEFINE p_xmdm001        LIKE xmdm_t.xmdm001
   DEFINE p_xmdm002        LIKE xmdm_t.xmdm002
   DEFINE p_xmdm005        LIKE xmdm_t.xmdm005
   DEFINE p_xmdm006        LIKE xmdm_t.xmdm006
   DEFINE p_xmdm007        LIKE xmdm_t.xmdm007
   DEFINE p_xmdm033        LIKE xmdm_t.xmdm033
   DEFINE p_xmdm009        LIKE xmdm_t.xmdm009
   DEFINE p_xmdm008        LIKE xmdm_t.xmdm008
   DEFINE p_xmdm010        LIKE xmdm_t.xmdm010
   DEFINE p_xmdm011        LIKE xmdm_t.xmdm011
   DEFINE p_xmdk001        LIKE xmdk_t.xmdk001
   DEFINE p_xmdk007        LIKE xmdk_t.xmdk007
   DEFINE p_xmdk002        LIKE xmdk_t.xmdk002  
   DEFINE p_isagdocno      LIKE isag_t.isagdocno
   DEFINE p_isagseq        LIKE isag_t.isagseq
   DEFINE r_success        LIKE type_t.num5
   #DEFINE l_inao           RECORD LIKE inao_t.* #161104-00024#10
   #161104-00024#10 --s add
   DEFINE l_inao RECORD  #製造批序號庫存異動明細檔
          inaoent LIKE inao_t.inaoent, #企業編號
          inaosite LIKE inao_t.inaosite, #營運據點
          inaodocno LIKE inao_t.inaodocno, #單號
          inaoseq LIKE inao_t.inaoseq, #項次
          inaoseq1 LIKE inao_t.inaoseq1, #項序
          inaoseq2 LIKE inao_t.inaoseq2, #序號
          inao000 LIKE inao_t.inao000, #資料類型
          inao001 LIKE inao_t.inao001, #料件編號
          inao002 LIKE inao_t.inao002, #產品特徵
          inao003 LIKE inao_t.inao003, #庫存管理特徵
          inao004 LIKE inao_t.inao004, #包裝容器編號
          inao005 LIKE inao_t.inao005, #庫位
          inao006 LIKE inao_t.inao006, #儲位
          inao007 LIKE inao_t.inao007, #批號
          inao008 LIKE inao_t.inao008, #製造批號
          inao009 LIKE inao_t.inao009, #製造序號
          inao010 LIKE inao_t.inao010, #製造日期
          inao011 LIKE inao_t.inao011, #有效日期
          inao012 LIKE inao_t.inao012, #數量
          inao013 LIKE inao_t.inao013, #出入庫碼
          inaoud001 LIKE inao_t.inaoud001, #自定義欄位(文字)001
          inaoud002 LIKE inao_t.inaoud002, #自定義欄位(文字)002
          inaoud003 LIKE inao_t.inaoud003, #自定義欄位(文字)003
          inaoud004 LIKE inao_t.inaoud004, #自定義欄位(文字)004
          inaoud005 LIKE inao_t.inaoud005, #自定義欄位(文字)005
          inaoud006 LIKE inao_t.inaoud006, #自定義欄位(文字)006
          inaoud007 LIKE inao_t.inaoud007, #自定義欄位(文字)007
          inaoud008 LIKE inao_t.inaoud008, #自定義欄位(文字)008
          inaoud009 LIKE inao_t.inaoud009, #自定義欄位(文字)009
          inaoud010 LIKE inao_t.inaoud010, #自定義欄位(文字)010
          inaoud011 LIKE inao_t.inaoud011, #自定義欄位(數字)011
          inaoud012 LIKE inao_t.inaoud012, #自定義欄位(數字)012
          inaoud013 LIKE inao_t.inaoud013, #自定義欄位(數字)013
          inaoud014 LIKE inao_t.inaoud014, #自定義欄位(數字)014
          inaoud015 LIKE inao_t.inaoud015, #自定義欄位(數字)015
          inaoud016 LIKE inao_t.inaoud016, #自定義欄位(數字)016
          inaoud017 LIKE inao_t.inaoud017, #自定義欄位(數字)017
          inaoud018 LIKE inao_t.inaoud018, #自定義欄位(數字)018
          inaoud019 LIKE inao_t.inaoud019, #自定義欄位(數字)019
          inaoud020 LIKE inao_t.inaoud020, #自定義欄位(數字)020
          inaoud021 LIKE inao_t.inaoud021, #自定義欄位(日期時間)021
          inaoud022 LIKE inao_t.inaoud022, #自定義欄位(日期時間)022
          inaoud023 LIKE inao_t.inaoud023, #自定義欄位(日期時間)023
          inaoud024 LIKE inao_t.inaoud024, #自定義欄位(日期時間)024
          inaoud025 LIKE inao_t.inaoud025, #自定義欄位(日期時間)025
          inaoud026 LIKE inao_t.inaoud026, #自定義欄位(日期時間)026
          inaoud027 LIKE inao_t.inaoud027, #自定義欄位(日期時間)027
          inaoud028 LIKE inao_t.inaoud028, #自定義欄位(日期時間)028
          inaoud029 LIKE inao_t.inaoud029, #自定義欄位(日期時間)029
          inaoud030 LIKE inao_t.inaoud030, #自定義欄位(日期時間)030
          inao014 LIKE inao_t.inao014, #庫存單位
          inao020 LIKE inao_t.inao020, #檢驗合格量
          inao021 LIKE inao_t.inao021, #已入庫/出貨/簽收量
          inao022 LIKE inao_t.inao022, #已驗退/簽退量
          inao023 LIKE inao_t.inao023, #已倉退/銷退量
          inao024 LIKE inao_t.inao024, #已轉QC量
          inao025 LIKE inao_t.inao025  #已退品量
   END RECORD
   #161104-00024#10 --e add
   DEFINE l_sql            STRING
   DEFINE l_xmdk087        LIKE xmdk_t.xmdk087  
   DEFINE l_xmdk000        LIKE xmdk_t.xmdk000     #161228-00004#1
   DEFINE l_n              LIKE type_t.num5 

   WHENEVER ERROR CONTINUE

   LET r_success = TRUE

   IF NOT cl_null(p_inaj004) OR
      NOT cl_null(p_xmdkdocno) OR
      NOT cl_null(p_xmdm001) OR
      NOT cl_null(p_xmdm005) OR
      NOT cl_null(p_xmdm009) OR
      NOT cl_null(p_xmdm008) THEN

      #更新庫存交易明細表
      INITIALIZE g_inaj.* TO NULL

      LET g_inaj.inajent = g_enterprise       #企業代碼          
      LET g_inaj.inajsite = g_isaf_m.isafcomp #營運據點      
      LET g_inaj.inaj001 = p_isagdocno        #單據編號          
      LET g_inaj.inaj002 = p_isagseq          #項次                      
      LET g_inaj.inaj003 = p_xmdmseq1         #項序
      LET g_inaj.inaj004 = p_inaj004          #出入庫碼(1入庫,-1出庫)               
      LET g_inaj.inaj005 = p_xmdm001          #料件編號          
      LET g_inaj.inaj006 = p_xmdm002          #產品特徵          
      LET g_inaj.inaj007 = p_xmdm033          #庫存管理特徵      
      LET g_inaj.inaj008 = p_xmdm005          #庫位編號          
      LET g_inaj.inaj009 = p_xmdm006          #儲位編號          
      LET g_inaj.inaj010 = p_xmdm007          #批號                      
      LET g_inaj.inaj011 = p_xmdm009          #交易數量          
      LET g_inaj.inaj012 = p_xmdm008          #交易單位          
      #LET g_inaj.inaj013 = #元件有預設值      #交易單位與庫存單位換算率         
      #LET g_inaj.inaj014 = #元件有預設值      #交易單位與料件基本單位換算率     
      LET g_inaj.inaj015 = g_prog             #異動命令代號              
      #LET g_inaj.inaj016 =                   #理由碼                     
      #LET g_inaj.inaj017 =                   #異動部門編號               
      LET g_inaj.inaj018 = p_xmdk007          #異動廠商/客戶編號  
      #LET g_inaj.inaj019 =                   #備註                       
      #LET g_inaj.inaj020 =                   #工單單號/料號            
      #LET g_inaj.inaj021 =                   #多角序號                 
      LET g_inaj.inaj022 = p_xmdk001          #單據扣帳日期
      #LET g_inaj.inaj023 = cl_get_today()     #實際執行扣帳日期   #160816-00023#1 mark 過帳寫入 inaj023 時,改用發票日期(isaf014)傳入
      LET g_inaj.inaj023 = g_isaf_m.isaf014   #發票日期           #160816-00023#1 add
      LET g_inaj.inaj024 = cl_get_time()      #資料產生時間              
      LET g_inaj.inaj025 = g_user             #異動資料產生者
      LET g_inaj.inaj026 = p_xmdm010          #參考單位
      LET g_inaj.inaj027 = p_xmdm011          #參考數量
      #LET g_inaj.inaj028                     #成本料號
      #LET g_inaj.inaj038 =  #專案編號
      #LET g_inaj.inaj039 =  #WBS    
      SELECT xmdl030,xmdl031 INTO g_inaj.inaj038,g_inaj.inaj039 FROM xmdl_t WHERE xmdlent = g_enterprise AND xmdldocno = p_xmdkdocno AND xmdlseq = p_xmdmseq

      #161228-00004#1--mark--str--lujh
      #IF p_xmdk002 MATCHES '[34]' THEN
      #   LET g_inaj.inaj036 = '401'           #調撥
      #END IF
      #161228-00004#1--mark--end--lujh
      
      SELECT xmdk087,xmdk000 INTO l_xmdk087,l_xmdk000 FROM xmdk_t WHERE xmdkent = g_enterprise AND xmdkdocno = p_xmdkdocno   #161228-00004#1 add xmdk000 lujh
      
      #161228-00004#1--add--str--lujh
      IF l_xmdk000 = '6' THEN 
         LET g_inaj.inaj036 = '202'   #銷售退貨
      ELSE
         LET g_inaj.inaj036 = '201'   #銷售出庫
      END IF
      #161228-00004#1--add--end--lujh
      
      IF l_xmdk087 = 'Y' THEN    
         #LET g_inaj.inaj036 = '401'           #調撥     #161228-00004#1 mark lujh
         
         #將inao的資料也同步更新，入到發票倉
         #LET l_sql = " SELECT * FROM inao_t ",   #161208-00026#19   mark
         #161208-00026#19   add---s
         LET l_sql = " SELECT inaoent,inaosite,inaodocno,inaoseq,inaoseq1,
                              inaoseq2,inao000,inao001,inao002,inao003,
                              inao004,inao005,inao006,inao007,inao008,
                              inao009,inao010,inao011,inao012,inao013,
                              inaoud001,inaoud002,inaoud003,inaoud004,inaoud005,
                              inaoud006,inaoud007,inaoud008,inaoud009,inaoud010,
                              inaoud011,inaoud012,inaoud013,inaoud014,inaoud015,
                              inaoud016,inaoud017,inaoud018,inaoud019,inaoud020,
                              inaoud021,inaoud022,inaoud023,inaoud024,inaoud025,
                              inaoud026,inaoud027,inaoud028,inaoud029,inaoud030,
                              inao014,inao020,inao021,inao022,inao023,
                              inao024,inao025
                         FROM inao_t ",
         #161208-00026#19   add---e
                     "  WHERE inaoent = '",g_enterprise,"'",
                     "    AND inaodocno = '",p_xmdkdocno,"'",
                     "    AND inaoseq = '",p_xmdmseq,"'",
                     "    AND inaoseq1 = '",p_xmdmseq1,"'",
                     "    AND inao005 = '",p_xmdm005,"'",
                     "    AND inao006 = '",p_xmdm006,"'",
                     "    AND inao000 = 2 "
         PREPARE aist310_inao_pre FROM l_sql
         DECLARE aist310_inao_cur CURSOR FOR aist310_inao_pre
         #FOREACH aist310_inao_cur INTO l_inao.*   #161208-00026#19   mark
         #161208-00026#19   add---s
         FOREACH aist310_inao_cur 
            INTO l_inao.inaoent,l_inao.inaosite,l_inao.inaodocno,l_inao.inaoseq,l_inao.inaoseq1,
                 l_inao.inaoseq2,l_inao.inao000,l_inao.inao001,l_inao.inao002,l_inao.inao003,
                 l_inao.inao004,l_inao.inao005,l_inao.inao006,l_inao.inao007,l_inao.inao008,
                 l_inao.inao009,l_inao.inao010,l_inao.inao011,l_inao.inao012,l_inao.inao013,
                 l_inao.inaoud001,l_inao.inaoud002,l_inao.inaoud003,l_inao.inaoud004,l_inao.inaoud005,
                 l_inao.inaoud006,l_inao.inaoud007,l_inao.inaoud008,l_inao.inaoud009,l_inao.inaoud010,
                 l_inao.inaoud011,l_inao.inaoud012,l_inao.inaoud013,l_inao.inaoud014,l_inao.inaoud015,
                 l_inao.inaoud016,l_inao.inaoud017,l_inao.inaoud018,l_inao.inaoud019,l_inao.inaoud020,
                 l_inao.inaoud021,l_inao.inaoud022,l_inao.inaoud023,l_inao.inaoud024,l_inao.inaoud025,
                 l_inao.inaoud026,l_inao.inaoud027,l_inao.inaoud028,l_inao.inaoud029,l_inao.inaoud030,
                 l_inao.inao014,l_inao.inao020,l_inao.inao021,l_inao.inao022,l_inao.inao023,
                 l_inao.inao024,l_inao.inao025
         #161208-00026#19   add---e
         
            LET l_inao.inao013 = p_inaj004
            LET l_inao.inao005 = p_xmdm005
            LET l_inao.inao006 = p_xmdm006
            LET l_inao.inao007 = p_xmdm007
            
            LET l_n = 0
            #SELECT COUNT(*) INTO l_n FROM inao_t #160907-00046#1 mark
            SELECT COUNT(1) INTO l_n FROM inao_t #160907-00046#1
               WHERE inaoent = g_enterprise AND inaodocno = p_isagdocno AND inaoseq = p_isagseq AND inaoseq1 = l_inao.inaoseq1
                 AND inao013 = p_inaj004 AND inaoseq2 = l_inao.inaoseq2
            IF l_n = 0 OR cl_null(l_n) THEN
            
               INSERT INTO inao_t(inaoent,inaosite,inaodocno,inaoseq,inaoseq1,inaoseq2,inao000,inao001,inao002,inao003,
                                  inao004,inao005,inao006,inao007,inao008,inao009,inao010,inao011,inao012,inao013,
                                  inao014,inao020,inao021,inao022,inao023,inao024)
                      VALUES(g_enterprise,g_isaf_m.isafcomp,p_isagdocno,p_isagseq,l_inao.inaoseq1,
                             l_inao.inaoseq2,l_inao.inao000,l_inao.inao001,l_inao.inao002,l_inao.inao003,
                             l_inao.inao004,l_inao.inao005,l_inao.inao006,l_inao.inao007,l_inao.inao008,
                             l_inao.inao009,l_inao.inao010,l_inao.inao011,l_inao.inao012,l_inao.inao013,
                             l_inao.inao014,l_inao.inao020,l_inao.inao021,l_inao.inao022,l_inao.inao023,
                             l_inao.inao024) 
               
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "ins inao_t:"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()         
                  LET r_success = FALSE
                  EXIT FOREACH
               END IF   
            END IF               
         END FOREACH 
      END IF

      CALL s_inventory_ins_inaj(g_isaf_m.isafcomp) RETURNING r_success
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 庫存單據過帳還原時刪除對應的庫存交易異動明細
# Memo...........:
# Usage..........: CALL aist310_del_inaj(p_docno,p_seq,p_site)
#                  RETURNING r_success
# Input parameter: p_docno     單據編號
#                : p_seq       項次
#                : p_site      營運據點
# Return code....: r_success   處理狀態
# Date & Author..: 151209-00023#1 By lujh
# Modify.........:
################################################################################
PRIVATE FUNCTION aist310_del_inaj(p_docno,p_seq,p_site)
   DEFINE p_docno      LIKE inaj_t.inaj001
   DEFINE p_seq        LIKE inaj_t.inaj002
   DEFINE p_site       LIKE inaj_t.inajsite
   DEFINE r_success    LIKE type_t.num5
   DEFINE l_inaj033    LIKE inaj_t.inaj033
   DEFINE l_inbamoddt  LIKE inba_t.inbamoddt


   WHENEVER ERROR CONTINUE

   LET r_success = TRUE

   #檢查傳入的單據編號是否有值，若沒有則顯示錯誤訊息並不允許往下執行，並回傳失敗
   IF cl_null(p_docno) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'sub-00228'#160318-00005#22 mod #'sub-00351'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF

   IF cl_null(p_site) THEN
      LET p_site = g_site
   END IF

   #刪除庫存交易明細資料
   DELETE FROM inaj_t
    WHERE inajent  = g_enterprise
      AND inajsite = p_site
      AND inaj001  = p_docno
      AND inaj002  = p_seq
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "del inaj_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   #刪除inaj_t資料的同時刪除對應的inal_t
   DELETE FROM inal_t
    WHERE inalent = g_enterprise
      AND inalsite = p_site
      AND inal001 = p_docno
      AND inal002 = p_seq
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "del inal_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF         

   RETURN r_success
END FUNCTION
# 订单的时候整批将分摊后的资料插入单身
#160316-00017#2 add lujh
PRIVATE FUNCTION aist310_isag_ins_10(p_isag002,p_isag011,p_site)
   DEFINE p_isag002            LIKE isag_t.isag002
   DEFINE p_isag011            LIKE isag_t.isag011
   DEFINE p_site               LIKE isag_t.isagorga
   DEFINE l_sql                STRING
   DEFINE l_success            LIKE type_t.num5
   DEFINE l_isag004            LIKE isag_t.isag004
  #DEFINE l_isag               RECORD LIKE isag_t.* #161104-00024#10
   #161104-00024#10 --s add
   DEFINE l_isag RECORD  #銷項發票來源明細檔
          isagent LIKE isag_t.isagent, #企業編號
          isagcomp LIKE isag_t.isagcomp, #法人
          isagdocno LIKE isag_t.isagdocno, #開票單號
          isagseq LIKE isag_t.isagseq, #項次
          isagorga LIKE isag_t.isagorga, #來源組織
          isag001 LIKE isag_t.isag001, #來源類型
          isag002 LIKE isag_t.isag002, #來源單號
          isag003 LIKE isag_t.isag003, #來源項次
          isag004 LIKE isag_t.isag004, #發票數量
          isag005 LIKE isag_t.isag005, #發票單位
          isag006 LIKE isag_t.isag006, #稅別
          isag007 LIKE isag_t.isag007, #含稅否
          isag008 LIKE isag_t.isag008, #稅率
          isag009 LIKE isag_t.isag009, #料號
          isag010 LIKE isag_t.isag010, #品名
          isag011 LIKE isag_t.isag011, #期別
          isag012 LIKE isag_t.isag012, #收款條件
          isag013 LIKE isag_t.isag013, #原始發票編號
          isag014 LIKE isag_t.isag014, #原始發票號碼
          isag015 LIKE isag_t.isag015, #正負值
          isag016 LIKE isag_t.isag016, #客戶料號
          isag017 LIKE isag_t.isag017, #客戶品名
          isag101 LIKE isag_t.isag101, #原幣單價
          isag103 LIKE isag_t.isag103, #原幣未稅金額
          isag104 LIKE isag_t.isag104, #原幣稅額
          isag105 LIKE isag_t.isag105, #原幣稅後金額
          isag106 LIKE isag_t.isag106, #訂金發票已被攤未稅額
          isag113 LIKE isag_t.isag113, #本幣未稅金額
          isag114 LIKE isag_t.isag114, #本幣稅額
          isag115 LIKE isag_t.isag115, #本幣稅後金額
          isag116 LIKE isag_t.isag116, #原幣已收金額
          isag117 LIKE isag_t.isag117, #本幣已收金額
          isag126 LIKE isag_t.isag126, #輔助帳二原幣已收金額　
          isag127 LIKE isag_t.isag127, #輔助帳二本幣已收金額　
          isag128 LIKE isag_t.isag128, #輔助帳二應收單號
          isag136 LIKE isag_t.isag136, #輔助帳三原幣已收金額　
          isag137 LIKE isag_t.isag137, #輔助帳二本幣已收金額　
          isag138 LIKE isag_t.isag138, #輔助帳三應收單號
          isagud001 LIKE isag_t.isagud001, #自定義欄位(文字)001
          isagud002 LIKE isag_t.isagud002, #自定義欄位(文字)002
          isagud003 LIKE isag_t.isagud003, #自定義欄位(文字)003
          isagud004 LIKE isag_t.isagud004, #自定義欄位(文字)004
          isagud005 LIKE isag_t.isagud005, #自定義欄位(文字)005
          isagud006 LIKE isag_t.isagud006, #自定義欄位(文字)006
          isagud007 LIKE isag_t.isagud007, #自定義欄位(文字)007
          isagud008 LIKE isag_t.isagud008, #自定義欄位(文字)008
          isagud009 LIKE isag_t.isagud009, #自定義欄位(文字)009
          isagud010 LIKE isag_t.isagud010, #自定義欄位(文字)010
          isagud011 LIKE isag_t.isagud011, #自定義欄位(數字)011
          isagud012 LIKE isag_t.isagud012, #自定義欄位(數字)012
          isagud013 LIKE isag_t.isagud013, #自定義欄位(數字)013
          isagud014 LIKE isag_t.isagud014, #自定義欄位(數字)014
          isagud015 LIKE isag_t.isagud015, #自定義欄位(數字)015
          isagud016 LIKE isag_t.isagud016, #自定義欄位(數字)016
          isagud017 LIKE isag_t.isagud017, #自定義欄位(數字)017
          isagud018 LIKE isag_t.isagud018, #自定義欄位(數字)018
          isagud019 LIKE isag_t.isagud019, #自定義欄位(數字)019
          isagud020 LIKE isag_t.isagud020, #自定義欄位(數字)020
          isagud021 LIKE isag_t.isagud021, #自定義欄位(日期時間)021
          isagud022 LIKE isag_t.isagud022, #自定義欄位(日期時間)022
          isagud023 LIKE isag_t.isagud023, #自定義欄位(日期時間)023
          isagud024 LIKE isag_t.isagud024, #自定義欄位(日期時間)024
          isagud025 LIKE isag_t.isagud025, #自定義欄位(日期時間)025
          isagud026 LIKE isag_t.isagud026, #自定義欄位(日期時間)026
          isagud027 LIKE isag_t.isagud027, #自定義欄位(日期時間)027
          isagud028 LIKE isag_t.isagud028, #自定義欄位(日期時間)028
          isagud029 LIKE isag_t.isagud029, #自定義欄位(日期時間)029
          isagud030 LIKE isag_t.isagud030, #自定義欄位(日期時間)030
          isag018 LIKE isag_t.isag018 #訂金已開發票
   END RECORD
   #161104-00024#10 --e add
   DEFINE r_xrcd123            LIKE xrcd_t.xrcd113
   DEFINE r_xrcd124            LIKE xrcd_t.xrcd114
   DEFINE r_xrcd125            LIKE xrcd_t.xrcd115
   DEFINE r_xrcd133            LIKE xrcd_t.xrcd113
   DEFINE r_xrcd134            LIKE xrcd_t.xrcd114
   DEFINE r_xrcd135            LIKE xrcd_t.xrcd115
   DEFINE l_xmdc016            LIKE xmdc_t.xmdc016    #160322-00027#3 add lujh
   DEFINE l_isag105            LIKE isag_t.isag105
   DEFINE l_isagseq            LIKE isag_t.isagseq
   DEFINE l_xmdb006            LIKE xmdb_t.xmdb006
   DEFINE l_tmp                RECORD
                               num            LIKE type_t.num5,
                               xmdcsite       LIKE xmdc_t.xmdcsite,
                               type           LIKE type_t.chr20,
                               xmdadocno      LIKE xmda_t.xmdadocno,   #订单单号
                               xmdb001        LIKE xmdb_t.xmdb001,     #期别
                               xmdcseq        LIKE xmdc_t.xmdcseq,     #项次
                               xmdc010        LIKE xmdc_t.xmdc010,     #计价单位
                               xmda011        LIKE xmda_t.xmda011,     #税别
                               oodb005        LIKE oodb_t.oodb005,     #含税否
                               oodb006        LIKE oodb_t.oodb006,     #税率
                               xmda009        LIKE xmda_t.xmda009,     #收款条件
                               xmdc015        LIKE xmdc_t.xmdc015,     #单价
                               xmda016        LIKE xmda_t.xmda016,     #汇率
                               amt            LIKE xmdc_t.xmdc047,     #金額 
                               qty            LIKE xmdc_t.xmdc011,     #數量
                               #160517-00001#7 Add  ---(S)---
                               xmdc011        LIKE xmdc_t.xmdc011,
                               xmdc046        LIKE xmdc_t.xmdc046,
                               xmdc047        LIKE xmdc_t.xmdc047,
                               xmdc048        LIKE xmdc_t.xmdc048,
                               flag           LIKE type_t.chr1
                               #160517-00001#7 Add  ---(E)---
                               END RECORD
   
   LET l_success = TRUE  
   
   CALL cl_err_collect_init()   #20160427 add lujh
   
   CALL s_dep_pay(p_isag002,p_isag011,g_isaf_m.isaf016,p_site,g_isaf_m.isaf101,'') RETURNING l_success
   IF l_success = FALSE THEN 
      RETURN
   END IF

   LET l_sql = "SELECT * FROM s_dep_pay_tmp "
   PREPARE aist310_s_dep_pay_tmp_pre FROM l_sql
   DECLARE aist310_s_dep_pay_tmp_cs CURSOR FOR aist310_s_dep_pay_tmp_pre
   
   FOREACH aist310_s_dep_pay_tmp_cs INTO l_tmp.*
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'aist310_s_dep_pay_tmp_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET l_success = FALSE 

         EXIT FOREACH
      END IF
      
      SELECT MAX(isagseq) INTO l_isag.isagseq
        FROM isag_t
       WHERE isagent = g_enterprise
         AND isagcomp = g_isaf_m.isafcomp
         AND isagdocno = g_isaf_m.isafdocno
         
      IF cl_null(l_isag.isagseq) THEN 
         LET l_isag.isagseq = 1
      ELSE
         LET l_isag.isagseq = l_isag.isagseq + 1
      END IF

      SELECT xmdc001,xmda009,xmdc027,xmdc016    #160322-00027#3 add xmdc016 lujh
        INTO l_isag.isag009,l_isag.isag012,l_isag.isag016,l_xmdc016    #160322-00027#3 add l_xmdc016 lujh
        FROM xmda_t,xmdc_t
       WHERE xmdaent = g_enterprise
         AND xmdaent = xmdcent
         AND xmdadocno = xmdcdocno
         AND xmdadocno = l_tmp.xmdadocno
         AND xmdcseq = l_tmp.xmdcseq
         
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = l_isag.isag009
      CALL ap_ref_array2(g_ref_fields,"SELECT imaal003 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET l_isag.isag010 = '', g_rtn_fields[1] , ''
      
      SELECT gzcb004 INTO l_isag.isag015
        FROM gzcb_t
       WHERE gzcb001 = '8341'
         AND gzcb002 = '10'

      LET l_isag.isagent   = g_enterprise
      LET l_isag.isagcomp  = g_isaf_m.isafcomp
      LET l_isag.isagdocno = g_isaf_m.isafdocno
      LET l_isag.isagorga  = p_site
      LET l_isag.isag001   = '10'
      LET l_isag.isag002   = l_tmp.xmdadocno
      LET l_isag.isag003   = l_tmp.xmdcseq
      LET l_isag.isag005   = l_tmp.xmdc010
      LET l_isag.isag006   = l_xmdc016           #160322-00027#3 change l_tmp.xmda011 to xmdc016 lujh
      LET l_isag.isag007   = l_tmp.oodb005
      LET l_isag.isag008   = l_tmp.oodb006
      LET l_isag.isag011   = l_tmp.xmdb001
      LET l_isag.isag101   = l_tmp.xmdc015
      
      SELECT SUM(isag004) INTO l_isag004 
        FROM isag_t,isaf_t 
       WHERE isagent = g_enterprise
         AND isag002 = l_isag.isag002  
         AND isag003 = l_isag.isag003  
         AND isafent = isagent
         AND isafdocno = isagdocno
         AND isafcomp = isafcomp 
         AND isag011 = l_isag.isag011
         AND isafstus <> 'X'
         AND ((isagdocno = g_isaf_m.isafdocno
         AND   isagseq <> g_isag_d[l_ac].isagseq)
          OR   isagdocno <> g_isaf_m.isafdocno )   

      IF cl_null(l_isag004) THEN 
         LET l_isag004 = 0
      END IF
      
      #160517-00001#7 Mark ---(S)---
     #IF cl_null(l_tmp.qty) THEN 
     #   LET l_tmp.qty = 0
     #END IF
	  #
     #LET l_isag.isag004 = l_tmp.qty - l_isag004
      #160517-00001#7 Mark ---(E)---
      #160517-00001#7 Add  ---(S)---
      IF cl_null(l_tmp.xmdc011) THEN 
         LET l_tmp.xmdc011 = 0
      END IF
	   
      LET l_isag.isag004 = l_tmp.xmdc011 - l_isag004
      #160517-00001#7 Add  ---(E)---
      
      IF l_isag.isag004 = 0 THEN 
         #20160427--add--str--lujh
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "" 
         LET g_errparam.code   = "ais-00315" 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         #20160427--add--end--lujh
         CONTINUE FOREACH
      END IF
      
      #160517-00001#7 Mark ---(S)---
     #CALL s_tax_ins(g_isaf_m.isafdocno,l_isag.isagseq,0,l_isag.isagorga,
     #               l_tmp.amt,l_isag.isag006,
     #               l_isag.isag004,g_isaf_m.isaf100,g_isaf_m.isaf101,g_glaald,0,0)
     #  RETURNING l_isag.isag103,l_isag.isag104,l_isag.isag105,
     #            l_isag.isag113,l_isag.isag114,l_isag.isag115,
     #            r_xrcd123,r_xrcd124,r_xrcd125,r_xrcd133,r_xrcd134,r_xrcd135
      #160517-00001#7 Mark ---(E)---
      #160517-00001#7 Add  ---(S)---
      LET l_isag.isag103 = l_tmp.xmdc046
      LET l_isag.isag104 = l_tmp.xmdc048
      LET l_isag.isag105 = l_tmp.xmdc047
      LET l_isag.isag113 = l_isag.isag103 * g_isaf_m.isaf101
      LET l_isag.isag114 = l_isag.isag104 * g_isaf_m.isaf101
      LET l_isag.isag115 = l_isag.isag105 * g_isaf_m.isaf101
      #161214-00053#1 add ------
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isag.isag113,2) RETURNING g_sub_success,g_errno,l_isag.isag113
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isag.isag114,2) RETURNING g_sub_success,g_errno,l_isag.isag114
      CALL s_curr_round_ld('1',g_glaald,g_glaa001,l_isag.isag115,2) RETURNING g_sub_success,g_errno,l_isag.isag115
      #161214-00053#1 add end---
      
      DROP TABLE aist310_detail
      #SELECT * FROM xrcd_t WHERE xrcdent = g_enterprise   #161208-00026#19   mark
      #161208-00026#19   add---s
      SELECT xrcdent,xrcdcomp,xrcdld,xrcdsite,xrcddocno,
             xrcdseq,xrcdseq2,xrcdorga,xrcd001,xrcd002,
             xrcd003,xrcd004,xrcd005,xrcd006,xrcd007,
             xrcd008,xrcd009,xrcd010,xrcd100,xrcd101,
             xrcd102,xrcd103,xrcd104,xrcd105,xrcd106,
             xrcd112,xrcd113,xrcd114,xrcd115,xrcd116,
             xrcd117,xrcd118,xrcd121,xrcd124,xrcd131,
             xrcd134,xrcd123,xrcd125,xrcd133,xrcd135,
             xrcdud001,xrcdud002,xrcdud003,xrcdud004,xrcdud005,
             xrcdud006,xrcdud007,xrcdud008,xrcdud009,xrcdud010,
             xrcdud011,xrcdud012,xrcdud013,xrcdud014,xrcdud015,
             xrcdud016,xrcdud017,xrcdud018,xrcdud019,xrcdud020,
             xrcdud021,xrcdud022,xrcdud023,xrcdud024,xrcdud025,
             xrcdud026,xrcdud027,xrcdud028,xrcdud029,xrcdud030,
             xrcd011,xrcd012,xrcd013
        FROM xrcd_t 
       WHERE xrcdent = g_enterprise
      #161208-00026#19   add---e
         AND xrcddocno = l_tmp.xmdadocno
         AND xrcdseq   = l_tmp.xmdcseq
      INTO TEMP aist310_detail
      UPDATE aist310_detail SET xrcddocno = l_isag.isagdocno,xrcdseq = l_isag.isagseq
                               ,xrcd001 = g_prog, xrcdld = g_glaald   #170220-00070#1
      INSERT INTO xrcd_t SELECT * FROM aist310_detail
      DROP TABLE aist310_detail

      UPDATE xrcd_t SET xrcd103 = l_isag.isag103,
                        xrcd104 = l_isag.isag104,
                        xrcd105 = l_isag.isag105,
                        xrcd113 = l_isag.isag113,
                        xrcd114 = l_isag.isag114,
                        xrcd115 = l_isag.isag115
       WHERE xrcdent   = g_enterprise
         AND xrcddocno = l_isag.isagdocno
         AND xrcdseq   = l_isag.isagseq

      #160517-00001#7 Add  ---(E)---
      
     #INSERT INTO isag_t VALUES(l_isag.*) #161108-00017#6 mark
      #161108-00017#6 --s add
      INSERT INTO isag_t(isagent,isagcomp,isagdocno,isagseq,isagorga,
                         isag001,isag002,isag003,isag004,isag005,
                         isag006,isag007,isag008,isag009,isag010,
                         isag011,isag012,isag013,isag014,isag015,
                         isag016,isag017,isag101,isag103,isag104,
                         isag105,isag106,isag113,isag114,isag115,
                         isag116,isag117,isag126,isag127,isag128,
                         isag136,isag137,isag138,isagud001,isagud002,
                         isagud003,isagud004,isagud005,isagud006,isagud007,
                         isagud008,isagud009,isagud010,isagud011,isagud012,
                         isagud013,isagud014,isagud015,isagud016,isagud017,
                         isagud018,isagud019,isagud020,isagud021,isagud022,
                         isagud023,isagud024,isagud025,isagud026,isagud027,
                         isagud028,isagud029,isagud030,isag018)
      VALUES(l_isag.isagent,l_isag.isagcomp,l_isag.isagdocno,l_isag.isagseq,l_isag.isagorga,
             l_isag.isag001,l_isag.isag002,l_isag.isag003,l_isag.isag004,l_isag.isag005,
             l_isag.isag006,l_isag.isag007,l_isag.isag008,l_isag.isag009,l_isag.isag010,
             l_isag.isag011,l_isag.isag012,l_isag.isag013,l_isag.isag014,l_isag.isag015,
             l_isag.isag016,l_isag.isag017,l_isag.isag101,l_isag.isag103,l_isag.isag104,
             l_isag.isag105,l_isag.isag106,l_isag.isag113,l_isag.isag114,l_isag.isag115,
             l_isag.isag116,l_isag.isag117,l_isag.isag126,l_isag.isag127,l_isag.isag128,
             l_isag.isag136,l_isag.isag137,l_isag.isag138,l_isag.isagud001,l_isag.isagud002,
             l_isag.isagud003,l_isag.isagud004,l_isag.isagud005,l_isag.isagud006,l_isag.isagud007,
             l_isag.isagud008,l_isag.isagud009,l_isag.isagud010,l_isag.isagud011,l_isag.isagud012,
             l_isag.isagud013,l_isag.isagud014,l_isag.isagud015,l_isag.isagud016,l_isag.isagud017,
             l_isag.isagud018,l_isag.isagud019,l_isag.isagud020,l_isag.isagud021,l_isag.isagud022,
             l_isag.isagud023,l_isag.isagud024,l_isag.isagud025,l_isag.isagud026,l_isag.isagud027,
             l_isag.isagud028,l_isag.isagud029,l_isag.isagud030,l_isag.isag018)
      #161108-00017#6 --e add
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'insert isag_t'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET l_success = FALSE                  
      END IF
   END FOREACH
   
   LET l_isag105 = 0
   SELECT SUM(isag105) INTO l_isag105 FROM isag_t
    WHERE isagent = g_enterprise
      AND isagdocno = g_isaf_m.isafdocno AND isagcomp = g_isaf_m.isafcomp
      AND (isag018 = 'Y' OR isag018 IS NULL) #160823-00016#1
   IF cl_null(l_isag105) THEN LET l_isag105 = 0 END IF

   LET l_xmdb006 = 0
   SELECT xmdb006 INTO l_xmdb006 FROM xmdb_t WHERE xmdbent = g_enterprise
      AND xmdbdocno = p_isag002 AND xmdb001 = p_isag011
   IF cl_null(l_xmdb006) THEN LET l_xmdb006 = 0 END IF

   #訂金金額和发票金額存在差異
   IF l_isag105 <> l_xmdb006 THEN
      SELECT isagseq INTO l_isagseq FROM isag_t WHERE isagent = g_enterprise
         AND isagdocno = g_isaf_m.isafdocno AND isagcomp = g_isaf_m.isafcomp
         AND isag105 = (SELECT MAX(isag105) FROM isag_t WHERE isagent = g_enterprise
                           AND isagdocno = g_isaf_m.isafdocno AND isagcomp = g_isaf_m.isafcomp)
      IF cl_null(l_isagseq) THEN LET l_isagseq = 1 END IF
      #將差異金額放入應收單據單身金額最大的一筆的含稅金額中
      LET l_isag105 = l_xmdb006 - l_isag105
      UPDATE isag_t SET isag103 = isag103 + l_isag105,
                        isag105 = isag105 + l_isag105
       WHERE isagent = g_enterprise
         AND isagdocno = g_isaf_m.isafdocno
         AND isagcomp = g_isaf_m.isafcomp
         AND isagseq = l_isagseq

      UPDATE isag_t SET isag113 = isag103 * g_isaf_m.isaf101,
                        isag115 = isag105 * g_isaf_m.isaf101
       WHERE isagent = g_enterprise
         AND isagdocno = g_isaf_m.isafdocno
         AND isagcomp = g_isaf_m.isafcomp
         AND isagseq = l_isagseq
   END IF
   
   IF l_success = TRUE THEN
      CALL s_transaction_end('Y',0)
   ELSE
      CALL s_transaction_end('N',0)
   END IF
   
   CALL cl_err_collect_show()    #20160427 add lujh
   
   CALL aist310_b_fill()
END FUNCTION
# 把单头的法人更新到xrcdcomp
#160322-00027#3 add lujh
PRIVATE FUNCTION aist310_upd_xrcdcomp()
   IF g_para_data = 'Y' THEN 
      CALL s_transaction_begin()
      UPDATE xrcd_t SET xrcdcomp = g_isaf_m.isafcomp
       WHERE xrcdent = g_enterprise
         AND xrcdld = g_glaald
         AND xrcddocno = g_isaf_m.isafdocno
         
      IF SQLCA.SQLcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "upd xrcd_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
      
         CALL s_transaction_end('N','0')  
      ELSE
         CALL s_transaction_end('Y','0')   
      END IF
   END IF
END FUNCTION
##160414-00018#2 By albireo
PRIVATE FUNCTION aist310_fill_chk2(ps_idx)
   DEFINE ps_idx        LIKE type_t.chr10
     
  
   #此funtion功能暫時停用(2015/1/12)
   #無論傳入值為何皆回傳true(代表要填充該單身)
 
   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1')  AND 
      (cl_null(g_wc2_table2) OR g_wc2_table2.trim() = '1=1')  AND 
      (cl_null(g_wc2_table3) OR g_wc2_table3.trim() = '1=1')  AND 
      (cl_null(g_wc2_table4) OR g_wc2_table4.trim() = '1=1') THEN
      #add-point:fill_chk段other_chk name="fill_chk.other_chk"

      #end add-point
      RETURN TRUE
   END IF

   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 對帳單主畫面表尾合計金額
# Memo...........: 160826-00017#2
# Usage..........: CALL aist310_isaf_sum_button(p_isafcomp,p_isafdocno,p_isagseq)
# Date & Author..: 161108 By 06821
# Modify.........:
################################################################################
PRIVATE FUNCTION aist310_isaf_sum_button(p_isafcomp,p_isafdocno,p_isagseq)
DEFINE p_isafcomp       LIKE isaf_t.isafcomp
DEFINE p_isafdocno      LIKE isaf_t.isafdocno
DEFINE p_isagseq        LIKE isag_t.isagseq
DEFINE r_isaf103_s      LIKE isaf_t.isaf103
DEFINE r_isaf104_s      LIKE isaf_t.isaf104
DEFINE r_isaf105_s      LIKE isaf_t.isaf105
DEFINE r_isaf113_s      LIKE isaf_t.isaf113
DEFINE r_isaf114_s      LIKE isaf_t.isaf114
DEFINE r_isaf115_s      LIKE isaf_t.isaf115

   IF cl_null(p_isafcomp) OR cl_null(p_isafdocno) THEN
      RETURN
   END IF

   LET r_isaf103_s = 0
   LET r_isaf104_s = 0
   LET r_isaf105_s = 0
   LET r_isaf113_s = 0
   LET r_isaf114_s = 0
   LET r_isaf115_s = 0

   IF cl_null(p_isagseq) OR p_isagseq = 0 THEN
      SELECT SUM(isag103*isag015),SUM(isag104*isag015),SUM(isag105*isag015),
             SUM(isag113*isag015),SUM(isag114*isag015),SUM(isag115*isag015)
        INTO r_isaf103_s,r_isaf104_s,r_isaf105_s,
             r_isaf113_s,r_isaf114_s,r_isaf115_s
        FROM isag_t INNER JOIN isaf_t ON isafent = g_enterprise AND isafcomp = isagcomp AND isafdocno = isagdocno
       WHERE isagent = g_enterprise AND isagcomp = p_isafcomp AND isagdocno = p_isafdocno AND (isag018 = 'Y' OR isag018 IS NULL) 
   ELSE
      SELECT SUM(isag103*isag015),SUM(isag104*isag015),SUM(isag105*isag015),
             SUM(isag113*isag015),SUM(isag114*isag015),SUM(isag115*isag015)
        INTO r_isaf103_s,r_isaf104_s,r_isaf105_s,
             r_isaf113_s,r_isaf114_s,r_isaf115_s
        FROM isag_t INNER JOIN isaf_t ON isafent = g_enterprise AND isafcomp = isagcomp AND isafdocno = isagdocno
       WHERE isagent = g_enterprise AND isagcomp = p_isafcomp AND (isag018 = 'Y' OR isag018 IS NULL) 
         AND isagdocno = p_isafdocno AND isagseq <> p_isagseq
   END IF

   IF cl_null(r_isaf103_s) THEN LET r_isaf103_s = 0 END IF
   IF cl_null(r_isaf104_s) THEN LET r_isaf104_s = 0 END IF
   IF cl_null(r_isaf105_s) THEN LET r_isaf105_s = 0 END IF
   IF cl_null(r_isaf113_s) THEN LET r_isaf113_s = 0 END IF
   IF cl_null(r_isaf114_s) THEN LET r_isaf114_s = 0 END IF
   IF cl_null(r_isaf115_s) THEN LET r_isaf115_s = 0 END IF

   #同發票主檔金額合計取位
   #161214-00053#1 mark ------
   #LET r_isaf103_s = s_curr_round(g_site,g_isaf_m.isaf100,r_isaf103_s,2)
   #LET r_isaf104_s = s_curr_round(g_site,g_isaf_m.isaf100,r_isaf104_s,2)
   #LET r_isaf105_s = s_curr_round(g_site,g_isaf_m.isaf100,r_isaf105_s,2)
   ##161209-00037#1 mark ------
   ##LET r_isaf113_s = s_curr_round(g_site,g_isaf_m.isaf100,r_isaf113_s,2)
   ##LET r_isaf114_s = s_curr_round(g_site,g_isaf_m.isaf100,r_isaf114_s,2)
   ##LET r_isaf115_s = s_curr_round(g_site,g_isaf_m.isaf100,r_isaf115_s,2)
   ##161209-00037#1 mark end---
   ##161209-00037#1 add ------
   #LET r_isaf113_s = s_curr_round(g_site,g_glaa001,r_isaf113_s,2)
   #LET r_isaf114_s = s_curr_round(g_site,g_glaa001,r_isaf114_s,2)
   #LET r_isaf115_s = s_curr_round(g_site,g_glaa001,r_isaf115_s,2)
   ##161209-00037#1 add end---
   #161214-00053#1 mark end---
   #161214-00053#1 add ------
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,r_isaf103_s,2) RETURNING g_sub_success,g_errno,r_isaf103_s
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,r_isaf104_s,2) RETURNING g_sub_success,g_errno,r_isaf104_s
   CALL s_curr_round_ld('1',g_glaald,g_isaf_m.isaf100,r_isaf105_s,2) RETURNING g_sub_success,g_errno,r_isaf105_s
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,r_isaf113_s,2) RETURNING g_sub_success,g_errno,r_isaf113_s
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,r_isaf114_s,2) RETURNING g_sub_success,g_errno,r_isaf114_s
   CALL s_curr_round_ld('1',g_glaald,g_glaa001,r_isaf115_s,2) RETURNING g_sub_success,g_errno,r_isaf115_s
   #161214-00053#1 add end---
   
   #161214-00053#1 add ------
   IF g_isai004 = '1' THEN
      IF r_isaf103_s < 0 THEN
         LET r_isaf103_s = r_isaf103_s * -1
      END IF
      IF r_isaf104_s < 0 THEN
         LET r_isaf104_s = r_isaf104_s * -1
      END IF
      IF r_isaf105_s < 0 THEN
         LET r_isaf105_s = r_isaf105_s * -1
      END IF
      IF r_isaf113_s < 0 THEN
         LET r_isaf113_s = r_isaf113_s * -1
      END IF
      IF r_isaf114_s < 0 THEN
         LET r_isaf114_s = r_isaf114_s * -1
      END IF
      IF r_isaf115_s < 0 THEN
         LET r_isaf115_s = r_isaf115_s * -1
      END IF
   END IF
   #161214-00053#1 add end---
   
   RETURN r_isaf103_s,r_isaf104_s,r_isaf105_s,
          r_isaf113_s,r_isaf114_s,r_isaf115_s
END FUNCTION

 
{</section>}
 
