<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="afap210" std_prog="afap210" erpver="1.0" module="AFA" ver="5" env="s" zone="t10prd" booking="Y" type="M" identity="s" section_flag="N" designer_ver="1.0">
  <other>
    <code_template value="W" status=""/>
    <free_style value="N" status=""/>
    <start_arg value="" status=""/>
  </other>
  <point name="function.afap210_construct" order="1" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 單身資料查詢
# Memo...........:
# Usage..........: CALL afap210_construct()
# Input parameter: 
# Date & Author..: 2014/8/5 By 01531
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_construct()
   CLEAR FORM
   CALL g_detail_d.clear()
   INITIALIZE g_wc TO NULL
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

         CONSTRUCT BY NAME g_wc ON faak000,faak001,faak003,faak004

            BEFORE CONSTRUCT
               CALL cl_qbe_init()
            
            ON ACTION controlp INFIELD faak000
	            INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
	            LET g_qryparam.reqry = FALSE
               CALL q_faak000()                       #呼叫開窗
               DISPLAY g_qryparam.return1 TO faak000  #顯示到畫面上  
               NEXT FIELD faak000                     #返回原欄位 
               
            ON ACTION controlp INFIELD faak001
	            INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
	            LET g_qryparam.reqry = FALSE
               CALL q_faak001_1()                     #呼叫開窗
               DISPLAY g_qryparam.return1 TO faak001  #顯示到畫面上  
               NEXT FIELD faak001                     #返回原欄位 

            ON ACTION controlp INFIELD faak003
	            INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
	            LET g_qryparam.reqry = FALSE
               CALL q_faak003_1()                       #呼叫開窗
               DISPLAY g_qryparam.return1 TO faak003  #顯示到畫面上  
               NEXT FIELD faak003                     #返回原欄位 
               
            ON ACTION controlp INFIELD faak004
	            INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
	            LET g_qryparam.reqry = FALSE
               CALL q_faak004_1()                       #呼叫開窗
               DISPLAY g_qryparam.return1 TO faak004_1  #顯示到畫面上  
               NEXT FIELD faak004                       #返回原欄位
               
         END CONSTRUCT



      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG
         
      ON ACTION close
         LET g_action_choice = "exit" 
         LET INT_FLAG = 1
         EXIT DIALOG


      #查詢CONSTRUCT共用ACTION
      &include "construct_action.4gl"

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   END DIALOG
END FUNCTION]]>
  </point>
  <point name="function.afap210_create_tmp" order="2" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 臨時表
# Memo...........:
# Usage..........: CALL afap210_create_tmp()
# Input parameter:  
# Return code....:  
# Date & Author..: 2014/8/5 By 01531
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_create_tmp()
#DEFINE r_success       LIKE type_t.num5
#   
#   WHENEVER ERROR CONTINUE
#   LET r_success = FALSE
#
#   #检查事务中
#   IF NOT s_transaction_chk('N',1) THEN
#      RETURN r_success
#   END IF 
    DROP TABLE afap210_tmp;
      CREATE TEMP TABLE afap210_tmp(
     sel     LIKE type_t.chr1,
     faak000 LIKE faak_t.faak000,
     faak001 LIKE faak_t.faak001,
     faak003 LIKE faak_t.faak003,
     faak004 LIKE faak_t.faak004,
     faak019 LIKE faak_t.faak019,
     faak018 LIKE faak_t.faak018,
     faak022 LIKE faak_t.faak022,     
     produce LIKE type_t.chr1,
     pin     LIKE type_t.chr1,
     pout    LIKE type_t.chr1,  
     faah000 LIKE faah_t.faah000,
     faah002 LIKE faah_t.faah002,
     faah001 LIKE faah_t.faah001,
     faah003 LIKE faah_t.faah003,
     faah004 LIKE faah_t.faah004)
     
    DROP TABLE afap210_01_tmp;
      CREATE TEMP TABLE afap210_01_tmp(
     flag    LIKE type_t.num5,
     faak000 LIKE faak_t.faak000,
     faak001 LIKE faak_t.faak001,
     faak003 LIKE faak_t.faak003,
     faak004 LIKE faak_t.faak004,
     faak019 LIKE faak_t.faak019,
     faak018 LIKE faak_t.faak018,
     faah018 LIKE faah_t.faah018,
     faah022 LIKE faah_t.faah022,     
     faah002 LIKE faah_t.faah002,
     faah001 LIKE faah_t.faah001,
     faah003 LIKE faah_t.faah003,
     faah004 LIKE faah_t.faah004)     
    
END FUNCTION]]>
  </point>
  <point name="function.afap210_upd_tmp" order="3" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 更新tmp卡編、批號等資料
# Memo...........:
# Usage..........: CALL afap210_upd_tmp()
# Input parameter:  
# Date & Author..: 2014/8/5 By 01531
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_upd_tmp()
DEFINE  l_sql     STRING
DEFINE  l_cnt     LIKE type_t.num5
DEFINE  l_n       LIKE type_t.num5
DEFINE  l_n1      LIKE type_t.num5
DEFINE  l_faah000 LIKE faah_t.faah000
DEFINE  l_faah001 LIKE faah_t.faah001
DEFINE  l_faah003 LIKE faah_t.faah003
DEFINE  l_faah004 LIKE faah_t.faah004
DEFINE  l_faak019_1 LIKE faak_t.faak019
DEFINE  l_faak019 LIKE faak_t.faak019
DEFINE  l_faah    DYNAMIC ARRAY OF type_g_detail_d  

#   SELECT COUNT(*) INTO l_n FROM afap210_tmp WHERE sel = 'Y' AND pin = 'Y'
#   
#   LET l_faah000 = ''
#   LET l_faah001 = ''
#   LET l_faah003 = ''
#   LET l_faah004 = ''
#   LET l_faak019_1 = ''
#   LET l_faaK019 = ''
#   
#   #批號更新
#   LET g_sql = " SELECT * FROM afap210_tmp WHERE sel = 'Y' AND pin = 'Y' "
#   PREPARE afap210_tmp_pr3 FROM g_sql 
#   DECLARE afap210_tmp_cs3 CURSOR FOR afap210_tmp_pr3
#   
#
#   LET l_sql = " SELECT COUNT(*) FROM afap210_tmp ",
#               "  WHERE sel = 'Y' AND pin = 'Y' ",
#               "    AND faah003 = ? AND faah004 = ? AND faah001 = ? ",
#               "    AND faah000 IS NOT NULL"
#   PREPARE afap210_tmp_1 FROM l_sql 
#   
#   LET l_cnt = 0 
#   
#   LET l_n1 = 1
#   
#   FOREACH afap210_tmp_cs3 INTO l_faah[l_n1].* 
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = "foreach:"
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#         EXIT FOREACH
#      END IF
#
#      EXECUTE afap210_tmp_1 USING l_faah[l_n1].faah003,l_faah[l_n1].faah004,l_faah[l_n1].faah001 INTO l_cnt 
#      IF l_cnt >= 0 THEN 
#         SELECT MIN(faak000) INTO l_faah[l_n1].faah000 FROM afap210_tmp 
#          WHERE sel = 'Y' AND pin = 'Y'
#            AND faah003 = l_faah[l_n1].faah003 AND faah004 = l_faah[l_n1].faah004
#            AND faah001 = l_faah[l_n1].faah001  
#
#         UPDATE afap210_tmp SET faah000 = l_faah[l_n1].faah000
#          WHERE sel = 'Y' AND pin = 'Y'
#            AND faah003 = l_faah[l_n1].faah003 AND faah004 = l_faah[l_n1].faah004 
#            AND faah001 = l_faah[l_n1].faah001 AND faah000 IS NULL
#         IF SQLCA.sqlcode THEN
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.code = SQLCA.sqlcode
#            LET g_errparam.extend = 'update faah000 1'
#            LET g_errparam.popup = TRUE
#            CALL cl_err()                 
#         END IF     
#      END IF
#
#      LET l_n1 = l_n1 + 1
#   END FOREACH
#   
#   
#   #不同幣別，財編+附號為空
#   LET l_sql = " SELECT faah000,faah001,faah003,faah004,faak019 FROM afap210_tmp ",
#               "  WHERE sel = 'Y' AND pin = 'Y' "
#  
#   PREPARE afap210_tmp_pr1 FROM l_sql 
#   DECLARE afap210_tmp_cs1 CURSOR FOR afap210_tmp_pr1
#   
#   
#   LET l_sql = " SELECT faak019 FROM afap210_tmp ",
#               "  WHERE sel = 'Y' AND pin = 'Y' ",
#               "    AND faah003 = ? AND faah004 = ? AND faah001 = ? AND faah000 = ?"
#
#   PREPARE afap210_tmp_pr2 FROM l_sql 
#   DECLARE afap210_tmp_cs2 CURSOR FOR afap210_tmp_pr2
#   
#   FOREACH afap210_tmp_cs1 INTO l_faah000,l_faah001,l_faah003,l_faah004,l_faak019
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = "foreach cs1:"
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#         EXIT FOREACH
#      END IF 
#      
#      FOREACH afap210_tmp_cs2 USING l_faah003,l_faah004,l_faah001,l_faah000 INTO l_faak019_1
#         IF SQLCA.sqlcode THEN
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.code = SQLCA.sqlcode
#            LET g_errparam.extend = "foreach cs2:"
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
#            EXIT FOREACH
#         END IF      
#         IF l_faak019_1 != l_faak019 THEN 
#            #合併時不同幣別，財編+附號為空
#            UPDATE afap210_tmp SET faah003 = '',
#                                   faah004 = ''
#               WHERE faah003 IS NOT NULL AND faah004 IS NOT NULL
#                 AND faah003 = l_faah003 AND faah004 = l_faah004
#                 AND faak019 = l_faak019_1 AND faah000 = l_faah000                
#            IF SQLCA.sqlcode THEN
#               INITIALIZE g_errparam TO NULL
#               LET g_errparam.code = SQLCA.sqlcode
#               LET g_errparam.extend = 'update cs2'
#               LET g_errparam.popup = TRUE
#               CALL cl_err()                 
#            END IF                  
#         END IF
#      END FOREACH       
#   END FOREACH
   
   #detail array
#   LET g_sql = " SELECT * FROM afap210_tmp WHERE sel = 'Y' AND pin = 'Y' "                 #chenying mark 20141123 
   LET g_sql = " SELECT * FROM afap210_tmp WHERE sel = 'Y' AND (pin = 'Y' OR pout = 'Y' OR produce = 'Y')"   #chenying add
   
   LET g_cnt = 1 
   
   PREPARE afap210_tmp_pr FROM g_sql
   DECLARE afap210_tmp_cs CURSOR FOR afap210_tmp_pr

   FOREACH afap210_tmp_cs INTO g_tmp[g_cnt].* 
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "foreach:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF

      LET g_cnt = g_cnt + 1    
   END FOREACH
   
   CALL g_tmp.deleteElement(g_cnt)
   IF g_cnt > 1 THEN 
      CALL afap210_detail_display()
   END IF 
   IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
      RETURN
   END IF
   
   
END FUNCTION]]>
  </point>
  <point name="function.afap210_detail_display" order="4" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 单身資料顯示
# Memo...........:
# Usage..........: CALL afap210_detail_display()
# Input parameter:  
# Date & Author..: 2014/8/5 By 01531
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_detail_display()
   DISPLAY ARRAY g_tmp TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b)

      BEFORE ROW
          LET l_ac = DIALOG.getCurrentRow("s_detail1")
          LET g_detail_idx = l_ac
          DISPLAY g_detail_idx TO h_index

       BEFORE DISPLAY
          CALL cl_set_act_visible("accept,cancel", FALSE)
          CALL FGL_SET_ARR_CURR(g_detail_idx)
          LET l_ac = DIALOG.getCurrentRow("s_detail1")
          DISPLAY g_rec_b TO h_count
 
   
      ON ACTION close
         LET g_action_choice="exit"
         LET INT_FLAG=FALSE         
         EXIT DISPLAY
         
      ON ACTION exit
         LET g_action_choice="exit"
         LET INT_FLAG = FALSE
         EXIT DISPLAY
         
      ON ACTION batch_execute
         CALL afap210_process()
         EXIT DISPLAY 
   END DISPLAY    
   
END FUNCTION]]>
  </point>
  <point name="function.afap210_process" order="5" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: p處理
# Memo...........:
# Usage..........: CALL afap210_process()
# Input parameter:  
# Date & Author..: 2014/8/4 By 01531
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_process()
   DEFINE  l_success    LIKE type_t.num5
   DEFINE  l_cnt        LIKE type_t.num5  
   DEFINE  l_cnt1       LIKE type_t.num5   
   DEFINE  l_faah000    LIKE faah_t.faah000
   DEFINE  l_faah001    LIKE faah_t.faah001
   DEFINE  l_faah003    LIKE faah_t.faah003
   DEFINE  l_faah004    LIKE faah_t.faah004
   DEFINE  l_faak000    LIKE faak_t.faak000
   DEFINE  l_faak001    LIKE faak_t.faak001
   DEFINE  l_faak003    LIKE faak_t.faak003
   DEFINE  l_faak004    LIKE faak_t.faak004   
   DEFINE  l_sum        LIKE faak_t.faak022
   DEFINE  l_faak019    LIKE faak_t.faak019
   DEFINE  l_faak018    LIKE faak_t.faak018
   DEFINE  l_faah018    LIKE faah_t.faah018
   DEFINE  l_faah022    LIKE faah_t.faah022  
   DEFINE  l_faap       RECORD LIKE faap_t.*
   DEFINE  l_faah       RECORD LIKE faah_t.*
   DEFINE  l_faak       RECORD LIKE faak_t.*
   DEFINE  l_faaj014    LIKE faaj_t.faaj014
   DEFINE  l_faaj015    LIKE faaj_t.faaj015
   DEFINE  l_glaa025    LIKE glaa_t.glaa025
   DEFINE  l_faajld     LIKE faaj_t.faajld
   DEFINE  l_year       STRING
   DEFINE  l_month      STRING
   DEFINE  l_str        STRING 
   DEFINE  l_faah002    LIKE faah_t.faah002
   DEFINE  l_faai       RECORD LIKE faai_t.*
   DEFINE  l_sql        STRING 
   DEFINE  l_n          LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   
   LET l_faah000 = ''
   LET l_faah001 = ''
   LET l_faah003 = ''
   LET l_faah004 = ''
   LET l_faak000 = ''
   LET l_faak001 = ''
   LET l_faak003 = ''
   LET l_faak004 = ''   
   LET l_faak018 = 0
   LET l_faak019 = ''   
   LET l_sum = 0
 
   
   CALL cl_showmsg_init()  
   LET l_success=TRUE
   CALL s_transaction_begin()
   
   LET g_sql = " SELECT faah000,faah001,faah002,faah003,faah004,faak019,SUM(faak018),SUM(faak022) ",
               "   FROM afap210_tmp ",
               "  WHERE sel = 'Y' AND (pin = 'Y' OR produce = 'Y')",
               "  GROUP BY faah000,faah001,faah002,faah003,faah004,faak019  ",
               "  ORDER BY faah000,faah001,faah002,faah003,faah004,faak019  "

   PREPARE afap210_pre_1 FROM g_sql
   DECLARE afap210_cs_1 CURSOR FOR afap210_pre_1
   
   
   LET g_sql = " SELECT faak000,faak001,faak003,faak004,faah001,faah002,faah003,faah004,faak019,faah018,faah022  ",
               "   FROM afap210_01_tmp "         

   PREPARE afap210_pre_2 FROM g_sql
   DECLARE afap210_cs_2 CURSOR FOR afap210_pre_2
   
   
   LET g_sql = " SELECT faak000,faak001,faak003,faak004 ",
               "   FROM afap210_tmp ",
               "  WHERE sel = 'Y' AND (pin = 'Y' OR produce = 'Y') ",   #20150210 add produce = 'Y'                          
               "    AND faah003 = ? AND faah004 = ? "

   PREPARE afap210_pre_3 FROM g_sql
   DECLARE afap210_cs_3 CURSOR FOR afap210_pre_3        
   
      
   #合併
   LET l_cnt = 0 
   SELECT COUNT(*) INTO l_cnt FROM afap210_tmp
    WHERE sel = 'Y' 
      AND (pin = 'Y' OR produce = 'Y') 
   INITIALIZE l_faah.* TO NULL
   INITIALIZE l_faak.* TO NULL
   IF l_cnt > 0 THEN 
      FOREACH afap210_cs_1 INTO l_faah000,l_faah001,l_faah002,l_faah003,l_faah004,l_faak019,l_faak018,l_sum 
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "foreach cs_1:"
            LET g_errparam.popup = TRUE
            CALL cl_err()
            EXIT FOREACH
         END IF
      
         IF cl_null(l_faah004) THEN LET l_faah004 = ' '  END IF 
         SELECT faak000,faak001,faak003,faak004
           INTO l_faak000,l_faak001,l_faak003,l_faak004
           FROM afap210_tmp
          WHERE faah003 = l_faah003
            AND faah004 = l_faah004
         SELECT * INTO l_faak.*
           FROM faak_t
          WHERE faakent = g_enterprise
            AND faak000 = l_faak000
            AND faak001 = l_faak001
            AND faak003 = l_faak003
            AND faak004 = l_faak004
         LET l_faah.faahent = g_enterprise
         IF g_para_data = 'Y' THEN
            SELECT lpad((MAX(faah001) + 1),10,'0') INTO l_faah.faah001
              FROM faah_t
             WHERE faahent = g_enterprise

            IF cl_null(l_faah.faah001) THEN
               SELECT lpad(1,10,'0') INTO l_faah.faah001
                 FROM faah_t
                WHERE faahent = g_enterprise
            END IF
         ELSE
            LET l_faah.faah001 = l_faah001
         END IF
         IF g_para_data2 = 'Y' AND l_faah.faah002 = '1' THEN          
            LET l_faah.faah003 = l_faah.faah001
         END IF
         LET l_year = YEAR(g_today)
         LET l_month = MONTH(g_today)
         IF l_month < 10 THEN
            LET l_month = '0' CLIPPED,l_month
         END IF
         LET l_str = l_year CLIPPED,l_month
         LET g_sql = "SELECT MAX(faah000) ",
                     "  FROM faah_t ",
                     " WHERE faahent = '",g_enterprise,"'",
                     "   AND faah000 LIKE '",l_str,"%'"
         PREPARE faah000_pre FROM g_sql
         EXECUTE faah000_pre INTO l_faah000
         IF cl_null(l_faah000) THEN
            LET l_faah.faah000 = l_str,'0001'
         ELSE
            LET g_sql = "SELECT lpad((lpad((substr(MAX(faah000),7,10) + 1),4,'0')),10,'",l_str,"')",
                        "  FROM faah_t ",
                        " WHERE faahent = '",g_enterprise,"'",
                        "   AND faah000 LIKE '",l_str,"%'"
            PREPARE faah000_pre1 FROM g_sql
            EXECUTE faah000_pre1 INTO l_faah.faah000
         END IF
         
         LET l_faah.faah002 = l_faah002
         LET l_faah.faah003 = l_faah003
         LET l_faah.faah004 = l_faah004
         LET l_faah.faah005 = l_faak.faak005
         LET l_faah.faah006 = l_faak.faak006
         LET l_faah.faah007 = l_faak.faak007
         LET l_faah.faah008 = l_faak.faak008
         LET l_faah.faah009 = l_faak.faak009
         LET l_faah.faah010 = l_faak.faak010
         LET l_faah.faah011 = l_faak.faak011
         LET l_faah.faah012 = l_faak.faak012
         LET l_faah.faah013 = l_faak.faak013
#         LET l_faah.faah014 = l_faak.faak014  #chenying mark 20141124
         LET l_faah.faah014 = g_today          #chenying add
         LET l_faah.faah015 = l_faak.faak015
         LET l_faah.faah016 = l_faak.faak016
         LET l_faah.faah017 = l_faak.faak017
         LET l_faah.faah018 = l_faak018
         LET l_faah.faah019 = 0
         LET l_faah.faah020 = l_faak.faak019
         LET l_faah.faah021 = l_faak.faak021
         LET l_faah.faah022 = l_sum
         #根据归属法人获取对应主帐套
         SELECT UNIQUE glaald INTO l_faajld FROM glaa_t WHERE glaaent=g_enterprise AND glaacomp=l_faak.faak032 AND glaa014='Y'
         IF cl_null(l_faajld) THEN LET l_faajld=' ' END IF
         #获取帐套使用主本币
         SELECT glaa001,glaa025 INTO l_faaj014,l_glaa025 FROM glaa_t WHERE glaald=l_faajld AND glaaent=g_enterprise   
         #获取当前汇率
         CALL s_aooi160_get_exrate('2',l_faajld,g_today,l_faah.faah020,
                                         #目的幣別          #匯類類型
                                         l_faaj014,0,l_glaa025) RETURNING l_faaj015 
         LET l_faah.faah023 = l_faah.faah021 * l_faaj015
         LET l_faah.faah024 = l_faah.faah018 * l_faah.faah023
         LET l_faah.faah025 = l_faak.faak025
         LET l_faah.faah026 = l_faak.faak026
         LET l_faah.faah027 = l_faak.faak027
         LET l_faah.faah028 = l_faak.faak028
         LET l_faah.faah029 = l_faak.faak029
         LET l_faah.faah030 = l_faak.faak030
         LET l_faah.faah031 = l_faak.faak031
         LET l_faah.faah032 = l_faak.faak032
         SELECT faac007
           INTO l_faah.faah033
           FROM faac_t
           WHERE faacent = g_enterprise
           AND faac001 = l_faah.faah006 
         IF cl_null(l_faah.faah033) THEN 
            LET l_faah.faah033 = 'Y'
         END IF 
         LET l_faah.faah034 = l_faak.faak035
         LET l_faah.faah035 = l_faak.faak036
         LET l_faah.faah036 = l_faak.faak037
         LET l_faah.faah037 = l_faak.faak038
         LET l_faah.faah041 = l_faak.faak042
         LET l_faah.faah042 = l_faak.faak049
         LET l_faah.faahownid = g_user
         LET l_faah.faahowndp = g_dept
         LET l_faah.faahcrtid = g_user
         LET l_faah.faahcrtdp = g_dept
         LET l_faah.faahcrtdt = g_today
         LET l_faah.faahmodid = ''
         LET l_faah.faahmoddt = ''
         LET l_faah.faahstus = 'N'
         
         CALL s_aooi390_oofi_upd('3',l_faah.faah003) RETURNING l_success  #add--2015/05/07 By shiun
         INSERT INTO faah_t VALUES(l_faah.*)
#         INSERT INTO faah_t(faahent,faah000,faah001,faah003,faah004,faah020,faah018,faah022,faahstus,
#         faah014,faah015,faah025,faah026,faah028,faah029,faah030,faah031,faah032,faahownid,faahowndp,faahcrtid,faahcrtdp,faahcrtdt) 
#            VALUES(g_enterprise,l_faah000,l_faah001,l_faah003,l_faah004,l_faak019,l_faak018,l_sum,'N',
#            g_today,'0',g_user,g_dept,g_dept,g_user,g_dept,g_dept,g_dept,g_user,g_dept,g_user,g_dept,g_today) 
         
#         IF SQLCA.sqlcode THEN  #chenying mark  #20141123
         IF SQLCA.sqlcode OR SQLCA.sqlcode = 100 THEN   #chenying add 
            LET l_success = FALSE
            CALL cl_errmsg('ins faah',l_faah001,'N',sqlca.sqlcode,1)
         END IF
         
         #yangtt---2015/6/9--
         #標籤明細,如果底稿中有標籤明細，則插入
         SELECT COUNT(*) INTO l_n FROM faai_t WHERE faaient = g_enterprise
           AND faai000 = l_faak000 AND faai001 = l_faak001
           AND faai002 = l_faak003 AND faai003 = l_faak004
         IF l_n > 0 THEN
            LET l_sql = " SELECT *  FROM faai_t ",
                        "   WHERE faaient = ",g_enterprise,
                         "    AND faai000 = '",l_faak000,"' AND faai001 = '",l_faak001,"'",
                         "    AND faai002 = '",l_faak003,"' AND faai003 = '",l_faak004,"'"
            PREPARE faai_prep FROM l_sql
            DECLARE faai_curs CURSOR FOR faai_prep
            
            FOREACH faai_curs INTO l_faai.*
               LET l_faai.faai000 = l_faah.faah000
               LET l_faai.faai001 = l_faah.faah001
               LET l_faai.faai002 = l_faah.faah003
               LET l_faai.faai003 = l_faah.faah004
               
               INSERT INTO faai_t
                        (faaient,
                         faai000,faai001,faai002,faai003,
                         faaiseq
                         ,faai004,faai012,faai013,faai005,faai006,faai007,faai008,faai010,faai009,faai014,faai015,faai016,faai017,faai018,faai019,faai020,faai021,faai022,faai023) 
                  VALUES(g_enterprise,
                         l_faai.faai000,l_faai.faai001,l_faai.faai002,l_faai.faai003,l_faai.faaiseq,
                         l_faai.faai004,l_faai.faai012,l_faai.faai013, 
                         l_faai.faai005,l_faai.faai006,l_faai.faai007, 
                         l_faai.faai008,l_faai.faai010,l_faai.faai009, 
                         l_faai.faai014,l_faai.faai015,l_faai.faai016, 
                         l_faai.faai017,l_faai.faai018,l_faai.faai019, 
                         l_faai.faai020,l_faai.faai021,l_faai.faai022, 
                         l_faai.faai023)
               
               IF SQLCA.sqlcode OR SQLCA.sqlcode = 100 THEN
                  LET l_success = FALSE
                  CALL cl_errmsg('ins faai',l_faah001,'N',sqlca.sqlcode,1)
               END IF

            END FOREACH
        END IF
        #yangtt---2015/6/9--
            
            
         FOREACH afap210_cs_3 USING l_faah003,l_faah004 
            INTO l_faak000,l_faak001,l_faak003,l_faak004
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "foreach cs_3:"
               LET g_errparam.popup = TRUE
               CALL cl_err()
               EXIT FOREACH
            END IF  

            LET l_faap.faapownid = g_user
            LET l_faap.faapowndp = g_dept
            LET l_faap.faapcrtid = g_user
            LET l_faap.faapcrtdp = g_dept 
            LET l_faap.faapcrtdt = cl_get_current()
            LET l_faap.faapmodid = ""
            LET l_faap.faapmoddt = ""
         IF cl_null(l_faak004) THEN LET l_faak004 = ' ' END IF  #chenying add 20141123  
         IF cl_null(l_faah004) THEN LET l_faah004 = ' ' END IF  #chenying add 20141123              
         
            INSERT INTO faap_t(faapent,faap000,faap001,faap002,faap003,faap006,faap007,faap008,faap009,
                               faapownid,faapowndp,faapcrtid,faapcrtdp,faapcrtdt,faapmodid,faapmoddt,faapstus)
                        VALUES(g_enterprise,l_faak000,l_faak001,l_faak003,l_faak004,l_faah.faah000,l_faah.faah001,l_faah003,l_faah004,
                               l_faap.faapownid,l_faap.faapowndp,l_faap.faapcrtid,l_faap.faapcrtdp,l_faap.faapcrtdt,l_faap.faapmodid,
                               l_faap.faapmoddt,'Y')
            IF SQLCA.sqlcode THEN
               LET l_success = FALSE
               CALL cl_errmsg('ins faap',l_faah001,'N',sqlca.sqlcode,1)
            END IF 
            UPDATE faak_t SET faak043 = 'Y'
                        WHERE faakent = g_enterprise
                          AND faak000 = l_faak000
                          AND faak001 = l_faak001
                          AND faak003 = l_faak003
                          AND faak004 = l_faak004
                          AND faak043 = 'N'
            IF SQLCA.sqlcode THEN
               LET l_success = FALSE
               CALL cl_errmsg('upd faak',l_faak001,'N',sqlca.sqlcode,1)
            END IF                           
          END FOREACH            
          CALL afap210_get_deault_value(l_faak000,l_faak001,l_faak003,l_faak004,l_faah.faah000,l_faah.faah001,l_faah003,l_faah004)
       END FOREACH         
   END IF   
   
   #分割 
   LET l_cnt1 = 0

   LET l_faah000 = ''
   LET l_faah001 = ''
   LET l_faah003 = ''
   LET l_faah004 = ''
   LET l_faah018 = 0
   LET l_faak019 = '' 
   LET l_faah022 = 0
   
   SELECT COUNT(*) INTO l_cnt1 FROM afap210_01_tmp
   INITIALIZE l_faah.* TO NULL
   INITIALIZE l_faak.* TO NULL
   IF l_cnt1 > 0 THEN 
      FOREACH afap210_cs_2 INTO l_faak000,l_faak001,l_faak003,l_faak004,l_faah001,l_faah002,l_faah003,l_faah004,l_faak019,l_faah018,l_faah022
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "foreach cs_2:"
            LET g_errparam.popup = TRUE
            CALL cl_err()
            EXIT FOREACH
         END IF      
         SELECT * INTO l_faak.*
           FROM faak_t
          WHERE faakent = g_enterprise
            AND faak000 = l_faak000
            AND faak001 = l_faak001
            AND faak003 = l_faak003
            AND faak004 = l_faak004         
         LET l_faah.faahent = g_enterprise
         IF g_para_data = 'Y' THEN
            SELECT lpad((MAX(faah001) + 1),10,'0') INTO l_faah.faah001
              FROM faah_t
             WHERE faahent = g_enterprise

            IF cl_null(l_faah.faah001) THEN
               SELECT lpad(1,10,'0') INTO l_faah.faah001
                 FROM faah_t
                WHERE faahent = g_enterprise
            END IF
         ELSE
            LET l_faah.faah001 = l_faah001
         END IF
         IF g_para_data2 = 'Y' AND l_faah.faah002 = '1' THEN          
            LET l_faah.faah003 = l_faah.faah001
         END IF
         LET l_year = YEAR(g_today)
         LET l_month = MONTH(g_today)
         IF l_month < 10 THEN
            LET l_month = '0' CLIPPED,l_month
         END IF
         LET l_str = l_year CLIPPED,l_month
         LET g_sql = "SELECT MAX(faah000) ",
                     "  FROM faah_t ",
                     " WHERE faahent = '",g_enterprise,"'",
                     "   AND faah000 LIKE '",l_str,"%'"
         PREPARE faah000_pre2 FROM g_sql
         EXECUTE faah000_pre2 INTO l_faah000
         IF cl_null(l_faah000) THEN
            LET l_faah.faah000 = l_str,'0001'
         ELSE
            LET g_sql = "SELECT lpad((lpad((substr(MAX(faah000),7,10) + 1),4,'0')),10,'",l_str,"')",
                        "  FROM faah_t ",
                        " WHERE faahent = '",g_enterprise,"'",
                        "   AND faah000 LIKE '",l_str,"%'"
            PREPARE faah000_pre3 FROM g_sql
            EXECUTE faah000_pre3 INTO l_faah.faah000
         END IF
         LET l_faah.faah002 = l_faah002
         LET l_faah.faah003 = l_faah003
         IF cl_null(l_faah004) THEN LET l_faah004=' ' END IF
         LET l_faah.faah004 = l_faah004
         LET l_faah.faah005 = l_faak.faak005
         LET l_faah.faah006 = l_faak.faak006
         LET l_faah.faah007 = l_faak.faak007
         LET l_faah.faah008 = l_faak.faak008
         LET l_faah.faah009 = l_faak.faak009
         LET l_faah.faah010 = l_faak.faak010
         LET l_faah.faah011 = l_faak.faak011
         LET l_faah.faah012 = l_faak.faak012
         LET l_faah.faah013 = l_faak.faak013
#         LET l_faah.faah014 = l_faak.faak014  #chenying mark 20141124
         LET l_faah.faah014 = g_today          #chenying add         
         LET l_faah.faah015 = l_faak.faak015
         LET l_faah.faah016 = l_faak.faak016
         LET l_faah.faah017 = l_faak.faak017
         LET l_faah.faah018 = l_faah018
         LET l_faah.faah019 = 0
         LET l_faah.faah020 = l_faak019
         LET l_faah.faah021 = l_faak.faak021
         LET l_faah.faah022 = l_faah022
         LET l_faah.faah023 = l_faak.faak023
         LET l_faah.faah024 = l_faak.faak024
         LET l_faah.faah025 = l_faak.faak025
         LET l_faah.faah026 = l_faak.faak026
         LET l_faah.faah027 = l_faak.faak027
         LET l_faah.faah028 = l_faak.faak028
         LET l_faah.faah029 = l_faak.faak029
         LET l_faah.faah030 = l_faak.faak030
         LET l_faah.faah031 = l_faak.faak031
         LET l_faah.faah032 = l_faak.faak032
         LET l_faah.faah033 = l_faak.faak033
         LET l_faah.faah034 = l_faak.faak035
         LET l_faah.faah035 = l_faak.faak036
         LET l_faah.faah036 = l_faak.faak037
         LET l_faah.faah037 = l_faak.faak038
         LET l_faah.faah041 = l_faak.faak042
         LET l_faah.faahownid = g_user
         LET l_faah.faahowndp = g_dept
         LET l_faah.faahcrtid = g_user
         LET l_faah.faahcrtdp = g_dept
         LET l_faah.faahcrtdt = g_today
         LET l_faah.faahmodid = ''
         LET l_faah.faahmoddt = ''
         LET l_faah.faahstus = 'N'

         CALL s_aooi390_oofi_upd('3',l_faah.faah003) RETURNING l_success  #add--2015/05/07 By shiun
         INSERT INTO faah_t VALUES(l_faah.*)
#         INSERT INTO faah_t(faahent,faah000,faah001,faah003,faah004,faah020,faah018,faah022,faahstus,
#          faah014,faah015,faah025,faah026,faah028,faah029,faah030,faah031,faah032,faahownid,faahowndp,faahcrtid,faahcrtdp,faahcrtdt) 
#            VALUES(g_enterprise,l_faah000,l_faah001,l_faah003,l_faah004,l_faak019,l_faah018,l_faah022,'N',
#            g_today,'0',g_user,g_dept,g_dept,g_user,g_dept,g_dept,g_dept,g_user,g_dept,g_user,g_dept,g_today) 
         
#         IF SQLCA.sqlcode THEN                         #cheniyng mark
          IF SQLCA.sqlcode OR SQLCA.sqlcode = 100 THEN  #chenying add 20141123
            LET l_success = FALSE
            CALL cl_errmsg('ins faah 1',l_faah001,'N',sqlca.sqlcode,1)
         END IF

         LET l_faap.faapownid = g_user
         LET l_faap.faapowndp = g_dept
         LET l_faap.faapcrtid = g_user
         LET l_faap.faapcrtdp = g_dept 
         LET l_faap.faapcrtdt = cl_get_current()
         LET l_faap.faapmodid = ""
         LET l_faap.faapmoddt = ""
         
         IF cl_null(l_faak004) THEN LET l_faak004 = ' ' END IF  #chenying add 20141123  
         IF cl_null(l_faah004) THEN LET l_faah004 = ' ' END IF  #chenying add 20141123    
         INSERT INTO faap_t(faapent,faap000,faap001,faap002,faap003,faap006,faap007,faap008,faap009,
                            faapownid,faapowndp,faapcrtid,faapcrtdp,faapcrtdt,faapmodid,faapmoddt,faapstus)
                     VALUES(g_enterprise,l_faak000,l_faak001,l_faak003,l_faak004,l_faah.faah000,l_faah.faah001,l_faah003,l_faah004,
                            l_faap.faapownid,l_faap.faapowndp,l_faap.faapcrtid,l_faap.faapcrtdp,l_faap.faapcrtdt,l_faap.faapmodid,
                            l_faap.faapmoddt,'Y')
         IF SQLCA.sqlcode THEN
            LET l_success = FALSE
            CALL cl_errmsg('ins faap',l_faah001,'N',sqlca.sqlcode,1)
         END IF  
         CALL afap210_get_deault_value(l_faak000,l_faak001,l_faak003,l_faak004,l_faah.faah000,l_faah.faah001,l_faah003,l_faah004)
         UPDATE faak_t SET faak043 = 'Y'
                     WHERE faakent = g_enterprise
                       AND faak000 = l_faak000
                       AND faak001 = l_faak001
                       AND faak003 = l_faak003
                       AND faak004 = l_faak004
                       AND faak043 = 'N'
         IF SQLCA.sqlcode THEN
            LET l_success = FALSE
            CALL cl_errmsg('upd faak',l_faak001,'N',sqlca.sqlcode,1)
         END IF 
            
      END FOREACH           
   END IF 
   
   IF l_success = FALSE  THEN
      CALL cl_err_showmsg()
      CALL s_transaction_end('N','0') 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'adz-00218'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN    
   ELSE
      CALL s_transaction_end('Y','0')
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'adz-00217'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()      
   END IF 
END FUNCTION]]>
  </point>
  <point name="function.afap210_01_ins" order="6" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 分割資料新增tmp
# Memo...........:
# Usage..........: CALL afap210_01_ins(p_faak000,p_faak001,p_faak003,p_faak004,p_faak019,p_faak018)
# Input parameter:  
# Date & Author..: 2014/8/6 By 01531
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_01_ins(p_faak000,p_faak001,p_faak003,p_faak004,p_faak019,p_faak018)
DEFINE p_faak000 LIKE faak_t.faak000
DEFINE p_faak001 LIKE faak_t.faak001
DEFINE p_faak003 LIKE faak_t.faak003
DEFINE p_faak004 LIKE faak_t.faak004
DEFINE p_faak019 LIKE faak_t.faak019
DEFINE p_faak018 LIKE faak_t.faak018
DEFINE i         LIKE type_t.num5
DEFINE l_faak022 LIKE faak_t.faak022
DEFINE l_faah018 LIKE faah_t.faah018
DEFINE l_faah022 LIKE faah_t.faah022
DEFINE l_faak022_1 LIKE faak_t.faak022
DEFINE l_faah022_t LIKE faah_t.faah022
DEFINE l_faah001  LIKE faah_t.faah001

   LET l_faak022 = 0
   LET l_faah022 = 0
   LET l_faah018 = 0
   LET l_faak022_1 = 0
   LET l_faah001 = ''
   
#   LET l_faah022_t = p_faak018 - l_faah022
   
   #删除临时表已存在的资料
   DELETE FROM afap210_01_tmp
    WHERE faak000 = p_faak000
      AND faak001 = p_faak001
      AND faak003 = p_faak003
      AND faak004 = p_faak004
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DEL afap210_01_tmp"
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN
   END IF
   CALL afap210_get_faah001() RETURNING l_faah001
    
   SELECT faak022 INTO l_faak022 FROM faak_t 
    WHERE faakent = g_enterprise
      AND faakstus = 'Y' AND faak043 = 'N' 
      AND faak000 = p_faak000
      AND faak001 = p_faak001
      AND faak003 = p_faak003
      AND faak004 = p_faak004
      
   LET l_faah022_t = l_faak022 #20141123 chenying add #总金额备份 
      
   IF p_faak018 = 0 THEN
      LET l_faah018 = 1
      LET l_faah022 = l_faak022
      LET l_faah001 = l_faah001+1 USING '&&&&&&&&&&' 
      INSERT INTO afap210_01_tmp VALUES(1,'Y',p_faak000,p_faak001,p_faak003,p_faak004,p_faak019,p_faak018,'N','Y',
                                         1,l_faah022,p_faak000,l_faah001,'',' ')
                                         
   ELSE   
      LET l_faak022_1 = l_faak022 / p_faak018      
#      LET l_faah022_t = l_faak022  #chenying mark
      FOR i = 1 TO p_faak018
          LET l_faah018 = 1
          LET l_faah022 = s_num_round('3',l_faak022_1,0) 
          
          IF i = p_faak018 THEN 
#             LET l_faah022 = l_faah022_t - (i-1)*l_faak022_1 #20141123 chenying mark
             LET l_faah022 = l_faak022 - (i-1)*l_faak022_1  #20141123 chenying add #用总金额去减
             LET l_faah022 = s_num_round('3',l_faah022,0) 
          ELSE
#             LET l_faah022_t = l_faah022_t - l_faah022
             LET l_faah022_t = l_faah022_t - l_faah022  #20141123 chenying add #循环得到剩余金额    
          END IF  
 
          LET l_faah001 = l_faah001+1 USING '&&&&&&&&&&'
          INSERT INTO afap210_01_tmp VALUES(i,'Y',p_faak000,p_faak001,p_faak003,p_faak004,p_faak019,p_faak018,'N','Y',
                                             l_faah018,l_faah022,p_faak000,l_faah001,'',' ')
      END FOR
   END IF    

END FUNCTION]]>
  </point>
  <point name="function.afap210_get_faah001" order="7" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 卡片編號
# Memo...........:
# Usage..........: CALL afap210_get_faah001()
# Input parameter:  
# Date & Author..: 2014/8/6 By 01531
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_get_faah001()
   DEFINE l_ooab002     LIKE ooab_t.ooab002
   DEFINE l_max_faah001 LIKE faah_t.faah001
   DEFINE l_faah001     LIKE faah_t.faah001
   DEFINE l_faah001_1   LIKE faah_t.faah001

    #檢查tmp中是否存在已有最大的卡片編號
    #是否自動編號 S-FIN-9005
#    SELECT ooab002 INTO l_ooab002 FROM ooab_t
#     WHERE ooabent = g_enterprise
#       AND ooab001 = 'S-FIN-9005'
#       AND ooabsite = g_site

    SELECT lpad((MAX(faah001) + 1),10,'0') INTO l_max_faah001 FROM afap210_tmp
    SELECT lpad((MAX(faah001) + 1),10,'0') INTO l_faah001_1 FROM afap210_01_tmp

    IF l_max_faah001 IS NULL AND l_faah001_1 IS NULL THEN
       SELECT lpad((MAX(faah001) + 1),10,'0') INTO l_max_faah001
         FROM faah_t
        WHERE faahent = g_enterprise
        LET l_faah001 = l_max_faah001
    ELSE
       IF l_max_faah001 IS NULL AND l_faah001_1 IS NOT NULL THEN
          LET l_faah001 = l_faah001_1
       END IF
       IF l_max_faah001 IS NOT NULL AND l_faah001_1 IS NULL THEN
          LET l_faah001 = l_max_faah001
       END IF
       IF l_max_faah001 IS NOT NULL AND l_faah001_1 IS NOT NULL THEN
          IF l_max_faah001 > l_faah001_1 THEN
             LET l_faah001 = l_max_faah001
          ELSE
             LET l_faah001 = l_faah001_1
          END IF
       END IF
    END IF
    IF cl_null(l_faah001) THEN 
       SELECT lpad(1,10,'0') INTO l_faah001
         FROM faah_t
        WHERE faahent = g_enterprise
    END IF 
    RETURN l_faah001
END FUNCTION]]>
  </point>
  <point name="function.afap210_ui_dialog_1" order="8" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...:  
# Memo...........:
# Usage..........: CALL afap210_ui_dialog_1()
# Input parameter:  
# Date & Author..: 2014/08/29 By 01531
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_ui_dialog_1()
   DEFINE li_idx   LIKE type_t.num5
   #add-point:ui_dialog段define
   DEFINE l_ooab002     LIKE ooab_t.ooab002
   DEFINE l_max_faah001 LIKE faah_t.faah001
   DEFINE l_cnt         LIKE type_t.num5 
   DEFINE l_n           LIKE type_t.num5
   DEFINE l_faah001     LIKE faah_t.faah001
   DEFINE l_c           LIKE type_t.num5
   #end add-point 
 
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   CALL afap210_create_tmp()
   
   
   WHILE TRUE
      CALL g_detail_d.clear()
      CALL cl_dlg_query_bef_disp()  #相關查詢
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
               
         #end add-point
         #add-point:ui_dialog段input
         INPUT ARRAY g_detail_d FROM s_detail1.*
            ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                      INSERT ROW = FALSE, 
                      DELETE ROW = FALSE,
                      APPEND ROW = TRUE)
                    
            BEFORE INPUT

            BEFORE ROW
                         
                LET l_ac = ARR_CURR()
               
            
               
            ON CHANGE sel
           
               IF g_detail_d[l_ac].sel = 'Y' THEN 
                  UPDATE afap210_tmp SET sel = 'Y' 
                   WHERE faak000 = g_detail_d[l_ac].faak000
                     AND faak001 = g_detail_d[l_ac].faak001
                     AND faak003 = g_detail_d[l_ac].faak003
                     AND faak004 = g_detail_d[l_ac].faak004
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.extend = "UPD afap210_tmp"
                     LET g_errparam.code   = SQLCA.sqlcode
                     LET g_errparam.popup  = TRUE
                     CALL cl_err()
                     LET g_detail_d[l_ac].sel = 'N'
                     NEXT FIELD sel
                  END IF
               ELSE        
                  #存在分割或合并               
                  IF g_detail_d[l_ac].out = 'Y' OR g_detail_d[l_ac].in = 'Y' OR g_detail_d[l_ac].produce = 'Y' THEN 
                     IF NOT cl_ask_confirm('afa-00330') THEN
                        LET g_detail_d[l_ac].sel = 'Y'
                        NEXT FIELD sel
                     END IF
                     #單筆產生                   
                     IF g_detail_d[l_ac].produce = 'Y' THEN                      
                        UPDATE afap210_tmp SET sel = 'N',
                                               faah002 = '',
                                               faah001 = '',
                                               faah003 = '',
                                               faah004 = '',
                                               produce = 'N'
                         WHERE faak003 = g_detail_d[l_ac].faak003
                           AND faak004 = g_detail_d[l_ac].faak004
                           AND faak001 = g_detail_d[l_ac].faak001
                           AND produce = 'Y'
                         IF SQLCA.sqlcode THEN
                            INITIALIZE g_errparam TO NULL
                            LET g_errparam.extend = "UPD afap210_tmp"
                            LET g_errparam.code   = SQLCA.sqlcode
                            LET g_errparam.popup  = TRUE
                            CALL cl_err()
                            LET g_detail_d[l_ac].sel = 'Y'
                            NEXT FIELD sel
                         END IF
                     END IF 
                     #合并                     
                     IF g_detail_d[l_ac].in = 'Y' THEN
                        UPDATE afap210_tmp SET sel = 'N',
                                               faah002 = '',
                                               faah001 = '',
                                               faah003 = '',
                                               faah004 = '',
                                               pin = 'N'
                         WHERE faah003 = g_detail_d[l_ac].faah003
                           AND faah004 = g_detail_d[l_ac].faah004
                           AND pin = 'Y'
                         IF SQLCA.sqlcode THEN
                            INITIALIZE g_errparam TO NULL
                            LET g_errparam.extend = "UPD afap210_tmp"
                            LET g_errparam.code   = SQLCA.sqlcode
                            LET g_errparam.popup  = TRUE
                            CALL cl_err()
                            LET g_detail_d[l_ac].sel = 'Y'
                            NEXT FIELD sel
                         END IF
                     END IF 
                     #分割
                     IF g_detail_d[l_ac].out = 'Y' THEN 
                        UPDATE afap210_tmp SET sel = 'N',
                                               faah002 = '',
                                               faah001 = '',
                                               faah003 = '',
                                               faah004 = '',
                                               pout = 'N'
                         WHERE faak001 = g_detail_d[l_ac].faak001
                           AND faak003 = g_detail_d[l_ac].faak003
                           AND faak004 = g_detail_d[l_ac].faak004
                           AND pout = 'Y'
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.extend = "UPD afap210_tmp"
                           LET g_errparam.code   = SQLCA.sqlcode
                           LET g_errparam.popup  = TRUE
                           CALL cl_err()
                           LET g_detail_d[l_ac].sel = 'Y'
                           NEXT FIELD sel
                        END IF
                        #删除临时表已存在的资料
                        DELETE FROM afap210_01_tmp
                         WHERE faak000 = g_detail_d[l_ac].faak000
                           AND faak001 = g_detail_d[l_ac].faak001
                           AND faak003 = g_detail_d[l_ac].faak003
                           AND faak004 = g_detail_d[l_ac].faak004
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.extend = "DEL afap210_01_tmp"
                           LET g_errparam.code   = SQLCA.sqlcode
                           LET g_errparam.popup  = TRUE
                           CALL cl_err()
                           LET g_detail_d[l_ac].sel = 'Y'
                           NEXT FIELD sel
                        END IF
                     END IF 
                  #不存在合并或分割
                  ELSE
                     UPDATE afap210_tmp SET sel = 'N' 
                      WHERE faak000 = g_detail_d[l_ac].faak000
                        AND faak001 = g_detail_d[l_ac].faak001
                        AND faak003 = g_detail_d[l_ac].faak003
                        AND faak004 = g_detail_d[l_ac].faak004  
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.extend = "UPD afap210_tmp"
                        LET g_errparam.code   = SQLCA.sqlcode
                        LET g_errparam.popup  = TRUE
                        CALL cl_err()
                        LET g_detail_d[l_ac].sel = 'Y'
                        NEXT FIELD sel
                     END IF
                  END IF 
                  LET g_detail_d[l_ac].faah001 = ''
                  LET g_detail_d[l_ac].faah002 = ''
                  LET g_detail_d[l_ac].faah003 = ''
                  LET g_detail_d[l_ac].faah004 = ''
                  LET g_detail_d[l_ac].out ='N'
                  LET g_detail_d[l_ac].in = 'N'
                  LET g_detail_d[l_ac].produce = 'N'
               END IF 
               CALL afap210_display()
               
            AFTER INPUT
               CALL afap210_query()
              
         END INPUT             
         #end add-point
         #add-point:ui_dialog段自定義display array
     
         #end add-point
 
       #  SUBDIALOG lib_cl_dlg.cl_dlg_qryplan
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            CALL afap210_construct()
   
            IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
               EXIT WHILE
            END IF
   
            CALL afap210_b_fill()
  
            #end add-point
 
         #選擇全部
#         ON ACTION selall
#            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
#            FOR li_idx = 1 TO g_detail_d.getLength()
#               LET g_detail_d[li_idx].sel = "Y"
#               #add-point:ui_dialog段on action selall
#
#               #end add-point
#            END FOR
#            #add-point:ui_dialog段on action selall
#            UPDATE afap210_tmp SET sel = 'Y'
#            IF SQLCA.sqlcode THEN
#               INITIALIZE g_errparam TO NULL
#               LET g_errparam.code = SQLCA.sqlcode
#               LET g_errparam.extend = 'update 4'
#               LET g_errparam.popup = TRUE
#               CALL cl_err()                 
#            END IF            
 
            #end add-point
 
#         #取消全部
#         ON ACTION selnone
#            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
#            FOR li_idx = 1 TO g_detail_d.getLength()
#               LET g_detail_d[li_idx].sel = "N"
#               #add-point:ui_dialog段on action selnone
#
#               #end add-point
#            END FOR
#            #add-point:ui_dialog段on action selnone
#            UPDATE afap210_tmp SET sel = 'N'
#            IF SQLCA.sqlcode THEN
#               INITIALIZE g_errparam TO NULL
#               LET g_errparam.code = SQLCA.sqlcode
#               LET g_errparam.extend = 'update 5'
#               LET g_errparam.popup = TRUE
#               CALL cl_err()                 
#            END IF   
            #end add-point
 
#         #勾選所選資料
#         ON ACTION sel
#            FOR li_idx = 1 TO g_detail_d.getLength()
#               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
#                  LET g_detail_d[li_idx].sel = "Y"
#               END IF
#            END FOR
#            #add-point:ui_dialog段on action sel
#            UPDATE afap210_tmp SET sel = 'Y' 
#             WHERE faak000 = g_detail_d[l_ac].faak000
#               AND faak001 = g_detail_d[l_ac].faak001
#               AND faak003 = g_detail_d[l_ac].faak003
#               AND faak004 = g_detail_d[l_ac].faak004
#
#            IF SQLCA.sqlcode THEN
#               INITIALIZE g_errparam TO NULL
#               LET g_errparam.code = SQLCA.sqlcode
#               LET g_errparam.extend = 'update 6'
#               LET g_errparam.popup = TRUE
#               CALL cl_err()                 
#            END IF
            #end add-point
 
         #取消所選資料
#         ON ACTION unsel
#            FOR li_idx = 1 TO g_detail_d.getLength()
#               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
#                  LET g_detail_d[li_idx].sel = "N"
#               END IF
#            END FOR
#            #add-point:ui_dialog段on action unsel
#            UPDATE afap210_tmp SET sel = 'N' 
#             WHERE faak000 = g_detail_d[l_ac].faak000
#               AND faak001 = g_detail_d[l_ac].faak001
#               AND faak003 = g_detail_d[l_ac].faak003
#               AND faak004 = g_detail_d[l_ac].faak004
#
#            IF SQLCA.sqlcode THEN
#               INITIALIZE g_errparam TO NULL
#               LET g_errparam.code = SQLCA.sqlcode
#               LET g_errparam.extend = 'update 7'
#               LET g_errparam.popup = TRUE
#               CALL cl_err()                 
#            END IF
            #end add-point
         #產生單一資料
         ON ACTION produce
            LET g_action_choice="produce"
            #########################mark by huangtao
            CALL afap210_produce()
            #########################mark by huangtao  
            NEXT FIELD sel
         #合併
         ON ACTION coalition
            LET g_action_choice="coalition"
            #########################mark by huangtao
            #CALL afap210_produce('2')
            CALL afap210_coalition()
            #########################mark by huangtao
            NEXT FIELD sel
         #分割
         ON ACTION comminute
            LET g_action_choice="comminute"
            CALL afap210_comminute()
            NEXT FIELD sel
            
         ON ACTION filter
            LET g_action_choice="filter"
            CALL afap210_filter()
            #add-point:ON ACTION filter

            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            ACCEPT DIALOG 
            
             
         # 條件清除
         ON ACTION qbeclear
            #20150210 add by chenying
            LET INT_FLAG = 1
            EXIT DIALOG   
            #20150210 add by chenying
            
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            CALL afap210_b_fill()
            CALL afap210_fetch()
 
         #add-point:ui_dialog段action
         ON ACTION cancel
            LET INT_FLAG = 1
            EXIT DIALOG         
         #end add-point
 
         #主選單用ACTION
         &include "main_menu.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
END FUNCTION]]>
  </point>
  <point name="function.afap210_get_deault_value" order="9" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 获取底稿信息作为默认值

# Date & Author..: 2014/11/13 By liuym
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_get_deault_value(p_faak000,p_faak001,p_faak003,p_faak004,p_faah000,p_faah001,p_faah003,p_faah004)
   DEFINE  p_faak000    LIKE faak_t.faak000
   DEFINE  p_faak001    LIKE faak_t.faak001
   DEFINE  p_faak003    LIKE faak_t.faak003
   DEFINE  p_faak004    LIKE faak_t.faak004
   DEFINE  p_faah000    LIKE faah_t.faah000
   DEFINE  p_faah001    LIKE faah_t.faah001
   DEFINE  p_faah003    LIKE faah_t.faah003
   DEFINE  p_faah004    LIKE faah_t.faah004
   DEFINE  l_faah002    LIKE faah_t.faah002
   DEFINE  l_faah005    LIKE faah_t.faah005
   DEFINE  l_faah006    LIKE faah_t.faah006
   DEFINE  l_faah007    LIKE faah_t.faah007
   DEFINE  l_faah008    LIKE faah_t.faah008
   DEFINE  l_faah009    LIKE faah_t.faah009
   DEFINE  l_faah010    LIKE faah_t.faah010
   DEFINE  l_faah011    LIKE faah_t.faah011
   DEFINE  l_faah012    LIKE faah_t.faah012
   DEFINE  l_faah013    LIKE faah_t.faah013 
   DEFINE  l_faah014    LIKE faah_t.faah014
   DEFINE  l_faah015    LIKE faah_t.faah015
   DEFINE  l_faah017    LIKE faah_t.faah017
   DEFINE  l_faah020    LIKE faah_t.faah020
   DEFINE  l_faah021    LIKE faah_t.faah021
   DEFINE  l_faah022    LIKE faah_t.faah022
   DEFINE  l_faah023    LIKE faah_t.faah023
   DEFINE  l_faah024    LIKE faah_t.faah024
   DEFINE  l_faah032    LIKE faah_t.faah032
   DEFINE  l_faah042    LIKE faah_t.faah042
   DEFINE  l_faah033    LIKE faah_t.faah033
   DEFINE  l_faah034    LIKE faah_t.faah034   
   DEFINE  l_faah035    LIKE faah_t.faah035
   DEFINE  l_faah036    LIKE faah_t.faah036
   DEFINE  l_faah037    LIKE faah_t.faah037
   DEFINE  l_faaj003    LIKE faaj_t.faaj003
   DEFINE  l_faaj004    LIKE faaj_t.faaj004
   DEFINE  l_faaj011    LIKE faaj_t.faaj011
   DEFINE  l_faaj014    LIKE faaj_t.faaj014
   DEFINE  l_faaj015    LIKE faaj_t.faaj015
   DEFINE  l_faaj016    LIKE faaj_t.faaj016
   DEFINE  l_faaj019    LIKE faaj_t.faaj019
   DEFINE  l_faaj024    LIKE faaj_t.faaj024
   DEFINE  l_faaj025    LIKE faaj_t.faaj025
   DEFINE  l_faaj026    LIKE faaj_t.faaj026
   DEFINE  l_faajld     LIKE faaj_t.faajld
   DEFINE  l_faaj006    LIKE faaj_t.faaj006
   DEFINE  l_faaj007    LIKE faaj_t.faaj007
   DEFINE  l_success    LIKE type_t.num5   
   DEFINE  l_glaa025    LIKE glaa_t.glaa025
   DEFINE  l_faaj028    LIKE faaj_t.faaj028
   DEFINE  l_faaj023    LIKE faaj_t.faaj023
   DEFINE  l_faac016    LIKE faac_t.faac016#残值率
   DEFINE  l_faah       RECORD LIKE faah_t.*
   DEFINE  l_glaa015    LIKE glaa_t.glaa015
   DEFINE  l_glaa017    LIKE glaa_t.glaa017
   DEFINE  l_faaj101    LIKE faaj_t.faaj101
   DEFINE  l_glaa018    LIKE glaa_t.glaa018
   DEFINE  l_faaj102    LIKE faaj_t.faaj102
   DEFINE  l_faaj103    LIKE faaj_t.faaj103
   DEFINE  l_faaj104    LIKE faaj_t.faaj104
   DEFINE  l_faaj105    LIKE faaj_t.faaj105
   DEFINE  l_faaj111    LIKE faaj_t.faaj111
   DEFINE  l_faaj108    LIKE faaj_t.faaj108
   DEFINE  l_glaa019    LIKE glaa_t.glaa019
   DEFINE  l_faaj017    LIKE faaj_t.faaj017
   DEFINE  l_faaj018    LIKE faaj_t.faaj018
   DEFINE  l_faaj151    LIKE faaj_t.faaj151
   DEFINE  l_glaa022    LIKE glaa_t.glaa022
   DEFINE  l_glaa021    LIKE glaa_t.glaa021
   DEFINE  l_faaj152    LIKE faaj_t.faaj152
   DEFINE  l_faaj153    LIKE faaj_t.faaj153
   DEFINE  l_faaj154    LIKE faaj_t.faaj154
   DEFINE  l_faaj155    LIKE faaj_t.faaj155
   DEFINE  l_faaj161    LIKE faaj_t.faaj161
   DEFINE  l_faaj158    LIKE faaj_t.faaj158
   
   #取faak_t數據作為預設值
   IF cl_null(p_faah004) THEN LET p_faah004=' ' END IF
   #      类型    资产性质 主要类型  次要类型  资产组   取得日期  资产状态  单位    资产属性   原币单价  本币单价  本币金额
   SELECT faak005, faak006, faak007, faak008,faak014, faak015, faak017,faak049  ,faak021, faak023,  faak024,faak009,faak010,faak011,faak012,faak013,faak019,faak022,faak032  #20150210 del faak002
   INTO l_faah005,l_faah006,l_faah007,l_faah008,l_faah014,l_faah015,l_faah017,l_faah042,l_faah021,l_faah023,l_faah024,                                                     #20150210 del l_faah002     
        l_faah009,l_faah010,l_faah011,l_faah012,l_faah013,l_faah020,l_faah022,l_faah032 
   FROM faak_t WHERE faak000=p_faak000 AND faak001=p_faak001 AND faak003=p_faak003 AND faak004=p_faak004 AND faakent=g_enterprise
   
   SELECT * INTO l_faah.* FROM faah_t WHERE faah000 = p_faah000 AND faah001 = p_faah001 AND faah003 = p_faah003 AND faah004 = p_faah004 AND faahent = g_enterprise
   #根据资产主要类型获取预设值
   SELECT faac003,faac004,faac005,faac007,faac008,faac009,faac010,faac011,faac016
   INTO l_faaj003,l_faaj004,l_faaj011,l_faah033,l_faah034,
        l_faah035,l_faah036,l_faah037,l_faac016
   FROM faac_t
   WHERE faacent = g_enterprise
   AND faac001 = l_faah006  #資產主要類型
   #根据归属法人获取对应主帐套
   SELECT UNIQUE glaald INTO l_faajld FROM glaa_t WHERE glaaent=g_enterprise AND glaacomp=l_faah032 AND glaa014='Y'
   IF cl_null(l_faajld) THEN LET l_faajld=' ' END IF
   #获取帐套使用主本币
   SELECT glaa001,glaa025 INTO l_faaj014,l_glaa025 FROM glaa_t WHERE glaald=l_faajld AND glaaent=g_enterprise   
   #获取当前汇率
   CALL s_aooi160_get_exrate('2',l_faajld,g_today,l_faah020,
                                   #目的幣別          #匯類類型
                                   l_faaj014,0,l_glaa025)
    RETURNING l_faaj015 
    LET l_faaj016 = l_faah.faah022*l_faaj015
    #预留残值
    IF cl_null(l_faac016) THEN LET l_faac016=0 END IF
    LET l_faaj019 =l_faaj016*l_faac016/100
    
    LET l_faaj006 = '1'

    SELECT ooag003 INTO l_faaj007
      FROM ooag_t 
     WHERE ooagent = g_enterprise
       AND ooag001 = g_user
   #未折减额
   LET l_faaj028 = l_faaj016
   #根据帐套+主要类型获资产旧科目 
   SELECT glab005 INTO l_faaj023 FROM glab_t  WHERE glabld =l_faajld
   AND glab003 = '9901_01' AND glab002=l_faah006
   #根据帐套+主要类型获取折旧科目 
   SELECT glab005 INTO l_faaj025 FROM glab_t  WHERE glabld =l_faajld
   AND glab003 = '9901_03' AND glab002=l_faah006
   #根据帐套+主要类型获取累折科目 
   SELECT glab005 INTO l_faaj024 FROM glab_t WHERE glabld =l_faajld
           AND glab003 = '9901_02' AND glab002=l_faah006
   #根据帐套+主要类型获取減值準備科目 
   SELECT glab005 INTO l_faaj026 FROM glab_t WHERE glabld = l_faajld
   AND glab003 = '9901_04' AND glab002=l_faah006
               

   UPDATE faah_t SET(faah004,faah005,faah006,faah007,faah008,faah014,faah015,faah016,faah017,faah042,     #20150210 del faah002
                     faah033,faah034,faah035,faah036,faah037,faah021,faah023,faah009,faah010,faah011,faah012,faah013,faah024)
                      =
                     (p_faah004,l_faah005,l_faah006,l_faah007,l_faah008,l_faah014,l_faah015,'1',l_faah017,l_faah042,l_faah033,l_faah034, #20150210 del l_faah002  
                      l_faah035,l_faah036,l_faah037,l_faah021,l_faah023,l_faah009,l_faah010,l_faah011,l_faah012,l_faah013,l_faah024)
    WHERE faah000= p_faah000 AND faah001=p_faah001 AND faah003=p_faah003 AND faah004=p_faah004 AND faahent=g_enterprise 
   IF SQLCA.sqlcode THEN
      LET l_success = FALSE
      CALL cl_errmsg('UPD faah',p_faak001,'N',sqlca.sqlcode,1)
   END IF  
   LET l_faaj017 = 0
   LET l_faaj018 = 0
   #帳套是否使用本位幣二
    SELECT glaa015 INTO l_glaa015 FROM glaa_t 
     WHERE glaaent = g_enterprise
       AND glaald = l_faajld
    IF l_glaa015 = 'Y' THEN
       #本位幣二 匯率類型
       SELECT glaa016,glaa018 INTO l_faaj101,l_glaa018
         FROM glaa_t
        WHERE glaaent = g_enterprise
          AND glaald = l_faajld
          
       #本位幣二 換算基準
       SELECT glaa017 INTO l_glaa017
         FROM glaa_t
        WHERE glaaent = g_enterprise
          AND glaald = l_faajld
       
       IF l_glaa017 ='1' THEN
          #本位幣二 匯率  
          CALL s_aooi160_get_exrate('2',l_faajld,g_today,l_faah.faah020,
                                 #目的幣別                 #匯類類型
                                 l_faaj101,0,l_glaa018)
          RETURNING l_faaj102

          #本位幣二 成本
         LET l_faaj103 =  l_faah.faah022 *  l_faaj102
       ELSE
         #本位幣二 匯率  
         CALL s_aooi160_get_exrate('2',l_faajld,g_today,l_faaj014,
                                 #目的幣別                 #匯類類型
                                 l_faaj101,0,l_glaa018)
         RETURNING l_faaj102

         #本位幣二 成本
         LET l_faaj103 =  l_faah.faah024 *  l_faaj102
       END IF   
       LET l_faaj105 = l_faaj103 * l_faac016/100
       LET l_faaj104 = l_faaj017 * l_faaj102
       LET l_faaj111 = l_faaj018 * l_faaj102
       LET l_faaj108 = l_faaj028 * l_faaj102
   END IF     
   #帳套是否使用本位幣三
   SELECT glaa019 INTO l_glaa019 FROM glaa_t 
    WHERE glaaent = g_enterprise
      AND glaald = l_faajld
   IF l_glaa019 = 'Y' THEN
      #本位幣三 匯率類型
      SELECT glaa020,glaa022 INTO l_faaj151,l_glaa022
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaald = l_faajld
      
      #本位幣二 換算基準
      SELECT glaa021 INTO l_glaa021
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaald = l_faajld   
      
      IF l_glaa021 ='1' THEN
         #本位幣三 匯率  
         CALL s_aooi160_get_exrate('2',l_faajld,g_today,l_faah.faah020,
                                  #目的幣別                 #匯類類型
                                  l_faaj151,0,l_glaa022)
         RETURNING l_faaj152
         
         #本位幣三 成本
         LET l_faaj153 =  l_faah.faah022 *  l_faaj152  
      ELSE
         #本位幣三 匯率  
         CALL s_aooi160_get_exrate('2',l_faajld,g_today,l_faaj014,
                                  #目的幣別                 #匯類類型
                                  l_faaj151,0,l_glaa022)
         RETURNING l_faaj152
         
         #本位幣三 成本
         LET l_faaj153 =  l_faah.faah024 *  l_faaj152
      END IF   
      LET l_faaj155 = l_faaj153 * l_faac016/100
      LET l_faaj154 = l_faaj017 * l_faaj152
      LET l_faaj161 = l_faaj018 * l_faaj152
      LET l_faaj158 = l_faaj028 * l_faaj152
   END IF
   INSERT INTO faaj_t(faajent,faajld,faaj037,faaj001,faaj002,faaj000,faaj003,faaj004,faaj005,faaj011,faaj023,faaj024,faaj025,
                      faaj026,faaj014,faaj015,faaj016,faaj019,faaj028,faaj006,faaj007,faajsite,faaj101,faaj102,faaj103,faaj104,faaj105,faaj111,
                      faaj108,faaj151,faaj152,faaj153,faaj154,faaj155,faaj161,faaj158,faaj017,faaj018)
               VALUES(g_enterprise,l_faajld,p_faah001,p_faah003,p_faah004,p_faah000,l_faaj003,l_faaj004,l_faaj004,l_faaj011,l_faaj023,l_faaj024,
               l_faaj025,l_faaj026,l_faaj014,l_faaj015,l_faaj016,l_faaj019,l_faaj028,l_faaj006,l_faaj007,g_site,l_faaj101,l_faaj102,l_faaj103,l_faaj104,l_faaj105,l_faaj111,
               l_faaj108,l_faaj151,l_faaj152,l_faaj153,l_faaj154,l_faaj155,l_faaj161,l_faaj158,0,0)
               
   IF SQLCA.sqlcode THEN
      LET l_success = FALSE
      CALL cl_errmsg('INS faaj_t',p_faak001,'N',sqlca.sqlcode,1)
   END IF

END FUNCTION]]>
  </point>
  <point name="function.afap210_produce" order="10" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 产生单一资料
# Memo...........:
# Usage..........: CALL afap210_produce()
# Input parameter: p_type    
# Return code....: 无
# Date & Author..: 2014/12/13 By yangxf
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_produce()
   DEFINE p_type       LIKE type_t.num5
   DEFINE l_n          LIKE type_t.num5
   DEFINE l_faak019    LIKE faak_t.faak019
   DEFINE l_faak019_t  LIKE faak_t.faak019
   
   LET l_n = 0
   #单一产生

   SELECT COUNT(*) INTO l_n
     FROM afap210_tmp
    WHERE sel = 'Y'
      AND pin = 'N'
      AND produce = 'N'
      AND pout = 'N'
   
   IF l_n = 0 THEN 
      RETURN 
   END IF 

   CALL afap210_03_open()
   IF NOT INT_FLAG THEN 
     
     #   UPDATE afap210_tmp SET faah001 = g_faah_m.faah001,
     #                          faah002 = g_faah_m.faah002,
     #                          faah003 = g_faah_m.faah003,
     #                          faah004 = g_faah_m.faah004,
     #                          produce = 'Y'
     #    WHERE sel = 'Y'
     #      AND pin = 'N'
     #      AND pout = 'N'   
     #      AND produce = 'N'
     #   IF SQLCA.SQLcode  THEN
     #      INITIALIZE g_errparam TO NULL 
     #      LET g_errparam.extend = "UPD afap210_tmp" 
     #      LET g_errparam.code   = SQLCA.sqlcode 
     #      LET g_errparam.popup  = TRUE 
     #      CALL cl_err()                  
     #      RETURN 
     #   END IF 
      
   END IF
   CALL afap210_display()
END FUNCTION]]>
  </point>
  <point name="function.afap210_comminute" order="11" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 分割
# Memo...........:
# Usage..........: CALL afap210_comminute()
# Input parameter: 无
# Return code....: 无
# Date & Author..: 2014/12/14 By yangxf
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_comminute()
   DEFINE l_n      LIKE type_t.num5
   
   LET l_n = 0
   #检查分割资料是否大于1
   SELECT COUNT(*) INTO l_n
     FROM afap210_tmp
    WHERE sel = 'Y'
      AND pout = 'N'
      AND produce = 'N'
      AND pin = 'N'
   IF l_n > 1 THEN 
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "afa-00337"
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN 
   END IF 
   IF l_n = 0 THEN 
      RETURN 
   END IF 
#   #检查被分割资料数量是否小于等于1
#   SELECT COUNT(*) INTO l_n
#     FROM afap210_tmp
#    WHERE sel = 'Y'
#      AND pout = 'N'
#      AND pin = 'N'
#      AND faak018 <= 1
#   IF l_n > 0 THEN 
#      INITIALIZE g_errparam TO NULL 
#      LET g_errparam.extend = "" 
#      LET g_errparam.code   = "afa-00338"
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#      RETURN 
#   END IF 
   SELECT faak000,faak001,faak003,faak004
     INTO g_faak000,g_faak001,g_faak003,g_faak004
     FROM afap210_tmp 
    WHERE sel = 'Y'
      AND pout = 'N'
      AND produce = 'N'
      AND pin = 'N'
   LET g_flag = 'Y'
   CALL afap210_01_open()
   IF g_flag = 'Y' THEN 
      UPDATE afap210_tmp SET pout = 'Y'
       WHERE sel = 'Y'
         AND pout = 'N'
         AND produce = 'N'
         AND pin = 'N'
      IF SQLCA.SQLcode  THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "UPD afap210_tmp" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()                  
         RETURN 
      END IF 
   END IF 
   CALL afap210_display()
END FUNCTION]]>
  </point>
  <point name="function.afap210_02_open" order="12" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 財编资料维护
# Memo...........:
# Usage..........: CALL afap210_02_open()
# Input parameter: 无
# Return code....: 无
# Date & Author..: 2014/12/14 By yangxf
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_02_open()
DEFINE lwin_curr       ui.Window
DEFINE lfrm_curr       ui.Form
DEFINE ls_path         STRING
DEFINE l_ooef017       LIKE ooef_t.ooef017
DEFINE l_n             LIKE type_t.num5
DEFINE l_success       LIKE type_t.num5
DEFINE l_faah001       LIKE faah_t.faah001
DEFINE l_faah001_2     LIKE faah_t.faah001
DEFINE l_faah001_3     LIKE faah_t.faah001
DEFINE l_count         LIKE type_t.num5
DEFINE l_count1        LIKE type_t.num5

#150311---earl---add---s
DEFINE l_oofg_return    DYNAMIC ARRAY OF RECORD
                oofg019     LIKE oofg_t.oofg019,   #field
                oofg020     LIKE oofg_t.oofg020    #value
                        END RECORD
#150311---earl---add---e 

   INITIALIZE g_faah_m.* TO NULL
   #開啟畫面
   OPEN WINDOW w_afap210_s02 WITH FORM cl_ap_formpath("afa","afap210_s02")
   CALL cl_ui_init()
   CALL cl_set_combo_scc('faah002','9911')
   LET lwin_curr = ui.Window.getCurrent()
   LET lfrm_curr = lwin_curr.getForm()
   LET ls_path = os.Path.join(os.Path.join(FGL_GETENV("ERP"),"cfg"),"4tb")
   LET ls_path = os.Path.join(ls_path,"toolbar_lib.4tb")
   CALL lfrm_curr.loadToolBar(ls_path)
   LET g_faah_m.faah002 = '1' 
   LET g_faah_m.faah004 = ' ' 
   IF g_para_data = 'N' THEN 
      CALL cl_set_comp_entry("faah001",TRUE)
   ELSE
      CALL cl_set_comp_entry("faah001",FALSE)
   END IF
   IF g_para_data2 = 'Y' AND g_faah_m.faah002 = '1' THEN
      CALL cl_set_comp_entry("faah003",FALSE)
   ELSE
      CALL cl_set_comp_entry("faah003",TRUE)  
   END IF
   IF g_para_data = 'Y' THEN
      CALL afap210_get_faah001() RETURNING g_faah_m.faah001
   END IF
   IF g_para_data2 = 'Y' AND g_faah_m.faah002 = '1' THEN          
      LET g_faah_m.faah003 = g_faah_m.faah001
   END IF
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      INPUT BY NAME g_faah_m.faah002,g_faah_m.faah001,g_faah_m.faah003,g_faah_m.faah004 ATTRIBUTE(WITHOUT DEFAULTS)
          BEFORE INPUT 
            IF g_faah_m.faah002 = '1' THEN 
              LET g_faah_m.faah004 = ' '
              DISPLAY BY NAME g_faah_m.faah004
              CALL cl_set_comp_entry("faah004",FALSE)
            ELSE
              LET g_faah_m.faah004 = ''
              CALL cl_set_comp_entry("faah004",TRUE)
            END IF
          
          BEFORE FIELD faah002
             LET g_faah002_t = g_faah_m.faah002
             
          ON CHANGE faah002
            IF g_faah_m.faah002 = '1' THEN 
               LET g_faah_m.faah003 = ''
               LET g_faah_m.faah004 = ' '
               CALL cl_set_comp_entry("faah004",FALSE)
            ELSE
               LET g_faah_m.faah003 = ''
               LET g_faah_m.faah004 = ''
               CALL cl_set_comp_entry("faah004",TRUE)
            END IF
            IF g_para_data2 = 'Y' AND g_faah_m.faah002 = '1' THEN
               CALL cl_set_comp_entry("faah003",FALSE)               
               LET g_faah_m.faah003 = g_faah_m.faah001
               DISPLAY BY NAME g_faah_m.faah003
               IF NOT cl_null(g_faah_m.faah001) AND NOT cl_null(g_faah_m.faah003) AND g_faah_m.faah004 IS NOT NULL THEN 
                  IF g_faah_m.faah002 != g_faah002_t THEN
                     IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND " || "faah001 = '"||g_faah_m.faah001 ||"' AND "|| "faah003 = '"||g_faah_m.faah003 ||"' AND "|| "faah004 = '"||g_faah_m.faah004 ||"'",'std-00004',0) THEN  
                        LET g_faah_m.faah002 = ''
                        NEXT FIELD faah002
                     END IF
                     IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "||"faah003 = '"||g_faah_m.faah003 ||"' AND "|| " faah001 = '"||g_faah_m.faah001 ||"' AND " || "faah004 = '"||g_faah_m.faah004 ||"'",'std-00004',0) THEN 
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            ELSE
               CALL cl_set_comp_entry("faah003",TRUE)    
            END IF

         AFTER FIELD faah001
             IF g_para_data = 'N' THEN
                SELECT lpad(g_faah_m.faah001,10,'0') INTO g_faah_m.faah001
                  FROM faah_t
                 WHERE faahent = g_enterprise
                DISPLAY BY NAME g_faah_m.faah001
             END IF 
             IF g_para_data2 = 'Y' AND g_faah_m.faah002 = '1' THEN
                CALL cl_set_comp_entry("faah003",FALSE)               
                LET g_faah_m.faah003 = g_faah_m.faah001
                DISPLAY BY NAME g_faah_m.faah003
             ELSE
                CALL cl_set_comp_entry("faah003",TRUE)  
             END IF
            IF NOT cl_null(g_faah_m.faah003) AND g_faah_m.faah004 IS NOT NULL AND NOT cl_null(g_faah_m.faah001) THEN
               IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| " faah001 = '"||g_faah_m.faah001 ||"' AND "|| "faah003 = '"||g_faah_m.faah003 ||"' AND "|| "faah004 = '"||g_faah_m.faah004 ||"'",'std-00004',0) THEN 
                  NEXT FIELD CURRENT
               END IF
               IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "||"faah003 = '"||g_faah_m.faah003 ||"' AND "|| " faah001 = '"||g_faah_m.faah001 ||"' AND "|| "faah004 = '"||g_faah_m.faah004 ||"'",'std-00004',0) THEN 
                  NEXT FIELD CURRENT
               END IF
            END IF

         BEFORE FIELD faah003
            IF g_para_data2 <> 'Y' THEN
               IF cl_null(g_faah_m.faah003) AND g_faah_m.faah002 = '1' THEN
                  IF g_para_data3 = 'Y' AND g_para_data2 ='N' THEN
                     #150311---earl---mod---s
                     #CALL s_aooi390('3') RETURNING l_success,g_faah_m.faah003
#                     CALL s_aooi390_auto_no('3') RETURNING l_success,g_faah_m.faah003,l_oofg_return  #mark--2015/05/07 By shiun
                     #150311---earl---mod---e
                     CALL s_aooi390_gen('3') RETURNING l_success,g_faah_m.faah003,l_oofg_return   #add--2015/05/07 By shiun
                     DISPLAY BY NAME g_faah_m.faah003
                     LET g_faah003_t = g_faah_m.faah003
                  END IF
               END IF
            END IF
            
         AFTER FIELD faah003
            IF NOT cl_null(g_faah_m.faah003) AND g_faah_m.faah004 IS NOT NULL AND NOT cl_null(g_faah_m.faah001) THEN
               IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| " faah001 = '"||g_faah_m.faah001 ||"' AND "|| "faah003 = '"||g_faah_m.faah003 ||"' AND "|| "faah004 = '"||g_faah_m.faah004 ||"'",'std-00004',0) THEN 
                  NEXT FIELD CURRENT
               END IF
               IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "||"faah003 = '"||g_faah_m.faah003 ||"' AND "|| " faah001 = '"||g_faah_m.faah001 ||"' AND "|| "faah004 = '"||g_faah_m.faah004 ||"'",'std-00004',0) THEN 
                  NEXT FIELD CURRENT
               END IF
               #add--2015/05/08 By shiun--(S)
               IF NOT s_aooi390_chk('3',g_faah_m.faah003) THEN
                  LET g_faah_m.faah003 = g_faah003_t
                  DISPLAY BY NAME g_faah_m.faah003
                  NEXT FIELD CURRENT
               END IF
               #add--2015/05/08 By shiun--(E)
            END IF
            IF NOT afap210_faah003_chk() THEN
               NEXT FIELD faah003
            END IF
            #2015/02/15 Add By 01727 客户家财产编号Key值,重复需要提醒,但不需要卡死
            #2015/02/15 Add ---(S)---
            IF NOT cl_null(g_faah_m.faah003) AND NOT cl_null(g_faah_m.faah002) AND g_faah_m.faah002 = '1' THEN  #类型为主件时候才需要判断
               LET l_count = 0
               SELECT COUNT(*) INTO l_count FROM faah_t WHERE faahent = g_enterprise
                  AND faah003 = g_faah_m.faah003
               IF cl_null(l_count) THEN lET l_count = 0 END IF
               IF l_count > 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'afa-00449'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
               END IF
            END IF
            #2015/02/15 Add ---(E)---
            
         AFTER FIELD faah004
            IF NOT cl_null(g_faah_m.faah003) AND g_faah_m.faah004 IS NOT NULL AND NOT cl_null(g_faah_m.faah001) THEN
               IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| " faah001 = '"||g_faah_m.faah001 ||"' AND "|| "faah003 = '"||g_faah_m.faah003 ||"' AND "|| "faah004 = '"||g_faah_m.faah004 ||"'",'std-00004',0) THEN 
                  NEXT FIELD CURRENT
               END IF
               IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "||"faah003 = '"||g_faah_m.faah003 ||"' AND "|| " faah001 = '"||g_faah_m.faah001 ||"' AND "|| "faah004 = '"||g_faah_m.faah004 ||"'",'std-00004',0) THEN 
                  NEXT FIELD CURRENT
               END IF
            END IF
            
         ON ACTION controlp INFIELD faah003
            IF g_faah_m.faah002 = '2' OR g_faah_m.faah002 = '3' THEN
			      INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
			      LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_faah_m.faah003
               CALL q_faah003()
               LET g_faah_m.faah003 = g_qryparam.return1 
               LET g_qryparam.where = " "
               DISPLAY g_faah_m.faah003 TO faah003              #顯示到畫面上
               NEXT FIELD faah003                          #返回原欄位
            END IF
      END INPUT
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DIALOG
 
      ON ACTION accept
         ACCEPT DIALOG 
         
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG   

      ON ACTION close
         LET INT_FLAG = 1         
         LET g_action_choice = "exit"
         EXIT DIALOG 
   END DIALOG
   CLOSE WINDOW w_afap210_s02
      
END FUNCTION]]>
  </point>
  <point name="function.afap210_faah003_chk" order="13" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 財编检查
# Memo...........:
# Usage..........: CALL afap210_faah003_chk()
# Input parameter: 无
# Return code....: 状态码
# Date & Author..: 2014/12/14 By yangxf
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_faah003_chk()
   DEFINE l_n      LIKE type_t.num5
   
   IF NOT cl_null(g_faah_m.faah002) AND NOT cl_null(g_faah_m.faah003) AND g_faah_m.faah002 <> '1' THEN 
      SELECT count(*) INTO l_n 
        FROM faah_t
       WHERE faahent = g_enterprise
         AND faah003 = g_faah_m.faah003
         AND faah002 = '1'
         
      IF l_n = 0 THEN 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'afa-00016'
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN FALSE
      END IF 
   END IF
   
   RETURN TRUE
END FUNCTION]]>
  </point>
  <point name="function.afap210_display" order="14" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 显示单身数据
# Memo...........:
# Usage..........: CALL afap210_display()
# Input parameter: 无
# Return code....: 无
# Date & Author..: 2014/12/15 By yangxf
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_display()
   DEFINE l_cnt   LIKE type_t.num5 
   
   LET l_cnt = 1
   DECLARE afap210_curs CURSOR FOR SELECT * FROM afap210_tmp ORDER BY faak000,faak001,faak003,faak004
   FOREACH afap210_curs INTO g_detail_d[l_cnt].*
   
      LET l_cnt = l_cnt +1
   END FOREACH 
   CALL g_detail_d.deleteElement(l_cnt)
   LET g_detail_cnt = l_cnt - 1
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      BEFORE DISPLAY
        EXIT DISPLAY 
        
   END DISPLAY    
END FUNCTION]]>
  </point>
  <point name="function.afap210_01_open" order="15" ver="4" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL afap210_01_open()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/15 By yangxf
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_01_open()
DEFINE lwin_curr       ui.Window
DEFINE lfrm_curr       ui.Form
DEFINE ls_path         STRING
DEFINE l_n             LIKE type_t.num5
DEFINE l_faah018       LIKE faah_t.faah018
DEFINE l_success       LIKE type_t.num5
DEFINE l_insert        BOOLEAN
DEFINE l_faah022       LIKE faah_t.faah022
DEFINE p_cmd           LIKE type_t.chr1
DEFINE l_count         LIKE type_t.num5
DEFINE l_count1        LIKE type_t.num5

#150311---earl---add---s
DEFINE l_oofg_return    DYNAMIC ARRAY OF RECORD
                oofg019     LIKE oofg_t.oofg019,   #field
                oofg020     LIKE oofg_t.oofg020    #value
                        END RECORD
#150311---earl---add---e 

   #開啟畫面
   OPEN WINDOW w_afap210_s01 WITH FORM cl_ap_formpath("afa","afap210_s01")
   CALL cl_ui_init()
   LET lwin_curr = ui.Window.getCurrent()
   LET lfrm_curr = lwin_curr.getForm()
   LET ls_path = os.Path.join(os.Path.join(FGL_GETENV("ERP"),"cfg"),"4tb")
   LET ls_path = os.Path.join(ls_path,"toolbar_lib.4tb")
   CALL lfrm_curr.loadToolBar(ls_path)
   IF g_para_data = 'N' THEN 
      CALL cl_set_comp_entry("b_faah001",TRUE)
   ELSE
      CALL cl_set_comp_entry("b_faah001",FALSE)
   END IF
   CALL cl_set_combo_scc('b_faah002','9911')
   CALL afap210_01_b_fill()
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      INPUT ARRAY g_detail1_d FROM s_detail2.*
         ATTRIBUTE(COUNT = g_rec_b1,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
               INSERT ROW = TRUE, 
               DELETE ROW = TRUE,
               APPEND ROW = TRUE)   
         
      BEFORE ROW
         LET l_insert = FALSE
         LET l_ac1 = ARR_CURR()
         LET g_detail_idx = l_ac1      
         LET l_n = ARR_COUNT()
         IF g_rec_b1 >= l_ac1 THEN 
            LET p_cmd = 'u'
            LET g_detail1_d_t.* = g_detail1_d[l_ac].*
         END IF 
         
      BEFORE INSERT
         LET p_cmd = 'a'
         INITIALIZE g_detail1_d_t.* TO NULL
         LET l_n = ARR_COUNT()
         INITIALIZE g_detail1_d[l_ac1].* TO NULL
         SELECT MAX(flag) + 1 INTO g_detail1_d[l_ac1].flag
           FROM afap210_01_tmp
          WHERE faak000 = g_faak000
            AND faak001 = g_faak001
            AND faak003 = g_faak003
            AND faak004 = g_faak004
         IF cl_null(g_detail1_d[l_ac1].flag) THEN 
            LET g_detail1_d[l_ac1].flag = 1
         END IF 
         SELECT faak000,faak001,faak003,faak004,faak019,faak018,faak022
           INTO g_detail1_d[l_ac1].faak000,g_detail1_d[l_ac1].faak001,
                g_detail1_d[l_ac1].faak003,g_detail1_d[l_ac1].faak004,
                g_detail1_d[l_ac1].faak019,g_faak018,g_faak022
           FROM afap210_tmp
          WHERE faak000 = g_faak000
            AND faak001 = g_faak001
            AND faak003 = g_faak003
            AND faak004 = g_faak004
         LET g_detail1_d[l_ac1].faak018 = g_faak018
         LET g_detail1_d[l_ac1].faah018 = 1 
         LET g_detail1_d[l_ac1].faah002 = '1'
         LET g_detail1_d[l_ac1].faah003 = ''
         LET g_detail1_d[l_ac1].faah004 = ' '
         CALL cl_set_comp_entry("b_faah004",FALSE)
         IF g_para_data = 'Y' THEN
            CALL afap210_get_faah001() RETURNING g_detail1_d[l_ac1].faah001
         END IF
         IF g_para_data2 = 'Y' AND g_detail1_d[l_ac1].faah002 = '1' THEN
            CALL cl_set_comp_entry("b_faah003",FALSE)
            LET g_detail1_d[l_ac1].faah003 = g_detail1_d[l_ac1].faah001
         ELSE
            CALL cl_set_comp_entry("b_faah003",TRUE)  
         END IF
               
      AFTER INSERT
         IF INT_FLAG THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = '' 
            LET g_errparam.code   = 9001 
            LET g_errparam.popup  = FALSE 
            CALL cl_err()
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         INSERT INTO afap210_01_tmp VALUES(g_detail1_d[l_ac1].*)
         IF SQLCA.SQLcode  THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "INTO afap210_01_tmp" 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            CANCEL INSERT
         END IF 
         
      BEFORE DELETE 
         IF NOT cl_ask_del_detail() THEN
            CANCEL DELETE
         END IF
         DELETE FROM afap210_01_tmp
          WHERE faak000 = g_faak000
            AND faak001 = g_faak001
            AND faak003 = g_faak003
            AND faak004 = g_faak004
            AND flag = g_detail1_d[l_ac1].flag
         IF SQLCA.SQLcode  THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "INTO afap210_01_tmp" 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()                  
            CANCEL DELETE
         END IF 
         
      ON ROW CHANGE 
         IF INT_FLAG THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = '' 
            LET g_errparam.code   = 9001 
            LET g_errparam.popup  = FALSE 
            CALL cl_err()
            LET INT_FLAG = 0
            LET g_detail1_d[l_ac1].* = g_detail1_d_t.*
            EXIT DIALOG 
         END IF
         UPDATE afap210_01_tmp SET faah018 = g_detail1_d[l_ac1].faah018,
                                   faah022 = g_detail1_d[l_ac1].faah022,
                                   faah001 = g_detail1_d[l_ac1].faah001,
                                   faah002 = g_detail1_d[l_ac1].faah002,
                                   faah003 = g_detail1_d[l_ac1].faah003,
                                   faah004 = g_detail1_d[l_ac1].faah004
          WHERE faak000 = g_faak000
            AND faak001 = g_faak001
            AND faak003 = g_faak003
            AND faak004 = g_faak004
            AND flag = g_detail1_d[l_ac1].flag
         IF SQLCA.SQLcode  THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "INTO afap210_01_tmp" 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()                  
            EXIT DIALOG 
         END IF 
         
         ON CHANGE b_faah002
            IF g_detail1_d[l_ac1].faah002 = '1' THEN 
               LET g_detail1_d[l_ac1].faah003 = ''
               LET g_detail1_d[l_ac1].faah004 = ' '
               CALL cl_set_comp_entry("b_faah004",FALSE)
            ELSE
               LET g_detail1_d[l_ac1].faah003 = ''
               LET g_detail1_d[l_ac1].faah004 = ''
               CALL cl_set_comp_entry("b_faah004",TRUE)
            END IF 
            IF g_para_data2 = 'Y' AND g_detail1_d[l_ac1].faah002 = '1' THEN
               CALL cl_set_comp_entry("b_faah003",FALSE)               
               LET g_detail1_d[l_ac1].faah003 = g_detail1_d[l_ac1].faah001
               IF NOT cl_null(g_detail1_d[l_ac1].faah001) AND NOT cl_null(g_detail1_d[l_ac1].faah003) AND g_detail1_d[l_ac1].faah004 IS NOT NULL THEN 
                  IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( g_detail1_d[l_ac1].faah002 != g_detail1_d_t.faah002)) THEN
                     IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                        NEXT FIELD CURRENT
                     END IF
                     IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                        NEXT FIELD CURRENT
                     END IF
                     LET l_n = 0
                     SELECT COUNT(*) INTO l_n
                       FROM afap210_01_tmp 
                      WHERE flag <> g_detail1_d[l_ac1].flag
                        AND faah003 = g_detail1_d[l_ac1].faah003
                        AND faah004 = g_detail1_d[l_ac1].faah004
                        AND faah001 = g_detail1_d[l_ac1].faah001
                     IF l_n > 0 THEN 
                        INITIALIZE g_errparam TO NULL 
                        LET g_errparam.extend = '' 
                        LET g_errparam.code   = 'std-00004'
                        LET g_errparam.popup  = FALSE 
                        CALL cl_err()
                        NEXT FIELD b_faah004
                     END IF 
                  END IF 
               END IF
            ELSE
               CALL cl_set_comp_entry("b_faah003",TRUE)    
            END IF
            
         AFTER FIELD b_faah001
             IF g_para_data = 'N' THEN
                SELECT lpad(g_detail1_d[l_ac1].faah001,10,'0') INTO g_detail1_d[l_ac1].faah001
                  FROM faah_t
                 WHERE faahent = g_enterprise
                DISPLAY BY NAME g_detail1_d[l_ac1].faah001
             END IF 
             IF g_para_data2 = 'Y' AND g_detail1_d[l_ac1].faah002 = '1' THEN
                CALL cl_set_comp_entry("b_faah003",FALSE)               
                LET g_detail1_d[l_ac1].faah003 = g_detail1_d[l_ac1].faah001
                DISPLAY BY NAME g_detail1_d[l_ac1].faah003
             ELSE
                CALL cl_set_comp_entry("b_faah003",TRUE)  
             END IF
            IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( g_detail1_d[l_ac1].faah001 != g_detail1_d_t.faah001)) THEN
               IF  NOT cl_null(g_detail1_d[l_ac1].faah003) AND NOT cl_null(g_detail1_d[l_ac1].faah001) AND g_detail1_d[l_ac1].faah004 IS NOT NULL THEN
                   IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                      NEXT FIELD CURRENT
                   END IF
                   IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                      NEXT FIELD CURRENT
                   END IF
                   LET l_n = 0
                   SELECT COUNT(*) INTO l_n
                     FROM afap210_01_tmp 
                    WHERE flag <> g_detail1_d[l_ac1].flag
                      AND faah003 = g_detail1_d[l_ac1].faah003
                      AND faah004 = g_detail1_d[l_ac1].faah004
                      AND faah001 = g_detail1_d[l_ac1].faah001
                   IF l_n > 0 THEN 
                      INITIALIZE g_errparam TO NULL 
                      LET g_errparam.extend = '' 
                      LET g_errparam.code   = 'std-00004'
                      LET g_errparam.popup  = FALSE 
                      CALL cl_err()
                      NEXT FIELD b_faah001
                   END IF 
               END IF
            END IF 
            
         BEFORE FIELD b_faah003
            IF g_para_data2 <> 'Y' THEN 
               IF cl_null(g_detail1_d[l_ac1].faah003) AND g_detail1_d[l_ac1].faah002 = '1' THEN
                  IF g_para_data3 = 'Y' AND g_para_data2 ='N' THEN 
                     #150311---earl---mod---s
                     #CALL s_aooi390('3') RETURNING l_success,g_detail1_d[l_ac1].faah003
#                     CALL s_aooi390_auto_no('3') RETURNING l_success,g_detail1_d[l_ac1].faah003,l_oofg_return
                     #150311---earl---mod---e
                     CALL s_aooi390_gen('3') RETURNING l_success,g_detail1_d[l_ac1].faah003,l_oofg_return   #add--2015/05/07 By shiun
                  END IF 
               END IF
            END IF 
         
         #財编检查
         AFTER FIELD b_faah003
            IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( g_detail1_d[l_ac1].faah003 != g_detail1_d_t.faah003)) THEN
               IF  NOT cl_null(g_detail1_d[l_ac1].faah003) AND NOT cl_null(g_detail1_d[l_ac1].faah001) AND g_detail1_d[l_ac1].faah004 IS NOT NULL THEN
                   IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                      NEXT FIELD CURRENT
                   END IF
                   IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                      NEXT FIELD CURRENT
                   END IF
                   LET l_n = 0
                   SELECT COUNT(*) INTO l_n
                     FROM afap210_01_tmp 
                    WHERE flag <> g_detail1_d[l_ac1].flag
                      AND faah003 = g_detail1_d[l_ac1].faah003
                      AND faah004 = g_detail1_d[l_ac1].faah004
                      AND faah001 = g_detail1_d[l_ac1].faah001
                   IF l_n > 0 THEN 
                      INITIALIZE g_errparam TO NULL 
                      LET g_errparam.extend = '' 
                      LET g_errparam.code   = 'std-00004'
                      LET g_errparam.popup  = FALSE 
                      CALL cl_err()
                      NEXT FIELD b_faah003
                   END IF 
                   #add--2015/05/08 By shiun--(S)
                   IF NOT s_aooi390_chk('2',g_detail1_d[l_ac1].faah003) THEN
                      LET g_detail1_d[l_ac1].faah003 = g_detail1_d_t.faah003
                      DISPLAY BY NAME g_detail1_d[l_ac1].faah003
                      NEXT FIELD CURRENT
                   END IF
                   #add--2015/05/08 By shiun--(E)
               END IF
            END IF 
            IF NOT cl_null(g_detail1_d[l_ac1].faah003) THEN 
               IF NOT afap210_faah003_chk() THEN 
                  LET g_detail1_d[l_ac1].faah003 = ''
                  NEXT FIELD b_faah003
               END IF 

            END IF 
            #2015/02/15 Add By 01727 客户家财产编号Key值,重复需要提醒,但不需要卡死
            #2015/02/15 Add ---(S)---
            IF NOT cl_null(g_detail1_d[l_ac1].faah003) AND NOT cl_null(g_detail1_d[l_ac1].faah002) AND g_detail1_d[l_ac1].faah002 = '1' THEN  #类型为主件时候才需要判断
               LET l_count = 0
               SELECT COUNT(*) INTO l_count FROM faah_t WHERE faahent = g_enterprise
                  AND faah003 = g_detail1_d[l_ac1].faah003
               IF cl_null(l_count) THEN lET l_count = 0 END IF
               FOR l_count1 = 1 TO g_detail1_d.getLength()
                  IF g_detail1_d[l_ac1].faah003 = g_detail1_d[l_count1].faah003 AND l_ac1 <> l_count1 THEN
                     LET l_count = l_count + 1
                  END IF
               END FOR
               IF l_count > 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'afa-00449'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
               END IF
            END IF
            #2015/02/15 Add ---(E)---
         
         AFTER FIELD b_faah004
            IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( g_detail1_d[l_ac1].faah004 != g_detail1_d_t.faah004)) THEN
               IF  NOT cl_null(g_detail1_d[l_ac1].faah003) AND NOT cl_null(g_detail1_d[l_ac1].faah001) AND g_detail1_d[l_ac1].faah004 IS NOT NULL THEN
                   IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                      NEXT FIELD CURRENT
                   END IF
                   IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                      NEXT FIELD CURRENT
                   END IF
                   LET l_n = 0
                   SELECT COUNT(*) INTO l_n
                     FROM afap210_01_tmp 
                    WHERE flag <> g_detail1_d[l_ac1].flag
                      AND faah003 = g_detail1_d[l_ac1].faah003
                      AND faah004 = g_detail1_d[l_ac1].faah004
                      AND faah001 = g_detail1_d[l_ac1].faah001
                   IF l_n > 0 THEN 
                      INITIALIZE g_errparam TO NULL 
                      LET g_errparam.extend = '' 
                      LET g_errparam.code   = 'std-00004'
                      LET g_errparam.popup  = FALSE 
                      CALL cl_err()
                      NEXT FIELD b_faah004
                   END IF 
               END IF
            END IF 

         ON ACTION controlp INFIELD b_faah003
            IF g_detail1_d[l_ac1].faah002 = '2' OR g_detail1_d[l_ac1].faah002 = '3' THEN
			      INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
			      LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_detail1_d[l_ac1].faah003
               CALL q_faah003()
               LET g_detail1_d[l_ac1].faah003 = g_qryparam.return1 
               LET g_qryparam.where = " "
               DISPLAY BY NAME g_detail1_d[l_ac1].faah003
               NEXT FIELD b_faah003                          #返回原欄位
            END IF
            
         AFTER FIELD b_faah018
            IF NOT cl_null(g_detail1_d[l_ac1].faah018) THEN
               IF g_detail1_d[l_ac1].faah018 <= 0 THEN 
                   INITIALIZE g_errparam TO NULL 
                   LET g_errparam.extend = '' 
                   LET g_errparam.code   = 'afa-00353'
                   LET g_errparam.popup  = FALSE 
                   LET g_detail1_d[l_ac1].faah018 = g_detail1_d_t.faah018
                   CALL cl_err()
               END IF 
            END IF
#               SELECT SUM(faah018) INTO l_faah018
#                 FROM afap210_01_tmp 
#                WHERE flag <> g_detail1_d[l_ac1].flag
#                  AND faak000 = g_faak000
#                  AND faak001 = g_faak001
#                  AND faak003 = g_faak003
#                  AND faak004 = g_faak004
#                IF cl_null(l_faah018) THEN 
#                   LET l_faah018 = 0
#                END IF 
#                IF l_faah018 + g_detail1_d[l_ac1].faah018 > g_faak018 THEN 
#                    INITIALIZE g_errparam TO NULL 
#                    LET g_errparam.extend = '' 
#                    LET g_errparam.code   = 'afa-00341'
#                    LET g_errparam.popup  = FALSE 
#                    CALL cl_err()
#                    LET g_detail1_d[l_ac1].faah018 = g_detail1_d_t.faah018
#                    NEXT FIELD b_faah018
#                END IF
#                LET g_detail1_d[l_ac1].faah022 = g_detail1_d[l_ac1].faah018*(g_faak022/g_faak018)
#            END IF 

         AFTER FIELD b_faah022
            IF NOT cl_null(g_detail1_d[l_ac1].faah022) THEN
               IF g_detail1_d[l_ac1].faah022 <= 0 THEN 
                   INITIALIZE g_errparam TO NULL 
                   LET g_errparam.extend = '' 
                   LET g_errparam.code   = 'afa-00354'
                   LET g_errparam.popup  = FALSE 
                   CALL cl_err()
                   LET g_detail1_d[l_ac1].faah022 = g_detail1_d_t.faah022
                   NEXT FIELD b_faah022
               END IF 
               SELECT SUM(faah022) INTO l_faah022
                 FROM afap210_01_tmp 
                WHERE flag <> g_detail1_d[l_ac1].flag
                  AND faak000 = g_faak000
                  AND faak001 = g_faak001
                  AND faak003 = g_faak003
                  AND faak004 = g_faak004
                IF cl_null(l_faah022) THEN 
                   LET l_faah022 = 0
                END IF 
                IF l_faah022 + g_detail1_d[l_ac1].faah022 > g_faak022 THEN 
                    INITIALIZE g_errparam TO NULL 
                    LET g_errparam.extend = '' 
                    LET g_errparam.code   = 'afa-00355'
                    LET g_errparam.popup  = FALSE 
                    CALL cl_err()
                    LET g_detail1_d[l_ac1].faah022 = g_detail1_d_t.faah022
                    NEXT FIELD b_faah022
                END IF
            END IF 

      AFTER INPUT 
#         SELECT SUM(faah018) INTO l_faah018
#           FROM afap210_01_tmp 
#          WHERE faak000 = g_faak000
#            AND faak001 = g_faak001
#            AND faak003 = g_faak003
#            AND faak004 = g_faak004
#         IF cl_null(l_faah018) THEN 
#            LET l_faah018 = 0
#         END IF 
#         IF l_faah018 != g_faak018 THEN 
#            INITIALIZE g_errparam TO NULL 
#            LET g_errparam.extend = '' 
#            LET g_errparam.code   = 'afa-00342'
#            LET g_errparam.popup  = FALSE 
#            CALL cl_err()
#            NEXT FIELD b_faah018
#         END IF 
         SELECT SUM(faah022) INTO l_faah022
           FROM afap210_01_tmp 
          WHERE faak000 = g_faak000
            AND faak001 = g_faak001
            AND faak003 = g_faak003
            AND faak004 = g_faak004
         IF cl_null(l_faah022) THEN 
            LET l_faah022 = 0
         END IF 
         IF l_faah022 > g_faak022 THEN 
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = '' 
            LET g_errparam.code   = 'afa-00355'
            LET g_errparam.popup  = FALSE 
            CALL cl_err()
            NEXT FIELD b_faah022
         END IF
      
      END INPUT
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DIALOG
 
      ON ACTION accept
         ACCEPT DIALOG 
         
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG   

      ON ACTION close
         LET INT_FLAG = 1         
         LET g_action_choice = "exit"
         EXIT DIALOG 
   END DIALOG
   IF INT_FLAG THEN 
      LET g_flag = 'N'
      #清空临时表数据
      DELETE FROM afap210_01_tmp 
       WHERE faak000 = g_faak000
         AND faak001 = g_faak001
         AND faak003 = g_faak003
         AND faak004 = g_faak004
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "DEL afap210_01_tmp" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      END IF
   END IF 
   CLOSE WINDOW w_afap210_s01
END FUNCTION]]>
  </point>
  <point name="function.afap210_01_b_fill" order="16" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 分割單身顯示
# Memo...........:
# Usage..........: CALL afap210_01_b_fill()
# Input parameter:  
# Return code....:  
# Date & Author..: 2014/12/15 By yangxf
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_01_b_fill()
   LET g_sql = " SELECT * FROM afap210_01_tmp ",
               "  WHERE faak000 = '",g_faak000,"'",
               "    AND faak001 = '",g_faak001,"'",
               "    AND faak003 = '",g_faak003,"'",
               "    AND faak004 = '",g_faak004,"'"
               
   PREPARE afap210_01_sel FROM g_sql
   DECLARE afap210_01_curs CURSOR FOR afap210_01_sel
   
   CALL g_detail1_d.clear()    

   LET g_cnt = 1 
   ERROR "Searching!"
   
   FOREACH afap210_01_curs INTO g_detail1_d[g_cnt].*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH 01:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         EXIT FOREACH
      END IF
      LET g_cnt = g_cnt + 1
   END FOREACH
                 
   CALL g_detail1_d.deleteElement(g_cnt)
   LET g_rec_b1 = g_cnt - 1 
   DISPLAY g_rec_b1 TO FORMONLY.cnt
   LET g_cnt = 0       
END FUNCTION]]>
  </point>
  <point name="function.afap210_set_entry" order="17" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_set_entry()

    IF g_detail_d[l_ac].sel = 'Y' AND g_pr = 'Y' THEN
       CALL cl_set_comp_entry("b_faah001,b_faah003,b_faah004",TRUE)
       CALL cl_set_comp_required("b_faah001,b_faah003,b_faah004",TRUE)
    ELSE
       CALL cl_set_comp_entry("b_faah001,b_faah003,b_faah004",FALSE)
       CALL cl_set_comp_required("b_faah001,b_faah003,b_faah004",FALSE) 
    END IF

END FUNCTION]]>
  </point>
  <point name="function.afap210_coalition" order="18" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_coalition()
   DEFINE p_type       LIKE type_t.num5
   DEFINE l_n          LIKE type_t.num5
   DEFINE l_faak019    LIKE faak_t.faak019
   DEFINE l_faak019_t  LIKE faak_t.faak019
   
   LET l_n = 0

     #######################mark by huangtao
     ##检查是否只勾选一笔资料
     #SELECT COUNT(*) INTO l_n
     #  FROM afap210_tmp
     # WHERE sel = 'Y'
     #   AND pin = 'N'
     #   AND produce = 'N'
     #   AND pout = 'N'
     #IF l_n > 1 THEN 
     #   INITIALIZE g_errparam TO NULL 
     #   LET g_errparam.extend = ""
     #   LET g_errparam.code   = "afa-00335" 
     #   LET g_errparam.popup  = TRUE 
     #   CALL cl_err()
     #   RETURN 
     #ELSE
     #   IF l_n = 0 THEN 
     #      RETURN 
     #   END IF 
     #END IF
     ######################mark by huangtao
   #多笔合并

      LET l_n = 0
      #检查是否勾选两笔以上的资料
      SELECT COUNT(*) INTO l_n
        FROM afap210_tmp
       WHERE sel = 'Y'
         AND pin = 'N'
         AND produce = 'N'
         AND pout = 'N'
      IF l_n = 0 THEN 
         RETURN 
      END IF 
      IF l_n < 2 THEN 
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "" 
         LET g_errparam.code   = "afa-00336"
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         RETURN 
      END IF
 

      LET l_faak019_t = ''
      #如果是合并检查币别是否相同
      DECLARE sel_faak019 CURSOR FOR SELECT faak019 FROM afap210_tmp WHERE sel = 'Y'
                                                                       AND pin = 'N'
                                                                       AND produce = 'N'
                                                                       AND pout = 'N'
      FOREACH sel_faak019 INTO l_faak019
         IF l_faak019_t != l_faak019 AND NOT cl_null(l_faak019_t) THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "" 
            LET g_errparam.code   = "afa-00340"
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            RETURN 
         END IF 
         LET l_faak019_t = l_faak019
      END FOREACH 
  
   CALL afap210_02_open()
   IF NOT INT_FLAG THEN 
 
         UPDATE afap210_tmp SET faah001 = g_faah_m.faah001,
                                faah002 = g_faah_m.faah002,
                                faah003 = g_faah_m.faah003,
                                faah004 = g_faah_m.faah004,
                                pin = 'Y'
          WHERE sel = 'Y'
            AND pin = 'N'
            AND pout = 'N' 
            AND produce = 'N'      
         IF SQLCA.SQLcode  THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "UPD afap210_tmp" 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()                  
            RETURN 
         END IF             

        # UPDATE afap210_tmp SET faah001 = g_faah_m.faah001,
        #                        faah002 = g_faah_m.faah002,
        #                        faah003 = g_faah_m.faah003,
        #                        faah004 = g_faah_m.faah004,
        #                        produce = 'Y'
        #  WHERE sel = 'Y'
        #    AND pin = 'N'
        #    AND pout = 'N'   
        #    AND produce = 'N'
        # IF SQLCA.SQLcode  THEN
        #    INITIALIZE g_errparam TO NULL 
        #    LET g_errparam.extend = "UPD afap210_tmp" 
        #    LET g_errparam.code   = SQLCA.sqlcode 
        #    LET g_errparam.popup  = TRUE 
        #    CALL cl_err()                  
        #    RETURN 
        # END IF 
      
   END IF
   CALL afap210_display()
END FUNCTION]]>
  </point>
  <point name="function.afap210_03_open" order="19" ver="5" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_03_open()
DEFINE lwin_curr       ui.Window
DEFINE lfrm_curr       ui.Form
DEFINE ls_path         STRING
DEFINE l_n             LIKE type_t.num5
DEFINE l_faah018       LIKE faah_t.faah018
DEFINE l_success       LIKE type_t.num5
DEFINE l_insert        BOOLEAN
DEFINE l_faah022       LIKE faah_t.faah022
DEFINE p_cmd           LIKE type_t.chr1
DEFINE l_count         LIKE type_t.num5


#開啟畫面
   OPEN WINDOW w_afap210_s03 WITH FORM cl_ap_formpath("afa","afap210_s03")
   CALL cl_ui_init()
   LET lwin_curr = ui.Window.getCurrent()
   LET lfrm_curr = lwin_curr.getForm()
   LET ls_path = os.Path.join(os.Path.join(FGL_GETENV("ERP"),"cfg"),"4tb")
   LET ls_path = os.Path.join(ls_path,"toolbar_lib.4tb")
   CALL lfrm_curr.loadToolBar(ls_path)
   IF g_para_data = 'N' THEN 
      CALL cl_set_comp_entry("b_faah001",TRUE)
   ELSE
      CALL cl_set_comp_entry("b_faah001",FALSE)
   END IF
   CALL cl_set_combo_scc('b_faah002','9911')
   CALL afap210_03_b_fill()
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      INPUT ARRAY g_detail3_d FROM s_detail3.*
         ATTRIBUTE(COUNT = g_rec_b1,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
               INSERT ROW = FALSE, 
               DELETE ROW = FALSE,
               APPEND ROW = FALSE)   
         
      BEFORE ROW
         LET l_insert = FALSE
         LET l_ac1 = ARR_CURR()
         LET g_detail_idx = l_ac1      
         LET l_n = ARR_COUNT()
         IF g_rec_b1 >= l_ac1 THEN 
            LET p_cmd = 'u'
            LET g_detail3_d_t.* = g_detail3_d[l_ac1].*
         END IF 
         #2015/7/1--by--02599--add--str--
         IF cl_null(g_detail3_d[l_ac1].faah002) THEN
            LET g_detail3_d[l_ac1].faah002 = '1'
         END IF
         #2015/7/1--by--02599--add--end
    #  BEFORE INSERT
    #     LET p_cmd = 'a'
    #     INITIALIZE g_detail3_d_t.* TO NULL
    #     LET l_n = ARR_COUNT()
    #     INITIALIZE g_detail3_d[l_ac1].* TO NULL
         
       
        # CALL cl_set_comp_entry("b_faah004",FALSE)
        # IF g_para_data = 'Y' THEN
        #    CALL afap210_get_faah001() RETURNING g_detail1_d[l_ac1].faah001
        # END IF
        # IF g_para_data2 = 'Y' AND g_detail1_d[l_ac1].faah002 = '1' THEN
        #    CALL cl_set_comp_entry("b_faah003",FALSE)
        #    LET g_detail1_d[l_ac1].faah003 = g_detail1_d[l_ac1].faah001
        # ELSE
        #    CALL cl_set_comp_entry("b_faah003",TRUE)  
        # END IF
             
      AFTER INSERT
         IF INT_FLAG THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = '' 
            LET g_errparam.code   = 9001 
            LET g_errparam.popup  = FALSE 
            CALL cl_err()
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         
         
      BEFORE DELETE 
         IF NOT cl_ask_del_detail() THEN
            CANCEL DELETE
         END IF
       
         
      ON ROW CHANGE 
         IF INT_FLAG THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = '' 
            LET g_errparam.code   = 9001 
            LET g_errparam.popup  = FALSE 
            CALL cl_err()
            LET INT_FLAG = 0
            LET g_detail3_d[l_ac1].* = g_detail3_d_t.*
            EXIT DIALOG 
         END IF
         UPDATE afap210_tmp SET faah002 = g_detail3_d[l_ac1].faah002,
                                faah003 = g_detail3_d[l_ac1].faah003,
                                faah004 = g_detail3_d[l_ac1].faah004,
                                faah001 = g_detail3_d[l_ac1].faah001,
                                produce = 'Y'
          WHERE faak001 = g_detail3_d[l_ac1].faak001
            AND faak003 = g_detail3_d[l_ac1].faak003
            AND faak004 = g_detail3_d[l_ac1].faak004
            
              
        ON CHANGE b_faah002
           IF g_detail3_d[l_ac1].faah002 = '1' THEN 
              LET g_detail3_d[l_ac1].faah003 = ''
              LET g_detail3_d[l_ac1].faah004 = ' '
              CALL cl_set_comp_entry("b_faah004",FALSE)
           ELSE
              LET g_detail3_d[l_ac1].faah003 = ''
              LET g_detail3_d[l_ac1].faah004 = ''
              CALL cl_set_comp_entry("b_faah004",TRUE)
           END IF 
    #       IF g_para_data2 = 'Y' AND g_detail1_d[l_ac1].faah002 = '1' THEN
    #          CALL cl_set_comp_entry("b_faah003",FALSE)               
    #          LET g_detail1_d[l_ac1].faah003 = g_detail1_d[l_ac1].faah001
    #          IF NOT cl_null(g_detail1_d[l_ac1].faah001) AND NOT cl_null(g_detail1_d[l_ac1].faah003) AND g_detail1_d[l_ac1].faah004 IS NOT NULL THEN 
    #             IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( g_detail1_d[l_ac1].faah002 != g_detail1_d_t.faah002)) THEN
    #                IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
    #                   NEXT FIELD CURRENT
    #                END IF
    #                IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "|| "faah003 = '"||g_detail1_d[l_ac1].faah003 ||"' AND "|| "faah001 = '"||g_detail1_d[l_ac1].faah001 ||"' AND "|| "faah004 = '"||g_detail1_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
    #                   NEXT FIELD CURRENT
    #                END IF
    #                LET l_n = 0
    #                SELECT COUNT(*) INTO l_n
    #                  FROM afap210_01_tmp 
    #                 WHERE flag <> g_detail1_d[l_ac1].flag
    #                   AND faah003 = g_detail1_d[l_ac1].faah003
    #                   AND faah004 = g_detail1_d[l_ac1].faah004
    #                   AND faah001 = g_detail1_d[l_ac1].faah001
    #                IF l_n > 0 THEN 
    #                   INITIALIZE g_errparam TO NULL 
    #                   LET g_errparam.extend = '' 
    #                   LET g_errparam.code   = 'std-00004'
    #                   LET g_errparam.popup  = FALSE 
    #                   CALL cl_err()
    #                   NEXT FIELD b_faah004
    #                END IF 
    #             END IF 
    #          END IF
    #       ELSE
    #          CALL cl_set_comp_entry("b_faah003",TRUE)    
    #       END IF
    #       
        AFTER FIELD b_faah001
            IF g_para_data = 'N' THEN
               SELECT lpad(g_detail3_d[l_ac1].faah001,10,'0') INTO g_detail3_d[l_ac1].faah001
                 FROM faah_t
                WHERE faahent = g_enterprise
               DISPLAY BY NAME g_detail3_d[l_ac1].faah001
            END IF 
    #        IF g_para_data2 = 'Y' AND g_detail1_d[l_ac1].faah002 = '1' THEN
    #           CALL cl_set_comp_entry("b_faah003",FALSE)               
    #           LET g_detail1_d[l_ac1].faah003 = g_detail1_d[l_ac1].faah001
    #           DISPLAY BY NAME g_detail1_d[l_ac1].faah003
    #        ELSE
    #           CALL cl_set_comp_entry("b_faah003",TRUE)  
    #        END IF
           IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( g_detail3_d[l_ac1].faah001 != g_detail3_d_t.faah001)) THEN
              IF  NOT cl_null(g_detail3_d[l_ac1].faah003) AND NOT cl_null(g_detail3_d[l_ac1].faah001) AND g_detail3_d[l_ac1].faah004 IS NOT NULL THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| "faah001 = '"||g_detail3_d[l_ac1].faah001 ||"' AND "|| "faah003 = '"||g_detail3_d[l_ac1].faah003 ||"' AND "|| "faah004 = '"||g_detail3_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "|| "faah003 = '"||g_detail3_d[l_ac1].faah003 ||"' AND "|| "faah001 = '"||g_detail3_d[l_ac1].faah001 ||"' AND "|| "faah004 = '"||g_detail3_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
                 
              END IF
           END IF 
          
    #    BEFORE FIELD b_faah003
    #       IF g_para_data2 <> 'Y' THEN 
    #          IF cl_null(g_detail1_d[l_ac1].faah003) AND g_detail1_d[l_ac1].faah002 = '1' THEN
    #             IF g_para_data3 = 'Y' AND g_para_data2 ='N' THEN 
    #                CALL s_aooi390('3') RETURNING l_success,g_detail1_d[l_ac1].faah003
    #             END IF 
    #          END IF
    #       END IF 
    #    
    #    #財编检查
        AFTER FIELD b_faah003
           IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( g_detail3_d[l_ac1].faah003 != g_detail3_d_t.faah003)) THEN
              IF  NOT cl_null(g_detail3_d[l_ac1].faah003) AND NOT cl_null(g_detail3_d[l_ac1].faah001) AND g_detail3_d[l_ac1].faah004 IS NOT NULL THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| "faah001 = '"||g_detail3_d[l_ac1].faah001 ||"' AND "|| "faah003 = '"||g_detail3_d[l_ac1].faah003 ||"' AND "|| "faah004 = '"||g_detail3_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "|| "faah003 = '"||g_detail3_d[l_ac1].faah003 ||"' AND "|| "faah001 = '"||g_detail3_d[l_ac1].faah001 ||"' AND "|| "faah004 = '"||g_detail3_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
                  
              END IF
           END IF 
           IF NOT cl_null(g_detail3_d[l_ac1].faah003) THEN 
              IF NOT afap210_faah003_chk1(g_detail3_d[l_ac1].faah002,g_detail3_d[l_ac1].faah003) THEN 
                 LET g_detail3_d[l_ac1].faah003 = ''
                 NEXT FIELD b_faah003
              END IF  
           END IF 
            #2015/02/15 Add By 01727 客户家财产编号Key值,重复需要提醒,但不需要卡死
            #2015/02/15 Add ---(S)---
            IF NOT cl_null(g_detail3_d[l_ac1].faah003) AND NOT cl_null(g_detail3_d[l_ac1].faah002) AND g_detail3_d[l_ac1].faah002 = '1' THEN  #类型为主件时候才需要判断
               LET l_count = 0
               SELECT COUNT(*) INTO l_count FROM faah_t WHERE faahent = g_enterprise
                  AND faah003 = g_detail3_d[l_ac1].faah003
               IF cl_null(l_count) THEN lET l_count = 0 END IF
               IF l_count > 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'afa-00449'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
               END IF
            END IF
            #2015/02/15 Add ---(E)---
        
        AFTER FIELD b_faah004
           IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( g_detail3_d[l_ac1].faah004 != g_detail3_d_t.faah004)) THEN
              IF  NOT cl_null(g_detail3_d[l_ac1].faah003) AND NOT cl_null(g_detail3_d[l_ac1].faah001) AND g_detail3_d[l_ac1].faah004 IS NOT NULL THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM faah_t WHERE "||"faahent = '" ||g_enterprise|| "' AND "|| "faah001 = '"||g_detail3_d[l_ac1].faah001 ||"' AND "|| "faah003 = '"||g_detail3_d[l_ac1].faah003 ||"' AND "|| "faah004 = '"||g_detail3_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM afap210_tmp WHERE "|| "faah003 = '"||g_detail3_d[l_ac1].faah003 ||"' AND "|| "faah001 = '"||g_detail3_d[l_ac1].faah001 ||"' AND "|| "faah004 = '"||g_detail3_d[l_ac1].faah004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
              END IF
           END IF 
    
        ON ACTION controlp INFIELD b_faah003
           IF g_detail3_d[l_ac1].faah002 = '2' OR g_detail3_d[l_ac1].faah002 = '3' THEN
		        INITIALIZE g_qryparam.* TO NULL
              LET g_qryparam.state = 'i'
	           LET g_qryparam.reqry = FALSE
              LET g_qryparam.default1 = g_detail3_d[l_ac1].faah003
              LET g_qryparam.where = " faah002 = 1 " #20150210 add
              CALL q_faah003()
              LET g_detail3_d[l_ac1].faah003 = g_qryparam.return1 
              LET g_qryparam.where = " "
              DISPLAY BY NAME g_detail3_d[l_ac1].faah003
              NEXT FIELD b_faah003                          #返回原欄位
           END IF

 

      END INPUT
      
      BEFORE DIALOG 
         NEXT FIELD b_faah002
         
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DIALOG
 
      ON ACTION accept
         ACCEPT DIALOG 
         
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG   

      ON ACTION close
         LET INT_FLAG = 1         
         LET g_action_choice = "exit"
         EXIT DIALOG 
   END DIALOG
   IF INT_FLAG THEN 
      LET g_flag = 'N'
     # #清空临时表数据
     # DELETE FROM afap210_01_tmp 
     #  WHERE faak000 = g_faak000
     #    AND faak001 = g_faak001
     #    AND faak003 = g_faak003
     #    AND faak004 = g_faak004
     # IF SQLCA.sqlcode THEN
     #    INITIALIZE g_errparam TO NULL 
     #    LET g_errparam.extend = "DEL afap210_01_tmp" 
     #    LET g_errparam.code   = SQLCA.sqlcode 
     #    LET g_errparam.popup  = TRUE 
     #    CALL cl_err()
     # END IF
   END IF 
   CLOSE WINDOW w_afap210_s03
END FUNCTION]]>
  </point>
  <point name="function.afap210_03_b_fill" order="20" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_03_b_fill()
  
   LET g_sql = " SELECT sel,faak000,faak001,faak003,faak004,faak019,faak018,
                        faak022,faah002,faah001,faah003,faah004 FROM afap210_tmp ",
               "  WHERE sel = 'Y' AND pin = 'N' AND produce = 'N' AND pout = 'N' "
               
   PREPARE afap210_03_sel FROM g_sql
   DECLARE afap210_03_curs CURSOR FOR afap210_03_sel
   
   CALL g_detail3_d.clear()    

   LET g_cnt = 1 
   ERROR "Searching!"
   
   FOREACH afap210_03_curs INTO g_detail3_d[g_cnt].*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH 03:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         EXIT FOREACH
      END IF
      LET g_cnt = g_cnt + 1
   END FOREACH
                 
   CALL g_detail3_d.deleteElement(g_cnt)
   LET g_rec_b1 = g_cnt - 1 
   DISPLAY g_rec_b1 TO FORMONLY.cnt
   LET g_cnt = 0  
END FUNCTION]]>
  </point>
  <point name="function.afap210_faah003_chk1" order="21" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION afap210_faah003_chk1(p_faah002,p_faah003)
   DEFINE l_n       LIKE type_t.num5
   DEFINE p_faah002 LIKE faah_t.faah002
   DEFINE p_faah003 LIKE faah_t.faah003
   
   IF NOT cl_null(p_faah002) AND NOT cl_null(p_faah003) AND p_faah002 <> '1' THEN 
      SELECT count(*) INTO l_n 
        FROM faah_t
       WHERE faahent = g_enterprise
         AND faah003 = p_faah003
         AND faah002 = '1'
         
      IF l_n = 0 THEN 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'afa-00016'
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN FALSE
      END IF 
   END IF
   
   RETURN TRUE
END FUNCTION]]>
  </point>
  <point name="b_fill.clear" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   #删除临时表资料
   DELETE FROM afap210_tmp
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "afap210_tmp"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN
   END IF]]>
  </point>
  <point name="b_fill.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE  l_n       LIKE type_t.num5]]>
  </point>
  <point name="b_fill.foreach_into" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   g_detail_d[l_ac].*]]>
  </point>
  <point name="b_fill.foreach_iside" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#      LET g_detail_d[l_ac].faah000=g_detail_d[l_ac].faak000   #mark by yangxf
      INSERT INTO afap210_tmp VALUES(g_detail_d[l_ac].*)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "afap210_tmp"
         LET g_errparam.popup = TRUE
         CALL cl_err()  
         EXIT FOREACH
      END IF  

      SELECT COUNT(*) INTO l_n FROM afap210_tmp  
]]>
  </point>
  <point name="b_fill.other_table" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL g_detail_d.deleteElement(l_ac)]]>
  </point>
  <point name="b_fill.sql_before" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   LET g_sql = " SELECT 'N',faak000,faak001,faak003,faak004,faak019,faak018,faak022,'N','N','N','','','','',' ' ",
               "   FROM faak_t ",
               "  WHERE faakent = ? AND faakstus = 'Y' AND faak043 = 'N' ",
               "    AND ",g_wc CLIPPED,
               "  ORDER BY faak000,faak001,faak003,faak004"               ]]>
  </point>
  <point name="global.variable" order="" ver="3" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[     sel     LIKE type_t.chr1,
     faak000 LIKE faak_t.faak000,
     faak001 LIKE faak_t.faak001,
     faak003 LIKE faak_t.faak003,
     faak004 LIKE faak_t.faak004,
     faak019 LIKE faak_t.faak019,
     faak018 LIKE faak_t.faak018,
     faak022 LIKE faak_t.faak022,    
     produce LIKE type_t.chr1,     
     in      LIKE type_t.chr1,
     out     LIKE type_t.chr1,  
     faah000 LIKE faah_t.faah000,
     faah002 LIKE faah_t.faah002,
     faah001 LIKE faah_t.faah001,
     faah003 LIKE faah_t.faah003,
     faah004 LIKE faah_t.faah004    
                     END RECORD
DEFINE g_rec_b              LIKE type_t.num5
DEFINE g_rec_b1             LIKE type_t.num5 
DEFINE g_detail_idx         LIKE type_t.num5 
DEFINE g_detail_idx1        LIKE type_t.num5 
DEFINE l_ac1                LIKE type_t.num5 
DEFINE g_tmp  DYNAMIC ARRAY OF type_g_detail_d

TYPE type_g_detail1_d RECORD
     flag    LIKE type_t.num5, 
     faak000 LIKE faak_t.faak000,
     faak001 LIKE faak_t.faak001,
     faak003 LIKE faak_t.faak003,
     faak004 LIKE faak_t.faak004,
     faak019 LIKE faak_t.faak019,
     faak018 LIKE faak_t.faak018,
     faah018 LIKE faah_t.faah018, 
     faah022 LIKE faah_t.faah022,
     faah002 LIKE faah_t.faah002,
     faah001 LIKE faah_t.faah001,
     faah003 LIKE faah_t.faah003,
     faah004 LIKE faah_t.faah004    
                     END RECORD
                     
DEFINE g_detail1_d  DYNAMIC ARRAY OF type_g_detail1_d 
DEFINE g_detail1_d_t   type_g_detail1_d
#############################add by huangtao
TYPE type_g_detail3_d RECORD
     sel     LIKE type_t.chr1,
     faak000 LIKE faak_t.faak000,
     faak001 LIKE faak_t.faak001,
     faak003 LIKE faak_t.faak003,
     faak004 LIKE faak_t.faak004,
     faak019 LIKE faak_t.faak019,
     faak018 LIKE faak_t.faak018,
     faak022 LIKE faak_t.faak022,
     faah002 LIKE faah_t.faah002,
     faah001 LIKE faah_t.faah001,
     faah003 LIKE faah_t.faah003,
     faah004 LIKE faah_t.faah004    
                     END RECORD                
DEFINE g_detail3_d  DYNAMIC ARRAY OF type_g_detail3_d 
DEFINE g_detail3_d_t   type_g_detail3_d
#############################add by huangtao   
DEFINE g_faah_m     RECORD 
       faah002      LIKE faah_t.faah002,
       faah001      LIKE faah_t.faah001,
       faah003      LIKE faah_t.faah003,
       faah004      LIKE faah_t.faah004
      END RECORD 
DEFINE g_para_data      LIKE type_t.chr80     #卡片編號是否自動編號
DEFINE g_para_data1     LIKE type_t.chr80     #折舊費用科目取值
DEFINE g_para_data2     LIKE type_t.chr80 
DEFINE g_para_data3     LIKE type_t.chr80 
DEFINE g_faah002_t      LIKE faah_t.faah002
DEFINE g_faah003_t      LIKE faah_t.faah003
DEFINE g_faak000    LIKE faak_t.faak000
DEFINE g_faak001    LIKE faak_t.faak001
DEFINE g_faak003    LIKE faak_t.faak003
DEFINE g_faak004    LIKE faak_t.faak004
DEFINE g_faak022    LIKE faak_t.faak022
DEFINE g_faak018    LIKE faak_t.faak018
DEFINE g_flag       LIKE type_t.chr1
DEFINE g_pr         LIKE type_t.chr1]]>
  </point>
  <point name="init.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_ooef017  LIKE ooef_t.ooef017]]>
  </point>
  <point name="init.init" order="" ver="3" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL cl_set_combo_scc('b_faah002','9911')
   CALL cl_set_comp_entry("b_faah000,b_faah001,b_faah003,b_faah004",FALSE) #20141127 add by chenying 
   SELECT ooef017 INTO l_ooef017
     FROM ooef_t
    WHERE ooef001 = g_site
      AND ooefent = g_enterprise
   CALL cl_get_para(g_enterprise,l_ooef017,'S-FIN-9005') RETURNING g_para_data   #卡片編號是否自動編號
   CALL cl_get_para(g_enterprise,l_ooef017,'S-FIN-9002') RETURNING g_para_data2  #财产编号预设是否与卡片编号一致
   CALL cl_get_para(g_enterprise,l_ooef017,'S-FIN-9010') RETURNING g_para_data3  #财产编号自动编号否
   IF g_para_data = 'Y' THEN 
      CALL cl_set_comp_visible("b_faah001",FALSE)
   ELSE
      CALL cl_set_comp_visible("b_faah001",TRUE)
   END IF ]]>
  </point>
  <point name="main.background" order="" ver="2" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL s_aooi390_cre_tmp_table() RETURNING l_success   #add--2015/03/20 By shiun]]>
  </point>
  <point name="main.before_close" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="main.define" order="" ver="2" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_success    LIKE type_t.num5   #add--2015/03/20 By shiun]]>
  </point>
  <point name="main.exit" order="" ver="2" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL s_aooi390_drop_tmp_table()   #add--2015/03/20 By shiun]]>
  </point>
  <point name="query.after_construct" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL afap210_upd_tmp()
   RETURN]]>
  </point>
  <point name="ui_dialog.before_dialog" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
   CALL afap210_create_tmp()
   
]]>
  </point>
  <point name="ui_dialog.before_dialog2" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL afap210_construct()
   
            IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
               EXIT WHILE
            END IF
   
            CALL afap210_b_fill()]]>
  </point>
  <point name="ui_dialog.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   
   CALL afap210_ui_dialog_1()
   RETURN
   
#  DEFINE l_ooab002     LIKE ooab_t.ooab002
#  DEFINE l_max_faah001 LIKE faah_t.faah001
#  DEFINE l_cnt         LIKE type_t.num5 
#  DEFINE l_n           LIKE type_t.num5
#  DEFINE l_faah001     LIKE faah_t.faah001]]>
  </point>
  <point name="ui_dialog.more_action" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         ON ACTION cancel
            LET INT_FLAG = 1
            EXIT DIALOG         ]]>
  </point>
  <point name="ui_dialog.more_construct" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="ui_dialog.more_displayarray" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[     ]]>
  </point>
  <point name="ui_dialog.more_input" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         INPUT ARRAY g_detail_d FROM s_detail1.*
            ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                      INSERT ROW = FALSE, 
                      DELETE ROW = FALSE,
                      APPEND ROW = TRUE)
                    
   #        BEFORE INPUT
   #           CALL cl_set_comp_entry("b_faah000,b_faah001,b_faah003,b_faah004",FALSE)  
   #
   #        BEFORE ROW
   #           LET l_ac = ARR_CURR()
   #           
   #        AFTER FIELD b_faah003
   #           IF NOT cl_null(g_detail_d[l_ac].faah000) AND NOT cl_null(g_detail_d[l_ac].faah001) AND
   #              NOT cl_null(g_detail_d[l_ac].faah003) AND NOT cl_null(g_detail_d[l_ac].faah003) THEN 
   #              SELECT COUNT(*) INTO l_cnt FROM faah_t 
   #               WHERE faahent = g_enterprise
   #                 AND faah000 = g_detail_d[l_ac].faah000
   #                 AND faah001 = g_detail_d[l_ac].faah001
   #                 AND faah003 = g_detail_d[l_ac].faah003
   #                 AND faah004 = g_detail_d[l_ac].faah004
   #              IF l_cnt > 0 THEN
   #                 INITIALIZE g_errparam TO NULL
   #                 LET g_errparam.code = 'afa-00141'
   #                 LET g_errparam.extend = ''
   #                 LET g_errparam.popup = TRUE
   #                 CALL cl_err()
   #                 NEXT FIELD CURRENT                  
   #              END IF                  
   #           END IF  
   #           
   #           IF NOT cl_null(g_detail_d[l_ac].faah003) THEN          
   #              UPDATE afap210_tmp SET faah003 = g_detail_d[l_ac].faah003 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004  
   #              IF SQLCA.sqlcode THEN
   #                 INITIALIZE g_errparam TO NULL
   #                 LET g_errparam.code = SQLCA.sqlcode
   #                 LET g_errparam.extend = 'update faah003'
   #                 LET g_errparam.popup = TRUE
   #                 CALL cl_err()                 
   #              END IF 
   #           END IF                
   #
   #       AFTER FIELD b_faah004  
   #           IF NOT cl_null(g_detail_d[l_ac].faah000) AND NOT cl_null(g_detail_d[l_ac].faah001) AND
   #              NOT cl_null(g_detail_d[l_ac].faah003) AND NOT cl_null(g_detail_d[l_ac].faah003) THEN 
   #              SELECT COUNT(*) INTO l_cnt FROM faah_t 
   #               WHERE faahent = g_enterprise
   #                 AND faah000 = g_detail_d[l_ac].faah000
   #                 AND faah001 = g_detail_d[l_ac].faah001
   #                 AND faah003 = g_detail_d[l_ac].faah003
   #                 AND faah004 = g_detail_d[l_ac].faah004
   #              IF l_cnt > 0 THEN
   #                 INITIALIZE g_errparam TO NULL
   #                 LET g_errparam.code = 'afa-00141'
   #                 LET g_errparam.extend = ''
   #                 LET g_errparam.popup = TRUE
   #                 CALL cl_err()
   #                 NEXT FIELD CURRENT                  
   #              END IF                  
   #           END IF   
   #
   #           IF NOT cl_null(g_detail_d[l_ac].faah004) THEN  
   #              UPDATE afap210_tmp SET faah004 = g_detail_d[l_ac].faah004 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004  
   #              IF SQLCA.sqlcode THEN
   #                 INITIALIZE g_errparam TO NULL
   #                 LET g_errparam.code = SQLCA.sqlcode
   #                 LET g_errparam.extend = 'update faah004'
   #                 LET g_errparam.popup = TRUE
   #                 CALL cl_err()                 
   #              END IF
   #           END IF
   #        
   #        AFTER FIELD b_faah001
   #           IF NOT cl_null(g_detail_d[l_ac].faah000) AND NOT cl_null(g_detail_d[l_ac].faah001) AND
   #              NOT cl_null(g_detail_d[l_ac].faah003) AND NOT cl_null(g_detail_d[l_ac].faah003) THEN 
   #              SELECT COUNT(*) INTO l_cnt FROM faah_t 
   #               WHERE faahent = g_enterprise
   #                 AND faah000 = g_detail_d[l_ac].faah000
   #                 AND faah001 = g_detail_d[l_ac].faah001
   #                 AND faah003 = g_detail_d[l_ac].faah003
   #                 AND faah004 = g_detail_d[l_ac].faah004
   #              IF l_cnt > 0 THEN
   #                 INITIALIZE g_errparam TO NULL
   #                 LET g_errparam.code = 'afa-00141'
   #                 LET g_errparam.extend = ''
   #                 LET g_errparam.popup = TRUE
   #                 CALL cl_err()
   #                 NEXT FIELD CURRENT                  
   #              END IF                  
   #           END IF 
   #
   #           IF NOT cl_null(g_detail_d[l_ac].faah001) THEN
   #              UPDATE afap210_tmp SET faah001 = g_detail_d[l_ac].faah001 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004 
   #              IF SQLCA.sqlcode THEN
   #                 INITIALIZE g_errparam TO NULL
   #                 LET g_errparam.code = SQLCA.sqlcode
   #                 LET g_errparam.extend = 'update faah001'
   #                 LET g_errparam.popup = TRUE
   #                 CALL cl_err()                 
   #              END IF
   #           END IF
   #
   #        AFTER FIELD b_faah000
   #           IF NOT cl_null(g_detail_d[l_ac].faah000) AND NOT cl_null(g_detail_d[l_ac].faah001) AND
   #              NOT cl_null(g_detail_d[l_ac].faah003) AND NOT cl_null(g_detail_d[l_ac].faah003) THEN 
   #              SELECT COUNT(*) INTO l_cnt FROM faah_t 
   #               WHERE faahent = g_enterprise
   #                 AND faah000 = g_detail_d[l_ac].faah000
   #                 AND faah001 = g_detail_d[l_ac].faah001
   #                 AND faah003 = g_detail_d[l_ac].faah003
   #                 AND faah004 = g_detail_d[l_ac].faah004
   #              IF l_cnt > 0 THEN
   #                 INITIALIZE g_errparam TO NULL
   #                 LET g_errparam.code = 'afa-00141'
   #                 LET g_errparam.extend = ''
   #                 LET g_errparam.popup = TRUE
   #                 CALL cl_err()
   #                 NEXT FIELD CURRENT                  
   #              END IF                  
   #           END IF 
   #
   #           IF NOT cl_null(g_detail_d[l_ac].faah000) THEN  
   #              UPDATE afap210_tmp SET faah000 = g_detail_d[l_ac].faah000 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004 
   #              IF SQLCA.sqlcode THEN
   #                 INITIALIZE g_errparam TO NULL
   #                 LET g_errparam.code = SQLCA.sqlcode
   #                 LET g_errparam.extend = 'update faah000'
   #                 LET g_errparam.popup = TRUE
   #                 CALL cl_err()                 
   #              END IF
   #           END IF
   #            
   #        ON CHANGE sel
   #           IF g_detail_d[l_ac].sel = 'Y' THEN 
   #              UPDATE afap210_tmp SET sel = 'Y' 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004
   #              CALL cl_set_comp_entry("b_faah000,b_faah001,b_faah003,b_faah004,out,in",TRUE)   
   #           ELSE
   #              UPDATE afap210_tmp SET sel = 'N' 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004  
   #              CALL cl_set_comp_entry("b_faah000,b_faah001,b_faah003,b_faah004,out,in",FALSE)    
   #           END IF 
   #           
   #           IF SQLCA.sqlcode THEN
   #              INITIALIZE g_errparam TO NULL
   #              LET g_errparam.code = SQLCA.sqlcode
   #              LET g_errparam.extend = 'update 1'
   #              LET g_errparam.popup = TRUE
   #              CALL cl_err()                 
   #           END IF
   #           
   #        ON CHANGE in
   #           CALL cl_set_comp_entry("b_faah000,b_faah001,b_faah003,b_faah004",TRUE) 
   #
   #           IF g_detail_d[l_ac].in = 'Y' THEN 
   #              CALL cl_set_comp_entry("out",FALSE)
   #              
   #              UPDATE afap210_tmp SET pin = 'Y' 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004
   #             
   #        #SELECT COUNT(*) INTO l_n FROM afap210_tmp WHERE sel = 'Y' AND pin = 'Y'  #ceshi   
   #  
#  #               #檢查tmp中是否存在已有最大的卡片編號  
#  #               #是否自動編號 S-FIN-9005
#  #               SELECT ooab002 INTO l_ooab002 FROM ooab_t
#  #                WHERE ooabent = g_enterprise
#  #                  AND ooab001 = 'S-FIN-9005'
#  #                  AND ooabsite = g_site 
#  #                  
#  #               SELECT MAX(faah001) INTO l_max_faah001 FROM afap210_tmp,afap210_01_tmp
#  #               
#  #               IF l_max_faah001 IS NULL THEN
#  #                  IF l_ooab002 = 'Y' THEN 
#  #                     SELECT MAX(faah001) INTO l_max_faah001 FROM faah_t     
#  #                     LET g_detail_d[l_ac].faah001 = l_max_faah001+1 USING '&&&&&&&&&&'                     
#  #                  ELSE
#  #                     LET g_detail_d[l_ac].faah001 = ''
#  #                  END IF                  
#  #               ELSE
#  #                  IF l_ooab002 = 'Y' THEN 
#  #                     LET g_detail_d[l_ac].faah001 = l_max_faah001+1 USING '&&&&&&&&&&'
#  #                  ELSE
#  #                     LET g_detail_d[l_ac].faah001 = ''
#  #                  END IF                  
#  #               END IF   
   #              
   #              CALL afap210_get_faah001() RETURNING l_faah001
   #              LET g_detail_d[l_ac].faah001 = l_faah001
   #              UPDATE afap210_tmp SET faah001 = g_detail_d[l_ac].faah001 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004 
   #
   #              IF SQLCA.sqlcode THEN
   #                 INITIALIZE g_errparam TO NULL
   #                 LET g_errparam.code = SQLCA.sqlcode
   #                 LET g_errparam.extend = 'update 8'
   #                 LET g_errparam.popup = TRUE
   #                 CALL cl_err()                 
   #              END IF                    
   #           ELSE
   #              LET g_detail_d[l_ac].faah000 = ''
   #              LET g_detail_d[l_ac].faah001 = ''
   #              LET g_detail_d[l_ac].faah003 = ''
   #              LET g_detail_d[l_ac].faah004 = ''
   #              
   #              CALL cl_set_comp_entry("out",TRUE)
   #              
   #              UPDATE afap210_tmp SET pin = 'N' 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004               
   #           END IF 
   #           
   #           IF SQLCA.sqlcode THEN
   #              INITIALIZE g_errparam TO NULL
   #              LET g_errparam.code = SQLCA.sqlcode
   #              LET g_errparam.extend = 'update 2'
   #              LET g_errparam.popup = TRUE
   #              CALL cl_err()                 
   #           END IF               
   #           
   #
   #        ON CHANGE out
   #           CALL cl_set_comp_entry("b_faah000,b_faah001,b_faah003,b_faah004",TRUE)
   #
   #           IF g_detail_d[l_ac].out = 'Y' THEN 
   #              CALL cl_set_comp_entry("in",FALSE)
   #              
   #              UPDATE afap210_tmp SET pout = 'Y' 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004
   #                 
   #              CALL afap210_01_ins(g_detail_d[l_ac].faak000,g_detail_d[l_ac].faak001,g_detail_d[l_ac].faak003,
   #                                  g_detail_d[l_ac].faak004,g_detail_d[l_ac].faak019,g_detail_d[l_ac].faak018) 
   #                                  
   #              CALL afap210_01_open(g_detail_d[l_ac].faak000,g_detail_d[l_ac].faak001,g_detail_d[l_ac].faak003,
   #                                    g_detail_d[l_ac].faak004,g_detail_d[l_ac].faak019,g_detail_d[l_ac].faak018,
   #                                    g_detail_d[l_ac].in,g_detail_d[l_ac].out)   
   #           ELSE
   #              CALL cl_set_comp_entry("in",TRUE)
   #              
   #              UPDATE afap210_tmp SET pout = 'N' 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004               
   #           END IF 
   #           
   #           IF SQLCA.sqlcode THEN
   #              INITIALIZE g_errparam TO NULL
   #              LET g_errparam.code = SQLCA.sqlcode
   #              LET g_errparam.extend = 'update 3'
   #              LET g_errparam.popup = TRUE
   #              CALL cl_err()                 
   #           END IF  
   #
   #        ON CHANGE b_faah000 
   #           UPDATE afap210_tmp SET faah000 = g_detail_d[l_ac].faah000 
   #            WHERE faak000 = g_detail_d[l_ac].faak000
   #              AND faak001 = g_detail_d[l_ac].faak001
   #              AND faak003 = g_detail_d[l_ac].faak003
   #              AND faak004 = g_detail_d[l_ac].faak004  
   #           IF SQLCA.sqlcode THEN
   #              INITIALIZE g_errparam TO NULL
   #              LET g_errparam.code = SQLCA.sqlcode
   #              LET g_errparam.extend = 'update faah000'
   #              LET g_errparam.popup = TRUE
   #              CALL cl_err()                 
   #           END IF 
   #
   #        ON CHANGE b_faah001 
   #           UPDATE afap210_tmp SET faah001 = g_detail_d[l_ac].faah001 
   #            WHERE faak000 = g_detail_d[l_ac].faak000
   #              AND faak001 = g_detail_d[l_ac].faak001
   #              AND faak003 = g_detail_d[l_ac].faak003
   #              AND faak004 = g_detail_d[l_ac].faak004  
   #           IF SQLCA.sqlcode THEN
   #              INITIALIZE g_errparam TO NULL
   #              LET g_errparam.code = SQLCA.sqlcode
   #              LET g_errparam.extend = 'update faah001'
   #              LET g_errparam.popup = TRUE
   #              CALL cl_err()                 
   #           END IF  
   #           
   #        ON CHANGE b_faah003 
   #           UPDATE afap210_tmp SET faah003 = g_detail_d[l_ac].faah003 
   #            WHERE faak000 = g_detail_d[l_ac].faak000
   #              AND faak001 = g_detail_d[l_ac].faak001
   #              AND faak003 = g_detail_d[l_ac].faak003
   #              AND faak004 = g_detail_d[l_ac].faak004  
   #           IF SQLCA.sqlcode THEN
   #              INITIALIZE g_errparam TO NULL
   #              LET g_errparam.code = SQLCA.sqlcode
   #              LET g_errparam.extend = 'update faah003'
   #              LET g_errparam.popup = TRUE
   #              CALL cl_err()                 
   #           END IF  
   #
   #        ON CHANGE b_faah004 
   #           UPDATE afap210_tmp SET faah004 = g_detail_d[l_ac].faah004 
   #            WHERE faak000 = g_detail_d[l_ac].faak000
   #              AND faak001 = g_detail_d[l_ac].faak001
   #              AND faak003 = g_detail_d[l_ac].faak003
   #              AND faak004 = g_detail_d[l_ac].faak004                  
   #           IF SQLCA.sqlcode THEN
   #              INITIALIZE g_errparam TO NULL
   #              LET g_errparam.code = SQLCA.sqlcode
   #              LET g_errparam.extend = 'update faah004'
   #              LET g_errparam.popup = TRUE
   #              CALL cl_err()                 
   #           END IF
   #
   #        AFTER INPUT
   #           IF NOT cl_null(g_detail_d[l_ac].faah004) THEN
   #              UPDATE afap210_tmp SET faah004 = g_detail_d[l_ac].faah004 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004 
   #           END IF  
   #           IF NOT cl_null(g_detail_d[l_ac].faah003) THEN
   #              UPDATE afap210_tmp SET faah003 = g_detail_d[l_ac].faah003 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004 
   #           END IF 
   #           IF NOT cl_null(g_detail_d[l_ac].faah001) THEN
   #              UPDATE afap210_tmp SET faah001 = g_detail_d[l_ac].faah001 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004 
   #           END IF 
   #           IF NOT cl_null(g_detail_d[l_ac].faah000) THEN
   #              UPDATE afap210_tmp SET faah000 = g_detail_d[l_ac].faah000 
   #               WHERE faak000 = g_detail_d[l_ac].faak000
   #                 AND faak001 = g_detail_d[l_ac].faak001
   #                 AND faak003 = g_detail_d[l_ac].faak003
   #                 AND faak004 = g_detail_d[l_ac].faak004 
   #           END IF   
   #
   #           IF SQLCA.sqlcode THEN
   #              INITIALIZE g_errparam TO NULL
   #              LET g_errparam.code = SQLCA.sqlcode
   #              LET g_errparam.extend = 'update :'
   #              LET g_errparam.popup = TRUE
   #              CALL cl_err()                 
   #           END IF
            
              
         END INPUT             ]]>
  </point>
  <point name="ui_dialog.onaction_sel" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            UPDATE afap210_tmp SET sel = 'Y' 
             WHERE faak000 = g_detail_d[l_ac].faak000
               AND faak001 = g_detail_d[l_ac].faak001
               AND faak003 = g_detail_d[l_ac].faak003
               AND faak004 = g_detail_d[l_ac].faak004

            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'update 6'
               LET g_errparam.popup = TRUE
               CALL cl_err()                 
            END IF]]>
  </point>
  <point name="ui_dialog.onaction_selall" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            UPDATE afap210_tmp SET sel = 'Y'
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'update 4'
               LET g_errparam.popup = TRUE
               CALL cl_err()                 
            END IF            
 ]]>
  </point>
  <point name="ui_dialog.onaction_selnone" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            UPDATE afap210_tmp SET sel = 'N'
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'update 5'
               LET g_errparam.popup = TRUE
               CALL cl_err()                 
            END IF   ]]>
  </point>
  <point name="ui_dialog.onaction_unsel" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            UPDATE afap210_tmp SET sel = 'N' 
             WHERE faak000 = g_detail_d[l_ac].faak000
               AND faak001 = g_detail_d[l_ac].faak001
               AND faak003 = g_detail_d[l_ac].faak003
               AND faak004 = g_detail_d[l_ac].faak004

            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'update 7'
               LET g_errparam.popup = TRUE
               CALL cl_err()                 
            END IF]]>
  </point>
  <point name="ui_dialog.qbeclear" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #20150210 add by chenying
            LET INT_FLAG = 1
            EXIT DIALOG   
            #20150210 add by chenying]]>
  </point>
  <section id="afap210.b_fill" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION afap210_b_fill()
 
   DEFINE ls_wc           STRING
   #add-point:b_fill段define
   {<point name="b_fill.define" edit="s"/>}
   #end add-point
   #add-point:b_fill段define
   {<point name="b_fill.define_customerization" edit="c"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
 
   PREPARE afap210_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR afap210_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空
   {<point name="b_fill.clear"/>}
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into
   {<point name="b_fill.foreach_into"/>}
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      {<point name="b_fill.foreach_iside"/>}
      #end add-point
      
      CALL afap210_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.other_table"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE afap210_sel
   
   LET l_ac = 1
   CALL afap210_fetch()
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.after_b_fill"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="afap210.description" ver="1" status="" src="s" readonly="">
    <![CDATA[#應用 a00 樣板自動產生(Version:1)
#+ Version..: T100-ERP-1.00.00(SD版次:5,PR版次:5) Build-000115
#+ 
#+ Filename...: afap210
#+ Description: 底稿拋轉固定資產作業
#+ Creator....: 01531(2014-08-01 11:13:37)
#+ Modifier...: 05384(2015-05-07 14:47:00) -SD/PR-
]]>
  </section>
  <section id="afap210.detail_show" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION afap210_detail_show()
   #add-point:show段define
   {<point name="detail_show.define" edit="s"/>}
   #end add-point
   #add-point:show段define
   {<point name="detail_show.define_customerization" edit="c"/>}
   #end add-point
   
   #add-point:detail_show段
   {<point name="detail_show.detail_show"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="afap210.fetch" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION afap210_fetch()
 
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define
   {<point name="fetch.define" edit="s"/>}
   #end add-point
   #add-point:fetch段define
   {<point name="fetch.define_customerization" edit="c"/>}
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
  </section>
  <section id="afap210.filter" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ filter過濾功能
PRIVATE FUNCTION afap210_filter()
   #add-point:filter段define
   {<point name="filter.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter.define_customerization" edit="c"/>}
   #end add-point    
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define
   {<point name="filter.detail_cnt"/>}
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL afap210_b_fill()
   
END FUNCTION
]]>
  </section>
  <section id="afap210.filter_parser" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ filter欄位解析
PRIVATE FUNCTION afap210_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define
   {<point name="filter_parser.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter_parser.define_customerization" edit="c"/>}
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
  </section>
  <section id="afap210.filter_show" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION afap210_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = afap210_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
  </section>
  <section id="afap210.global" ver="12" status="" src="s" readonly="">
    <![CDATA[#應用 p02 樣板自動產生(Version:13)
{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔
#{<point name="global.inc" />}
##end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   {<point name="global.parameter"/>}
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable" edit="s"/>}
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)
{<point name="global.variable_customerization" edit="c"/>}
#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
  </section>
  <section id="afap210.init" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION afap210_init()
   #add-point:init段define
   {<point name="init.define" edit="s"/>}
   #end add-point   
   #add-point:init段define
   {<point name="init.define_customerization" edit="c"/>}
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="afap210.main" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ 作業開始 
MAIN
   DEFINE ls_js  STRING
   #add-point:main段define
   {<point name="main.define" edit="s"/>}
   #end add-point   
   #add-point:main段define
   {<point name="main.define_customerization" edit="c"/>}
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("afa","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   {<point name="main.background"/>}
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_afap210 WITH FORM cl_ap_formpath("afa",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL afap210_init()   
 
      #進入選單 Menu (="N")
      CALL afap210_ui_dialog() 
 
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_afap210
   END IF 
   
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
]]>
  </section>
  <section id="afap210.other_function" ver="1" status="" src="s" readonly="">
    <![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
  </section>
  <section id="afap210.query" ver="4" status="" src="s" readonly="">
    <![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION afap210_query()
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define
   {<point name="query.define" edit="s" />}
   #end add-point 
   #add-point:query段define
   {<point name="query.define_customerization" edit="c" />}
   #end add-point 
    
   #add-point:cs段after_construct
   {<point name="query.after_construct" />}
   #end add-point
        
   LET g_error_show = 1
   CALL afap210_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query
   {<point name="query.cs段after_query" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="afap210.ui_dialog" ver="10" status="" src="s" readonly="">
    <![CDATA[#+ 選單功能實際執行處
PRIVATE FUNCTION afap210_ui_dialog()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define" edit="s"/>}
   #end add-point 
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define_customerization" edit="c"/>}
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL afap210_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
         {<point name="ui_dialog.more_construct"/>}
         #end add-point
         #add-point:ui_dialog段input
         {<point name="ui_dialog.more_input"/>}
         #end add-point
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            {<point name="ui_dialog.before_dialog2"/>}
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.selall.befroe"/>}
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               {<point name="ui_dialog.for.onaction_selall"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
               {<point name="ui_dialog.for.onaction_selnone"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            {<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            {<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            {<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL afap210_filter()
            #add-point:ON ACTION filter
            {<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前
            {<point name="ui_dialog.before_accept"/>}
            #end add-point
            CALL afap210_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            {<point name="ui_dialog.qbeclear"/>}
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh
            {<point name="ui_dialog.datarefresh"/>}
            #end add-point
            CALL afap210_b_fill()
 
         #add-point:ui_dialog段action
         {<point name="ui_dialog.more_action"/>}
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
  </section>
</add_points>
